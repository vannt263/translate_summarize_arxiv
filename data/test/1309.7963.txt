{
  "article_text": [
    "monte carlo ( mc ) techniques are increasingly being used in proton therapy to simulate and validate treatment plans @xcite .",
    "mc calculations are more accurate than pencil - beam evaluations , since they take into account detailed microscopic processes and have a better handling of material inhomogeneities in patients . however , computational times associated with mc simulations can be prohibitive .",
    "for example , calculating the dose within 2% statistical error in a 150 @xmath3 volume requires around 1 hour on a modern 100-node cluster . at present , the use of mc is therefore either restricted to institutions that have access to significant computing resources , or reserved for a handful of cases requiring detailed investigation and enhanced accuracy .",
    "recently , there have been several attempts to simulate both charged particle and photon transport on graphics processing units ( gpus ) @xcite . in particular , proton transport mcs for particle therapy applications have been successfully implemented .",
    "using gpus , mc calculations of treatment plans involving @xmath4 proton trajectories have been completed in under 30 s. it is therefore clear that gpus can be of tremendous benefit to proton therapy , both for research and in clinical applications ( e.g. plan validation and optimization ) .",
    "however , the current generation of gpu proton mcs make a number of simplifying assumptions concerning non - elastic nuclear interactions .",
    "kohno et al .",
    "@xcite do not directly simulate nuclear processes , but ` include ' them by using measured proton depth dose distributions in water .",
    "jia et al .",
    "@xcite follow fippel and soukup @xcite by using a crude model of nuclear interactions on the oxygen nucleus .",
    "they demonstrate that the lack of an in - depth model of nuclear processes does not significantly impact dose predictions in low - density tissue and bone .",
    "it is nonetheless conceivable that unsatisfactory results could be obtained in certain situations , e.g. propagation through high - z materials such as metallic implants .",
    "detailed investigations ( e.g. studies of secondary particles and residual nuclei ) are also not possible with the model used in refs .",
    "@xcite .",
    "to better include non - elastic nuclear interactions , one can envisage a hybrid proton transport program , in which ionization energy loss , straggling and multiple scattering are simulated on the gpu , while nuclear events are handled by existing software packages on the cpu .",
    "however , in this configuration the running time is expected to be completely dominated by nuclear calculations . for @xmath4 protons in the therapeutic energy range ( 70250 mev ) , we estimate the number of nuclear events that need to be simulated to be of the order of @xmath5 . on a i7 - 3820 3.6 ghz processor it can take from 200 to 900 s to simulate @xmath6 200 mev proton@xmath1o non - elastic interactions with geant4.9.6p2 , depending on the chosen nuclear interaction model . our primary aim is to improve the treatment of nuclear processes in a gpu proton transport mc without considerably extending the net calculation time .",
    "thus , we developed a rudimentary but fast gpu - based mc simulation of nuclear interactions , which is able to predict secondary particle properties following non - elastic events for incident proton energies below 250 mev .",
    "to our knowledge , such simulations have not been previously reported .",
    "we show that on a nvidia gtx680 card , @xmath6 200 mev proton@xmath1o nuclear events can be computed in 2 s. this paper is organized as follows . in  2 ,",
    "we describe our approach , which is a conventional bertini - type intranuclear cascade ( inc ) model including nuclear evaporation .",
    "we then give details of its implementation on the gpu in  3 .",
    "our results are described in  4 .",
    "predictions from our code are verified with geant4.9.6p2 ; simulated data for proton interactions with @xmath1o and @xmath7ca are shown , and calculation times are compared .",
    "we summarize in  5 .",
    "a non - elastic nucleon - nucleus interaction can be assumed to take place in two steps : a fast inc stage that leaves the nucleus in an excited state , followed by an evaporation stage .",
    "the inc phase has been modeled extensively since the late 1950 s using mc techniques @xcite . in the bertini approach @xcite ,",
    "the incident particle and nucleon - nucleon collision products are tracked , assuming straight line trajectories and taking into account medium effects , until they exit the nucleus or their energies lie below a cutoff .",
    "the simulated nucleon - nucleon collisions are not ordered in time . in the evaporation phase ,",
    "de - excitation of the nucleus occurs after energy equilibration , first through the emission of low - energy particles ( nucleons and possibly heavier fragments ) , then photons .",
    "the probability of particle emission can be calculated using statistical methods @xcite .",
    "the inc - evaporation model applies to non - elastic interactions in the therapeutic energy range down to a few tens of mev , although its validity becomes questionable at low energy .",
    "it contains no adjustable parameters , i.e. its predictions do not need to be normalized .",
    "our model inputs , assumptions and further details on the two phases are given below .",
    "the nucleus is treated as a two - component fermion gas mixture of protons and neutrons .",
    "the nucleon density @xmath8 follows a fermi distribution : @xmath9 where @xmath10 ( @xmath11 is the mass number ) , and @xmath12 . for simplicity , @xmath8 is approximated by a step function consisting of 15 shells of constant densities and equal thickness .",
    "the density of each shell is found by integrating @xmath8 . following chen et al .",
    "@xcite , we take the radius of a nucleus to be @xmath13 fm .",
    "the potential energy @xmath14 of a nucleon is the sum of its fermi energy @xmath15 and the binding energy @xmath16 , which is calculated using the semi - empirical mass formula .",
    "target nucleon momenta are sampled from a quadratic distribution .      as mentioned above ,",
    "the incident nucleon and collision products are followed in the nucleus .",
    "the sequence of calculations in our cascade simulation roughly follows that of metropolis et al .",
    "( fig .  3 in ref .",
    "@xcite ) . below 250 mev , only nucleon  nucleon elastic collisions need to be considered .",
    "total and differential elastic nucleon - nucleon cross - sections are calculated using the parameterizations of cugnon et al .",
    "collision kinematics are fully relativistic .",
    "pauli blocking is enforced by requiring that the kinetic energies of all collision products exceed their fermi energies .",
    "the cutoff energy is taken to be @xmath17 for neutrons and @xmath18 for protons , where @xmath19 is the coulomb barrier .",
    "refraction and reflection of nucleons at shell boundaries are taken into consideration using the prescription of chen et al .",
    "@xcite . at the end of the cascade",
    ", the excitation energy of the residual nucleus is calculated through energy conservation , as in ref .",
    "@xcite .      for the evaporation phase",
    ", we adopt the generalized evaporation model ( gem ) @xcite .",
    "although the gem can handle nuclide emission up to mg , only he and lighter particles are considered in this work .",
    "an isotropic angular distribution is assumed in the rest frame of the nucleus for all evaporated particles .",
    "other post - cascade processes such as photon evaporation , pre - equilibrium emission of particles , fission and fermi break - up are not currently included in our model .",
    "in this section , our implementation of the above model on a gpu using the cuda framework @xcite is described .",
    "three kernels are used for the following tasks : ( 1 ) initialization of random number sequences for generation within individual threads using the curand library @xcite , ( 2 ) the inc simulation , and ( 3 ) nuclear evaporation calculations .",
    "kernel 2 processes one full cascade and kernel 3 computes one nuclear de - excitation per gpu thread .    as for memory allocation ,",
    "gpu constant memory is used to store simulation - wide physics constants .",
    "pre - calculated total nucleon - nucleon cross - section tables and other read - only input data arrays are stored as 1-d textures .",
    "global memory is used to store information on incident particles , excited nuclei , and secondary particles that escape the nucleus .",
    "collision products are stored in per - thread local memory before being simulated .",
    "shared memory is minimally used in the present work .",
    "floating point precision is adopted in all calculations .",
    "compile - time conditions are inserted to isolate cuda c extensions , so that the same program can be made to run on the cpu .",
    "this greatly facilitates debugging and running time comparisons .      the inc model described in ",
    "[ section : cascadedescription ] was implemented as one gpu kernel .",
    "the inputs to this kernel are : a structure of arrays ( soa ) describing the incident protons ( position , momentum , and energy ) and the initial curand states for all threads . a soa is used to ensure coalesced global memory reads .",
    "the outputs are two soa s containing information on exiting particles and the excited nuclei remaining after the inc .",
    "the limiting factors affecting run - time performance were : ( 1 ) thread divergence caused by the intrinsic stochastic nature of the simulation and conditional instructions , ( 2 ) register spill and local memory overhead , due to the large kernel size and the use of local memory arrays to store secondary nucleons that need to be propagated in the inc .    to assess the impact of divergence , we simulated 70 and 200 mev proton@xmath20c cascade events with all threads assigned the same initial random number seed ( i.e. curand state ) .",
    "the running times were approximately four and five times shorter for the 70 and 200 mev interactions , respectively .",
    "thread divergence is unavoidable in mc simulations , but we tried to minimize its effects where possible , e.g. by avoiding deeply - nested conditional statements and factoring out operations that are common to all branches .    our attempts to store secondary nucleons in shared or global ( instead of local ) memory resulted in longer running times",
    ". shared memory usage reduced gpu thread occupancy , and using global memory to keep track of recoiling nucleons proved to be comparatively less efficient due to very frequent uncoalesced access and stores ( many secondary nucleons need to be processed in one cascade ) .",
    "our particle evaporation kernel is based on the geant4.9.6p2 gem code . to adapt the latter to the gpu , the object - oriented structure was discarded .",
    "class methods used in calculating particle emission probabilities and sampling emitted particle kinetic energies were re - engineered as device functions .",
    "the evaporation kernel inputs are the curand states and the soa containing information on the post - inc excited nuclei .",
    "the output is another soa describing the properties of evaporated particles .",
    "since one thread can involve more than one exiting particle , the soa is written to global memory in an uncoalesced manner .",
    "we verified that this did not result in a significant increase in total running time .",
    "the limiting factors for the evaporation kernel were again thread divergence and register spill .",
    "we calculated proton interactions on a number of therapeutically relevant nuclei at different incident proton energies between 70 and 230 mev . to illustrate the performance of our mc , predicted secondary proton and neutron yields for proton@xmath1o and proton@xmath7ca are shown in comparison with geant4.9.6p2 simulations in  [ section : g4comparison ] .",
    "computational times are then compared in  [ section : runtime ] .",
    "geant4.9.6p2 calculations were performed using the binary and bertini cascade models @xcite , both of which are routinely adopted in geant4-based proton therapy mcs .",
    "the binary cascade model is more detailed and computationally more intensive than the bertini approach .",
    "our code is conceptually closer to the latter .",
    "the two geant4 models allowed us to gauge the level of discrepancy that can be expected among established inc simulations .",
    "[ figure : protonneutronyields ] shows our computed yield of secondary protons and neutrons for ( a ) 70 mev proton@xmath1o and ( b ) 200 mev proton@xmath7ca interactions .",
    "the neutron yield has been scaled down by a factor of 10 for clarity .",
    "[ figure : protonneutrondiffyields](a ) and ( b ) show the proton and neutron yields in a @xmath21 bin centered at @xmath22 , @xmath23 , @xmath24 and @xmath25 for 200 mev proton@xmath7ca interactions .",
    "the @xmath23 , @xmath24 and @xmath25 curves have been scaled down again for clarity .    the yields shown in figs .",
    "[ figure : protonneutronyields ] and [ figure : protonneutrondiffyields ] are absolute , i.e. they were not normalized to each other .",
    "the gpu simulation is in reasonable agreement with both geant4 models .",
    "comparable levels of agreement were obtained for other therapeutically relevant nuclei ( not shown here for brevity ) .",
    "o and ( b ) 200 mev proton@xmath7ca interactions . , title=\"fig:\",width=325 ] o and ( b ) 200 mev proton@xmath7ca interactions .",
    ", title=\"fig:\",width=325 ]     bin centered at @xmath22 , @xmath23 , @xmath24 and @xmath25 , for 200 mev non - elastic proton interactions on @xmath7ca.,title=\"fig:\",width=325 ]   bin centered at @xmath22 , @xmath23 , @xmath24 and @xmath25 , for 200 mev non - elastic proton interactions on @xmath7ca.,title=\"fig:\",width=325 ]      .[table : runtimeresults ] time taken in seconds to compute @xmath26 proton@xmath1o and proton@xmath7ca interactions at 70 and 200 mev incident proton kinetic energy ( k.e ) .",
    "see  [ section : runtime ] for details . [",
    "cols=\"^,^,^,^,^\",options=\"header \" , ]     all simulations were preformed on a workstation equipped with a i7 - 3820 3.6 ghz processor and a gtx680 card with 4 gb on - board memory . in table  [ table : runtimeresults ] , we compare the calculation times for @xmath26 proton@xmath1o and proton@xmath7ca interactions at 70 and 200 mev , for five cases : ( 1 ) geant4.9.6p2 binary cascade model on the cpu , ( 2 ) geant4.9.6p2 bertini model on the cpu , ( 3 ) our mc compiled to run on the cpu , ( 4 ) our mc compiled to run on the gpu , and ( 5 ) our mc compiled with the ` -use_fast_math ` option to run on the gpu .",
    "this ` nvcc ` compiler flag enforces faster but less accurate cuda intrinsic functions for some mathematical operations .",
    "cpu calculations were done on a single thread , and running times for ( 4 ) and ( 5 ) include host cpu operations .    on the cpu ,",
    "our mc is 24 times faster than the geant4 bertini cascade computations . on the gpu , our mc benefits from a speed - up factor of @xmath220 .",
    "using cuda math intrinsics , the performance is further improved speed - wise by a factor of 1.31.6 .",
    "as far as we can tell , the resulting loss in accuracy in predicted secondary particle yields is small and its impact on dose calculations should be negligible .    for 200 mev protons on @xmath1o , the calculation time ( as a percentage of the total run - time ) of each kernel is as follows : 72% for the inc kernel , 23% for the evaporation kernel and 3% for curand initialization .",
    "the rest of the time is spent in host - gpu data transfers . for 200 mev protons on @xmath7ca",
    "the respective percentages are 50% , 47% and 2% .",
    "the inc kernel run - time is roughly the same for @xmath1o and @xmath7ca , while the evaporation kernel run - time is significantly higher for @xmath7ca .",
    "the run - times for heavier nuclei are expected to be dominated by evaporation calculations .",
    "although the run - time performance is adequate for our purposes , it can be improved in a number of ways . as seen in ",
    "[ section : implementation ] , our implementation is unsophisticated and not fully optimized for the gpu . to mitigate the effects of divergence",
    ", one can try to re - structure the code into small data - parallel tasks , i.e. separate kernels to handle vertices ( e.g. shell boundaries or nucleon - nucleon interactions ) and steps .",
    "trivially , we can also benefit by deploying the same code on a compute capability 3.5 gpu , which allows four times more registers per thread",
    ".    this inc - evaporation simulation will be a critical part of our effort to develop a fast and accurate gpu - based particle transport mc for proton therapy applications .",
    "from the results shown above , for @xmath27 proton trajectories the overhead due to non - elastic interactions is likely to be @xmath28 s on a gtx680 .",
    "note that the curand states do not have to be initialized specifically for the inc - evaporation mc if it is integrated within a larger simulation package .",
    "in summary , we have implemented an intranuclear cascade - evaporation simulation for the gpu .",
    "this simulation will result in more accurate and rigorous mc calculations of proton therapy treatment plans on the gpu .",
    "our work also illustrates how gpus can be used to significantly accelerate mc simulations of non - elastic nuclear interactions .",
    "this work was funded in part by a grant from varian medical systems , inc .",
    "we are grateful to our colleagues at mayo clinic for carefully reading the manuscript ."
  ],
  "abstract_text": [
    "<S> monte carlo simulations of the transport of protons in human tissue have been deployed on graphics processing units ( gpus ) with impressive results . to provide a more complete treatment of non - elastic nuclear interactions in these simulations </S>",
    "<S> , we developed a fast intranuclear cascade - evaporation simulation for the gpu . </S>",
    "<S> this can be used to model non - elastic proton collisions on any therapeutically relevant nuclei at incident energies between 20 and 250 mev . </S>",
    "<S> predictions are in good agreement with geant4.9.6p2 . </S>",
    "<S> it takes approximately 2 s to calculate @xmath0 200 mev proton-@xmath1o interactions on a nvidia gtx680 gpu . a speed - up factor of @xmath220 relative to one intel i7 - 3820 core processor thread </S>",
    "<S> was achieved .    </S>",
    "<S> = 1    monte carlo , proton transport , nuclear cascade , evaporation , gpu , cuda </S>"
  ]
}