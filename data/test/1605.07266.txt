{
  "article_text": [
    "monitoring the activity of large - scale neuronal ensembles during complex behavioral states is fundamental to neuroscience research",
    ". continued advances in optical imaging technology are greatly expanding the number and depth of neuronal populations that can be visualized .",
    "specifically , in vivo calcium imaging through microendoscopic lenses and the development of miniaturized microscopes have enabled deep brain imaging of previously inaccessible neuronal populations of freely moving mice ( @xcite ) . while these techniques have been widely used by neuroscientists ,",
    "automatic methods for extracting cellular signals from this data are currently limited and suboptimal .",
    "the desired method should be able to ( 1 ) identify spatial footprints of all neurons , ( 2 ) denoise , demix and deconvolve the temporal signals ( @xcite ) .",
    "figure [ fig : example]a is an example frame from microendoscopic data , where the weak neuronal signals are submerged in the large background ( the raw video data can we watched here ) . for illustrative purposes , we draw two rois in the optical field and compute their mean fluorescence intensities ( figure [ fig : example]c , d ) .",
    "the red roi overlaps with one neuron and the green roi only has the background ( figure [ fig : example]b ) .",
    "thus the fluorescence in the red roi ( figure [ fig : example]c ) is a superposition of the background and the neuron s temporal activity , whereas the green ( figure [ fig : example]d ) provides an estimation of the background signal . by subtracting these two traces",
    ", we are able to roughly estimate the temporal activity of the neuron within the red roi ( figure [ fig : example]e ) . from this example",
    ", we can see that the background is an order of magnitude larger than the neural activity and its fluctuations are as fast as neuronal calcium transients .",
    "these features make it difficult to detect and demix cellular signals automatically from the raw video .",
    "our work is based on a matrix factorization approach , which can simultaneously segment cells and estimate changes in fluorescence in the temporal domain .",
    "this approach stems from the observation that spatiotemporal calcium activity can be approximated as product of two matrices : a spatial matrix that encodes the location of each neuron and a temporal matrix that characterizes the calcium concentration evolution for each neuron .",
    "it has several variations with different constraints , such as independent component analysis ( pca - ica , @xcite ) , nonnegative matrix factorization ( nmf , @xcite ) , sparse space - time deconvolution ( sstd , @xcite ) and constrained nonnegative matrix factorization ( cnmf , @xcite ) . in particular , pca - ica seeks spatiotemporal components that have reduced dependence .",
    "it is an inherently linear demixing method and can fail in the case when the neural components exhibit significant spatial overlaps ( @xcite ) .",
    "nonlinear methods like nmf , sstd and cnmf can deal with overlapping neural sources more effectively , and often outperform pca - ica .",
    "the main applications of these nonlinear methods are 2-photon or light - sheet imaging data , where the background is weak and has simple spatiotemporally separable structure .",
    "they usually model the background with a rank-1 nonnegative matrix .",
    "however , applying these nonlinear matrix factorization methods to the microendoscopic data faces two problems : ( 1 ) the background term is not well modeled by rank-1 nmf and its large residual could contaminate the extracted neuronal signals ; ( 2 ) the procedures of initializing the model parameters , especially spatial and temporal components of neurons , in these models do not work well because the strong and noisy background mixes with the weak neural signals .",
    "since the optimization problem in these methods are non - convex , without good initialization , it may lead to low - quality results or require excessive time for convergent results .      in this paper , we extend the cnmf framework ( @xcite ) to address strong fluctuations in background fluorescence , and make it applicable to microendoscopic data .",
    "like the proposed cnmf in @xcite , our extended cnmf for microendoscopic data ( cnmf - e ) also has the capability of identifying neurons with low signal - to - noise ratio ( snr ) and simultaneously denoising , deconvolving and demixing large - scale microendoscopic data . to accomplish this : ( 1 ) we replace the rank-1 nmf approximation of the background with a more sophisticated approximation , which can better account the complex background and avoid absorbing cellular signals , and ( 2 ) we develop an efficient initialization procedure to extract neural activities with minimal influence from the background .",
    "the structure of the paper is as follows . in section [ sec : cnmf ]",
    "we briefly review the cnmf model and describe our modifications to the model . in section [ sec : fit_model ]",
    ", we develop our specialized model fitting procedure . in section [ sec : result ] we validate our new proposed cnmf - e on simulated and experimental data , and we also compare it with the widely used pca - ica method ( @xcite ) .    * notation * a matrix @xmath0 represents the spatiotemporal activity of @xmath1 pixels in @xmath2 frames .",
    "the column vector @xmath3 is the observation of the whole frame in time - step @xmath4 .",
    "we use @xmath5 to refer the spatial location of one pixel , thus @xmath6 is the fluorescence intensity in @xmath4-th frame at location @xmath7 . for a column vector @xmath8 encoding the spatial information of @xmath1 pixels , @xmath9 indicates the value of @xmath10 at pixel @xmath7 .",
    "the video data we have are observations from the optical field for a total number of @xmath2 frames .",
    "the recorded data can be represented by a matrix @xmath11 , where @xmath1 is the number of pixels in the field .",
    "each neuron is characterized by its spatial ` footprint ' vector @xmath12 and ` calcium activity ' @xmath13 . here",
    "both @xmath14 and @xmath15 are forced to be nonnegative because of their physical interpretations .",
    "given @xmath16 of one neuron , its spatiotemporal activity is represented as @xmath17 .",
    "the background activity is represented by a matrix @xmath18 .",
    "suppose the field contains a total number of @xmath19 neurons , then the observation is a superposition of all neurons spatiotemporal activity , time - varying background and additive noise : @xmath20 where @xmath21 , c=[\\mathbf{c}_1 , \\cdots , \\mathbf{c}_k]^t$ ] .",
    "the noise term @xmath22 is assumed to be gaussian and @xmath23 .",
    "@xmath24 is a diagonal matrix indicating that the noise is spatially and temporally uncorrelated .",
    "@xcite also explicitly model the calcium dynamics @xmath15 with a stable autoregressive process ( ar ) of order @xmath25 , @xmath26 where @xmath27 is the number of spikes that neuron fired at the @xmath4-th frame and it is sparse in the neural systems .",
    "the ar coefficients @xmath28 are different for each neuron and they are estimated from the data .    estimating the model parameters @xmath29 in model ( [ eq : y])([eq : arp ] ) can give us all neurons spatial footprints and their deconvolved temporal activities . to fit the model , we also have to constrain the background term to have simplified structure , otherwise letting @xmath30 leads to the least reconstruction error .",
    "this framework is general and we use it in our new method as well .",
    "compared with the proposed implementation in @xcite , our method models the background term differently .    in the work of @xcite , they model the background with a rank-1 nonnegative matrix @xmath31 , where @xmath32 and @xmath33 encode the background spatial and temporal structure respectively",
    "this is a good assumption for two - photon or light - sheet imaging data , but the background in microendoscopic data requires a more complex model .",
    "we also have to avoid the increased complexity from absorbing cellular signals into the background .",
    "thus the ideal model should explicitly model the background features that are distinct from neurons of interest . here",
    "we include two main features of the background into the model of @xmath34 : ( 1 ) the temporal component of each pixel has a constant large baseline and some slow trends ( see figure [ fig : example]d ) and ( 2 ) background is usually spatially smooth in a larger spatial range compared with neuron size ( figure [ fig : example ] ) , which means the background of all pixels within a neuron does not have large spatial gradients .",
    "this is because the fluctuations in the background reflects the out - of - focus fluorescence and they are significantly blurred .",
    "hence we model the background term as @xmath35 where @xmath36 and @xmath37 .",
    "@xmath38 explains the constant baselines and slow trends for all pixels ( figure [ fig : example]c ) and their temporal dynamics are much slower than calcium indicators .",
    "the second term @xmath39 models the fast fluctuation in the background and the spatial component @xmath40 has low spatial - frequency structure .",
    "the constraint of @xmath40 excludes cellular signals from the background term .",
    "in this section , we will describe our customized algorithm for fitting the model ( [ eq : y])([eq : arp])([eq : bg ] ) .",
    "we frequently use the pixel - wise formulation of model ( [ eq : y ] ) and ignore the noise term : @xmath41 our framework can be summarized into the following steps :    1 .",
    "initialize @xmath42 using the new initialization procedure .",
    "2 .   approximate the background @xmath43 using model ( [ eq : bg ] ) .",
    "update @xmath42 from data @xmath44 using constrained alternating matrix factorization .",
    "4 .   post - process the results automatically or manually : delete neurons , pick the missed neurons from the residuals , and merge neurons with high temporal correlations .",
    "repeat steps 2 , 3 , 4 until the results are biologically meaningful .",
    "our techniques differ from @xcite in the following aspects : ( 1 ) the initialization step for @xmath45 and @xmath46 here requires careful considerations of the background contaminations and our approach is totally new .",
    "( 2 ) instead of updating the background term iteratively , we update the background independently in different iterations and the rank of the background model can be modified in each iteration . as a result , our algorithm has a better control of the residual levels in background .    in the followings , we mainly describe our novel initialization step and briefly summarize the procedure of fitting the background term . as for steps ( 3 - 5 ) and discussions for scalability issue , we put them in the supplementary materials ( section [ supp : iterative_manual ] and [ supp : speed ] ) .    , the initialized temporal activity of one neuron .",
    "d@xmath47 , raw data of the cropped small window ( green square in a and b ) .",
    "e@xmath47 , the estimated time - varying local backgrounds in the small cropped window .",
    "c@xmath48 , @xmath49 and @xmath50 are the re - ordered version of c@xmath47 , @xmath51 and @xmath52 .",
    "c@xmath53 is the temporal differencing of c@xmath48 and the result has been thresholded with its @xmath54 standard deviation .",
    "similarly , d@xmath53 is differencing result of d@xmath48 .",
    "f , the initialized spatial and temporal components of the neuron.,width=529 ]      here we develop a robust procedure for initializing @xmath45 and @xmath46 without estimation of the background .",
    "this procedure utilizes the spatial smoothness feature in the background and removes it by spatial high - pass filtering of the raw data .",
    "we estimate the temporal component of one neuron @xmath15 from spatially filtered data and then use it to extract the corresponding spatial footprint @xmath14 from the raw data . in the step of estimating @xmath14 , we re - order all frames to make nearby frames share the similar local background levels and then take the temporal differencing to remove the background signals temporally .",
    "after that , we can use regression to get @xmath14 . repeating",
    "this process can initialize the required number of neurons .",
    "the whole procedure is schematically illustrated in figure [ fig : initialization ] and described in algorithm [ alg : init ] in the supplementary materials .",
    "the spatial smoothness assumption of the background leads to @xmath55 i.e. , within the spatial range of a cell body , the background is spatially invariant .",
    "based on this assumption , we use @xmath56 to filter the raw data @xmath6 , and @xmath56 is defined as @xmath57 where @xmath58 .",
    "@xmath59 is a gaussian kernel with width @xmath60 and @xmath61 is the the average size of the neurons .",
    "@xmath56 is a template matching filter to detect spatial structures with similar shapes and sizes . for flat structures in the small regions , like background , filtering them with @xmath56",
    "get results close to 0 .",
    "thus in the filtered data @xmath62 , the background @xmath63 has been roughly removed and @xmath64 is mainly composed of cellular signals ( figure [ fig : initialization]b ) .",
    "more interestingly , the calcium concentrations of most neurons can be directly approximated by the temporal traces of some pixels in @xmath64 .",
    "( figure [ fig : initialization]c@xmath47 , see section [ supp : filter ] in supplementary materials for derivation ) .",
    "we call these pixels seed pixels because we can use them to initialize neurons .",
    "we initialize neurons with a greedy algorithm . in each iteration , we find one seed pixel @xmath65 ( see supplementary materials section [ sec : seed ] for details of how to detect seed pixels ) and initialize its spatial footprint @xmath66 and temporal course @xmath67",
    ". then we subtract @xmath68 from the raw video data , find the next seed pixel and repeat the initialization procedure until specified number of neurons have been initialized or no more seed pixels exist .    given a seed pixel @xmath65 , we can initialize the neuron s temporal component as @xmath69 ( figure [ fig : initialization]c@xmath47 ) .",
    "this approximation is usually good , and here we propose an efficient method to extract its spatial component @xmath14 from the raw data @xmath70 .",
    "we first crop the optical field with a square centered at @xmath65 and the square size is twice larger than the average neuron size @xmath61 ( figure [ fig : initialization]d@xmath47 ) .",
    "since cell bodies have localized structure , the spatial shape of the expected neuron is completely covered by this square .",
    "then we approximate the local background level in this cropped area @xmath71 using the median of the fluorescence intensities on the square boundary ( figure [ fig : initialization]e@xmath47 ) . by sorting all frames in an order of @xmath72 such that @xmath73 ( figure [ fig : initialization]c@xmath48d@xmath48e@xmath48 ) , nearby frames have the minimal differences ( @xmath74 ) in the background term .",
    "hence the differencing of the sorted video data is @xmath75 we already have @xmath76 , so we can initialize @xmath14 by regressing @xmath77 on @xmath78 ( figure [ fig : initialization]c@xmath53d@xmath53 ) . empirically we found that thresholding @xmath79 achieves better results .",
    "after we get @xmath80 ( figure [ fig : initialization]f ) , we can reestimate @xmath81 using a simple formula : @xmath82 where @xmath83 is a vector replacing all nonzero pixels of @xmath84 with the mean of those nonzero pixels . by running this initialization procedure iteratively",
    ", we can extract almost all neurons .      after we get @xmath85 and @xmath86",
    ", @xmath87 is mainly the background component and we will approximate it with a matrix described in eq .",
    "( [ eq : bg ] ) .",
    "first we use a spline basis with low temporal dynamics to approximate the first term @xmath88 ( baseline + slow trend ) , then we factorize the residual @xmath89 with @xmath39 . by constraining @xmath40 with high spatial smoothness , we can avoid cellular signals being absorbed into the background .",
    "we use singular value decomposition ( svd ) together with low - pass filtering of the estimated spatial components to estimate @xmath90 and @xmath91 .",
    "( see supplementary materials [ supp : bg ] for details ) .",
    "pca - ica ( @xcite ) is the most widely used automatic methods for analyzing microendoscopic data ( @xcite ) .",
    "it seeks spatially and temporally independent components as individual neurons . in this section",
    "we compared our cnmf - e with pca - ica method using simulated and experimental data .",
    "we simulated @xmath92 neurons activity in the optical field ( @xmath93 pixels ) for @xmath94 frames ( @xmath95 hz ) . to ensure that the background had similar features as real data",
    ", we utilized the background extracted from our experimental data as the background in our simulation .",
    "we also add i.i.d .",
    "gaussian noise to our model ( the simulated video data can be found here ) .",
    "after removing all false positives , pca - ica detected @xmath96 neurons and our cnmf - e method found @xmath97 neurons of the @xmath92 neurons .",
    "most neurons detected by pca - ica did not have localized structures and multiple neurons were combined together ( see supplementary figure [ fig : supp_ac ] ) .",
    "we superimposed the contours of all extracted neurons together on top of the locations of simulated neurons .",
    "pca - ica - based segmentation failed to identify a large proportion of the neurons in this dataset , whereas nearly every neuron was identified by the cnmf - e approach ( figure [ fig : sim]cd ) .",
    "we matched each simulated neuron with a neuron among all the extracted neurons by selecting the one most correlated with the simulated neuron temporally .",
    "for a pair of matched neuron , they should have both high temporal and spatial correlations in the perfect case , i.e. , the real cellular signal is extracted from the data with high fidelity .",
    "we displayed spatial and temporal correlations of all simulated neurons with their matched neurons detected by two approaches ( figure [ fig : sim]bd ) . a total number of @xmath97 simulated neurons were accurately recovered by our cnmf - e method ( figure [ fig : sim]d ) . while for pca - ica , a large proportion of the matched neurons have low spatial and temporal correlations ( figure [ fig : sim ] ) indicating failures in recovering real neurons signals .",
    "we also display @xmath98 tightly clustered neurons in the simulated data ( figure [ fig : sim]e ) to demonstrate that our cnmf - e approach can accurately detect and demix their activity ( figure [ fig : sim]g ) .",
    "the spatiotemporal similarity between the 4 neurons segmented with cnmf - e ( figure 3 g ) and ground truth ( figure 3e ) indicates a good performance in extracting the neural activity .",
    "in contrast , pca - ica based detection can only detect two neurons and the calcium traces have high level of noise .",
    "the reason is that pca - ica merges multiple neurons together spatially and distorts the calcium traces in the temporal domain .",
    "furthermore , the distorted calcium traces reduces the number of detected neurons .",
    "the data used here was collected from the prefrontal cortex ( pfc ) of a freely moving mouse .",
    "the frame rate is 15 hz . the raw image ( figure [ fig : data_example]a ) is blurry and it is difficult to visually detect any neurons .",
    "its local correlation image ( @xcite ) of the raw data is approximately uniform @xmath99 ( figure [ fig : data_example]c ) , which means neighboring pixels share strong background fluctuations .",
    "here we removed the background by spatially filtering the raw data with @xmath56 and then calculated local correlation image using eq .",
    "( [ eq : pnr_corr ] ) in supplementary materials .",
    "figure [ fig : data_example]d clearly shows the locations of all neurons .",
    "appying our proposed cnmf - e method is able to detect @xmath100 neurons from the raw data .",
    "their contours are depicted on top the the correlation image and we can see that our method efficiently identifies neurons in the optical field ( figure [ fig : data_example]d ) .",
    "after subtracting the extracted background from the raw data , neural activity is visualized more effectively ( figure [ fig : data_example]b ) .",
    "the quality of this background correction on the raw data is important for extracting neural signals and demixing neurons . in the supplementary video ( )",
    ", we showed the raw video , extracted background video , background corrected video and reconstructed cellular activity @xmath101 . from the video , we can see that cnmf - e reliably extracted the weak cellular signals from the rapidly fluctuating background .",
    "we choose three neighboring neurons within a small field to show the performance of our method . in figure",
    "[ fig : data_example]e , we showed their rois and the local correlation image .",
    "the mean fluorescence traces within each roi are too noisy to infer any calcium events .",
    "both pca - ica and cnmf - e isolated these three neurons and extracted the spiking signals , but the traces extracted with the pca - ica have higher levels of noise .",
    "further , note that traces extracted with pca - ica have large artifactual negative peaks .",
    "cnmf - e does not have this problem due to the nonnegative requirements . in the shaded region of figure [ fig : data_example]f ,",
    "we demonstrate potential crosstalk between two neurons , that is avoided by cnmf - e but not pca - ica based segmentation ( watch video here .",
    "the temporal traces in the video are extracted from cnmf - e ) .     detected neurons and the correlation image calculated using our cnmf - e method ( see eq .",
    "( [ eq : pnr_corr ] ) in supplementary materials ) .",
    "e , mean fluorescence traces from three rois .",
    "f , extracted spatial / temporal components of three neurons using pca - ica method .",
    "g , results using our cnmf - e method .",
    ", width=529 ]",
    "in this paper , we proposed an efficient method for extracting cellular signals from microendoscopic data ; such methods are in very high demand in the neuroscience community .",
    "the analysis of this video data is the first stage of processing in many experiments , so the quality of source extraction in this step highly influences the scientific conclusions drawn in downstream analysis . as shown in figure [ fig : sim ] and [ fig : data_example ] ,",
    "our method shows credible performances in recovering the real neuronal signals and outperforms the previous standard pca - ica method .",
    "thus the methods introduced here ( which we plan to release as open source software ) will be a powerful and important tool for the neuroscience community .",
    "funding for this research was provided by nih 2r01mh064537 ( p.z .",
    ", r.k . ) , nih r90da023426 ( p.z . ) , national institute of child health nichd and human development hd079124 ( g.s . ) , nichd grant t32 hd040127 ( s.r . ) , simons research foundation ( g.s . ) , simons foundation global brain research awards 325171 , 365002 , aro muri w911nf-12 - 1 - 0594 , darpa n66001 - 15-c-4032 ( simplex ) , and a google faculty research award ( l.p . ) ; in addition , this work was supported by the intelligence advanced research projects activity ( iarpa ) via department of interior/ interior business center ( doi / ibc ) contract number d16pc00003 ( l.p . ) , d16pc00007 ( p.z . ) . the u.s .",
    "government is authorized to reproduce and distribute reprints for governmental purposes notwithstanding any copyright annotation thereon .",
    "disclaimer : the views and conclusions contained herein are those of the authors and should not be interpreted as necessarily representing the official policies or endorsements , either expressed or implied , of iarpa , doi / ibc , or the u.s .",
    "government .",
    "11 [ 1]#1 [ 1]`#1 ` urlstyle [ 1]doi : # 1    ferran  diego andilla and fred  a. hamprecht . .",
    "_ advances in neural information processing systems _ , pages 6472 , 2014 .",
    "andrzej cichocki , rafal zdunek , and shun - ichi amari . .",
    "_ independent component analysis and signal separation _ ,",
    "46660 ( 1):0 169176 , 2007 .    benjamin  a flusberg , axel nimmerjahn , eric  d cocker , eran  a mukamel , robert p  j barretto , tony  h ko , laurie  d burns , juergen  c jung , and mark  j schnitzer . _ nature methods _ , 50 ( 11):0 9358 , 2008 .",
    "johannes friedrich , daniel soudry , yu  mu , jeremy freeman , misha ahrens , and liam paninski . .",
    "in _ conference on neural information processing systems _ , 2015 .",
    "kunal  k ghosh , laurie  d burns , eric  d cocker , axel nimmerjahn , yaniv ziv , abbas  el gamal , and mark  j schnitzer .",
    "_ nature methods _ , 80 ( 10):0 871878 , 2011 .    ryuichi maruyama , kazuma maeda , hajime moroda , ichiro kato , masashi inoue , hiroyoshi miyakawa , and toru aonishi . .",
    "_ neural networks _ ,",
    "55:0 1119 , 2014 .",
    "eran  a. mukamel , axel nimmerjahn , and mark  j. schnitzer . .",
    "_ neuron _ , 630 ( 6):0 747760 , 2009 .",
    "eftychios  a pnevmatikakis , daniel soudry , yuanjun gao , timothy  a machado , josh merel , david pfau , thomas reardon , yu  mu , clay lacefield , weijian yang , misha ahrens , randy bruno , thomas  m jessell , darcy  s peterka , rafael yuste , and liam paninski . .",
    "_ neuron _ , 890 ( 2):0 285299 , 2016 .    shanna  l resendez , josh  h jennings , randall  l ung , vijay mohan  k namboodiri , zhe  charles zhou , james  m otis , hiroshi nomura , jenna  a mchenry , oksana kosyk , and garret  d stuber . .",
    "_ nature protocols _ , 110 ( 3):0 566597 , 2016 .",
    "spencer  l smith and michael husser . .",
    "_ nature neuroscience _ , 130 ( 9):0 11441149 , 2010 .",
    "yaniv ziv and kunal  k ghosh . .",
    "_ current opinion in neurobiology _ , 32:0 141147 , 2015",
    "since @xmath103 filtering the raw data with @xmath56 results @xmath104(\\mathbf{x})\\cdot c_i(t).\\end{aligned}\\ ] ] for each neuron , there is an area @xmath105(\\mathbf{x } ) > 0\\}$ ] .",
    "usually @xmath106 corresponds to the central area for a neuron with gaussian shape . for @xmath107 , @xmath108(\\mathbf{x})\\cdot c_i(t ) +",
    "\\sum_{j\\neq i}^k [ \\tilde{h}\\ast a_j](\\mathbf{x})\\cdot c_j(t ) .",
    "\\label{eq : zxt}\\ ] ] if @xmath109(\\mathbf{x})=0 $ ] for all @xmath110 , i.e. , the @xmath111 th neuron is well isolated from the others , then @xmath112 this is a nice feature because we can estimate @xmath102 from @xmath64 directly .",
    "empirically we found that this condition can be relaxed to @xmath109(\\mathbf{x})\\leq0 $ ] .",
    "when @xmath109(\\mathbf{x})<0 $ ] , @xmath113 has negative spikes from neuron @xmath114 and we can remove them simply by thresholding @xmath64 with its median .",
    "thus for each neuron @xmath111 , as long as there exist some @xmath107 and @xmath109(\\mathbf{x})\\leq0 $ ] for all @xmath110 ( small positive values are still tolerable ) , we can simply approximate its calcium concentration @xmath102 with @xmath64 .",
    "a seed pixel @xmath7 should have two main features : first , @xmath113 has high peak - to - noise ratio ( pnr ) because it encodes the calcium concentration @xmath102 of one neuron and usually @xmath102 has large calcium transients ; second , seed pixel has high temporal correlations with its neighboring pixels because they are likely to share the same @xmath102 .",
    "we computed two metrics for each of these two features : @xmath115 where @xmath116 ( we use @xmath117 ) determines the range of neighbors and @xmath118 is the total number of neighboring pixels .",
    "@xmath119 calculates the temporal correlation between two time series @xmath120 and @xmath121 .",
    "the function @xmath122 is a pre - processing of @xmath64 before computing local correlation . in our implementation , we threshold the differencing of @xmath113 by @xmath123 ( e.g. , @xmath124 .",
    "this is equivalent to a rough detection of calcium transients . it is better than using @xmath64 directly because it reduces the influence of the background residual , noise and negative spikes from nearby neurons . to avoid unnecessary searches of the seed pixels , we usually set thresholds for both @xmath125 ( e.g. , 5 ) and @xmath126 ( e.g. , 0.5 ) . in each iteration of the initialization",
    ", we find the pixel with the maximum value of @xmath127 and set it as a seed pixel . here",
    "we use point - wise product of @xmath125 and @xmath126 to emphasize the characteristics of seed pixels .",
    "if we successfully initialize one neuron from this seed pixel , the spatiotemporal activity of this initialized neuron @xmath128 will be peeled off from the residual data ( it is @xmath70 at the beginning of the initialization ) .",
    "we also have to locally update @xmath125 and @xmath126 in the initialized area .",
    "each neuron can only be visited once for initialization .",
    "we will stop the initialization procedure until the specified number @xmath19 reaches or there are no more seed pixels .",
    "define @xmath130 as nonzero pixels of @xmath84 and @xmath131 then @xmath132 again , the spatial smoothness of the background term @xmath133 induces @xmath134 . when the overlaps between neurons are not severe , @xmath135 , hence , we have @xmath136      the trends of all pixels are independent and we approximate all trends with b - spline basis @xmath137 , i.e. , @xmath138 , where the row vectors of @xmath137 are cubic b - spline basis given a sequences of knots . by increasing the intervals between knots ,",
    "we lower the number of basis and constrain the dynamics of @xmath139 to be slow .",
    "we usually choose evenly distributed knots over the whole time period with an interval of @xmath140 seconds .",
    "this is much larger than dynamics of the calcium indicators ( @xmath141 seconds ) .",
    "@xmath142 contains coefficients of each spline basis .",
    "it is estimated with regression @xmath143\\cdot[xx^t]^{-1}$ ] .    after we remove the @xmath38 , we move on to approximate the the fast fluctuations @xmath144 with low rank-@xmath118 matrix @xmath39 .",
    "the truncated svd of @xmath145 has the globally minimum frobenious norm of the difference between @xmath145 and @xmath39 .",
    "here we choose row vectors of @xmath91 be the top @xmath118 right singular vectors of @xmath145 and then @xmath146 .",
    "however , the computed @xmath40 is not guaranteed to have low spatial frequency structure .",
    "we post - process @xmath40 to enforce this constraint . here",
    "we low - pass filter it with a median filter to get @xmath90 .",
    "the size of the median filter is chosen larger than a neuron size .",
    "then the background is estimated with @xmath147      empirically after the initialization of @xmath42 and approximating @xmath43 with model ( [ eq : bg ] ) , the results are very close to the optimal solutions .",
    "but we can still make the parameter estimations better by iteratively updating model parameters .",
    "there are several things we can do : ( 1 ) deconvolve the temporal components in @xmath46 to get denoised calcium traces , ( 2 ) delete false positive neurons , ( 3 ) pick neurons from the residual @xmath148 , and ( 4 ) merge neurons that were inappropriately split into several components .",
    "all these operations can lead to better extraction of cellular signals .",
    "each time when we update @xmath43 , we run the same procedure as section [ supp : bg ] again",
    ". we can adaptively change the b - spline basis and rank of @xmath39 to get better approximation .",
    "for example , when we see some trend in cellular signals , we can use spline basis with more knots to explain this trend in the background .",
    "sometimes the background corrected data is still blurry because we do not remove the background cleanly . in this case , we can increase the rank to @xmath39 term in background to explain it .    to update @xmath85 and @xmath86",
    ", we keep the background @xmath43 unchanged , i.e. , we fit the model @xmath149 .",
    "this can be done using the same approaches described in @xcite and we need to make changes by removing the background term ( see section [ sec : updateac ] )",
    ".    our method can also allow users verify the extracted cells visually and delete those low - quality neurons .",
    "the spatiotemporal activity of these deleted neurons will be absorbed by the background @xmath43 or other neurons .",
    "the signal qualities of nearby neurons might be improved . to add a neuron from the residual @xmath148 , we first select one pixel @xmath65 ( usually the one with the maximum residual ) and then run a rank-1 nmf in a small window centered at @xmath65 to get its spatial and temporal components . we can also manually or automatically select @xmath65 .",
    "although these steps are simple , they showed great helps in speeding up the model fitting procedure . as a comparison ,",
    "pca - ica method has no manual intervention steps .",
    "removing false positive neurons could not improve signal extraction of other neurons .",
    "after subtracting the background from the raw data , we can optimize @xmath45 and @xmath46 by fitting the model @xmath150 this is the same cnmf problem as proposed by @xcite .",
    "the trivial difference is that eq .",
    "( [ eq : new_cnmf ] ) has no background term .",
    "we can use the same optimization procedure to estimate @xmath29 . here",
    "we rewrite their approaches for this optimization approach .",
    "briefly they iteratively update @xmath45 and @xmath46 by solving two optimization problems .",
    "( 1 ) given the estimates of @xmath151 in previously iterations , @xmath152 can be updated by solving the following convex problem @xmath153 where @xmath154 is the standard deviation of the gaussian noise for each pixel @xmath111 . ( 2 ) once we update @xmath155 , we update @xmath156 column by column . to update the @xmath114th column",
    ", we first form the quantity @xmath157[\\mathbf{c}_1^{(k)},\\cdots , \\mathbf{c}_{j-1}^{(k ) } , \\mathbf{c}_{j+1}^{(k-1)}\\cdots , \\mathbf{c}_k^{(k-1)}]^t\\big),\\ ] ] and then apply any deconvolution method of choice to @xmath158 to obtain @xmath159 .",
    "we usually use the noise - constrained deconvolution method used in @xcite .    removing the spatial sparsity constraint and the temporal dynamics can",
    "significantly reduces the computation time and the results are close to the optimal solution . in this case ,",
    "( [ eq : new_cnmf ] ) is a plain nmf problem with some locality constrains .",
    "@xcite adapted the hierarchical alternating least squares ( hals ) method ( @xcite ) algorithm to solve it with fast speed .",
    "in our implementations , we frequently use the hals algorithm to get convergent results before running the full cnmf approaches .",
    "our method is very fast in analyzing data . in the example of the simulated data ( @xmath93 pixels , 3000 frames ) , our naive matlab implementation took @xmath160 minutes to initialize @xmath161 neurons out of @xmath92 on a single desktop . fitting the background model given",
    "@xmath42 requires @xmath162 seconds .",
    "the manual interventions of adding / deleting neurons only need few clicks and they can be processed in real time .",
    "the results of our initialization step are very close the final solutions , so we only need @xmath163 cnmf iterations to update model parameters .",
    "the performances of those algorithms used for solving cnmf have been reported in @xcite and @xcite .",
    "our implementations can be easily optimized to be faster . in the initialization step ,",
    "spatial filtering and calculation of the local correlation images are the only computation - intensive parts in the processing of huge data sets .",
    "these computations themselves are very classical matrix operations and utilizing gpu can significantly make it faster . since the initialization of each neuron is only dependent on a very small window , the whole initialization step can be easily processed in parallel by segmenting the optical field into multiple small patches .",
    "we can also use distributed computing to process the data patch by patch .",
    "fitting the background model requires two steps : ( 1 ) the first step is approximating the baseline and slow trends .",
    "since all pixels are independent , we can easily run it in parallel without effort ; ( 2 ) the second step is basically svd and there are plenties of existing algorithms or packages to deal with this problem for extremely large datasets . in summary , all the algorithm proposed in this paper has no scalability issues and can be easily scaled for processing any large - scale datasets ."
  ],
  "abstract_text": [
    "<S> in vivo calcium imaging through microscopes has enabled deep brain imaging of previously inaccessible neuronal populations within the brains of freely moving subjects . </S>",
    "<S> however , microendoscopic data suffer from high levels of background fluorescence as well as an increased potential for overlapping neuronal signals . </S>",
    "<S> previous methods fail in identifying neurons and demixing their temporal activity because the cellular signals are often submerged in the large fluctuating background . here </S>",
    "<S> we develop an efficient method to extract cellular signals with minimal influence from the background . </S>",
    "<S> we model the background with two realistic components : ( 1 ) one models the constant baseline and slow trends of each pixel , and ( 2 ) the other models the fast fluctuations from out - of - focus signals and is therefore constrained to have low spatial - frequency structure . </S>",
    "<S> this decomposition avoids cellular signals being absorbed into the background term . after subtracting the background approximated with this model , we use constrained nonnegative matrix factorization ( cnmf , @xcite ) to better demix neural signals and get their denoised and deconvolved temporal activity . </S>",
    "<S> we validate our method on simulated and experimental data , where it shows fast , reliable , and high quality signal extraction under a wide variety of imaging parameters . </S>"
  ]
}