{
  "article_text": [
    "several fpga - based time - to - digital converter ( tdc ) designs have already been proposed@xcite@xcite .",
    "however , there were many incentives for us to design a new core .",
    "the pvt compensation mechanism of @xcite introduces dead times during which the core is insensitive to incoming signal transitions , which we found undesirable .",
    "the continuous calibration process of @xcite requires that the statistical distribution of transitions within the reference tdc clock periods is uniform .",
    "this may not be the case in systems meant to be part of a particle accelerator , where many events are synchronous to a single clock .",
    "therefore , we devised another technique ( _ online calibration _ ) that does not introduce dead times and is independent of the statistics of the incoming signal .",
    "we also wanted the design to function on spartan-6 fpgas so that it can be used on the spec@xcite boards .",
    "previous works are based on virtex-5 or cyclone - ii fpgas .",
    "finally , no source code is published for any of these designs , which renders it necessary to develop a new core for all practical purposes ( and incidentally makes it more difficult to reproduce and verify the results ) .",
    "our core is available under the lgpl free software license and its full vhdl code can be freely downloaded from http://www.ohwr.org/projects/tdc-core .",
    "the block diagram of the core is given in figure  [ fig : block ] .",
    "the generated timestamp is based on a cycle count and the arrival time within a clock cycle .",
    "the former needs only a simple counter whereas the latter is measured with a tapped delay line .",
    "the fine time measurement is obtained by injecting the signal into the tapped delay line which gives a measurement analogous to a thermometer after the taps are sampled by d flip - flops .",
    "the total delay of the delay line must be greater than the clock period . at each clock tick ,",
    "an encoder counts the taps the signal has reached and gives a _ raw _ measurement of the timestamp of the signal within the current clock cycle .",
    "this raw value is fed into a look - up table ( lut ) which converts it into a calibrated value expressed in subdivisions of the clock cycle , called the _ fractional _ value .",
    "finally , in the _ deskew _ stage , the fractional value is combined with the index of the current clock cycle given by the coarse counter , and the resulting fixed - point value is added a user - defined constant to enable the tdc core to directly generate timestamps relative to the source of the system clock .",
    "the main difficulty with this system is that the delay line is subject to process , temperature and voltage ( pvt ) induced variations , and it needs to be calibrated against them .    to generate the lut contents , the controller switches to the calibration signal .",
    "the key property of the calibration signal is that the probability density of its transition timestamps within a system clock cycle must be constant .",
    "the controller measures the raw timestamps and books a histogram .",
    "because of the constant probability density , the heights of the histogram bars are approximately proportional to the delays between the taps of the delay line after enough measurements have been taken .",
    "further , the last tap to have recorded a signal transition corresponds to a delay equal to the system clock period .",
    "this enables the controller to build the initial contents of the lut .",
    "this process is called _",
    "startup calibration_.    the drawback of the startup calibration is that the system can not operate while the calibration is taking place .",
    "therefore , a process of _ online calibration _ has been devised .",
    "each channel contains a ring oscillator that is placed close to the delay line .",
    "the controller periodically measures the frequency of this ring oscillator , compares it to the frequency that was measured at the time of startup calibration , linearly interpolates the fractional timestamps , and updates the lut .",
    "this allows compensation of temperature and voltage effects while the system keeps running .",
    "the system gives timestamps of both rising and falling edges of the incoming signal .",
    "the rising edges are discerned from the falling edges using the `` polarity '' output .",
    "the delay line uses a carry chain .",
    "it is made up of ` carry4 ` primitives whose ` co ` outputs are registered by the dedicated d flip flops of the same slices .",
    "the signal is injected at the ` cyinit ` pin at the bottom of the carry chain .",
    "the ` carry4 ` primitives have their ` s ` inputs hardwired to 1 , which means the carry chain becomes a delay line with the signal going unchanged through the ` muxcy ` elements ( see @xcite for reference ) .",
    "since each ` carry4 ` contains four ` muxcy ` elements , the delay line has four times as many taps as there are ` carry4 ` primitives .    using the xilinx timing model",
    ", a surprising observation is that some delay differences between consecutive taps are negative .",
    "this probably is at the origin of the `` bubbles '' mentioned in the epfl paper @xcite .",
    "the schematics given by xilinx of the ` carry4 ` primitive is misleading there , and has probably little to do with the actual transistor - level implementation .",
    "the xilinx documentation @xcite gives a hint by describing the primitive as `` fast carry logic _ with look ahead _ '' .",
    "to avoid negative differences , we simply reorder the bits at the output of the delay line to sort the taps by increasing actual delays .",
    "we can then think of the delay line according to figure  [ fig : delaystruct ] .",
    "the bin widths are uneven , but the incoming signal reaches the taps in order .",
    "this last property simplifies the encoder design , since it only has to count the number of identical bits at the beginning of the delay line .          in the formulas below :    * @xmath1 is the system clock period .",
    "* @xmath2 is the number of hits in the histogram at output @xmath3 .",
    "a hit at output @xmath3 means that the signal propagated down to output @xmath3 , without reaching output @xmath4 .",
    "* @xmath5 is the width of bin @xmath3 .",
    "* @xmath6 is the total number of hits in the histogram .",
    "* @xmath7 is the timestamp of an event whose signal propagated down to output @xmath3 ( without reaching output @xmath4 ) , measured backwards from the clock tick . *",
    "@xmath8 ( respectively @xmath9 ) is the current ( respectively reference ) frequency of the online calibration ring oscillator .      at startup ,",
    "the core sends random pulses into the delay line ( coming from a on - chip ring oscillator ) , builds the histogram , computes the delays ( as explained in @xcite ) , and initializes the lut .",
    "we take the first output of the delay line to be the origin of the time measurements , and we define : @xmath10    the width of other bins is proportional to their respective number of counts in the histogram .",
    "the widths sum up to a clock period .",
    "this leads to the following equation : @xmath11    the timestamp is the sum of the widths of the traversed bins : @xmath12    in the tdc core , the unit is the clock period , and the output has @xmath13 base 2 digits after the radix points .",
    "the controller also chooses @xmath14 , where @xmath15 is the number of _ extra histogram bits_. expressed in units of @xmath16 clock periods ( which is the weight of the least significant bit of the fixed - point output ) , we have : @xmath17      online calibration is performed with a simple linear interpolation of the delays relative to the ring oscillator frequencies : @xmath18    note that when @xmath19 , some values can go above the maximum fractional part value of @xmath20 and might not fit in the lut anymore . however , those correspond to delays that now exceed one clock period , and therefore they should almost never get used . in case of overflow ,",
    "the controller saturates the result by using the maximum value @xmath20 in order to give the best approximation in case those lut entries still get used .",
    "the demonstration design runs on a spec board equipped with a fmc dio 5-channel daughterboard .",
    "test signals go through the fmc daughterboard .",
    "the first lemo connector on the daughterboard is configured as output and transmits an oscillating pattern .",
    "the next two lemo connectors are inputs connected to tdc channels .    for measuring the fpga temperature ,",
    "a 1-wire digital thermometer is attached on top of the fpga using kapton tape .",
    "thermal paste improves conduction between the fpga and the sensor .",
    "the tdc core is configured with 2 channels ( to enable differential measurements , see  [ sec : dm ] ) and each delay line has 124 ` carry4 ` elements ( 496 taps ) .    to minimize variations of the timing properties between runs of the automated place and route tool and to maximize thermal coupling between each delay line and its online calibration oscillator ,",
    "the design is floorplanned .",
    "the two delay lines from each channel are placed close to their respective iobs .",
    "the ring oscillator components are placed in the ` slicex ` columns just at the right of the delay lines , and spread evenly along the height of the delay lines .",
    "there is one ring oscillator per channel , which is made of many luts in series .",
    "this is illustrated by figure [ fig : floorplan ] , where the delay lines are colored green and the ring oscillators are blue ( each blue block is a ` slicex ` component containing a lut belonging to one of the two ring oscillators ) .        in the input signal path , there are one multiplexer and one inverter per channel",
    ". everything is packed into one fpga slice , which is also manually placed to minimize timing variations .",
    "the physical input signal path can be seen in figure [ fig : inputpath ] .",
    "the lvds iobs are represented in black , and the routing and the slice in pink .",
    "a limitation of this tdc design is that it does not compensate for pvt variations in the input signal path elements .",
    "the purpose of this experiment is to examine how temperature affects propagation delays .",
    "we slowly heated the fpga ( so it remains in thermal equilibrium with the sensor ) to obtain the plot of figure [ fig : rofreq ] .",
    "the frequency values are directly reported from the tdc core , and are measured in cycles per frequency counter period .",
    "as expected , the frequencies decrease linearly with the temperature , and the two channels follow a near - identical pattern .",
    "the variation is small : about 1.3% for the 15c difference .",
    "however , near the end of the delay line , a 1.3% variation represents about 100ps , so it is important to compensate for the effects of temperature .",
    "we suspect that the constant difference between the two channels is due to process variations across the different locations of the fpga chip where the two ring oscillators are placed , and/or differences in routes chosen by the ` par ` tool to implement the two oscillators .",
    "the startup calibration process relies on an asynchronous clock source which generates tdc events with a uniform random distribution within the system clock cycles .",
    "we wanted to verify that the process is deterministic enough .    with the fpga in thermal equilibrium , we ran the startup calibration twice and compared the resulting lut contents .",
    "the difference is plotted in figure [ fig : scs ] , and is small enough .",
    "the purpose of this test is to determine the precision of the system .",
    "we connected the oscillator output of the fmc dio card to a splitter feeding two cables of different lengths going to the two tdc channels .",
    "those cables had propagation delays of approximately 2ns and 4ns .",
    "we then observed the difference between the two tdc timestamps , which is expected to remain constant ( figure [ fig : dtdc ] ) .",
    "since the oscillator is asynchronous to the system clock , the complete delay line can be covered and tested .",
    "the advantage of this technique is that it is easy to set up and does not require expensive equipment .",
    "a limitation is that the result is not affected by common - mode noise of the input path to the delay line ( figure [ fig : inputpath ] ) .",
    "we made the measurements at thermal equilibrium , with the sensor measuring 36.9375c .",
    "the histogram of the results is shown in figure [ fig : mhist ] .",
    "the results can be modeled with a gaussian distribution having a mean of 2221ps ( which is close to the 4ns-2ns difference in propagation times from the cables ) and a standard deviation of 37ps .",
    "if we suppose that the jitter in each channel is independent and also has a gaussian distribution , we can estimate that its standard deviation is 26ps .",
    "this means that for one channel , 95% of the results are precise to @xmath2152ps .      even though the influence of temperature is small (  [ sec : rofreq ] ) , we can still see the positive action of the online calibration .",
    "after calibrating at 37c , we brought the temperature to 47.875c , and ran startup calibration again .",
    "we observed a significant difference between the lut contents ( figure [ fig : chtmlt ] ) .",
    "the new lut data are very close to what had been extrapolated from the 37c data by the online calibration system ( figure [ fig : chtmht ] ) .",
    "in fact , in this sample the difference is slightly smaller than what we had observed between two startup calibrations at the same temperature ( figure [ fig : scs ] ) .",
    "this shows the good working of the online calibration system .",
    "the results of this experiment are very encouraging , as they show a precision better than that of many commercial tdc chips , but using a lower - cost fpga .",
    "we can also potentially support dozens of channels in the xc6slx45 t of the spec board as the core uses little fpga resources and also shares the calibration logic among all channels .",
    "further , the latency of the core is low ( 6 cycles of the system clock ) and the throughput high ( for each channel , the dead time after an event is 3 cycles of the system clock , which can be brought down to 1 cycle without major architecture changes ) .",
    "this is also better than many commercial solutions .",
    "there are however several areas of improvement .",
    "first , more testing would be welcome , with many boards and fpgas , with deliberate variations of the supply voltage , and within a wider temperature range .    examining the startup calibration histograms",
    "reveals that almost half of the bin widths are zero .",
    "this is due to the particular propagation characteristics of carry chains , which are not the best solution for a delay line ( their advantage , however , is that it is relatively easy to keep the exact same delays between runs of the place - and - route tool ) .",
    "it can make sense to use regular luts and/or general routing to implement the delay line instead , at the cost of increased design difficulty and reduced portability .",
    "the startup calibration process could be improved ( and made almost deterministic ) by using as calibration signal a clock whose frequency is slightly different from the system clock .",
    "this way , the variations shown in figure [ fig : scs ] ( which peak at almost 17ps ) can be reduced or eliminated .",
    "the carry chain is very long and this restricts its possible placements and compatibility with smaller fpgas .",
    "using luts and/or routing would also alleviate this problem .",
    "if better precision is needed , multiple delay lines can work in parallel and their outputs combined , in order to average errors out .",
    "finally , the influence of the input path ( figure [ fig : inputpath ] ) was not thoroughly studied , even though we expect it to be minor .",
    "this work was prepared under an agreement with and funded by cern .",
    "the content of this paper does not necessarily reflect the position or the policy of cern and no official endorsement should be inferred ."
  ],
  "abstract_text": [
    "<S> we have designed , implemented and tested a time - to - digital converter core in a low - cost spartan-6 fpga . </S>",
    "<S> our design exploits the finite propagation speed in carry chains to realize a delay line in which the propagation distance of the incoming signal s edges is measured using hundreds of taps . </S>",
    "<S> this technique enables the core to reach a precision far better than the minimum switching period of the fpga flip - flops . to compensate for process , voltage and temperature ( pvt ) effects </S>",
    "<S> , our design uses a combination of two techniques : startup calibration and online calibration . </S>",
    "<S> the startup calibration uses a statistical method to estimate the delay between the taps of the delay line and helps eliminate the effect of process variations . </S>",
    "<S> the online calibration , which takes place without disruption of the core s operation , uses a ring oscillator whose frequency instability is measured and used to compensate for subsequent voltage and temperature effects on the delay line . </S>",
    "<S> our tests show that our design reaches a precision of @xmath0 ps rms over a temperature range of 37c to 48c .    [ </S>",
    "<S> types and design styles ] </S>"
  ]
}