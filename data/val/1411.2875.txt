{
  "article_text": [
    "the dynamics of complex stochastic systems are often governed by rare events - examples include protein folding , macromolecular association , or phase transitions . these rare events lead to sampling problems when trying to compute expectation values from computer simulations , such as molecular dynamics ( md ) or markov chain monte carlo ( mcmc ) .",
    "one approach to alleviate such sampling problems is to increase the rate at which the rare events occur by generating and combining simulations at different thermodynamic states .",
    "for example , proteins can easily be unfolded at high temperatures , and protein - ligand complexes can dissociate at artificial hamiltonians , where protein and ligand have reduced interaction energies .",
    "generalized ensemble methods , such as replica exchange molecular dynamics , parallel tempering and simulated tempering exploit this observation by coupling simulations at different temperatures or hamiltonians within an mcmc framework .",
    "yet another example is umbrella sampling@xcite which uses a set of biased hamiltonians to ensure approximately uniform sampling along a set of pre - defined slow coordinates .",
    "all of the aforementioned enhanced sampling methods are constructed such that for long simulation times , the equilibrium distribution of each thermodynamic state will be sampled from . with that in mind , reweighting estimators make use of all simulation data by reweighting each probability density from the thermodynamic state sampled at to the condition of interest _ via _ the boltzmann density . the most frequently used reweighting estimators are the weighted histogram analysis method ( wham ) @xcite , bin - less wham @xcite and the multi - state bennett acceptance ratio ( mbar ) method @xcite .",
    "the most common use of reweighting is to obtain equilibrium expectations or free energy differences .",
    "reweighting can also be applied to obtain dynamical information from the available contiguous trajectory pieces @xcite .",
    "when the probability density of trajectories can be evaluated , mbar can be applied to trajectories instead of sample configurations , obtaining estimates of dynamical expectations @xcite .",
    "both wham and mbar are statistically optimal under specific assumptions as they can be derived from maximum - likelihood or minimum variance principles @xcite .",
    "however , a key assumption of both estimators is that data is given as statistically independent samples of the respective equilibrium distributions . in reality ,",
    "md and mcmc simulations provide time - correlated data trajectories .",
    "consequently , estimators exploiting the time - correlation in the data can achieve significantly better results@xcite .",
    "in particular , wham and mbar can not obtain unbiased estimates from datasets for which the initial conditions of harvested trajectories do not come from a probability density that is known a priori .",
    "examples of such datasets are swarms of short uncoupled trajectories @xcite or metadynamics and conformational flooding during the fill - up phase @xcite .",
    "a complementary approach to address sampling problems is markov state modeling @xcite . a markov state model ( msm ) transition matrix contains conditional transition probabilities between discrete configuration states at some lagtime @xmath0 . given the transition matrix ,",
    "an equilibrium distribution can be computed that is unbiased if each transition event used for estimating the msm originates from a local equilibrium distribution restricted to respective discrete state @xcite . in this case , msms are able to reweigh trajectories that are not sampled from global equilibrium without any a priori knowledge of the transition probabilities . in order to use msms for computing kinetics",
    ", @xmath0 must be long enough for transition events to approximately decorrelate for a given configuration space discretization @xcite . since msm estimators are purely based on observed transition statistics they can not combine the information from different thermodynamic states .",
    "therefore , the orders - of - magnitude speedup that can sometimes be achieved with enhanced sampling methods has not been accessible to msms as yet .",
    "the transition - based reweighting analysis method ( tram ) @xcite aims at combining the advantages of reweighting estimators and msms . in ref .",
    "@xcite , we have defined tram as a class of estimators that ( 1 ) take the statistical weights of samples at different thermodynamic states into account , in order to reweigh these samples ; and ( 2 ) exploits transitions observed in the sampled trajectories , without assuming that these trajectories are sampled from equilibrium . ref . @xcite",
    "introduced a statistically optimal estimator for non - equilibrium trajectories given that the statistical weight of each trajectory can be evaluated .",
    "conceptually , an optimal tram estimator could be formulated from this principle . in practice , however , data is typically not stored at every integration time step , such that trajectory probability densities are not available .    in ref .",
    "@xcite , we have introduced the first tram estimator that is applicable to practical molecular dynamics data , and could show that it can provide superior estimates of equilibrium probabilities and free energy compared with wham .",
    "however , the estimator in ref .",
    "@xcite is only approximately optimal and is very tedious to compute .",
    "another tram estimator is presented in ref .",
    "@xcite and called the dynamic histogram analysis method ( dham ) .",
    "dham was shown to avoid systematic errors that may occur when analyzing umbrella sampling with wham .",
    "dham uses a dynamical model ( diffusion along a reaction coordinate ) to relate transition matrices of simulations at different bias potentials .",
    "this assumption is helpful when a diffusion model is appropriate and there is one or a few slow reaction coordinates only ( e.g. as in the case of umbrella sampling ) . in this way it regularizes the solution and",
    "therefore makes the estimates statistically more stable . in ref .",
    "@xcite we introduced xtram , which does not assume a specific dynamical model but only exploits the fact that samples can be reweighted in order to couple different thermodynamic states .",
    "moreover , xtram is as yet the only tram estimator that avoids the discretization of reweighting factors required in the other tram methods and as well as in wham .",
    "xtram may provide substantial improvements compared to mbar for time - correlated data , is shown to be asymptotically exact , and is shown to converge to mbar when the data is not time correlated @xcite .",
    "however , xtram was not derived from a maximum - likelihood or minimum - variance principle and is therefore probably not statistically optimal for finite data sets .    in the present paper , we provide for the first time a statistically optimal tram method by presenting a maximum - likelihood solution to the discrete tram problem formulated in ref .",
    "we derive a set of self - consistent equations whose solution yields the maximum likelihood dtram estimator .",
    "it is shown that the dtram solution is an asymptotically correct estimator , i.e. it converges to the exact equilibrium probabilities and transition probabilities with an increasing amount of simulation data .",
    "the dtram equations can be solved using a newton method , as done before for wham and mbar @xcite , or an easy - to - implement iterative algorithm provided here .",
    "we show that dtram becomes identical to wham in the limit of statistically independent samples , i.e. sampled from the global equilibrium at each thermodynamic state .",
    "moreover , dtram becomes identical to a reversible msm when we have only a single thermodynamic state .",
    "a number of applications are shown to demonstrate the usefulness and versatility of dtram .",
    "we assume that a set of md or mcmc simulations have been performed , each in one of @xmath1 thermodynamic states ( indexed by the superscript @xmath2 ) . for simulations in which the thermodynamic state is frequently changed , such as in replica - exchange simulations , each contiguous sequence is treated as a separate trajectory at one of the @xmath1 thermodynamic states .",
    "furthermore , we assume that the data has been discretized to a configuration space partition ( indexed by subscripts @xmath3 ) .",
    "we are primarily interested in the free energy , or equivalently , the equilibrium probability of discrete states in some unbiased or reference ensemble @xmath4 .",
    "in addition we might be interested in the equilibrium probability of states under all biased ensembles .",
    "if the simulation trajectories are long enough , we will also be able to compute kinetic properties , as discussed later .",
    "we will be dealing with simulations where the unbiased , or reference probability @xmath5 and the biased probability at simulation condition @xmath6 , @xmath7 are related by a known and constant bias factor @xmath8 :    @xmath9    where @xmath10 is a normalization constant .",
    "thus , the bias is multiplicative in probabilities or additive in the potential .",
    "this formalism is applicable whenever one has simulations conducted at different thermodynamic states , such as replica - exchange methods or umbrella sampling , but also direct simulations at different temperatures or hamiltonians . in the results section",
    ", we will show how the reweighting factor @xmath8 can be computed for a few selected examples .",
    "the most common analysis method used in the present scenario is wham .",
    "wham uses the histogram counts @xmath11 , i.e. the number of samples falling into bin @xmath12 at thermodynamic state @xmath6 .",
    "although wham was originally derived as a minimum - variance estimator@xcite , it can be derived as a maximum - likelihood estimator@xcite using the likelihood @xmath13 which simply assumes that every count @xmath11 is independently drawn from the biased distribution @xmath7 , which is linked to the unbiased distribution @xmath14 _ via _ eq .",
    "( [ eq : reweighting_1 ] ) .",
    "let us now turn to reversible markov state models @xcite .",
    "the maximum likelihood markov model is the transition matrix @xmath15 between @xmath16 discrete configuration states , that maximizes the likelihood of the observed transitions between these states .",
    "the likelihood of a markov model is well known@xcite , and simply a product of all transition probabilities corresponding to the observed trajectory . to obtain a reversible markov state model ,",
    "this likelihood is maximized using the constraints that the transition probabilities @xmath17 must fulfill detailed balance with respect to the equilibrium distribution @xmath14 : @xmath18 where @xmath19 is the number of times the trajectories were observed in state @xmath12 at time @xmath20 and in state @xmath21 at a later time @xmath22 , where @xmath0 is the lag time at which the markov model is estimated . for an msm ,",
    "all simulation data producing counts @xmath19 , has to be generated at the same thermodynamic state ( e.g. temperature , hamiltonian ) , and the estimated @xmath23 is then only valid for this thermodynamic state .",
    "the reversibility of the msm is ensured by the constraint equations ( [ eq : msm - dbconstraint ] ) .",
    "estimators that maximize eqs .",
    "( [ eq : msm - likelihood]-[eq : msm - dbconstraint ] ) usually provide both @xmath23 and the equilibrium distribution @xmath14 @xcite .    in tram , we combine these two approaches as follows : we avoid the wham assumption that every count is sampled from global equilibrium , and instead treat every trajectory at thermodynamic condition @xmath6 as a markov chain with the configuration - state transition counts @xmath24 . however , in contrast to markov models we exploit the fact that equilibrium probabilities can be reweighted between different thermodynamic states via ( [ eq : reweighting_1]-[eq : reweighting_2 ] ) .",
    "the resulting likelihood of all @xmath25 and @xmath14 , based on simulations at all thermodynamic states can be formulated as : @xmath26 here , @xmath27 is the markov transition matrix at thermodynamic state @xmath6 , and @xmath24 are the number of transitions observed at that simulation condition .",
    "@xmath28 is the vector of equilibrium probabilities of discrete states at each thermodynamic state .",
    "note that all of these @xmath1 equilibrium distributions are coupled through eqs .",
    "( [ eq : reweighting_1]-[eq : reweighting_2 ] ) . because each markov model @xmath25 must have the distribution @xmath28 as a stationary distribution , all markov models are coupled too .",
    "this is what makes the maximization of the tram likelihood eqs .",
    "( [ eq : tram - likelihood]-[eq : tram - dbconstraint ] ) difficult , and it can neither be achieved by wham , nor by existing msm estimators .",
    "we call eqs .",
    "( [ eq : reweighting_1],[eq : reweighting_2],[eq : tram - likelihood],[eq : tram - dbconstraint ] ) the tram equations . in the present paper",
    "we will obtain the reweighting factors @xmath8 in eqs .",
    "( [ eq : reweighting_1]-[eq : reweighting_2 ] ) by a configuration space discretization or binning , such as in wham . for this reason we call the present solution a discrete tram method , which should be distinguished from approaches where the reweighting is done for individual samples @xcite .",
    "we will seek the maximum likelihood of eq .",
    "( [ eq : tram - likelihood ] ) . as in common practice ,",
    "we work with the logarithm of the likelihood , because it has the same maximum point as the likelihood but can be treated more easily : @xmath29 moreover , we have the following constraints .",
    "using detailed balance eq .",
    "( [ eq : tram - dbconstraint ] ) with the reweighting equations ( [ eq : reweighting_1]-[eq : reweighting_2 ] ) results in @xmath30 note that the normalization factors , @xmath10 , have cancelled .",
    "in addition , @xmath25 should be a transition matrix and @xmath14 should be a probability vector , so we have the normalization conditions :    @xmath31    the normalization of @xmath28 is achieved by the normalization constants in eq .",
    "( [ eq : reweighting_1])-([eq : reweighting_2 ] ) .    in order to solve the discrete tram problem we have to maximize the log likelihood ( [ eq : tram - log - likelihood ] ) under the constraints ( [ eq : tram - constraint1]-[eq : tram - constraint3 ] ) .",
    "the variables are both the unbiased equilibrium probabilities @xmath14 ( providing @xmath32 variables due to the constraint ( [ eq : tram_iteration_pi ] ) ) , and the biased transition matrices @xmath25 ( each having @xmath33 remaining free variables that are not fixed by constraints ( [ eq : tram - constraint1])-([eq : tram - constraint2 ] ) ) .",
    "note that changing the simulation conditions , such as bias or temperature , will modify the transition probabilities in a non - trivial way that depends on the simulation condition , the integrator and thermostat used , and the state space discretization .",
    "therefore we can not relate the different @xmath25 without restricting the generality of our estimator .",
    "the only general connection between these markov models is the coupling of their equilibrium distributions via eqs .",
    "( [ eq : reweighting_1]-[eq : reweighting_2 ] ) .    in appendix a.1 - 3",
    ", we use lagrange duality theory to show that the optimal solution of the discrete tram problem above fulfills the following two conditions : @xmath34    where @xmath35 are unknown lagrange multipliers . in the setting with detailed balance",
    "we can unfortunately not give a closed expression for them , but we can optimize them along with the equilibrium distribution @xmath14 . note that the equations above do not require the transition probabilities @xmath36 to be computed explicitly . if these are desired , they can be subsequently computed from the solution of eqs .",
    "( [ eq : dtram_equation1]-[eq : dtram_equation2 ] ) ( see sec . [ sub : kinetics ] below ) .    in appendix",
    "a.4 we prove that the dtram equations above are asymptotically correct .",
    "this means that in the limit of a lot of simulation data - either realized by long trajectories or many short trajectories - the estimate will converge to the correct stationary distributions @xmath14 and @xmath28 .",
    "we can rewrite the self - consistent equations ( [ eq : dtram_equation1],[eq : dtram_equation2 ] ) to derive the following iteration ( fixed - point method ) , that can be used to numerically solve the discrete tram problem .",
    "first we initialize @xmath14 and @xmath37 by the simple guess : @xmath38 and then we iterate the following equations until @xmath14 is converged : @xmath39 instead of the simple @xmath40 initialization for @xmath5 in eq .",
    "( [ eq : initial_guess_pi ] ) , we could use the standard wham algorithm to obtain a much better guess @xcite .",
    "while a better starting point might be relevant for optimizing computational performance , we have not observed the estimation result to depend on this choice .    as an alternative to the fixed - point iteration ( [ eq : tram_iteration_v],[eq : tram_iteration_pi ] )",
    ", we can solve equations ( [ eq : dtram_equation1],[eq : dtram_equation2 ] ) by using the multidimensional newton method for root finding available in many numerics packages .",
    "given @xmath14 and @xmath37 at their optimal values , the transition probabilities can be computed for any thermodynamic state @xmath6 simulated at by : @xmath41 see appendix a.2 for the derivation . in eq .",
    "( [ eq : pij ] ) we have explicitly stated that transition counts , and hence the transition probabilities are estimated at a given lag time @xmath0 .",
    "as a consequence of the asymptotic correctness of dtram ( appendix a.4 ) , the estimates of @xmath42 are also asymptotically correct , that is for either long trajectories or many short trajectories we will get an unbiased estimate of the transition probabilities .    in order to compute kinetics , such as transition rates or timescales , the transition matrices",
    "@xmath25 do not only have to be valid for the lag time @xmath0 estimated at , but they have to be markov models that predict the kinetics at longer times correctly .",
    "how adequate @xmath25 is as a markov model should be tested by validating that the relaxation timescales computed from the eigenvalues of @xmath25 are approximately constant in @xmath0 @xcite and by checking that the chapman - kolmogorow @xmath43^{n}$ ] approximately holds @xcite .",
    "the @xmath25 can only be used as markov models when the contiguous simulation trajectories are long enough to support a suitable lag time @xmath0 .",
    "generalized ensemble simulations , such as replica - exchange , parallel or simulated tempering generally only provide very short contiguous trajectory pieces and are only suitable for constructing markov models of small systems and using excellent configuration state discretizations @xcite .    based on umbrella sampling simulations , the construction of markov models at the different umbrellas @xmath6 is usually possible , but for the unbiased system we can only obtain the equilibrium distribution @xmath14 and not the markov model .",
    "the reason is that the transition matrices ( [ eq : pij ] ) can only be estimated at the different simulation conditions @xmath6 , whereas the equilibrium probability of the chosen reference ensemble @xmath14 is computed through reweighting , and is thus also available for thermodynamic states not simulated at .",
    "however , the umbrella - markov models @xmath25 could still provide useful information . for example comparing the longest relaxation timescale of each umbrella markov model with the respective simulation length could be used as an indicator of convergence , and whether some or all simulation lengths should be increased @xcite .",
    "unbiased md simulations at different thermodynamic states are most suitable for constructing markov models , because one has the choice of running simulations long enough to accommodate a suitable lag time @xmath0 .",
    "a systematic way of constructing such simulations is the random swapping protocol @xcite .",
    "note that such simulations may not only violate the sampling from global equilibrium , but also the sampling from local equilibrium , it is possible that the estimation of @xmath14 and all associated stationary estimates are biased for short lag times @xmath0 .",
    "therefore , when using dtram to analyze unbiased md simulations at different thermodynamic states , one should definitely compute the estimates as a function of @xmath0 in order to ensure that a large enough @xmath0 is used to obtain unbiased estimates .",
    "we now show that the commonly used wham method is obtained as a special case of dtram .",
    "starting from the dtram estimator , we employ the wham assumption that each sample at thermodynamic state @xmath6 is independently generated from the biased probability distribution @xmath44 .",
    "this means that transition probabilities @xmath36 are equal to the probability of observing state @xmath21 without knowledge of @xmath12 : @xmath45 in a setting where counts are generated independently , the transition counts @xmath24 can be modeled by splitting up the total counts ending in bin @xmath21 according to the equilibrium probability that they have been in a given bin @xmath12 before : @xmath46 note that this selection generates actually observed histogram counts as @xmath47 . substituting @xmath48 in ( [ eq : p - ind]-[eq : c - ind ] ) using ( [ eq : reweighting_1]-[eq : reweighting_2 ] ) and inserting the result into eq .",
    "( [ eq : pij ] ) yields the equalities @xmath49 which must hold for all @xmath12 and @xmath6 .",
    "this is exactly the case when the lagrange multipliers become : @xmath50 substituting ( [ eq : c - ind ] ) and ( [ eq : nu - c ] ) into ( [ eq : tram_iteration_pi ] ) gives us the solution for the unbiased stationary probabilities : @xmath51 which is exactly the wham algorithm @xcite .",
    "therefore , wham is a special case of dtram , suggesting that tram should yield estimates that are at least as good as wham , but should give better estimates when the wham assumptions of sampling from global equilibrium at condition @xmath6 does not hold .",
    "now we relate dtram to reversible markov models .",
    "suppose we only have a single thermodynamic state @xmath6 and one or several simulation trajectories generating counts @xmath19 at this condition . in this case we can drop the index @xmath6 , all reweighting factors are unity @xmath52 , and equations ( [ eq : dtram_equation1]-[eq : dtram_equation2 ] ) become :",
    "@xmath53 we can combine both equations to : @xmath54 thus we solve for the lagrange multipliers : @xmath55 substituting @xmath56 into ( [ eq : dtram_equation2 ] ) leads to the optimality condition for @xmath5 : @xmath57 inserting the result into ( [ eq : pij ] ) yields the reversible transition matrix estimator : @xmath58 which is identical to the known optimality condition for a reversible markov model transition matrix and the corresponding iterative estimator @xcite .",
    "therefore , a reversible msm is a special case of dtram .",
    "we start with a simple example to illustrate a scenario in which the classical wham estimator fails because the assumption of sampling from global equilibrium is not fulfilled . fig .",
    "[ fig : discrete_example]a shows the energy levels @xmath59 of a discrete three - state system .",
    "we consider a metropolis - hastings jump process between neighboring states . due to the high - energy transition state @xmath60 ,",
    "the minima @xmath61 and @xmath62 are long - lived and escaping them is a rare event .",
    "now we run a simulation consisting of three independent trajectories :    1 .   an unbiased trajectory of length @xmath63 starting state @xmath61 2 .   an unbiased trajectory of length @xmath63 starting state @xmath62 3 .   a trajectory of length @xmath63 using bias @xmath64 starting in state @xmath60 .    the biased trajectory 3 samples from an energy landscape that is flat over @xmath61 , @xmath62 and @xmath60 .",
    "trajectories 1 and 2 will be stuck in states @xmath61 or @xmath62 , respectively , and only be able to escape them when @xmath63 is sufficiently long .",
    "trajectories 1 and 2 are using the same unbiased hamiltonian and are therefore in the same thermodynamic state @xmath65 .",
    "the corresponding reweighting factor is simply : @xmath66 for all states @xmath67 .",
    "trajectory 3 is in a different thermodynamic state with a biased hamiltonian that we shall call @xmath68 .",
    "we use the bias as a reweighting factor : @xmath69 for all states @xmath67 . in this way we can reweigh all samples between the two thermodynamic states and produce estimates of the energies @xmath70 using both wham with eqs .",
    "( [ eq : wham_iteration_pi]-[eq : wham_iteration_f ] ) and dtram with eqs ( [ eq : tram_iteration_v]-[eq : tram_iteration_pi ] ) .    because states @xmath61 and @xmath62 are long - lived , we expect that the unbiased trajectories 1 and 2 can not sample from the global equilibrium , unless the simulation times @xmath63 is very long . as a result",
    "the wham estimator is strongly biased initially and systematically underestimates the energy differences - see solid lines in fig .",
    "[ fig : discrete_example]b . only after about @xmath71 steps , the bias of the wham estimator is negligible .",
    "in contrast , the dtram estimate is unbiased even for short simulation lengths - see dashed lines in fig . [",
    "fig : discrete_example]b .",
    "dtram does not suffer from the wham bias because each transition count is indeed independent from the previous transition count , even when the simulation does not sample from global equilibrium .",
    "moreover , the uncertainty of the dtram estimate is much smaller than the uncertainty of the wham estimate .",
    "this is because every transition count is an independent sample , and therefore dtram benefits from a much larger statistical efficiency than wham .    while illustrative , this example is over - simplistic . in reality",
    ", we do not have discrete states and the dynamics is no markov chain .",
    "let us investigate next how dtram performs in a more realistic setting .",
    "( a)comparison of wham and dtram estimation results using three independent trajectories sampling from three discrete states ( two unbiased trajectories starting in @xmath61 and @xmath62 respectively , and biased trajectory sampling from a flat energy landscape over @xmath61 , @xmath60 and @xmath62 ) .",
    "( a ) schematic of the energies of three states .",
    "error bars correspond to one standard deviation of the estimate computed over 25 independent runs .",
    "( b ) estimation of the energies of @xmath61 , @xmath60 and @xmath62 using wham ( solid lines ) and dtram ( dashed lines).,title=\"fig : \" ]    ( b)comparison of wham and dtram estimation results using three independent trajectories sampling from three discrete states ( two unbiased trajectories starting in @xmath61 and @xmath62 respectively , and biased trajectory sampling from a flat energy landscape over @xmath61 , @xmath60 and @xmath62 ) .",
    "( a ) schematic of the energies of three states .",
    "error bars correspond to one standard deviation of the estimate computed over 25 independent runs .",
    "( b ) estimation of the energies of @xmath61 , @xmath60 and @xmath62 using wham ( solid lines ) and dtram ( dashed lines).,title=\"fig : \" ]      in umbrella sampling , one introduces for each simulation @xmath6 an additive bias potential , such that our total potential in simulation @xmath6 is given by @xmath72 where @xmath12 is a bin index of one or several finely discretized coordinates in which the bias potential is acting .",
    "@xmath73 is the unbiased potential evaluated at bin @xmath12 ( usually at its center ) , and @xmath74 is the value of the @xmath6th umbrella ( bias ) potential .",
    "all energies are dimensionless ( i.e. in units of the thermal energy @xmath75 ) .",
    "the biased equilibrium probabilities are proportional to : @xmath76 with the unbiased equilibrium probability and the reweighting factors given by : @xmath77 umbrella sampling is typically employed using stiff constraining potentials , such that the simulations quickly decorrelate . in such a scenario , wham is a suitable estimator for extracting unbiased equilibrium probabilities and free energy differences .",
    "however , an analysis of umbrella sampling data can indeed benefit from using dtram .",
    "firstly , dtram uses conditional transition events , and the number of statistically independent observations thus depends on a lag time @xmath0 which can be thought of as a local decorrelation time , i.e. a time at which transitions become statistically independent .",
    "this time is generally shorter than the global decorrelation time ( or statistical inefficiency ) @xmath78 , at which samples generated by the trajectory become statistically independent .",
    "thus , whenever @xmath78 is longer than the interval at which configurations are saved , dtram will be able to exploit that this data more efficiently than wham .",
    "this should lead to improved estimates .    moreover , umbrella sampling can , in conjunction with wham , result in systematic errors that can be avoided with a tram estimator : as shown in@xcite , using umbrellas that are too weak to stabilize the simulation at a transition state can lead to umbrella simulations that still have high internal free energy barriers and therefore do not generate samples that are drawn from the respective equilibrium distribution .",
    "although a wham estimate would be correct in the limit of infinitely long simulation times , it may provide drastically biased estimates for practical simulation times .",
    "here , we employ umbrella sampling simulations on a one - dimensional double - well potential with a dimensionless energy : @xmath79 illustrated in fig .  [",
    "fig : us - doublewell]b , c .",
    "the configuration space is discretized using a one dimensional binning : all @xmath80-values are assigned to the closest point from the set @xmath81 , generating up to 101 discrete states .",
    "however , in practice only about 80 states are visited and we exclude empty bins from the analysis .",
    "umbrella sampling simulations are conducted using @xmath82 different biasing potentials given by : @xmath83 where @xmath84 is the center of the @xmath6-th biasing potential .",
    "the dynamics are simulated using the metropolis process described in appendix c. the bias potentials are chosen relatively weak , such that the umbrella simulations near the transition state contain rare events . in this case , wham is a poor estimator because it takes relatively long to generate statistically independent samples .    in order to apply dtram",
    ", we evaluate all bias potentials for each discrete state , compute the reweighting factors according to eq .",
    "( [ eq : reweighting - factor - us ] ) , and store this information in a reweighting matrix .",
    "we additionally store all state - to - state transition counts @xmath24 for each umbrella simulation @xmath6 .",
    "given this data the dtram estimation is computed by iterating equations ( [ eq : tram_iteration_v]-[eq : tram_iteration_pi ] ) to convergence .",
    "the performances of wham and dtram are compared in terms of the mean error of the estimated energy barriers : @xmath85 where @xmath86 and @xmath87 are the energy barriers for the @xmath88 and @xmath89 process , respectively , and the superscript `` @xmath90 '' represents the approximate value obtained from the estimated @xmath91 .",
    "[ fig : us - doublewell]a compares the energy barrier estimation error using wham ( black ) and dtram ( red ) as a function of the length of the umbrella simulations . in addition , estimation results our earlier approximate tram method from @xcite are shown in blue . fig .",
    "[ fig : us - doublewell]b and c show the energy profile estimated from the data using trajectory lengths of @xmath92 and @xmath93 steps per umbrella , respectively .",
    "all means and standard deviations are obtained by repeating the simulation 30 times .",
    "it is apparent that both estimators converge to the correct energy barriers and energy profile in the limit of a large amount of simulation data . for short simulations ,",
    "the dtram estimates are significantly better than the wham and approximate tram estimates - or in other words much less simulation data is needed with dtram to obtain estimates of equal quality than when wham or approximate tram are used .",
    "( a)estimation results of wham , the present method ( dtram ) , and our early approximate tram method ( atram ) from @xcite based on umbrella sampling simulations in a double - well potential . (",
    "a ) mean and standard deviation of the energy barrier estimation error calculated over @xmath94 independent umbrella sampling runs with @xmath82 umbrellas each .",
    "the @xmath80-axis shows the number of steps in an umbrella trajectory .",
    "( b ) mean and standard deviation of estimates of the potential @xmath91 generated by wham , dtram and approximate tram using a trajectory length of @xmath95 .",
    "( c ) same as ( b ) , but with a trajectory length of @xmath93.,title=\"fig : \" ]    \\(b ) estimation results of wham , the present method ( dtram ) , and our early approximate tram method ( atram ) from @xcite based on umbrella sampling simulations in a double - well potential .",
    "( a ) mean and standard deviation of the energy barrier estimation error calculated over @xmath94 independent umbrella sampling runs with @xmath82 umbrellas each .",
    "the @xmath80-axis shows the number of steps in an umbrella trajectory .",
    "( b ) mean and standard deviation of estimates of the potential @xmath91 generated by wham , dtram and approximate tram using a trajectory length of @xmath95 .",
    "( c ) same as ( b ) , but with a trajectory length of @xmath93.,title=\"fig : \" ]    \\(c ) estimation results of wham , the present method ( dtram ) , and our early approximate tram method ( atram ) from @xcite based on umbrella sampling simulations in a double - well potential .",
    "( a ) mean and standard deviation of the energy barrier estimation error calculated over @xmath94 independent umbrella sampling runs with @xmath82 umbrellas each .",
    "the @xmath80-axis shows the number of steps in an umbrella trajectory .",
    "( b ) mean and standard deviation of estimates of the potential @xmath91 generated by wham , dtram and approximate tram using a trajectory length of @xmath95 .",
    "( c ) same as ( b ) , but with a trajectory length of @xmath93.,title=\"fig : \" ]    in order to demonstrate the validity of dtram on molecular dynamics data of a large protein system , we have used it to analyze umbrella sampling simulations of the passage of na@xmath96 ions through the transmembrane pore of the glic channel ( fig .",
    "[ fig : us - ion - channel ] ) .",
    "the data was generated in the simulations of zhu and hummer @xcite .",
    "wham and dtram provide a similar free energy profile ( fig .",
    "[ fig : us - ion - channel]b ) , but for a given number of bins used to discretize the membrane normal used as a reaction coordinate , dtram provides a smaller systematic error . the systematic error is measured in terms of the energy difference calculated for the two end - states which should be 0 as a result of the periodic boundary conditions used in the simulation ( fig . [",
    "fig : us - ion - channel]c ) .",
    "estimation results of wham and dtram based on umbrella sampling simulations of na@xmath96 passage through a glic channel using simulations of zhu and hummer @xcite .",
    "( a ) structure of the ion channel .",
    "( b ) free energy profile computed by wham and dtram when using 400 bins to discretize the reaction coordinate ( membrane normal ) .",
    "( c ) systematic estimating error of the energies of the end - states , measured by its difference from 0 , as a function of the number of discretization bins used . ]",
    "we have derived a maximum likelihood estimator for the transition - based reweighting analysis method ( tram ) .",
    "this estimator optimally combines simulation trajectories produced at different thermodynamic states .",
    "this is done by taking into account both the time correlations in the trajectories via transition counts , and by considering that the weight of every configuration can be given in any thermodynamic state via the boltzmann distribution .",
    "the present estimator operates a configuration space discretization , and in particular also discretizes the reweighting factors between different thermodynamic states .",
    "hence we call the present method discrete tram , or in short dtram",
    ".    dtram combines ideas from the weighted histogram analysis method ( wham ) and reversible markov state models ( msms ) .",
    "we have shown that dtram is in fact a proper generalization of both methods , i.e. both the wham estimator and the reversible msm estimator can be derived as special cases from the dtram equations . consequently , dtram can be applied to any kind of simulation data that either wham or msms can be applied to . in particular , dtram is useful for getting improved estimates from general - ensemble simulations ( replica - exchange molecular dynamics , parallel or simulated tempering ) , multiple biased simulations ( umbrella sampling , metadynamics , conformational flooding etc ) . like msms , dtram is useful for obtaining estimates from swarms of short simulations that are not in global equilibrium , but beyond msms it can do so for trajectories produced under different thermodynamic conditions , such as temperatures or hamiltonians .",
    "dtram provides estimates for both the equilibrium distribution at a thermodynamic state of interest , and the kinetics at the thermodynamic states simulated at .",
    "the kinetic estimates should be treated with care as they are only useful when the data admits the choice of a lagtime that is sufficiently long to parametrize a markov model that can predict long - term kinetics . for such estimates",
    ", it should be checked whether they are converged as a function of the lag time , as it is common practice in markov state modeling .",
    "we will investigate the suitability of dtram to estimate kinetic data in future work . in the present paper we have only worked with short trajectory segments , and",
    "hence have only used dtram in order to estimate equilibrium distributions and free energies .",
    "it has been demonstrated that dtram provides superior estimates of these properties compared to wham when applied to biased simulations .",
    "the present reweighting formulation is straightforwardly applied when the configuration space can be discretized in such a way that the bias factor @xmath8 is approximately constant within each bin .",
    "although such a discretization is easily done for umbrella sampling while biasing one or two coordinates , it is unsuitable in other cases , such as replica - exchange simulations .",
    "it has been suggested to construct a joint discretization in configuration and energy space @xcite .",
    "an optimal solution to the problem will involve a self - consistent evaluation of @xmath8 in a way that integrates the sampled configurations assigned to bin @xmath12 with a mbar - like approach @xcite .",
    "a python implementation of the dtram method is available under https://github.com/markovmodel/pytram .",
    "* acknowledgements *    the authors thank following colleagues for enlightening discussions : john d. chodera ( mskcc , new york ) , gerhard hummer ( mpi for biophysics , frankfurt ) , alessandro laio ( sissa , trieste ) , roland r. netz ( fu berlin ) and the entire cmb team at fu berlin .",
    "we thank fangqiang zhu for providing us with the umbrella sampling simulation data of the glic ion channel .",
    "this work was funded from following grants : wu 744/ 1 - 1 and dfg sfb 1114 ( wu ) , dfg sfb 740 and 958 ( mey ) , erc grant `` pccell '' ( no ) .",
    "43ifxundefined [ 1 ] ifx#1 ifnum [ 1 ]",
    "# 1firstoftwo secondoftwo ifx [ 1 ] # 1firstoftwo secondoftwo `` `` # 1''''@noop [ 0]secondoftwosanitize@url [ 0 ]  + 12$12  & 12#1212_12%12@startlink[1]@endlink[0]@bib@innerbibempty ( ,  )  pp .",
    "@noop * * ,   ( ) @noop * * ,   ( ) @noop * * ,   ( ) @noop * * ,   ( ) @noop * * ,   ( ) @noop * * ,   ( ) @noop * * ,   ( ) @noop * * ,   ( ) @noop * * ,   ( ) @noop * * ,   ( ) @noop * * ,   ( ) @noop * * ,   ( ) @noop * * ,   ( ) @noop * * ,   ( ) @noop * * ,   ( ) link:\\doibase 10.1002/jcc.21186 [ * * ,   ( ) ] @noop * * ,   ( ) @noop * * ,   ( ) @noop ( ) @noop * * ,   ( ) @noop * * ,   ( ) link:\\doibase 10.1073/pnas.1103547108 [ * * , ( ) ] @noop * * ,   ( ) @noop * * ,   ( ) @noop * * ,   ( ) @noop * * ,   ( ) @noop * * ,   ( ) @noop * * ,   ( ) @noop * * ,   ( ) @noop * * ,   ( ) @noop * * ,   ( ) @noop * * ,   ( ) @noop * * ,   ( ) @noop * * ,   ( ) @noop * * ,   ( ) @noop * * ,   ( ) link:\\doibase 10.1063/1.3216567 [ * * ,   ( ) ] @noop _ _ , , vol .  ( ,  ,  ) @noop * * ,   ( ) @noop _ _  ( ,  ) @noop _ _ ( ,  ) @noop _ _  ( , )",
    "a detailed description of lagrange duality theory we refer to textbooks @xcite .",
    "here we just summarize a few aspects of the theory relevant for solving the tram problem .    consider a constrained minimization problem of the following form : @xmath97 the lagrangian function",
    "can be defined by @xmath98 if ( [ eq : convex - problem ] ) is a convex problem and some technical assumption such as slater condition holds , it can be proven that ( [ eq : convex - problem ] ) is _ equivalent _ to the following maximization problem : @xmath99 where @xmath100 is the lagrange dual function defined by @xmath101 the equivalence here means the optimal values of the two problems are equal , i.e. , the solution @xmath102 to ( [ eq : convex - problem ] ) and the solution @xmath103 to ( [ eq : dual - problem ] ) satisfies @xmath104 .",
    "moreover , @xmath105      we first consider the dual lagrange approach to solving dtram at a single thermodynamic state , i.e. the situation that is equivalent with a reversible markov state model . here",
    "we first ignore the normalization of the stationary distribution @xmath14 , i.e. , @xmath106 may not be equal to @xmath107 .",
    "the maximum likelihood estimation of the transition matrix @xmath23 with a fixed equilibrium distribution @xmath14 is given by the following optimization problem : @xmath108 where @xmath109 is the log - likelihood function of @xmath23 . by using the lagrange duality theory",
    ", we have the following lemma :    * lemma * : the minimization problem ( [ eq : single-1 ] ) is equivalent to the maximization problem @xmath110 and the optimal solution @xmath111 to ( [ eq : single-1 ] ) and the optimal solution @xmath103 to ( [ eq : single-2 ] ) satisfy @xmath112 * proof * : the lagrangian function of ( [ eq : single-1 ] ) is defined as * @xmath113 * note that @xmath114 then the dual function of ( [ eq : single-1 ] ) is @xmath115,\\boldsymbol{\\lambda},\\mathbf{v}\\right)\\nonumber \\\\   & = & -\\sum_{i , j}c_{ij}\\ln\\left(\\frac{c_{ij}}{\\pi_{i}\\left(\\lambda_{ij}-\\lambda_{ji}\\right)+v_{i}}\\right)\\nonumber \\\\   &   & + \\sum_{i , j}c_{ij}-\\sum_{i}v_{i}\\nonumber \\\\   & = & \\sum_{i , j}c_{ij}\\ln\\left(\\pi_{i}\\left(\\lambda_{ij}-\\lambda_{ji}\\right)+v_{i}\\right)-\\sum_{i}v_{i}\\nonumber \\\\   &   & -\\sum_{i , j}c_{ij}\\ln c_{ij}+\\sum_{i , j}c_{ij}\\label{eq : dual - function}\\end{aligned}\\ ] ] and ( [ eq : single-1 ] ) is equivalent to the maximization problem @xmath116 from ( [ eq : dual - function ] ) , we can get @xmath117 and @xmath118 therefore , @xmath119 and the optimal value of ( [ eq : single-1 ] ) is equal to @xmath120 and @xmath121 where @xmath122 we now consider the case that the stationary distribution is unknown . in this case , the maximum likelihood estimate of @xmath123 is @xmath124      if we further consider multiple biased simulations with @xmath125 , we can also conclude that the maximum likelihood estimate of @xmath14 can be given by the following min - max problem : @xmath126 for the sake of convenience , here we define @xmath127 .",
    "then ( [ eq : multiple - minimax - problem ] ) can be rewritten as @xmath128 because @xmath129 is a concave function of @xmath130 if @xmath131 is fixed and a convex function of @xmath131 if @xmath130 is fixed , the solution to ( [ eq : multiple - minimax - problem - u ] ) is a saddle point and characterized by ( see section 10.3.4 in @xcite ) @xmath132    considering that @xmath133 and @xmath134 we can conclude that the optimal solution to ( [ eq : multiple - minimax - problem ] ) should satisfy @xmath135 this leads to the following iterative algorithm for unbiased estimation of multiple simulations : @xmath136      here we show that dtram converges to the correct equilibrium distribution and transition probabilities in the limit of large statistics . in this limit , either achieved through long simulation trajectories or many short simulation trajectories , the count matrices @xmath137 $ ] become : @xmath138 where @xmath139 $ ] is the matrix of exact transition probabilities ( no statistical error ) , which satisfies @xmath140 where @xmath141 $ ] are the exact stationary probabilities of configuration states . inserting ( [ eq : asymptotic - limit - counts ] ) into the dtram equations ( [ eq : dtram_equation1]-[eq : dtram_equation2 ] ) , we obtain : @xmath142 and thus the first dtram equation is satisfied .",
    "furthermore , we obtain : @xmath143 and thus the second dtram equation is satisfied as well . from the above two equations , we can conclude that in the statistical limit ( either achieved by long trajectories or many short trajectories ) , the solution of the dtram equations converges to the correct equilibrium distribution and the correct transition probabilities .",
    "note that we have assumed that all trajectory data is in local equilibrium within each starting state @xmath12 - if this is not the case the counts @xmath19 and thus also the estimated @xmath5 and @xmath17 will be biased .",
    "thus , if the data is of such a nature that local equilibrium is a concern ( e.g. metadynamics or uncoupled short md trajectories ) , all estimates should be computed as a function of the lag time @xmath0 .",
    "the simulation trajectory @xmath144 is generated by a metropolis simulation model , which is a reversible markov chain with initial state @xmath145 , stationary distribution @xmath146 , and transition probability @xmath147 where @xmath148 denotes the proposal distribution which satisfies @xmath149 and @xmath150 ."
  ],
  "abstract_text": [
    "<S> we propose a discrete transition - based reweighting analysis method ( dtram ) for analyzing configuration - space - discretized simulation trajectories produced at different thermodynamic states ( temperatures , hamiltonians , etc . ) </S>",
    "<S> dtram provides maximum - likelihood estimates of stationary quantities ( probabilities , free energies , expectation values ) at any thermodynamic state . </S>",
    "<S> in contrast to the weighted histogram analysis method ( wham ) , dtram does not require data to be sampled from global equilibrium , and can thus produce superior estimates for enhanced sampling data such as parallel / simulated tempering , replica exchange , umbrella sampling , or metadynamics . </S>",
    "<S> in addition , dtram provides optimal estimates of markov state models ( msms ) from the discretized state - space trajectories at all thermodynamic states . under suitable conditions </S>",
    "<S> , these msms can be used to calculate kinetic quantities ( e.g. rates , timescales ) . in the limit of a single thermodynamic state </S>",
    "<S> , dtram estimates a maximum likelihood reversible msm , while in the limit of uncorrelated sampling data , dtram is identical to wham . </S>",
    "<S> dtram is thus a generalization to both estimators . </S>"
  ]
}