{
  "article_text": [
    "the interaction between matter and radiation is one of the fundamental mechanisms shaping the distribution of the baryonic component in the universe , from stellar to cosmological scales .",
    "this process often couples wildly different scales and the large dynamical range makes accurate modelling difficult .",
    "a notable example is given by the reionization of cosmic hydrogen at redshift @xmath0 ( for a review , see , e.g. , meiksin 2009 ) . during this epoch , the hii regions generated by the first ionizing sources expand to intergalactic scales and overlap , leaving most of the universe highly ionized and re - heated by several thousand kelvin degrees .",
    "the brightest , high - redshift quasars , may have produced even larger hii regions before the end of reionization , with linear sizes extending up to a hundred comoving mpc . nonetheless , most of the evolution in the gas temperature and ionization state still happened on much smaller scales , i.e. within the ionization - fronts , whose sizes are comparable to the local photon mean - free - path just outside the hii regions , about three orders of magnitude smaller than the hii regions themselves for gas at mean cosmic density .    even without considering such an extreme case in dynamical range , the numerical solution of the full radiative transfer equations still represents a big computational challenge .",
    "this is mostly due to two factors .",
    "the first is the high - dimensionality : seven variables are required for a full specification of the radiation field ( three spatial variables , two angular directions , photon frequency , and time ) .",
    "the second is the intrinsic `` non - locality '' of the problem : the radiation field at a given point is determined by the gas properties along the lines of sight towards all the sources of radiation ( including the diffuse medium itself ) .    for these reasons ,",
    "current numerical models rely on approximations aimed to decrease the problem dimensionality and , at the same time , the computational costs associated with the `` non - locality '' of the full radiation transfer ( e.g. , abel , norman & madau 1999 , gnedin & abel 2001 , maselli , ferrara & ciardi 2003 , razoumov & cardall 2005 , mellema et al .",
    "2006 , rijkhorst et al .",
    "2006 , ritzerveld & icke 2006 , whalen & norman 2006 ; for a review , see also iliev et al .",
    "2006 and references therein ; more recent codes include , e.g. , trac & cen 2007 , semelin et al .",
    "2007 , aubert & teyssier 2008 , altay et al .",
    "2008 , pawlik & schaye 2008 , finlator et al .",
    "2009 , petkova & springel 2009 ) .",
    "a widely used approximation is the so called `` method of characteristics '' which is particularly suited for cases where the radiation field is completely dominated by individual sources ( with no contribution from the radiative recombinations produced by the medium itself ) . in this scheme , the radiation field",
    "is determined simply from the column densities along a line of sight between the sources and a given point in the computational domain , discretized in cells ( or particles ) . in the `` long - characteristics '' flavour , the column densities",
    "are directly calculated with a single ray from the sources to the cell centre , summing up all the contributions cut through the cells in between . in the faster , but less accurate , `` short - characteristics '' version , the column densities are determined in an ordered way starting from the cells closer to the source and moving outwards after summing up ( using some interpolation scheme ) previous contributions . in both cases ,",
    "sampling the radiation field with a single ray from the sources to the cell centre may be problematic in particular situations , i.e. when the cells are optically thick and in presence of strong density gradients .",
    "practically , the consequences may be the loss of photon conservation and numerical artifacts in the i - front shapes ( see , e.g. , mellema et al .",
    "2006 ) .    in a cosmological situation , e.g. for the reionization scenario described before",
    ", we would like to have an accurate method for the very typical case in which numerical resolution imposes optically thick cells .",
    "this may be obtained sampling the radiation field in a statistical , homogeneous way , using the widely used monte carlo techniques . in this case , a series of rays is randomly casted around the sources in order to obtain the right solid angle distribution , averaging the contributions to the radiation field within individual ( three - dimensional ) volume elements .",
    "the drawbacks of this method are the computational costs : many rays ( per cell ) are required to avoid statistical noise and the method becomes less and less efficient as one moves outwards from the sources ( but see , abel & wandelt 2002 ) .",
    "moreover , if the grid is composed by cells of different sizes , the required number of rays to be casted is determined by the size of the smallest cells , irrespectively of the volume fraction they actually occupy .    in this work",
    ", we develop a novel approach aimed to obtain an accurate solution of the radiative transfer problem in cosmological situations in an efficient way : combining the monte carlo scheme with the `` cell - by - cell '' approach typical of the characteristic methods .",
    "as we mentioned at the beginning of this section , despite the large scales associated with , e.g. , the reionization process , the medium properties are very often determined within a small fraction of its volume , i.e. within the i - fronts .",
    "the basic idea is to concentrate the computational efforts onto this part of the computational volume , where they are actually needed .",
    "this is achieved thanks to a new algorithm which casts , with the correct solid angle distribution , a series of rays for each cell _ individually_. in this way , we are able to use an algorithm that adaptively determines : i ) the number of rays needed for a particular cell to achieve the convergence of the radiation field ( irrespectively of the cell size , or distance from the source ) , ii ) in which part of the volume to apply the ( expensive ) monte carlo ray - tracing .",
    "the result is that the computing time of the rt scales now with the number of cells to be evolved during a simulation - step , i.e. , typically the cells contained within the i - fronts , with a huge gain in computational speed ( and accuracy ) with respect to a classical monte carlo .    with the new `` cell - by - cell '' approach we are also able to gain the full advantages of adaptive mesh refinement ( amr ) methods ( see , e.g. berger & oliger 1984 ) that increase the spatial resolution where needed .",
    "in particular , we implemented a scheme , based on the original clustering algorithm by berger & rigoutsos ( 1991 ) , to adaptively refine the mesh in correspondence of the i - fronts during the course of the simulation .",
    "this allows us to fully resolve the small scales associated with the i - fronts within the large , cosmological simulation boxes that follow the reionization process .",
    "resolving the i - fronts has a profound impacts for a large range of astrophysical applications , e.g. , to accurately predict the temperature state of the gas surrounding a bright quasar during reionization .",
    "in the validating test section ( section 4 ) , we will present an example of how resolving the i - front may be important in the determination of the gas temperature within the _ whole _ hii region .",
    "the paper is organized as follows . in section 2 ,",
    "we review the basic radiative transfer equation .",
    "the computational method used by our new rt code , ` radamesh `  ( * * r**adiative - transfer on * * ada**ptive * mesh * ) , is presented in section 3 , in section 4 , we show the validating tests of the code . we conclude in section 5 .",
    "the cosmological radiative transfer equation in comoving coordinates ( e.g. , norman , paschos & abel 1998 ) is given by    @xmath1    where @xmath2 is the monochromatic specific intensity of the radiation field , @xmath3 is a unit vector along the direction of propagation of the ray , @xmath4 is the ( time - dependent ) hubble constant , @xmath5 is the ratio of cosmic scale factors between photon emission at frequency @xmath6 and the present time t , @xmath7 denotes the opacity at frequency @xmath6 and @xmath8 is the source function of the medium .    if the scale of interest @xmath9 is much smaller than the hubble radius , @xmath10 , ( as always in our case ) and the medium properties are changing on a time scale shorter than the light crossing time @xmath11 , equation ( [ generalrteq ] ) reduces to the classical , static radiative transfer equation :    @xmath12    this equation admits the following solution , @xmath13 where @xmath14 is the optical depth along @xmath3 .",
    "this solution is in general adequate for cosmological simulations except on small distances from the sources ( or , equivalently , for very bright sources ) . in this case",
    ", the approximations break down allowing the ionization - fronts to expand faster than the speed of light . in section [ gammasec ]",
    "we discuss an approximate correction to solve this unphysical behaviour .",
    "it is often convenient to express @xmath15 as a sum of the attenuated , direct radiation from individual sources ( @xmath16 ) and the diffuse radiation ( @xmath17 ) generated within the medium : @xmath18    using equation ( [ ieq ] ) , the radiation field intensity can be specified at any point of the simulation box given the value of the optical depth to the individual sources and the source term of the medium . from the radiation field , it is then possible to derive for each species @xmath19 the photoionization rate ( per particle ) : @xmath20 and the gas photoheating rate ( per unit volume ) : @xmath21    where @xmath22 and @xmath23 are the frequency threshold and the cross - section for the ionization of species @xmath19 , respectively , and @xmath24 is the physical number density .",
    "analogously to eq .",
    "( [ isplit ] ) , we can split @xmath25 and @xmath26 into the sum of direct ( @xmath27,@xmath28 ) and diffuse ( @xmath29,@xmath30 ) components .",
    "finally , @xmath31 and @xmath32 are used to compute the chemistry evolution of the neutral fraction of hydrogen ( @xmath33 ) , neutral helium ( @xmath34 ) , singly ionized helium ( @xmath35 ) , and the temperature ( expressed in terms of the total energy density @xmath36 ) according to the following rate equations : @xmath37 here @xmath38 , @xmath39 and @xmath40 are the temperature - dependent radiative recombination ( to all levels ) , collisional ionization , and dielectronic recombination coefficients , respectively ; @xmath41 is the number density of electrons , @xmath42 is the gas clumping factor    for simplicity , we assume the same value of @xmath43 for each species in the current version of the code .    ,",
    "and @xmath44 is the total cooling rate ( including recombinations , collisional excitations , compton , brehmstrahlung and hubble cooling ) .",
    "we use the analytical fits of hui & gnedin ( 1998 ) for the ionization , recombination and cooling rates .",
    "one of the main challenges in the calculation of the photoionization / heating rate is represented by the presence of the diffuse term in eq .",
    "( [ isplit ] ) , since it requires the transport of the diffuse photons generated from atomic recombinations in every point of the medium .",
    "a widely used solution to this problem is the so called `` on - the - spot '' approximation ( ots or _ case b _ , originally proposed by baker & menzel 1938 ) , which assumes that every diffuse , ionizing photon is absorbed exactly in the same point where it is generated ( i.e. , the photon mean - free - path is much smaller than the resolution scale ) . in this case , assuming for the moment a pure hydrogen medium , the diffuse part of the photoionization rate can be written as : @xmath45 where @xmath46 is the recombination coefficient to the hydrogen ground level , and @xmath47 is the analogous coefficient for the levels @xmath48 . substituting this relation in eq .",
    "( [ fhieq ] ) , we obtain : @xmath49 i.e. , a relation that depends only on the photoionization rate from individual sources ( @xmath50 ) and , thus , greatly simplifies the radiative transfer problem .",
    "analogous relations can be obtained for hei and heii , assuming that every ionizing photon from recombinations is absorbed by the same species from which it originates ( obviously , this approximation breaks down if we consider that non - self - ionizing photons from heii recombinations can actually ionize both hei and hi , see section [ recradsec2 ] for a detailed discussion ) .    as also noticed by ritzerveld ( 2005 ) , despite being widely used , the ots approximation is based on an incorrect argument : if the local mean - free - path is very small as assumed , i.e. , the local optical depth is very high for the diffuse photons generated locally , even higher the optical depth would be for the radiation coming from discrete , non - local sources ( unless their spectral energy distribution is much harder ) .",
    "for instance , in the classical strmgren sphere situation with a monochromatic source ( see test 1 below ) , the regime where the ots approximation may hold corresponds to regions where the directional flux from the central source is not able to penetrate , i.e. only at the extreme edge of the strmgren sphere .",
    "the opposite case ( called _ case a _ ) is represented by the situation in which the mean - free - path of the diffuse photons goes to infinity and , effectively , @xmath51 . despite the loss of photon conservation for a bounded region like a strmgren sphere ,",
    "this approximation is actually more correct than the ots in most situations as we will show later .",
    "the computational volume in ` radamesh `  is discretized in a ( series of ) regular , block - structured grid(s ) where the physical properties of the medium are associated with a zone - centered grid element , i.e. with a _ cell_.",
    "the current possible choices for the computational domain in ` radamesh `  are : i ) single , uniform cartesian grid , ii ) _ static _ multi - mesh structure , iii ) _ evolving _ multi - mesh structure . in the",
    "case , the grid is spatially fixed to the initial , single or multi - mesh structure obtained , e.g. , from the output of an adaptive mesh refinement ( amr ) hydro - simulation . in the _ evolving _ case , this initial structure is adaptively refined ( unrefined ) each time the cells satisfy a chosen refinement ( unrefinement ) criterion .",
    "the refining procedure is described in details in section [ amrsec ] .",
    "the radiation field ( from individual sources and from diffuse radiation ) is discretized in a series of rays that are propagated through this single or multi - mesh structure using a ray - tracing algorithm . before discussing the ray - tracing method ,",
    "it is necessary to describe more in detail the multi - mesh implementation in ` radamesh ` .",
    "multi - mesh domains in ` radamesh `  are composed of a nested hierarchy of rectangular grids of different sizes and levels of refinement , following the implementation called `` patch - based amr '' , originally described in berger & oliger ( 1984 ) .",
    "the position and aspect ratios of this patches are optimized in order to increase the spatial ( and temporal ) resolution where needed within the computational box .",
    "other possible multi - mesh implementations have been proposed in the past , like , e.g , the `` tree - based amr '' ( see khokhlov 1998 and references therein ) . in this case , each cell ( or @xmath52 group of cells in three - dimensions ; typically @xmath53 ) is refined into children cells , on a cell - by - cell basis , and a `` grid '' is the analogous of a single cell ( or a @xmath52 group of cells ) .",
    "these methods were originally developed for the numerical solution of hydrodynamical equation and they have advantages and disadvantages with respect to each other for this particular problem . in our case , patch - based amr presents a significant advantage with respect to other implementations : it reduces the total number of grids .",
    "one of the major problem presented by a ray - tracing algorithm is the fact that a significant part of the computational time may be spent in `` crossing '' the simulation box .",
    "this is in a sense unavoidable , because solving the radiative transfer equations is a highly non - local problem .",
    "optimizing the data and memory structure is thus fundamental in order to have an efficient algorithm .",
    "minimizing the number of `` crossing '' grids helps reducing the overhead associated with the ray - tracing in a multi - mesh structure .    in order to increase the efficiency in `` crossing '' the computational volume , grids and cells in ` radamesh `  at different levels of refinement are connected with two separate hierarchical trees and linked lists .",
    "grids are strictly nested , i.e. , each grid at level @xmath54 is fully contained by a single grid at level @xmath55 ( the `` parent '' grid ) .",
    "note that , although this may increase the total number of grids , it allows a more efficient tree - search for both grids and cells .",
    "grids that share the same `` parent '' are connected via a linked list .",
    "thus , each grid @xmath56 at level @xmath54 may have a maximum of three associated pointers : i ) the `` parent '' grid at level @xmath55 , ii ) the `` next brother '' grid in the linked list at level @xmath54 , iii ) the `` son '' grid at level @xmath57 ( i.e. , the head of the linked list of grids fully contained within @xmath56 ) .",
    "grids without an associated `` son '' are called `` leaf '' grids .",
    "this hierarchical tree is a light structure that requires small amounts of memory ( if the number of grids is significantly smaller than the total number of cells , as it is always the case for `` patch - based amr '' ) and that can be reconstructed or saved easily given its strict nesting .",
    "if refined , a cell at level @xmath54 contains a group of @xmath58 subcells , where @xmath59 is the refinement factor . in principle",
    ", @xmath59 may vary with levels , although commonly is fixed to a constant value ( typically @xmath60 ) .",
    "analogously to the grid case , a cell without refinement is called a `` leaf '' cell .",
    "combined with the grid - tree , there is another simple hierarchical structure in ` radamesh `  associated directly with the cells : each refined cell at level @xmath54 points to the grid at @xmath57 that contains its @xmath58 subcells .",
    "this simple ( but more memory - consuming ) cell - tree is built efficiently when needed from the grid - tree and , for this reason , is not saved during output or back - up in order to save memory usage .",
    "the use of the cell - tree allows to recover very quickly the location of the relevant subgrid ( and thus the subcell ) at level @xmath57 when crossing the tree towards higher levels of refinement , without searching through the `` next brother '' linked list of the subgrids .",
    "when searching for cells at coarser ( or at the same ) level , the grid - tree is used instead . the combination of the grid - tree and the simple cell - tree represents a good balance between flexibility ( that translate into computational speed ) of the box crossing algorithm and memory consumption of the tree - structure .",
    "ray - tracing is a well - studied problem in computational geometry , with several efficient methods commonly used in computer graphics .",
    "one of the most efficient solution is the simple and fast grid - traversal algorithm of amanatides & woo ( 1987 ) , particular suited in the case of a single , uniform cartesian grid .",
    "basically , this simple algorithm determines the intersection points between the boundaries of the cells and a ray ( defined from its initial position and two direction angles ) as it traverses the computational grid .",
    "we employ the grid and cell hierarchical trees discussed above to extend this fast algorithm from the single , uniform grid to the multi - mesh structure .",
    "this is done simply adding to the original algorithm , after each cell boundary crossing , a ( recursive ) check for the need of changing the current traversing grid ( either at the same or at a different level ) .",
    "let us consider , for example , the case in which a ray is currently traversing a grid at level @xmath61 .",
    "there are two situations in which a change of grid is required : a ) the ray is still within the boundaries of the current grid but is entering a subgrid at level @xmath62 ; b ) the ray is exiting the boundaries of the current grid . we know that we are in the first situation simply checking the current cell tree : if the cell is associated with a subgrid , we immediately recover from the tree the memory location of the new grid at @xmath63 and , from the intersection coordinates , the corresponding cell within this grid .",
    "we recursively continue the search until we reach a `` leaf '' cell . in the second case ,",
    "the search consists of two phases .",
    "first , we cross the grid tree towards the `` parent '' grids at level @xmath64 until we find a grid where the ray is fully contained ( and not at the grid boundaries ) or where the ray is _ _ entering _ _ the grid boundaries .",
    "note that usually this search is very fast given that , for a typical nested structure , we only need to go to the level @xmath65 . when the grid at @xmath64 is found , we check if the cell where the ray is currently located is a `` leaf '' .",
    "if this is not the case , we apply the same procedure as in case a ) .    when traversing a `` leaf '' grid we can apply the original traversal algorithm without the need for the recursive check ( and change of grids ) described above . in this respect ,",
    "the use of a `` patch - based amr '' , given its larger grids , result in a reduction of the computational costs of the traversing algorithm .      `",
    "radamesh `  is based on a ray - tracing algorithm that propagates the ( discretized ) radiation field through the computational volume .",
    "however , in the same spirit of the amr method , the key element in ` radamesh `  is not represented by the _ ray _ or photon package but , instead , by the computational _ cell_. in other words , the propagation of the radiation field ( and the solution of the radiative transfer equation ) is performed on a `` cell - by - cell '' basis rather than `` ray - by - ray '' .",
    "computationally , this translates into the change of the main loop in the algorithm , from rays to cells : the radiation field from the ( discrete and diffuse ) sources is propagated with a photon - conserving method separately for each cell in the computational volume . as we explain below , at the heart of the algorithm",
    "there is a new method that allows to draw a series of rays from a source , located at any position inside ( or outside ) the box , through a cubic cell with the _ correct _ solid angle distribution .",
    "this extends the `` monte carlo '' methods , where a series of rays is uniformly casted around a source to obtain the correct solid angle distribution , from the computational box to the cell level .",
    "this `` cell - by - cell monte carlo '' is a more natural approach when most of the physical evolution of the medium happens rapidly only in a small portion of the simulated box at a time .",
    "this is a typical case in cosmological simulation , either because of a difference in density ( e.g. , self - shielded dense clumps in a mostly ionized medium ) or in the ionized state ( e.g. , the expansion of an ionization - front in a mostly neutral igm during reionization ) with the cell - based approach , we can split the computational volume , either single or multi - mesh , grouping the cells with different evolving times or properties and focusing the computational efforts only where actually needed .",
    "this is obtained associating to each cell an individual time - step ( @xmath66 ) that is used to determine whether the cell can be considered _ active _ or not during the current simulation step .",
    "we discuss how we derive @xmath66 and how we define the _ active _ cell in section [ timestepsec ] .    in detail ,",
    "the computational algorithm consists of an iterative method divided into four main parts for each simulation step ( and for each _ active _ cell ) : i ) finding the ionization and photo - heating rates , ii ) choosing the time - step , iii ) solving the chemistry equation for the evolution of the medium properties , and , if needed , iv ) performing an adaptive refinement of the computational mesh .",
    "the first part of the algorithm is the most time - consuming ( and important ) part of the method and is described in detail in the following section .",
    "the photo - ionization ( @xmath31 ) and photo - heating rates ( @xmath26 ) are computed for each _ active _ , leaf cell ( during the current time - step ) with an iterative monte carlo procedure until convergence for both quantities is reached .",
    "the convergence level is typically set at 1% , but can be increased ( decreased ) depending on the requested level of accuracy .",
    "we compute separately , with two different methods , the contribution to the total photoionization / heating rate from discrete sources ( @xmath67 ) and from diffuse emission ( @xmath68 ) .",
    "most of the effort is dedicated to the calculation of ( @xmath67 ) , since in many ( cosmological ) cases the directional flux from discrete sources represents the major contribution to the total photoionization rate .",
    "the procedure to obtain the values of @xmath67 and @xmath69 is the following : for each iteration step , a packet of rays is propagated from selected points within the cell to the sources .",
    "these points are chosen with a monte carlo procedure based on a rejection algorithm that insures an uniform solid - angle distribution within the cell .",
    "the total flux is then re - scaled according to the fraction of the solid angle covered by the cell .",
    "we present in the appendix the analytical approximation that gives the solid angle of a ( cubic ) cell as seen by any point inside ( or outside ) the box .    for each ray ,",
    "we compute the hi , hei , and heii column densities both for the path length within the cell ( @xmath70 ) and for the path length connecting the cell edge to the source ( @xmath71 ) .",
    "the column densities are then used to calculate the frequency - dependent optical depths @xmath72 and @xmath73 . given the optical depths , we derive the probability that a photon with frequency @xmath6 is absorbed by the species @xmath19 within the cell : @xmath74 } { \\sum\\limits_{j=1}^{3}\\{1-\\mathrm{exp}[-\\delta\\tau_j(\\nu)]\\ } } \\{1-\\mathrm{exp}[-\\delta\\tau_i(\\nu)]\\}\\ .\\ ] ] the optical depths and the spectral energy distribution of the sources are sampled into @xmath75 ( logarithmically - spaced ) frequency bins .",
    "the probability distributions @xmath76 are used to compute the photoionization rate , including for the moment only the first term in eq .",
    "( [ ieq ] ) , for each ray of the packet and for each source : @xmath77\\ , \\ ] ] where @xmath78 denotes the number of ionizing photons per unit time emitted by the source in the frequency bin @xmath79 .",
    "finally , the value of @xmath67 is obtained by averaging @xmath80 over the number of rays in the packet , the cell volume and the fraction of the solid angle covered by the cell ( see appendix ) .",
    "several packets of rays are generated until the value of @xmath67 converges to the required level .",
    "the procedure is repeated for each source and the single values of @xmath67 are added .",
    "the photoionization rates @xmath69 are obtained in a similar way , starting from @xmath81\\ .\\ ] ]    in order to avoid redundant calculations of the column densities @xmath71 from the cell edges to the sources for each ray packet , we first evaluate @xmath71 on the cell vertexes `` visible '' from each source .",
    "if the difference between these values is less than a given ( small ) threshold , we do not use the full ray - casting algorithm .",
    "instead , we use the @xmath71 values at the vertexes to interpolate ( linearly ) the needed values on the cell faces . typically , the cells that need the full ray - casting algorithm are a few percent of the total volume and correspond to the ionization - front regions ( where the column - density varies rapidly ) . for the remaining cells , interpolating the column - densities",
    "is a good approximation and allows to substantially speed - up the computation .",
    "note that in this case , the algorithm is similar to a classical long - characteristic ray - tracing .    to achieve a better performance",
    "it is also possible to choose a column - density threshold ( or , equivalently , an optical depth threshold at the ionization limit ) above which ` radamesh `  skips the calculation of the @xmath67 and @xmath69 values .",
    "this is computationally convenient , e.g. , in the early stages of the expansion of an ionization - front in a neutral and dense medium , when most of the volume is still optically thick to the source radiation .",
    "analogously , it is possible to choose a minimum value of @xmath70 and @xmath71 below which an optically - thin approximation is used instead of the full ray - tracing algorithm .",
    "this is typically the situation for the ionized region in proximity of the sources , where the optical depth is negligible .",
    "as mentioned in section 2 , eq .",
    "( [ ieq ] ) permits i - fronts to propagate faster than light in near proximity of a bright source .",
    "an exact solution for this problem that does not require to fully solve the time - dependent radiative transfer equation and avoids the loss of photon conservation is only available in the case of an homogeneous medium ( e.g. , shapiro et al .",
    "2006 ) as we have also discussed elsewhere ( cantalupo et al .",
    "2008 ) . in the more general case of an inhomogeneous medium",
    ", we fix this unphysical behaviour by disregarding the ionizing flux of a given source at a distance @xmath82 , where @xmath83 is the source current lifetime .",
    "note that , the loss of photon conservation due to this approximation is typically restricted to the very early phases of the expansion of the i - front produced by very bright sources .",
    "once the value of the directional photoionization / heating rate have been obtained , we calculate ( with a simpler procedure ) the diffuse component rates for the same , _ active _ cells .",
    "also in this case we follow a `` cell - by - cell '' approach : given a particular ( _ active _ ) cell for which we want to compute @xmath84 and @xmath85 , we generate with a monte carlo procedure a set of rays that propagates outwards from the cell centre .",
    "for each cell encountered by the ray , we compute the medium opacity and the source term as a function of the @xmath86 , @xmath87 , @xmath88 , @xmath89 , and temperature . in particular ,",
    "we include : i ) hi , hei and heii free - bound continuum ( from osterbrock 1989 ) , ii ) heii balmer continuum ( from ercolano & storey 2006 ) , iii ) heii two - photon continuum ( from nussbaumer & schmutz 1984 ) , and iv ) the heii ly@xmath90 line .",
    "we neglect the hei balmer continuum and hei emission lines given their ( relatively ) small contribution to the total emissivity .",
    "given the source function , we compute and add the respective @xmath84 and @xmath85 to the direct photoionization / heating rate , according to the equation presented in section 2 .    in this method , each ray represents a fixed fraction of the solid angle ( @xmath91 ) of the sky as seen by the cell , determined by the chosen number of rays ( that we leave in the current version as a free parameter ) . note that this procedure is accurate if the three - dimensional diffuse field is homogeneous over a scale corresponding to @xmath92 , where @xmath93 is the distance from the cell",
    ". obviously ,",
    "if the medium is clumpy , this method becomes more and more inaccurate at increasing distances from the cell , unless the number of rays is increased accordingly .",
    "note , however , that in most cosmological situations , the diffuse field represents a small component with respect to the direct radiation from sources .",
    "as mentioned above , we associate an individual time - step @xmath66 to each cell in the computational volume .",
    "we first estimate @xmath66 for the cells with the newly calculated @xmath25 by taking a fixed fraction @xmath94 of the minimum ionization timescale from the rate equations . the minimum value found for @xmath66",
    "is stored ( as the new global time - step @xmath95 ) . at this point",
    "we check which cells can be considered _ active _ during the next simulation step comparing the individual @xmath66 with @xmath95 . if @xmath96 , where @xmath97 is a user - defined parameter , the cell is considered _ active _ and we assign @xmath98 . if a previously _ active _ cell does not meet this criterion we de - activate the cell until a simulation time @xmath99 ( or a number @xmath100 of simulation steps ) has elapsed . if @xmath101 all ( leaf ) cells are always considered active .    since the cells within the ionization - front have the shortest @xmath66 , they are always selected as _ active_. in practice , the factor @xmath102 controls how broad is the region of _ active _ cells around the i - front .",
    "cells outside of this region are updated only when necessary , typically after several simulation time - steps , given their much longer ionization / recombination time - scales .",
    "even for very large values of @xmath102 ( e.g. , @xmath103 ) the gain in computational speed is huge , since most of the volume has evolution time - scales several orders of magnitude larger than the i - fronts .      in this part of the computational algorithm , we solve the rate equation and we evolve the medium properties for the _ active _ cells with the newly calculated @xmath25 and @xmath26 . for the integration of the rate equations",
    ", we use the radau iia method ( hairer & wanner 1996 ) , an implicit runge - kutta scheme of variable , adaptive order .",
    "this allows this part of the code to be computationally stable and reasonably fast for the required accuracy .",
    "if activated , the adaptive mesh refinement is performed with the recursive clustering algorithm of berger & rigoutsos ( 1991 ) . before applying this algorithm ,",
    "we flag the cells that satisfy a given refinement criterion .",
    "the currently implemented refinement criterion is based on a combination of three variables for each atomic species : i ) the cell neutral fraction , ii ) the cell ionization rate ( @xmath25 ) , and iii ) the ( frequency dependent ) cell optical depth @xmath104 .",
    "the ultimate goal is to flag and refine the fast evolving cells that are inside the i - front ( i.e. , the cells with the highest @xmath25 ) , until their @xmath105 is below the desired value . in practice",
    ", the refinement criterion should produce a multi - mesh grid where the front is well resolved , i.e. where the @xmath104 at the species energy threshold is well below unity .",
    "moreover , we would like also to have a pre - refined region just beyond the current position of the i - front , and a _ sharp _ cut corresponding to the regions where the i - front is just passed leaving the medium ( highly ) ionized .",
    "the size and shape of the refining region can be easily tuned with a criterion that includes the three variables discussed above , see test 6 for an example .",
    "the recursive amr algorithm starts from the base grid at the coarser level and it is composed by three main steps : i ) flagging , ii ) clustering , and iii ) refining / unrefining .",
    "once the cells to be refined at the coarser level ( @xmath106 ) are flagged as discussed above , they are clustered into new rectangular patches .",
    "these are splitted until the clustering efficiency ( i.e. , the ratio between the number of flagged and total number of cell in the new patch ) is greater than a chosen minimum threshold , typically 80% . in order to avoid the creation of grids that are too small ( and thus inefficient for the ray - tracing algorithm ) , it is also possible to chose a minimum size for the newly created patches . in most of the situations ,",
    "we find that a minimum size of two ( parent ) cells gives the best balance between number of newly created cells and efficiency of the algorithm . we then _ propagate _ the physical properties from the coarser grid ( @xmath107 ) to the newly created patches at level @xmath108 ( refinement ) .",
    "currently , only straight injection refinement has been implemented . if a cell at level @xmath107 that was previously refined has not been flagged during the current time - step , the properties of its subcells at level @xmath108 are _ propagated _ back to the parent cell that becomes now a leaf cell ( un - refinement ) .",
    "temperature during un - refinement is weighted according to the subcell electron number densities , while the species neutral fractions ( @xmath109 ) are weighted according to the mass densities .",
    "this algorithm is recursively repeated , patch by patch , at finer levels , until there are newly flagged cells or the maximum number of refinement levels is reached .    during clustering and refinement ,",
    "the grid - tree and the cell - tree are updated , new memory is dynamically allocated for the newly created grids and , at the same time , the memory slots associated with the un - refined grids are released . by the algorithm construction , parent and son grids",
    "have memory slots allocated in close parts of the memory map .",
    "this ensures an efficient memory usage and reduces computational overhead during ray - tracing .    in case where the amr is performed on an existing multi - mesh grid ( e.g. , the output of an hydrodynamical amr code )",
    ", there is the very important option in ` radamesh `   to consider this initial grid as _ fixed _ : i.e. , the amr builds the new patches on the top of the existing multi - mesh grid without unrefining it below the original , initial level .",
    "this allows us to increase the resolution where needed for the radiative transfer ( on the i - front ) without losing the resolution achieved with the hydro code .",
    "the capacity of ` radamesh `  of adding further levels of refinement on an existing amr grid , without loosing previous information , is of great importance for several physical applications .",
    "for example for the study of the highly ionized ( but denser than the average ) regions in proximity of a qso that where already touched by its i - front and that would appear as ly@xmath90 forest in the quasar spectrum .",
    "myr in the plane @xmath110 ( top panel ) and @xmath111 ( bottom panel).,title=\"fig : \" ]   myr in the plane @xmath110 ( top panel ) and @xmath111 ( bottom panel).,title=\"fig : \" ]     myr ( top panel ) and @xmath112 myr ( bottom panel).,title=\"fig : \" ]   myr ( top panel ) and @xmath112 myr ( bottom panel).,title=\"fig : \" ]     with respect to the strmgen radius @xmath113 ( bottom panel ) and the analytical solution ( top panel ) .",
    "see text for details . ]",
    "in this section we present the validating tests of the code based on the radiative transfer code comparison project ( iliev et al . 2006 ; i06 thereafter ) .",
    "these tests have been designed in order to compare all the important aspects of several radiative - transfer codes present in the literature .",
    "they include the correct tracking of both slow and fast ionization - fronts in homogeneous and inhomogeneous density fields , i - front trapping , spectrum hardening and the solution of the temperature state .",
    "the original tests in i06 ( test 1 to 4 ) are performed for a single , uniform grid , pure hydrogen medium and without recombination radiation ( using the ots approximation ) . in order to compare our results with the other rt codes",
    ", we use the same single grid ( pure - hydrogen ) configuration as used in i06 to reproduce the results of test 1 to 4 . in the second part of this section",
    ", we present a set of case studies aimed at substantiating the new characteristics of our code .",
    "in particular , we verify in test 5 and test 6 the multi - mesh , adaptive capability of ` radamesh ` . in test 7 and test 8",
    "we show the effects of the diffuse radiation transfer for hydrogen only medium ( test 7 ) and including helium ( test 8) .     and times @xmath114 myr ( top panel ) and @xmath115 myr ( bottom panel).,title=\"fig : \" ]   and times @xmath114 myr ( top panel ) and @xmath115 myr ( bottom panel).,title=\"fig : \" ]     myr ( top panel ) and @xmath115 myr ( bottom panel ) .",
    "the results from ` radamesh `  are presented as solid black lines .",
    "the other lines represent the results from a sample of four different codes taken from the rt code comparison project ( i06 ) , in particular : ` c^2-ray ` ( red , short - dashed line ) , ` crash ` ( cyan , dotted line ) , ` ftte ` ( blue , long - dashed line ) , and ` rsph ` ( green , dot - dashed line ) .",
    ", title=\"fig : \" ]   myr ( top panel ) and @xmath115 myr ( bottom panel ) .",
    "the results from ` radamesh `  are presented as solid black lines .",
    "the other lines represent the results from a sample of four different codes taken from the rt code comparison project ( i06 ) , in particular : ` c^2-ray ` ( red , short - dashed line ) , ` crash ` ( cyan , dotted line ) , ` ftte ` ( blue , long - dashed line ) , and ` rsph ` ( green , dot - dashed line ) .",
    ", title=\"fig : \" ]     and times @xmath114 myr ( top panel ) and @xmath115 myr ( bottom panel).,title=\"fig : \" ]   and times @xmath114 myr ( top panel ) and @xmath115 myr ( bottom panel).,title=\"fig : \" ]     myr ( top panel ) and @xmath115 myr ( bottom panel ) . the results from `",
    "radamesh `  are presented as solid black lines .",
    "the other lines represent the results from a sample of four different codes taken from the rt code comparison project ( i06 ) , see caption in figure [ t2f16 ] .",
    ", title=\"fig : \" ]   myr ( top panel ) and @xmath115 myr ( bottom panel ) .",
    "the results from ` radamesh `  are presented as solid black lines .",
    "the other lines represent the results from a sample of four different codes taken from the rt code comparison project ( i06 ) , see caption in figure [ t2f16 ] .",
    ", title=\"fig : \" ]      this test represents the classical problem of the expansion of a hii region in an uniform ( pure - hydrogen ) medium around a single ionizing source .",
    "we assume that a steady , monochromatic ( @xmath116 ev ) source emitting @xmath117 ionizing photons per unit time turns on in an initially - neutral , uniform - density , static medium with hydrogen number density @xmath118 . likewise in i06",
    ", we use for this test the ots approximation .",
    "the temperature is fixed at @xmath119 k. under these conditions , and assuming that the front is sharp ( i.e. that it is infinitely - thin , with the gas inside fully - ionized and the gas outside fully - neutral ) , there is a well - known analytical solution for the evolution of the i - front radius , @xmath120 , and velocity , @xmath121 , given by @xmath122^{1/3}\\,,\\\\ \\rm v_i&=&\\frac{r_{\\rm s}}{3t_{\\rm rec}}\\frac{\\exp{(-t / t_{\\rm rec } ) } } { \\left[1-\\exp(-t / t_{\\rm rec})\\right]^{2/3}}\\ , , \\label{strom0}\\end{aligned}\\ ] ] where @xmath123^{1/3}\\,,\\ ] ] is the strmgren radius , i.e. the radius at which recombinations balance the ionizations and the hii region expansion stops .",
    "here @xmath124 is the case b recombination coefficient and @xmath125^{-1}\\,,\\ ] ] is the recombination time .",
    "the hii region initially expands quickly and then slows down as the evolution time approaches the recombination time , @xmath126 . at a few recombination times , the i - front stops and in absence of gas motions remains static thereafter .",
    "the numerical parameters for this test are the followings : computational box dimension @xmath127  kpc ( the source is at one corner of the box ) , gas number density @xmath128  @xmath129 , initial ionization fraction ( given by collisional equilibrium ) @xmath130 , and ionization rate @xmath131 photonss@xmath132 .",
    "for these parameters the recombination time is @xmath133 myr . assuming a recombination rate @xmath134 at @xmath119 k , then @xmath135 kpc .",
    "note that the value of @xmath113 is actually independent from the use of the ots or case b approximation ( see test 7 ) .",
    "myr ( top panel ) and @xmath136 myr ( bottom panel).,title=\"fig : \" ]   myr ( top panel ) and @xmath136 myr ( bottom panel).,title=\"fig : \" ]     myr ( top panel ) and @xmath136 myr ( bottom panel).,title=\"fig : \" ]   myr ( top panel ) and @xmath136 myr ( bottom panel).,title=\"fig : \" ]    in figure [ t1 ] , we show the images of the hi fraction in the plane y=0 and z=0 at time @xmath112 myr , when the equilibrium strmgen sphere is reached .",
    "the hii region is nicely spherical in both the planes , demonstrating that our algorithm produces an uniform coverage of the solid angle around the source . in figure",
    "[ t1f8 ] , we plot the spherically averaged radial profiles of the ionized ( @xmath137 ) and neutral fraction ( 1-@xmath137 ) at times @xmath138 and 500 myr .",
    "the thickness of the transition between the hii and hi regions is in agreement with both analytical and numerical expectations from most of the other codes in i06 . in particular , thanks to our new adaptive algorithm ( that ensures the convergence of the radiation field in any cell ) , the i - front thickness does not suffer from diffusive effects shown by other `` classical '' monte carlo methods ( cfr . ,",
    "e.g. , the results of ` crash ` in i06 ) .",
    "finally , in figure [ t1f7 ] , we show the time evolution of the i - front position ( defined as the point of 50% ionization ) .",
    "the code tracks the i - front correctly , with the position never varying by more than few percent from the analytical solution .",
    "myr ( top panel ) and @xmath136 myr ( bottom panel ) .",
    "the results from ` radamesh `  are presented as solid black lines .",
    "the other lines represent the results from a sample of four different codes taken from the rt code comparison project ( i06 ) , see caption in figure [ t2f16 ] .",
    ", title=\"fig : \" ]   myr ( top panel ) and @xmath136 myr ( bottom panel ) .",
    "the results from ` radamesh `  are presented as solid black lines .",
    "the other lines represent the results from a sample of four different codes taken from the rt code comparison project ( i06 ) , see caption in figure [ t2f16 ] .",
    ", title=\"fig : \" ]     myr ( top panel ) and @xmath136 myr ( bottom panel ) .",
    "the results from ` radamesh `  are presented as solid black lines .",
    "the other lines represent the results from a sample of four different codes taken from the rt code comparison project ( i06 ) , see caption in figure [ t2f16 ] .",
    ", title=\"fig : \" ]   myr ( top panel ) and @xmath136 myr ( bottom panel ) .",
    "the results from ` radamesh `  are presented as solid black lines .",
    "the other lines represent the results from a sample of four different codes taken from the rt code comparison project ( i06 ) , see caption in figure [ t2f16 ] .",
    ", title=\"fig : \" ]      in this test we use the same parameters of test 1 , but now the ionizing source has a @xmath139 black - body spectrum and we allow the gas temperature to evolve .",
    "initially , the gas is fully neutral with a temperature t=100 k. there are no analytical solutions for this test , therefore we compare our results to what obtained by the other codes in i06 .    in figure [ t2hi ] , we show the images of the neutral hydrogen fraction ( on the @xmath111 plane ) at times @xmath114 and @xmath115 myr .",
    "the spherically averaged hi profiles , for the same time - snapshots , are presented in figure [ t2f16 ] ( black , solid lines ) , together with a sample of the results obtained by the other codes in i06 ( see caption in the figure ) .",
    "the overall size of the hii region and the internal structure agree very well .",
    "the temperature images and the spherically averaged profiles at times @xmath114 and @xmath115 myr are presented in figures [ t2temp ] and [ t2f17 ] .",
    "also in this case , the resulting temperature structure agree well with most of the other codes in i06 . in particular , we are able to obtain a large pre - heated region without any sign of spatial anisotropy , since our algorithm does not suffer from the under - sampling the radiation field ( like in a `` classical '' monte carlo ) , even a large distances from the sources .",
    "myr obtained by ` radamesh `  ( top - left panel ) and by three of the four codes that performed the same tests in i06 , in particular : ` crash ` ( bottom - left panel ) , ` c^2-ray ` ( top - right panel ) , and ` ftte ` ( bottom - right panel ) . ]",
    "myr obtained by ` radamesh `  ( top - left panel ) and by three of the four codes that performed the same tests in i06 ( see caption in figure [ t4hi_005 ] ) . ]     myr obtained by ` radamesh `  ( top - left panel ) and by three of the four codes that performed the same tests in i06 ( see caption in figure [ t4hi_005 ] ) . ]     myr obtained by ` radamesh `  ( top - left panel ) and by three of the four codes that performed the same tests in i06 ( see caption in figure [ t4hi_005 ] ) . ]",
    "this test verifies that the propagation of an i - front within a dense clump is slowed down at the point of being stopped ( _ trapped _ ) and the production of a correct shadowing effect ( in both the ionization and the temperature state ) behind the clump .",
    "we use the same set - up as described by i06 : a spherical ( hydrogen - only ) uniform cloud of radius @xmath140 kpc , is located at the position @xmath141 kpc within a box of length @xmath127 kpc . the hydrogen number density and the initial temperature outside of the clump are , respectively , @xmath142 @xmath129 and @xmath143k , while inside the clump we have @xmath144 @xmath129 and @xmath145 k. the radiation has a black - body spectrum with @xmath146 k and a constant ionizing photon flux @xmath147 s@xmath132 @xmath148 , incident to the @xmath110 box side .",
    "given these parameters , we expect that the i - front should be trapped slightly beyond the clump centre , as discussed in i06 . in figure [ t3hi_ima ]",
    ", we show slices of the gas neutral fraction at the box mid - plane @xmath149 kpc ( passing through the centre of the clump ) at times @xmath150 myr ( top panel ) and @xmath136 myr ( bottom panel ) .",
    "the corresponding temperature slices are presented in figure [ t3temp_ima ] . at @xmath150 myr ,",
    "the i - front is not yet trapped and it is still moving supersonically from the edge of the clump .",
    "the images show that the shadow is sharp and produced correctly behind the clump .",
    "as expected , the i - front is trapped slightly beyond the clump centre at @xmath136 myr .",
    "the position of the i - front and the hi profiles inside the clump , presented in figure [ t3hi_prof ] , agree well with the other codes in i06 , altough , especially at later times , the results are rather code dependent . the same is true for the temperature profiles , as shown in figure ( [ t3temp_prof ] ) .      in this test",
    ", we follow the propagation of the ionization - fronts from multiple sources in a static cosmological density field .",
    "the initial conditions for the density and source spatial distribution / luminosities are provided by i06 . in particular",
    ", we use a time - slice at @xmath151 from a hydro - simulation with a box size of @xmath152 comoving mpc and @xmath153 cells .",
    "the initial temperature is fixed to t=100 k everywhere .",
    "the ionizing sources correspond to the 16 most massive halos in the box , with a luminosity proportional to the halo mass and a black - body spectrum with @xmath154 k ( see i06 for more details ) .    in figures [ t4hi_005 ] and [ t4hi_02 ] , we present slices of neutral hydrogen fraction cut through the simulation box at coordinate @xmath155 , in box units , at time @xmath156 myr and @xmath157 myr , respectively . comparing our results with three of the four codes that performed this test in i06 ( ` c^2-ray ` , `",
    "crash ` and ` ftte ` ) , we find a general agreement , although all the codes produce somewhat different morphologies .",
    "this general agreement is confirmed also examining the temperature slices in figures [ t4temp_005 ] and [ t4temp_02 ] . here",
    "the differences between the codes presented in i06 is higher and due to different assumption about spectral hardening and partially to the different algorithm used .",
    "the spectral hardening effect , namely the increased temperature in the regions that are still mostly neutral , is traced in detail by ` radamesh ` .",
    "myr and coordinate @xmath155 ( box units ) .",
    "the multi - mesh structure in the plane @xmath155 is overlaid . ]      with this test , not present in the original set of i06 , we show and verify the multi - grid capability of ` radamesh `  in the case of a static multi - mesh .",
    "in particular we use the same initial condition of test 1 changing the original grid with three nested , concentric grids with @xmath158 cells , corresponding to two levels of refinement ( with a factor two and four increased resolution with respect to the base mesh ) . with this configuration ,",
    "the centre of the box has a resolution equivalent to a @xmath159 cells grid .",
    "we limit the number of levels and the resolution of the base grid in this test for illustrative purposes .",
    "the source position is @xmath160 in box units . in figure ( [ t5 mg ] ) , we show the image of hi fraction and the computational meshes corresponding to the slice at coordinate @xmath155 and time @xmath161 myr . as we can see from the image ,",
    "the front is tracked very well despite of the different grids ( and resolution ) , with no spurious effect introduced by the multi - grid structure .      in the original set of tests in i06 ,",
    "the initial conditions ( e.g. , box size , hydrogen density , source luminosity ) have been chosen in such a way to properly resolve the i - front with a single , uniform grid of @xmath153 cells .",
    "for example , in the final test of i06 , test 4 ( multiple sources in a `` cosmological '' density field ) , the box size is fixed to @xmath152 comoving mpc , corresponding to @xmath162 physical kpc at the simulation redshift ( @xmath151 ) for @xmath163 . however , in a more realistic cosmological situation , e.g. for the study of the reionization process or the expansion of the i - front around a bright , high - redshift qso , the box size must be at least 2 orders of magnitude larger than test 4 ( see , e.g. , meiksin 2009 ) .",
    "this test , not present in the original set of i06 , demonstrate the ability of ` radamesh `  to resolve the i - front of a bright quasar in a large cosmological box , with the help of an adaptively evolving multi - mesh .",
    "in particular we show that properly resolving the i - front is essential to accurately predict the temperature state of the gas , both in the i - front and in the qso hii region . for this purpose",
    "we run a series of simulation increasing the maximum level of refinement until convergence is reached for the temperature state of the gas . in the same spirit of test 2",
    ", we use an uniform ( hydrogen - only ) medium with evolving temperature and we locate the source at one corner of the box . the box size is @xmath164 comoving mpc , the medium density is equal to the mean hydrogen density of the universe and it evolves with redshift .",
    "the initial redshift is @xmath165 , the total evolution time is @xmath166 yr ( corresponding to a final redshift @xmath167 ) .",
    "the source has a power - law spectrum with a ( frequency ) spectral slope of @xmath168 , sampled in 60 logarithmically spaced bins from 1 to 60 rydberg .",
    "the total ionization rate is @xmath169 ph s@xmath132 .",
    "these parameters are comparable to the respective quantities associated with the observed high - redshift quasars in sdss ( e.g. , fan et al .",
    "2006 ) .    for the assumed spectrum ( which has a mean ionizing photon energy of @xmath170 ryd ) the photon mean - free path is @xmath171 physical kpc at the initial redshift for a fully neutral patch of gas composed of hydrogen only .",
    "to resolve the i - front properly we would ideally need that @xmath172 is sampled by at least two cells , i.e. a spatial resolution of @xmath173 physical kpc . with an uniform grid",
    "this would correspond to a @xmath174 cells mesh , effectively out of the reach for current computational facilities .",
    "instead , we use a @xmath153 base grid and 5 additional levels of adaptive grid refinement that follow the i - front expansion , effectively achieving the required spatial resolution .    in figure [ t6image ]",
    ", we show an image slice of the hydrogen neutral fraction at @xmath175 yr ( in the quasar rest - frame ) .",
    "the i - front scale is so small compared to the box size that it visually appears perfectly thin in the large image .",
    "zooming in by a large factor in a small region containing the i - front ( see inset in the same figure ) , and now the i - front thickness appears . in box units ,",
    "the i - front size ( as measured from the points where the neutral fractions are 0.1 and 0.9 ) is roughly @xmath176 , i.e. @xmath177 physical kpc , corresponding to @xmath178 .",
    "overlaid , we show the adaptively refined multi - mesh structure that closely follows the i - front , with the highest level of refinement ( @xmath179 ) that encompasses the i - front itself . at this level of refinement ,",
    "the i - front is fully resolved by at least 10 simulation cells .    in figure",
    "[ t6plot ] , we show how resolving the i - front changes the predicted temperature profile inside the qso hii bubble and in the i - front region . from bottom to top ,",
    "the lines represent the temperature profiles obtained varying the maximum level of refinement from @xmath180 ( i.e. , single uniform grid ) to @xmath181 .",
    "as expected , temperature convergence is reached for @xmath182 , i.e. at spatial resolution comparable or smaller than @xmath172 , indicating that we are effectively resolving the i - front .",
    "in fact , fully resolving the i - front improves the sampling of the spectral hardening ( within the i - front itself ) and a harder spectrum is able to produce a large _ increase _ in the gas temperature , as observed in figure [ t6plot ]     note that the current temperature of a cell within the hii region at @xmath115 myr is mainly determined at an earlier epoch , i.e. , when the cell was located within the i - front .",
    "therefore , also the temperature increase _ within _ the hii region can be ascribed to the ( i - front ) spectral hardening effect .",
    "numerical effects on the gas temperature due to the different resolution are negligible , as we show in appendix b.    .",
    "the prediction of the correct temperature state in the i - front and in the qso bubble is fundamental , e.g. , for the study of the reionization epoch with the near - zone ly@xmath90 forest ( see e.g. , bolton et al .",
    "2010 ) or with the i - front ly@xmath90 emission ( cantalupo et al .",
    "2008 ) .",
    "comoving mpc ) and i - front adaptive mesh refinement .",
    "the qso was turned on at @xmath165 and keep it at a constant ionizing rate of @xmath169 ph s@xmath132 for @xmath175 yr ( the final redshift is thus @xmath167 ) . from bottom to top , the lines correspond to increasing maximum level of refinement ( from @xmath180 to @xmath181 ) . the base grid is composed by @xmath153 cells .",
    "this plot clearly shows that the high - resolution achieved through amr is essential to correctly resolve the i - front and , thus , to properly recover the gas temperature profile around the qso in a cosmological context . ]",
    "we repeat test 1 dropping the ots approximation used in i06 and including now the full radiative transfer of diffuse photons produced by hydrogen recombinations .",
    "since all the cell in the strmgren sphere may be now source of ionizing photons , we must change the original test configuration , placing the ( discrete ) source at the centre of the box and increasing the box size by a factor of two . apart from these modifications",
    ", we use the same parameter set as in test 1 .    for a monochromatic spectrum , homogeneous medium and for a fixed temperature , we know that the radius of the strmgren sphere ( @xmath183 ) obtained with the ots ( case b ) approximation must be equal to the one obtained with the full radiative transfer of the diffuse radiation .",
    "this is a fundamental constraint deriving from photon conservation .",
    "moreover , once the ionization equilibrium has been reached , there is an analytical approximation for the ratio between the diffuse and directional radiation field needed to compensate , at a given radius @xmath93 , the recombinations , as found by ritzerveld ( 2005 ) :    @xmath184^{1-\\alpha/\\alpha_{{\\mathrm}{b}}-1 } \\ , \\ ] ]    where the first equality is only valid for a monochromatic spectrum .",
    "note that eq .",
    "( [ ritz ] ) is exact for an `` outward - only '' system , i.e. when the contribution to @xmath185 is given by the recombinations at @xmath186 ( indeed , @xmath187 in ritzerveld s solution ) .",
    "therefore , we expect that this approximation should slightly underestimate @xmath188 for @xmath189 ( note , however that within this region the total radiation field will be dominated by @xmath190 ) .    in figure [ gammadiff ]",
    ", we present the result obtained by ` radamesh `  including the full radiative transfer of diffuse photons ( black solid line ) . in very good agreement with the analytical expectations",
    "( red dashed line ) , we found that the diffuse radiation field strength equals the directional field from the central source at @xmath191 , confirming that diffuse radiation is dominant in the outer parts of the strmgren sphere .",
    "the full rt results produce , as expected , a slightly higher value of diffuse radiation in the central parts of the hii regions with respect to the `` outward - only '' solution .",
    "because of photon conservation , this is correctly balanced by a lower diffuse field at the edge of the strmgren sphere when compared to the analytical approximation .    in figure [ hifracdiff ] ,",
    "we show how the hydrogen neutral fraction profile ( @xmath192 ) at `` equilibrium '' ( @xmath112 myr ) is modified by the full radiative transfer of diffuse photons ( red solid line ) with respect to the ots ( case b ) approximation ( blue , long - dashed line ) and the other extreme represented by the case a approximation ( black , short - dashed line ) .",
    "as expected , in the interior of the hii regions , where the gas is highly ionized , the mean - free - path of the diffusion photons is very large and thus the profile obtained by the full rt closely follows the one obtained assuming case a. however , as the local opacity increases moving outward , diffuse photons start to be absorbed and the hi fraction tends to become closer to the ots case . in the outer parts of the hii region ( @xmath193 ) , diffusion radiation becomes the dominant component and the gas is more ionized than in the ots case b approximation .",
    "however , in accordance with photon conservation , the final size of the strmgren sphere is very close to the one obtained with case b : the recombination radiation escaped from the inner region has been absorbed ( creating an `` excess '' ) closer to the strmgren radius , but the final photon balance is the same .    as a remark , it is interesting to note that the ots approximation is actually never valid inside the strmgren sphere for this very simple , standard test ( apart , obviously , at the strmgren radius ) . actually , case a is a much better approximation if one is interested in the inner part of the hii region , or , analogously , in the early phases of the ionization - front expansion .",
    "( see text for details ) . in this test , the medium temperature has been fixed to @xmath119k ]    myr for case a ( short dashed black line ) , `` on - the - spot '' case b ( long dashed blue line ) approximations and including the full radiative transfer of diffuse emission from hii recombinations ( solid red line ) . in this test",
    ", the medium temperature has been fixed to @xmath119k . ]",
    "the previous test has been limited to the very simple case of a monochromatic spectrum ( for both diffuse and direct radiation ) and a hydrogen only , fixed temperature medium . in this way , we were able to compare our results to the analytical prediction from photon conservation arguments .",
    "however , the real effect induced by the full rt of recombination radiation is much more complex since its characteristic spectral energy distribution ( sed ) is in general different from the sed of the discrete sources .",
    "moreover , the presence of helium may have a profound impact also on the neutral hydrogen distribution , given that both the bound - free and the balmer continuum of hei and heii ( together with two - photon and line emissions ) are able to ionize hi .",
    "in this test , we verify these effects using the same configuration of test 2 , including now the full rt of recombination radiation from hydrogen and helium . the only parameters , apart the inclusion of the diffuse component rt , that have been modified with respect to test 2 are the following : i ) the discrete source has been placed in the centre of the box and the box size has been increased by a factor 2 , ii ) the medium include hydrogen and helium , iii ) we evolve the simulation to @xmath112 myr .",
    "note that we do not expect in this case a full equilibrium to be reached , given the complex interplay between hydrogen and helium recombination emission and their ionization state .    in figure [ hifracdiff_t2b ] , we present the hi profile obtained by the full rt of diffuse radiation ( red solid line ) in comparison with the case a approximation ( black , short - dashed line ) and the ots case b ( blue , long - dashed line ) at @xmath112 myr . in figure",
    "[ hefracdiff_t2b ] , we show the analogous profiles for the hei , heii and heiii fractions ( see labels in the figure ) . as evident from figure [ hifracdiff_t2b ] , there is now an excess of hi photoionizations with respect to case b , that leads to a larger strmgren sphere size .",
    "this excess is due to diffuse photons produced by helium recombinations , in particular the balmer continuum ( plus ly@xmath90 and two - photon continuum ) produced in the heiii region , that alters the total photon budget available for the photoionization of hi . in effect , a fraction of the high - energy , heii - ionizing photons from the central source are `` converted '' via heiii recombinations to lower energy , hi - ionizing photons ( and also hei - ionizing photons ; indeed , a similar but less conspicuous effect is also visible for the hei fractions in figure [ hefracdiff_t2b ] ) .",
    "therefore , assuming case b for hydrogen and helium actually results in the loss of this important component of the photon budget .",
    "this enlightens the importance of including heii and heiii recombination emission also for studies that are only interested in the properties of the hydrogen component .",
    "myr for case a ( short dashed black line ) , case b ( long dashed blue line ) approximations and including the full radiative transfer of ionizing diffuse emission from hii , heii and heiii recombinations ( solid red line ) . ]     myr for case a ( short dashed black lines ) , `` on - the - spot '' case b ( long dashed blue lines ) approximations and including the full radiative transfer of ionizing diffuse emission from hii , heii and heiii recombinations ( solid red lines ) . ]",
    "we have presented a new , three - dimensional radiative transfer code , called ` radamesh ` , based on an adaptive monte carlo ray - tracing scheme .",
    "the algorithm has been specifically developed to efficiently resolve the small scales associated with the ionization - fronts within large , cosmological simulations , with the help of an adaptive mesh refinement ( amr ) scheme combined with a new `` cell - by - cell monte carlo '' approach : rays are casted separately from selected cells within the computational box to the sources with a method that ensures their correct solid angle distribution .",
    "this method has several advantages with respect to a classical monte carlo ray - tracing scheme    where a series of rays is uniformly casted around a source to obtain the correct solid angle distribution .    , in particular for multi - mesh domains .",
    "indeed , in a classical monte carlo , the number of rays to cast is determined by the smallest , most distant cells to the source , i.e. from the ( few ) cells at the highest refinement level , oversampling the rest of the box . in ` radamesh ` , the number of rays is proportional to the number of cells to be evolved during the current time - step , i.e. the fast evolving cells typically located within the i - front .",
    "this translates into a huge gain in computational speed and efficiency , given the small fraction of the computational volume occupied by the i - front .",
    "moreover , we are now able to choose a local criterion that adaptively determines the number of rays needed in a particular cell , e.g. set by the convergence of the radiation field .",
    "this ensures to obtain the required accuracy in the prediction of the temperature or ionization state of the gas in a very efficient way : concentrating the computational efforts only where actually needed .    in the same spirit of hydrodynamical amr codes , `",
    "radamesh `  is also able to increase the spatial resolution where required , adaptively refining the mesh in correspondence of the ionization - fronts .",
    "the implemented algorithm is based on the original patch - based amr method of berger & rigoutsos ( 1991 ) .    `",
    "radamesh `  is able to trace the ionization - fronts from multiple sources as well as the diffuse ionizing radiation produced by hydrogen and helium recombinations with a multi - frequency approach .",
    "the time - evolution of six different species ( hi , hii , hei , heii , heiii , e ) and the gas temperature is followed with a time - dependent , non - equilibrium chemistry solver based on an implicit runge - kutta scheme of variable , adaptive order .",
    "we performed all the four tests present in the radiative transfer code comparison project of iliev et al .",
    "2006 , plus four additional , new tests aimed to substantiate and show the new characteristic of ` radamesh `  .",
    "the first four tests include the correct tracking of the i - front in homogeneous ( test 1 ) and in - homogeneous density fields with multiple sources ( test 4 ) , i - front trapping behind a dense clump ( test 3 ) , and the effect of photo - heating on the gas temperature state ( test 2 ) .",
    "these tests , like in the original i06 work , have been performed on a single , static mesh , without emission from atomic recombinations in order to better compare our results with the other codes .    `",
    "radamesh `  results are in very good agreement with the majority of the other codes present in i06 . in particular , thanks to the new adaptive algorithm , we have shown ( test 1 ) that the recovered i - front thickness and structure does not suffer from any diffusive effects and numerical broadening typical of other monte carlo codes ( given their poor sampling at large distances from the source ) .",
    "the same is true when the gas temperature is examined ( test 2 ) .",
    "the second set of tests ( test 5 to test 8) shows the ability of ` radamesh `  to deal with both static ( test 5 ) and adaptively evolving ( test 6 ) multi - mesh structures , and with diffuse radiation produced by hydrogen ( test 7 ) and helium ( test 8) recombinations . in test 5 , we reproduce the same results of the classical strmgren sphere situation ( test 1 ) with a nested hierarchy of meshes at different refinement levels , showing that no spurious effects are introduced by the multi - mesh structure .",
    "most importantly , we have shown in test 6 that ` radamesh `  is able to fully resolve an expanding i - front from a bright source ( e.g. , a quasar ) within a large , cosmological box ( 100 comoving mpc size ) , thanks to an adaptively evolving mesh with several levels of refinement .",
    "the ability of resolving the i - front on cosmological scales is fundamental for a large range of applications .",
    "for instance , recovering the correct gas temperature within the i - front and the qso bubble is important , e.g. , for the study of the reionization epoch with the near - zone ly@xmath90 forest ( see e.g. , bolton et al .",
    "2010 ) or with the ly@xmath90 emission generated within the i - front ( cantalupo et al .",
    "2008 ) . in test 6",
    ", we have demonstrated that a proper treatment of the spectral hardening inside a resolved i - front may result in a substantial increase of the gas temperature ( @xmath194 k ) within the _ whole _ hii region surrounding the bright , central source .    the effect of diffuse radiation generated by hydrogen recombinations on the classic strmgren sphere case ( with monochromatic radiation ) has been presented in test 7 . here",
    ", we have verified that our treatment of diffuse radiation produces the same strmgren sphere size with respect to the case b approximation , in agreement with photon conservation . moreover , in accordance with the analytical prediction by ritzerveld ( 2005 ) , we have verified that the diffuse field becomes the dominant component at a distance from the source corresponding to 87% of the strmgren radius .",
    "the neutral fraction profile in the inner part of the hii region follows the same profile obtained with case a approximation , while in the outer part the gas is more ionized and the i - front narrower than the result obtained with the widely used , case b approximation . in test 8",
    ", we have also considered the effect of hei and heii recombination radiation on the hydrogen and helium ionization state .",
    "we have found that heii diffuse radiation , especially the hi - ionizing , heii balmer continuum ( together with heii two - photon continuum and ly@xmath90 emission ) may have an important effect also on the hydrogen ionization state , substantially increasing the strmgren sphere size .    at present , ` radamesh `  is not yet coupled with hydro - dynamics but is able to post - process the output of three different hydrodynamical codes , both grid - based , e.g. , ` ramses ` ( teyssier 2002 ) , ` charm ` ( miniati & colella 2007 ) and particle - based , e.g. ` gadget ` ( springel 2005 ) .",
    "these outputs are efficiently converted to ` radamesh `  patch - based structures with a fast algorithm based on the clustering method of berger & rigoustous ( 1991 ) , also used into the amr module .",
    "the default format is very similar to the widely used ` chombo hdf5 ` structure    https://seesar.lbl.gov/anag/chombo    , allowing ` radamesh `  outputs to be directly visualized with the most recent , high - performance visualization packages ( e.g. , ` visit `    https://wci.llnl.gov/codes/visit    ) .",
    "currently , ` radamesh `  is efficiently parallelized with openmp .",
    "all the results presented in this paper have been obtained with a few hours of computational time on a 8-core intel - xeon workstation .",
    "sc thanks francesco miniati for useful discussions and martin haehnelt for comments on an earlier version of this manuscript .",
    "cp acknowledges the role of piero madau who nearly 10 years ago sensitised him to the cosmological radiative - transfer problem and followed the development of some unpublished algorithms .",
    "part of the figures presented in this paper have been realized with the visualization software visit , we are grateful to llnl to have made public this powerful tool .",
    "abel , t. , norman , m.  l. , & madau , p.  1999 , apj , 523 , 66 abel , t. , & wandelt , b.  d.  2002 , mnras , 330 , l53 altay , g. , croft , r.  a.  c. , & pelupessy , i.  2008 , mnras , 386 , 1931 amanatides , j. , & woo , a. , `` a fast voxel traversal algorithm for ray tracing '' , proc .",
    "eurographics 87 , amsterdam , the netherlands , august 1987 , pp 1 - 10 aubert , d. , & teyssier , r.  2008 , mnras , 387 , 295 baker , j.  g. , & menzel , d.  h.  1938 , apj , 88 , 52 berger , m.  j. , and oliger , j. , `` adaptive mesh refinement for hyperbolic partial differential equations '' , j. comput .",
    "phys . , 53 , pp .",
    "484 - 512 , 1984 berger , m.  j. , and rigoustsos , i. , `` an algorithm for point clustering and grid generation '' , new york university - cims report nyu-501 , 1991 bolton , j.  s. , becker , g.  d. , wyithe , j.  s.  b. , haehnelt , m.  g. , & sargent , w.  l.  w.  2010 , arxiv:1001.3415 cantalupo , s. , porciani , c. , & lilly , s.  j.  2008 , apj , 672 , 48 ercolano , b. , & storey , p.  j.  2006 , mnras , 372 , 1875 gnedin , n.  y. , & abel , t.  2001 , new astronomy , 6 , 437 fan , x. , at al .  2006 , aj , 132 , 117 finlator , k. , zel , f. , & dav , r.  2009 , mnras , 393 , 1090 hairer , e. , & wanner , g. , `` solving ordinary differential equations ii .",
    "stiff and differential - algebraic problems '' , springer series in comput .",
    "mathematics , vol .",
    "14 , springer - verlag 1991 , second revised edition 1996 . , l. and gnedin , n.  y. , 1997 , mnras , 292 , 27 khokhlov , a.  m. , 1998 , j.comput.phys . , 143 , 519 , i.  t. , ciardi , b. , alvarez , m.  a. , maselli , a. , ferrara , a. , gnedin , n.  y. , mellema , g. , nakamoto , t. , norman , m.  l. , razoumov , a.  o. , rijkhorst , e .-",
    "j . , ritzerveld , j. , shapiro , p.  r. , susa , h. , umemura , m. , whalen , d.  j. , 2006 , mnras , 371 , 1057 maselli , a. , ferrara , a. , & ciardi , b.  2003 , mnras , 345 , 379 meiksin , a.  a.  2009 , reviews of modern physics , 81 , 1405 mellema , g. , iliev , i.  t. , alvarez , m.  a. , & shapiro , p.  r.  2006 , new astronomy , 11 , 374 miniati , f. , & colella , p.  2007",
    ", journal of computational physics , 227 , 400 norman , m.  l. , paschos , p. , & abel , t.  1998 , memorie della societa astronomica italiana , 69 , 455 nussbaumer , h. , & schmutz , w.  1984 , a&a , 138 , 495 osterbrock , d.  e. , 1989 , astrophysics of gaseous nebulae and active galactic nuclei .",
    "university science books , mill valley , ca , p. 422",
    "pawlik , a.  h. , & schaye , j.  2008 , mnras , 389 , 651 petkova , m. , & springel , v.  2009 , mnras , 396 , 1383 razoumov , a.  o. , & cardall , c.  y.  2005 , mnras , 362 , 1413 rijkhorst , e .-",
    "plewa , t. , dubey , a. , & mellema , g.  2006 , a&a , 452 , 907 ritzerveld , j.  2005 , a&a , 439 , l23 ritzerveld , j. , & icke , v.  2006 , physical review e , 74 , 026704 semelin , b. , combes , f. , & baek , s.  2007 , a&a , 474 , 365 shapiro , p.  r. , iliev , i.  t. , alvarez , m.  a. , & scannapieco , e.  2006 , apj , 648 , 922 springel , v.  2005 , mnras , 364 , 1105 teyssier , r.  2002 , a&a , 385 , 337 trac , h. , & cen , r.  2007 , apj , 671 , 1 whalen , d. , & norman , m.  l.  2006 , apjs , 162 , 281",
    "starting from the explicit form of the solid angle for each face of a cubic cell , we have found the following approximation for the total cell solid angle as seen by any source inside ( or outside ) the computational box :    @xmath195 \\ , \\end{split}\\ ] ]    where @xmath196 is the three - dimensional levi - civita symbol ( note the implicit sum over the indices @xmath197 and @xmath198 ) , @xmath199 is the @xmath200 matrix containing the cell vertexes coordinates ( translated to the cartesian system with the source at the origin ) , @xmath201 and @xmath202 are , respectively , the cell centre and the source coordinates , @xmath54 is the linear cell size , @xmath203 is the @xmath204 unit matrix ( i.e. , the matrix of ones ) , and @xmath205 is the following @xmath200 matrix :    @xmath206 .",
    "all lengths and coordinates are in box units .",
    "note that the presence of the factors containing @xmath207 and @xmath196 reduce the total number of terms in the overall sum to four per cell face .",
    "the function @xmath208 removes from the sum the solid angle of a face _",
    "invisible _ to the source , since this has a negative sign .    in figure",
    "[ satest ] , we show the comparison between the recovered cell solid angle obtained by a full monte carlo simulation with @xmath153 cubic cells and @xmath166 rays ( black circles ) , and the above analytical approximation ( red solid line ) . the solid angle is shown as a function of the distance from the source , placed at @xmath209 , and for two different directions : parallel to the @xmath137-axis ( i.e. , normal to two cell faces ; lower line ) and along the line of sight that connects the source to the box vertex @xmath210 ( upper line ) .",
    "note that these two directions correspond to the minimum and maximum possible solid angle of a cubic cell at a given distance from the source .",
    "the analytical approximation is in very good agreement with the monte carlo results",
    ".     grid .",
    "the solid angle is shown as a function of the distance from the source , as seen by two different angular directions ( see labels ) . ]",
    "in test 6 , we have shown that the spectral hardening inside a resolved i - front may result in a substantial increase of the gas temperature ( @xmath194 k ) within the _ whole _ hii region surrounding a bright quasar . to better demonstrate that this result is not affected by numerical effects due to the different grid resolutions , we have repeated test 6 assuming a source with similar ionizing rate but with a soft spectrum ( a black - body with @xmath211 k ) . in this case ,",
    "spectral hardening is minimal and therefore we do not expect that increasing the resolution on the i - front should substantially change the gas temperature as in test 6 . as we show in figure [ t6b ] ( line colors and style have the same meaning as in figure 18 ) , this is indeed the case : different maximum levels of refinement produce now very similar temperatures inside the hii region showing that numerical effects are not important .",
    "note that the ( larger ) shift in the i - front position in figure [ t6b ] ( with respect to figure 18 ) is due to the fact that , at the lowest resolution , cells are very optically thick to radiation with frequencies right above the ionization threshold ( the vast majority , given the soft spectrum assumed here ) .",
    "this slightly alters photon - conservation , which holds to high accuracy when the front is resolved into less optically thick elements , as shown in test 1 .",
    "k ) . in this case ,",
    "spectral hardening is minimal and different maximum levels of refinement produce now very similar temperatures inside the hii region .",
    "this demonstrates that numerical effects are not substantially affecting the results of test 6 . ]"
  ],
  "abstract_text": [
    "<S> we present a new three - dimensional radiative transfer ( rt ) code , ` radamesh ` , based on a ray - tracing , photon - conserving and adaptive ( in space and time ) scheme . ` </S>",
    "<S> radamesh `  uses a novel monte carlo approach to sample the radiation field within the computational domain on a `` cell - by - cell '' basis . </S>",
    "<S> thanks to this algorithm , the computational efforts are now focused where actually needed , i.e. within the ionization - fronts ( i - fronts ) . </S>",
    "<S> this results in an increased accuracy level and , at the same time , a huge gain in computational speed with respect to a `` classical '' monte carlo rt , especially when combined with an adaptive mesh refinement ( amr ) scheme . among several new features , ` radamesh `  is able to adaptively refine the computational mesh in correspondence of the i - fronts , allowing to fully resolve them within large , cosmological boxes . we follow the propagation of ionizing radiation from an arbitrary number of sources and from the recombination radiation produced by h and he . the chemical state of six species ( hi , hii , hei , heii , heiii , e ) and gas temperatures are computed with a time - dependent , non - equilibrium chemistry solver . </S>",
    "<S> we present several validating tests of the code , including the standard tests from the rt code comparison project and a new set of tests aimed at substantiating the new characteristics of ` radamesh ` . using our amr scheme , </S>",
    "<S> we show that properly resolving the i - front of a bright quasar during reionization produces a large increase of the predicted gas temperature within the whole hii region . </S>",
    "<S> also , we discuss how h and he recombination radiation is able to substantially change the ionization state of both species ( for the classical strmgren sphere test ) with respect to the widely used `` on - the - spot '' approximation .    </S>",
    "<S> [ firstpage ]    radiative transfer - methods : numerical - hii regions - intergalactic medium - diffuse radiation - cosmology : theory </S>"
  ]
}