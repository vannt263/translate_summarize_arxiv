{
  "article_text": [
    "the solar interior , photosphere and atmosphere are coupled by magnetic fields .",
    "it is therefore important to gain insights about the magnetic field structure in all layers of the sun and solar atmosphere .",
    "direct and accurate measurements of the magnetic field vector are typically carried out only on the photosphere .",
    "although measurements in higher layers are available for a few individual cases , _",
    "e.g. _ in the chromosphere by solanki _",
    "( 2003 ) and in the corona by , the line - of - sight integrated character of such chromospheric and coronal magnetic field measurements complicates their interpretation @xcite .",
    "knowledge of the magnetic field in the corona is essential , however , to understand basic physical processes such as the onset of flares , coronal mass ejections and eruptive prominences .",
    "inferences of the coronal magnetic field can be obtained by extrapolating measurements of the photospheric magnetic field vector ( _ e.g. _ observed by _",
    "hinode_/sot , solis or the upcoming sdo / hmi instruments ) into the corona .",
    "because the magnetic pressure dominates the plasma pressure in active - region coronae , making the plasma @xmath1 low , [ see work by and , which discuss the plasma beta over active regions and over the quiet sun , respectively ] , these extrapolations neglect non - magnetic forces and assume the coronal magnetic field @xmath2 to be force - free , such that it obeys :    @xmath3    equation ( [ jxb ] ) implies that the electric current density @xmath4 is parallel to the magnetic field @xmath5 .",
    "starting more than a quarter century ago @xcite , different mathematical methods and numerical implementations have been developed to solve the nonlinear force - free equations ( [ divb ] ) and ( [ jxb ] ) for the solar case .",
    "see , for example , @xcite for review papers and @xcite for evaluations of the performance of corresponding computer programs with model data .",
    "the codes use the magnetic field vector ( or quantities derived from the magnetic field vector ) on the bottom boundary of a computational domain as input .",
    "one would like to prescribe the measured photospheric data as the bottom boundary of nonlinear force - free fields ( nlfff ) codes , but there is a problem : the observed photospheric magnetic field is usually not force - free .",
    "the relatively high plasma @xmath1 in the photosphere means that non - magnetic forces can not be neglected there and that such photospheric magnetic field data are not consistent with well known force - free compatibility conditions defined in @xcite .",
    "recently , developed a scheme that mitigates this problem , in which the inconsistent and noisy photospheric vector magnetograms used as bottom boundary conditions are preprocessed in order to remove net magnetic forces and torques and to smooth out small - scale noise - like magnetic structures .",
    "the resulting magnetic field data are sufficiently force - free and smooth for use with extrapolation codes , but also are found to bear a high resemblance to chromospheric vector magnetic field data .",
    "this leads us to the question whether we can constrain the preprocessing tool further by taking direct chromospheric observations , such as h@xmath0 images , into consideration .",
    "we will investigate this topic in the present work .",
    "in this section , we briefly discuss the criteria on the photospheric boundary data that are required for consistency with a force - free extrapolation of the overlying coronal magnetic field .",
    ", , , and show how moments of the lorentz force , integrated over a volume of interest , define constraints on the closed surface bounding this volume . as explained in detail in the sense of these relations",
    "is that on average a force - free field can not exert pressure on the boundary or shear stresses along axes lying in the boundary . for the coronal magnetic field extrapolation calculations discussed here , a localized region of interest , such as an active region , is typically selected for analysis .",
    "the extrapolation algorithms applied to the coronal volume overlying such localized regions of interest require boundary conditions , and , except at the lower ( photospheric ) boundary , these boundary conditions are usually chosen to be consistent with potential fields and thus do not possess magnetic forces or torques . in these cases ,",
    "the consistency criteria reduce to conditions on the lower boundary only :    1 .   on average force - free fields can not exert pressure on the boundary + @xmath6 2 .   on average force - free fields can not create shear stresses along axes lying in the boundary + @xmath7",
    "these relations must be fulfilled in order to be suitable boundary conditions for a nonlinear force - free coronal magnetic field extrapolation .",
    "we define dimensionless numbers ,    @xmath8    @xmath9    in order to evaluate how well these criteria are met .",
    "ideally , it is necessary for @xmath10 for a force - free coronal magnetic field to exist . pointed out that the magnetic field is probably not force - free in the photosphere , where @xmath2 is measured because the plasma @xmath1 in the photosphere is of the order of unity and pressure gradient and gravity forces are not negligible . the integral relations ( [ prepro1])-([prepro5 ] ) are not satisfied in this case in the photosphere and the measured photospheric field is not a suitable boundary condition for a force - free extrapolation .",
    "investigations by metcalf _",
    "( 1995 ) revealed that the solar magnetic field is not force - free in the photosphere , but becomes force - free about @xmath11 above the photosphere .",
    "the problem has been addressed also by who pointed out that care has to be taken when extrapolating the coronal magnetic field as a force - free field from photospheric measurements , because the force - free low corona is sandwiched between two regions ( photosphere and higher corona ) with a plasma @xmath12 , where the force - free assumption might break down .",
    "an additional problem is that measurements of the photospheric magnetic vector field contain inconsistencies and noise .",
    "in particular the components of @xmath2 transverse to the line of sight , as measured by current vector magnetographs , are more uncertain than the line - of - sight component . as measurements in higher layers of the solar atmosphere ( where the magnetic field is force - free ) are not routinely available , we have to deal with the problem of inconsistent ( with the force - free assumption as defined by equations ( [ prepro1])([prepro5 ] ) ) photospheric measurements . a routine which uses measured photospheric vector magnetograms to find",
    "suitable boundary conditions for a nonlinear force - free coronal magnetic field extrapolation , dubbed `` preprocessing '' , has been developed by .",
    "the preprocessing scheme of involves minimizing a two - dimensional functional of quadratic form similar to the following :    @xmath13    where    @xmath14 ,    \\label{defl_1 } \\\\",
    "l_2 & = & \\left [ \\left(\\sum_p x   \\left(b_z^2-b_x^2-b_y^2 \\right ) \\right)^2                + \\left(\\sum_p y   \\left(b_z^2-b_x^2-b_y^2 \\right ) \\right)^2          \\right .",
    "\\nonumber \\\\ & & \\left .",
    "\\hspace*{0.8em }                + \\left(\\sum_p y b_x b_z -x b_y b_z \\right)^2          \\right ] , \\\\",
    "l_3 & = & \\left [ \\sum_p \\left(b_x - b_{xobs } \\right)^2",
    "+ \\sum_p \\left(b_y - b_{yobs } \\right)^2 \\right .",
    "\\nonumber \\\\   & &       \\left .",
    "+ \\sum_p \\left(b_z - b_{zobs } \\right)^2 \\right ] ,   \\label{defl_3 } \\\\",
    "l_4 & = & \\left [ \\sum_p \\left(\\delta b_x \\right)^2                       + \\left(\\delta b_y \\right)^2                       + \\left(\\delta b_z \\right)^2          \\right ] .",
    "\\label{defl_4}\\end{aligned}\\ ] ]    the surface integrals as defined in equations ( [ prepro1])([prepro5 ] ) are here replaced by a summation @xmath15 over all grid nodes @xmath16 of the bottom surface grid .",
    "we normalize the magnetic field strength with the average magnetic field on the photosphere and the length scale with the size of the magnetogram .",
    "each constraint @xmath17 is weighted by a yet undetermined factor @xmath18 . the first term ( @xmath19=1 )",
    "corresponds to the force - balance conditions ( [ prepro1])-([prepro2 ] ) , the next ( @xmath19=2 ) to the torque - free condition ( [ prepro3])-([prepro5 ] ) .",
    "the following term ( @xmath19=3 ) contains the difference of the optimized boundary condition with the measured photospheric data and the next term ( @xmath19=4 ) controls the smoothing .",
    "the 2d - laplace operator is designated by @xmath20 and the differentiation in the smoothing term is achieved by the usual 5-point stencil . the last term ( @xmath21 )",
    "has not been used in preprocessing so far and will be introduced in the next section .",
    "the aim of the preprocessing procedure is to minimize @xmath22 so that all terms @xmath17 if possible are made small simultaneously .",
    "this minimization procedure provides us iterative equations for @xmath23 ( see for details ) .",
    "as result of the preprocessing we get a data set which is consistent with the assumption of a force - free magnetic field in the corona but also as close as possible to the measured data within the noise level .",
    "nonlinear force - free extrapolation codes can be applied only to low plasma @xmath1 regions , where the force - free assumption is justified .",
    "this is known not to be the case in the photosphere , but is mostly true for the upper chromosphere and for the corona in quiescent conditions .",
    "the preprocessing scheme as used until now modifies observed photospheric vector magnetograms with the aim of approximating the magnetic field vector at the bottom of the force - free domain , _",
    "i.e. _ , at a height that we assume to be located in the middle to upper chromosphere . in this study",
    ", we investigate whether the use of chromospheric fibril observations as an additional constraint in the preprocessing can bring the resulting field into even better agreement with the expected chromospheric vector field .",
    "we discuss this idea in the next section .",
    "the idea is to specify another term ( @xmath24 ) in equation ( [ deflprep ] ) which measures how well the preprocessed magnetic field is aligned with fibrils seen in h@xmath0 . as a first step we have to extract the directions of the fibrils , say @xmath25 and @xmath26 out of the h@xmath0 images , where @xmath27 is a unit vector tangent @xmath28 to the chromospheric fibrils projected onto the solar photosphere ( representing the field direction with a 180-degree ambiguity ) . for simplicity one might rebin @xmath25 and @xmath26 to the same resolution as the vector magnetogram . in regions where we can not identify clear filamentary structures in the images we set @xmath29 .",
    "these regions are only affected by the other , classical terms of the preprocessing functional ( [ deflprep ] ) .",
    "the angle of the projected magnetic field vector on the xy - plane with the h@xmath0 image is    @xmath30    where @xmath31 is the projection of the magnetic field vector in the xy - plane and @xmath32 are the directions of the chromospheric h@xmath0 fibrils .",
    "the preprocessing aims for deriving the magnetic field vector on the bottom boundary of the force - free domain , which is located in the chromosphere .",
    "the chromospheric magnetic field is certainly a priori unknown and as initial condition for the preprocessing routine we take @xmath33 from the photospheric vector magnetogram .",
    "we define the functional :    @xmath34    please note that the term @xmath35 in equation ( [ defl5 ] ) weights the angle with the magnetic field strength , because it is in particular important to minimize the angle in strong field regions .",
    "the space dependent function @xmath36 is not a priori related to the magnetic field strength .",
    "@xmath37 can be specified in order to indicate the confidence level of the fibril direction - finding algorithm ( see _ e.g. _ , for the description of a corresponding feature recognition tool ) . for the application to observational data",
    "@xmath37 will be ( with appropriate normalization ) provided by this tool .",
    "it is likely , however , that the direction of the h@xmath0 fibrils can be identified more accurately in strong magnetic field regions , but this is not an a priori assumption . in section [ opti_halpha ]",
    "we investigate the influence of different assumptions for @xmath37 .",
    "we take the functional derivative of @xmath38    @xmath39    for a sufficiently small time step @xmath40 we get a decreasing @xmath38 with the iteration equations    @xmath41    the aim of our procedure is to make all terms in functional ( [ deflprep ] ) small simultaneously .",
    "there are obvious contradictions between some of the @xmath17 terms , such as between the @xmath42 ( photospheric data ) and @xmath43 ( smoothing ) terms .",
    "an important task is to find suitable values for the five parameters @xmath18 which control the relative weighting of the terms in equation ( [ deflprep ] ) .",
    "the absolute values do not matter ; only the relative weightings are important .",
    "we typically give all integral relations of the force and torque conditions ( [ prepro1])-([prepro5 ] ) the same weighting ( unity ) .",
    "to fulfill these consistency integrals is essential in order to find suitable boundary conditions for a nonlinear force - free extrapolation . in principle",
    "it would be possible to examine different values for the force - free term @xmath44 and torque - free term @xmath45 -or even to give six different weightings for the six integral relations- but giving all integrals the same weighting seems to be a reasonable choice .",
    "the torque integrals depend on the choice of the length scale @xmath46 and giving the same weighting to all integrals requires @xmath47 . for the length scale normalization used here @xmath48",
    "this leads to @xmath49 .",
    "we will test our newly developed method with the help of a model active region in the next section .",
    "layer , center : model - photospheric magnetic field , bottom : model - photospheric magnetic field after classical preprocessing with @xmath50.,width=529 ]          we test our extended preprocessing routine with the help of an active region model recently developed by van ballegooijen _",
    "( 2007 ) in this model line - of - sight photospheric measurements from soho / mdi have been used to compute a potential field .",
    "a twisted flux rope was then inserted into the volume , after which the whole system was relaxed towards a nonlinear force - free state with the magnetofrictional method described in . the van ballegooijen _ et al . _ ( 2007 ) model is force - free throughout the entire computational domain , except within two gridpoints of the bottom boundary .",
    "hereafter , we refer to the bottom of the force - free layer as the `` model chromosphere '' ( see the top panel of figure [ magnetograms1 ] ) . on the bottom boundary ( see the central panel of figure [ magnetograms1 ] ) , hereafter referred to as the `` model photosphere '' , the model contains significant non - magnetic forces and the force - free consistency criteria ( [ prepro1])-([prepro5 ] ) are not satisfied .",
    "these forces take the form of vertical buoyancy forces directed upward , and have been introduced by van ballegooijen _ et al . _",
    "( 2007 ) to mimic the effect of a reduced gas pressure in photospheric flux tubes . the nature of these forces is therefore expected to be similar to those observed on the real sun . for a more detailed discussion we refer to metcalf _",
    "( 2007 ) . both the chromospheric ( @xmath51 ) as well as the photospheric magnetic field vector ( @xmath52 ) from the van ballegooijen _ et al . _ ( 2007 ) model have been used to test four sophisticated nonlinear force - free extrapolation codes in a blind algorithm test by metcalf _",
    "the codes computed nonlinear force - free codes in a @xmath53 box , which is about at the upper limit current codes can handle on workstations .",
    "we briefly summarize the results of metcalf _ et al . _",
    "( 2007 ) as :    * nlfff - extrapolations from model - chromospheric data recover the original reference field with high accuracy . *",
    "when the extrapolations are applied to the model - photospheric data , the reference field is not well recovered .",
    "* preprocessing of the model - photospheric data to remove net forces and torques improves the result , but the resulting accuracy was lower than for extrapolations from the model - chromospheric data .",
    "the poor performance of extrapolations using the unprocessed model - photospheric data is related to their inconsistency with respect to the force - free conditions ( [ prepro1])-([prepro5 ] ) .",
    "the central panel of figure [ magnetograms1 ] shows the photospheric magnetic field and the central panel of figure [ magnetograms1a ] illustrates the difference between the model - chromospheric and model - photospheric fields .",
    "it is evident that there are remarkable differences in all components of the magnetic field vector . for real data we usually can not measure the chromospheric magnetic field vector directly ( which was possible for @xcite model data ) and we have to apply preprocessing before using the data as input for force - free extrapolation codes .",
    "force - free extrapolations using preprocessed data from the model photosphere ( as lower panels of figures [ magnetograms1 ] and [ magnetograms1a ] ) , while encouraging , were not completely satisfactory , in light of the results being worse than when the model - chromospheric data were used as boundary conditions . in",
    "what follows , we will use an artificial h@xmath0 image created from the model chromosphere to test a modified preprocessing scheme , and compare the results to the classical ( original ) preprocessing scheme .",
    "we use the model - chromospheric magnetic field @xmath54 to derive the direction vectors of the artificial h@xmath0 images . for the model case we can simply use the chromospheric model field to specify the direction vectors @xmath25 and @xmath26 , which contain only information regarding the direction of the horizontal components of the magnetic field ( including a @xmath55 ambiguity , but no information about the magnetic field strength . for real data",
    "this information can be derived from high - resolution h@xmath0 images using feature recognition techniques , _",
    "e.g. _ the ridge detector of .",
    ", right panel : @xmath56 ) with the model chromosphere in dependence of the preprocessing parameters @xmath57 and @xmath58 .",
    "we found a maximum correlation at @xmath59 and @xmath60.,width=529 ]    we tested more than @xmath61 possible combinations of @xmath62 and @xmath63 using the model - photospheric field as input , and computed the pearson correlation coefficient between the preprocessed results and the model - chromospheric field . only @xmath64 and @xmath56",
    "were used in computing the correlation coefficient , because the correlation of the longitudinal ( _ i.e. _ , the line - of - sight ) component is in general higher than that of the transverse components , due to @xmath65 not being affected by the ambiguity - problem and the noise being much lower than in the other directions .",
    "we computed @xmath66 combinations of @xmath67 between @xmath68 with a step size of @xmath69 . hereafter a local maximum around @xmath70 appeared .",
    "this region was analyzed in more detail by using these two values as new initial guess .",
    "to do this , we tried another @xmath66 combinations around this pair with a reduced step size of @xmath71 in the positive as well as the negative direction .",
    "then the absolute maximum of the correlation coefficients for both , @xmath72 and @xmath73 appeared at @xmath74 ( see figure  [ corr34 ] ) .",
    "the bottom panel of figure [ magnetograms1 ] shows the corresponding preprocessed photospheric magnetic field .",
    "fibrils identified from the model chromosphere . the fibrils give us information about the transverse components ( @xmath64 and @xmath56 ) of the chromospheric magnetic field .",
    "the fibrils contain a @xmath75 ambiguity and do not provide any information about the chromospheric magnetic field strength .",
    "the bottom panels show from left to right the different weighting functions @xmath76 , respectively .",
    "regions where @xmath37 is higher are more important is the @xmath38-preprocessing - term ( [ defl5 ] ) which controls the influence of the h@xmath0-fibrils.,width=529 ]    in the following we aim to find suitable parameters for including information from h@xmath0 images into the preprocessing .",
    "our main aim is to investigate the effects of additional chromospheric information . to exclude side effects we therefore keep the combination of @xmath44-@xmath58 found in the previous section to be able to clearly investigate the effect of the additional term @xmath38 . in principle",
    "one could vary all @xmath18 simultaneously .",
    "we can not exclude that there might exist a better combination of @xmath44 to @xmath77 with better agreement of our preprocessed field and the model chromospheric field .",
    "this is , however , not the aim of this work , because this is not a suitable way to deal with real data , because there is no model chromosphere to test the result .",
    "it is not possible to provide an optimal parameter set suitable for all vector magnetographs .",
    "the optimal combination has to be carried out for different instruments separately .",
    "we expect that an optimal parameter set for a certain instrument and particular region will be also useful for the preprocessing of other regions of the same kind ( say active regions ) observed with the same instrument .",
    "we test our methods with `` model fibrils '' extracted from the model chromosphere shown in the top panel of figure [ fig_halpha ] .",
    "we define @xmath78 used in equation ( [ defl5 ] ) as one of the following :    1 .",
    "we assume that at every point of our h@xmath0 image gives us the exact orientation of the magnetic field ( which is indeed the case , as we calculated it from the chromospheric model data ) and fix our weighting with @xmath79 .",
    "we assume that the photospheric magnetic field magnitude gives us the importance of the h@xmath0 information at each point and use + + @xmath80 .",
    "+ we scale @xmath81 to a maximum value of @xmath82 .",
    "( see figure [ fig_halpha ] bottom left panel . )",
    "we do as in the previous case , but assume now , that only points in the magnetogram where the field magnitude is greater than 50 % of the maximum contribute to the h@xmath0 preprocessing .",
    "so , we define + @xmath83 + ( see figure [ fig_halpha ] bottom center panel . )",
    "4 .   in our last case",
    "we assume in the same way as in the previous one , but now only points in the magnetogram where the field magnitude is greater than 10 % of the maximum contribute to the preprocessing .",
    "all these grid points are weighted with @xmath82 and the rest with zero .",
    "in other words , one defines + @xmath84 + ( see figure [ fig_halpha ] bottom right panel . )",
    "we now figure out the optimal value of @xmath77 in equation ( [ deflprep ] ) for the four different weighting functions @xmath85 .",
    "initially , we use a step size of @xmath86 and then , around the first appearing maximum , we reduced it to @xmath87 .",
    "this is to find a more precise optimal value of @xmath77 .",
    "we calculate the pearson correlation coefficient between the chromospheric reference field ( @xmath51 ) and the minimum solution of the preprocessing routine ( @xmath88 ) .",
    "this provides us the optimal values of @xmath77 for the different weighting functions , see second row in table [ tab : testparms2 ] .",
    "preprocessing with different weighting functions .",
    "top : @xmath89 , center : @xmath81 , bottom : @xmath90 , see text.,width=529 ]     and the h@xmath0-preprocessed fields as shown in figure [ magnetograms2].,width=529 ]    table [ tab : testparms2 ] lists some metrics related to the various preprocessing schemes , including the dimensionless numbers @xmath91 and @xmath92 from equations ( [ eps_force ] ) and ( [ eps_torque ] ) , the values of the various @xmath17 from section [ sec : preprocessing ] , and the averaged angles between the preprocessing results and the model - chromospheric field .",
    "the first three rows of the table list the model chromosphere ( @xmath93 ) and photosphere ( @xmath94 ) data and the classical preprocessing scheme ( @xmath95 ) .",
    "when using the unprocessed model - photospheric data ( @xmath94 ) , it is clear that the force - free consistency criteria ( as represented by @xmath96 , @xmath97 , and @xmath98 ) are not fulfilled and are orders of magnitude higher than for the chromospheric data ( @xmath93 ) .",
    "consequently , we can not expect the extrapolation codes to result in a meaningful nonlinear force - free field in the corona , as discussed in metcalf _",
    "( 2007 ) .",
    "the remaining rows in tables [ tab : testparms2 ] and [ tab : extraparms ] list the results for the cases where the h@xmath0 preprocessing was used .",
    "a qualitative comparison of the h@xmath0-preprocessed magnetograms ( shown in figure [ magnetograms2 ] ) with the model chromosphere ( shown in the top panel of figure [ magnetograms1 ] ) indicates a strong resemblance for all three magnetic field components , but certainly not a perfect match .",
    "difference images between the h@xmath0-preprocessed magnetograms and the model chromosphere ( shown in the top panel of figure [ magnetograms1 ] ) are present in figure [ magnetograms2a ] .",
    "the resemblance using the h@xmath0 preprocessing scheme is much improved when compared to the magnetograms resulting from the classical preprocessing scheme .",
    "table [ tab : extraparms ] displays metrics of the resulting nonlinear force - free extrapolations using each preprocessing scheme.[multiblock footnote omitted ] as expected , the extrapolation codes perform poorly when the unprocessed boundary ( @xmath94 ) is used .",
    "in particular , the resulting magnetic energy @xmath99 of this case ( normalized to the energy of the reference solution ) is only 65% of the correct answer , making it almost impossible to estimate the free magnetic energy in the solution available for release during eruptive processes such as flares and coronal mass ejections .",
    "taking preprocessing into account ( rows 3 - 7 in both tables ) significantly improves the result .",
    "the force - free consistency criteria ( @xmath100 ) are adequately fulfilled for all preprocessed cases and are even better ( lower values ) than the model chromospheric field .",
    "this is naturally , however , because the preprocessing routine has been developed in particular to derive force - free - consistent boundary conditions from inconsistent ( forced , noisy ) photospheric measurements .",
    "the classical preprocessing @xmath101 has already reduced the angle to the model h@xmath0 fibrils ( last two columns of table [ tab : testparms2 ] ) by almost a factor of two , even though no information about the chromosphere has been used .",
    "if we include chromospheric information , ( see figure [ fig_halpha ] ) in our preprocessing routine ( @xmath102 , rows 4 - 7 ) the angle of the preprocessed field with the h@xmath0 images reduces significantly . the second to last row in table [ tab : testparms2 ] contains the average angle and in the last column the angle has been weighted by the magnetic field , which means that @xmath103 measures mainly how well the magnetic field and the chromospheric fibrils are aligned in regions of a high magnetic field strength . for the purpose of coronal magnetic field extrapolations the strong field regions are essential .",
    "if we include all information from the h@xmath0 image , as done in row 4 for @xmath89 we find that the magnetic field and the fibrils are almost parallel in the entire region .",
    "this is the ideal case , however , as fibrils have been identified all over the region with the same excellent accuracy .",
    "for observed data it is more likely that the direction of the fibrils will be identifiable with high accuracy only in bright and magnetically strong regions .",
    "this effect is taken into account in rows 5 - 7 of both tables . in the last two rows we take the chromospheric data only into account where the magnetic field strength is larger than @xmath104 and @xmath105 of the maximum field strength , respectively .",
    "naturally , the average angle @xmath106 of the chromospheric fibrils with the preprocessed magnetic field becomes larger than for the ideal case .",
    "we find , however , that the angle @xmath107 remains relatively low in strong field regions , except for the case @xmath90 .",
    "we can easily understand that @xmath90 ( chromospheric information ignored where the magnetic field is less than @xmath108 of its maximum ) provides less accurate results , because the area where chromospheric data have been taken into account , is only a very small fraction of the entire region ( see figure [ fig_halpha ] lower central panel ) .",
    "case @xmath90 has few nonzero points .",
    "these points are , however , in the regions with the strongest magnetic field strength .",
    "the @xmath38 terms minimizes the angle between magnetic field and chromospheric fibrils only in these nonzero points .",
    "this local correction does , however , influence the magnetogram globally , because the @xmath109 and @xmath110 term contain global measures and the @xmath111 terms couples neighbouring points . as a consequence",
    "the preprocessing result is different from classical preprocessing , even if the @xmath38 term is nonzero only for a limited number of pixel .    for observational data",
    "the weighting @xmath112 ( last row in the tables , areas with less than @xmath105 ignored ; see also [ fig_halpha ] lower right panel ) seems to be more realistic . in this case",
    "the overall average angle is not better than for classical preprocessing , but is different by only about @xmath113 when preferential weighting is given to the more important strong field regions .",
    "the ultimate test regarding the success of our extended preprocessing scheme is to use the preprocessed field as boundary conditions for a nonlinear force - free coronal magnetic field extrapolation .",
    "the results are presented in table [ tab : extraparms ] , row 3 for classical preprocessing and rows 4 - 7 for h@xmath0 preprocessing .",
    "we find that all preprocessed fields provide much better results than using the unprocessed data . for classical preprocessing",
    "we get the magnetic energy @xmath99 correct with an error of @xmath114 ( for unprocessed data we got an error of @xmath115 ) . taking the h@xmath0 information into account",
    "improves the result and the magnetic energy is computed with an accuracy of @xmath116 or better , even for the cases where we used chromospheric information only in parts of the entire regions .",
    ".results of the various preprocessing schemes : the model chromosphere and photosphere ( first two rows ) , classical preprocessing ( third row ) , and the h@xmath0 preprocessing cases ( last four rows ) .",
    "column 1 identifies the data set , columns 2 and 3 the value of @xmath77 and the weighting scheme used for the h@xmath0 preprocessing cases .",
    "columns 4 - 7 provide the value of the functionals @xmath117 , @xmath118 as defined in equations ( [ defl_1])-([defl_4 ] ) and ( [ defl5 ] ) , respectively . in columns 8 and 9",
    "we show how well the force - free and torque - free consistency criteria ( @xmath119 ) as defined in equations ( [ eps_force ] ) and ( [ eps_torque ] ) are fulfilled .",
    "the last two columns contain the averaged angle ( @xmath120 ) of the field with the model chromospheric data and a magnetic field weighted average angle ( @xmath121 ) with @xmath122 as defined in equation ( [ angle_phi ] ) .",
    "[ cols=\"^,^,^,^,^,^,^,^,^ , > , > \" , ]",
    "within this work we developed an improved algorithm for the preprocessing of photospheric vector magnetograms for the purpose of getting suitable boundary conditions for nonlinear force - free extrapolations .",
    "we extended the preprocessing routine developed by , which is referred to here as `` classical preprocessing '' .",
    "the main motivation for this work is related to the fact that active - region coronal magnetic fields are force - free due to the low @xmath1 coronal plasma , but the magnetic field vector can be measured with high accuracy only on the photosphere , where the plasma @xmath1 is about unity and non - magnetic forces can not be ignored .",
    "our original ( `` classical '' ) preprocessing removes these non - magnetic forces and makes the field compatible with the force - free assumption leading to more chromospheric - like configurations . in this study",
    ", we have found that by taking direct chromospheric observations into account ( such as by using fibrils seen in h@xmath0 images ) , the preprocessing is improved beyond the classical scheme .",
    "this improved scheme includes a term which minimizes the angle between the preprocessed magnetic field and the fibrils .",
    "we tested our method with the help of a model active region developed by van ballegooijen _",
    "( 2007 ) , which includes the forced photospheric and force - free chromospheric and coronal layers .",
    "this model has been used by metcalf _",
    "( 2007 ) for an inter - comparison of nonlinear force - free extrapolation codes .",
    "the comparison revealed that the model coronal magnetic field was reconstructed very well if chromospheric magnetic fields have been used as input , but in contrast the reconstructed fields compared poorly when unprocessed model - photospheric data were used .",
    "classical preprocessing significantly improves the result , but the h@xmath0 preprocessing developed in this paper is even better as the main features of the model corona are reconstructed with high accuracy .",
    "our extended preprocessing tool provides a fair estimate of the chromospheric magnetic field , which is used as boundary condition for computing the nonlinear force - free coronal magnetic field .",
    "in particular , the magnetic energy in the force - free domain above the chromosphere agrees with the model corona within @xmath116 , even if only strong - field regions of the model chromosphere , where the fibrils can be identified with highest accuracy , influence the final solution . from these tests",
    "we conclude that our improved preprocessing routine is a useful tool for providing suitable boundary conditions for the computation of coronal magnetic fields from measured photospheric vector magnetograms as provided for example from _",
    "the combination of preprocessing and nonlinear force - free field extrapolations seem likely to provide accurate computation of the magnetic field in the corona .",
    "we will still not get the magnetic field structure in the relative thin layer between / in the photosphere and the chromosphere correct , because here non - magnetic forces can not be neglected due to the finite @xmath1 plasma .",
    "although this layer is vertically thin ( _ e.g. _ , 2 vertical grid points in the van ballegooijen _ et al . _ ( 2007 ) model compared to 256 vertical grid points in the corona ) it contains a significant part of the total magnetic energy of the entire domain , see metcalf _ et al . _",
    "( 2007 ) . unfortunately",
    ", this part of the energy can not be recovered by force - free extrapolations , because the region is non - force - free .",
    "our improved preprocessing routine includes chromospheric information and therefore provides us with a closer approximation of the chromospheric magnetic field .",
    "this leads to more accurate estimates of the total magnetic energy in the corona",
    ".    a further improvement of the preprocessing routine could be done with the help of additional observations , _",
    "e.g. _ the line - of - sight chromospheric field , as planned for solis .",
    "one could include these measurement directly in the @xmath123-term ( [ defl_3 ] ) either as the only information or in some weighted combination with the photospheric field measurement .",
    "an investigation of the true 3d - structure of the thin non - force - free layer between photosphere and chromosphere requires further research .",
    "first steps towards non - force - free magnetohydrostatic extrapolation codes @xcite might help to reveal the secrets of this layer .",
    "non force - free magnetic field extrapolations will require additional observational constraints , because the magnetic field , the plasma density and pressure must be computed self - consistently in one model .    the work of t. wiegelmann was supported by dlr - grant 50 oc 0501 and j.k .",
    "thalmann got financial support by dfg - grant wi 3211/1 - 1 .",
    "m. derosa , t. metcalf , and c. schrijver were supported by lockheed martin independent research funds .",
    "we acknowledge stimulating discussions during the fourth nlfff - consortium meeting in june , 2007 in paris .",
    "we briefly summarize our nonlinear force - free extrapolation code here , which has been used to compute the 3d magnetic fields .",
    "we solve the force - free equations ( [ divb ] ) and ( [ jxb ] ) by optimizing ( minimizing ) the following functional :    @xmath124 \\ ; d^3x \\label{defl1},\\ ] ]    where @xmath125 and @xmath126 are weighting functions .",
    "it is obvious that ( for @xmath127 ) the force - free equations ( [ divb ] ) and ( [ jxb ] ) are fulfilled when @xmath128 is zero .",
    "the optimization method was proposed by wheatland , sturrock , and roumeliotis ( 2000 ) and further developed in wiegelmann and neukirch ( 2003 ) .",
    "here we use the implementation of wiegelmann ( 2004 ) which has been applied to data in wiegelmann et al .",
    "( 2005 ) . in this article",
    ", we used a recent update including of our code that included a multi - scale approach ( see metcalf et al .",
    "( 2007 ) for details ) .",
    "this version of the optimization code was also used with the ( same as in this paper ) model - chromospheric , photospheric and classical preprocessed photospheric magnetic field vector as part of an inter - code - comparison in @xcite . for alternative methods to solve the force - free equations ( [ divb ] ) and ( [ jxb ] )",
    "see the review papers by @xcite and references therein .",
    "in order to quantify the degree of agreement between the extrapolated vector fields of the input model field ( * b * , _ i.e. _ , the extrapolated chromospheric ( reference ) field ) and the nonlinear force - free solutions ( * b * , _ i.e. _ , the extrapolated preprocessed photospheric field ) that are specified on identical sets of grid points , we use five metrics in table [ tab : extraparms ] that compare either local characteristics or the global energy content in addition to the force and divergence integrals .",
    "these measures have been developed in schrijver et al .",
    "( 2006 ) and subsequently been used to evaluate the quality of force - free and non - force - free extrapolation codes @xcite .              where @xmath140 is the total number of vectors in the volume , and @xmath141 the angle between * b * and * b * at point @xmath132 .",
    "it is entirely a measure of the angular differences of the vector fields , i.  e.  @xmath142 if * b * @xmath143 * b * , @xmath144 if they are anti - parallel , and @xmath134 if @xmath135 at each point .            unlike the first two metrics , perfect agreement of the two vector fields results in @xmath147 . for an easier comparison with the others",
    ", we list @xmath148 , so that all measures reach unity for a perfect match ."
  ],
  "abstract_text": [
    "<S> the solar magnetic field is key to understanding the physical processes in the solar atmosphere . </S>",
    "<S> nonlinear force - free codes have been shown to be useful in extrapolating the coronal field upward from underlying vector boundary data . </S>",
    "<S> however , we can only measure the magnetic field vector routinely with high accuracy in the photosphere , and unfortunately these data do not fulfill the force - free condition . </S>",
    "<S> we must therefore apply some transformations to these data before nonlinear force - free extrapolation codes can be self - consistently applied . to this end , we have developed a minimization procedure that yields a more chromosphere - like field , using the measured photospheric field vectors as input . </S>",
    "<S> the procedure includes force - free consistency integrals , spatial smoothing , and  newly included in the version presented here  an improved match to the field direction as inferred from fibrils as can be observed in , _ </S>",
    "<S> e.g. _ , chromospheric h@xmath0 images . </S>",
    "<S> we test the procedure using a model active - region field that included buoyancy forces at the photospheric level . </S>",
    "<S> the proposed preprocessing method allows us to approximate the chromospheric vector field to within a few degrees and the free energy in the coronal field to within one percent . </S>"
  ]
}