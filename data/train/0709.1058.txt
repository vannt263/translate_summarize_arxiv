{
  "article_text": [
    "great advances have been made recently both in experimental techniques for studying the cosmic microwave background ( cmb ) and in the measurements themselves .",
    "the angular power spectrum of temperature fluctuations has been characterized over more than three decades in angular scale @xcite , and even the e - mode polarization spectrum has now been measured to some precision @xcite . in the coming years",
    ", even greater improvements in sensitivity are expected , with the planck nearing completion .",
    "as the sensitivity of cmb experiments improves , the requirements on the control and characterization of systematic effects also increase .",
    "it is of critical importance to propagate properly the uncertainties caused by such effects through to the cmb power spectrum and cosmological parameters , in order not to underestimate the final uncertainties , and thereby draw incorrect cosmological conclusions .",
    "a prime example of such systematic effects is non - cosmological foregrounds in the form of galactic and extra - galactic emission . with an amplitude rivaling that of the temperature signal over a significant fraction of the sky and completely dominating the polarization signal over most of the sky , the diffuse signal from our own galaxy must be separated accurately from the cmb signal in order not to bias the cosmological conclusions .",
    "further , the uncertainties in the separation process must be propagated through to the errors on the cmb power spectrum and cosmological parameters .",
    "these problems have been discussed extensively in the literature , and many different approaches to both power spectrum analysis and component separation have been proposed .",
    "two popular classes of power spectrum estimation methods are the pseudo-@xmath1 estimators ( e.g. , * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "* ) and maximum - likelihood methods ( e.g. , * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "for a review and comparison of these methods , see @xcite .",
    "examples of component separation methods are the maximum entropy method @xcite , the internal linear combination method @xcite , wiener filtering @xcite , the independent component analysis method @xcite , and direct likelihood estimation @xcite .",
    "the final step in a modern cosmological analysis pipeline is typically to estimate a small set of parameters for some cosmological model , which in practice is done by mapping out the parameter posteriors ( or likelihoods ) using an mcmc code ( e.g. , cosmomc ; lewis and bridle 2002 ) .",
    "to do so , one must establish an expression for the likelihood @xmath2 , where @xmath3 is a theoretical cmb power spectrum and @xmath4 are the observed data .",
    "it is therefore essential that the methods used in the base analysis pipeline ( e.g. , map making , component separation , power spectrum estimation ) allow one to estimate this function both accurately and efficiently .",
    "a particularly appealing framework for this task is the cmb gibbs sampler , pioneered by @xcite and @xcite .",
    "while a brute - force cmb likelihood evaluation code must invert a dense signal - plus - noise covariance matrix , @xmath5 , at a computational cost of @xmath6 , @xmath7 being the number of pixels in the data set , the gibbs sampler only requires the signal and noise covariance matrices separately .",
    "consequently , the algorithmic scaling is dramatically reduced , typically to either @xmath8 or @xmath9 for data with white or correlated noise , respectively .",
    "in addition to being a highly efficient cmb likelihood evaluator in its own right , as demonstrated by several previous analyses of real data @xcite , the gibbs sampler also offers unique capabilities for propagating systematic uncertainties end - to - end . any effect",
    "for which there is a well - defined sampling algorithm , either jointly with or conditionally on other quantities , can be propagated seamlessly through to the final posteriors .",
    "one example of this is beam uncertainties .",
    "given some stochastic description of the beam , for instance a mean harmonic space profile and an associated covariance matrix , one could sample at each step in the markov chain one particular realization from this model and use the resulting beam for the next cmb sampling steps , allowing for a short burn - in period .",
    "the cmb uncertainties will then increase appropriately .",
    "similar approaches could be taken for uncertainties in gain calibration and noise estimation",
    ".    however , rather than simply propagating a particular error term through the system , one often wants to estimate the characteristics of the effect directly from the data . in that case",
    ", a parametric model @xmath10 , @xmath11 being a set of parameters describing the effect , must be postulated .",
    "then , if it is both statistically and computationally feasible to sample from this distribution , the effect may be included in the joint analysis , and all joint posteriors will respond appropriately .    in this paper , we describe how non - cosmological frequency - dependent foreground signals may be included in a gibbs sampler . in this framework",
    "the cmb signal is assumed gaussian and isotropic , while the foregrounds are modeled either in terms of fixed spatial templates ( e.g. , monopoles , dipoles , low / high - frequency observations ) or in terms of a free amplitude and spectral response function at each pixel .",
    "our current code assumes identical angular resolution for all frequency bands , but we outline in  [ sec : conclusions ] how the algorithm may be generalized to handle multi - resolution experiments .    already with the present algorithm , we are able to perform a complete bayesian joint cmb and foreground analysis of current cmb experiments on large angular scales .",
    "for example , in the present paper we demonstrate the algorithm on a realistic simulation corresponding to the 3-yr wmap data . at an angular resolution of @xmath0 fwhm",
    ", we are able to produce the exact likelihood up to @xmath12 - 60 , into the regime where a cruder likelihood description is likely to be acceptable @xcite .",
    "further , in a companion paper @xcite we analyze the real 3-yr wmap data with the same tool , providing for the first time a complete set of physically motivated foreground posterior distributions of the observed microwave sky , together with their impact on cosmological parameters .",
    "the algorithm developed in this paper is a essentially a hybrid of two previous algorithms , namely the cmb gibbs sampler developed by @xcite , @xcite and @xcite , and the foreground mcmc sampler developed by @xcite . in this section ,",
    "we review these algorithms , emphasizing an intuitive and pedagogical introduction to the underlying ideas . in the next section we present the extensions required to make the hybrid code functional .",
    "note that while we discuss temperature measurements only in this paper , the methodology for analyzing polarization measurements is completely analogous .",
    "for example , see @xcite and @xcite for details on polarized power spectrum analysis through gibbs sampling .",
    "we first review the gibbs sampler for cmb temperature measurements .",
    "we choose our first data model to read @xmath13 where @xmath4 are the observed data , @xmath14 is the cmb sky signal , and @xmath15 is instrumental noise .",
    "complications such as multi - frequency observations and beam convolution will be introduced at a later stage .",
    "we assume both the cmb signal and noise to be gaussian random fields with vanishing mean and covariance matrices @xmath16 and @xmath17 , respectively . in harmonic space , where @xmath18 , the cmb covariance matrix is given by @xmath19 , @xmath3 being the angular power spectrum .",
    "the noise matrix @xmath17 is left unspecified for now , but we note that for white noise it is diagonal in pixel space , @xmath20 , for pixels @xmath21 and @xmath22 and noise variance @xmath23 .      in principle , we could map out this distribution over a grid in @xmath14 and @xmath1 , and the task would be done . unfortunately , since the number of grid points required for such an analysis scales exponentially with the number of free parameters , this approach is not feasible .    a potentially much more efficient approach is to map out the distribution by sampling .",
    "however , direct sampling from the joint distribution in equation [ eq : cmb_posterior ] is difficult even from an algorithmic point of view alone ; we are not aware of any textbook approach for this . and even if there were , it would most likely involve inverses of the joint @xmath29 covariance matrix , with a prohibitive @xmath30 scaling , in order to transform to the eigenspace of the system .",
    "this is the situation in which @xcite and @xcite proposed a particular gibbs sampling scheme . for a general introduction to the algorithm ,",
    "see , e.g. , @xcite . in short ,",
    "the theory of gibbs sampling tells us that if we want to sample from the joint density @xmath31 , we can alternately sample from the respective conditional densities as follows , @xmath32 here @xmath33 indicates sampling from the distribution on the right - hand side . after some burn - in period , during which the samples must be discarded , the joint samples @xmath34 will be drawn from the desired density .",
    "thus , the problem is reduced to that of sampling from the two _ conditional _ densities @xmath35 and @xmath36 .",
    "we now describe the sampling algorithms for each of these two conditional distributions , starting with @xmath36 .",
    "first , note that @xmath37 ; if we already know the cmb sky signal , the data themselves tell us nothing new about the cmb power spectrum .",
    "next , since the sky is assumed gaussian and isotropic , the distribution reads @xmath38 which , when interpreted as a function of @xmath1 , is known as the inverse gamma distribution .",
    "fortunately , there exists a simple textbook sampling algorithm for this distribution ( e.g. , * ? ? ? * ) , and we refer the interested reader to the previous papers for details .",
    "the sky signal algorithm is even simpler from a statistical point of view , although more involved to implement .",
    "defining the so - called mean - field map ( or wiener filtered data ) to be @xmath39 , the conditional sky signal distribution may be written as @xmath40 thus , @xmath41 is a gaussian distribution with mean equals to @xmath42 and a covariance matrix equals to @xmath43 .",
    "sampling from this gaussian distribution is straightforward , but computationally somewhat cumbersome .",
    "first , draw two random white noise maps @xmath44 and @xmath45 with zero mean and unit variance . then solve the equation @xmath46 { \\mathbf{s}}= { \\mathbf{n}}^{-1}{\\mathbf{d}}+ { \\mathbf{s}}^{-\\frac{1}{2 } } \\omega_0 + { \\mathbf{n}}^{-\\frac{1}{2 } } \\omega_1 .",
    "\\label{eq : lin_sys}\\ ] ] for @xmath14 .",
    "since the white noise maps have zero mean , one immediately sees that @xmath47 , while a few more calculations show that @xmath48 .    the problematic part about this sampling step is the solution of the linear system in equation [ eq : lin_sys ] . since this a @xmath49 system for current cmb data sets",
    ", it can not be solved by brute force .",
    "instead , one must use a method called conjugate gradients ( cg ) , which only requires multiplication of the coefficient matrix on the left - hand side , not inversion . for details on these computations ,",
    "together with some ideas on preconditioning , see @xcite .      for notational transparency , the discussion in the previous sections",
    "was limited to analysis of a single sky map , and did not include the effect of an instrumental beam .",
    "we now review the full equations for the general case .",
    "see @xcite for full details .",
    "let @xmath50 denote an observed sky map at frequency @xmath51 , @xmath52 its noise covariance matrix , and @xmath53 convolution with the appropriate instrumental beam response .",
    "equation [ eq : lin_sys ] then generalizes to @xmath54 { \\mathbf{s}}= & \\\\ \\sum_{\\nu } { \\mathbf{a}}_{\\nu}^t { \\mathbf{n}}_{\\nu}^{-1}{\\mathbf{d}}_{\\nu } + { \\mathbf{s}}^{-\\frac{1}{2 } } & \\omega_0 + \\sum_{\\nu } { \\mathbf{a}}_{\\nu}^t { \\mathbf{n}}_{\\nu}^{-\\frac{1}{2 } } \\omega_{\\nu}. \\end{split } \\label{eq : lin_sys2}\\ ] ] note that we now draw one white noise map for each frequency band , @xmath55 .",
    "the sampling procedure for @xmath56 is unchanged .",
    "finally , we make two comments regarding numerical stability and computational expense .",
    "first , note that the elements of @xmath14 have a variance equal to the cmb power spectrum , which goes as @xmath57 . to avoid round - off errors over the large dynamic range in the solution , it is numerically advantageous to solve first for @xmath58 in the cg search , and then to solve ( trivially ) for @xmath14 .",
    "the system solved by cg in practice is thus @xmath59 { \\mathbf{x}}&= \\\\ { \\mathbf{s}}^{\\frac{1}{2 } } \\sum_{\\nu } { \\mathbf{a}}_{\\nu}^t { \\mathbf{n}}_{\\nu}^{-1}{\\mathbf{d}}_{\\nu } + \\omega_0 + & { \\mathbf{s}}^{\\frac{1}{2 } } \\sum_{\\nu } { \\mathbf{a}}_{\\nu}^t { \\mathbf{n}}_{\\nu}^{-\\frac{1}{2 } } \\omega_{\\nu}. \\end{split }",
    "\\label{eq : lin_sys3}\\ ] ]    second , solving this equation by cg involves multiplication with expression in the brackets on the left - hand side , and therefore scales as the most expensive operation in the coefficient matrix . for white noise , @xmath60 ,",
    "this is the spherical harmonic transform required between pixel ( for noise covariance matrix multiplication ) and harmonic ( for beam convolution and signal covariance matrix multiplication ) space , with a scaling of @xmath8 . for correlated noise ,",
    "it is the multiplication with a dense @xmath61 inverse noise covariance matrix , with a scaling of @xmath9 .",
    "the previous section described how to sample from the exact cmb posterior @xmath24 by gibbs sampling . in this section ,",
    "we very briefly review the algorithm for sampling general sky signals presented by @xcite .",
    "first we define a parametric frequency model for the total sky signal , @xmath62 , @xmath11 representing the set of all free parameters in the model .",
    "a simple example would be @xmath63 , where @xmath64 is the cmb temperature , @xmath65 is the synchrotron emission amplitude relative to a reference frequency @xmath66 , @xmath67 is the synchrotron spectral index , and @xmath68 is the conversion factor between antenna and thermodynamic temperature for differential measurements .",
    "note that no constraints are imposed on the form of the spectral model in general , beyond the fact that it should contain at most @xmath69 free parameters , @xmath70 being the number of frequency bands of the experiment . in practice",
    ", one should also avoid models that contain nearly degenerate parameters .",
    "our goal is now to compute the posterior distribution @xmath10 for each pixel . for this to be computationally feasible ,",
    "we make two assumptions .",
    "first , we assume that the noise is uncorrelated between pixels , and second , that the instrumental beams are identical between frequency bands .",
    "if so , the data may be analyzed pixel - by - pixel , and the likelihood for a single pixel simply reads @xmath71 the posterior is as usual given by @xmath72 , where @xmath73 is a prior on @xmath11 .",
    "given this likelihood and prior , it is straightforward to sample from @xmath10 , for instance by metropolis - hastings mcmc @xcite , or by inversion sampling as described later in this paper .",
    "the main goal of this paper is to merge the two algorithms described in   [ sec : cmb_sampling ] and [ sec : fg_sampling ] into one joint cmb  foreground sampler , allowing us to estimate the joint posterior @xmath74 . in this paper",
    "we focus on a matched beam response experiment , for which @xmath75 , which is sufficient for low - resolution analysis of high - resolution experiments such as wmap and planck .",
    "we define the joint data model to be @xmath76 the first term on the right - hand side is the cmb sky signal .",
    "the second term is a sum over @xmath77 spatial templates , @xmath78 , each having a free amplitude @xmath79 at each frequency , for example monopole and dipole components .",
    "the third term is a sum over @xmath80 spatial templates , @xmath81 with a fixed frequency scaling @xmath82 and a single overall amplitude @xmath83 , for example the h@xmath84 template ( e.g. , * ? ? ?",
    "* ) coupled to a power law spectrum with free - free spectral index of @xmath85 .",
    "such spatial templates are a way of incorporating constraints on the sky from other measurements .",
    "their value depends on the validity of assumptions about spectra over large frequency ranges ( e.g. , h@xmath84 as a proxy for free - free emission at cmb frequencies ) .",
    "nevertheless , cmb experiments with too few frequencies to constrain foregrounds adequately on their own require such templates to provide additional constraints .",
    "both @xmath78 and @xmath86 are assumed to be convolved to the appropriate angular resolution of the experiment .    the fourth term , the most important novel feature of this paper , is a sum over @xmath87 foreground components each given by an overall amplitude @xmath88 and a frequency spectrum @xmath89 at each pixel @xmath90 .",
    "the spectral parameters @xmath91 may or may not be allowed to vary from pixel to pixel . by allowing independent frequency spectra at every single pixel , the model is very general , and capable of describing virtually any conceivable sky signal .",
    "the fifth and last term , @xmath92 , is instrumental noise .    in the current implementation of our codes , we allow only foreground spectra parametrized by a single spectral index , @xmath93 , where @xmath94 is an arbitrary , but fixed , function of frequency and @xmath66 is a reference frequency .",
    "a typical example is synchrotron emission , which may be modelled accurately over a wide frequency range by a simple power law ( in intensity , flux density , or antenna temperature units ) with a spatially varying spectral index .",
    "the cmb is most naturally described in terms of thermodynamic units , and we adopt this convention in our codes .",
    "the corresponding synchrotron model is therefore @xmath95 , where @xmath68 is the antenna - to - thermodynamic conversion factor .    as in any bayesian analysis",
    ", we must adopt a set of priors for the parameters under consideration .",
    "for this paper , we choose the prior most widely accepted in the statistical community , namely jeffreys ignorance prior ( e.g. , * ? ? ? * ) .",
    "this prior is given by the square root of the fisher information measure , @xmath96 .",
    "its effect is essentially to `` normalize '' the parameter volume relative to the likelihood , and make the likelihood so - called `` data translated '' .",
    "we will return to the effect of this prior in  [ sec : flat_vs_jeffrey ] .",
    "we impose an additional multiplicative prior on spectral parameters , either a top - hat or a gaussian",
    ".    for amplitude - type degrees of freedom , the ignorance prior works out be the usual flat prior , but for non - linear parameters , e.g. , spectral indices , it is non - uniform . in particular , for the power law spectrum parametrized by a spectral index @xmath97 described above , it reads @xmath98 .",
    "the difference between this and a flat prior will be demonstrated in ",
    "[ sec : flat_vs_jeffrey ] .",
    "an important special case is the cmb power spectrum , for which we adopt a uniform prior despite the fact that the corresponding density is non - gaussian .",
    "the main reason for doing so is that most cosmological parameter estimation codes expect the cmb likelihood , rather than the cmb posterior .",
    "having defined our data model and priors , the goal is now to estimate the joint cmb  foreground posterior @xmath99 .",
    "this is achieved through the following straightforward generalization of the previous gibbs sampling scheme , @xmath100 explicitly , all amplitude - type degrees of freedom are sampled jointly with the cmb sky signal using a generalization of equation [ eq : lin_sys ] , while all non - linear spectral parameters are sampled conditionally by inversion sampling , as described in  [ sec : index_sampling ] .",
    "the conditional cmb power spectrum sampling algorithm is unchanged , since it only depends on the cmb sky signal .",
    "we first describe the algorithm for sampling from the conditional amplitude density , @xmath101    [ [ sec : conditional_sampling ] ] conditional sampling of amplitudes + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + +    in principle , we could take further advantage of the gibbs sampling approach , and sample each of @xmath14 , @xmath102 , @xmath83 and @xmath103 conditionally , given all other parameters , including the amplitudes not currently being sampled .",
    "this method was briefly described by @xcite for monopole and dipole sampling , and later used for actual analysis by both @xcite and @xcite .",
    "briefly stated , this approach simply amounts to subtracting each of the signals that is conditioned upon from the data , and using the residual map to sample the remaining parameters in place of the full data set .",
    "its main advantage is highly modularized , simple and transparent computer code .",
    "however , for general applications this is a prohibitively inefficient sampling algorithm due to poor mixing properties and long markov chain correlation lengths .",
    "the problem is due to strong correlations between the various amplitudes .",
    "consider for instance a model including a cmb sky signal , monopole and dipole components , and a foreground template .",
    "note that the latter has both a non - zero monopole and dipole and also smaller - scale structure .",
    "the conditional sampling algorithm would then go as follows : first subtract the current monopole , dipole and foreground components from the data , and sample the cmb sky based on the residual map .",
    "the uncertainties in this conditional distribution are both cosmic variance and instrumental noise .",
    "second , subtract the recently sampled cmb signal and foreground template from the data , and sample the monopole and dipoles of the residual .",
    "the only source of uncertainty in this conditional distribution is instrumental noise alone , and the next sample therefore equals the previous state plus a noise fluctuation . for high signal - to - noise data the instrumental noise uncertainty in a single all - sky number such as the monopole and",
    "dipole amplitude is very small indeed , and the new sample is therefore essentially identical to the previous . finally , subtract the cmb signal and the monopole and dipole from the data , and sample the foreground template amplitude of the new residual .",
    "again , with high signal - to - noise data the new amplitude is virtually identical to the previous .",
    "the failure of this approach stems from the fact that the main uncertainty in the monopole , dipole and template amplitudes is not instrumental noise , but rather cmb cosmic variance coupled from template structures .",
    "this component is not explicitly acknowledged in the conditional template sampling algorithms when conditioning on the cmb signal , but only implicitly through the gibbs sampling chain .",
    "the net result is an extremely long markov chain correlation length .",
    "the reasons this conditional approach worked well in the analyses of @xcite , @xcite and @xcite cases were different , and somewhat fortuitous : only the monopole and dipole components were included in the 1-yr wmap temperature analysis , which couple only weakly to the low-@xmath104 cmb modes with a relatively small sky - cut . no foreground template sampling step as such was included , which would couple strongly to both the monopole , dipole and cmb signals .",
    "for the polarization analysis of @xcite , in which foreground templates were indeed included , a different effect came into play , namely the very low signal - to - noise ratio of the 3-yr wmap polarization data . at this signal - to - noise ,",
    "even conditional sampling works well .",
    "[ [ joint - sampling - of - amplitudes ] ] joint sampling of amplitudes + + + + + + + + + + + + + + + + + + + + + + + + + + + +    the solution to this problem is to sample all amplitude - type degrees of freedom jointly from @xmath105 .",
    "this is a four - component gaussian distribution with mean @xmath106 and covariance matrix @xmath107 .",
    "the required sampling algorithm is therefore fully analogous to that described in ",
    "[ sec : cond_samp_algorithms ] for the cmb sky signal .",
    "the remaining task is to generalize the expressions for @xmath106 and @xmath107 .    to keep the notation tractable ,",
    "we first define a symbolic four - element block vector of all amplitude coefficients , @xmath108 .",
    "the first block of @xmath109 contains the harmonic coefficients of @xmath14 , the second block contains @xmath79 for all frequencies and templates , the third contains @xmath83 for all templates with a fixed spectrum , and the fourth contains the pixel amplitudes @xmath103 for all pixel - by - pixel foreground components . in total",
    ", @xmath109 is an @xmath110-element vector .",
    "we also define a corresponding response vector @xmath111 , such that the data model in equation [ eq : model ] may be abbreviated to @xmath112 .    with this notation , the joint amplitude distribution reads @xmath113 here we have implicitly defined the symbolic @xmath114 inverse covariance block matrix @xmath115 \\label{eq : coupling_matrix}\\ ] ] ( see appendix [ app : coupling_matrix ] for explicit definitions of each element in this matrix ) and a corresponding four - element symbolic block vector for the wiener - filter mean , @xmath116 .",
    "\\label{eq : joint_mean}\\ ] ]    the sampling algorithm for this joint distribution is now fully analogous to the one described in  [ sec : cond_samp_algorithms ] by equation [ eq : lin_sys2 ] : 1 ) draw @xmath117 white noise maps with zero mean and unit variance ; 2 ) form the wiener filter mean plus random fluctuation right - hand side vector , @xmath118;\\ ] ] and 3 ) solve the set of linear equations , @xmath119 the solution vector @xmath120 then has the required mean @xmath121 and covariance matrix @xmath107 .",
    "again , for numerical stability it is useful to multiply both sides of equation [ eq : gen_lin_sys ] by the block - diagonal matrix @xmath122 , and solve for @xmath123 by cg .    to demonstrate the difference in mixing efficiency between conditional and joint amplitude sampling , figure[fig : joint_vs_conditional ] shows two trace plots for a high signal - to - noise simulation that included a cmb , a monopole , and a foreground template component .",
    "while the joint sampler instantaneously moves into the right regime , and subsequently efficiently explores the correct distribution , the conditional sampler converges only very slowly toward the correct value .",
    "the associated long markov chain correlation length makes this approach unfeasible for general problems .",
    "[ [ sec : preconditioning ] ] preconditioning + + + + + + + + + + + + + + +    the performance of the cg algorithm ( see @xcite for an outstanding introduction to this method ) depends sensitively on the condition number of the coefficient matrix @xmath107 , i.e. , the ratio of the largest to the smallest eigenvalue .",
    "in fact , the algorithm is not guaranteed to converge at all for poorly conditioned matrices , due to increasing round - off errors in cases that require many iterations .",
    "the condition number of the regularized @xmath107 matrix is essentially the largest signal - to - noise ratio of any component in the system , which in practice means that of the cmb quadrupole or the template amplitudes . for current and future cmb experiments , such as wmap and planck ,",
    "the integrated signal - to - noise of these large - scale modes is very large .",
    "it is therefore absolutely essential to construct an efficient preconditioner , @xmath124 , to decouple these modes brute - force , @xmath125 , simply in order to achieve basic convergence .    for the @xmath114 coupled system described above ,",
    "we adopt a three - stage preconditioner .",
    "first , for the low-@xmath104 cmb components we explicitly compute all elements of @xmath107 up to some @xmath12670 @xcite . this low-@xmath104 block",
    "is then coupled to the template amplitudes in a symbolic @xmath127 preconditioner , @xmath128 .",
    "\\label{eq : preconditioner}\\ ] ] the elements in this matrix are computed by transforming each object individually into spherical harmonic space , including modes only up to @xmath129 , and then performing the sums explicitly .",
    "( note that the seemingly intuitive proposition of computing the template elements in pixel space , as opposed to in harmonic space , is flawed ; unless all elements are properly bandwidth limited , a non - positive definite preconditioning matrix will result . ) for examples of such computations , see @xcite .",
    "the second part of our preconditioner regularizes the high-@xmath104 cmb components , and consists of the diagonal elements @xmath130 from @xmath131 to @xmath132 @xcite .",
    "the third part of our preconditioner covers the single pixel - pixel foreground amplitudes , which have low signal - to - noise ratio , and are preconditioned with the corresponding diagonal elements of @xmath107 only , @xmath133 .    for a typical low - resolution wmap3 application ( five frequency channels degraded to @xmath134 and @xmath0 fwhm resolution and regularized with @xmath135 rms white noise ) , we find that including only the diagonal elements in the above matrix can bring the fractional cg residual down to @xmath136 , while the recommended convergence criterion for single - precision data is @xmath137 .",
    "thus , including the cmb - template cross - terms in the low-@xmath104 cmb preconditioner in equation [ eq : preconditioner ] is not just a question of performance for the signal - to - noise levels of wmap ; it is required in order to converge at all .",
    "the total number of cg iterations is typically @xmath138 for the same application with the previously described three - level preconditioner .",
    "for some further promising ideas on preconditioning for similar systems , see @xcite .",
    "[ [ sec : constraints ] ] imposing linear constraints + + + + + + + + + + + + + + + + + + + + + + + + + + +    a useful addition to the above formalism is the possibility of imposing linear constraints on one or more of the parameters .",
    "for instance , if it is possible to calibrate the absolute offset of one frequency band by external information , for instance using knowledge about the instrument itself , it would be highly beneficial to fix the corresponding monopole value accordingly .",
    "another constraint may be to exclude template amplitude combinations with a given frequency spectrum , in order to disentangle arbitrary offsets at each frequency from the absolute zero - level of a given foreground component .    in the present code",
    ", we have implemented an option for imposing linear constraints on the template amplitudes @xmath139 on the form @xmath140 where @xmath141 , @xmath142 , are constant orthogonality vectors , and @xmath143 is the number of simultaneous linear constraints . for example , if we want to obtain a solution with a fixed monopole amplitude at frequency @xmath66 , we would set @xmath144 .",
    "the total dimension of the template amplitude vector space is @xmath145 , @xmath77 being the number of free templates at each band . within this space ,",
    "the constraint vectors @xmath146 span an @xmath143-dimensional sub - space @xmath147 to which the cg solution must be orthogonal ; @xmath148 must lie in the complement of @xmath147 , denoted @xmath149 .    to achieve this",
    ", we construct a projection operator @xmath150 by standard gram - schmidt orthogonalization , which is a @xmath151-dimensional matrix @xmath152 . to impose the constraints defined by equation [ eq : constraints ] on the the final cg solution , equation [ eq : gen_lin_sys ]",
    "is rewritten as @xmath153 which is solved as before .",
    "corresponding elements in the preconditioner are similarly modified in order to maintain computational efficiency .      with the amplitude sampling equations for @xmath154 in hand ,",
    "the only missing piece in the gibbs sampling scheme defined by equations [ eq : amplitude_sampler][eq : spectrum_sampler ] , is a spectral parameter sampler for @xmath155 . in the fgfit code presented by @xcite ,",
    "this task was done by metropolis - hastings mcmc , a very general technique that can sample from almost any multi - variate distribution .",
    "however , it has two disadvantages .",
    "first , hundreds of mcmc steps may be required to generate two uncorrelated samples , making the process quite expensive .",
    "second , and even worse for our application , the chains may need to `` burn in '' at each main gibbs iteration , because the amplitude parameters have changed since the last iteration .",
    "proper monitoring of these issues is difficult for problems with tens of thousands of pixels with very different signal - to - noise ratios .",
    "therefore , we have replaced the mcmc sampler with a direct sampler , specifically a standard inversion sampler , in the present version of our codes .",
    "while this algorithm is only applicable for univariate problems , it is also quite possibly the best such sampler , as it draws from the exact distribution , and no computation of acceptance probabilities is needed .",
    "the algorithm is the following : first , compute the conditional probability density @xmath156 , where @xmath157 is the currently sampled parameter and @xmath11 denotes the set of all other parameters in the model . in our application , @xmath156 is the normalized product of the likelihood @xmath158 in equation [ eq : chisq ] and any prior we wish to impose . then compute the corresponding cumulative probability distribution , @xmath159",
    "next , draw a random number @xmath160 from the uniform distribution @xmath161 $ ] . the desired sample from @xmath156 is given by @xmath162 .    for multivariate problems we use a gibbs sampling scheme to draw from the joint distribution , and sample each parameter conditionally . for example",
    ", if we want to allow free amplitudes ( @xmath163 and @xmath164 ) and spectral indices ( @xmath67 and @xmath165 ) for both synchrotron and thermal dust emission , the full sampling scheme reads @xmath166 note that it can be beneficial to iterate the latter two equations more than once in each main gibbs loop , in order to reduce the correlations between consequtive samples cheaply . typically , with two moderately correlated spectral indices we run @xmath167 spectral index iterations for each main gibbs iteration .",
    "while this approach results in quite acceptable mixing properties for reasonably uncorrelated parameters ( e.g. , synchrotron and dust spectral indices ) , other and more efficient methods may be required for more complicated problems .",
    "viable alternatives for such situations are , e.g. , rejection sampling or even standard metropolis - hastings mcmc with proper burn - in monitoring .",
    "the details of the particular sampling algorithm are of little importance as long as it can be proved that the method produces samples from the correct conditional distribution .",
    "the algorithm described in  [ sec : hybrid_sampling ] provides samples from the full joint posterior @xmath168 . from these multivariate samples we estimate each parameter individually by marginalizing over all other parameters in the system and reporting ,",
    "say , the marginal posterior mean and standard deviation .",
    "this is straightforward , but there are subtleties and care is required . before applying the method to simulated data in  [ sec : verification ] and [ sec : simulations ] , therefore , we discuss marginalization , priors , degeneracies , and high - dimensional probability distributions .",
    "much of the following deals with the degeneracy between unknown offsets ( or monopoles ) at each band and the overall zero - level of a foreground component with a free amplitude at each pixel .",
    "the same observations apply to any full - sky template with a free amplitude at each band ( e.g. , the three dipoles ) . for simplicity",
    "we discuss only offsets below . for the same reason , we neglect the antenna - to - thermodynamic temperature conversion factor . when explicit formulae are derived , the simplified and more readable versions are given in the text ; full expressions are given in appendices [ sec : jeffreys_prior ] and [ sec : full_constraint ] .",
    "it turns out that the degeneracy between unknown offsets and the foreground zero - level has almost no effect on the cmb component . for the cmb ,",
    "the relevant quantity is the sum over all foregrounds , not internal degeneracies among different foregrounds .",
    "if one cares only about separating the cmb from foregrounds , and not the foregrounds themselves , much of the following can be ignored .",
    "consider a hypothetical experiment that observes a single pixel at 30 , 44 , 70 , and 100ghz , with rms noise 10@xmath169 in each band .",
    "assume that the signal is a straight power - law parametrized by amplitude @xmath170 and spectral index @xmath97 , and that the absolute offset of the detectors is known perfectly for the three highest frequencies , but not for the 30ghz band .",
    "the signal model is @xmath171 there are three free parameters in this system , the offset , amplitude , and spectral index , and four measurements . since the number of constraints exceeds the number of degrees of freedom , it should be possible to estimate all three parameters individually .",
    "we simulated one realization of this model , adopting the model parameters @xmath172 , @xmath173 and @xmath174 , and adding white noise to each band .",
    "our priors are chosen to be uniform over @xmath175 and @xmath176 .",
    "we compute the joint posterior by a simple @xmath177 evaluation over a @xmath178 grid , and marginalize by direct integration .",
    "figure  [ fig : degenerate_case1 ] shows the results in terms of one- and two - dimensional marginal posteriors .",
    "the true input values are marked by thick crosses in the top panels and by dashed lines in the bottom panels .",
    "the posterior means are shown by dotted lines in the bottom panels .",
    "this simple example highlights two problems that will recur in later sections .",
    "first , as the top left panel shows , the offset and amplitude are highly degenerate and anti - correlated ; one may add an arbitrary offset to the 30ghz band and subtract it from the foreground amplitude , without affecting the final @xmath177 .",
    "this degeneracy is a crucial issue for cmb component separation .",
    "many foregrounds have power - law spectra , and differential anisotropy experiments ( e.g. , wmap ) can not determine absolute offsets .",
    "the monopoles of the wmap temperature sky maps were determined _ a posteriori _ based on a co - secant fit to a crude plane - parallel galaxy model @xcite .",
    "this approach is prone to severe modelling errors , precisely because of this type of degeneracy .",
    "the second problem is that integration over a highly degenerate joint posterior yields complicated and strongly non - gaussian marginal posteriors .",
    "obtaining unbiased point estimates from these posteriors is not trivial .",
    "clearly , the posterior mean is not an unbiased estimator .",
    "further , as we will see in the next section , even the posterior maximum is biased in general , unless special care is taken when choosing priors .",
    "the strong degeneracies found in the previous example can be broken partially by adding more data .",
    "consider a full - sky data set pixelized at healpix resolution @xmath179 ( 3072 independent pixels ) .",
    "reduce the noise to @xmath180 rms per pixel . use the same signal model as before , but with an offset common to all pixels , @xmath181 we adopt the spatially varying synchrotron model of @xcite as a template for the amplitude and spectral index of the signal component    we simulated a new data set , and computed the marginal monopole posterior by direct integration .",
    "this is straightforward because , for a given value of @xmath182 , the conditional amplitude - spectral index posterior reduces to a product of single - pixel distributions .",
    "the integration therefore goes over a sum of @xmath183 two - dimensional grids , rather than a single @xmath184 grid .",
    "the result is shown as a dashed curve in figure [ fig : jeffreys_vs_flat ] .",
    "two points are noteworthy .",
    "first , the marginal distribution is nearly gaussian , in contrast to the strongly non - gaussian single - pixel posterior shown in the bottom panel of figure [ fig : degenerate_case1 ] .",
    "thus , the additional data seem to have broken the degeneracy .",
    "second , however , the distribution has a mean and standard deviation of @xmath185 , more than 4@xmath186 away from zero !",
    "repeated experiments with different noise seeds gave similar results .",
    "this behaviour is a result of the choice of prior .",
    "we initially adopted a uniform prior on the offset , the amplitudes and the spectral indices , with little thought to why we should do so .",
    "this was a poor choice .",
    "@xcite argued that when nothing is known about a particular parameter , one ought to adopt a prior that does not implicitly prefer a given value over another , relative to the likelihood .",
    "this is not in general the uniform prior .",
    "jeffreys argued that the appropriate ignorance prior is given by the square root of the fisher information measure , @xmath187 where the angle brackets indicate an ensemble average .",
    "this prior ensures that no parameter region is preferred based on the parametrization of the likelihood alone ; it is therefore a proper ignorance prior ( e.g. , * ? ? ?",
    "the log - likelihood corresponding to the model defined in equation [ eq : pix_model ] reads @xmath188 computing the second derivatives of this expression with respect to @xmath170 , @xmath182 , and @xmath97 , we find that the appropriate jeffreys priors for the three parameters are @xmath189 respectively . in general , the ignorance prior for any linear parameter in a gaussian model is uniform because the second derivative of the likelihood is constant .",
    "however , for non - linear parameters greater care is warranted .",
    "figure [ fig : prior ] shows jeffreys prior for the spectral index @xmath97 , limited to @xmath190 .",
    "@xmath191 is given about two and half times more weight than @xmath192 .",
    "intuitively , this is necessary because there is an asymmetry between a steep and a shallow spectrum : a steep spectrum means that the signal dies off quickly with frequency , while a shallow spectrum implies that it maintains its strength longer .",
    "thus , there is a larger allowed parameter volume with steep indices than with shallow , leading to an imbalance in terms of marginal probabilities .",
    "this parametrization effect is countered by the jeffreys prior .",
    "the solid curve in figure [ fig : jeffreys_vs_flat ] shows the result of using jeffreys prior instead of a uniform prior .",
    "similar behaviour is observed independent of noise realization .",
    "the conclusion is clear : a proper ignorance prior leads to unbiased estimates , while a naive uniform prior leads to biased estimates .",
    "in addition to this basic ignorance prior , it may be beneficial to adopt physical priors , based on knowledge from other experiments .",
    "for example , if one had reason to expect that the dominant signal in a given data set were galactic synchrotron emission , a reasonable prior could be @xmath193 , based on low frequency measurements .",
    "the physical prior is multiplied by the ignorance prior , taking account of both effects . in the rest of the paper , when we say that a gaussian prior is adopted for the spectral indices , we mean a product of a gaussian and jeffreys prior .",
    "the previous section shows that given sufficient data and an appropriate prior , the marginal posterior is a good estimator of the target parameter . in this section",
    "we investigate what happens when the data are not sufficiently strong to break a degeneracy .",
    "we replace the single - channel offset @xmath182 by a template amplitude @xmath194 coupled to a fixed free - free template @xmath195 and a spectral index of @xmath196 , @xmath197    two modifications are made to the simulation .",
    "first , the spectral index of the synchrotron component is fixed to @xmath198 , rather than being spatially varying .",
    "second , a fifth frequency channel is added at 143 ghz .",
    "no free - free component is added to the data ; the optimal template amplitude value is zero .",
    "the question is whether these data are sufficient to distinguish between synchrotron and free - free emission with similar spectral indices of @xmath199 and @xmath200 , respectively .",
    "the answer is no .",
    "figure[fig : freefree_posterior ] shows the marginal template amplitude posteriors , computed by direct integration as in the previous section .",
    "the different curves correspond to different gaussian priors imposed on the synchrotron spectral index .",
    "all are centered on the true value @xmath199 , but with different standard deviations @xmath201 . with the strong prior of @xmath202 ,",
    "the amplitude posterior is well - centered near the true value of zero .",
    "however , when the prior is gradually relaxed , the marginal posterior widens and drifts away from the true value .",
    "the marginal posterior is not a useful estimator for the template amplitude in this case .",
    "this behaviour is explained by the fact that with 3072 independent pixels the contribution of noise to the offset amplitude is insignificant compared to the uncertainty introduced by coupling to the synchrotron component .",
    "moreover , the amplitude and spectral index distributions are similar for the two foreground components . as a result ,",
    "the joint distribution becomes long , narrow and curved , like that in the top middle panel of figure[fig : degenerate_case1 ] , the marginal one - dimensional posteriors are dominated by the `` boomerang wing '' orthogonal to the parameter axis .",
    "similarly , the `` wing '' parallel to the axis is diluted . given sufficiently strong degeneracies ,",
    "the marginal distributions no longer contain the maximum - likelihood point within their , say , @xmath203 confidence regions .",
    "when the prior is made increasingly tight , however , the wings of the distribution are gradually cut off and the marginal distribution homes in on the true value .",
    "thus , the collection of distributions shown in figure [ fig : freefree_posterior ] in some sense visualizes the joint posterior .",
    "this behaviour may be quantified by means of the covariance matrix of the gaussian amplitude part of the system , defined in equation [ eq : coupling_matrix ] .",
    "a useful quantity describing this matrix is its condition number , the ratio of its largest and smallest eigenvalues . for the particular case discussed above , we find that the condition number is @xmath204 , which , although tractable in terms of numerical precision for double precision numbers for single - precision arithmetic and @xmath205 for double precision . however , in practice one should stay well below these values , in particular for iterative applications since small numerical errors may propagate in an uncontrolled manner . ] , indicates a very strong degeneracy .",
    "the final example we consider before turning to realistic simulations is the same as in ",
    "[ sec : flat_vs_jeffrey ] , except we allow a free offset for _ all _ frequency bands , not just one .",
    "( this is characteristic of real experiments , which do not know the absolute zero - point at any frequency . )",
    "the model is @xmath206    if the spectral index is constant over the sky , @xmath207 , this is a perfectly degenerate model : @xmath208 one can simply add a constant to the foreground amplitude , and subtract a correspondingly scaled value from each offset .",
    "it is thus impossible to determine individually the absolute zero - level of foreground component and offsets . to obtain physically relevant results ,",
    "external information must be imposed .",
    "spatial variations in the spectral index partially resolve this degeneracy . in the @xcite synchrotron model",
    "the spectral index @xmath209 varies smoothly on the sky between @xmath210 and @xmath211 .",
    "the condition number of the foreground amplitude - offset covariance matrix is @xmath212 , and the covariance matrix is no longer singular . a modified index model with ten times smaller fluctuations but the same mean ( @xmath213 ) increases the condition number by two orders of magnitude , to @xmath214 .",
    "these strong degeneracies lead to the same quantitative behaviour as seen for the marginal free - free template amplitude posterior in the previous section , making it very difficult to estimate both all offsets and the foreground amplitude zero - level individually . in practice ,",
    "external constraints are required .",
    "we have implemented two approaches for dealing with this degeneracy in our code , both based on the projection operator described in  [ sec : amplitude_sampling ] .",
    "the first and more direct approach is to assume that the offsets of one or more bands are known _ a - priori _ by external information . for instance , if an experiment somehow measured total power , as opposed to differences alone , detailed knowledge about the instrument itself could be used for these purposes .",
    "the advantage of this approach is that it is exact , assuming the validity of the prior , and the accuracy of all uncertainties is maintained .",
    "it is implemented simply by demanding that @xmath215 , which requires , in terms of the orthogonality vectors defined in  [ sec : amplitude_sampling ] , @xmath144 .",
    "the second approach is based on the observation that the degeneracy between the foreground amplitude and the offsets seen in equation [ eq : perfect_degeneracy ] leads to a very specific frequency distribution of offset amplitudes . specifically , @xmath216 , where @xmath217 is an arbitrary constant , _ but common to all frequency bands_. it is therefore possible to require that the set of offsets should not have a frequency spectrum that matches the foreground spectrum .",
    "the corresponding constraint on @xmath218 may be derived from @xmath219 by first taking the derivative with respect to @xmath217 , and then enforcing a vanishing foreground component , @xmath220 , @xmath221 = 0\\ ] ] the expression in brackets says that the offsets should be orthogonal to the mean noise - weighted foreground spectrum .",
    "if the total signal model includes more than one signal component with a free amplitude at each pixel , then these should be included jointly in the above @xmath177 .",
    "a particularly important case is that including both a cmb signal , which has a frequency - independent spectrum , and a proper foreground component . for this case , we have @xmath222 where @xmath223 is the additional degree of freedom introduced by the cmb signal . the equivalent constraint on @xmath218 derived from this expression",
    "is notationally more involved ( see appendix [ sec : full_constraint ] for a full derivation and constraints ) , but may be written as before in terms a set of orthogonality vectors @xmath224 .    while this orthogonality constraint is effective for estimating the absolute zero - level of the foreground component in question , it corresponds to a strong implicit prior",
    "that is not likely to be compatible with reality .",
    "if there are indeed random offsets at all frequencies , some fractional combination of these offsets will mimic a foreground component . in the above approach",
    ", this component is _ defined _ to be a foreground signal , rather than an offset .",
    "further , no mixing between the two components is allowed .",
    "thus , the estimated error bars on both the offsets and foreground zero - level will be underestimated .",
    "recall , however , that this entire discussion concerns the relative contributions to the foreground zero - level and the free offsets , not the cmb signal , which relies on the sum of the two components alone .",
    "the fact that the _ estimated error _ in the foreground zero - level is under - estimated by a small factor , say , four or five ( @xmath225 vs.  @xmath226 ; see the simulation described in  [ sec : simulations ] ) , is of no consequence for most applications . far more important",
    "is the fact that this approach provides excellent estimates of both the cmb sky signal and the spectral index distribution , the two quantities where most of the physics lie .",
    "this is in sharp contrast to the method employed by the wmap team , which is based on a co - secant fit to a plane - parallel galaxy model @xcite . while that specific approach is prone to severe modelling errors because of its lack of detailed foreground modelling , the current approach is internally consistent with respect to all signal components . for more discussion on this issue , see appendix [ sec : full_constraint ] , as well as the actual analysis of the 3-yr data presented by @xcite . in that analysis , a common offset of @xmath227",
    "is detected in all frequency bands , as well as a significant residual dipole in the v - band data .",
    "the above discussion may be summarized by the following observations :    * the marginal mean is a good estimator only for mildly degenerate and non - gaussian joint distributions .",
    "strongly degenerate models should be avoided , because they are difficult to summarize by simple statistics , and because it takes a prohibitive number of samples to fully explore them . *",
    "the uniform prior is a proper ignorance prior for gaussian variables only . in general ,",
    "jeffreys rule should be used in the absence of informative priors . * for experiments with unknown offsets at each frequency band , there is a strong degeneracy between these offsets and the overall zero - level of the foreground amplitudes .",
    "this degeneracy should be broken by external or internal priors , if marginal posteriors are to be used as estimators .",
    "in  [ sec : degeneracies ] we considered simple toy models to develop intuition about the target distributions .",
    "we used analytical , brute - force computations to avoid the complexities of real - world computer code . in this section",
    ", we turn our attention to commander , our implementation of the joint foreground - cmb gibbs sampler described in  [ sec : hybrid_sampling ] .",
    "three conditional distributions are involved in this joint gibbs sampler , namely the cmb power spectrum distribution @xmath56 , the amplitude distribution @xmath105 , and the spectral parameter distribution @xmath228 . in the following three subsections ,",
    "we test the output from commander for these three conditional distributions against analytical expressions , at low resolution , to verify both the general sampling algorithms and our specific implementation .",
    "to verify the cmb power spectrum distribution @xmath56 , we construct a low - resolution cmb - only simulation as follows .",
    "draw a random cmb realization from a standard @xmath229cdm power spectrum @xcite , smooth to @xmath230 fwhm , and pixelize at @xmath231 .",
    "add white noise of @xmath180 rms to each pixel .",
    "impose the wmap kp2 sky cut @xcite , without point sources and downgraded to @xmath179 , on the data .",
    "we compute slices through the corresponding likelihood by considering each @xmath104 individually , fixing all other multipoles at the input power spectrum , with a brute - force calculation in pixel - space ( e.g. , * ? ? ?",
    "* ) , and with commander .",
    "the outputs from the latter are smoothed through rao - blackwellization @xcite to reduce monte carlo errors .",
    "figure[fig : verification_cmb ] shows the results for four multipoles .",
    "the theoretical input spectrum is shown by vertical solid lines , and the true realization spectrum by dashed lines .",
    "commander reproduces the cmb power spectrum distributions perfectly .",
    "to verify the amplitude distribution @xmath232 , we construct a simulation at @xmath233 ( 768 independent pixels , angular resolution @xmath234 fwhm ) .",
    "the cmb realization is the same as in the previous section , appropriately smoothed .",
    "five frequency channels are simulated , corresponding to the five wmap channels .",
    "in addition to the cmb sky signal , @xmath14 , we add a synchrotron signal , @xmath235 with a spatially varying spectral index , a dust template with an amplitude , @xmath194 , scaled to unity at w - band , and a @xmath236 monopole to the k - band .",
    "( see foreground description in section [ sec : model ] for further details on this model . )",
    "thus , all four types of amplitudes are represented .",
    "white noise of @xmath180 rms is added to each pixel at each frequency .",
    "we fix the cmb power spectrum and synchrotron spectral index map , and compute the joint gaussian amplitude distribution both analytically and with commander .",
    "the analytical computation is performed by direct evaluation of the mean @xmath237 and covariance matrix @xmath107 defined by equations  [ eq : coupling_matrix ] and [ eq : joint_mean ] .",
    "the marginal variances of each parameter are given by the diagonal elements of @xmath107 .",
    "figure [ fig : verification_gauss ] shows the marginal distributions for one parameter of each type .",
    "again , commander reproduces the exact analytical result perfectly .      to verify the spectral index sampler for @xmath238 , a single - pixel distribution",
    ", we simulate a single pixel .",
    "the signal model is identical to that in  [ sec : single_pixel ] , comprising a synchrotron component with unknown amplitude and spectral index , plus an unknown offset at the lowest frequency .",
    "we compute the corresponding three - dimensional joint posterior by direct grid evaluation and by commander .",
    "figure  [ fig : verification_single_pixel ] shows the corresponding marginal distributions .",
    "again we find perfect agreement .",
    "all conditional distributions currently implemented in commander have thus been verified .",
    "we turn now to a more realistic simulation , with properties corresponding to the 3-yr wmap data .",
    "the simulation has two goals .",
    "first , to show that the method can handle data with realistic complexities , and that it is applicable to the current wmap data and ( even more importantly ) the up - coming planck data .",
    "second , to provide the necessary background for understanding the results from the actual 3-yr wmap analysis presented by @xcite .",
    "we construct the simulation as follows .",
    "draw a cmb sky realization from the best - fit @xmath229cdm power spectrum presented by @xcite .",
    "convolve with the each of the beams of the ten differencing assemblies of wmap @xcite , pixelized at a healpix resolution of @xmath239 .",
    "add white noise to each map with standard deviation @xmath240 , where @xmath183 is the number of observations at pixel @xmath90 ( provided on lambda together with the actual sky maps ) .",
    "downgrade these ten maps to a common resolution of @xmath0 fwhm and @xmath241 , bandlimiting each map at @xmath242 .",
    "create frequency maps by co - adding differencing assembly maps at the same frequency ( e.g. , q  =  ( q1+q2)/2 ) . add uniform white noise of @xmath243 rms to each frequency map to regularize the noise covariance matrix .",
    "figure [ fig : signal_to_noise ] shows the cmb and noise spectra of the co - added v - band data , both at the native resolution of the frequency band ( dashed lines ) and at the common @xmath0 fwhm resolution ( solid lines ) .",
    "the cmb to regularization noise ratio is unity at @xmath244 , and less than 2% at @xmath245 .",
    "both the instrumental and the regularization signal - to - noise ratios are @xmath246 at @xmath247 , and therefore negligible at these scales compared to cosmic variance .",
    "instrumental noise averaged over the full sky is larger than the regularization noise everywhere below @xmath248 . in the ecliptic plane , where the instrumental",
    "rms is about a factor of two larger than the full - sky average due to wmap s scanning strategy , it dominates below @xmath249 .",
    "the result of this unmodelled noise term is , as we will see later , a somewhat high pixel - by - pixel @xmath177 in the ecliptic plane .",
    "however , since this error term is correlated only on very small scales ( the beam size of @xmath0 fwhm ) , and we understand its origin and benign behaviour , it does not represent a significant problem for the analysis . with additional years of wmap observations , and the addition of the planck data , this noise contribution will be further suppressed .",
    "further , we will consider in the future various approaches for taking this term into account , for instance by computing explicitly the corresponding sparse covariance matrix .",
    "our foreground model has three components , synchrotron , free - free , and thermal dust emission . for synchrotron emission , where the spectral index is known to vary substantially with position on the sky , we extrapolate the 408 mhz map @xcite using a map of the spectral index for each pixel . for the latter we use an updated version of the giardino et al .",
    "( 2002 ) spectral index map that is based on 408 mhz and wmap 23ghz data , after removing the free - free emission via the wmap mem free - freemodel ( bennett et al . 2003b ) .",
    "the free - free model is defined by the @xmath250 template of @xcite , scaled to 23ghz assuming an electron temperature of @xmath251 and a spatially constant spectral index of @xmath252 .",
    "the dust model is based on model 8 of @xcite , evaluated at 94ghz and scaled to other frequencies using a single - component modified black - body spectrum with @xmath253 and an emissivity index of @xmath254 .",
    "anomalous dust is ignored in this analysis .    guided by the results of @xcite",
    ", we add a common offset to all frequencies of @xmath255 .",
    "no dipole contributions are added to the simulations .    for the power spectrum analysis in  [ sec : cosmology ] , we analyze the same realization with and without foregrounds , but with the same sky cut .",
    "this allows us to distinguish between sky - cut and foreground - induced effects .",
    "we adopt the same parametric signal model as that used by @xcite , @xmath256 + \\\\+",
    "b&\\left[t(p ) a(\\nu ) \\left(\\frac{\\nu}{\\nu_0^{\\textrm{dust}}}\\right)^{1.7}\\right ] + f(p ) a(\\nu )    \\left(\\frac{\\nu}{\\nu_0}\\right)^{\\beta(p)}. \\end{split}\\ ] ] the first term is the cmb sky signal .",
    "the second and third terms are the monopole @xmath257 and three dipole components @xmath258 defined by standard cartesian basis vectors .",
    "the fourth term is a dust tracer , based on the fds template coupled to a fixed spectral index of @xmath259 , and a free overall amplitude @xmath194 .",
    "the postulated power - law spectrum does not match the modified black - body spectrum used to create the simulation , and modelling errors are therefore to be expected .",
    "the fifth term is a single low - frequency foreground component with a free amplitude @xmath260 and spectral index @xmath261 at each pixel @xmath90 .",
    "the antenna - to - thermodynamic differential temperature conversion factor is @xmath68 , as always .",
    "in addition to the previously described jeffreys prior , we adopt a prior of @xmath262 for the low - frequency foreground spectral index , assuming that the foreground signal is synchrotron emission unless the data require otherwise .",
    "this is not a particularly strong prior : the free - free spectral index of @xmath85 is only 2.8@xmath186 away from the prior mean , and it does not take a large free - free amplitude to overcome this . for instance , near the galactic plane the standard deviation of the marginal index posterior is @xmath263 , thirty times smaller than the prior width . at high latitudes , on the other hand , the synchrotron spectral index is for all practical purposes unconstrained .",
    "the prior prevents this component from interfering with the cmb signal in regions where its amplitude is low .",
    "we impose the orthogonality constraint discussed in  [ sec : degen_fullsky ] to break the degeneracy between the free monopoles and dipoles at each band , and the foreground zero - level and dipole .",
    "an important goal in the following is to see whether this approach yields sensible results .    with the simulation , model , and priors defined , we compute the joint and marginal posteriors using the machinery described earlier in the paper . the wall - clock time for generating one single sample",
    "is @xmath264s , parallelized over five 2.6ghz amd opteron 2218 processors , one for each frequency band .",
    "we generate five chains with 1000 samples each , for a total wall clock time of 14hr .",
    "the total computational cost is 350cpu hours .",
    "we begin our examination of the results by plotting the output markov chains as a function of iteration count in figure [ fig : wmap_trace_plots ] .",
    "each panel shows the evolution of one parameter , such as the cmb power spectrum coefficient for a single multipole or the dust template amplitude .",
    "burn - in is a crucial issue for markov chain algorithms .",
    "the chains were initialized with a random cmb power spectrum over - dispersed relative to the true distribution , and the spectral indices of the low - frequency foreground component were drawn randomly and uniformly between @xmath265 and @xmath266 .",
    "the gibbs sampler needs some time to converge to the equilibrium distribution ; as we see in figure  [ fig : wmap_trace_plots ] , about 200 iterations are required to reach the equilibrium state .",
    "the last parameters to equilibrate are the global monopole and dust amplitudes , because the uncertainty in these very high signal - to - noise parameters is very small , and only small steps can be made between consecutive gibbs samples .",
    "moreover , since these are global parameters , they couple to all other parameters .",
    "the @xmath177 trace plot shows an interesting feature . after reaching a minimum @xmath177 solution after about 100  iterations ,",
    "the chain stabilizes at a very slightly higher equilibrium value .",
    "this is due to the fact that the full distribution consists not only of the sky signal components , but also the cmb power spectrum .",
    "maximizing the total joint posterior value is therefore a compromise between minimizing the sky signal @xmath177 and optimizing the cmb power spectrum posterior . at iteration number 100",
    ", the cmb component is still burning in , whereas the foreground amplitude , the single most important parameter in terms of @xmath177 , has already reached its equilibrium .",
    "the markov chain thus overshoots in @xmath177 minimization until the cmb power spectrum equilibrates .",
    "correlation length is a second crucial issue for markov chain algorithms . in general ,",
    "classic metropolis - hastings algorithms have a long correlation length because they propose relatively small modifications at each iteration in order to maintain high acceptance probability .",
    "the gibbs sampler works differently . because it samples from exact conditional distributions , large jumps are perfectly feasible , at least in the absence of strong conditional correlations .",
    "( in the present case there are no such strong correlations . ) the cmb power spectrum and cmb sky signal are only weakly correlated in the high signal - to - noise regime , and the foreground spectral index couples only moderately strongly to the foreground amplitude of the same pixel , and weakly to anything else .",
    "the result is excellent mixing properties and short correlation lengths .",
    "this translates into a high sampling efficiency and a relatively small number of samples required for convergence . to quantify this",
    ", we adopt the widely used gelman - rubin @xmath267 statistic @xcite , which is the ratio between two variance estimates .",
    "if the markov chains have converged , the two estimates should agree , and their ratio , @xmath267 , should be close to unity .",
    "a typical recommendation is that @xmath267 should be less than 1.1 to claim convergence , given that the chains were initially over - dispersed , although smaller numbers are clearly better .",
    "computing this statistic for the five chains above , while discarding the first 200 samples , we find that @xmath267 is less than 1.01 for the cmb power spectrum up to @xmath268 , less than 1.05 for the both the cmb pixel and foreground amplitudes all over the sky , and less than 1.01 for the template amplitudes .",
    "thus , even with such a relatively modest number as 4000 samples , excellent convergence has been reached on all marginal statistics .",
    "we return to the question of joint convergence of the cmb spectrum posterior in  [ sec : cosmology ] .",
    "we now turn to the marginal distributions of the estimated signal parameters , and focus first on the signal components .",
    "the cmb power spectrum is discussed separately in the next section .",
    "the sky map results are summarized in figure [ fig : wmap_maps ] in terms of the marginal posterior means , standard deviations , and differences between the posterior means and the input maps .",
    "table  [ tab : monopole ] lists the monopole and dipole results .",
    "the dust template amplitude posterior mean and standard deviation is @xmath269 .",
    "considering first the left column in figure [ fig : wmap_maps ] , we see that the three sky map reconstructions are visually compelling . no obvious foreground residuals are observed in the cmb map , familiar structures such as",
    "the north galactic spur and gum nebula are seen in the foreground amplitude map , and the spectral index map distinguishes clearly between the known synchrotron and free - free regions .",
    "these visual considerations are quantified in the right column , where the input maps has been subtracted from the posterior means .",
    "we see that the cmb map has residuals at the @xmath270 rms level , with a peak - to - peak amplitude of @xmath271 .",
    "little of these residuals is correlated on the sky except for a few patches near the galactic plane .",
    "most of the differences are simply due to instrumental noise .    for the foreground amplitude ,",
    "more distinct correlated patches are seen , in particular in regions with strong free - free emission .",
    "this is due to the fact that a single power law is not a sufficiently good approximation to the sum of the free - free and synchrotron components , relative to the statistical uncertainty .",
    "lcccc    k - band & @xmath272 & @xmath273 & @xmath274 & @xmath275 + ka - band & @xmath276 & @xmath277 & @xmath278 & @xmath279 + q - band & @xmath280 & @xmath281 & @xmath278 & @xmath275 + v - band & @xmath282 & @xmath283 & @xmath284 & @xmath285 + w - band & @xmath286 & @xmath287 & @xmath288 & @xmath289    finally , even the the spectral index difference map shows clearly correlated regions , and additionally a negative bias of about @xmath290 .",
    "this bias is primarily due to two effects .",
    "first , as reported at the beginning of this section , the dust template amplitude is over - estimated by 12% , mainly because of mis - specification of the dust spectrum . as a result , slightly too much signal is subtracted from the higher frequency channels , and this in turn steepens the spectral index of the remaining signal .",
    "second , at high latitudes the data are noise dominated , and the @xmath291 prior becomes active . because the true signal has an average of @xmath292 at high latitudes , a bias of @xmath293 results .    comparing the actual difference maps with the estimated errors shown in the middle column of figure [ fig : wmap_maps ] , we see that the errors of the cmb and foreground amplitudes are underestimated by a factor of @xmath294 to 2 .",
    "( these plots are typically scaled to a dynamical range of @xmath295 .",
    "the expected peak - to - peak range in a difference plot is therefore roughly three times the rms error . )",
    "this is due to modelling errors in two forms .",
    "first and foremost , we neglected the smoothed instrumental noise in our data model , and this causes a significant unmodelled uncertainty at the smoothing scale .",
    "however , being random with zero mean , it does not induce significant structure on larger scales , and it therefore has negligible impact on the scales of cosmological interest ( @xmath296 ) .",
    "second , the foreground model is simplified compared to the input , as we approximate the sum of two power law components by a single power law , and also assume a simple power - law dust spectrum while the input sky has a modified black - body spectrum .",
    "combined , these effects introduce errors not captured by the estimated statistical uncertainties .    table  [ tab : monopole ] lists the posterior mean and standard deviations of the monopole and dipole coefficients .",
    "recall that the input parameters in the two cases were @xmath255 and @xmath297 , respectively .",
    "in general , these values are reconstructed reasonably well , although the error estimates are somewhat underestimated for the ka- and q - band monopoles .",
    "we see that the orthogonality constraint described in  [ sec : degen_fullsky ] is quite effective , producing a good estimate of all quantities of interest . on the other hand",
    ", it does have the effect of artificially reducing the error bars on the template amplitudes somewhat , and also correlating them .",
    "however , misestimation of the monopole error estimates by a few microkelvin is a small price to pay for an absolute estimate of the foreground amplitudes to within a few percent .",
    "the features seen in the cmb rms map may be understood qualitatively in terms of the above results .",
    "first , the most dominating structure is a hot - spot centered on the galactic plane .",
    "this is mainly due to the coupling between the galactic foregrounds and the x - component of the dipole . because of the large foreground signal in this direction , it is hard to estimate the corresponding dipole component ( see table [ tab : monopole ] ) , and this transfers uncertainty from low to high latitudes .",
    "note , however , that this particular component has a very specific correlation structure on the sky , which is taken implicitly into account by the algorithm ; this uncertainty does therefore not significantly affect high-@xmath104 modes in the power spectrum , even though it looks visually dominating in a marginal rms map .",
    "second , the masked galactic plane has a very high uncertainty , although not infinite ; the requirement of isotropy implies that the modes inside this plane is to some extent restricted , at least on large angular scales .",
    "finally , as expected there is a ( weaker ) correlation between the foreground amplitude and spectral index maps and the cmb rms map .",
    "figure  [ fig : wmap_chisq ] shows the average @xmath177 computed over the 4000 accepted samples .",
    "a value of 15 in this plot corresponds to a model that is excluded at the 99% confidence level .",
    "two points are worth noticing in this plot .",
    "first , the ecliptic plane stands out with higher @xmath177 values .",
    "as described above , this is due to the unmodelled , smoothed instrumental noise . at a smoothing scale of @xmath0 fwhm , this component is not fully negligible for the 3-yr wmap data relative to the cmb signal , and therefore causes a slight bias at the smallest scales , @xmath298 .",
    "however , we are mainly interested in @xmath299 , and in this range the instrumental signal - to - noise ratio exceeds 100 everywhere",
    ". this term does not affect the cmb signal of primary interest .",
    "the actual foreground - induced modelling errors are very small . indeed , despite the fact that we approximate the sum of two different power laws with a single component , and assume an incorrect dust spectrum , the @xmath177 distribution is essentially perfect near the ecliptic poles , and the residuals are very small even close to the galactic plane .    however , the @xmath177 for the global solution as a whole is somewhat poor , with a reduced @xmath177 of 1.68 .",
    "this large value is largely dominated by unmodelled smoothed instrumental noise in the ecliptic plane , as discussed above ; when analyzing the same data set at a smoothing scale of @xmath300 , rather than @xmath0 , we found a reduced @xmath301 .",
    "thus , when using the products from this analysis in subsequent studies ( e.g. , for cosmological parameter estimation ) , it is important to include only those scales that are unaffected by the degradation process itself . \"    in summary , the overall results are very promising indeed .",
    "the cmb sky signal is reconstructed to within a few percent everywhere , as is the foreground amplitude .",
    "further , the spectral indices are accurate to the @xmath302 level wherever there is a significant signal , and the monopole and dipole coefficients are very close to the true values .",
    "finally , even the reconstructed dust template amplitude is correct to within 2% .",
    "the results are slightly more mixed when it comes to estimation of uncertainties . for components with a relatively large intrinsic uncertainty , such as the cmb sky signal and foreground spectral index ,",
    "the error estimates are quite reasonable",
    ". on the other hand , for parameters with a high intrinsic signal - to - noise ratio , most noticeably the dust template amplitude , the errors are clearly under - estimated because of significant modelling errors .",
    "( we note that analysis of simulations with a foreground composition and priors that matches the assumed model yields , as expected from the results shown in section [ sec : verification ] , both point estimates and uncertainties in agreement with expectations . )",
    "the remaining and key issue is what the impact of these residuals and increased uncertainties are on the cmb power spectrum and cosmological parameters at @xmath296 .",
    "this is the topic of the next section .",
    "we now consider the cmb power spectrum posterior with the goal of understanding the impact of both residual foregrounds and error propagation on the final results .",
    "to do so , we consider both the identical simulation described in the previous section and a similar one in terms of instrumental properties and sky coverage , but excluding foregrounds both from the simulated data and the model .",
    "comparing the two against each other allows us to disentangle the effects of foregrounds and sky cut .",
    "the top panel of figure  [ fig : wmap_sigma ] shows the posterior mean realization specific spectrum , @xmath303 , for three different cases .",
    "first , the true full - sky spectrum is plotted as a red line .",
    "second , the cut - sky but cmb - only spectrum is shown as blue curve , and finally , the cut - sky and `` foreground - contaminated '' spectrum is shown as a black curve .",
    "the @xmath304 confidence region about the latter is marked as a gray region .",
    "the bottom panel shows the difference between the foreground - contaminated spectrum and the full - sky spectrum ( red ) , and difference between the two cut - sky spectra ( blue ) .    in terms of absolute differences",
    ", we see that the foreground errors ( blue curve in figure [ fig : wmap_sigma ] ) are in general less than @xmath305 at @xmath296 , with a few occasional peaks at @xmath306 , and without any striking biases . already at this point",
    ", we may thus predict that the absolute effect of residual temperature foregrounds on cosmological parameters will be small at large angular scales , when using the component separation method presented in this paper .",
    "next , we consider the foreground induced uncertainties .",
    "first we note that if the total cmb spectrum uncertainty has been properly estimated , then the full - sky difference spectrum ( red curve in figure  [ fig : wmap_sigma ] ) should be distributed according to the uncertainties indicated by the gray region . except for some noticeable correlated features around @xmath307 ,",
    "this agreement is quite reasonable .",
    "second , the blue curve shows the differences due to foregrounds alone .",
    "this term should thus be described by a corresponding increase in the total uncertainty when including foregrounds in the analysis .    to understand the relative magnitude of these contributions",
    ", it is instructive to compute the relative magnitudes of the errors due to cosmic variance , sky cut and instrumental noise , and foregrounds .",
    "these can be estimated from quantities ready at hand .",
    "first , the standard expression for the cosmic variance is @xmath308 second , the uncertainty due to the mask and instrumental noise alone is given by the variance of @xmath309 , @xmath310 where @xmath311 are generated in the analysis without foregrounds .",
    "similarly , the uncertainty due to the combined effect of the mask , instrumental noise , and foregrounds is given by the same expression but computed from the samples that also include foregrounds . to establish an order of magnitude approximation of the foreground - induced uncertainty alone",
    ", we assume that the variances add in quadrature , @xmath312 this is of course not strictly correct , because the errors in question are quite non - gaussian , but it is a sufficient approximation for our purposes .",
    "these three functions are shown in the top panel of figure [ fig : error_comp ] for the data set described above . in the bottom panel ,",
    "we show the ratio of the mask and noise error and the foreground error , respectively , to cosmic variance .",
    "first we note that the foreground error is always smaller than the mask and noise induced error , except at the very highest @xmath104 s , where the estimates are anyway not reliable .",
    "however , at @xmath313 these two are almost comparable in magnitude , both at the 2550% level of the cosmic variance . once again assuming that these errors add in quadrature , neglecting a 20% error term implies underestimating the full errors by about 2% ( @xmath314 ) .    at larger angular scales",
    ", we see that the foreground uncertainty becomes essentially irrelevant , simply because the cosmic variance dominates completely : at @xmath296 , the relative magnitude of this term is seldom more than 10% of the cosmic variance , which translates to a relative under - estimation of the total error by only 0.5% .",
    "this implies a somewhat surprising conclusion : exact foreground error propagation is not important on the very largest scales , below , say , @xmath296 , simply because the cosmic variance is so totally dominating .",
    "however , the same does not necessarily hold true on smaller scales . at @xmath315 ,",
    "the foreground error increases the total uncertainty by several percent , and this is likely to increase further to smaller scales may be connected with the lack of features in the dust template at these angular scales ; we do not believe it is a general feature . ] .",
    "it could constitute a very significant fraction of the total error in the range between @xmath316200 , depending on the spatial foreground power spectrum .    in figure",
    "[ fig : posteriors ] , we plot eight slices through the power spectrum likelihood between @xmath317 and 50 , for the two cases that exclude ( black curves ) and include ( red curves ) foregrounds . in these plots , we see the same behaviour as discussed above : at very low @xmath104 s , the widths of the distributions with and without foregrounds are essentially identical . however , at @xmath318 the effect of the foreground uncertainties starts to become visible , as the red distribution is noticeably wider than the black distribution .",
    "still , it is also very clear from this figure that the effect of neglecting foreground errors in the temperature spectrum at @xmath319 in terms of cosmological parameters will be minimal .    to demonstrate this statement",
    ", we define a simple two - parameter power spectrum model , @xmath320 where @xmath321 is a free overall amplitude , @xmath322 is a spectral tilt parameter , and @xmath323 is the actual theoretical power spectrum used to generate the simulation .",
    "we then map out the corresponding two - dimensional posterior using the blackwell - rao estimator @xcite .",
    "the analysis is restricted to the range between @xmath324 and 30 , which is the primary target range for our first wmap analysis @xcite .",
    "figure  [ fig : qn_model ] shows the results in terms of two sets of contours .",
    "the dashed contours show the results from the analysis excluding foregrounds , and the solid contours show the results including foregrounds . the true value of @xmath325 is marked by a cross .",
    "the agreement between the two sets of results is excellent .",
    "two conclusions may be drawn from this exercise .",
    "first , the method presented in this paper is fully capable of extracting the valuable cosmological signal from the 3-yr wmap data at large angular scales in quite realistic simulations , even when using the simplified foreground model described earlier .",
    "second , the increased uncertainty in cosmological parameters due to these foregrounds at @xmath326 is negligible .",
    "we have presented an algorithm for joint component separation and cmb power spectrum estimation .",
    "this algorithm is a natural extension of the cmb gibbs sampler previously developed by @xcite , @xcite and @xcite , and the foreground sampler described by @xcite .",
    "the basic product from this algorithm is a set of joint samples drawn from the full joint posterior @xmath327 , where @xmath1 is the cmb power spectrum , @xmath328 is the cmb sky signal , and @xmath11 denotes the set of all parameters in the foreground model . with this tool ,",
    "exact marginalization over very general foreground models is feasible , and proper foreground uncertainties may be propagated seamlessly through to the cmb power spectrum and , therefore , to cosmological parameters .",
    "there are some potential pitfalls the user of the method needs to be aware of before applying it to real data .",
    "in particular , one has to pay attention to possible degeneracies in the parametric signal model fitted to the data .",
    "such degeneracies are not uncommon in models relevant to cmb foreground analysis .",
    "two specific examples are synchrotron and free - free emission , with spectral indices of @xmath329 and @xmath252 , respectively , and the degeneracy between unknown offsets at all frequency bands and the foreground zero - level . in order to obtain reliable one - dimensional marginal estimates of each component individually",
    ", one must either make sure that the data have sufficient power to resolve the model , or impose priors to break the degeneracies .",
    "fortunately , since only the sum over all foregrounds is relevant to the actual cmb reconstruction , these issues are of little concern to the cosmological interpretation of the data .",
    "the primary target of this work is planck , scheduled to be launched in late 2008 , and which will observe the microwave sky at nine frequencies from 30 to 857ghz .",
    "combined with the five wmap frequencies , these fourteen sky maps will constitute an outstanding data set for both cosmological and galactic studies . using the methods described in this paper",
    ", it will be possible to constrain three or four foreground components pixel - by - pixel , and even more if adopting spatial templates as priors ( e.g. , the h@xmath330 template as a tracer for free - free ) .",
    "a more immediate application is the analysis of the 3-yr wmap temperature data , which is presented in a separate letter by @xcite .",
    "as demonstrated in the present paper , the method is fully capable of extracting the valuable cosmological signal at large angular scales from this data set , both in terms of the cmb power spectrum and cosmological parameters .",
    "further , a very general foreground model may be constrained to within a few percent in all parameters .    in its present form ,",
    "the method assumes identical beam responses at each frequency band .",
    "this limits its application to the lowest angular resolution of a given data set .",
    "however , this is not a fundamental limitation of the method , but only of our current implementation . specifically , it is straightforward to rewrite the sampling equations presented in  [ sec : hybrid_sampling ] to handle the foreground amplitudes in spherical harmonic space , similar to the current treatment of the cmb sky signal . in that case ,",
    "convolution with individual beams at each frequency poses no problem .",
    "an added bonus is that one may then optionally also either estimate or impose a spatial power spectrum on the foregrounds , just as for the cmb component .",
    "the implementation of this is left for future work .    still , as demonstrated in this paper ,",
    "even with the current implementation we are able to perform a complete bayesian joint cmb and foreground analysis with the 3-yr wmap temperature data at @xmath33150 .",
    "simple extrapolation with respect to angular resolution and instrumental noise suggests that we will be able to do at least as well for planck up to @xmath268200 , beyond which other and simpler approaches may be applicable .",
    "we will quantify these projections in greater detail in an upcoming publication where we apply the method to state - of - the - art planck - based simulations .",
    "an important part of this work is to quantify the impact of modelling errors .",
    "to conclude , given the recent successes of the gibbs sampling approach for analyzing both temperature and polarization cmb data , and now also including realistic foreground modelling , we believe that this method , or generalizations thereof , should be the baseline analysis strategy for planck at large angular scales .",
    "we also note that its computational efficiency and unparallelled capabilities for propagating systematic uncertainties is a combination that will prove extremely valuable to future cmb experiments .",
    "we acknowledge use of the healpix software @xcite and analysis package for deriving the results in this paper .",
    "we acknowledge use of the legacy archive for microwave background data analysis ( lambda ) .",
    "this work was partially performed at the jet propulsion laboratory , california institute of technology , under a contract with the national aeronautics and space administration .",
    "hke acknowledges financial support from the research council of norway , and the hospitality of the center for long wavelength astrophysics at jpl ..",
    "in section [ sec : amplitude_sampling ] we described the sampling algorithm for the conditional gaussian distribution @xmath332 .",
    "this involved calculating the joint mean , @xmath116 , \\label{eq : joint_mean2}\\ ] ] and multiplying with the inverse covariance matrix , @xmath115 .",
    "\\label{eq : coupling_matrix2}\\ ] ]    we now write each element in this matrix explicitly , for the benefit of readers who want to implement the algorithm themselves .",
    "the elements in the first row of blocks are given by , @xmath333 the upper part of the second row is @xmath334 note that in the above , @xmath335 is the block containing the second derivatives of the log density with respect to the amplitudes @xmath336 , but by the assumed independence of noise at different frequency channels , the terms with @xmath337 vanish .",
    "the elements of the upper part of the third row are @xmath338 and , finally , for the last block on the diagonal we have @xmath339",
    "in  [ sec : flat_vs_jeffrey ] it was shown that to obtain unbiased parameter estimates based on marginal statistics for a power - law foreground model , it is necessary to adopt a proper ignorance prior for the spectral index . in this appendix",
    "we derive the full expression for this prior , including noise and the antenna - to - thermodynamic conversion factor , @xmath68 .",
    "the data model is in this case @xmath340 where @xmath341 is a noise term with variance @xmath342 .",
    "we assume no noise correlations between frequencies .",
    "the log - likelihood then reads @xmath343    jeffreys ignorance prior is defined by @xmath344 where the averaging brackets denote an ensemble average .",
    "we therefore differentiate the log - likelihood twice and find @xmath345 aa(\\nu )      \\left(\\frac{\\nu}{\\nu_1}\\right)^{\\beta }      \\ln^2\\left(\\frac{\\nu}{\\nu_1}\\right ) \\right\\}\\ ] ] taking the ensemble average of this expression simply means setting @xmath346 , and the second term therefore vanishes , @xmath347 neglecting irrelevant constants .",
    "thus , the full expression for jeffreys ignorance prior for a spectral index @xmath97 reads @xmath348",
    "most of the discussion in  [ sec : degeneracies ] concerned the degeneracy between free offsets at each frequency band and the zero - level of an foreground component with a free amplitude at each pixel .",
    "if neither is known , it is possible to add an arbitrary constant to all amplitudes , and subtract a correspondingly scaled value from each free offset , essentially without affecting the final @xmath177 .    to break this degeneracy , two approaches were proposed .",
    "first , if external calibration is possible at one or more frequencies , such information should be exploited and conditioned upon .",
    "the second approach was to demand that the free offsets do not have frequency component similar to that of the foreground , by effectively fitting out the corresponding spectrum from the offsets .",
    "these issues apply more generally to any fixed template with a free amplitude at all frequency bands . for most typical applications ,",
    "this includes also three unknown dipole components , in addition to the familiar offset or monopole . in the following ,",
    "we simply consider a general collection of templates denoted by @xmath349 , which is an @xmath350 matrix consisting of @xmath351 templates listed in its columns . coupled to this",
    ", we define a coefficient vector @xmath352 containing the template amplitudes for each frequency and template .",
    "the sky response at frequency @xmath51 is thus given by @xmath353 .",
    "we now derive the joint orthogonality constraints for @xmath351 templates , for a sky model that includes two components with a free amplitude at each pixel , namely a cmb sky signal and a foreground component with a given frequency spectrum .",
    "we denote the vectors of free template coefficients for the cmb and foreground terms by @xmath354 and @xmath355 , respectively , and the foreground spectrum is defined by the @xmath61 diagonal matrix @xmath356 having entries equal to @xmath357 on the diagonal .",
    "note that the frequency spectrum of the cmb component is constant , and the corresponding matrix is therefore the identity .",
    "it is omitted in the following .    with this notation ,",
    "the @xmath177 to be minimized reads @xmath358 equating the derivatives of this expression with respect to @xmath354 and @xmath355 to zero gives @xmath359 these two sets of equations provide a general expression for @xmath360 as a function of @xmath354 and @xmath355 , and at this point we have done nothing more than performed a partial change of basis .",
    "we now impose the prior that breaks the degeneracy between the template and the foreground amplitudes , by requiring @xmath361 .",
    "the two above equations then has a unique solution .",
    "in particular , @xmath360 is given by @xmath362 where we , for notational transparency , have defined four ancillary matrices @xmath363 note that equation [ eq : joint_constraints ] corresponds to @xmath351 separate constraints on @xmath360 , and , in particular , each row of the matrix in parentheses defines one orthogonality vector @xmath364 .",
    "these constraints are thus imposed in the cg solver using the same projection operator method that was described in ",
    "[ sec : amplitude_sampling ] .",
    "however , we once again stress that this approach corresponds to imposing a very strong prior that is not realized in practice : if there are indeed random fluctuations in the unknown offsets , then these will have a component that happens to have a spectrum similar to the foregrounds .",
    "this component will in the present approach be interpreted as a foreground signal .",
    "further , the sampler is by this constraint not allowed to explore the joint distribution between the two components . in other words , both the marginal zero - level and offset uncertainties will be under - estimated by this approach .",
    "( note that most other parameters , such as the cmb signal , are very weakly affected by this , because they only depend on the sum of the two components , not each of the two separately . )",
    "that being said , for experiments where this constraint is required ( e.g. , differential observatories such as wmap ) , it is difficult indeed to construct an alternative and more self - consistent approach .",
    "for example , the wmap team adopted a method based on a co - secant fit to a very crude , plane parallel galaxy model .",
    "in their case , no uncertainties were quoted at all .",
    "this specific issue is considered in further detail in the actual 3-yr wmap analysis @xcite ."
  ],
  "abstract_text": [
    "<S> we describe and implement an exact , flexible , and computationally efficient algorithm for joint component separation and cmb power spectrum estimation , building on a gibbs sampling framework . </S>",
    "<S> two essential new features are 1 )  conditional sampling of foreground spectral parameters , and 2 )  joint sampling of all amplitude - type degrees of freedom ( e.g. , cmb , foreground pixel amplitudes , and global template amplitudes ) given spectral parameters . given a parametric model of the foreground signals , we estimate efficiently and accurately the exact joint foreground - cmb posterior distribution , and therefore all marginal distributions such as the cmb power spectrum or foreground spectral index posteriors . the main limitation of the current implementation is the requirement of identical beam responses at all frequencies , which restricts the analysis to the lowest resolution of a given experiment . </S>",
    "<S> we outline a future generalization to multi - resolution observations . </S>",
    "<S> to verify the method , we analyse simple models and compare the results to analytical predictions . </S>",
    "<S> we then analyze a realistic simulation with properties similar to the 3-yr wmap data , downgraded to a common resolution of @xmath0 . </S>",
    "<S> the results from the actual 3-yr wmap temperature analysis are presented in a companion letter . </S>"
  ]
}