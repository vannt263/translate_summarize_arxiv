{
  "article_text": [
    "in this paper , we present the development of a gray radiation solver in our compressible astrophysics code , castro .",
    "castro uses an eulerian grid with block - structured adaptive mesh refinement ( amr ) .",
    "our approach to amr is based on a nested hierarchy of logically - rectangular variable - sized grids with simultaneous refinement in both space and time . in our previous paper (",
    "* henceforth paper i ) , we describe our treatment of hydrodynamics , including gravity and nuclear reactions . here",
    ", we describe an algorithm for flux - limited gray radiation hydrodynamics based on a mixed - frame formulation .",
    "many astrophysical phenomena involve radiative processes , which often dominate the energy transport and dynamical behavior of the system .",
    "some examples include star formation , stellar structure and evolution , accretion onto compact objects , and supernovae .",
    "radiation hydrodynamics simulations are playing an increasingly important role in modeling these astrophysical systems .",
    "the fundamental equation of radiation transfer is a six - dimensional integro - differential equation @xcite , which is unfortunately very difficult to solve .",
    "numerical codes typically solve one or two angular moment equations of the transfer equation .",
    "one common approach is to solve a two - moment system including radiation energy density and radiation flux ( e.g. , * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "the system is closed by an approximate expression for the radiation pressure .",
    "another popular approach is to solve the radiation energy equation only ( e.g. , * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "in this approach , the so - called flux - limited diffusion ( fld ) approximation is used for closure @xcite .",
    "the two - moment approach is more accurate when the radiation is highly anisotropic and optically - thin , but it is computationally more expensive than the fld approach .",
    "however , fld is a very good approximation for optically - thick flows .",
    "furthermore , the fld approach can be numerically more robust than the two - moment approach for systems in the hyperbolic limit .",
    "we have adopted the fld approach in the radiation solver of castro .",
    "castro solves the equations of nonrelativistic radiation hydrodynamics .",
    "thus , gas quantities , such as pressure , temperature and density , are treated as frame - independent because the corrections are of order @xmath0 , where @xmath1 is the gas velocity and @xmath2 is the speed of light .",
    "however , radiation quantities , such as radiation energy density , radiation flux , and radiation pressure , in the comoving frame differ from those in the laboratory frame by order @xmath3 @xcite . neglecting the @xmath3 terms",
    "potentially leads to erroneous results , especially in the dynamic diffusion limit where transport of radiation is dominated by motion of the fluid @xcite . for numerical codes",
    ", some authors chose the comoving frame approach in which the radiation quantities are measured in the comoving frame ( e.g. , * ? ? ? * ; * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "* ) , whereas others chose the mixed - frame approach in which the radiation quantities are computed in the laboratory frame while the opacities are measured in the comoving frame ( e.g. , * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    ". a primary weakness of the comoving frame approach is that it does not conserve energy , whereas the mixed - frame approach is not suitable for systems in which line transport is important . in castro , we have chosen the mixed - frame approach because it conserves the total energy and is well suited for amr .",
    "this paper is organized as follows . in   [ sec : rhd ] we present the governing equations of the mixed - frame gray radiation hydrodynamics and the mathematical characteristics of the system . in   [ sec : single ] we describe the single - level integration scheme . in   [ sec : amr ] we describe how the integration algorithm is extended for amr . in   [ sec : performance ] we show the scaling behavior of castro with radiation . in   [ sec : tests ] we present results from a series of test problems .",
    "finally , we summarize the results of the paper in   [ sec : sum ] .",
    "assuming local thermodynamic equilibrium , the mixed - frame frequency - integrated radiation hydrodynamics equations , correct to @xmath3 , can be written as ( see e.g. , * ? ? ?",
    "* ; * ? ? ?",
    "* ) : @xmath4 here @xmath5 , @xmath6 , @xmath7 , @xmath8 , and @xmath9 are the mass density , velocity , pressure , temperature , and total energy per unit mass ( internal energy , @xmath10 , plus kinetic energy , @xmath11 ) , respectively .",
    "@xmath12 , @xmath13 , and @xmath14 are radiation energy density , radiation flux , and radiation pressure tensor , respectively .",
    "note that here the @xmath15 subscript denotes radiation .",
    "the speed of light and radiation constant are denoted by @xmath2 and @xmath16 , respectively , where @xmath17 and @xmath18 is the stefan - boltzmann constant .",
    "@xmath19 and @xmath20 are the planck mean and flux mean interaction coefficients , both in units of inverse length .",
    "the @xmath21 superscript denotes the comoving frame .",
    "radiation quantities ( @xmath12 , @xmath13 and @xmath14 ) without the @xmath21 superscript are measured in the lab frame .",
    "radiation quantities measured in the comoving and lab frames are related by the lorentz transformation @xcite .",
    "it should be noted that absorption and scattering coefficients are always computed in the comoving frame in the mixed - frame approach .",
    "also note that scattering can be included in the flux mean interaction coefficient .",
    "the whole system is closed by an equation of state for the fluid and a relation between @xmath22 and @xmath23 , @xmath24 where @xmath25 is the eddington tensor in the comoving frame .    in the fld approximation @xcite",
    ", the comoving radiation flux is written in the form of fick s law of diffusion , @xmath26 where the diffusion coefficient @xmath27 is given by @xmath28 where @xmath29 is the rosseland mean of the sum of the absorption and scattering coefficients , and @xmath30 is the flux limiter .",
    "we adopt the flux limiter approximation given in @xcite as @xmath31 the corresponding radiation pressure tensor is @xcite @xmath32 e_r^{(0)},\\ ] ] where @xmath33 is the identity tensor of rank 2 , @xmath34 , and the eddington factor @xmath35 is given by @xmath36 we note that in the optically - thick limit both the flux limiter @xmath30 and the eddington factor @xmath35 approach @xmath37 , whereas in the optically - thin limit the flux limiter @xmath30 and the eddington factor @xmath35 approach @xmath38 and @xmath39 , respectively .",
    "furthermore we assume that @xmath40 , a common approximation accurate in optically - thick regions @xcite .",
    "following @xcite , we keep terms up to @xmath3 , and we drop all terms that are insignificant in all following regimes : streaming , static diffusion , and dynamic diffusion limits .",
    "our radiation hydrodynamics equations now become , @xmath41 the absorption terms on the right hand side of these equations still include the radiation energy density in the comoving frame , because this is the the frame in which emission and absorption balance as the material becomes opaque .",
    "the comoving and lab frame quantities are related by @xmath42 in the framework of the fld approximation .",
    "radiation hydrodynamics under the assumption of fld is a mixed hyperbolic - parabolic system with stiff source terms .",
    "the equations of the hyperbolic subsystem are @xmath43 which are obtained by neglecting the terms on the right - hand - side of eqs .",
    "[ eq : full - rho][eq : full - er ] . in the limit of strong equilibrium ( i.e. , @xmath44 and @xmath45 ) , these right - hand - side terms are negligible and the full system becomes hyperbolic , governed by eqs .",
    "[ eq : hyper - rho][eq : hyper - er ] . in the more general case the hyperbolic subsystem will be solved first as part of a time - split discretization .    in castro",
    ", we solve the hyperbolic subsystem with a godunov method , which utilizes a characteristic - based riemann solver .",
    "the godunov method requires that we analyze the mathematical characteristics of the hyperbolic subsystem . for simplicity ,",
    "let us consider the system in one dimension , which can be written in terms of primitive variables as , @xmath46 where the primitive variables are @xmath47 and the jacobian matrix is @xmath48 the system is hyperbolic because the jacobian matrix is diagonalizable with four real eigenvalues . in general cases , the eigenvalues and eigenvectors are unfortunately very complicated .",
    "however , when the following relation holds , @xmath49 the four eigenvalues are , @xmath50 where @xmath51 is the radiation modified sound speed .",
    "the corresponding right eigenvectors are , @xmath52 and the corresponding left eigenvectors are , @xmath53 these four eigenvectors define the characteristic fields for the one - dimensional system . by computing the product of the right eigenvectors and the gradients of their corresponding eigenvalues @xcite , we find that the first and fourth fields are genuinely nonlinear corresponding to either a shock wave or a rarefaction wave .",
    "the second and third fields are linearly degenerate corresponding to a contact discontinuity in either gas pressure or density .",
    "note that there is also a jump in radiation energy density accompanying the jump in gas pressure such that the total pressure , @xmath54 , is constant across the contact discontinuity .",
    "obviously , in three dimensions , there are two additional linear discontinuities for transverse velocities just like the case of pure hydrodynamics .",
    "it should be noted that eq .",
    "[ eq : flamb ] is satisfied in both optically - thick and thin limits .",
    "although this condition is not always satisfied , it is a fairly good approximation .",
    "the @xcite flux limiter that we use ( eqs .  [ eq : lambda ] & [ eq : lam - r ] ) satisfies @xmath55 thus , for the purpose of an approximate riemann solver , the approximate eigenvalues and eigenvectors are used .",
    "the parabolic part of the system consists of the radiation diffusion and source - sink terms , which were omitted from the discussion of the hyperbolic subsystem ( eqs .",
    "[ eq : hyper - rho][eq : hyper - er ] ) .",
    "@xmath56 where @xmath10 is the specific internal energy .",
    "the term @xmath57 represents the energy exchange in the comoving frame between the material and radiation through absorption and emission of radiation .",
    "the term @xmath58 is due to the lorentz transformation of radiation energy density .",
    "we do not directly solve eqs .",
    "[ eq : drhoe - i0 ] & [ eq : der - i0 ] because of our mixed - frame approach . instead",
    ", we solve eqs .",
    "[ eq : drhoe - i ] & [ eq : der - i ] .",
    "an implicit treatment is usually necessary in order to solve these equations because of their stiffness .",
    "however , the lorentz transformation term @xmath58 can be treated explicitly in many situations because it is of similar order to the term @xmath59 in the hyperbolic subsystem ( eqs .",
    "[ eq : hyper - rhoe ] & [ eq : hyper - er ] ) , unless the planck mean is much larger than the rosseland mean . without scattering ,",
    "the planck mean is usually larger than the rosseland mean because the latter gives more weight to the lower opacity part of the radiation spectrum .",
    "however , in many astrophysical phenomena ( e.g. , shock breakout in core - collapse supernovae ) , electron scattering , which contributes to the rosseland mean only , is the dominant source of opacity , and therefore the lorentz transformation term can be neglected in those cases .",
    "for each step at a single level of refinement , the state is first evolved using an explicit godunov method for the hyperbolic subsystem (   [ sec : explicit ] ) .",
    "then an implicit update for radiation diffusion and source - sink terms is performed (   [ sec : implicit ] ) .",
    "it is customary in time - split schemes to denote intermediate quantities with a fractional time index such as @xmath60 , so that , for example , the explicit hyperbolic update would advance radiation energy density from @xmath61 to @xmath62 and the implicit update would then advance it from @xmath62 to @xmath63 . we are not using this notational convention here mainly to avoid confusion in the following section with time - centered quantities constructed at the actual intermediate time @xmath64 . in ",
    "[ sec : implicit ] , where we write out the implicit update in detail , we will refer to the post - hyperbolic intermediate quantities as @xmath65 , @xmath66 , etc .",
    "the hyperbolic subsystem is treated explicitly .",
    "this explicit part of our numerical integration algorithm for radiation hydrodynamics is very similar to the hydrodynamics algorithm presented in paper i of this series .",
    "we refer the reader to paper i for detailed description of the integration scheme , which supports a general equation of state , self - gravity , and nuclear reactions . here",
    "we will only present the parts specific to radiation hydrodynamics .",
    "the advection part of the time evolution can be written in the form @xmath67 where @xmath68 with the superscript @xmath8 denoting the transpose operation are the conserved variables , and @xmath69 is their flux .",
    "the conserved variables are defined at cell centers .",
    "we predict the primitive variables , including @xmath5 , @xmath6 , @xmath7 , @xmath70 , @xmath12 , from cell centers at time @xmath71 to edges at time @xmath64 and use an approximate riemann solver to construct fluxes , @xmath72 , on cell faces .",
    "this algorithm is formally second - order in both space and time .",
    "the time step is computed using the standard cfl condition for explicit methods , with additional constraints if additional physics ( such as burning ) is included .",
    "the sound speed used in the computation is now the radiation modified sound speed @xmath73 ( eq .  [ eq : cs ] ) .",
    "castro solves the hyperbolic subsystem of radiation hydrodynamics with an unsplit piecewise parabolic method ( ppm ) with characteristic tracing and full corner coupling @xcite .",
    "the four major steps in the construction of the face - centered fluxes , @xmath72 , in the case of hydrodynamics have been described in details in paper i. the extension to radiation hydrodynamics is straightforward given the characteristic analysis presented in   [ sec : hyper ] .",
    "thus , we will not repeat the details here .",
    "we will also omit the procedures for passively advected quantities , auxiliary variables , gravity , and reaction , because they do not change .",
    "first , we compute the primitive variables defined as @xmath74 .",
    "note that several variables are redundant for various reasons ( i.e. , efficiency and safety ) , which will be explained later .",
    "second , we reconstruct parabolic profiles of the primitive variables within each cell .",
    "the total pressure , @xmath75 , rather than the gas pressure , @xmath7 , is used in computing a flattening coefficient @xcite .    in the third step ,",
    "we perform characteristic extrapolations of the primitive variables and obtain the edge values of @xmath76 at @xmath64 using the eigenvectors of the system ( eq .",
    "[ eq : righteigen ] & [ eq : lefteigen ] ) and the parabolic profiles of the primitive variables .",
    "flattening is applied in this procedure .",
    "finally , the fluxes are computed for the edge values obtained in the last step using an approximate riemann solver , which is based on the riemann solver of @xcite and @xcite .",
    "the computational procedure is essentially the same as that in paper i except that the gas internal energy density , @xmath70 , and gas pressure , @xmath7 are now replaced by the total internal energy density , @xmath77 , and total pressure , @xmath78 .",
    "the riemann solver computes the godunov state at the interface , which is then used to compute the fluxes , @xmath79 .",
    "recall that there are redundant variables in the primitive variables , @xmath76 , for efficiency and safety . with the total internal energy density , @xmath80 , a call to the equation of state can be avoided .",
    "negative radiation energy density and gas pressure can also be avoided in the godunov state .",
    "the term , @xmath59 , in eqs .",
    "[ eq : hyper - rhoe ] & [ eq : hyper - er ] is computed as follows , @xmath81 } , \\nonumber\\end{aligned}\\ ] ] where the variables with half - integer index are the godunov states .",
    "the term , @xmath82 , in eq .",
    "[ eq : hyper - rhou ] is computed in a similar way .    depending upon a switch set by the user , the lorentz transformation term , @xmath83 ,",
    "may be included in the explicit update .",
    "the implicit solver evolves the radiation and gas according to eqs .",
    "[ eq : drhoe - i ] & [ eq : der - i ] .",
    "the algorithm uses a first - order backward euler discretization .",
    "we note that the lorentz term , @xmath83 , may or may not be included in the implicit solver .",
    "the advantage of including this term here is that it effectively balances emission against absorption in the comoving frame as the material becomes optically - thick and this coupling becomes stiff .",
    "implicit treatment also helps avoid a time step restriction when @xmath84 is significantly greater than 1 .",
    "the disadvantage is that it makes the resulting linear systems nonsymmetric , but this not a major concern in practice .",
    "the radiation update algorithm is based on that of @xcite .",
    "the update from the post - hyperbolic state to time @xmath85 for eqs .",
    "[ eq : drhoe - i ] & [ eq : der - i ] has the form @xmath86 \\label{eq : be1 } \\\\      + { } & q^{n+1 } { \\mbox{\\boldmath$u$}}\\cdot \\nabla e_{r}^{n+1 } , \\nonumber \\\\ \\frac{e_r^{n+1 } - e_r^{-}}{\\delta t } =     + { } & c \\kappa_{\\mathrm{p}}^{n+1 } \\left[a(t^{n+1})^4 -       e_r^{n+1}\\right ]   \\label{eq : be2 } \\\\     - { } & q^{n+1 } { \\mbox{\\boldmath$u$ } } \\cdot   \\nabla e_r^{n+1 }     + \\nabla \\cdot \\left(d^{n+1 } \\nabla e_r^{n+1 } \\right ) , \\nonumber\\end{aligned}\\ ] ] where @xmath87 and @xmath88 . here",
    ", we use the @xmath89 superscript to denote the state following the explicit update , and the @xmath90 superscript for the state at @xmath85 .",
    "since the velocity does not change in the implicit radiation update , we have dropped the @xmath89 superscript for @xmath91 .",
    "we solve eqs .",
    "[ eq : be1 ] & [ eq : be2 ] iteratively via newton s method .",
    "we define @xmath92 \\right .",
    "\\nonumber \\\\      \\ \\ \\ & + q^{n+1 } { \\mbox{\\boldmath$u$}}\\cdot \\nabla e_{r}^{n+1 } \\left .",
    "\\right\\ } , \\\\",
    "f_r = e_r^{n+1 } - e_r^{- }     - \\delta t & \\left\\ {        c \\kappa_{\\mathrm{p}}^{n+1 } \\left[a(t^{n+1})^4 -          e_r^{n+1}\\right ] \\right .",
    "\\nonumber \\\\      - q^{n+1 } { \\mbox{\\boldmath$u$ } } \\cdot   \\nabla e_r^{n+1 }       & + \\nabla \\cdot \\left(d^{n+1 } \\nabla e_r^{n+1 } \\left .",
    "\\right )     \\right\\}.\\end{aligned}\\ ] ] here , we have dropped the @xmath89 superscript for @xmath93 because the implicit update does not change the mass density .",
    "the desired solution is for @xmath94 and @xmath95 to both be zero , and the newton update to approach this state is the solution to the linear system @xmath96        ( { \\partial f_r}/{\\partial t})^{(k ) }        & ( { \\partial f_r}/{\\partial e_r})^{(k ) }        \\end{array } \\right ]    \\left[\\begin{array}{c }        \\delta t^{(k+1)}\\\\        \\delta e_r^{(k+1 ) }        \\end{array}\\right ] = \\left[\\begin{array}{c }        - f_e^{(k)}\\\\        - f_r^{(k ) }        \\end{array}\\right].\\ ] ] here @xmath97 and @xmath98 , where the @xmath99 superscript denotes the stage of the newton iteration . to reduce clutter",
    "we drop the @xmath90 superscript without loss of clarity , so @xmath100 .    to solve this system we eliminate the dependency on @xmath101 by forming the schur complement , leaving a modified diffusion equation for the radiation update @xmath102 .",
    "for simplicity we drop the temperature derivatives of @xmath103 and @xmath104 , keeping only the temperature dependence of the emission and absorption terms .",
    "this does not affect the converged solution and in practice does not appear to significantly degrade the convergence rate .",
    "after some mathematical manipulation we obtain the following diffusion equation , which must be solved for each newton iteration : @xmath105 e_r^{(k+1 ) }    - { } & \\nabla \\cdot \\left(d \\nabla e_r^{(k+1 ) } \\right )     \\label{eq : diffusion }   \\\\ + { } & ( 1-\\eta)q{\\mbox{\\boldmath$u$ } } \\cdot \\nabla e_r^{(k+1 ) }    \\nonumber \\\\",
    "= ( 1-\\eta ) c \\kappa_{\\mathrm{p } }        a \\left(t^{(k)}\\right)^4 + \\frac{1}{\\delta t } &          \\left[e_r^- - \\eta ( \\rho e^{(k ) } -   \\rho e^- ) \\right ] , \\nonumber\\end{aligned}\\ ] ] where @xmath106 } \\approx -\\frac{\\partial f_r}{\\partial t } \\left (           \\frac{\\partial f_e}{\\partial t } \\right)^{-1},\\ ] ] and @xmath107 is the specific heat capacity of the matter .",
    "the iterations are stopped when the maximum of @xmath108 on the computational domain falls below a preset tolerance ( e.g. , @xmath109 ) .",
    "note that eq .",
    "[ eq : diffusion ] is rewritten to be in terms of @xmath110 rather than @xmath111 .",
    "this is done for computational efficiency .",
    "after one or two newton iterations , the solution at the previous iteration , @xmath112 , is getting very close to the final converged solution @xmath63 . since we use @xmath112 as the starting point for the call to the iterative linear solver these calls get cheaper for each additional newton iteration .",
    "if we solved for @xmath111 instead , we would have to change the linear solver tolerance to avoid an unnecessarily accurate and expensive solve for what may be a very small correction .",
    "each time we solve the diffusion equation for a new iterate @xmath110 , we update the gas internal energy density as follows , @xmath113 . \\nonumber\\end{aligned}\\ ] ] the new temperature @xmath114 then derives from @xmath115 and @xmath5 via a call to the equation of state .",
    "other quantities may or may not be updated : the coefficients @xmath19 , @xmath29 , @xmath116 , @xmath103 , and @xmath104 are also temperature - dependent and could have been written with a @xmath99 superscript .",
    "the limiter @xmath30 can be recomputed based on the new @xmath110 .",
    "it is a tradeoff between efficiency and accuracy whether to recompute some or all of these at every iteration .",
    "our default choice is to recompute all of these at each iteration for better accuracy .",
    "however , updating coefficients can make the implicit update iteration less stable if the coefficients are not smooth functions of their inputs , in addition to the extra computational costs .",
    "but since each stage of the newton iteration ( eq .  [ eq : diffusion ] combined with eq .",
    "[ eq : rhoeup ] ) is itself a conservative solution , the implicit algorithm will conserve total energy to the tolerance of the linear solver ( which should not be confused with the tolerance of the newton iterations ) regardless of the number of iterations taken or which coefficients are updated .    in castro , the linear system eq .",
    "[ eq : diffusion ] is solved using the _ hypre _ library @xcite .",
    "we have developed drivers that work with systems in the canonical form @xmath117 where @xmath118 are cell - centered coefficients and @xmath119 , @xmath120 , and @xmath121 are centered at cell faces .",
    "[ eq : diffusion ] the @xmath120 coefficients are not used .",
    "there is some subtlety in the appropriate averaging of coefficients from cells to faces ; see @xcite for further discussion .",
    "the same canonical form works for cartesian , cylindrical , and spherical coordinates so long as appropriate metric factors are included in the coefficients and the rhs .    with _ hypre",
    "_ we have a choice between two parallel multigrid solvers : schaffer multigrid ( smg ) and pfmg .",
    "smg is more robust for difficult problems with strongly - varying coefficients , but pfmg is typically more efficient and scalable .",
    "these solvers work for systems at a uniform grid resolution ( that is , systems associated with a single level of adaptive mesh refinement ) . for systems coupling together more than one refinement level we could use the _ hypre _ algebraic multigrid ( amg ) solver , or an fac - type scheme @xcite using structured solvers on the separate levels . in earlier versions of the amr algorithm we required multilevel solvers for conservative coupling between refinement levels .",
    "we have now developed a scheme , though , that eliminates the need for a multilevel linear solver while still conserving total energy .",
    "we discuss this in detail in the following sections .",
    "note also that use of the @xmath121 coefficients deriving from the lorentz term make the diffusion equation nonsymmetric .",
    "the multigrid solvers mentioned above are designed for use with symmetric systems , but good convergence behavior can still be obtained by using these solvers as preconditioners for a krylov method such as gmres .",
    "castro uses a nested hierarchy of logically - rectangular , variable - sized grids with simultaneous refinement in both space and time , as illustrated in figures  [ fig : refspace ] and  [ fig : reftime ] .",
    "one major design objective of the amr algorithm is to preserve the conservation properties of the uniform - grid discretization .",
    "amr for hyperbolic equations in castro was described in detail in paper i.    the explicit update step for radiation hydrodynamics (   [ sec : explicit ] ) follows the same pattern as other hyperbolic equations and so does not increase the complexity of the amr algorithm .",
    "we note that the hyperbolic subsystem ( eqs .",
    "[ eq : hyper - rho ]  [ eq : hyper - er ] ) is only partially in conservation law form .",
    "it will not conserve total momentum because it does not include an equation analogous to eq .",
    "[ eq : radflux ] tracking the radiation momentum .",
    "it will conserve total energy , though , so long as the divergence terms are differenced in a conservative manner .",
    "these divergence terms therefore require amr reflux operations , as described in @xcite .",
    "the term @xmath122 appears in both the gas energy and radiation energy equations with opposite signs , so any consistent discretization of these terms will conserve total energy .",
    "the amr version of the implicit radiation diffusion update is based on @xcite , but with several important differences : the present algorithm is fully - implicit , not time - centered .",
    "the optional multilevel linear solve at the beginning of each coarse time step is no longer included  this feature was introduced to improve accuracy but we now consider it unnecessary in most cases . finally ,",
    "the multilevel linear solve for flux synchronization between coarse and fine levels is replaced by a new algorithm we call the `` deferred sync . ''",
    "these changes entirely eliminate the need to compute linear system solutions coupling different levels of the amr hierarchy , while not compromising conservation of total energy .",
    "performance is significantly improved because multilevel linear solvers tend to be more complex and expensive than those for single - level systems .",
    "the amr time step is defined recursively in terms of operations on a level @xmath123 and its interactions with coarser and finer levels .",
    "we consider advancing level  @xmath123 from time index @xmath124 to @xmath90 , corresponding to time values @xmath125 and @xmath126 , respectively .",
    "( even though levels other than @xmath123 have executed different numbers of time steps , we will use the @xmath90 superscript to refer to values at time @xmath126 on all levels involved in the calculation . ) the region covered by level  @xmath123 is denoted @xmath127 , its border is @xmath128 , and the border of the next finer level , projected onto level  @xmath123 , is @xmath129 .",
    "the notation to describe all of this is unavoidably complex due to the quantities at different times , levels , and stages of the update process . in the following outline ,",
    "we specify the update for the level @xmath123 and its synchronization with finer levels .",
    "we include the hyperbolic update and the refluxing step associated with it in order to show the proper sequence of operations and to contrast the explicit reflux with the implicit deferred sync . as in ",
    "[ sec : explicit ] the hyperbolic conserved state vector is denoted by @xmath130 , but we denote the hyperbolic flux by @xmath131 to distinguish it from the radiation flux . for the radiation flux",
    "we are concerned here only with the diffusion term in the implicit update , and we denote the associated flux by @xmath132 to distinguish it from the complete radiation flux @xmath133 introduced in   [ sec : eqns ] .    note that while the flux divergence is needed everywhere , the fluxes @xmath131 and @xmath132 themselves are stored only on the borders between levels .",
    "our code has data structures called flux registers designed for this purpose .",
    "the notation @xmath134 indicates an average of level @xmath135 data in space over the fine cells ( or cell faces ) making up each corresponding coarse cell ( or face ) , while @xmath136 denotes an average of level @xmath135 data in both space and time over the coarse ( level  @xmath123 ) time step .",
    "thus , at the only point in the algorithm where this notation is used , @xmath137 where @xmath138 is the number of level  @xmath139 time steps making up the level  @xmath123 time step from @xmath124 to @xmath90 , and @xmath140 is the level @xmath139 flux during the level @xmath139 time step @xmath141 .",
    "the expression involving @xmath142 that appears as a deferred source term in the diffusion equation and explicitly for the hyperbolic reflux is called the reflux divergence , because it takes the form of the divergence of a flux difference @xmath143 stored in the flux registers .",
    "these terms are evaluated _ only _ in the coarse cells bordering an interface with a finer level .",
    "they do not affect fine cells at the interface because flux calculations for those cells are already the more accurate ones ; the @xmath142 terms represent the corrected fluxes from these fine cells being imposed onto the coarse grid .",
    "another way to understand the @xmath142 terms is to consider @xmath144 and @xmath145 to be energy that has been `` misplaced '' at the coarse - fine interfaces during the level time step , due to the differing flux calculations on the different levels .",
    "if the solution were not corrected , this energy would be lost and the system would not be conservative . instead , the @xmath142 terms re - introduce the missing energy into the system .",
    "for the explicit hyperbolic flux this is done explicitly ; for the radiation flux it contributes to the right hand side for the implicit update , so as not to impose a new stability constraint on the size of the time step .",
    "the hyperbolic state vector @xmath130 includes the radiation and fluid energies updated in the implicit update step , but there is no ambiguity because the operations and their associated fluxes are completely distinct .",
    "the refluxing update to @xmath130 is written as an update , with @xmath130 appearing on both sides of the equation , because otherwise we would need additional notation to indicate the pre- and post - reflux states .",
    "averaging down from fine to coarse levels is also written as an update .",
    "the meaning of the rest of the pseudocode below should be reasonably clear in context :    = = @xmath146 and ( regrid requested from base level @xmath123 ) + * then * + @xmath147 * do * + @xmath148 determine new grid layout for level @xmath149 .",
    "+ @xmath148 interpolate data to new grids from level @xmath150 .",
    "+ @xmath148 copy data on intersection with old level @xmath149 .",
    "+   + * endif * + * level time step , * level @xmath123 : + for @xmath151 + ` ( see paper i ) + @xmath148 set @xmath152 for hyperbolic fluxes + ` on ( @xmath129 , @xmath153 ) and on ( @xmath154 , @xmath155 ) +   + @xmath156 @xmath157 = @xmath158 $ ] + @xmath159 + @xmath160 + @xmath161 + ` on @xmath127 + @xmath156 @xmath162 $ ] + @xmath163 ` on @xmath127 +   + @xmath148 @xmath164 + ` on ( @xmath129 , @xmath153 ) and on ( @xmath154 , @xmath155 ) + @xmath148 advance levels @xmath165 recursively . + @xmath148 @xmath166 + ` on @xmath129 , @xmath153 + @xmath148 @xmath167 + ` on @xmath129 , @xmath153 + * end level time step * + * if * @xmath146 * then * + ` ( synchronization / refluxing between levels @xmath123 and @xmath139 ) + @xmath148 @xmath168 + ` on @xmath169 + @xmath148 @xmath170 ` on @xmath171 + * endif * ` ( end synchronization / refluxing ) .",
    "the advantages of the deferred sync algorithm are that it eliminates the need for a separate linear solve for synchronization and eliminates the need for solving multilevel linear systems entirely .",
    "it does , however , add complications of its own to the amr implementation .",
    "one is that there is no longer any point within the time step cycle when the field variables are fully synchronized . at the end of a coarse time step all levels",
    "have reached the same point in time , but if we want to actually compute the energy budget and confirm conservation we have to include the contributions from deferred fluxes stored in flux registers .",
    "these will not be re - introduced into the state until the next time step .",
    "the end of a coarse time step is also the natural time for checkpoint / restart operations , so to reproduce the saved state of the system we now have to include the deferred fluxes in checkpoints as well .",
    "regridding becomes an issue as well .",
    "the adaptive algorithm periodically re - evaluates the refinement criteria for each level and may change the layout of refined grids . for grids at level @xmath123",
    "the criteria are evaluated at level @xmath172 , and this happens between level @xmath172 time steps .",
    "the interpolation operations between coarse and fine field variables are conservative .",
    "with the deferred sync , though , there will also be fluxes stored around the edges of level @xmath123 at the time that level may be changed .",
    "there is no straightforward way to transform these stored fluxes so that they coincide with the new mesh layout .",
    "instead , what we have is an old set of flux registers that may now overlap with level @xmath123 as well as with level @xmath172 , and if the grid layout changes enough may even overlap with other levels both finer and coarser .",
    "the deferred sync idea still applies , but the implementation becomes more complicated than the pseudocode above suggests .",
    "portions of the stored flux at the interface between levels @xmath123 and @xmath172 may be reintroduced into the level @xmath123 advance or the level @xmath139 advance , and so on , not just into level @xmath172 .",
    "castro is implemented within the boxlib framework for parallel structured - grid amr applications ( paper i and references therein ) . in boxlib",
    ", parallelization is based upon either hybrid openmp - mpi or pure mpi .",
    "because the _ hypre _ library does not fully support openmp yet , we use the pure mpi approach for the radiation hydrodynamics solver . for more information on software design and parallelization , we refer the reader to paper i. here we show the scaling behavior of the radiation hydrodynamics solver in castro .    a weak scaling study has been carried out on hopper , a petascale cray xe6 supercomputer at the national energy research scientific computing center .",
    "we have performed a series of three - dimensional simulations with 1 , 2 and 3 total levels on various numbers of cores . for the convenience of comparison , each run has one grid of @xmath173 cells at each level on each core .",
    "a refinement factor of 2 is used in the multi - level simulations .",
    "thus , the level 1 and 2 grids occupy 12.5% and 1.5625% of the whole volume , respectively . a point explosion like the one in ",
    "[ test : blast1 ] is replicated on each core .",
    "the fine grids are placed at the center of the local domain of each core .",
    "figure  [ fig : scaling ] shows that castro has very good scaling behavior up to 32768 cores . for the single - level simulations , the average wall clock time per coarse time step increases by only 17% from 8 cores to 32768 cores . because of subcycling in time for simulations with multiple levels , one coarse time step consists of one step on the coarse level and two steps on the next fine level , and the two fine steps might also consist of even finer steps , recursively .",
    "thus , the number of cells that are advanced in one coarse time step increases by a factor of three or seven , for the two- and three - level simulations , respectively ( fig .",
    "[ fig : reftime ] ) .",
    "our results also show that the overhead introduced by amr is modest .",
    "for example , on 4096 cores , the average wall clock times per coarse time step for the two- and three - level simulations are 3.6 and 8.6 times more than that of the single - level simulation .",
    "this corresponds to an overhead of 19% and 22% , respectively . on 32768 cores ,",
    "the average wall clock times per coarse time step for the two- and three - level simulations are 3.8 and 9.5 times more than that of the single - level simulation .",
    "this corresponds to an overhead of 25% and 36% , respectively .",
    "it should be noted that single - level simulations with equivalent uniform grids would cost @xmath174 and @xmath175 times more time than the corresponding two- and three - level simulations we have run even if the single - level simulations are assumed to scale perfectly .",
    "we also note that in this series of simulations about half of the time is spent on the implicit evolution of the parabolic part of the system .",
    "in this section we present detailed tests of the code demonstrating its ability to handle a wide range of radiation hydrodynamics problems .",
    "note that not every term is included in every test so that the algorithms for these terms can be tested separately .",
    "we test the radiation source - sink term in isolation in the approach to thermal equilibrium test (   [ test : equlbrm ] ) . for a nonequilibrium marshak wave problem (   [ test : marshak ] ) , the simulation involves the parabolic subsystem only . in ",
    "[ test : thermalwave ] , we assess the accuracy of the amr algorithms for radiation diffusion using a thermal wave test , and perform a convergence study .",
    "the system in a radiation front test (   [ test : lightfront ] ) is in the optically - thin streaming limit , whereas the system in a shock tube problem (   [ test : shocktube ] ) is in the limit of strong equilibrium with almost no diffusion .",
    "the full radiation hydrodynamics system is included in a nonequilibrium radiative shock problem (   [ test:2tshock ] ) and the advection of a radiation pulse problem (   [ test : pulse ] ) . in ",
    "[ test : hse ] , we demonstrate the ability of castro to maintain a static equilibrium of the gas and radiation pressures . in a radiative blast wave test (   [",
    "test : blast1 ] ) , we compare the results of simulations in 1d spherical , 2d cylindrical ( @xmath15 and @xmath176 ) , and 3d cartesian coordinates . finally , we demonstrate the ability of castro to handle a large lorentz transformation term in another radiative blast wave test (   [ test : blast2 ] ) .",
    "a cfl number of 0.8 is used for these tests unless stated otherwise or a fixed time step is used .",
    "the refinement factor is 2 for all amr runs .",
    "the relative tolerance for the newton iterations in the implicit update is @xmath109 for all runs .",
    "the lorentz transformation term is handled explicitly except in the second radiative blast wave test (   [ test : blast2 ] ) .",
    "this test introduced by @xcite has often been used to test the ability of a code to handle the source - sink term , @xmath177 .",
    "the test consists of a static uniform field of gas and radiation .",
    "the gas has a density of @xmath178 , a planck mean absorption coefficient of @xmath179 , a mean molecular weight of @xmath180 , and an adiabatic index of @xmath181 .",
    "the initial radiation energy density is @xmath182 corresponding to a temperature of @xmath183 .",
    "two cases with an initial internal energy density of @xmath184 and @xmath185 , respectively , have been studied .",
    "the gas temperatures are @xmath186 and @xmath187 for the two cases , respectively .",
    "the time step is chosen as @xmath188 .",
    "the evolution of the system will bring the gas and radiation into a thermal equilibrium . the radiation energy density will hardly change because the energy exchange between the gas and radiation is only a small fraction of the radiation energy .",
    "therefore an analytic solution can be calculated by solving the following ordinary differential equation @xmath189 where @xmath12 is assumed to be constant .",
    "the results of this test of the approach to thermal equilibrium are shown in figure  [ fig : equlbrm ] .",
    "the agreement with the analytic solution is good , especially in the first case . for the second case ,",
    "the cooling in the numerical calculation is initially slower than that in the analytic solution for the first few steps in agreement with the results of @xcite .",
    "the slow cooling is a result of the _ backward _ euler method and a relatively large time step at the beginning of the decay of the gas temperature .      in this test ,",
    "we simulate the nonequilibrium marshak wave problem in one dimension .",
    "initially half of the space , @xmath190 , consists of a static uniform zero - temperature gas and no radiation .",
    "a constant radiation flux @xmath191 is incident on the surface at @xmath192 .",
    "the gas is not allowed to move in this idealized test .",
    "thus the gas and radiation are coupled only through the source - sink term and the system is governed by eqs .",
    "[ eq : drhoe - i ] & [ eq : der - i ] , with @xmath193 .",
    "@xcite obtained analytic solutions for the problem under special assumptions .",
    "the matter is assumed to be gray with @xmath194 , and its volumetric heat capacity at constant volume is assumed to be @xmath195 , where @xmath8 is the gas temperature and @xmath196 is a parameter .",
    "we have run this test with @xmath197 and no flux limiter ( i.e. , @xmath198 ) . figure  [ fig : marshak ] shows the numerical results of the dimensionless radiation energy density and gas energy density defined by @xcite @xmath199 the computational domain of @xmath200 is covered by 128 uniform cells .",
    "the dimensionless time step is chosen to be @xmath201 .",
    "the numerical results are in good agreement with the analytic results of @xcite .      in this test",
    ", we simulate a thermal wave @xcite in three dimensions and use this test to assess the accuracy of the amr algorithms for radiation diffusion .",
    "suppose that a large amount of energy is deposited into a small volume as the internal energy of matter .",
    "the matter then starts to radiate and transfer most of its energy to radiation .",
    "we assume that the planck mean absorption coefficient is large enough so that the matter and the radiation are in thermal equilibrium .",
    "the heat is transported out of the initial hot spot because of the nonlinear radiation heat conduction . as a result , a thermal wave develops . as the matter cools down , the matter gains most of the energy again .",
    "initially the thermal wave speed is much higher than the sound speed . assuming that there is no fluid motion and the matter contains most of the energy",
    ", there is an analytic solution for this problem @xcite .",
    "this test is adapted from @xcite .",
    "the computational region in this test is three - dimensional with a domain of @xmath202 in each dimension .",
    "initially , the spherical hot spot has an energy of @xmath203 within a radius of @xmath204 , whereas the ambient medium has a very low temperature of @xmath205 .",
    "the volumetric heat capacity is @xmath206 .",
    "the planck mean absorption coefficient is @xmath207 , whereas the rosseland mean is @xmath208 . in this test",
    ", the hydrodynamics is turned off , and there is no flux limiter ( i.e. , @xmath198 ) .",
    "we have performed three simulations , a non - amr run with @xmath209 uniform cells , an amr run using the deferred sync algorithm (   [ sec : dsync ] ) , and an amr run using the multilevel algorithm of @xcite .",
    "the two amr runs use 2 total levels with an effective resolution of @xmath209 cells on the finer level .",
    "a cell is tagged for refinement if its temperature satisfies both @xmath210 and @xmath211 , where @xmath212 is the size of the cell . for the non - amr run ,",
    "we use a time step @xmath213 for step @xmath124 , whereas for the two amr runs , we use @xmath214 for step @xmath124 on the coarser level .",
    "we have chosen the time steps for the following reasons . first ,",
    "as it expands , the thermal wave is rapidly decelerated .",
    "thus , a fixed time step would not be optimal .",
    "instead , we let the time step grow over time .",
    "second , the numerical error depends on both time step @xmath215 and cell size @xmath212 . in this test ,",
    "we want to assess the accuracy of the amr runs in comparison with a non - amr run .",
    "therefore , we make the time step on the finer level of the amr runs to be roughly the same as that of the non - amr run .",
    "figure  [ fig : thermalwave ] shows a 2d slice at @xmath216 of the deferred sync run at @xmath217 for temperature and the difference between the numerical and analytic results .",
    "it is shown that the largest errors ( @xmath218@xmath219 ) occur near the thermal wave front where the slope of the temperature profile is extremely steep . at the center ,",
    "the absolute error is only @xmath220 , whereas the relative error is 0.7% .",
    "it takes 451 coarse time steps for the amr runs to reach @xmath217 .",
    "the finer grids in the amr runs occupy 0.20 , 2.3 , and 32% of the volume at steps 1 , 226 , and 451 , respectively .",
    "thus , the benefit of amr is obvious . to quantitatively measure the accuracy of the results , we compute the normalized @xmath221-norm error for temperature , @xmath222 , where @xmath223 and @xmath224 are the numerical and analytic results for cell @xmath225 , respectively , and @xmath226 is the volume of cell @xmath225 . at @xmath217 ,",
    "the @xmath221-norm errors are @xmath227 , @xmath228 , and @xmath229 , for the non - amr , deferred sync , multilevel sync runs , respectively .",
    "the results show that our amr algorithms have only increased the error by @xmath230@xmath231 .",
    "ccc 16 , 32 & 0.0706 & + 32 , 64 & 0.0245 & 1.5 + 64 , 128 & 0.00833 & 1.6 + 128 , 256 & 0.00268 & 1.6    we have also performed a series of amr simulations using the deferred sync to check the convergence behavior of the code . besides the amr run using the deferred sync that has been presented ( fig .",
    "[ fig : thermalwave ] ) , two lower resolution runs and one higher resolution run have been performed ( table  [ tab : tw ] ) .",
    "in all four runs , there are two total amr levels . in the convergence study ,",
    "when the cell size changes by a factor of 2 from one run to another , we change the time step by a factor of 4 .",
    "table  [ tab : tw ] shows the @xmath221-norm errors and convergence rate at @xmath217 . in this study",
    ", the order of accuracy with respect to @xmath212 is @xmath232 .",
    "because our implicit scheme is first - order in time and second - order in the spatial discretization of the diffusion term , the expected convergence rate for a smooth flow is second - order with respect to @xmath212 when @xmath233 is fixed .",
    "however , the temperature profile of the thermal wave problem has a very steep slope near the front and its second derivative is discontinuous there .",
    "hence , it is not surprising that the achieved order of accuracy is lower than 2 .      in this problem",
    ", we test our code in the optically - thin streaming limit .",
    "this is the opposite limit from diffusion .",
    "the computational domain of this test is a one - dimensional region of @xmath234 , covered by 128 uniform cells .",
    "initially , the region @xmath235 is filled with radiation , @xmath236 , whereas the region of @xmath237 has @xmath238 .",
    "the left and right boundaries are held at @xmath239 and @xmath240 , respectively , during the calculation",
    ". the hyperbolic update (   [ sec : explicit ] ) is switched off in this test .",
    "the planck mean absorption coefficient is set to zero .",
    "we have studied two cases with rosseland means of @xmath241 and @xmath242 , respectively .",
    "thus the optical depths of the whole domain are @xmath243 and @xmath244 , respectively . for each case , we have performed two calculations , one with the time step set to @xmath245 and one with @xmath246 .",
    "physically , the radiation front is expected to propagate at the speed of light , but the diffusion approximation does not naturally support a propagating front at any speed . only the flux limiter permits the code to approximate the correct solution . in the numerical results the radiation front moves at approximately the speed of light with spreading due to diffusion ( figure  [ fig : streaming ] ) .",
    "better results are obtained for smaller time steps .      in this test ,",
    "the one - dimensional numerical region ( @xmath234 ) initially consists of two constant states : @xmath247 , @xmath248 , @xmath249 and @xmath250 , @xmath251 , @xmath252 , where @xmath253 stands for the left state , and @xmath254 the right state .",
    "the initial discontinuity is at @xmath255 .",
    "the gas is assumed to be ideal with an adiabatic index of @xmath256 and a mean molecular weight of @xmath257 .",
    "initially , the radiation is assumed to be in thermal equilibrium with the gas ( i.e. , @xmath258 ) .",
    "the interaction coefficients are set to @xmath259 and @xmath260 .",
    "thus , due to the huge opacities , the system is close to the limit of strong equilibrium with no diffusion ( i.e. , @xmath261 and @xmath45 ) , and is essentially governed by eqs .",
    "[ eq : hyper - rho][eq : hyper - er ] .",
    "the parameters of this test problem are chosen such that neither radiation pressure nor gas pressure can be ignored .",
    "the numerical results are shown in figure  [ fig : shocktube ] .",
    "also shown are the results from a pure hydrodynamics calculation with an equation of state ( eos ) for ideal gas plus radiation .",
    "as we expected , the results from the radiation hydrodynamics calculation are almost identical to those of the pure hydrodynamics calculation .",
    "we also note that our scheme is stable without using small time steps even though the system is in the `` dynamic diffusion '' limit @xcite with @xmath262 , where @xmath263 is the optical depth of the system .",
    "radiation can modify the structure of a shock because it diffuses and because it interacts with matter .",
    "analytic estimates of radiative shock structures can be found in @xcite .",
    "recently @xcite have found a semi - analytic exact solution of radiative shocks with gray nonequilibrium diffusion . in this section",
    ", we present our numerical results for two shock strengths and compare them to the solutions of @xcite .",
    "the first problem is the mach 2 shock in @xcite .",
    "this is a subcritical shock in which the pre - shock matter is preheated by diffused radiation to a temperature that is lower than the temperature in the relaxation region far downstream .",
    "there is an embedded hydrodynamic shock that causes a jump in density and raises the temperature of the matter above the final downstream temperature .",
    "the matter temperature behind the embedded hydrodynamic shock then cools down in the relaxation region .",
    "the second problem is the mach 5 supercritical shock in @xcite . in the case of a supercritical shock ,",
    "the matter temperature just before the hydrodynamic shock equals the downstream temperature .",
    "most of the precursor region of a supercritical shock is close to equilibrium .",
    "note that in both cases there is no jump in radiation energy density , otherwise the radiation flux would be infinite , which is unphysical .",
    "the mach 2 shock problem is simulated in a one - dimensional region of @xmath264 consisting of two constant states : @xmath265 , @xmath266 , @xmath267 and @xmath268 , @xmath269 , @xmath270 , where @xmath253 stands for the left state , and @xmath254 the right state .",
    "the initial discontinuity is at @xmath271 .",
    "the gas is assumed to be ideal with an adiabatic index of @xmath272 and a mean molecular weight of @xmath257 .",
    "initially , the radiation is assumed to be in thermal equilibrium with the gas ( i.e. , @xmath258 ) .",
    "the planck and rosseland coefficients are set to @xmath273 and @xmath274 , respectively .",
    "the boundaries are held at fixed values .",
    "two refinement levels ( three total levels ) are used with the finest resolution at @xmath275 . in this test",
    ", a cell is tagged for refinement if the normalized second derivative of either density or temperature given by @xcite @xmath276 is greater than 0.8 . here",
    ", @xmath277 is a parameter set to 0.02 in this test , and @xmath278 denotes either density or temperature .",
    "the initial conditions are set according to the pre - shock and post - shock states of the m2 shock .",
    "after a brief period of adjustment , the system settles down to a steady shock .",
    "the simulation is stopped at @xmath279 .",
    "the results are shown in figure  [ fig : m2 ] .",
    "the agreement with the analytic solution is excellent , except that the numerical results in the figure had to be shifted by @xmath280 in space to match the analytic shock position .",
    "this discrepancy in shock position is due to the initial transient phase as the initial state relaxes to the correct steady - state profile .",
    "no flux limiter is used in this calculation because the analytic solution of @xcite assumes @xmath198 .",
    "the setup of the mach 5 shock problem is similar to that of the mach 2 shock problem .",
    "the computational domain in this test is @xmath281 .",
    "four refinement levels ( five total levels ) are used with the finest resolution at @xmath282 .",
    "the refinement criteria are the same as in the mach 2 shock test ( eq .  [ eq : error ] ) .",
    "the initial left and right states are @xmath283 , @xmath284 , @xmath285 and @xmath286 , @xmath287 , @xmath288 , respectively .",
    "again , the system settles down to a steady shock after a brief period of adjustment .",
    "figure  [ fig : m5 ] shows the results at @xmath289 . the results including the narrow spike in temperature are in good agreement with the analytic solution .",
    "in this test , introduced by @xcite , we simulate the advection of a radiation pulse by the motion of gas .",
    "the initial temperature and density profiles are @xmath290 where @xmath291 , @xmath292 , @xmath293 , @xmath294 , the mean molecular weight of the gas is @xmath295 , and @xmath254 is the ideal gas constant .",
    "initially the radiation is assumed to be in thermal equilibrium with the gas .",
    "we also assume that the radiation pressure is @xmath296 ( i.e. , @xmath198 ) .",
    "if there were no radiation diffusion , the system would be in an equilibrium with the gas pressure and radiation pressure balancing each other .",
    "the interaction coefficients are set proportional to density as @xmath297 .",
    "because of radiation diffusion , the balance is lost and the gas moves .",
    "the purpose of this test is to assess the ability of the code to handle radiation being advected by gas .",
    "we will solve the problem numerically in different laboratory frames .",
    "then we can compare the case in which the gas is initially at rest to the case in which the gas initially moves at a constant velocity .",
    "we have performed three runs for comparison with each other and against the results of @xcite .",
    "the computational domain in all three runs is a one - dimensional region of @xmath298 with periodic boundaries .",
    "the simulations are stopped at @xmath299 .",
    "the velocity in the first run is initially zero everywhere , whereas in the second run it is @xmath300 everywhere .",
    "the numerical grid in these two runs consists of 512 uniform cells .",
    "the third run is a high - resolution calculation of the first case with 4096 uniform cells .",
    "figure  [ fig : pulse ] shows the density , velocity , and temperature profiles for all three runs .",
    "the results of the advected run have been shifted in space for comparison .",
    "the profiles from these three runs are almost identical demonstrating the accuracy of our scheme in this test .",
    "we also show the relative difference in figure  [ fig : pulse - error ] .",
    "the relative error of the low - resolution unadvected run with respect to the high - resolution run is computed as ( high - low)/high , and the relative error of the low - resolution advected run with respect to the low - resolution unadvected run is computed as ( unadvected - advected ) / unadvected .",
    "note that in figure  [ fig : pulse - error ] the results of the high - resolution run have been restricted to the low - resolution grid by averaging for comparison .",
    "the figure shows that the difference between the low - resolution and high - resolution runs is less than 0.05% everywhere , and the difference between the advected and unadvected runs is less than 0.0016% everywhere .",
    "the relative error in our runs is 1000 times smaller than that of @xcite .",
    "we also note that the asymmetry in the difference between the advected and unadvected cases is expected because our upwinding scheme breaks the symmetry slightly in the advected run .",
    "the linear solver can also break the symmetry slightly .      in the test of advecting radiation pulse (   [ test : pulse ] ) ,",
    "if there were no radiation diffusion , the system would be in a static equilibrium with the gas and radiation pressures balancing each other . in this test",
    ", we set both interaction coefficients to a very high value of @xmath301 .",
    "thus almost no diffusion can happen .",
    "we have performed a calculation on a two - dimensional cartesian grid of @xmath302 and @xmath303 with 512 uniform cells in each direction .",
    "the initial velocity is zero everywhere . for the initial setup , the coordinate @xmath304 in eq .",
    "[ eq : pulse ] is replaced by @xmath305 .",
    "figure  [ fig : pulse - hse ] shows the velocity profile at @xmath306 .",
    "the maximal velocity at that time is @xmath307 .",
    "note that the sound speed in this problem is between @xmath308 and @xmath309 .",
    "such a small gas velocity indicates that castro can maintain a perfect static equilibrium in multiple dimensions because of the way radiation pressure and gas pressure are coupled in the riemann solver .      in this test",
    ", a large amount of energy is deposited into a small region .",
    "this results in a spherical blast wave , which is somewhat similar to the sedov - taylor blast wave in hydrodynamics , except here we include radiation .",
    "there is no analytic solution for this problem .",
    "we use this problem to test the implementation of the geometric factors in castro .",
    "we have performed simulations in 1d spherical , 2d cylindrical ( @xmath15 and @xmath176 ) , and 3d cartesian coordinates .",
    "initially , the gas is at rest with a density of @xmath310 .",
    "the initial temperature for both the gas and radiation is set to @xmath311 , except for a region inside a sphere with a radius of @xmath312 centered at the origin where temperature is set to @xmath313 .",
    "the gas is assumed to be ideal with an adiabatic index of @xmath256 and a mean molecular weight of @xmath314 .",
    "the planck and rosseland coefficients are set to @xmath315 and @xmath316 .",
    "these simulations were run with two refinement levels ( three total levels ) with a cell size of @xmath317 at the finest level . in these simulations , at each but the finest level a numerical cell is tagged for refinement if it satisfies either @xmath318 or @xmath319 .",
    "furthermore , the intermediate level is slightly larger than the finest level due to proper nesting ( see paper i ) .",
    "the computational domain for the 1d spherical run is @xmath320 .",
    "the computational domain for the 2d cylindrical run is @xmath320 and @xmath321 . for the 3d run ,",
    "the computational domain is @xmath322 in each direction .",
    "a cfl number of 0.6 is used for these simulations , and the initial time step is shrunk by a factor of 100 to allow the point explosion to develop . note that we have chosen these initial conditions so that different regimes can be explored by the test .",
    "the blast wave starts with almost all the energy in radiation . at the end of the simulations ,",
    "approximately one third of the energy is in the gas , and the gas pressure just behind the shock is about twice the radiation pressure .",
    "furthermore , the gas and radiation are not in equilibrium near the shock due to the low planck mean opacity .",
    "since there is no analytic solution for the problem , we have also run a high - resolution 1d simulation with a cell size of @xmath323 for comparison .",
    "figure  [ fig : blast ] shows the radial profiles of density , radial velocity , gas temperature , and radiation temperature at @xmath324 for these runs .",
    "the radial profiles of the 2d and 3d results are computed by mapping each cell into its corresponding radial bin and averaging .",
    "the width of the bins is chosen to be the cell size at the finest refinement level .",
    "the results from runs in three different coordinates are in excellent agreement with each other , and they agree with those of the high - resolution simulation .",
    "a snapshot of the structure of density , radial velocity , gas temperature , and radiation temperature at @xmath325 for the 2d simulation is shown in figure  [ fig : bw2d ] .",
    "a 2d slice at @xmath192 of the 3d simulation is shown in figure  [ fig : bw3d ] .",
    "the multi - d results show good agreement with each other , and they are spherically symmetric except for some minor asymmetry in velocity at the low density region near the center .",
    "this asymmetry is , in part , due to the representation of the initial hot sphere in non - spherical coordinates .",
    "another source of the asymmetry in the 2d run is the coordinate singularity at the longitudinal axis ( @xmath326 ) of the cylindrical coordinates .",
    "it should also be noted that the amr gridding algorithm in castro does not necessarily preserve symmetry even if the layout of the numerical cells that are tagged for refinement is symmetric .",
    "last , but perhaps not least , the linear solver does not preserve perfect symmetry either .",
    "this test is similar to the first radiative blast wave test (   [ test : blast1 ] ) except that the planck mean coefficient is set to @xmath327 .",
    "thus the ratio of the two coefficients is @xmath328 . because of such a large ratio of the two mean opacities , the lorentz transformation term has to be treated implicitly in this test ,",
    "otherwise the time step would have to be much smaller for stability reasons .",
    "we have performed a 2d cylindrical simulation with two refinement levels ( three total levels ) and a cell size of @xmath329 at the finest level on a computational domain of @xmath320 and @xmath321 . in this 2d amr run , a numerical cell is tagged for refinement if it satisfies either @xmath330 or @xmath319 .",
    "we have also performed a high - resolution 1d simulation with a cell size of @xmath331 for comparison .",
    "a cfl number of 0.6 is used for the simulations , and the initial time step is shrunk by a factor of 100 to allow the point explosion to develop .",
    "figure  [ fig : blast2 ] shows the radial profiles of density , radial velocity , gas temperature and radiation temperature at @xmath324 for the two runs .",
    "the results show that castro can handle a very large lorentz transformation term implicitly without having to decrease the time step .",
    "we have developed a new radiation hydrodynamics solver in our compressible astrophysics code , castro .",
    "we use the mixed - frame approach and adopt the fld assumption .",
    "the solver uses a second - order explicit godunov method for the hyperbolic part of the system and a first - order backward euler method for the parabolic part .",
    "we have also presented the mathematical characteristics of the hyperbolic subsystem .",
    "the eigenvalues and eigenvectors of the system we have obtained are used to construct the riemann solver in our godunov scheme , and could also be useful for other characteristic - based schemes .    we have demonstrated the capability of castro to address a wide range of radiation hydrodynamics problems by extensive testing .",
    "there are a number of other radiation hydrodynamics codes .",
    "some recent examples include zeus-2d @xcite , zeus - mp @xcite , orion @xcite , heracles @xcite , v2d @xcite , nike @xcite , ramses @xcite , and crash @xcite .",
    "here we compare castro with these other codes .    *",
    "a major advantage of castro is its efficiency due to the use of amr and combined with good scaling behavior on up to 32768 cores . among the other radiation hydrodynamics codes listed above , only orion , ramses , and crash are three - dimensional amr codes .",
    "zeus - mp and heracles are three - dimensional codes without amr . zeus-2d and v2d are two - dimensional codes .",
    "nike is a one - dimensional code . *",
    "a unique strength of our code is that the hyperbolic solver in castro is an unsplit version of the ppm method that avoids spurious noise caused by dimensional splitting ( see paper i for an example of the advantage of unsplit methods over dimensional splitting methods ) . for the hyperbolic part , orion , heracles , nike , ramses , and crash use godunov methods , whereas zeus-2d , zeus - mp , and v2d use the zeus type of algorithms .",
    "the latter are faster but somewhat less accurate than high - order godunov methods . however , for a radiation hydrodynamics code , the cost of the hyperbolic solver is no longer a concern , because the implicit parabolic solver is more expensive . for multigroup radiation hydrodynamics , the implicit parabolic solver would be even more expensive and the hyperbolic solver would be essentially free . *",
    "our scheme is very robust even for dynamic diffusion . by solving the entire hyperbolic subsystem in one riemann solver",
    ", the scheme can avoid the operator splitting errors that appear in many other numerical schemes ( see e.g. , * ? ? ? * ) .",
    "we note that ramses and crash also couple both radiation and matter in their riemann solvers .",
    "* castro is based on a mixed - frame formulation , as is orion and nike .",
    "a main advantage of the mixed - frame approach is that it conserves the total energy , whereas its main disadvantage is that it is of limited use for line transport .",
    "however , line transport can not be treated by a gray radiation solver regardless of its choice of frame . *",
    "castro , zeus-2d , zeus - mp , orion , v2d , ramses , and crash have adopted the fld approach , whereas heracles and nike are based on the two - moment approach .",
    "thus castro carries the limitations of fld , such as poor accuracy for optically - thin flows .",
    "however , fld is computational cheaper than the two - moment approach .",
    "moreover , for multigroup radiation , fld is much less memory intensive than the two - moment approach .",
    "the current implementation uses a gray approximation based on the frequency - integrated formulation of the radiation hydrodynamics equations .",
    "we note that numerical codes exist for multigroup flux - limited radiation hydrodynamics ( e.g. , * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "it is straightforward to extend our scheme to multigroup radiation because the radiation pressure in the hyperbolic subsystem is still a frequency - integrated quantity for multigroup radiation .",
    "a multigroup neutrino - radiation hydrodynamics solver is also currently under development .",
    "the authors would like to thank eric myra , doug swesty and michael zingale at stony brook university for a number of helpful discussions about radiation hydrodynamics .",
    "the work at lbnl was supported by the office of high energy physics and the office of advanced scientific computing research of the u.s .",
    "department of energy under contract no .",
    "de - ac02 - 05ch11231 .",
    "the work performed at llnl was supported by the scidac program of the u.s .",
    "department of energy under the auspices of contract no .",
    "de - ac52 - 07na27344 .",
    "adam burrows was supported by the scidac program of doe under grant number de - fg02 - 08er41544 , the nsf under subaward no .",
    "nd201387 to the joint institute for nuclear astrophysics , and the nsf petaapps program , under award oci-0905046 via a subaward no .",
    "44592 from louisiana state university to princeton university .",
    "this research used resources of the national energy research scientific computing center , which is supported by the office of science of the u.s .",
    "department of energy under contract no .",
    "de - ac02 - 05ch11231 .",
    "falgout , r. , & yang ,",
    "u. 2002 , in lecture notes in computer science , vol . 2331 , computational science",
    " iccs 2002 , ed .",
    "p.  sloot , a.  hoekstra , c.  tan , & j.  dongarra ( springer berlin / heidelberg ) , 632641"
  ],
  "abstract_text": [
    "<S> we describe the development of a flux - limited gray radiation solver for the compressible astrophysics code , castro . </S>",
    "<S> castro uses an eulerian grid with block - structured adaptive mesh refinement based on a nested hierarchy of logically - rectangular variable - sized grids with simultaneous refinement in both space and time . </S>",
    "<S> the gray radiation solver is based on a mixed - frame formulation of radiation hydrodynamics . in our approach , </S>",
    "<S> the system is split into two parts , one part that couples the radiation and fluid in a hyperbolic subsystem , and another parabolic part that evolves radiation diffusion and source - sink terms . </S>",
    "<S> the hyperbolic subsystem is solved explicitly with a high - order godunov scheme , whereas the parabolic part is solved implicitly with a first - order backward euler method . </S>"
  ]
}