{
  "article_text": [
    "over the past few years cosmological measurements have become much more precise and the need for correspondingly accurate theoretical predictions is rapidly growing .",
    "upcoming measurements of weak gravitational lensing and galaxy clustering at high redshift are expected to reach percent level accuracy on scales where non - linear gravitational effects are important . on these scales",
    "there are a number of difficult challenges that must be overcome before percent level precision in the theoretical models can reliably be obtained .",
    "for example , baryonic effects must be properly taken into account ( see e.g.  @xcite for a recent discussion of the required accuracy ) .",
    "another important issue is the presence of massive neutrinos in the universe .",
    "even though neutrinos are very light , they do contribute to cosmic structure formation and have an impact which is certainly larger than the accuracy goal .",
    "this has led to a number of analytic or semi - analytic studies of non - linear gravitational clustering with neutrinos , using either higher order perturbation theory or renormalisation group methods inspired by field theory @xcite .",
    "even though such methods are extremely important , in particular in the pseudo linear regime , they must be checked and/or calibrated using high precision @xmath0-body simulations , and they are hard to combine self consistently with @xmath0-body models including baryon physics .",
    "early simulations including massive neutrinos were exclusively done in mixed dark matter models with high neutrino masses and no dark energy ( see e.g.  @xcite ) .",
    "however , observations strongly suggest that the underlying cosmological model is a variant of the @xmath1cdm model with relatively modest neutrino masses of approximately 1 ev or less .",
    "of course it should be noted that current data actually favours more than the 3 neutrino degrees of freedom predicted by the standard model ( see e.g.  @xcite ) , and that an additional sterile neutrino with a mass around 1 ev might explain this , as well as the observed short baseline neutrino oscillation anomalies ( see e.g.  @xcite for recent discussions of the short baseline anomaly ) .",
    "neutrinos are well known to be difficult to handle in structure formation simulations .",
    "the reason is that for reasonable values of the neutrino mass , the thermal velocities of typical neutrinos vastly exceed the gravitational flow velocities until very late in the evolution of the universe .",
    "this in turn leads to very short time steps and thermal poisson noise in the simulations unless very large numbers of neutrino particles are used .",
    "this problem has been addressed in a number of different ways , for example by evolving the neutrino density on a grid , or by a combination of grid and particle methods .",
    "while such simulations can achieve high accuracy they are cumbersome and complex to run .",
    "we refer the reader to a number of papers discussing these issues @xcite .    here",
    "we present a much simpler approach , based on the assumption that neutrinos can be treated as a perfect fluid with a finite sound speed . while this assumption is manifestly wrong , we demonstrate that quantities such as the matter power spectrum can be calculated with high accuracy ( reaching an accuracy of 1 - 2% over the relevant range of scales ) in such simulations which have the advantage of being very fast and simple to run .    in the next section we briefly outline the theoretical framework for treating neutrinos in structure formation .",
    "in section 3 we describe our implementation on massive neutrinos as a fluid in the publicly available gadget-2 code , and in section 4 we provide a detailed description of our results , including convergence tests .",
    "finally section 5 contains a discussion and our conclusions .",
    "[ nusph ] describes the small changes necessary to add neutrino particles to the latest public version of the gadget-2 code .",
    "a link to a working version is also provided .",
    "in this subsection we will briefly outline how the evolution of massive neutrinos is followed in linear theory .",
    "the notation is identical to @xcite .",
    "we use the metric in the conformal newtonian gauge    @xmath2    in a perturbed universe the phase - space distribution function is expanded to first order as follows @xmath3 with the perturbation parametrised by @xmath4 , and the zeroth - order fermi - dirac phase - space distribution function given by @xmath5 here @xmath6 , where @xmath7 is the proper redshifting momentum and @xmath8 is the neutrino temperature today .",
    "after neutrino decoupling the collisionless boltzmann equation evolves the distribution function as    @xmath9    expanding the perturbation @xmath10 in a legendre series the perturbed neutrino energy density is given by a weighted sum over neutrino momentum states    @xmath11    where @xmath12 .    from the boltzmann equation the @xmath13 s are related to each other and the metric potentials by @xmath14 the second term on the right hand side of the equation for @xmath15 encodes the effect of structure formation in evolving gravitational potentials , whereas the first term incorporates the effect of velocity on structure formation .",
    "the change in velocity is affected by the three terms on the right hand side of the equation for @xmath16 .",
    "the first term encodes the effect of flow velocities redshifting in an expanding universe , whereas the second term , found from the hierarchy of @xmath17 s , incorporates the effect of momentum ( and redshift ) dependent neutrino free - streaming .",
    "these two terms give rise to less structure , whereas the last term in the equation for @xmath16 gives the acceleration as a gradient of the gravitational potential .",
    "the above set of hierarchy equations can formally be integrated to give the fluid equations @xcite @xmath18 where @xmath19 is the density contrast , @xmath20 is the fluid velocity perturbation , @xmath21 is the equation of state , and @xmath22 is the anisotropic stress .    for a perfect fluid we have @xmath23 and",
    "the hierarchy can be truncated at @xmath24 .",
    "this reduces the boltzmann equation to the usual continuity and euler equations .",
    "even though this is formally not allowed for massive neutrinos the system of equations could still be truncated by assuming a relation between @xmath22 and the effective sound speed , @xmath25 , in the system .",
    "this approach was taken in @xcite and shown to provide reasonable accuracy when tracking the linear evolution of neutrino perturbations .",
    "since neutrinos are a subdominant component in structure formation ( except in sterile neutrino warm dark matter scenarios ) , a relatively small error in the neutrino component translates into a much smaller error in such quantities as the total matter power spectrum .    in the neutrino fluid approach",
    "it is assumed that neutrinos behave like a perfect fluid with sound speed squared , @xmath26 , given by @xmath27 where @xmath28 is the velocity dispersion of neutrinos , given by their effective temperature , and @xmath29 is some function of redshift ( but not of position ) .",
    "@xmath30 is a constant of order 1 . in the non - relativistic limit",
    "we have @xmath31 , @xmath32 , and the above equations reduce to @xmath33    in the non - relativistic limit the neutrino velocity dispersion can be written as @xmath34 which in the same limit reduces to the following simple form @xcite @xmath35 and @xmath36 .",
    "again , we stress that this approach is manifestly not correct in the sense that a perfect fluid with finite sound speed exhibits acoustic oscillations on scales smaller than the jeans scale because of the @xmath37 term in the equation for @xmath38 while the true neutrino equations have a @xmath39 damping term which is not proportional to the local density . since the jeans scale for collisional particles",
    "is given as @xmath40 and the free - streaming scale for neutrinos is given as @xmath41 the relation in eq .",
    "( [ eq : cs ] ) ensures that the jeans scale is close to the free - streaming scale provided that @xmath42(1 )",
    ".    however , since the neutrino transfer function at the starting point of the @xmath0-body simulation has been evolved using the exact boltzmann equation hierarchy up to a point where the neutrino transfer function on small scales is orders of magnitude below the cdm transfer function , the most important point is _ not _ the difference between dissipation and oscillations , but just the fact that the neutrino transfer function can not grow on small scales .",
    "uncertainty on @xmath44 from a galaxy survey with effective volume @xmath45 10 ( gpc/@xmath46 @xcite . ]",
    "our simulations use the same cosmological parameters as in our previous studies , i.e.  they assume a flat , @xmath1cdm model with @xmath47 , @xmath48 , @xmath49 and @xmath50 .",
    "the scalar fluctuation amplitude is assumed to be @xmath51 . while these values are not preferred by current cosmological data , they are sufficiently close to the best fit values to produce qualitatively identical results . we have used a modified version of the gadget-2 particle - mesh n - body code @xcite to perform the simulations .",
    "unless otherwise stated , our simulations are performed in boxes of size 256 mpc/@xmath52 , using @xmath53 particles and a @xmath53 force mesh .",
    "this is more than adequate for our purposes and we have carefully checked that resolution is not a problem in our simulations .",
    "initial conditions are generated using camb to evolve the linear transfer functions until a redshift of @xmath54 , at which point a 2nd order lagrangian method is used to generate the perturbation field , as described in @xcite .",
    "we assume adiabatic fluctuations .",
    "we implement neutrinos in gadget-2 as a new sph particle type . however , instead of the normal sph equations we assume an isothermal neutrino gas where the only free parameter is the redshift dependent sound speed .",
    "this parameter is simply found by using the relation in eq .",
    "( [ eq : cs ] ) . given that in the normal gas formulation the isothermal sound speed is redshift independent this has to be encoded in the equations of motion for the sph particles . in gadget-2 a constant entropy formulation is used that allows for change in entropy only at shocks or due to external physics .",
    "we could use the explicit equations ( [ eq : cs ] ) and ( [ eq : cs2 ] ) , but for simplicity we instead use them to set the initial entropy , and then evolve the entropy forward using the simple evolution equation @xmath55 where @xmath56 is the time variable and @xmath57 is the effective entropy in gadget-2 .",
    "the treatment of neutrinos as a fluid induces acoustic oscillations at small scales .",
    "we do not want the oscillations to be reflected in the gravitational potential , and therefore it is essential to set the gravitational smoothing large enough that they do not impact the cdm .",
    "this is discussed below .",
    "finally we note that although we have used sph as a framework for treating neutrinos in the non - linear regime , a mesh implementation should work equally well .",
    "the total matter power spectra can reproduce results from the detailed hybrid code @xcite to a precision of approximately 1 - 2% up to @xmath58 , more than sufficient for analysing most upcoming data sets . in fig .",
    "[ fig : power ] we show the suppression of fluctuation power as a function of different neutrino masses up to 1.2 ev .",
    "the results are compared to the exact results from the hybrid code , and to results from linear perturbation theory . to provide an estimate of the maximum deviation tolerable",
    "we also show the statistical error on a power spectrum measurement from a galaxy survey with an effective volume of 10 ( gpc/@xmath46 . from the figure",
    "it can be seen that deviations between the @xmath43sph code and the hybrid codes are smaller than the statistical uncertainty at least up to @xmath58 . for illustration purposes we show cdm density plots from simulations with @xmath59 ev and 1.2 ev respectively in fig .",
    "[ fig : dens ] .",
    "however , the neutrino clustering is not reproduced to the same level of accuracy . as is the case for grid - based simulations ,",
    "an important ingredient has been removed .",
    "decoupled neutrinos have a distribution given by a relativistic fermi - dirac function .",
    "this means that even though the mean momentum is large , a small proportion of neutrinos will always have low initial momenta and be subject to gravitational clustering .",
    "this phenomenon was studied in great detail in @xcite and the neutrino density profiles in typical dark matter halos extracted . however , in the @xmath43sph approach the neutrino gas is treated as isothermal which in particle language is approximately equal to providing all neutrinos with the same initial thermal velocity . while this is a reasonable approximation to the real physical situation it fails to follow the small proportion of low momentum neutrinos that actually cluster in halos .    in terms of the neutrino power spectrum",
    "this can be seen as a lack of power at high @xmath60 .",
    "again , we stress that this is not a problem in most cases , i.e.  where the total matter power spectrum is studied : weak lensing , large scale structure surveys , lyman-@xmath30 surveys etc . however , the code is not well suited for studies of neutrino behaviour , for example in the context of relic neutrino detection . in practise the capability to follow the detailed neutrino distribution",
    "is rarely needed and the ease with which the @xmath43sph method can be implemented far outweighs its limitations .     for 0.6",
    "ev neutrinos in the @xmath43sph approximation ( black line ) and in the hybrid code ( red line ) . ]      the pronounced dip in suppression is located at the point where the @xmath1cdm model has gone non - linear while the @xmath61cdm model is still in the linear regime . at higher redshifts",
    "this point is located at higher values of @xmath60 , as can be seen in fig .",
    "[ fig:06evz ] .",
    "the amplitude of the suppression also increases because the overall power spectrum normalisation is lower at high redshift .",
    "we have checked explicitly that the @xmath43sph code produces results which are compatible with the hybrid code .",
    "[ fig:06evz ] clearly shows that the agreement between the two codes is even better at higher redshifts than at @xmath62 .",
    "( in order of decreasing amplitude on large scales ) for 0.6 ev neutrinos in the @xmath43sph approximation . ]      one important effect which must be taken into account is that if the effective softening length for sph particles is set too low , the system fails to properly track evolution not only of the sph system , but also the dominant cdm component .",
    "this can be seen in the total matter power spectrum in fig .",
    "[ fig : soft ] .",
    "the matter power spectrum drops steeply on scales smaller than the effective sound propagation scale . that this is indeed due to waves can be seen in fig .",
    "[ fig : waves ] where the right side panels clearly show oscillations in both the cdm and the neutrino components .",
    "what happens is that the strong waves in the neutrino component wipe out the cdm fluctuations before they become highly non - linear , except in a few very high density regions .",
    "when the softening length is increased the spurious acoustic waves vanish and the cdm system behaves as expected . we stress that in the simulations actually used to compare against the hybrid code , this is not an issue .",
    "we merely show figs .",
    "[ fig : soft ] and [ fig : waves ] for illustration purposes .",
    "sph simulations .",
    "black lines are @xmath63 simulations in a @xmath64 mpc@xmath65 box .",
    "the lines show the matter power spectrum for @xmath66 kpc , relative to a model with @xmath67 kpc .",
    "the red line shows the same for @xmath68 kpc relative to @xmath67 kpc , but for a @xmath53 simulation .",
    "as can be seen , the effect diminishes dramatically when a larger number of particles is used . ]      in fig .",
    "[ fig : velo ] we show the relative suppression for 0.6 ev for different values of the effective sound speed . for low values the overall suppression",
    "is systematically underestimated . however , for values around 0.2 and up , the small scale structure fits extremely well .",
    "there is a simple reason for this : on small scales neutrinos contribute almost nothing to the overall structure .",
    "even if they do cluster in halos , the fraction of halo masses in neutrinos is tiny .",
    "therefore it is a good approximation when calculating global quantities to treat neutrinos as non - clustering on sufficiently small scales .",
    "this behaviour is captured by our treatment and even though the method significantly under predicts the amount of power in the neutrino component on small scales it has no effect on quantities such as the power spectrum .    on larger scales ,",
    "the effective velocity must be tuned to fit with the linear theory prediction .",
    "simulations with too high a sound speed underestimate power on large scales , while the opposite is true for neutrino components too similar to cdm .    in conclusion :",
    "quantities such as the power spectrum are relatively robust against variations in the actual value of the effective sound speed on small scales , while on large scales it should be tuned to fit the linear theory prediction . in practise",
    "we find a value of @xmath30 around 0.2 - 0.3 to be accurate for any neutrino mass up to 1.2 ev .",
    "we have presented a very simple scheme for implementing neutrinos in @xmath0-body simulations using sph and the assumption that neutrinos behave as an ideal , isothermal fluid . while this assumption is wrong",
    "because neutrinos in reality are free - streaming , we have demonstrated that errors in quantities such as the matter power spectrum can be kept under control at the 1 - 2% level over all relevant scales , sufficient for analysing for example data from the upcoming euclid satellite mission .",
    "the reason is that although neutrino small scale clustering is severely underestimated in the @xmath43sph code , the contribution of neutrinos to small scale matter clustering is negligible and quantities such as the power spectrum can therefore be estimated quite accurately .",
    "the sph implementation presented here has a number of advantages over the hybrid neutrino code presented in @xcite : it is very easy to implement in existing codes , such as gadget-2 ( see [ nusph ] for how to implement it ) .",
    "the only requirement is the addition of a new sph particle type with a modified time - temperature relation . as for initial conditions ,",
    "the only required input is a set of transfer functions for cdm , baryons and neutrinos .",
    "this is in contrast to the hybrid code which requires solving the linear theory neutrino boltzmann equations either separately or in the @xmath0-body code .",
    "the hybrid code also necessitates solving the momentum dependent boltzmann equations and keeping this information as the @xmath0-body code is evolved forward in time .    while the @xmath43sph code fails to accurately map neutrino structures on small scales , it is more than adequate for power spectrum calculation .",
    "this in turn means that it is well suited for calculations of e.g.  weak lensing .",
    "cluster abundances can also be reliably calculated . as was demonstrated in @xcite ,",
    "the halo mass function in models with neutrinos can be accurately calculated by using the correct power spectrum and making the assumption that neutrinos do not contribute significantly to halo masses , i.e.  exactly the assumption needed for the sph approach to work .",
    "the only real drawback of the code is that it can not follow neutrino structures .",
    "however , this feature is only really needed for calculations of quantities such as the local neutrino density .",
    "in summary , the code presented here is more than sufficiently accurate and extremely easy to implement in existing @xmath0-body codes .",
    "for this reason the @xmath43sph method could well become the standard method for implementing neutrinos in structure formation simulations .",
    "particles in a 256 mpc/@xmath52 box , and the figures show slices of thickness 10 mpc/@xmath52 . ]",
    "box using @xmath63 resolution .",
    "the plot shows a slice of thickness 40 mpc/@xmath52 .",
    "top row is cdm , bottom neutrinos .",
    "the left column is with an sph softening of 4000 kpc/@xmath52 , and the right with a softening of 250 kpc/@xmath52 .",
    "the acoustic waves are seen in both the neutrino and the cdm components in the right column . ]",
    "we acknowledge computing resources from the danish center for scientific computing ( dcsc ) .",
    "patching a stock version of gadget-2 with sph neutrinos is very easy .",
    "it is only a matter of inserting @xmath69 lines of code .",
    "a stock version of gadget-2 patched with sph neutrinos can be found on http://phys.au.dk/~steen/nusph.tar.gz - but note that here the neutrinos replace baryons as particle type 0 .",
    "this means that in this version it is not possible to have both baryons and neutrinos , however this is easy to ameliorate should one wish to .",
    "a normal gadget-2 makefile can be used to compile this code , the only modification is to add opt+=-dneutrino_fluid . without this option the code behaves like the stock version .",
    "it is also necessary to add an omeganeutrino value in the parameter file .",
    "the above minimal sph neutrino code is based on gadget-2 version 2.0.7 , so to see the changes it is possible to do a simple    .... diff -r /path / to / gadget2 - 2.0.7_nusph / gadget2 /path / to / gadget2 - 2.0.7/gadget2 ....    between this version and a stock version of the gadget-2 code .",
    "it is not too much work to put in the extra code by hand in a modified gadget-2 code .",
    "it should also be possible to run a three - way merge , _ e.g. _",
    "diff3 , on each of the files allvars.h , begrun.c , global.c , hydra.c , init.c , io.c and read_ic.c and handle any conflicts .",
    "00 k.  heitmann , m.  white , c.  wagner , s.  habib , d.  higdon , astrophys .  j.   * 715 * , 104 - 121 ( 2010 ) .",
    "[ arxiv:0812.1052 [ astro - ph ] ] .",
    "c.  p.  ma and e.  bertschinger , astrophys .",
    "j.   * 455 * , 7 ( 1995 ) [ arxiv : astro - ph/9506072 ] .",
    "e.  komatsu _ et al .",
    "_ , arxiv:1001.4538 [ astro-ph.co ] .",
    "j.  brandbyge , s.  hannestad , t.  haugblle and b.  thomsen , jcap * 0808 * ( 2008 ) 020 [ arxiv:0802.3700 [ astro - ph ] ] .",
    "v.  springel , mon .  not .",
    "soc .   * 364 * , 1105 ( 2005 ) [ arxiv : astro - ph/0505010 ] .",
    "v.  springel , n.  yoshida and s.  d.  m.  white , new astron .",
    "* 6 * ( 2001 ) 79 [ arxiv : astro - ph/0003162 ] . m.  tegmark , phys .",
    "lett .   * 79 * , 3806 - 3809 ( 1997 ) .",
    "[ astro - ph/9706198 ] .",
    "a.  lewis , a.  challinor and a.  lasenby , astrophys .",
    "j.   * 538 * ( 2000 ) 473 [ arxiv : astro - ph/9911177 ] .",
    "l.  kofman , a.  klypin , d.  pogosian and j.  p.  henry , astrophys .  j.   * 470 * , 102 ( 1996 ) [ arxiv : astro - ph/9509145 ] ."
  ],
  "abstract_text": [
    "<S> we present a novel method for implementing massive neutrinos in @xmath0-body simulations . instead of sampling the neutrino velocity distribution by individual point particles we take neutrino free - streaming into account by treating it as an effective redshift dependent sound speed in a perfect isothermal fluid , and assume a relation between the sound speed and velocity dispersion of the neutrinos . </S>",
    "<S> although the method fails to accurately model the true neutrino power spectrum , it is able to calculate the total matter power spectrum to the same accuracy as more complex hybrid neutrino methods , except on very small scales . </S>",
    "<S> we also present an easy way to update the publicly available gadget-2 version with this neutrino approximation . </S>"
  ]
}