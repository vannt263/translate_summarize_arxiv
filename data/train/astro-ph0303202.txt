{
  "article_text": [
    "in an earlier paper ( lucy 2002 ; paper i ) , a technique for imposing the constraint of statistical equilibrium on monte carlo ( mc ) transfer codes was developed .",
    "this was achieved by first replacing the rate - equation representation of statistical equilibrium by one involving macroscopic energy flows and then quantizing these flows into indivisible energy packets .",
    "these @xmath4-packets - the mc quanta - contain either radiant energy ( @xmath0-packets ) or kinetic energy ( @xmath1-packets ) and undergo changes on interaction with matter in accordance with certain probabilistic rules .",
    "because these rules are analogous to the transition probabilities that govern a real atom s interactions with photons and electrons ( or other colliding species ) , they can be interpreted as ( mc ) transition probabilities that govern a _ macro - atom s _ interactions with @xmath0- and @xmath1-packets , with the macro - atom simply representing the atoms of a particular species in a finite volume element .",
    "in addition to providing its theoretical basis , paper i subjected the macro - atom formalism to various numerical tests , each of which concerned a single point in a stratified atmosphere . in the first group of tests ,",
    "the consistency of the scheme was confirmed by demonstrating that , when used with the exact level populations , the technique asymptotically reproduces the correct line- and continuum emissivities . but consistency , though necessary , does not guarantee that an effective nlte code can be developed with this technique . accordingly",
    ", paper i also tested the sensitivity of the mc emissivities to departures from the exact level populations , since extreme sensitivity would make it unlikely that the scheme would be successful in an iterative search for a nlte solution .",
    "fortunately , the emissivities were found to be remarkably insensitive to the level populations , thus suggesting good convergence characteristics .    given these successes with one - point tests ,",
    "the next step is evidently to apply the macro - atom formalism to a stratified medium .",
    "possible test problems are many and varied since the technique is quite general : potentially , it applies to multi - species plasmas , to multi - dimensional geometries , and to problems with non - radiative heating . but",
    "given the technique s novelty , step - by - step testing is advisable , starting with the simplest of problems .",
    "accordingly , this paper treats a 1-d medium comprising just one atomic species and subject only to radiative heating .",
    "specifically , the problem is to compute the level populations and kinetic temperature throughout the outer envelope of a type ii supernova , which we take to be pure hydrogen . in",
    "such extended , low density envelopes , substantial departures from lte arise due to the strong dilution of continuum radiation and to the negligible importance of collisional excitations .",
    "the technique s ability to solve non - trivial nlte problems is therefore tested .",
    "in particular , the convergence behaviour of the iterations required to obtain the level populations and the temperature stratification can be investigated . moreover",
    ", this test serves to illustrate the structure of nlte codes using the macro - atom formalism .",
    "in this section , the basic assumptions concerning the structure of the supernova and the relevant atomic physics are stated .",
    "in contrast to previous mc codes for sne ( lucy 1987 ; mazzali & lucy 1993 ; lucy 1999b ; mazzali 2000 ) , the interest here is to test technique rather than to construct a code immediately suitable for analysing observational data .",
    "accordingly , state - of - the - art modelling precision with respect to the sn envelope or to the atomic physics and radiative transfer is of no concern .      in formulating this test problem",
    ", we take the computational domain @xmath5 to be exterior to the layers where the energy released by radioactive decays is thermalized . then , with the further assumptions that the radiative cooling and recombination time scales are small compared to the expansion time scale , the principles governing spectrum formation are statistical and thermal equilibrium in every local co - moving frame within @xmath5 .",
    "because the energy sources are interior to the lower boundary ( @xmath6 ) of @xmath5 , this calculation does not predict the sn s luminosity @xmath7 , which is therefore a parameter . for the same reason ,",
    "a boundary condition at @xmath6 on the outwardly - directed radiation field is required .",
    "this is taken to be @xmath8 where @xmath9 , the black - body temperature , remains to be determined .    in eq .",
    "( 1 ) and throughout this paper , @xmath10 denotes frequency in the matter frame ; frequency in the rest frame will be denoted by @xmath11 .",
    "similarly , the energy of an @xmath0-packet in the matter and rest frames will be denoted by @xmath12 and @xmath13 , respectively .    the density distribution at time @xmath14 after the explosion is obtained as usual from the assumption of homologous expansion .",
    "thus @xmath15 where @xmath16 is the constant velocity of the mass layer that is at radius @xmath17 at time @xmath18 , and @xmath19 is the density - velocity profile at elapsed time @xmath18 .",
    "the profile adopted is that of arnett s ( 1988 ) explosion model for sn1987a .    with the further assumption of a pure h composition ,",
    "the atomic number density is @xmath20 .      for the problem",
    "thus defined , the basic parameters are @xmath14 and @xmath7 .",
    "the test calculation of sect .",
    "7 is carried out at @xmath21 days , and @xmath22 is required to be @xmath23 erg s@xmath24 , the value determined observationally for sn 1987a ( suntzeff & bouchet 1990 ) .",
    "in addition to setting parameters , the location of the lower boundary must be specified .",
    "this is taken to be the layer moving at @xmath25 km s@xmath24 , corresponding to @xmath26 cm .",
    "the mc calculation is performed for a discretized version of the sn s envelope .",
    "specifically , the envelope is modelled as @xmath27 constant - density spherical shells , within each of which the temperature @xmath28 and the level populations @xmath29 are also constant .    the independent variable is @xmath30 , in terms of which the shells have constant thickness @xmath31 , with @xmath32 and @xmath33 .",
    "the mean radius of the @xmath34th shell is defined to be @xmath35 , where @xmath36 .",
    "the density of the @xmath34th shell is then the value given by eq .",
    "( 2 ) at @xmath37 .",
    "the model h atom is that used in the one - point consistency test in sect .",
    "5.2 of paper i. thus there are 15 levels , with level 15 being the h@xmath38 continuum @xmath39 .",
    "the 14 bound levels correspond to principal quantum numbers @xmath40 and have consolidated statistical weights @xmath41 .",
    "transition probabilities and photoionization cross sections for hydrogen can of course be computed with arbitrary accuracy .",
    "accordingly , the oscillator strengths for bound - bound ( b - b ) transitions are derived from an accurate look - up table . but the continuous absorption coefficient is simplified by setting gaunt factors @xmath42 . thus , the cross section for photoionization from level @xmath43 is @xmath44 where @xmath45 is the cross section at the ionization threshold frequency @xmath46 .",
    "in the following three sections , a detailed account is given of how the internal radiation field in the sn s envelope is derived using the macro - atom formalism of paper i. this mc calculation is subsequently embedded in an outer iteration loop ( sect .",
    "6.5 ) in the search for the nlte solution .",
    "a random number generator is essential for every mc code . in this investigation ,",
    "the routine * ran2 * from numerical recipes ( press et al . 1992 ) is used , but with minor changes to convert to double precision .",
    "independent tests confirm the high quality of sequences of random numbers created with this routine .    in the rest of this paper ,",
    "the variable @xmath47 denotes a random number sampling a uniform distribution in the interval @xmath48 and thus indicates a call to * ran2 * in the mc code .      in paper",
    "i , three formulations of the macro - atom technique were presented .",
    "two concerned alternative treatments of stimulated emission ; and the third , moving media in the sobolev limit . here , in view of the large velocity gradients in a sn envelope , we treat line formation in the sobolev approximation and so follow the formulation presented in sect",
    ". 4.3 of paper i.    although accuracy is not of concern in this paper , it is nevertheless of interest that duschinger et al .",
    "( 1995 ) find that , in treating the formation of hydrogen lines in type ii sne , the sobolev approximation is as accurate as the comoving frame method .      because of the envelope s",
    "large optical depth in the lyman continuum , an @xmath0-packet in that continuum will propagate a negligible distance before it undergoes a bound - free ( b - f ) absorption .",
    "accordingly , a useful economy of computational effort is obtained by assuming that such packets are re - absorbed at the point of emission .",
    "this is the familiar ` on - the - spot ' approximation commonly used for models of photoionized nebulae ( e.g. , osterbrock 1974 ) .",
    "moreover , as for such models , this approximation is implemented for the dominant source of @xmath0-packets with @xmath49 by setting @xmath50 and @xmath51 , the ground state recombination and photoionization coefficients , to zero .",
    "of course , lyman continuum @xmath0-packets can in principle also be emitted by f - f emission and by recombinations to excited levels .",
    "such packets if they occur are re - absorbed in situ by activating a macro - atom to state @xmath39 .",
    "the above approximation effectively imposes an upper limit @xmath52 on the mc radiation field . in a second approximation ,",
    "a lower limit @xmath53 is also imposed .",
    "the reason for this is the @xmath54 dependence of f - f absorption as @xmath55 , which results in occasional jumps in estimates of @xmath56 , the f - f heating rate , when an @xmath0-packet is emitted with @xmath57 .",
    "the limit @xmath53 eliminates such jumps at the price of a slightly biased estimate of @xmath56 .",
    "the chosen lower limit @xmath58 , the ionization threshold of the highest bound level @xmath59 . to ensure that @xmath0-packets are not emitted with @xmath60 , we set oscillator strengths @xmath61 if @xmath62 and also exclude @xmath60 when sampling the f - f emissivity function .",
    "note that , in order to avoid loss of generality , these devices for imposing frequency limits are ignored in all subsequent formulae .",
    "a further approximation is the neglect in the transfer theory of all terms of @xmath63 except for the doppler effect ( mccrea & mitra 1936 ; lucy 1971,1999b ) . but",
    "apart from time - delay , it is quite straightforward to include relativistic effects in mc codes ( mazzali & lucy 1993 ) .",
    "the nlte solution must be obtained iteratively and so starting values are required for the basic variables . for every iteration except the first",
    ", the previous iteration s radiation field @xmath64 is available , as also are the corresponding temperatures @xmath28 and level - populations @xmath29 . for the first iteration ,",
    "initial guesses are required for these quantities .",
    "the initial mean intensity of the radiation field in the balmer and higher continua is taken to be @xmath65 where the dilution factor @xmath66 $ ] .",
    "the lower - boundary temperature @xmath9 , which also determines the frequency distribution of @xmath0-packets launched into @xmath5 at @xmath6 - see eq .",
    "( 1 ) , is initiated at @xmath67k .    with",
    "the radiation field specified , values of @xmath28 , @xmath29 and @xmath68 in each shell could be obtained by imposing the constraints of statistical and thermal equilibrium as described in sect .",
    "6 . instead",
    ", the simpler and cruder option is followed of assuming an isothermal stratification with @xmath69k and then obtaining the initial @xmath29 and @xmath68 from the saha and boltzmann formulae .      with the current estimates of @xmath64 , @xmath28 and @xmath29 ,",
    "the mc transition probabilities are computed for the next simulation of the radiation field . following an @xmath4-packet s capture by a macro - atom ,",
    "these probabilities determine stochastically the characteristics of the subsequently - emitted @xmath4-packet .",
    "the mc transition probabilities defined in paper i and in this paper involve _ ratios _ of the rates of various radiative and collisional processes . as in paper",
    "i , the formulae for such rates always refer to unit volume .    adopting the notation of paper i ,",
    "we define @xmath70 to be the total rate of the transition @xmath71 , with @xmath72 and @xmath73 denoting radiative and collisional rates . also , except where noted , the summation convention of paper i is assumed .",
    "thus suffixes @xmath74 and @xmath75 indicate summations over all levels @xmath76 and all levels @xmath77 , respectively .",
    "the probability that a macro - atom in state @xmath43 emits an @xmath0-packet and thus de - activates is then @xmath78 where @xmath79 is the excitation energy of level @xmath43 .",
    "the corresponding probability for the emission of a @xmath1-packet is @xmath80 in addition to the options of emitting an @xmath0- or a @xmath1-packet , a macro - atom in state @xmath43 can spontaneously jump to any other state @xmath81 .",
    "moreover , such internal transitions occur without the absorption or emission of an @xmath4-packet .",
    "the probabilities of internal transitions to the _ particular _ upper or lower states @xmath75 and @xmath74 are @xmath82 the above options for leaving state @xmath43 are complete ; consequently , @xmath83 as may readily be demonstrated .",
    "in order to compute these mc transition probabilities , the rates @xmath72 and @xmath73 must be specified .",
    "the rates of excitation and de - excitation due to collisions by thermal electrons are @xmath84 the rates of collisional ionization and recombination have the same form , except that the latter , being a three - body process , is @xmath85 .    for excitations , the coefficient @xmath86 is computed with van regemorter s ( 1962 ) approximate formula and the inverse coefficient @xmath87 by detailed balancing . for collisional ionizations , the coefficient @xmath88 is evaluated with the approximate formula given by mihalas ( 1978 , eq .",
    "[ 5 - 79 ] ) , with the inverse coefficient @xmath89 again obtained by detailed balancing .      the radiative bound - bound ( b - b ) rates are computed in the sobolev approximation as discussed earlier .",
    "thus , with stimulated emissions treated as negative absorptions , the radiative rates between bound level @xmath43 and a lower level @xmath81 are @xmath90 here the mean intensity @xmath91 refers to the far blue wing of the transition @xmath92 , and @xmath93 is the sobolev escape probability , given by @xmath94 where @xmath95 is the transition s sobolev optical depth . in the special case of homologous expansion , @xmath96 with @xmath14 being the elapsed time since the sn exploded .",
    "for the first iteration , the mean intensities @xmath91 are from eq .",
    "( 4 ) . for subsequent iterations",
    ", they are evaluated from the mc radiation field - see sect .",
    "the radiative processes coupling bound levels to the continuum are photoionizations and radiative recombinations .",
    "the rate coefficient for spontaneous recombinations to level @xmath43 is ( e.g. , mihalas 1978 , p.131 ) @xmath97 with @xmath98 where an asterisk indicates the level s lte population at the given @xmath28 and @xmath68 .",
    "the corresponding rate coefficient for stimulated recombinations @xmath99 is @xmath100 and that for photoionizations @xmath101 is @xmath102 in terms of the above , the total recombination coefficient for level @xmath43 is @xmath103 .",
    "if we treat stimulated recombinations as negative photoionizations , the radiative rates coupling @xmath43 and @xmath39 are @xmath104 and @xmath105 .",
    "this latter rate may be written as @xmath106 , where the corrected photionization coefficient @xmath107 is expressed in terms an absorption cross section @xmath108 which incorporates the nlte correction factor for stimulated emissions .",
    "the rates at which b - f and f - b transitions absorb and emit radiant energy are needed in the course of the calculation .",
    "these can conveniently be expressed in terms of modified photoionization and recombination coefficients .",
    "thus the rate at which photoionizations from level @xmath43 remove energy from the radiation field is @xmath109 , where @xmath110 comparison with eq .",
    "( 16 ) shows that this modified coefficient is obtained from the conventional one by changing @xmath111 to @xmath112 in the integrand s denominator .",
    "similarly , the corresponding rate at which spontaneous recombinations to level @xmath43 add energy to the radiation field is @xmath113 , where @xmath114 this modified coefficient is again obtained from the conventional one [ eq .",
    "( 13 ) ] by changing @xmath111 by @xmath112 in the integrand s denominator .",
    "following the same procedure , the modified coefficients @xmath115 and @xmath116 are also defined .",
    "thus stimulated recombinations to level @xmath43 emit radiant energy at the rate @xmath117 .",
    "but when treated as negative photoionizations , these stimulated recombinations reduce the rate at which photoionizations from level @xmath43 absorb radiant energy to @xmath118 .    in terms of the above ,",
    "the total rate at which recombinations to level @xmath43 emit radiant energy is @xmath119 , where @xmath120 .",
    "for the first iteration , the coefficients @xmath121 , @xmath122,@xmath123 and @xmath124 are derived by numerical integration with @xmath64 from eq.(4 ) . for subsequent iterations , they are evaluated using the mc radiation field - see sect . 6.2 . in terms of these coefficients , the corrected photionization coefficient @xmath125 and correspondingly for @xmath126",
    "this mc technique directly models the flow of energy through the domain @xmath5 by computing the interaction histories of numerous indivisible @xmath4-packets . in consequence of these interactions ,",
    "an @xmath4-packet is sometimes an @xmath0-packet and at other times a @xmath1-packet .",
    "accordingly , in this section , the probabilistic rules governing the emission and absorption of both @xmath0- and @xmath1-packets are developed .      in the absence of non - radiative heating in @xmath5 ,",
    "the desired solution satisfies the constraint of radiative equilibrium in the co - moving frame at every point in @xmath5 .",
    "this constraint is rigorously incorporated into the macro - atom formalism by not allowing active macro - atoms to appear or disappear spontaneously within @xmath5 .",
    "this then implies that every @xmath4-packet s interaction history both begins and ends as an @xmath0-packet crossing a boundary of @xmath5 ( sect .",
    "7.1 , paper i ) .",
    "accordingly , in the context of a spherically - symmetrical sn envelope , the creation of @xmath0-packets corresponds to a sampling of @xmath127 given by eq .",
    "( 1 ) .    in the previous sn and stellar wind codes , the initial energies @xmath128 of the packets were equal , independent of frequency . but",
    "now , in order that the weak radiation field between l@xmath129 and the lyman limit is well represented , @xmath0-packets are created in equal numbers in equal intervals of @xmath130 , with energies assigned in accordance with black body emission at @xmath9 .    despite @xmath0-packets no longer having equal initial energies ,",
    "mc estimators for integrals of the radiation field can be cast in familiar form if we take @xmath128 to be the _ unit _ adopted for measuring the energies of the packets .",
    "a convenient choice is defined by the equation @xmath131 where @xmath132 is the interval simulated by the mc experiment and @xmath133 is the number of @xmath0-packets launched across the lower boundary @xmath6 in time @xmath132 .",
    "now consider an @xmath0-packet representing emission by the lower boundary in the interval @xmath134 at @xmath10 during time @xmath132 .",
    "since the flux transported by @xmath127 in this interval is @xmath135 , this packet s energy in the co - moving frame is given by @xmath136 a total of @xmath137 packets with fractional energies given by eq .",
    "( 22 ) are created _ uniformly _ in @xmath138 in the frequency interval @xmath139 - see sect .",
    "notice that the values of @xmath138 are _ not _ obtained by random sampling .",
    "this is the one point in the calculation where stratified sampling can readily and safely be used to limit mc noise .",
    "the @xmath0-packets must also have their initial direction cosines @xmath140 specified .",
    "assuming zero limb - darkening for emission at the lower boundary - see eq .",
    "( 1 ) , we randomly sample this limb - darkening law by taking @xmath141 . the packet s initial rest energy is then @xmath142 .",
    "a macro - atom can be activated by a @xmath1-packet or an @xmath0-packet .",
    "the mc transition probabilities defined in sect .",
    "3.5 are then applied until the macro - atom de - activates .",
    "this occurs with the emission of a @xmath1-packet or an @xmath0-packet . if an @xmath0-packet is emitted , the next step is to assign @xmath10 .",
    "the relevant procedure depends on whether de - activation occurred from the continuum state or from a discrete state .      in this case",
    ", the emitted @xmath0-packet belongs to an emission line arising from atomic level @xmath43 .",
    "one of these lines must therefore be selected randomly , with due weight given to the lines emissivities . since the total emissivity of the lines @xmath144 is @xmath145 , where the @xmath146 are from eq .",
    "( 10 ) , the selection probability for the line @xmath71 is @xmath147 .",
    "if the line thus randomly selected is @xmath71 , the @xmath10 of the emitted @xmath0-packet is simply the transition s rest frequency @xmath148 .",
    "note that because we are using the sobolev approximation in the narrow - line limit , no sampling of an emission profile is required .      in this case",
    ", the emitted @xmath0-packet s @xmath10 is obtained by sampling the energy distributions of the spontaneous recombination continua ( sect .",
    "4.2.3 , paper i ) .",
    "this can be done by first selecting a continuum and then selecting a @xmath10 in that continuum .",
    "the emissivity due to spontaneous recombinations to level @xmath43 is [ cf .",
    "( 13 ) ] @xmath149 substituting for @xmath150 from eq .",
    "( 3 ) and integrating from @xmath46 to @xmath151 , we find that the integrated emissivity of the @xmath99 continuum is @xmath152 the selection probability for emission in the @xmath99 continuum is therefore @xmath153 .    if the selected continuum is @xmath99 , the next step is to sample its energy distribution .",
    "the emitted @xmath0-packet s @xmath10 is thus the solution of the equation @xmath154 substitution from eqs .",
    "( 23 ) and ( 24 ) reduces this equation to the simple formula @xmath155 note that @xmath0-packets emitted by macro - atoms de - activating from state @xmath39 represent only the loss of _ ionization _ energy - see sect.5.2 and fig.4 in paper i. but recombination emission also results in the loss of _ thermal _ energy .",
    "this loss is represented by ( some of ) the conversions of @xmath1-packets into @xmath0-packets - see sect .",
    "4.3.2 below .",
    "the mc transition probabilities defined in paper i model the effect of atomic levels on the frequency redistribution of absorbed radiant energy .",
    "another set of probabilities must now be defined to model the corresponding effect of interactions with the thermal pool . in this formalism",
    ", such interactions are represented by the emission and absorption of @xmath1-packets .",
    "note that in developing probabilistic rules for @xmath1-packets , we assume that b - f and f - f absorptions as well as collisional de - excitations and recombinations are all followed by an instantaneous re - adjustment of the thermal motions to a maxwell velocity distribution . accordingly ,",
    "when considering the elimination of @xmath1-packets , we use rate coefficients that assume a maxwell distribution for the thermal electons .      the interactions creating @xmath1-packets",
    "correspond to the mechanisms heating the gas .",
    "collisional de - excitations and recombinations convert excitation and ionization energy into heat .",
    "these processes are represented in this formalism as @xmath156 - i.e. , by the emission of a @xmath1-packet by an active macro - atom - see eq.(6 ) .",
    "a second heating mechanism is the conversion of radiant energy into heat by f - f absorptions . in this formalism",
    ", this corresponds to @xmath157 - i.e. , to the direct conversion of an @xmath0-packet into a @xmath1-packet without the mediation of a macro - atom .",
    "a third heating mechanism is the conversion of radiant energy into heat by b - f absorptions . for this mechanism ,",
    "an extended discussion is necessary since not all absorbed energy appears as heat .    in terms of the modified photoionization coefficient defined in sect .",
    "3.6 , the rate at which b - f transitions from level @xmath43 absorb radiant energy is @xmath158 . but each photoionization raises the ionization energy by @xmath159 .",
    "accordingly , from the total absorbed rate , the amount @xmath160 is used in ionizing the atoms , with only the remainder @xmath161 available to heat the gas .    the existence of these two channels might suggest that an @xmath0-packet undergoing a b - f absorption should be split . but this would lose the advantages of working with indivisible packets ( paper i , sect .",
    "1 ) . instead , therefore , the absorbed energy is assigned randomly to one or other of the channels .",
    "thus , with probability @xmath162 the @xmath0-packet activates a macro - atom to its continuum state @xmath39 - i.e. , @xmath163 .",
    "alternatively , with probability @xmath164 , the @xmath0-packet converts directly into a @xmath1-packet - i.e. , @xmath157 . in the first case , all of the @xmath0-packet s energy",
    "is converted into ionization energy ; in the second , all is contributed to the thermal pool .",
    "summing over all bound states , we find that the probability that a b - f absorption of an @xmath0-packet with frequency @xmath10 results in the creation of a @xmath1-packet is @xmath165 where @xmath166 is the probability that the b - f absorption occurred from level @xmath43 . now , since the macroscopic b - f absorption coefficient @xmath167 is given by @xmath168 where the corrected cross section @xmath169 is defined by eq .",
    "( 18 ) , the required probability @xmath166 is evidently @xmath170 the probabilities defined in this subsection are @xmath171 if @xmath172 for all @xmath10 . from eq . ( 18 ) , we see that this inequality is violated as @xmath173 if @xmath174 , where @xmath175 is the departure coefficient for level @xmath43 . in the numerical tests of sect .",
    "7 , minor violations of the condition @xmath176 occur for high levels of the model h atom , and these are probably due to the neglect of the recombinations into levels @xmath177 and therefore of the subsequent cascade contributions to the included levels . to avoid negative probabilities when this happens , we set @xmath178 in eq .",
    "( 18 ) if @xmath179 .      on the assumption that advection and conduction of thermal energy are negligible compared with radiative transport ( but note the possibilities of generalization ) , a @xmath1-packet is converted _ in situ _",
    "back into an @xmath0-packet , either directly ( @xmath180 ) or indirectly ( @xmath181 ) .",
    "the interactions eliminating @xmath1-packets correspond to the mechanisms cooling the gas , and their selection probabilities are determined by the mechanisms cooling rates .",
    "collisional excitations and ionizations convert heat into excitation and ionization energy .",
    "the total cooling rate provided by this mechanism is @xmath182 a second cooling mechanism is the conversion of heat into radiant energy by f - f emission .",
    "the cooling rate in this case ( e.g , osterbrock 1974 , p.44 ) is @xmath183 with the mean gaunt factor set @xmath184 , the coefficient @xmath185 ( cgs ) .",
    "a third cooling mechanism is the conversion of heat into radiant energy by f - b emission .",
    "the rate at which spontaneous recombinations @xmath99 convert thermal _ and _ ionization energy into radiant energy is @xmath186 - see sect .",
    "each such recombination releases @xmath112 of ionization energy , which is therefore being radiated at the rate @xmath187 . subtracting this from the previous expression and summing over bound states ,",
    "we find that the rate at which heat is radiated by spontaneous f - b transitions is @xmath188 with cooling rates thus specified , the selection probabilities are as follows : a @xmath1-packet is removed by a f - b transition ( @xmath180 ) with probability @xmath189 by a f - f process ( @xmath180 ) with probability @xmath190 and by a collisional process with probability @xmath191 . in this last case",
    ", the @xmath1-packet activates a macro - atom ( @xmath192 ) and so is not directly converted into an @xmath0-packet .",
    "note that the quantity subtracted in eq .",
    "( 33 ) , namely the rate of loss of ionization energy , is represented in this mc procedure by macro - atoms de - activating from state @xmath39 ( sect .",
    "4.2.2 ) . also cooling by stimulated recombinations does not appear in the above formulae because these recombinations , treated as negative photoionization , are allowed for when creating @xmath1-packets ( sect .",
    "the mc model of the radiation field in the sn envelope is built up from the trajectories of @xmath137 individual @xmath0-packets , starting from their launch into @xmath5 at @xmath193 and ending with their exit from @xmath5 , either by escaping to @xmath151 or by re - crossing the lower boundary .    as an @xmath0-packet propagates in @xmath5",
    ", it will typically undergo numerous geometrical and physical ` events ' .",
    "the geometrical events are simply crossings of the boundaries of the @xmath27 constant - density shells .",
    "but the more important _ physical _ events constitute the mc technique s treatment of the interactions of radiation and matter .    in describing how the packets trajectories are computed",
    ", it suffices to explain how to find the next event along one packet s trajectory .",
    "thus , we now suppose that an @xmath0-packet has just undergone event @xmath194 in its propagation history and that this occurred in shell @xmath34 .",
    "the task now is first to find the location and nature of event @xmath195 and then to compute the frequency @xmath10 and direction of propagation of the @xmath0-packet that emerges from this event .      immediately following event @xmath194 , the macroscopic coefficients of continuum absorption (",
    "@xmath196 , @xmath197 ) and scattering ( @xmath198 ) must be computed since the @xmath0-packet is either in a new shell or has changed its @xmath10 .    the b - f coefficient , corrected for stimulated emission , is given by eq .",
    "( 18 ) , where the @xmath29 are the current estimates of the nlte level populations in shell @xmath34 .",
    "the f - f coefficient @xmath197 is calculated with the standard formula but with mean gaunt factor @xmath42 , in accordance with the corresponding simplification for eq .",
    "( 3 ) .",
    "if @xmath199 is distance from event @xmath194 measured along the packet s trajectory and @xmath200 is the corresponding optical depth , then the pathlength @xmath201 between events @xmath194 and @xmath195 is determined by the equation @xmath202 where the beam s exponential decay with optical depth is randomly sampled by taking @xmath203 .",
    "continuum and line processes both contribute to @xmath200 .",
    "the continuum contibution is approximately @xmath204 where @xmath10 is the packet s frequency immediately following event @xmath194 .",
    "notice that the small changes in the extinction coefficient seen by the packet as its @xmath10 decreases along the trajectory between events @xmath194 and @xmath195 are neglected .",
    "this is justified since these changes @xmath205 as @xmath206 .",
    "the contribution of lines to @xmath200 is computed with the sobolev approximation in the narrow - line limit , according to which a line with sobolev optical depth @xmath207 attenuates an incident beam by the factor @xmath208 at the _ point _ where resonance occurs .",
    "thus @xmath200 undergoes _ discontinuous _ increments @xmath207 at the points @xmath209 where the packet s frequency @xmath210 equals one of the rest frequencies @xmath211 of the b - b transitions .",
    "accordingly , @xmath212 where the summation extends over all @xmath209 in the interval @xmath213 .",
    "moreover , at each @xmath209 , @xmath214 the above prescription for locating event @xmath195 applies only if it occurs within shell @xmath34 . if eq .",
    "( 36 ) is not satisfied in shell @xmath34 , event @xmath195 is geometrical , and the pathlength @xmath201 is then simply the distance from event @xmath194 to the point where the trajectory crosses into a neighbouring shell .",
    "if event @xmath195 occurs within shell @xmath34 then it is physical , due to either continuum extinction or a line absorption .",
    "the former is indicated if @xmath215 ; the latter otherwise .",
    "if the event is a continuum extinction , we decide between the three contributing mechanisms using a single random number : the event is an electron scattering if @xmath216 ; failing this , the event is a b - f absorption if @xmath217 ; failing this , the event is a f - f absorption .",
    "event @xmath195 is absorption in line @xmath1 if @xmath218 .",
    "but since @xmath219 has a discontinuity at @xmath209 , this solution of eq .",
    "( 36 ) is actually recognized by finding that @xmath220 .      with the nature of event @xmath195 determined ,",
    "the next task is to assign a frequency to the emitted @xmath0-packet .",
    "if event @xmath195 is geometrical , the @xmath0-packet is simply continuing its existing flight path into the new shell , and so the @xmath10 at the beginning of the ` new ' trajectory is identical to the @xmath10 at the end of the ` previous ' trajectory , namely the value at the boundary crossing .",
    "on the other hand , if event @xmath195 is physical , the nature of the event determines the procedure to be followed in assigning @xmath10 .      with electron scatterings treated as coherent in the comoving frame , the scattered @xmath0-packet s @xmath10 is identical to that of the incident packet .      if event @xmath195 is absorption by the transition @xmath221 , the immediate result is a macro - atom in state @xmath75 - i.e. @xmath222 .",
    "the next step therefore is the repeated application of the transition probabilities of sect .",
    "3.5 until the macro - atom de - activates .",
    "this was discussed at length in paper i and specifically illustrated in sect .",
    "5.5 of that paper with the 15-level h atom used here .",
    "the macro - atom de - activates with the emission of either a @xmath1- packet or an @xmath0-packet . in the former case ,",
    "the @xmath1-packet is eliminated in situ as described in sect .",
    "if the macro - atom de - activates with the emission of an @xmath0-packet , selection of @xmath10 depends on whether it was emitted from the continuum state @xmath39 or from one of the bound states @xmath143 .",
    "these cases were both discussed in sect .",
    "4.2 , where the selection procedures followed in assigning @xmath10 are given .",
    "if event @xmath195 was a f - f absorption , the immediate result is a @xmath1-packet which then in situ either converts into an @xmath0-packet or excites a macro - atom .",
    "the conversion @xmath180 occurs by f - b emission with probability @xmath223 or by f - f emission with probability @xmath224 ( sect .",
    "4.3.2 ) . for f - b emission ,",
    "the selection of @xmath10 for the emergent @xmath0-packet is the two step procedure described in sec .",
    "4.2.2 .    for f - f emission ,",
    "@xmath10 is selected by sampling this mechanism s emissivity function - i.e. , by solving the equation @xmath225 if the @xmath10-dependence of the velocity - averaged gaunt factor is neglected , @xmath226 and the solution is @xmath227 besides these two direct @xmath180 conversions , there is alternatively the indirect conversion @xmath228 , which occurs with probability @xmath191 and is due to collisional cooling . in this case , the macro - atom is activated to state @xmath43 with probability @xmath229 - see eq .",
    "application of the mc transition probabilities as in sect .",
    "5.4.2 then leads eventually to the emission of an @xmath0-packet .",
    "if event @xmath195 is a b - f absorption , the immediate result is either a @xmath1-packet ( sect .",
    "4.3.1 ) or a macro - atom in state @xmath39 .",
    "the selection probability is @xmath230 for the former and @xmath231 for the latter , where @xmath10 is the frequency of the incident @xmath0-packet .",
    "if this selection results in a macro - atom in state @xmath39 , the mc transition rules are applied as described in sect .",
    "5.4.2 until an @xmath0-packet is emitted .",
    "on the other hand , if the result is a @xmath1-packet , it converts in situ into an @xmath0-packet as described in sect .",
    "5.4.3 .",
    "re - emission following a physical event is assumed to occur isotropically in the matter frame , so the new direction cosine in every case is @xmath232 . for electron scattering",
    ", this is an approximation .",
    "but isotropic emission is exact for thermal processes - i.e. , for f - f and f - b emissions .",
    "it is also exact for the sobolev treatment of b - b emission in a homologously expanding flow since there is then no kinematically - preferred direction .",
    "if this technique is applied to a spherically - symmetric stellar wind , the expansion is no longer homologous and so b - b emission is angle dependent .",
    "specifically , the pdf to be sampled for the new direction cosine is @xmath233 $ ] , where @xmath234 is the intensity in the line s far - red wing of the radiation emitted by the line ( castor 1970 ; lucy 1971 ) .      if @xmath13 is the packet s rest energy during its free flight prior to event @xmath195 , then , at the event , @xmath235 , where @xmath236 is the velocity at that location and @xmath237 is the incident direction cosine .",
    "now , at every event , the incident and emergent @xmath0-packets have the same energy @xmath12 .",
    "accordingly , the packet s rest energy along its free flight following event @xmath195 is @xmath238 , where @xmath140 is the new direction cosine .    with the assignment of @xmath10 and @xmath140 and the updating of @xmath13 , the treatment of event @xmath195 is complete .",
    "the calculation therefore now returns to sect .",
    "5.1 to initiate the search for event @xmath239 .",
    "the trajectories of @xmath133 individual @xmath0-packets computed as described in sect .",
    "5 collectively constitute the mc estimate of the radiation field in @xmath5 .",
    "the next challenge is to use it to derive improved values of @xmath29 and @xmath28 for each of the @xmath27 constant - density shells .",
    "the mc estimate for the luminosity of the sn is @xmath240 where the summation is over the @xmath0-packets that escape to @xmath151 .    from this equation ,",
    "we derive an improved scale factor @xmath241 by requiring that @xmath242 has its specified value - see sect . 2.2 .",
    "the improved value of @xmath9 then follows from eq .",
    "( 21 ) .",
    "this improved scale factor is used below in computing the radiative rates needed for the statistical and thermal equilibrium calculations .",
    "the improved @xmath9 is used to determine the initial frequency distribution of @xmath0-packets ( sect .",
    "4.1 ) at the start of the next iteration .      in order to use the mc radiation field to improve the values of @xmath29 and @xmath28 ,",
    "estimators are needed for the radiative rate coefficients .",
    "fortunately , efficient estimators can be constructed with a procedure given in an earlier paper ( lucy 1999a ) .    in the context now of a moving atmosphere , the energy - density argument of lucy ( 1999a ) applied to a local co - moving frame yields the formula @xmath243 where the summation is over all trajectory segments @xmath244 in @xmath245 such that the @xmath0-packets frequencies @xmath246 fall in the interval @xmath247 .",
    "this equation is the building block that allows us to construct the required estimators .    for this problem ,",
    "@xmath245 in eq .",
    "( 43 ) is the volume of one of the spherical shells into which the envelope is discretized ( sect .",
    "but the estimators derived in this section are quite general : no particular geometry or symmetry is assumed .    if we use eq.(43 ) to derive an estimator for the photoionization coefficient given by eq .",
    "( 16 ) , the result is a summation , with the summed quantity being the integral of @xmath248 over the pathlength @xmath201 between consecutive events .",
    "but since every pathlength is confined to a single shell , @xmath249 as @xmath250 and so @xmath201 may be treated as a small quantity .",
    "this then implies that each @xmath201-integral can be approximated by a one - point quadrature . with this approximation ,",
    "the estimator for the photoionization coefficient for level @xmath43 is @xmath251 where @xmath10 is the packet s frequency at the mid - point of @xmath201 and the summation is over all @xmath0-packets in @xmath245 with @xmath252 .",
    "the efficiency of this estimator derives from not being restricted to @xmath0-packets that actually cause photoionizations .",
    "thus its precision greatly exceeds that of an estimator based simply on counting photoionizations in @xmath245 .",
    "in particular , this estimator returns a non - zero estimate of @xmath121 even if no @xmath0-packets cause photoionizations from level @xmath43 in a given shell , as commonly happens for the higher , less populated levels and in the outer , less dense shells .    applying the same procedure now to eq .",
    "( 15 ) , we obtain @xmath253 as the corresponding estimator for the rate coefficient of stimulated recombinations to level @xmath43 , with @xmath10 again evaluated at the mid - point of @xmath201 .",
    "this estimator s efficiency is a consequence of not being limited to @xmath0-packets that actually cause stimulated recombinations .",
    "the above estimators refer to transitions to and from the continuum . but",
    "statistical equilibrium also depends on the radiative rates of b - b transitions - see eq.(10 ) .",
    "thus we require an estimator for @xmath91 , the mean intensity at frequency @xmath254 - i.e. in the far blue wing of the transition @xmath92 .",
    "this can also be derived from eq.(43 ) .    for homologous expansion",
    ", there is no kinematically - preferred direction , and so the rate at which the frequency @xmath210 of an @xmath0-packet in free flight decreases with distance @xmath199 is independent of its direction of propagation . to the accuracy of this calculation - see sect .",
    "3.3 , this rate is @xmath255 .",
    "this equation gives the length @xmath244 of the trajectory segment within which @xmath10 is in the interval @xmath256 . substituting this value of @xmath244 into eq .",
    "( 43 ) , we obtain @xmath257 as an estimator for the mean intensity at @xmath254 . in this formula , @xmath258 is the packet s energy at the point where @xmath259 , and the summation is over all @xmath0-packets in @xmath245 that come into resonance with the transition @xmath92 .",
    "the efficiency of this estimator derives from it not being restricted to @xmath0-packets that actually undergo the b - b transition @xmath92 .",
    "accordingly , a non - zero estimate is usually returned even when no such transitions occur in @xmath245 .",
    "evidently , the estimate is zero only if no @xmath0-packets in @xmath245 happened to come into resonance during the mc calculation . to avoid such spurious zero estimates for @xmath91 ,",
    "a minimum value of @xmath133 is required ( lucy 1999b ) .",
    "the above estimators refer only to the radiative rates that enter the equations of statistical equilibrium .",
    "further quantities are required by the equation of thermal equilibrium .",
    "these include the coefficients @xmath122 and @xmath260 defined in sect . 3.6 .",
    "as is evident from their definitions , estimators for these quantities are obtained from those derived above for @xmath121 and @xmath261 simply by changing @xmath111 to @xmath112 in the factors @xmath262 - see eqs .",
    "( 44 ) and ( 45 ) .",
    "finally , an estimate is also needed for the heating rate due to f - f absorptions , @xmath263 if we separate out the dependence on level population by writing @xmath264 and then again apply eq .",
    "( 43 ) , the estimator for the coefficient is @xmath265 where the summation is over all pathlengths in @xmath245 and @xmath10 is evaluated at their mid - points .",
    "the summations in the above estimators are accumulated in the course of the mc simulation and are the only quantities concerning the internal radiation field that need to be stored .",
    "when the trajectories of all @xmath133 packets have been computed , the scale factor @xmath241 is determined as described in sect .",
    "6.1 and then used to convert the summations into the required rate coefficients .",
    "although the accuracy of these various estimators remains to be demonstrated , it is clear from their derivation that they are consistent . in other words , as @xmath266 _ and _ @xmath250 , they converge to the quantities being estimated .",
    "the required solution is in statistical and thermal equilibrium .",
    "accordingly , following each mc calculation , the equations representing both of these equilibria are used simultaneously to derive improved values of @xmath29 and @xmath28 throughout the envelope .",
    "nevertheless , it is convenient to discuss these equilibria separately .",
    "the equation of statistical equilibrium for level @xmath43 can be written in the form @xmath267 where @xmath268 denotes the total rate coefficient for the transition @xmath71 . specifically , for transitions between bound levels , we have [ cf .",
    "eqs ( 9 ) and ( 10 ) ] @xmath269 for excitations @xmath92 , and @xmath270 for de - excitations @xmath71 .",
    "in addition , for transitions coupling bound levels to the continuum , we have @xmath271 for ionizations",
    "@xmath272 , and @xmath273 for recombinations @xmath99 .",
    "( 49 ) applies to all levels @xmath274 .",
    "but since every source term is a loss term for another level , the sum of the left hand sides is zero , which implies that one of the equations is redundant .",
    "this leaves @xmath275 equations in the @xmath39 unknown level populations @xmath29 . to make the system determinate",
    ", we impose the constraint @xmath276 where @xmath277 is the known number density of h atoms - see sect . 2.1 .",
    "the coefficients @xmath268 depend on @xmath278 and on the @xmath29 of bound levels through the escape probabilities @xmath93 .",
    "accordingly , the system of equations defined by eqs . ( 49 ) and ( 54 ) is non - linear .",
    "but fortunately the system can be solved iteratively with a standard package for linear equations .",
    "thus the coefficients are evaluated with the current estimates of @xmath29 and then the system solved for improved estimates .",
    "these are then used to recompute the @xmath93 and hence the @xmath268 and the process repeated until convergence is achieved .",
    "however , at this point a limitation in the mc approach to nlte problems becomes apparent .",
    "the problem arises for the populations @xmath29 of closely - spaced levels near the continuum .",
    "monte carlo sampling errors in the estimated rates of the processes populating such levels can give rise to level inversions , and these then prevent convergence of the above back substitutions . to overcome this , the following stabilizing device is adopted : for each level @xmath81 , the @xmath29 of a higher level @xmath43 is replaced by @xmath279 if @xmath280 .    because this problem only arises for high levels in the outermost shells , its impact on the mc code s prediction of the sn s line- and continuum spectrum from the uv to the mid - ir is totally negligible .",
    "moreover , as expected , the occurrence of these spurious inversions decreases as the size of the mc simulation increases .",
    "for example , with @xmath281 in an envelope stratified into @xmath282 shells , inversions occurred in 13 shells starting at @xmath283 and affecting levels as low as @xmath284 . with @xmath133 increased to @xmath285 , inversions occur in only 5 shells starting at @xmath286 and the lowest affected level is @xmath287 . with a modest further increase to @xmath288",
    ", inversions seldom occur .",
    "nevertheless , problems requiring accurate population ratios for closely - spaced levels are perhaps best not tackled with mc methods .",
    "in addition to statistical equilibrium , the required nlte solution must also be in thermal equilibrium .",
    "this latter equilibrium is simply the condition that throughout the envelope @xmath289 where @xmath290 and @xmath291 are the total heating and cooling rates , respectively .",
    "given the physical processes included in this calculation , we have @xmath292 and @xmath293    in terms of the modified photoionization coefficient defined in sect .",
    "3.6 , the rate at which b - f transitions convert radiant energy into thermal energy is @xmath294 the corresponding rate at which f - b transitions convert thermal energy into radiant energy is @xmath295 the heating and cooling rates @xmath56 and @xmath296 due to f - f processes have previously been defined in eqs . ( 47 ) and ( 32 ) .",
    "the cooling rate @xmath297 due to collisional excitations is given by eq .",
    "( 33 ) , and the corresponding heating rate @xmath298 due to de - excitations is computed similarly .    when the mc model of the internal radiation field has been computed , the current values of a shell s level populations and temperature , @xmath299 and @xmath300 , do not in general correspond to thermal equilibrium - i.e. , @xmath301 . to eliminate this residual , we apply corrections @xmath302 and @xmath303 that satisfy the linearized version of eq.(55 ) , @xmath304 but a more convenient form of this equation follows from noting that each level s contribution to the net heating rate can be expressed in terms of heating ( @xmath305 ) and cooling ( @xmath306 ) coefficients",
    "- see eqs ( 48),(58 ) and ( 59 ) - so that @xmath307 .",
    "with this substitution , eq.(60 ) becomes @xmath308 where @xmath309 is computed by numerical differencing , and @xmath310 is the improved level population .",
    "( 61 ) is one equation in @xmath311 unknowns .",
    "but if we add it to eqs.(49 ) and ( 54 ) , we have @xmath311 equations in the @xmath311 unknowns @xmath29 and @xmath303 .",
    "this combined system of equations , representing statistical _ and _ thermal equilibrium , is solved by repeated back substitution as described in sect .",
    "6.3 . with each back substitution , the coefficients @xmath268 , @xmath305 , @xmath306 and @xmath312 are recomputed because of their dependences on @xmath29 , @xmath68 and @xmath28 .",
    "this simple iteration technique for finding @xmath29 and @xmath303 must often start far from the final solution and can then fail due to large initial corrections . to avoid such failures , an undercorrection factor @xmath313",
    "is applied to the corrections @xmath302 and @xmath303 , and the temperature change is further limited to @xmath314 , with @xmath315k . moreover , if the magnitude of the correction vector @xmath302 increases from one iteration to the next , the factor @xmath75 and the bound @xmath316 are both decreased . with these precautions",
    ", back - substitution proves to be a robust technique for solving the equations of statistical and thermal equilibrium .",
    "the iteration technique also fails when sampling errors contribution to @xmath317 itself implies a large correction @xmath303 .",
    "the only remedy in this case is to increase @xmath133 .",
    "the iterations are deemed to have converged when @xmath318k _ and _ @xmath319 , where the averaging is over levels @xmath320 because of the occasional spurious inversions of high levels ( sect .",
    "when the iterations have converged to this accuracy , the typical residuals for each shell are @xmath321 and similarly for the agreement between the source and sink terms , @xmath322 and @xmath323 , for all levels @xmath43 in eq.(49 ) . however , when the @xmath29 of a high level has been stabilized to avoid a spurious inversion , the fractional departure from statistical equilibrium rises to @xmath324 .      during the above ( inner ) iterations to find @xmath29 and @xmath28 , the pathlength summations of sect .",
    "6.2 are of necessity held fixed . in effect , therefore , the matter in each shell is brought into equilibrium with a _ fixed _ radiation field . accordingly ,",
    "if the mc radiation field were now to be recomputed with the improved @xmath29 and @xmath28 , these summations would change , and so statistical and thermal equilibrium would again be violated .",
    "evidently , an outer iterative loop is necessary if convergence to the nlte solution is to be achieved .",
    "the scheme adopted for these outer iterations is simply to repeatedly input the updated @xmath29 and @xmath28 from sect .",
    "6.4 into the mc calculation of sect .",
    "these outer iterations are continued until the changes in @xmath29 _ and _ @xmath28 from one outer iteration to the next can be attributed to mc sampling errors .",
    "the novelty of this iterative technique is that , despite well - documented convergence failures in various earlier applications ( see , e.g. , mihalas 1978 ) , we are relying on the @xmath3-iteration device of repeatedly bringing matter into statistical and thermal equilibrium with the just- updated mc radiation field .",
    "indeed , these @xmath3-iterations would also fail to converge _ if _ the radiation field were obtained by solving the equation of radiative transfer ( rte ) .",
    "but in this mc scheme , the radiation field is subject at every iteration to constraints that other iterative schemes only aim to achieve asymptotically .",
    "thus , even while @xmath29 and @xmath28 still depart from their equilibrium values , the constraint of radiative equilibrium in the matter frame is obeyed rigorously . moreover",
    ", the mc transition probabilities approximately incorporate the constraints that statistical equilibrium imposes on the frequency redistribution of absorbed radiant energy . in effect , therefore , the scheme introduces a _ constrained _ @xmath3-operator that , for sufficiently large @xmath133 , generates at every iteration a radiation field that is closer to the converged solution than would be the radiation field generated by the rte .",
    "the convergence of these constrained @xmath3-iterations is illustrated in sect .",
    "in sects . 3 - 6 , a detailed description has been given of how the mc model of the internal radiation field is derived and how it is used to improve level populations and temperatures throughout the envelope .",
    "but whether such improvements will actually result in convergence to the nlte solution remains to be demonstrated .",
    "crucial to the success or otherwise of this technique is the accuracy of the estimators developed in sect .",
    "6.2 . even with consistent estimators",
    ", the technique would have little current interest if adequate accuracy requires simulations with impossibly large @xmath133 . on the other hand ,",
    "if accurate rates are achievable with feasible values of @xmath133 , then the coefficients in , and therefore the solutions of , the equations of statistical and thermal equilibrium will differ little from those derivable with a standard transfer calculation .",
    "an obvious accuracy test would be to obtain an accurate solution of a nlte problem using a conventional code and then examine the convergence of mc solutions of the same problem as @xmath27 and @xmath133 increase .",
    "but a simpler procedure is followed here : the special case of free - streaming @xmath0-packets allows values of the various coefficients obtained with the mc estimators to be compared with values obtained by numerical integration .",
    "the mc code is easily modified so that @xmath0-packets propagate without interaction .",
    "each packet is then emitted as before from the moving lower boundary but thereafter conserves its @xmath13 and @xmath11 , while its @xmath12 and @xmath10 decrease along the trajectory because of the differential expansion .",
    "a further modification made for this free - streaming test is to omit stratified sampling of the @xmath0-packets frequencies at the lower boundary - see sect .",
    "thus , the @xmath133 bins in @xmath130 are here randomly not uniformly sampled . by",
    "thus not benefiting from stratified sampling , the results should be more typical of circumstances where the radiation field is created within @xmath5 rather than emitted by an artificial boundary condition .    at radius @xmath0 , the conical radiation field modelled by this free - streaming mc calculation",
    "has specific intensity @xmath325 , where @xmath326 is the frequency at @xmath6 of a photon that reaches @xmath0 with frequency @xmath10 and direction cosine @xmath140 . from this expression for @xmath327 ,",
    "the mean intensity @xmath328 can be computed to arbitrary accuracy by numerical integration .",
    "such calculations carried out at fequencies @xmath329 and at the mean radii @xmath330 then allow the estimator @xmath91 given by eq .",
    "( 46 ) to be tested .",
    "similarly , @xmath331 can be computed for a grid of frequencies and then used to obtain accurate values for the coefficients @xmath121 , @xmath122 , @xmath123 , @xmath115 and @xmath332 by numerical integration , thereby testing their mc estimators from sect .",
    "6.2 .    these comparisons , carried out for @xmath333 and @xmath334 , support the assertion of sect .",
    "6.2 that these estimators are consistent .",
    "thus numerical experiments indicate that the errors of the mc estimates @xmath335 as @xmath27 _ and _ @xmath336 , with no suggestion of bias .",
    "but if @xmath27 is fixed while @xmath336 , the estimators sampling errors @xmath335 but biases due to discretization errors remain . on the other hand , if @xmath133 is fixed while @xmath337 , biases @xmath335 but sampling errors become large , especially for the mean intensities @xmath91 .",
    "in addition to confirming the estimators consistency , this special case also suggests that acceptable accuracies are indeed achieved with feasible values of @xmath338 .",
    "for example , with @xmath282 and @xmath339 , the mc free - streaming simulation requires only about 3 min computer time and yet gives reasonably accurate coefficients .",
    "thus , in one such simulation , the means of the fractional and of the absolute fractional errors of the coefficients @xmath121 for @xmath340 and @xmath341 are @xmath342 and @xmath343 , respectively .",
    "these gratifyingly small errors are a consequence of the large number of @xmath0-packets contributing to the summation in eq .",
    "( 44 ) and confirm the efficiency of estimators constructed from eq .",
    "( 43 ) .",
    "the quantities least accurately estimated are the @xmath91 .",
    "thus , in the above simulation , the mean fractional and absolute fractional errors of the @xmath91 for the balmer lines in all shells are @xmath344 and @xmath345 , respectively . in this case",
    ", sampling errors clearly dominate over any systematic bias due to discretization errors .",
    "this is no suprise since the summation in eq .",
    "( 46 ) includes only those @xmath0-packets that are red - shifted into resonance with the transition @xmath92 .",
    "accordingly , even with @xmath339 , the number of packets contributing to the summation for a particular @xmath91 is not large .",
    "for example , in the case of the balmer lines , the number is @xmath346 at @xmath347 rising to @xmath348 at @xmath349 .",
    "these relatively large sampling errors for the @xmath91 are the main source of error for the coefficients in the equations of statistical equilibrium . of course",
    ", for a typical level , there are several source terms , some not even subject to sampling errors ; and so the fractional sampling error of the total input rate will be correpondingly reduced . nevertheless , for a level populated predominately by a single radiative b - b transtion , its @xmath29 will directly reflect the sampling error of the relevant @xmath91 .",
    "but since sampling errors differ from one iteration to the next , levels suffering this sensitivity will display fluctuating values of @xmath29 and so should not escape notice .      to investigate convergence to the nlte solution",
    ", the values of @xmath28 and @xmath29 throughout the envelope were monitored for 20 outer iterations in a calculation with @xmath282 shells and @xmath350 packets .",
    "the envelope s parameters are as specified in sect .",
    "2.2 , and the calculation is initiated as described in sect . 3.4 .",
    "thus , for the first iteration , the mc transition probabilities are computed with radiative and collisional rates corresponding to the initial analytical model of the radiation field -eq .",
    "( 4)- and to the inital guesses for @xmath29 and @xmath28 .",
    "for all subsequent iterations , the mc transition probabilities are computed from the mc radiation field via the mc estimators of sect .",
    "6.2 , and the @xmath29 and @xmath28 are the updated values resulting from bringing the matter into statistical and thermal equilibrium with the mc radiation field .",
    "figure 1 shows how the envelope s temperature stratification evolves from the initial @xmath351k as the iterations proceed .",
    "the corrections are seen to be substantial for iterations 1 - 4 and negligibly small thereafter .",
    "thus the scheme appears to converge at the fifth iteration , with the changes introduced at iterations 6 - 20 presumably being random fluctuations about the exact nlte solution .",
    "such fluctuations are expected because of different sampling errors in successive realisations of the mc radiation field .",
    "to support this claim that the scheme has indeed achieved rapid convergence to the close neighbourhood of the exact nlte solution , a separate nlte calculation has been carried out with line formation again treated in the sobolev approximation but now with the continuum radiation field approximated by the free - streaming model described in sect .",
    "7.1 . with the radiation field",
    "thus prescribed , the determination of @xmath29 and @xmath28 at radius @xmath0 from the equations of statistical and thermal equilibrium is a one - point problem .",
    "the coefficients in these equations are calculated with accurate numerical integrations as for the accuracy tests of sect .",
    "7.1 and then @xmath29 and @xmath28 obtained with the back - substitution iterations of sect . 6.4 .",
    "this one - point calculation has been carried out at several radii , with the results plotted as open circles in fig .",
    "the agreement with the mc solutions for iterations 6 - 20 is excellent .    given that the scheme has indeed converged and that the remaining temperature fluctations are therefore due to sampling errors",
    ", the next question is whether such fluctuations are unacceptably large .",
    "assuming convergence at iteration 6 , we derive an accurate estimate @xmath352 of the exact @xmath28 for each shell by averaging over iterations 6 - 20 .",
    "the standard deviation of the fluctuations @xmath353 can then be computed for each shell as well as a consolidated value @xmath354 for the entire envelope . for this simulation with @xmath350",
    ", we find that @xmath355k .",
    "temperature uncertainties of this magnitude are admittedly large compared to the nominal precision - often @xmath356 - achieved by conventional nlte codes .",
    "but in view of the parametric , geometrical and kinematic uncertainties associated with specifying the structure of any celestial object , errors of @xmath357k are completely inconsequential .    the amplitude of the fluctuations following convergence depend of course on @xmath133 . repeating the above simulation with @xmath339 and again averaging over iterations 6 - 20 , we find that @xmath354 increases to @xmath358k , consistent with the expected scaling @xmath359 .",
    "the convergence behaviour of the @xmath29 for the same 20 iterations of the above model with @xmath282 shells and @xmath350 packets is shown in fig . 2 for shell @xmath360 .",
    "again we see substantial corrections in the first few iterations followed by fluctations of moderate amplitude about the scheme s solution in the limit @xmath2 .",
    "as for the temperature iterations , the mc solution is compared to the accurate nlte solution for the conical radiation field of sect .",
    "the agreement is excellent for low levels and for the continuum ( @xmath39 ) but small discrepancies are evident for high levels . this probably reflects a small difference in the two calculations due to the device used in the mc calculation to avoid negative probabilities when @xmath361 - see sect .",
    "a further test of the accuracy of the converged @xmath29 is presented in fig .",
    "3 . in this diagram ,",
    "the variation with radius of the departure coefficients for several levels are compared to the corresponding values for the conical radiation field .",
    "the agreement is seen to be satisfactory .",
    "the behaviour of the h level populations in this sn envelope are qualitatively similar to those of the hydrogenic ion he@xmath38 in w - r winds ( hillier 1987 ) .",
    "in particular , photoionizations predominantly occur from level 2 , which behaves like a ground state , becoming overpopulated in the outer layers due to the dilution of the ionizing continuum shortward of @xmath3623646 and to the trapping of lyman @xmath129 photons .",
    "note that , because most h atoms are in the ground state for both the nlte and the lte solutions , the departure coefficient @xmath363 is almost exactly @xmath42 .",
    "accordingly , the values @xmath364 plotted in fig .",
    "3 directly indicate the decoupling of level @xmath365 from the ground state .",
    "given that the macro - atom formalism has now been extended to include interactions with the thermal pool , it is of interest to test this extension by repeating the consistency test of level emissivities described for h in sect .",
    "5.2 of paper i.    when the outer iterations have converged , the level populations , temperature and radiative rates appropriate to statistical _ and _ thermal equilibrium are known for each mass shell . from this information , the rates at which radiant energy is being converted to other forms can be computed for each of the processes operating . specifically , these are : conversions into excitation energy by b - b absorptions to levels @xmath366 ; conversion into ionization energy by b - f absorptions ; and conversions into thermal energy by b - f and f - f absorptions .",
    "these last two processes , labelled @xmath367 and @xmath368 , were not included in paper i , which treated only statistical equilibrium .    from these conversion rates ,",
    "a monte carlo test of the mc transition probabilities is carried out for each mass shell as follows : @xmath369 equal energy @xmath0-packets are assigned to these absorption channels in proportion to the computed conversion rates .",
    "those assigned to processes @xmath370 activate a macro - atom to state @xmath43 , while those assigned to processes @xmath367 and @xmath368 result in the creation of a @xmath1-packet .",
    "application of the mc transition probabilities then results eventually in the emission of an @xmath0-packet as described in sect .",
    "moreover , each emitted @xmath0-packet belongs to one of the @xmath371 emission processes representing the inverse of the above absorption processes .",
    "accordingly , when all @xmath372 packets have been absorbed and re - emitted , we have experimental values @xmath373 for each of the @xmath371 emission processes .    but the rates at which excitation , ionization and thermal energy is being converted in a given shell into radiant energy can be directly computed from the known level populations and temperature - i.e. , from the rates of the various b - b , f - b and f - f processes .",
    "thus , we can predict that @xmath374 of the @xmath372 packets should have been emitted by process @xmath43 .    in paper",
    "4 , the agreement of @xmath373 and @xmath374 was shown graphically . here ,",
    "more rigorously , we compute the values of @xmath375 for each mass shell .",
    "since there are 16 emission channels , we expect the experimental values of @xmath376 to be distributed as @xmath377 with @xmath378 degrees of freedom .",
    "thus , 50 percent of the values should be @xmath379 and 95 percent @xmath380    the results obtained after the 20th iteration for the model with @xmath282 discussed in sect .",
    "7.2 are as follows : the 20 values of @xmath376 range from 7.87 to 34.22 , with @xmath381 and @xmath382 .",
    "the outcome of this test is that the experimental values of @xmath376 are slightly biased to higher values than predicted by the @xmath377 distribution .",
    "however , given that the underlying model has departures from strict statistical and thermal equilibrium because of its own mc sampling errors , these results are in fact a strong confirmation that the extension of the macro - atom formalism to include interactions with the thermal pool has been carried out correctly .    as a further test of this conclusion ,",
    "values of @xmath376 were computed with the summation restricted to the three channels containing @xmath0-packets emitted by f - b and f - f processes . in this case , the values for all shells are @xmath383 , the 95 percent confidence limit for @xmath384 degrees of freedom .",
    "this eliminates the possibility that the above upward bias is due to poor predictions for the continuum channels .",
    "when the outer iteration loop has converged , the @xmath0-packets that escaped to @xmath151 during the last iteration provide a crude estimate of the sn s emergent spectrum .",
    "this is obtained by simply allocating each escaping packet s rest energy @xmath13 to its appropriate bin in a grid of rest frequencies .",
    "this crude spectrum is shown in fig . 4 for the above model with @xmath350 packets .",
    "in this figure , luminosity density is plotted against vacuum wavelength in the optical domain and , despite sampling errors , the p cygni line profiles of h@xmath129 and h@xmath385 are clearly seen .    if this mc code were intended for use in interpreting observational data , the crude mc spectrum shown in fig .",
    "4 would not be compared with the observed spectrum . instead , a far less noisy theoretical spectrum would be computed by following a procedure described earlier ( lucy 1999b ) .",
    "specifically , estimates of line- and continuum source functions can be derived from the same mc simulation and used to compute a high quality spectrum from the formal integral for the emergent intensity as a function of impact parameter .",
    "in paper i , the radiative and collisional interactions of an atomic species in statistical equilibrium with its environment was modelled in terms of macro - atoms being activated and de - activated by the absorption and emission of @xmath4-packets . in this paper",
    ", this macroscopic quantization has been extended to include interactions with the thermal pool on the assumption of local thermal balance - i.e. , @xmath386 .",
    "( but note that departures from thermal equilibrium due to non - radiative heating can be incorporated as described in sect .",
    "7.2 of paper i. )    with this extension , the macro - atom formalism allows mc transfer codes to obtain nlte solutions for stratified atmospheres . as a first test of this , this paper describes a mc code treating the formation of the h spectrum in a type ii sn , with the emphasis being on demonstrating the consistency of the technique as @xmath387 , the accuracy of the estimators of the various radiative rates for feasible values of @xmath133 , and the convergence behaviour of the constrained @xmath3-iteration scheme .",
    "given that consistency has been demonstrated and that the geometry - independent @xmath3-iteration scheme converges , applications to problems with arbitrary geometry and to multiple - species plasmas are now in principle possible .",
    "but considering the detail and resolution required to have impact on a current research topic , such problems will undoubtedly require a substantial increase in computational resources over those deployed here for a 1-d envelope of pure h. even with the efficient estimators of sect .",
    "6.2 , each cell in the numerical grid must still be traversed by numerous @xmath0-packets if adequate accuracy is to be achieved .",
    "this requirement obviously mandates a huge increase in @xmath133 for 2- and 3-d problems .",
    "but also in 1-d problems for _ static _ atmospheres , narrow line widths will demand large values of @xmath133 in order to get accurate b - b transition rates .",
    "a further problem arises if the lower boundary of the computational domain is at a large optical depth in the continuum .",
    "each @xmath0-packet s interaction history will then comprise numerous events and will often end with a recrossing of the lower boundary , thus reducing the number of @xmath0-packets traversing the cells in the outer atmosphere .",
    "this requirement for substantial computer resources suggests the use of a computer with numerous parallel processors .",
    "fortunately , this mc technique is extremely well suited for such machines , especially those with large shared memory .",
    "a mc transfer calculation can then be equally divided between the processors , each of which carries its task to completion with no exchanges of information or packets with other processors .",
    "following completion , the individual processors contributions to the estimator summations are added to obtain the radiative rates for all cells , which are then equally divided among the processors to solve the equations of statistical and thermal equilibrium .",
    "these remarks suggest that close to the maximum theoretical efficiency should be achievable .",
    "the long - term aim in devoloping the macro - atom formalism is to obtain accurate nlte solutions for multi - dimensional problems using mc methods .",
    "but the technique is likely to be of more immediate use in obtaining _ approximate _ nlte solutions with precision sufficient for current research problems .",
    "the reasons for optimism in this regard are that , even without the converged stratifications of temperature and level populations , the technique rigorously obeys radiative equilibrium and also provides remarkably accurate emissivites ( paper i , sect . 6 ) .",
    "thus , for some problems , adequate accuracy will be achieved by using analytic ionization and excitation formulae , as in previous stellar wind and sne codes , but then computing the radiation field with this mc technique replacing the earlier techniques that assumed coherent scattering ( abbott & lucy 1985 ) or downward branching ( lucy 1999b ) . for yet higher accuracy",
    ", ionization could be solved for while retaining an analytic excitation formula .",
    "compared to the full nlte problem , this greatly reduces the demand for large @xmath133 since estimates of b - b rates are no longer required .",
    "moreover , for each atomic species , the statistical equilibrium equations for perhaps thousands of levels are replaced by the ionization equations for just @xmath388 ions . despite this enormous simplification ,",
    "the anticipated loss of accuracy is slight in view of the afore - mentioned accurate mc emissivities .",
    "i am grateful to s.sim for a discussion on the potential application of parallel processors .",
    "abbott , d. c. & lucy , l. b. 1985 , apj , 288 , 679 arnett w.d .",
    "1988 , apj , 331 , 377 castor j.i . 1970 ,",
    "mnras , 149 , 111 duschinger m. , puls j. , branch d. , hoeflich p. , gabler a. 1995 , a&a , 297 , 802 hillier d.j .",
    "1987 , apjs , 63 , 947 lucy l.b . 1971 , apj , 163 , 95 lucy l.b .",
    "1987 , in : danziger i.j .",
    "eso workshop on sn 1987a , p. 417",
    "1999a , a&a , 344 , 282 lucy l.b .",
    "1999b , a&a , 345 , 211 lucy l.b .",
    "2002 , a&a , 384 , 725 mazzali p.a . , lucy l.b .",
    "1993 , a&a , 279 , 447 mccrea w.h . , mitra k.k .",
    "1936 , zs.f.ap . ,",
    "11 , 359 mihalas d. , 1978 , stellar atmospheres ( 2nd ed . ) .",
    "w.h.freeman & co. , san francisco osterbrock d.e .",
    "1974 , astrophysics of gaseous nebulae ( w.h .",
    "freeman & co. , san francisco ) press w.h . ,",
    "teukolsky s.a .",
    ", vetterling w.t . ,",
    "flannery b.p .",
    "1992 , numerical recipes .",
    "cambridge univ . press ,",
    "cambridge suntzeff n.b . ,",
    "bouchet p. 1990",
    ", aj , 99 , 650 van regemorter h. 1962 , apj , 136 , 906"
  ],
  "abstract_text": [
    "<S> the macroscopic quantizations of matter into macro - atoms and radiant and thermal energies into @xmath0- and @xmath1-energy packets initiated in paper i is completed with the definition of transition probabilities governing energy flows to and from the thermal pool . </S>",
    "<S> the resulting monte carlo method is then applied to the problem of computing the hydrogen spectrum of a type ii supernova . </S>",
    "<S> this test problem is used to demonstrate the scheme s consistency as the number of energy packets @xmath2 , to investigate the accuracy of monte carlo estimators of radiative rates , and to illustrate the convergence characteristics of the geometry - independent , constrained @xmath3-iteration method employed to obtain the nlte stratifications of temperature and level populations . </S>",
    "<S> in addition , the method s potential , when combined with analytic ionization and excitation formulae , for obtaining useful approximate nlte solutions is emphasized . </S>"
  ]
}