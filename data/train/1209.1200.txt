{
  "article_text": [
    "image simulations are becoming ubiquitous in observational astronomy .",
    "they are intensively used in topics as diverse as extragalactic astrophysics ( with public codes like skymaker @xcite , simage @xcite , shera @xcite , or the simulation package developed by the large synoptic survey telescope ( lsst ) team @xcite ) , cmb analysis ( e.g. @xcite ) , or supernovae ( e.g. @xcite ) .",
    "simulations are mainly used to forecast the results of an observation strategy and to test measurement methods .",
    "examples are given by the lsst simulations @xcite , the public shear testing program ( step ) and gravitational lensing accuracy testing ( great ) simulations @xcite , as well as individual works ( e.g. @xcite ) .",
    "in this work , we focus on simulations used for extragalactic wide - field astronomy . depending on their aim",
    ", such simulations will either be minimalist , like the great simulations which simulated simplistic individual galaxies on a mesh , or include most of , or all relevant cosmology , astrophysics , atmosphere physics and telescope characterization ( lsst ) . the step project ( using skymaker and simage )",
    "took an intermediate approach , where simulations look realistic , but without focusing much on any particular physics or observational apparatus .    depending on their emphasis ,",
    "the speed of simulation codes can vary greatly , from hours to days to simulate a quarter square degree ground - based image .",
    "however , if a simulation package is to be used as an integrated part of a method and pipeline calibration process , its speed becomes a driving parameter : a fast simulation code , used to calibrate an external measurement method , allows one to efficiently explore a larger parameter space for the measurement method or survey .",
    "the aim of this paper is to introduce the ultra fast image generator ( ufig ) , a fast simulation c++ code able to simulate realistic images on a timescale comparable to that needed by sextractor @xcite to analyze similar images ( i.e. , less than one minute for a 0.25 sq .",
    "image ) ; since it is widely used in astronomy and is well optimized , we take sextractor as a reference . to this end , we adopt simple , yet realistic , models of galaxies , stars and observation conditions , that allow us to minimize the computation load . we also bring our code to the current computation limits by highly optimizing our implementation through an efficient use of random number generators , parallelization and vectorization .",
    "this fast code is thus complementary to end - to - end simulation packages aimed at detailed modeling of observational effects .    although the code may be used to simulate an image from various ground - based facilities and observation conditions , in this paper we use as a practical test case the simulation of a typical subaru suprimecam @xcite coadded 10k@xmath18k pixels image , processed from four 450-seconds exposures , with a 5-@xmath2 ( extended ) limiting magnitude of @xmath5 , unless otherwise stated .",
    "section [ sect_model ] summarizes the model that we use for galaxies , stars and noise .",
    "further details about it can be found in the appendices .",
    "section [ sect_req ] motivates the strategy used to optimize the simulation of realistic images , and section [ sect_implementation ] describes the implementation and the optimizations we use on the computational part of the problem ; in particular , we present how we optimize random numbers generation and implement multithreading .",
    "section [ sect_imcon ] explores the consistency of the ufig simulations with real images .",
    "section [ sect_perfs ] shows the performances of our code ; in particular , we show in this section how the execution time depends on the image s size and on the exposure time .",
    "we conclude in sect .",
    "[ sect_ccl ] .",
    "further details about ufig , including examples and information about the distribution of the code , can be found at http://www.astro.ethz.ch/refregier/research/software/ufig .",
    "the simulations are based on a simple , yet realistic , modeling of galaxies , stars and noise : the models are summarized in this section .",
    "the appendices expand on the astrophysics and the methods used to assess our models .",
    "we assume that galaxy profiles are well described by the sersic profile @xcite @xmath6 \\right),\\ ] ] where @xmath7 is the radius of the circle enclosing 50% of the total flux of the galaxy , @xmath8 is the sersic index , and @xmath9 is a constant satisfying the equation @xmath10 , where @xmath11 is the lower incomplete gamma - function , and @xmath12 is the gamma - function .",
    "we find the probability density function ( p.d.f ) of sersic indices for bright galaxies ( magnitude less than 20 ) to be well represented by @xmath13 , where @xmath14 represents the normal distribution of mean @xmath4 and variance @xmath15 ( see [ app_gals ] ) . for faint galaxies ( magnitude bigger than 20 ) , we describe it by @xmath16 .",
    "we parametrize the magnitude distribution of galaxies with a polynomial of the form @xmath17 .",
    "table [ tab_galscounts ] summarizes the coefficients @xmath18 for different filters .",
    "finally , we account for the galaxies intrinsic ellipticity distribution with a 2d gaussian ( of both components of the ellipticity ) of width @xmath19 .",
    "we use a moffat profile to account for the point spread function ( psf ) .",
    "the ( circular ) moffat profile is defined as @xcite : @xmath20^{-\\beta},\\ ] ] where @xmath21 is the value at the origin ( @xmath22 ) , and @xmath23 and @xmath24 are scale parameters depending on the observation s conditions .",
    "the width of the profile , @xmath23 , is related to its fwhm and to its half - light radius @xmath7 .",
    "we finally account for noise in the image .",
    "we first add poisson noise for galaxies and stars .",
    "we then add the noise from various sources , like the sky brightness , the readout noise and the errors arising during the data processing , such as flat - field inaccuracies .",
    "following e.g. @xcite , we define it as a gaussian random deviate with zero mean and standard deviation given by eq .",
    "( [ eq_fullnoise ] ) .",
    "we finally correlate the noise with a lanczos resampling @xcite .",
    "the main requirement of our simulation pipeline is that it must be fast , while providing realistic images .",
    "since sextractor has become the reference software for wide - field image analysis and is computationally efficient , we use its execution time on a given image as our unit of time . in that sense",
    ", we want the running time of the cycle simulation creation ( ufig )  simulation analysis ( sextractor ) not to be dominated by the execution of ufig , hence setting the requirement that ufig is not slower than sextractor .",
    "for instance , ufig should simulate a typical subaru suprimecam image of 0.25 sq .",
    "( made up of approximately 10,000@xmath18,000 pixels ) with a 5-@xmath2 limiting magnitude of @xmath25 under one minute .    to meet this goal , we must define the most efficient way to draw galaxies and stars , their generation being the most expensive task of a simulation code .",
    "we can think of two ways to simulate 2d objects such as galaxies and stars in an image from a given light distribution : ( 1 ) pixel - based and ( 2 ) photon - based .",
    "in the former case , an analytic description of the object is pixelized .",
    "the description can be a simple profile , which is simply pixelized by taking its value at the center of pixels , or by integrating it in pixels , or it can be more complex , as in a shapelets model @xcite .",
    "public simulation packages like skymaker , simage or shera rely on this principle .    in the second approach ,",
    "an analytical description of the object is considered as the distribution of the photons that make it up .",
    "photons are then drawn individually to make up the object .",
    "this approach is used e.g. by the lsst simulation group @xcite .",
    "the choice of the algorithm is determined by the total number of operations needed to create all the galaxies and all the stars of the simulation .",
    "these are described below .",
    "[ [ pixel - based - approach ] ] pixel - based approach : + + + + + + + + + + + + + + + + + + + + +    in this case , the elementary building block of an object is one pixel . to simulate one pixel",
    ", we first have to draw its value from the analytical description of the object .",
    "the value of the psf for that pixel is drawn in the same way , from an analytical description of the psf shape .",
    "an object should be made on a refined grid ( i.e. , using pixels smaller than those of the final simulations ) in order to minimize approximations of the profile at the center of pixels ; analytically integrating over pixels allows one to get rid of those approximations , but at the price of a more complex implementation .",
    "then , poisson noise must be applied to the pixel .",
    "finally , the object , once created , is convolved with the psf .",
    "this last step , albeit optimized by using ffts , is computationally expensive , even more if the object is refined so that numerical errors are minimized .",
    "[ [ photon - based - approach ] ] photon - based approach : + + + + + + + + + + + + + + + + + + + + + +    in this case , the elementary building block of an object is one photon . to simulate one photon , we draw its position from the analytical description of the object , seen as a distribution function . the effect of the psf is simply to displace the photon ; therefore , we just have to draw a random displacement from the analytical description of the psf , and apply it to the position of the photon .",
    "contrary to the pixel - based approach , no complex task ( such as a convolution ) has to be done at all .",
    "finally , since photons are drawn individually , poisson noise emerges naturally , with no need to add it eventually .    therefore , less operations are necessary to simulate a photon than to simulate a pixel . in the next subsection , we consider the number of photons and the number of pixels that we need to simulate to make an extragalactic subaru suprimecam - like image , before concluding on what approach we choose .",
    "number of photons ( thick black ) and number of pixels ( thin green ) sampled per magnitude per square degree .",
    "dash - dot lines represent the contribution of galaxies , dashed lines show that of stars , and solid lines show the total .",
    "diamonds and squares are photon counts from galaxies and stars from a typical subaru - suprimecam image in rc - band.,width=302 ]    the number of photons coming from galaxies per square degree and per magnitude can be computed from the magnitude distribution of galaxies ( eq . [ eq_magdist ] ) and the relation between the number of photons and the magnitude of a galaxy ( eq . [ eq_nphotons ] ) .",
    "a similar approach allows us to estimate the number of photons coming from stars . integrating those functions , it is easy to estimate the number of photons required for a photon - by - photon simulation .",
    "similarly , assuming that an average galaxy is contained in a 21@xmath121 postage stamp , and that we resample it by a factor of 5 when simulating it , we can estimate the number of sampled pixels per square degree and per magnitude in a pixel - by - pixel approach .",
    "the same exercise can be done for stars , assuming that the average postage stamp size is 61@xmath161 pixels ( stars are on average brighter and more spread out than galaxies ) .",
    "[ fig_nphotmag ] shows the number of photons per square degree and per magnitude ( black thick lines ) and the number of ( resampled by a factor 5 ) pixels required per square degree and per magnitude ( green thin lines ) . in both cases ,",
    "dash lines correspond to stars , dash - dot lines correspond to galaxies , and solid lines show the total number of photons and pixels .",
    "the symbols show photon counts from a typical subaru   gives the number of photons and pixels that one needs to sample to simulate a 0.25 deg@xmath0 image with an 450 seconds exposure time , from magnitude 12 to magnitude 29 .",
    "these numbers confirm the conclusions from fig .",
    "[ fig_nphotmag ] : the number of photons is highly dominated by stars photons , and the number of pixels is dominated by galaxies .",
    "furthermore , the number of photons needed to simulate galaxies is of the same order than the needed number of pixels .",
    ".[tab_ppn ] number of photons and pixels sampled for one ufig simulation . [ cols=\"^,^,^\",options=\"header \" , ]     the number of photons making up a galaxy of magnitude mag , for a single exposure time @xmath26 , in the ab - magnitude system , is given by : @xmath27 where @xmath28 is the effective telescope s mirror s surface , @xmath29 is the filter s central wavelength , @xmath30 the filter s width , @xmath24 is the atmospheric extinction , @xmath31 is the planck constant , and @xmath32 is the total throughput of the observation system @xmath33 .",
    "this number can be rescaled to simulate a galaxy on a coadded image with magnitude zero - point @xmath34 : @xmath35 where @xmath36 is the instrument magnitude zero - point , i.e. the magnitude corresponding to a flux of 1 adu for a one second exposure time in the same observing conditions , @xmath37 where gain is the ccd s gain and @xmath38 its quantum efficiency .",
    "we use the acs - gc catalog to parametrize the relation between the apparent magnitude and apparent size of galaxies . in this catalog , galaxies @xmath7 are estimated by fitting a sersic profile . since this catalog is shallower than the public data we used to estimate the magnitude distribution ( [ ssect_galscounts ] ) , we do not use it to parameterize the magnitude distribution , but use that derived above . the acs - gc data",
    "are therefore used only to analytically describe the relation between the magnitude and the size of galaxies .",
    "we find that in the @xmath39 plane , where @xmath40 and @xmath41 are the magnitude and the size rotated such that they become uncorrelated , and shifted such that they have zero mean , the distribution of the log of the size @xmath41 at a given magnitude @xmath40 is well fitted by a gaussian .",
    "additionally , given that the correlation angle between the size and the magnitude is small , we checked that the magnitude distribution derived in [ ssect_galscounts ] for the unrotated magnitudes is still a good fit to that of the rotated magnitudes @xmath40 .",
    "thus , we set a galaxy s magnitude and size such that : @xmath42 where @xmath43 and @xmath44 set the pivot point around which magnitudes and sizes are rotated .",
    "they are estimated from the magnitude and size means of cosmos , and are set to @xmath45 and @xmath46 .",
    "the correlation angle @xmath47 is set to 5.7 deg .",
    "the rotated magnitude @xmath40 is drawn from the distribution ( [ eq_magdist ] ) , and the log of the rotated size @xmath41 is drawn from a normal distribution of zero mean and standard deviation 0.19 arcsec .",
    "we checked that the magnitude - size relation does not depend significantly on the observing band , and therefore , we restrict its parametrization to what is presented here .",
    "we use a moffat profile to account for the psf .",
    "the ( circular ) moffat profile is defined in eq .",
    "( [ eq_moffat1 ] ) , where @xmath21 is the value at the origin ( @xmath22 ) , and @xmath23 and @xmath24 are scale parameters depending on the observation s conditions .",
    "for instance , for realistic atmospheric turbulences , @xmath48 @xcite .",
    "we use @xmath49 to account for instrumental effects ( especially diffraction ) .",
    "the profile s width @xmath23 is related to its fwhm by @xmath50 and to its @xmath7 by @xmath51 .",
    "contrary to the case of the sersic profile , the moffat profile can not be linked to a usual known distribution , from the p.d.f of which we can easily estimate the displacement to apply to a given photon in ufig .",
    "therefore , we sample the displacement by inverting the c.d.f of the profile .    the moffat profile , seen as the normalized p.d.f @xmath52 , where the random variable @xmath53 corresponds to the photon s displacement , is given by : @xmath54^{-\\beta}{\\rm d}x.\\ ] ] defining the variable @xmath55 , so that the p.d.f of @xmath56 is @xmath57 for @xmath58 , and integrating it , we obtain the c.d.f of @xmath56 : @xmath59    the displacement due to the psf is then obtained by inverting eq .",
    "( [ eq_cdf_moffat ] ) , the c.d.f .",
    "itself being uniformally sampled : @xmath60^{\\frac{1}{1-\\beta}}-1}.\\ ] ]    we parametrize the stars magnitude distribution with a polynomial fit to the milky way model derived in @xcite .",
    "given the position in the sky of the image we want to simulate , we extract the stars magnitude distribution from the corresponding online application @xcite .",
    "poisson noise is automatically and naturally accounted for when simulating galaxies in a photon - based approach .",
    "we add poisson noise for stars , and account for the noise from various sources , like the sky brightness , the readout noise and data processing , with a gaussian random deviate with zero mean and standard deviation ( see e.g. @xcite or @xcite ) : @xmath61 where @xmath62 is the readout noise of the camera , @xmath63 is the sky brightness in adus , @xmath64 is the number of exposures out of which the coadded image is assumed to be done and @xmath65 describes the noise coming from the data reduction ( including , but not limited to , flat - fielding inaccuracies ) . it should be noted that independently of the hybrid approach we use to simulate galaxies and stars , we treat the background noise at the pixel level , and therefore add it in adus to the noiseless image .",
    "finally , we resample our simulations with a lanczos filter to better mimic the data reduction process .",
    "we want to thank stefan mller and julien carron for useful discussions , as well as jason rhodes and richard massey for comments on the manuscript .",
    "we acknowledge the usage of the jet propulsion laboratory supercomputers , which are provided by funding from the jpl office of the chief information officer , and we thank jason rhodes for making this usage possible .    00 lsst science collaborations , abell , p.  a. , allison , j. , et al .  2009 , arxiv:0912.0201 berg , j. , price , s. , amara , a. , & rhodes , j.  2012 , mnras , 419 , 2356 bernstein , j.  p. , kessler , r. , kuhlmann , s. , et al .  2012 , apj , 753 , 152 bertin , e.  2009 , memorie della societ astronomica italiana , 80 , 422 bertin , e. , & arnouts , s.  1996 , a&as , 117 , 393 brent , r.p . , 1992 , proc . of fifth australian supercomputer conference , melbourne , dec . pp .",
    "704 - 706 brent , r.  p.  1994 ,",
    "mathematics of computation , 63 , 389 bridle , s. , balan , s.  t. , bethge , m. , et al .",
    "2010 , mnras , 405 , 2044 capak , p. , aussel , h. , ajiki , m. , et al .",
    "2007 , apjs , 172 , 99 chang , c. , kahn , s.  m. , jernigan , j.  g. , et al .",
    "2012 , arxiv:1206.1378 chang , c. , marshall , p.  j. , jernigan , j.  g. , et al .",
    "2012 , arxiv:1206.1383 delabrouille , j. , betoule , m. , melin , j .- b . , et al .",
    "2012 , arxiv:1207.3675 dobke , b.  m. , johnston , d.  e. , massey , r. , et al .",
    "2010 , pasp , 122 , 947 driver , s.  p. , allen , p.  d. , graham , a.  w. , et al .",
    "2006 , mnras , 368 , 414 duchon , c.  e.  1979 , journal of applied meteorology , 18 , 1016 furusawa , h. , kosugi , g. , akiyama , m. , et al .  2008 ,",
    "apjs , 176 , 1 grazian , a. , fontana , a. , de santis , c. , et al .",
    "2004 , pasp , 116 , 750 griffith , r.  l. , cooper , m.  c. , newman , j.  a. , et al .",
    "2012 , arxiv:1203.1651 heymans , c. , van waerbeke , l. , bacon , d. , et al .",
    "2006 , mnras , 368 , 1323 kacprzak , t. , zuntz , j. , rowe , b. , et al .  2012 , arxiv:1203.5049 kitching , t.  d. , balan , s.  t. , bridle , s. , et al .  2012 , mnras , 423 , 3163 lecuyer , p. , simard , r. , 2007 acm transactions on mathematical software , volume 33 issue 4 mandelbaum , r. , hirata , c.  m. , leauthaud , a. , massey , r.  j. , & rhodes , j.  2012 , mnras , 420 , 1518 massey , r. , heymans , c. , berg , j. , et al .",
    "2007 , mnras , 376 , 13 massey , r. , & refregier , a.  2005 , mnras , 363 , 197 matsumoto , m. , nishimura , .",
    ", 1998 , acm transactions on modeling and computer simulation : special issue on uniform random number generation , vol .",
    "1 , january 1998 , pp . 3 - 30 .",
    "http://mathworld.wolfram.com/legendre-gaussquadrature.html mccracken , h.  j. , radovich , m. , bertin , e. , et al .",
    "2003 , a&a , 410 , 17 meneghetti , m. , melchior , p. , grazian , a. , et al .",
    "2008 , a&a , 482 , 403 metcalfe , n. , shanks , t. , campos , a. , mccracken , h.  j. , & fong , r.  2001 , mnras , 323 , 795 miyazaki , s. , komiyama , y. , sekiguchi , m. , et al .",
    "2002 , pasj , 54 , 833 moffat , a.  f.  j.  1969 , aap , 3 , 455 perrett , k. , balam , d. , sullivan , m. , et al .",
    "2010 , aj , 140 , 518 refregier , a.  2003 , mnras , 338 , 35 refregier , a. , kacprzak , t. , amara , a. , bridle , s. , & rowe , b.  2012 , arxiv:1203.5050 robin , a.  c. , reyl , c. , derrire , s. , & picaud , s.  2003 , a&a , 409 , 523 http://model.obs-besancon.fr/ sersic , j.  l.  1968 , cordoba , argentina : observatorio astronomico , 1968 trujillo , i. , aguerri , j.  a.  l. , cepa , j. , & gutirrez , c.  m.  2001 , mnras , 328 , 977"
  ],
  "abstract_text": [
    "<S> simulated wide - field images are becoming an important part of observational astronomy , either to prepare for new surveys or to test measurement methods . in order to efficiently explore vast parameter spaces , </S>",
    "<S> the computational speed of simulation codes is a central requirement to their implementation . </S>",
    "<S> we introduce the ultra fast image generator ( ufig ) which aims to bring wide - field imaging simulations to the current limits of computational capabilities . </S>",
    "<S> we achieve this goal through : ( 1 ) models of galaxies , stars and observational conditions , which , while simple , capture the key features necessary for realistic simulations , and ( 2 ) state - of - the - art computational and implementation optimizations . we present the performances of ufig and show that it is faster than existing public simulation codes by several orders of magnitude . </S>",
    "<S> it allows us to produce images more quickly than sextractor needs to analyze them . </S>",
    "<S> for instance , it can simulate a typical 0.25 deg@xmath0 subaru suprimecam image ( 10k@xmath18k pixels ) with a 5-@xmath2 limiting magnitude of @xmath3 in 30 seconds on a laptop , yielding an average simulation time for a galaxy of 30@xmath4s . </S>",
    "<S> this code is complementary to end - to - end simulation codes and can be used as a fast , central component of observational methods relying on simulations .    </S>",
    "<S> simulations , wide - field imaging , computational speed </S>"
  ]
}