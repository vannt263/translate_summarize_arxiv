{
  "article_text": [
    "the constraint satisfaction problem ( csp ) consists of determining , given a finite set of variables with constraints on these , whether there exists an assignment of values to these variables that satisfies all the given constraints .",
    "the great flexibility of this framework has made the csp the focus of a great deal of attention from researchers in various fields ( see for instance the recent survey @xcite ) . in general the problem is * np*-complete , but restricting the type of constraint relations involved may yield tractable problems .",
    "in fact , schaefer @xcite and more recently @xcite have completely classified the complexity of boolean csp s and from their work it follows that boolean csp s are either trivial , first - order definable , or complete ( under @xmath0 reductions ) for one of the following standard classes of problems : * l * , * nl * , * p * , @xmath1*l * and * np*. one of the outstanding problems in the field is the so - called _ dichotomy conjecture _ @xcite that states that every csp should be either in * p * or * np*-complete .    in this paper",
    "we adopt the convenient point of view offered in @xcite where csp s are viewed as homomorphism problems with a fixed target . in other words , if @xmath2 is a finite relational structure , then @xmath2-csp consists of all structures that admit a homomorphism to @xmath2 .",
    "viewed this way , it becomes natural to ask which csp s can be described in various logics . for instance in @xcite , the result of allender et al .",
    "mentioned earlier is given a descriptive complexity analog , whereby it is shown that boolean csp s that lie in the classes * l * and * nl * are precisely those whose complement is describable in symmetric and linear datalog respectively . arguably the simplest csp s ( other than trivial ones ) are those whose members are describable by a first - order sentence . a very natural question in the vein of the dichotomy conjecture is then the following : can we determine ( easily ) from the constraint relations whether a given csp is first - order definable ?",
    "related questions for datalog and its restrictions remain open @xcite , @xcite .",
    "an important first step in this direction is atserias result @xcite proving that fo - definable csp s are precisely those with _ finite duality _ , i.e. those target structures @xmath2",
    "for which there exists a finite set @xmath3 of structures such that @xmath4 admits no homomorphism to @xmath2 precisely if some structure in @xmath3 admits a homomorphism to @xmath4 .",
    "this result was followed closely by the more general result for homomorphism - closed classes by rossman @xcite .    in this paper",
    ", we give several equivalent characterisations of fo - definable csp s .",
    "we first give a characterisation with an algebraic flavour : core structures with an fo - definable csp are characterised by the existence of special near - unanimity operations preserving their basic relations ( theorem [ core_nuf ] ) . for general structures",
    ", we prove that the problem of determining if @xmath2-csp is first - order definable is * np*-complete ( theorem [ foisnpc ] ) ; if the structure @xmath2 is a core , then in fact there exists a simple polynomial - time algorithm to determine this ( theorem [ focoreispoly ] ) .",
    "we shall also describe in this case a simple algorithm that produces a solution in polynomial - time ( theorem [ distohom ] ) .",
    "let @xmath2 be a core structure such that @xmath2-csp is first - order definable , and let @xmath4 be a structure with the same universe , such that the basic relations of @xmath4 are constraint relations `` inferred '' from those of @xmath2 , i.e. each is describable by a primitive positive formula with atomic formulas of the form @xmath5 with @xmath6 a basic relation of @xmath2 ; these inferred relations play a crucial role in the study of the complexity of csp s ( see e.g. @xcite ) .",
    "it is known that @xmath4-csp is logspace reducible to @xmath2-csp @xcite , but in general it will not be first - order definable .",
    "as a simple application of our algebraic characterisation of first - order definable csp s ( corollary [ 1antoa ] and proposition [ nuf ] ) we describe precisely which @xmath4-csp are first - order definable ; the others turn out to be * l*-complete , with their complement definable in symmetric datalog @xcite , a fragment of linear datalog .    to illustrate briefly the above results",
    ", we outline the algorithms in the special case of digraphs . for two vertices @xmath7 of a digraph @xmath8",
    ", we say that @xmath9 _ dominates _",
    "@xmath10 if every outneighbour of @xmath10 is also an outneighbour of @xmath9 and every inneighbour of @xmath10 is also an inneighbour of @xmath9 .",
    "if there exists a sequence @xmath11 of digraphs such that @xmath12 is obtained from @xmath13 by removing a dominated vertex for @xmath14 , we say that @xmath8 _ dismantles _ to @xmath15 .",
    "more generally , @xmath15 is a _ retract _ of @xmath8",
    "if there exists a homomorphism from @xmath8 to @xmath15 whose restriction to @xmath15 is the identity .",
    "the square @xmath16 of a digraph @xmath15 has vertex set @xmath16 where the arcs are the couples @xmath17 such that @xmath18 and @xmath19 are arcs of @xmath15 , and its diagonal @xmath20 is the set of vertices of @xmath16 with both coordinates equal .    the main algorithm to determine whether @xmath8-csp is first - order definable proceeds as follows : in @xmath21 , remove any dominated element outside the diagonal , if any .",
    "repeat this procedure until no element can be removed .",
    "if the resulting set is the diagonal , then the problem is first - order definable .",
    "assuming that @xmath8 is a core , i.e. that it has no proper retract , then the converse also holds .    , @xmath22 and @xmath23 . ]    in the figure above , @xmath24 is the transitive tournament on three vertices . in @xmath25 ,",
    "the two isolated vertices @xmath26 are dominated by all other vertices , the sources @xmath27 are dominated by @xmath28 and the sinks @xmath29 are dominated by @xmath30 .",
    "hence @xmath25 dismantles to @xmath31 , which shows that @xmath24-csp is first - order definable .",
    "in fact it is well known that a directed graph @xmath32 admits a homomorphism to @xmath24 if and only if there is no homomorphism from the directed 3-path @xmath22 to @xmath32 , and this condition is described by the first - order sentence @xmath33 , where @xmath34 denotes the existence of an arc from @xmath35 to @xmath36 .",
    "@xmath22-csp is not first - order definable ; indeed the path @xmath22 is a core and @xmath37 can only be dismantled down to @xmath38 .",
    "the square of @xmath23 can not be dismantled to its diagonal , but @xmath23 admits @xmath24 as a retract , whence @xmath23-csp is first - order definable . also , it is easy to check that @xmath39 dismantles to the `` graph '' @xmath40 of a homomorphism @xmath41 . in section [ psfocsp ] , we will see that such dismantlings of products can always be used to produce solutions of first - order definable constraint satisfaction problems .",
    "for basic notation and terminology with follow mainly @xcite and @xcite . a _ vocabulary _",
    "is a finite set @xmath42 of _ relation symbols _ , each with an _ arity _ @xmath43 assigned to it .",
    "a @xmath44-structure is a relational structure @xmath45 where @xmath46 is a non - empty set called the _ universe _ of @xmath2 , and @xmath47 is an @xmath43-ary relation on @xmath46 for each @xmath48 .",
    "we will use the same capital letter in blackboard bold and slanted typeface to denote a structure and its universe respectively .",
    "the elements of @xmath47 , @xmath49 will be called _ hyperedges _ of @xmath2 . for @xmath44-structures",
    "@xmath2 and @xmath4 , a _ homomorphism _ from @xmath2 to @xmath4 is a map @xmath50 such that @xmath51 for all @xmath52 , where for any relation @xmath53 of arity @xmath54 we have @xmath55 a @xmath44-structure @xmath4 is a _ substructure _ of a @xmath44-structure @xmath2 if @xmath56 and the identity map on @xmath57 is a homomorphism from @xmath4 to @xmath2 . for a subset @xmath57 of @xmath46 , the _ substructure @xmath4 of @xmath2 induced by @xmath57 _ is the @xmath44-structure with universe @xmath57 with relations @xmath58 for every @xmath48 . a substructure @xmath4 of @xmath2",
    "is called a _ retract _ of @xmath2",
    "if there exists a homomorphism @xmath59 from @xmath2 to @xmath4 whose restriction to @xmath57 is the identity ; the map @xmath59 is then called a _",
    "retraction_. a structure @xmath2 is called a _ core _ if it has no retract other than itself .",
    "it is well known ( see @xcite ) that every ( finite ) @xmath44-structure has a core which is unique up to isomorphism .",
    "let @xmath2 be a @xmath44-structure .",
    "we define the _ incidence multigraph _",
    "@xmath60 of @xmath2 as the bipartite multigraph with parts @xmath46 and @xmath61 which consists of all pairs @xmath62 such that @xmath53 and @xmath63 , and with edges @xmath64 joining @xmath65 to @xmath66 when @xmath67 .",
    "this allows us to import some basic concepts from graph theory : the _ distance _ @xmath68 between two elements @xmath69 and @xmath70 of @xmath46 is defined as half their distance in @xmath60 , the _ diameter _ of @xmath2 is defined as half the diameter of @xmath60 , and the _ girth _ of @xmath2 is defined as half the shortest length of a cycle in @xmath60 . in particular , @xmath2 has girth @xmath71 if and only if @xmath60 has parallel edges , and infinite girth if and only if @xmath60 is acyclic .",
    "notice in particular that tuples with repeated entries ( such as @xmath72 ) create parallel edges and hence cycles ; this property is not captured in the gaifman graph .",
    "we ll require a finer notion of tree below and this explains why we choose this variant of a ( multi)graph associated to a relational structure rather than the gaifman graph .",
    "although this presentation of the girth differs from that given in @xcite , the concept is the same and we can use the following erds - type result .",
    "[ largegirth ] let @xmath2 and @xmath4 be @xmath44-structures such that there exist no homomorphism from @xmath2 to @xmath4 .",
    "then for any positive integer @xmath73 there exists a @xmath44-structure @xmath74 of girth greater than @xmath73 such that there exists a homomorphism from @xmath74 to @xmath2 but no homomorphism from @xmath74 to @xmath4 .",
    "note that a @xmath44-structure of large girth must have large diameter unless it is acyclic .    a _ loop _ in a @xmath44-structure @xmath2 is an element @xmath65 such that @xmath75 for any @xmath48 ; equivalently",
    ", @xmath76 is a loop if and only if for every @xmath44-structure @xmath4 the constant map @xmath77 with value @xmath69 is a homomorphism . in particular , the image of a loop under a homomorphism is itself a loop . for an integer @xmath73",
    "the _ @xmath73-link _ of type @xmath78 is the @xmath44-structure @xmath79 such that @xmath80 for @xmath81 ( where @xmath43 is the arity of the relation @xmath82 ) .",
    "note that every @xmath83 is a loop in @xmath84 .",
    "link _ in an arbitrary @xmath44-structure is a homomorphic image of @xmath84 for some @xmath73 .",
    "the term `` path '' is more common than `` link '' , but we chose the latter to make it clear that these are not trees in the sense defined below .      a @xmath44-structure @xmath85 is called a _ @xmath44-tree _ ( or _ tree _ for short ) if @xmath86 is a tree , i.e. it is acyclic and connected .",
    "we require the following technical results :    [ treedecomposition ] for every @xmath44-tree @xmath85 with @xmath73 hyperedges , there is a sequence @xmath87 of subtrees of @xmath85 with the following properties : for each @xmath88    1 .   @xmath89 has @xmath90 hyperedges ;",
    "@xmath89 is a subtree of @xmath91 ; 3 .",
    "if @xmath92 is the hyperedge of @xmath91 which does not belong to @xmath89 then there exists a unique index @xmath48 such that @xmath93 is in the universe of @xmath89 .",
    "let @xmath94 be a path of maximal length in @xmath86 , where @xmath95 has more than one hyperedge .",
    "if @xmath96 , ( @xmath15 has to be a @xmath71-ary relation of @xmath44 ) , we obtain a new tree @xmath97 from @xmath85 by removing @xmath98 from @xmath15 . if @xmath99 , then @xmath100 , and we obtain a new tree @xmath97 by removing @xmath101 from @xmath15 and @xmath102 from @xmath103 . repeating this proceedure",
    ", we eventually obtain the desired decomposition .",
    "[ treesofagivendiameter ] let @xmath104 be a vocabulary .",
    "then for any integer @xmath73 the number of core @xmath44-trees of diameter at most @xmath73 is finite .    we will show that the number @xmath105 of core _ rooted _ trees in which the distance to the root is at most @xmath73 is finite .",
    "let @xmath106 be the number of relations in @xmath44 and let @xmath54 be the maximum arity of a relation in @xmath44 .",
    "we have @xmath107 , with equality only if @xmath108 .",
    "now suppose that @xmath109 is finite .",
    "for a rooted tree @xmath85 in which the distance to the root @xmath10 is at most @xmath73 , we can encode each hyperedge @xmath110 to which @xmath10 belongs by the name of the relation @xmath111 containing it ( there are at most @xmath106 choices ) , the index @xmath48 such that @xmath112 ( there are at most @xmath54 choices ) and the trees rooted at @xmath113 branching away from @xmath10 ( there are at most @xmath114 choices ) . if @xmath85 is a core , no two hyperedges can have the same label and @xmath85 is determined by its set of labels of hyperedges containing @xmath10",
    ". therefore @xmath115 .",
    "the @xmath44-structure @xmath4 is an _ obstruction _ for the @xmath44-structure @xmath2 if there is no homomorphism from @xmath4 to @xmath2 . a family @xmath116 of obstructions for @xmath2",
    "is called a _",
    "complete set of obstructions _ if for every @xmath44-structure @xmath4 that does not admit a homomorphism to @xmath2 there exists some @xmath117 which admits a homomorphism to @xmath4 .",
    "the structure @xmath2 is said to have _ tree duality _ if it admits a complete set of obstructions consisting of trees , and _ finite duality _ if it admits a finite complete set of obstructions . according to @xcite , for every finite family @xmath116 of @xmath44-trees",
    ", there exists a @xmath44-structure @xmath118 which admits @xmath116 as a complete set of obstructions ; and conversely every @xmath44-structure @xmath2 with finite duality admits a finite complete set of obstructions consisting of trees .",
    "thus the structures with finite duality form a subclass of the structures with tree duality , and there is one such core structure for every finite set of tree obstructions .",
    "an obstruction @xmath4 for @xmath2 is called _ critical _ if every proper substructure of @xmath4 admits a homomorphism to @xmath2 .",
    "it is clear that a critical obstruction is a core , and that every obstruction contains , as a substructure , a critical obstruction .",
    "[ fd = bd ] a @xmath44-structure @xmath2 has finite duality if and only if there is an upper bound on the diameter of its critical obstructions .    clearly , if @xmath2 has finite duality , then the maximum diameter of an obstruction in a finite complete set of obstructions for @xmath2 is an upper bound on the diameter of all critical obstructions for @xmath2 .",
    "conversely , suppose that the critical obsructions for @xmath2 have diameter at most @xmath106 .",
    "let @xmath119 be the set of core @xmath44-trees of diameter at most @xmath106 which do not admit a homomorphism to @xmath2 . by lemma  [ treesofagivendiameter ] , @xmath116 is finite . by lemma  [ largegirth ] , for any @xmath44-structure @xmath4 which does not admit a homomorphism to @xmath2",
    ", there exists a structure @xmath120 of girth at least @xmath121 which admits a homomorphism to @xmath4 but not to @xmath2 . a critical obstruction for @xmath2 contained in @xmath120 can not contain a cycle hence it must be a tree @xmath85 of diameter at most @xmath106 . therefore @xmath122 ; this shows that @xmath116 is a finite complete set of obstructions for @xmath2 .    for a @xmath44-structure @xmath2 ,",
    "the problem @xmath2-csp consists of determining whether an input structure @xmath4 admits a homomorphism to @xmath2 .",
    "it is said to be _ first - order definable _ if there exists a first - order sentence @xmath123 ( in the language of @xmath44 ) which is true on @xmath4 if and only if @xmath4 admits a homomorphism to @xmath2 . by a result of atserias @xcite",
    ", @xmath2-csp is first - order definable if and only if @xmath2 has finite duality , hence we have the following equivalences :    [ foequivalences ] let @xmath2 be a @xmath44-structure .",
    "then the following are equivalent .",
    "* @xmath2-csp is first - order definable ; * @xmath2 has finite duality ; * @xmath2 has a finite complete set of obstructions consisting of trees ; * the critical obstructions of @xmath2 have bounded diameter .",
    "we are mostly interested in the `` meta - problem '' of deciding whether an input structure @xmath2 has a first - order definable csp .",
    "the equivalences of theorem  [ foequivalences ] are not a usable decision procedure , but they will be used in the next two sections to find such a procedure . as a benchmark we state here feder and vardi s decision procedure for tree duality . given a structure @xmath45 , we define the structure @xmath124 , where @xmath125 is the set of all nonempty subsets of @xmath46 , and for @xmath126 , @xmath127 is the set of all @xmath43-tuples @xmath128 such that for all @xmath129 and @xmath130 there exist @xmath131 such that @xmath132 .",
    "[ tddecidable ] a @xmath44-structure @xmath2 has tree duality if and only if there exists a homomorphism from @xmath133 to @xmath2 .",
    "this proves that determining whether a given structure @xmath2 has tree duality is decidable , since a search for a homomorphism from @xmath133 to @xmath2 can be done in finite time . in section [ sectionconstructions ] ,",
    "we provide similar `` construction - and - homomorphism '' characterisations of first - order definable constraint satisfaction problems .",
    "however , we must first clear up a technical point concerning tree duality : indeed , feder and vardi s definition of a tree given in @xcite ( at the bottom of page 79 ) is slightly more general than the one given here , as it allows parallel edges in the incidence multigraph of a tree .",
    "nonetheless the corresponding concepts of `` tree duality '' turn out to be equivalent , as we show in the next section .",
    "in this section we prove that the notion of tree duality is the same whether we use the notion of tree as defined here or as defined in @xcite .",
    "[ treetoua ] let @xmath85 be a tree .",
    "then @xmath85 admits a homomorphism to @xmath2 if and only if @xmath85 admits a homomorphism to @xmath133 .    first note that the singletons induce a copy of @xmath2 in @xmath133 .",
    "thus , if a tree @xmath85 admits a homomorphism to @xmath2 , it also admits a homomorphism to @xmath133 .",
    "conversely , suppose that @xmath134 is a homomorphism .",
    "let @xmath135 be a decomposition of @xmath85 as described in lemma [ treedecomposition ] .",
    "we can define a sequence of homomorphisms @xmath136 as follows : @xmath137 has a single hyperedge @xmath138 for some @xmath53 .",
    "since @xmath139 is a homomorphism , by definition of @xmath140 there exist @xmath141 , @xmath142 , such that @xmath143 .",
    "this defines a homomorphism @xmath144 .",
    "now suppose that @xmath145 and @xmath136 is already defined .",
    "@xmath146 is obtained from @xmath147 by adding one hyperedge @xmath148 for some @xmath149 , where for exactly one index @xmath150 , @xmath151 belongs to the universe of @xmath147 .",
    "since @xmath139 is a homomorphism , by definition of @xmath133 there exist @xmath152 , @xmath153 , such that @xmath154 and @xmath155 .",
    "then @xmath156 is a well defined homomorphism from @xmath146 to @xmath2 .",
    "continuing in this way , we eventually define a homomorphism @xmath157 from @xmath85 to @xmath2 .",
    "the _ @xmath2 hyperedge consistency check _ is the following polynomial - time algorithm . at the start",
    "every element @xmath158 is assigned a list consisting of all the `` plausible '' images of @xmath70 under such a homomorphism ; initially this list is @xmath46 .",
    "then , the elements of @xmath57 are cyclically inspected to check whether their lists are still consistent with the local information : for every element @xmath70 , an element @xmath69 in the current list of @xmath70 is removed if there exists a relation @xmath159 and @xmath160 with @xmath161 for some @xmath90 such that there exists no @xmath162 with @xmath163 and @xmath164 in the list of @xmath165 for @xmath166 .",
    "the process continues until the lists stabilise .",
    "if at some point the list of an element becomes empty , the @xmath2 hyperedge consistency check is said to fail on @xmath4 , and otherwise it is said to succeed on @xmath4 .",
    "the following result gives an interpretation of these possible outcomes .",
    "[ hcc ] the @xmath2 hyperedge consistency check succeeds on @xmath4 if and only if there exists a homomorphism from @xmath4 to @xmath140 , and it fails on @xmath4 if and only if there exists a tree @xmath85 which admits a homomorphism to @xmath4 but no homomorphism to @xmath2 .",
    "if the @xmath2 hyperedge consistency check succeeds on @xmath4 , then by definition of @xmath133 the map @xmath167 assigning to every @xmath158 its final list @xmath168 is a homomorphism .",
    "conversely , if @xmath169 is a homomorphism , then again by definition of @xmath133 , the @xmath2 hyperedge consistency check will never eliminate an element @xmath170 from the list of any element @xmath70 of @xmath4 , hence it will succeed .",
    "if there exists a tree @xmath85 which admits a homomorphism to @xmath4 but not to @xmath2 , then by lemma [ treetoua ] , @xmath85 does not admit a homomorphism to @xmath133 , thus @xmath4 does not admit a homomorphism to @xmath133 . by the previous paragraph",
    "this implies that the @xmath2 hyperedge consistency check must fail on @xmath4 .",
    "conversely , suppose that the @xmath2 hyperedge consistency check fails on @xmath4 .",
    "we construct a tree @xmath85 as follows while running the hyperedge consistency check .",
    "when deleting an element @xmath69 from the list of an element @xmath70 of @xmath4 , we define a rooted tree @xmath171 with root @xmath172 with the following properties .",
    "* there is a homomorphism from @xmath171 to @xmath4 mapping @xmath172 to @xmath70 , * there is no homomorphism from @xmath171 to @xmath2 mapping @xmath172 to @xmath69 .    indeed , @xmath69 is deleted from the list of @xmath70 because we found a relation @xmath53 and @xmath160 with @xmath161 for some @xmath90 such that there exists no @xmath173 with @xmath163 and @xmath164 in the list of @xmath165 for @xmath166 .",
    "we then put elements @xmath174 in the universe of @xmath171 and @xmath175 in @xmath176 , and select the root @xmath177 . if @xmath178 does not contain any @xmath54-tuple @xmath179 such that @xmath163 , then we are done , since @xmath171 clearly satisfies properties ( i ) and ( ii )",
    "otherwise , for every @xmath179 such that @xmath163 , there exists at least one index @xmath48 such that @xmath164 is already removed from the list of @xmath165 whence the tree @xmath180 with properties ( i ) and ( ii ) is already defined ; we then add a copy of @xmath180 to @xmath171 , by identifying @xmath181 to @xmath182 .",
    "thus we get a tree @xmath171 such that the map @xmath183 defined by @xmath184 extends to a homomorphism from @xmath171 to @xmath4 . however , any homomorphism from @xmath171 to @xmath2 mapping @xmath172 to @xmath69 would also map the root of some previously defined @xmath180 to @xmath164 , which is impossible",
    ". thus @xmath171 satisfies properties ( i ) and ( ii ) .    when the list of some element @xmath70 of @xmath4 becomes empty",
    ", we can construct a tree @xmath85 by identifying the roots of all the trees @xmath171 to a new element @xmath54 .",
    "we then find a homomorphism from @xmath85 to @xmath4 by mapping @xmath54 to @xmath70 and extending independently on each @xmath171 .",
    "however a homomorphism from @xmath85 to @xmath2 would need to map @xmath54 to some element @xmath69 , hence induce a homomorphism from @xmath171 to @xmath2 mapping its root to @xmath69 , which is impossible . therefore , when the hyperedge consistency check fails , there exists a tree @xmath85 which admits a homomorphism to @xmath4 but not to @xmath2 .    in terms of dualities ,",
    "these results can be summarized as follows .    for a @xmath44-structure @xmath2",
    ", the following properties are equivalent :    * @xmath2 has tree duality , * @xmath133 admits a homomorphism to @xmath2 , * the @xmath2 hyperedge consistency check decides the @xmath2-csp problem .    *",
    "@xmath185 ( ii )  suppose that @xmath2 has tree duality .",
    "by lemma [ treetoua ] , there does not exist a tree that admits a homomorphism to @xmath133 but not to @xmath2 , hence there exists a homomorphism from @xmath133 to @xmath2 . * @xmath185 ( iii )  by lemma [ hcc ] the @xmath2 hyperedge consistency check decides the @xmath133-csp problem . if there exists a homomorphism from @xmath133 to @xmath2 , then since there also exists a homomorphism from @xmath2 to @xmath133 the @xmath2-csp problem is equivalent to the @xmath133-csp problem . *",
    "@xmath185 ( i )  by lemma [ hcc ] , when the @xmath2 hyperedge consistency check fails on a structure @xmath4 , there exists a tree @xmath85 which admits a homomorphism to @xmath4 but none to @xmath2 .",
    "thus if the @xmath2 hyperedge consistency check decides the @xmath2-csp problem , then @xmath2 has tree duality .",
    "property ( ii ) shows that these three properties are decidable , since a greedy search for a homomorphism from @xmath133 to @xmath2 can be done in finite time . property ( iii )",
    "gives a polynomial algorithm for the corresponding csp s , and property ( i ) shows that these problems contain the class of csp s with finite duality , that is , the first - order decidable csp s .",
    "let @xmath45 be a @xmath44-structure and @xmath186 an equivalence relation on @xmath46 . for @xmath65",
    "we denote @xmath187 the @xmath186-equivalence class containing @xmath69 .",
    "the _ quotient _ @xmath188 of @xmath2 under @xmath186 is the @xmath44-structure whose universe is the set of @xmath186-equivalence classes , where for @xmath126 we have @xmath189 if and only if there exist @xmath190 , @xmath191 such that @xmath192 .",
    "note that the quotient map @xmath193 where @xmath194 is a homomorphism ; in fact for every homomorphism @xmath195 , there is a natural equivalence @xmath186 ( the `` kernel '' of @xmath139 ) on @xmath46 and an injective homomorphism @xmath196 such that @xmath197 .",
    "here we give a first application of quotients to reveal an important structural property of cores with tree duality .",
    "a @xmath44-structure @xmath2 is called _ rigid _ if the identity is the only homomorphism from @xmath2 to itself .",
    "[ coreisrigid ] let @xmath2 be a core with tree duality .",
    "then @xmath2 is rigid .",
    "suppose that @xmath198 is a homomorphism . since @xmath2 is a core",
    ", @xmath199 is an automorphism of @xmath2 hence we can define an equivalence relation @xmath186 on @xmath46 by putting @xmath200 if there exists an integer @xmath201 such that @xmath202 . we will show that every tree which admits a homomorphism to @xmath188 also admits a homomorphism to @xmath2 .",
    "let @xmath85 be a tree which admits a homomorphism @xmath203 .",
    "let @xmath204 be the sequence of lemma  [ treedecomposition ]",
    ". for @xmath205 , the restriction of @xmath206 to the universe of @xmath207 is a homomorphism @xmath208 ; we recursively define a sequence @xmath209 of homomorphisms such that @xmath210 , where @xmath211 is the quotient map from @xmath2 to @xmath188 .",
    "first , @xmath137 has just one hyperedge @xmath212 for some @xmath48 , and @xmath213 . by definition of quotients",
    "this means that there exist @xmath214 such that @xmath215 , thus we can define @xmath216 by @xmath217 .",
    "now suppose that @xmath218 is already defined .",
    "@xmath207 is obtained from @xmath219 by adding an hyperedge @xmath220 which has only one coordinate @xmath221 in the universe of @xmath219 .",
    "again we have @xmath222 and there exist @xmath214 such that @xmath215 . put @xmath223 . then @xmath224 hence by the definition of @xmath186 there exists a power @xmath201 such that @xmath225 . since @xmath199 is a homomorphism , we then have @xmath226 , and we can extend the definition of @xmath227 to that of @xmath228 by putting @xmath229 if @xmath230 is in the universe of @xmath219 , and @xmath231 . indeed @xmath232 is well defined since both definitions coincide on @xmath221 , it is a homomorphism since it preserves @xmath220 in addition to all the hyperedges preserved by @xmath227 , and @xmath233 for all @xmath230 in the universe of @xmath207 whence @xmath234 . in this way",
    "we eventually define a homomorphism @xmath235 from @xmath236 to @xmath2 .",
    "hence every tree which admits a homomorphism to @xmath188 also admits a homomorphism to @xmath2 .",
    "since @xmath2 has tree duality this implies that @xmath188 admits a homomorphism to @xmath2 .",
    "since @xmath2 is a core which admits a homomorphism to @xmath188 , this implies that @xmath186 can not identify vertices , whence @xmath199 is the identity .      given two @xmath44-structures @xmath237 and @xmath238 their _ product _ is the @xmath44-structure @xmath239 where for @xmath126 , @xmath240 consists of all tuples @xmath241 such that @xmath242 and @xmath243 .",
    "both projections @xmath244 and @xmath245 are homomorphism and in general for any @xmath44-structure @xmath120 and any pair @xmath246 , @xmath247 of homomorphisms there is a unique homomorphism @xmath248 such that @xmath249 and @xmath250 .",
    "the product is associative ; the _ @xmath73-th power _",
    "@xmath251 of @xmath2 is the product of @xmath73 copies of @xmath2 . for any @xmath252 an _ @xmath73-ary operation on _",
    "@xmath2 is a homomorphism from @xmath251 to @xmath2 .",
    "the _ one - tolerant @xmath73-th power _",
    "@xmath253 of @xmath2 is the @xmath44-structure @xmath254 where for @xmath126 , @xmath255 consists of tuples @xmath256 such that @xmath257 . in other words , @xmath253 is obtained from @xmath251 by adding to @xmath258 all hyperedges that are mapped to @xmath47 by at least @xmath259 of the projections . in particular , the projections are not homomorphisms from @xmath253 to @xmath2 hence @xmath253 does not necessarily admit a homomorphism to @xmath2 . however notice that removal of a coordinate is a homomorphism from @xmath260 to @xmath253 .",
    "[ homtolerantpower ] there exists a homomorphism from @xmath260 to @xmath2 if and only if the critical obstructions of @xmath2 have at most @xmath73 hyperedges .",
    "let @xmath120 be a critical obstruction of @xmath2 with @xmath106 distinct hyperedges @xmath261 , @xmath262 .",
    "then for @xmath263 , the @xmath44-structure @xmath264 obtained from @xmath120 by removing @xmath265 ( without changing the universe ) admits a homomorphism @xmath232 to @xmath2 . by definition of @xmath266 ,",
    "the map @xmath267 is a homomorphism from @xmath120 to @xmath266 .",
    "therefore there is no homomorphism from @xmath266 to @xmath2 , and in particular none from @xmath260 to @xmath2 .",
    "conversely , suppose that there is no homomorphism from @xmath260 to @xmath2 .",
    "then there exists a critical obstruction @xmath120 of @xmath2 which admits a homomorphism @xmath139 to @xmath260 . for every coordinate @xmath268",
    ", there exists an hyperedge @xmath265 of @xmath120 which is not respected by @xmath269 , since @xmath269 is not a homomorphism from @xmath120 to @xmath2 . by the definition of @xmath260",
    ", @xmath265 is respected by @xmath270 for every @xmath271 , whence @xmath272 for @xmath271 .",
    "therefore @xmath120 has at least @xmath273 hyperedges .",
    "[ 1antoa ] a @xmath44-structure @xmath2 has finite duality if and only if there exists a positive integer @xmath73 such that @xmath253 admits a homomorphism to @xmath2",
    ".    note that the homomorphisms from @xmath71-tolerant powers of @xmath2 to @xmath2 are operations on @xmath2 . for @xmath274 , an operation @xmath275",
    "is called a _ near unanimity operation _",
    "if it satisfies the identities @xmath276    [ nuf ] let @xmath2 be a core with finite duality .",
    "then every homomorphism from a 1-tolerant power of @xmath2 to @xmath2 is a near unanimity operation .",
    "let @xmath277 be a homomorphism .",
    "for every @xmath278 and @xmath279 , consider the homomorphism @xmath280 defined by @xmath281 where @xmath282 if @xmath283 and @xmath284 otherwise . by lemma  [ coreisrigid ]",
    ", @xmath2 is rigid whence the map @xmath285 is the identity .",
    "thus for every @xmath286 and @xmath287 we have @xmath288 , and this is precisely the definition of a near unanimity operation .",
    "[ section_reference ] we say that a structure @xmath2 _ admits _ an operation @xmath289 , or equivalently that @xmath290 _ preserves _ the basic relations of @xmath2 if @xmath290 is a homomorphism from @xmath251 to @xmath2 .",
    "[ core_nuf ] every core relational structure with a first - order definable csp admits a near unanimity operation .",
    "recall from section  [ sectionprelim ] that the @xmath73-link @xmath84 of type @xmath44 has universe @xmath291 . for a @xmath44-structure @xmath120 ,",
    "a map @xmath139 from its universe to @xmath292 is a homomorphism from @xmath120 to @xmath84 if and only if @xmath293 whenever @xmath35 and @xmath36 are in a common hyperedge .    given a @xmath44-structure @xmath237 , note that the product @xmath294 has diameter at least @xmath73 since for any @xmath295 the distance between @xmath296 and @xmath297 is at least @xmath73 .",
    "( the distance could even be infinite , that is , @xmath296 and @xmath297 could lie in different connected components . )",
    "let @xmath298 be the equivalence relation defined on @xmath299 by @xmath300 note that @xmath301 also has diameter at least @xmath73 .",
    "[ cutends ] the substructures @xmath302 and @xmath303 of @xmath304 induced by @xmath305 and @xmath306 respectively both admit homomorphisms to @xmath2 .    on @xmath307 we can define a map @xmath139 to @xmath46 by @xmath308 .",
    "we show that @xmath139 is a homomorphism from @xmath302 to @xmath2 . for @xmath309 and @xmath310 , there exist @xmath311 , @xmath312 , such that @xmath313 , with @xmath314 .",
    "we then have that @xmath315 is equal to @xmath316 which is in @xmath47 , thus @xmath139 is a homomorphism .",
    "similarly , we can define a homomorphism @xmath317 by @xmath318 .",
    "[ lxa2toa ] a @xmath44-structure @xmath2 has critical obstructions of bounded diameter if and only if there exists a positive integer @xmath73 such that @xmath301 admits a homomorphism to @xmath2 .    by the previous lemma ,",
    "any critical obstruction of @xmath2 contained in @xmath301 must contain an element with first coordinate @xmath319 and an element with first coordinate @xmath73 ( the first coordinates are invariants of @xmath298-equivalence classes ) thus have diameter at least @xmath73 .",
    "hence if @xmath73 is larger than the diameter of all the critical obstructions of @xmath2 , then @xmath320 admits a homomorphism to @xmath2 .",
    "now suppose that @xmath2 has critical obstructions of arbitrarily large diameter",
    ". we will show that for every integer @xmath73 there exists an obstruction @xmath120 of @xmath2 which admits a homomorphism to @xmath301 .",
    "let @xmath321 be an obstruction of @xmath2 with diameter at least @xmath322 .",
    "let @xmath35 and @xmath36 be elements of @xmath23 at distance @xmath322 , and @xmath323 , @xmath324 the substructures of @xmath120 induced respectively by @xmath325 and @xmath326 .",
    "fix homomorphisms @xmath327 and @xmath328 and define @xmath329 by @xmath330 note that @xmath331 is a homomorphism from @xmath120 to @xmath84 .",
    "we fix an element @xmath332 and define a map @xmath139 from @xmath23 to the universe of @xmath301 by @xmath333 we will show that @xmath139 is a homomorphism from @xmath120 to @xmath320 .",
    "let @xmath334 be in @xmath335 for some @xmath336 . if @xmath337 for all @xmath338 , then @xmath339 which belongs to @xmath340 since @xmath341 and the quotient map from @xmath299 to @xmath301 are homomorphisms .",
    "if there exists an index @xmath342 such that @xmath343 , then @xmath344 for @xmath191 whence @xmath345 for @xmath191 by definition of @xmath298 ; therefore @xmath346 is equal to @xmath347 which is in @xmath348 . similarly if there exists an index @xmath342 such that @xmath349 , then @xmath350 @xmath351 .",
    "thus @xmath139 is a homomorphism .    since there exists a homomorphism from an obstruction of @xmath2 to @xmath301",
    "we conclude that there is no homomorphism from @xmath301 to @xmath2 .",
    "by theorem  [ foequivalences ] , corollary  [ 1antoa ] and proposition  [ lxa2toa ] we have the following characterisations :    [ focharacterisations ] let @xmath2 be a @xmath44-structure .",
    "then the following are equivalent .",
    "* @xmath2-csp is first - order definable ; * for some @xmath73 there exists a homomorphism from @xmath253 to @xmath2 ; * for some @xmath73 there exists a homomorphism from @xmath304 to @xmath2 .    at first glance",
    "our situation vis - a - vis the decidability question appears no better than before , but a closer look at the third condition in the above theorem reveals an upper bound on @xmath73 : indeed , for @xmath352 , the restriction @xmath232 of a homomorphism @xmath353 to @xmath354 corresponds to a homomorphism from @xmath355 to @xmath2 , and there are at most @xmath356 of these .",
    "if for @xmath357 we have @xmath358 , then for @xmath359 we can define a homomorphism @xmath360 by removing the useless middle part . therefore to determine whether @xmath2-csp is first - order definable it suffices to search for a homomorphism @xmath361 with @xmath362 , and",
    "this is a finite decision procedure .",
    "we can refine this argument by defining a graph structure on the set of all homomorphisms from @xmath355 to @xmath2 , where two homomorphisms @xmath206 , @xmath363 are called _ adjacent _ if there exists a homomorphism @xmath364 such that @xmath365 and @xmath366 .",
    "a homomorphism from @xmath301 to @xmath2 then corresponds to a link of length @xmath73 between a homomorphism @xmath367 which factors through the first projection and a homomorphism @xmath368 which factors through the second projection . since undirected reachability can be solved in logarithmic space , in our exponential setting this means that the search can be performed in polynomial space . in the next section",
    "this idea is developed further and we prove that the problem of determining whether @xmath2-csp is first - order definable is actually in * np*.",
    "let @xmath45 be a @xmath44-structure . for @xmath286",
    "we say that @xmath36 _ dominates @xmath35 in @xmath2 _ , if for every @xmath309 , @xmath369 and @xmath370 with @xmath284 we also have @xmath215 with @xmath371 and @xmath372 for all @xmath373 . for instance , if @xmath82 is ternary and @xmath374 , then for @xmath36 to dominate @xmath35 we must have @xmath375 and @xmath376 , each of which also implies @xmath377 .",
    "we say that @xmath35 _ is dominated in @xmath2 _ if it is dominated by some element @xmath378 .",
    "we say that @xmath2 _ dismantles to _ its induced substructure @xmath4 if there exists a sequence @xmath379 of distinct elements of @xmath46 such that @xmath380 and for each @xmath381 the element @xmath93 is dominated in the structure induced by @xmath382 . in other words , the structure @xmath4 can be obtained from @xmath2 by successively removing dominated elements ; the sequence @xmath379 is then called a _ dismantling sequence_. note that if @xmath383 is the substructure of @xmath2 induced by @xmath384 , where @xmath35 is dominated by @xmath36 in @xmath2 , then we can define a retraction @xmath385 by putting @xmath386 and @xmath387 for all @xmath388 . using composition",
    "we then see that if @xmath2 dismantles to @xmath4 then @xmath4 is a retract of @xmath2 ( the converse does not hold in general ) .",
    "our first result shows that `` dismantling @xmath2 to @xmath4 '' can be done greedily .",
    "[ greedy ] let @xmath389 be @xmath44-structures such that @xmath2 dismantles to @xmath4 . then for every dominated element @xmath390 of @xmath2 , the substructure @xmath391 of @xmath2 induced by @xmath392 dismantles to @xmath4 .",
    "let @xmath393 be a dismantling sequence of @xmath2 on @xmath4 .",
    "note that for some index @xmath90 we have @xmath394 .",
    "we will show that by removing @xmath395 and perhaps rearranging the sequence we get a dismantling sequence of @xmath391 on @xmath4 .",
    "for @xmath396 let @xmath397 be an element dominating @xmath93 in the substructure @xmath398 of @xmath2 induced by @xmath399 .",
    "note that for some indices @xmath48 there may be many choices for @xmath397 , and whenever @xmath400 , @xmath397 also dominates @xmath93 in the substructure of @xmath391 induced by @xmath401 .",
    "thus it suffices to show that for all @xmath402 , we can select @xmath397 other than @xmath69 .    let @xmath48 be the smallest index such that @xmath403 , and let @xmath70 be an element dominating @xmath69 in @xmath2 .",
    "note that if @xmath404 , then @xmath70 also dominates @xmath93 in the substructure of @xmath391 induced by @xmath405 , hence we can select @xmath406 instead . thus we can assume that @xmath407 for some @xmath408 .",
    "we then define a finite increasing sequence @xmath409 by putting @xmath410 , and letting @xmath411 be the index in @xmath412 such that @xmath413 if such an index exists .",
    "then @xmath93 is dominated by @xmath69 in @xmath398 , which is dominated by @xmath414 in @xmath2 . for @xmath415 , @xmath416",
    "is dominated by @xmath413 in @xmath417 , and @xmath418 is dominated by @xmath419 in @xmath420 .",
    "if @xmath421 , then @xmath422 also dominates @xmath93 in @xmath398 hence we can select @xmath423 instead of @xmath403 . if @xmath424 , then @xmath93 and @xmath425 dominate each other in @xmath398 . in this case",
    ", @xmath426 is a dismantling sequence of @xmath391 on its substructure induced by @xmath427 , which is isomorphic to @xmath428 via an isomorphism which fixes @xmath57 , whence @xmath391 dismantles to @xmath4 .",
    "let @xmath2 and @xmath4 be two @xmath44-structures .",
    "@xmath2-th power of @xmath4 _ is the @xmath44-structure @xmath429 where @xmath430 is the set of all maps from @xmath46 to @xmath57 , and for @xmath431 the relation @xmath432 consists of all hyperedges @xmath433 such that @xmath434 whenever @xmath435 .",
    "this definition is derived from the following correspondence , whose proof is straightforward .",
    "[ expoprod ] let @xmath436 be a homomorphism .",
    "then the map @xmath437 defined by @xmath438 , where @xmath439 , is a homomorphism from @xmath120 to @xmath440 .",
    "conversely , if @xmath441 is a homomorphism , then the map @xmath442 defined by @xmath443 is a homomorphism from @xmath444 to @xmath4 .",
    "in particular the homomorphisms from @xmath2 to itself can be viewed as homomorphisms from the product of @xmath2 and a loop to @xmath2 , which then correspond to loops in @xmath445 .",
    "now suppose that @xmath69 is dominated by @xmath70 in @xmath2 , and let @xmath59 be the retraction which maps @xmath69 to @xmath70 and fixes every other element of @xmath46 .",
    "then , considered as an element of @xmath445 , @xmath59 is a `` neighbour '' of the identity in the sense that there exists a homomorphism @xmath206 from the @xmath71-link @xmath446 to @xmath445 defined by @xmath447 and @xmath448 .",
    "the main result of this section is a generalisation of this observation to the dismantling process in general .",
    "[ dismantle ] let @xmath2 be a @xmath44-structure and let @xmath4 be a substructure of @xmath2 .",
    "then @xmath2 dismantles to @xmath4 if and only if there exist some @xmath449 and a homomorphism @xmath450 such that    * @xmath451 , * @xmath57 is fixed pointwise by @xmath452 for every @xmath453 , * @xmath454 is a retraction onto @xmath57 .",
    "we call two homomorphisms @xmath455 _ adjacent _ if there is a homomorphism @xmath456 from @xmath446 to @xmath445 such that @xmath457 and @xmath458",
    ". hence lemma  [ dismantle ] states that @xmath2 dismantles to @xmath4 if and only if there is a link of homomorphisms fixing @xmath57 pointwise which joins the identity on @xmath46 to a retraction onto @xmath57 .",
    "the proof will use the following property of composition in powers , whose proof is a straightforward application of the definition .",
    "[ composition ] let @xmath459 be @xmath44-structures .",
    "then the map @xmath460 defined by @xmath461 is a homomorphism . in particular for any integer @xmath201 , the map @xmath462 defined by @xmath463 is a homomorphism .    for every @xmath464 , and @xmath65",
    ", there exist integers @xmath465 such that we have @xmath466 ; we say that @xmath69 has _",
    "finite period under @xmath290 _ if we can take @xmath467 . for @xmath468 , we then have @xmath469 if @xmath69 has finite period under @xmath290 , and otherwise @xmath470 has finite period under @xmath290 .",
    "thus @xmath471 is a set - theoretic retraction of @xmath46 onto the set of its elements of finite period under @xmath290 .",
    "therefore for @xmath468 , the homomorphism @xmath472 defined in lemma  [ composition ] is a retraction of @xmath445 onto its substructure induced by the set - theoretic retractions of @xmath46 .    [",
    "proof of lemma [ dismantle ] ] suppose that @xmath2 dismantles to @xmath4 , and let @xmath393 be a dismantling sequence of @xmath2 on @xmath4 . for @xmath473 , let @xmath474 be an element dominating @xmath475 in the substructure of @xmath2 induced by @xmath476 .",
    "we define a sequence @xmath477 of retractions inductively by @xmath478 , @xmath479 if @xmath480 and @xmath481 otherwise .",
    "let @xmath482 be defined by @xmath483 .",
    "then @xmath484 is the identity , @xmath57 is fixed by each @xmath452 , and @xmath485 is a retraction onto @xmath57 .",
    "we show that @xmath456 is a homomorphism .    for @xmath309 ,",
    "let @xmath486 be an element of @xmath487 .",
    "then there exists an index @xmath488 and a subset @xmath489 of @xmath490 such that @xmath491 if @xmath492 and @xmath493 otherwise .",
    "we then have @xmath494 where @xmath495 if @xmath492 and @xmath496 otherwise . for every @xmath192",
    ", we have @xmath497 , since @xmath498 is a homomorphism .",
    "now @xmath499 coincides with @xmath500 except for some possible coordinates in @xmath489 where @xmath501 replaces @xmath475 .",
    "since @xmath502 and @xmath501 dominates @xmath475 in the substructure of @xmath2 induced by that subset , we then have @xmath503 .",
    "thus @xmath504 .",
    "this shows that @xmath456 is a homomorphism .",
    "conversely , suppose that @xmath505 is a homomorphism such that for @xmath506 we have @xmath507 , @xmath57 is fixed pointwise by each @xmath508 and @xmath509 is a retraction onto @xmath57 .",
    "put @xmath510 .",
    "we define three maps as follows .",
    "* @xmath511 is defined by @xmath512 .",
    "thus @xmath513 , which is a homomorphism by lemma [ composition ] .",
    "* @xmath514 , where @xmath515 is defined recursively by @xmath516 and @xmath517 for @xmath518 . since @xmath519 is idempotent , @xmath520 is adjacent to @xmath521 by lemma [ composition ] , whence @xmath522 is a homomorphism .",
    "* @xmath523 is a homomorphism by lemma [ composition ] .",
    "note that @xmath524 , and since every @xmath452 fixes @xmath57 , @xmath525 which is a retraction onto @xmath57 . also , for @xmath518 , @xmath526 is a retraction",
    "whose image @xmath527 is contained in that of @xmath528 .",
    "we can then show that every @xmath529 is dominated by @xmath530 in the substructure @xmath531 of @xmath2 induced by @xmath532 .",
    "indeed , for @xmath533 and @xmath534 such that @xmath163 for some index @xmath90 , we have that @xmath535 is in @xmath47 since @xmath536 is adjacent to @xmath528 , whence @xmath537 dominates @xmath69 in @xmath531 .",
    "therefore @xmath2 dismantles to its substructure induced by @xmath538 .",
    "here we interpret lemma [ lxa2toa ] in terms of exponential structures .",
    "for a @xmath44-structure @xmath2 we denote @xmath541 and @xmath542 the two projections of @xmath355 on @xmath2 .",
    "the _ diagonal _ of @xmath355 is its substructure @xmath543 induced by @xmath544 .",
    "[ aalaa2 ] let @xmath2 be a @xmath44-structure and @xmath73 an integer .",
    "if there exists a homomorphism @xmath545 such that @xmath546 and @xmath547 , then there exists a homomorphism from @xmath301 to @xmath2 .",
    "if @xmath2 is a core , the converse also holds .",
    "[ a2alaa2 ] let @xmath2 be a @xmath44-structure .",
    "if @xmath355 dismantles to its diagonal , then for some @xmath73 there exists a homomorphism @xmath548 such that @xmath546 and @xmath547 .",
    "if @xmath2 is a core , the converse also holds .",
    "[ proof of lemma [ aalaa2 ] ] by lemma [ expoprod ] a homomorphism @xmath549 corresponds to the homomorphism @xmath550 defined by @xmath551 .",
    "if @xmath546 and @xmath547 , then @xmath139 is constant on every @xmath298-equivalence class , hence we can define a homomorphism @xmath552 by @xmath553 .",
    "conversely , any homomorphism @xmath554 can be composed with the quotient map @xmath555 to give a homomorphism @xmath556 . by lemma [ expoprod ]",
    ", @xmath557 corresponds to a homomorphism @xmath558 , and by definition of @xmath298 there exist homomorphisms @xmath559 from @xmath2 to itself such that @xmath560 and @xmath561 .",
    "if @xmath2 is a core , then by lemma  [ coreisrigid ] , @xmath562 and @xmath563 are both the identity , whence @xmath546 and @xmath547 .",
    "[ proof of of lemma [ a2alaa2 ] ] suppose that @xmath355 dismantles to its diagonal @xmath543 . by lemma",
    "[ dismantle ] , for some @xmath73 there exists a homomorphism @xmath564 such that @xmath484 is the identity and @xmath454 is a retraction on @xmath543 . we can then define a homomorphism @xmath565 by @xmath566 and @xmath567 for @xmath568 .",
    "indeed both definitions of @xmath569 coincide since @xmath454 is a retraction on @xmath543 , and since @xmath484 is the identity , @xmath570 and @xmath571 .",
    "conversely , for every homomorphism @xmath572 such that @xmath546 and @xmath573 , we can define a homomorphism @xmath574 by @xmath575 .",
    "then @xmath576 is the identity and @xmath577 is a retraction on @xmath543 .",
    "if @xmath2 is a core , then since @xmath543 is isomorphic to @xmath2 via the canonical isomorphism , the restriction of every @xmath452 to @xmath543 must coincide with @xmath542 by lemma  [ coreisrigid ] .",
    "hence for @xmath568 , @xmath578 fixes @xmath543 .",
    "therefore @xmath355 dismantles to @xmath2 by lemma  [ dismantle ] .",
    "let @xmath2 be a relational structure such that @xmath355 dismantles to @xmath543 . then by lemma  [ a2alaa2 ]",
    ", @xmath579 contains a link between the two projections , thus for some @xmath73 there exists a homomorphism from @xmath304 to @xmath2 by lemma  [ aalaa2 ] .",
    "hence , by theorem  [ focharacterisations ] , @xmath2-csp is first - order definable .",
    "the converse does not hold in general . however , for any retract @xmath4 of @xmath2 , @xmath2-csp is equivalent to @xmath4-csp . in particular ,",
    "if @xmath4 is the core of @xmath2 and @xmath2-csp is first - order definable , then theorem  [ focharacterisations ] , lemma  [ aalaa2 ] and lemma  [ a2alaa2 ] imply that @xmath580 dismantles to @xmath581 .",
    "therefore we have proved the following :    [ foinnp ] a relational structure has a first - order definable csp if and only if it has a retract whose square dismantles to its diagonal .",
    "[ foisnpc ] the problem of determining whether a relational structure @xmath2 has a first - order definable csp is * np*-complete .    in fact , we will show the problem to be * np*-complete even in the restricted case of directed graphs .",
    "we contrast this with the following result :    [ focoreispoly ] the problem of determining whether a relational structure @xmath2 is a core with a first - order definable csp can be solved in polynomial time .",
    "in particular , theorem  [ focoreispoly ] implies that deciding whether an input core structure @xmath2 has a first - order definable csp can be done in polynomial time , but our algorithm does not require a certificate that the input is a core .",
    "[ proof of theorem [ foisnpc ] ] theorem [ foinnp ] shows that the problem is in * np*. we will show that 3-sat reduces to the problem of determining whether a given digraph has first - order definable csp .",
    "let @xmath582 be an instance of 3-sat , where each literal is one of the variables @xmath583 or its negation , and ( without loss of generality ) @xmath584 when @xmath585 .",
    "we construct a digraph @xmath8 such that @xmath586 is satisfiable if and only if @xmath8 has first - order definable csp .",
    "the vertex - set of @xmath8 is @xmath587 , and there is an arc from @xmath588 to @xmath589 if and only if @xmath590 and @xmath591 is not the negation of @xmath592 .",
    "thus the map @xmath139 from @xmath8 to the transitive tournament @xmath593 on @xmath73 vertices defined by @xmath594 is a homomorphism .",
    "furthermore it is not hard to see that for every tree @xmath46 which admits a homomorphism @xmath595 , there exists a homomorphism @xmath596 such that @xmath597 .",
    "thus the trees that map to @xmath8 are precisely those which map to @xmath593 .",
    "since @xmath593 has finite duality @xcite , this means that @xmath8 has first - order definable csp if and only if @xmath593 is the core of @xmath8 by theorem  [ foequivalences ] .",
    "if @xmath586 is satisfiable , then selecting for each @xmath48 an index @xmath598 such that @xmath599 is true yields a homomorphic image @xmath600 of @xmath593 in @xmath8 .",
    "conversely , if @xmath600 is a homomorphic image of @xmath593 in @xmath8 , then we can consistently deem the literals @xmath599 to be true to find a satisfactory truth assignment of @xmath586",
    ". therefore @xmath586 is satisfiable if and only if @xmath8 has first - order definable csp .",
    "[ proof of theorem [ focoreispoly ] ] we first test whether @xmath355 dismantles to @xmath543 . according to lemma  [ greedy ] this step can be performed in polynomial time using the greedy algorithm .",
    "if the answer is negative , then either @xmath2 is not a core , or it is a core which does not have a first - order definable csp . in any case",
    ", we output `` no '' and stop . if the answer is positive , then @xmath2 does have first - order definable csp , but it may not be a core . for each pair",
    "@xmath601 we form the quotient @xmath602 of @xmath2 under the equivalence which identifies @xmath69 and @xmath70 . by theorem  [ foequivalences ] , @xmath2 has tree duality , hence the polynomial consistency - check algorithm ( see @xcite ) detects whether @xmath602 admits a homomorphism to @xmath2 .",
    "if such a homomorphism @xmath139 exists , then @xmath2 admits a homomorphism to its proper substructure @xmath603 hence it is not a core ; we then output `` no '' and stop .",
    "if no homomorphism exists from any quotient @xmath602 to @xmath2 , then @xmath2 is a core .",
    "we then output `` yes '' .",
    "let @xmath2 be a structure such that @xmath355 dismantles to its diagonal .",
    "then @xmath2 has a first - order definable csp ; furthermore without loss of generality , we can assume that @xmath2 is a core , since adding to the type @xmath44 a unary relation for each element @xmath46 preserves the dismantling of @xmath355 to its diagonal . thus , the hyperedge consistency check algorithm is sufficient to determine whether a structure @xmath4 admits a homomorphism to @xmath2 .",
    "it is possible to find an explicit homomorphism from @xmath4 to @xmath2 in polynomial time using vertex identifications on a trial and error basis . in this section ,",
    "we provide an alternative algorithm based on dismantlings of @xmath604 .",
    "we will use the following variation of lemma [ greedy ] :    [ udt ] let @xmath4 be a structure which dismantles to two substructures @xmath120 and @xmath605 .",
    "if neither of @xmath120 and @xmath605 have dominated elements , then @xmath120 and @xmath605 are isomorphic .",
    "let @xmath606 be a dismantling sequence of @xmath4 on @xmath605 .",
    "for @xmath14 , let @xmath607 be the substructure of @xmath4 induced by @xmath608 .",
    "we define a sequence @xmath609 of structures such that @xmath610 if @xmath93 is not in the universe of @xmath611 , and otherwise @xmath612 is obtained from @xmath611 by replacing the element @xmath93 by an element which dominates it in @xmath607 . by induction we prove that    _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ @xmath4 dismantles to @xmath612 , which is isomorphic to @xmath120 . _",
    "_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _    indeed , for @xmath613 this is given , and the induction step clearly works when @xmath610 .",
    "suppose that @xmath612 is obtained from @xmath611 by replacing @xmath93 by @xmath36 .",
    "note that @xmath36 is not already in @xmath611 since @xmath611 is isomorphic to @xmath120 which contains no dominated elements . by lemma [ greedy ]",
    ", there exists a dismantling sequence @xmath614 of @xmath607 on @xmath611 . by replacing @xmath36 by @xmath93 in this sequence",
    ", we get a dismantling sequence of @xmath607 on @xmath615 , whence @xmath4 dismantles to @xmath615 .",
    "moreover , @xmath616 clearly dismantles to both @xmath611 and @xmath615 , whence @xmath93 and @xmath36 dominate each other in @xmath616",
    ". therefore @xmath611 and @xmath615 are isomorphic .",
    "thus , @xmath605 contains a substructure isomorphic to @xmath120 . by interchanging the roles of @xmath120 and @xmath605 ,",
    "we conclude that @xmath120 and @xmath605 are isomorphic .    in a product @xmath604",
    ", an element @xmath617 is said to be _ dominated in the second coordinate _ if it is dominated by an element of the form @xmath618 .",
    "we say that @xmath604 _ dismantles in the second coordinate _ to its substructure @xmath120 if @xmath120 can be obtained from @xmath604 by successively removing elements that are dominated in the second coordinate .",
    "note that dismantlings of @xmath604 in the second coordinate can be considered as ordinary dismantlings , by adding to the type @xmath44 one unary relation @xmath619 for each @xmath158 .",
    "hence the results of lemma [ udt ] apply , and @xmath604 dismantles in the second coordinate to a structure @xmath120 with no elements dominated in the second coordinate .",
    "such a structure @xmath120 is unique up to isomorphism . for each @xmath158",
    ", there exists at least one @xmath65 such that @xmath620 .",
    "if for each @xmath158 , there exists exactly one @xmath621 such that @xmath620 , then @xmath120 is the _ graph _ of the function @xmath622 .",
    "the latter is a homomorphism from @xmath4 to @xmath2 precisely when @xmath120 is isomorphic to @xmath4 .",
    "[ distohom ] let @xmath2 be a structure such that @xmath355 dismantles to its diagonal .",
    "for a structure @xmath4 , let @xmath120 be a substructure of @xmath604 obtained by dismantling in the second coordinate until no more elements are dominated in the second coordinate .",
    "then @xmath4 admits a homomorphism to @xmath2 if and only if @xmath120 is the graph of a homomorphism from @xmath4 to @xmath2 .",
    "obviously , if @xmath604 dismantles in the second coordinate to the graph of a homomorphism @xmath206 from @xmath4 to @xmath2 , then @xmath4 admits a homomorphism to @xmath2 .",
    "the proof of the converse parallels that of theorem [ foinnp ] . as mentioned in the beginning of this section",
    ", we can assume that @xmath2 is a core .",
    "let @xmath4 be a structure which admits a homomorphism to @xmath2 .",
    "we first define the structure @xmath623 as follows : @xmath624 is the quotient of the product @xmath625 under the equivalence @xmath298 defined by @xmath626 note that since @xmath4 admits a homomorphism to @xmath2 , the fiber @xmath627 is isomorphic to @xmath4 , while @xmath628 is not necessarily ismomorphic to @xmath2 . we complete the structure of @xmath623 by adding a copy of @xmath2 to the fiber @xmath629 : for each @xmath149 and @xmath162 , we put @xmath630 .    as in lemma",
    "[ cutends ] , the substructures of @xmath623 induced by @xmath631 and @xmath632 admit natural homomorphisms to @xmath2 and @xmath4 respectively , whence both of these admit homomorphisms to @xmath2",
    ". thus if @xmath73 is larger than the diameter of the minimal obstructions of @xmath2 , then there exists a homomorphism @xmath633 note that @xmath634 corresponds to a link of homomorphisms @xmath635 , where @xmath636 and @xmath637 for some homomorphism @xmath638 .",
    "we use @xmath634 to define a link of homomorphisms @xmath639 by @xmath640 thus , @xmath641 , @xmath642 and @xmath643 .",
    "there are two desirable properties which would allow us to reach our conclusion : if @xmath644 were a link of retractions such that @xmath645 , then by lemma [ dismantle ] we would have that @xmath604 dismantles on @xmath646 .",
    "however the current link @xmath644 may have neither of these properties .",
    "thus we will repeatedly modify our link through the following two procedures :    * if @xmath647 is a link with the same properties as @xmath644 above , then for @xmath648 the functions @xmath649 defined by @xmath650 form a link of retractions , where @xmath651 , @xmath652 and @xmath653 for some @xmath654 .",
    "however we do not necessarily have @xmath655 . *",
    "if @xmath649 is a link of retractions with the properties given in ( i ) , we define the sequence @xmath656 recursively by @xmath657 and @xmath658 .",
    "then we clearly have @xmath659 .",
    "moreover , @xmath660 , @xmath661 and @xmath662 for some @xmath663 .",
    "in particular , @xmath664 and @xmath665 are adjacent , and if @xmath666 and @xmath667 are adjacent , then so are @xmath668 and @xmath669 by lemma [ composition ] .",
    "thus , @xmath670 forms a link , though these homomorphisms may not be retractions .",
    "after an initial run through steps ( i ) and ( ii ) , every time we need to repeat step ( ii ) it is because the previous step ( i ) reduced the size of the images of some functions in the link . thus after some repetitions , we eventually get a link @xmath671 such that @xmath672 , each @xmath673 is a retraction and @xmath674 .",
    "thus the map @xmath675 defined by @xmath676 satisfies the hypotheses of lemma [ dismantle ] whence @xmath677 dismantles to @xmath678 .",
    "moreover , each function @xmath673 is of the form @xmath679 , and also preserve the relations @xmath680 .",
    "thus @xmath677 dismantles in the second coordinate to @xmath681 for some function @xmath682 .",
    "since there exists a homomorphism @xmath638 and the dismantling sequence induces a homomorphism from the graph of @xmath139 to that of @xmath206 , we conclude that @xmath206 is indeed a homomorphism from @xmath4 to @xmath2 .    given a structure @xmath2 such that @xmath355 dismantles to its diagonal , theorem [ distohom ]",
    "provides the following algorithm for deciding whether a structure @xmath4 admits a homomorphism to @xmath2 : we dismantle @xmath604 in the second coordinate until we get a structure @xmath120 with no dominations in the second coordinate .",
    "we then have the following possibilities :    * if @xmath120 is not a graph , then there is no homomorphism from @xmath4 to @xmath2 .",
    "* if @xmath120 is a graph , @xmath683 where @xmath622 is not a homomorphism from @xmath4 to @xmath2 , then there is no homomorphism from @xmath4 to @xmath2 . *",
    "otherwise , @xmath4 admits a homomorphism to @xmath2 , and @xmath120 is the graph of such a homomorphism @xmath638 .",
    "this algorithm works a bit like the hyperedge consistency check , with the list of an element @xmath70 of @xmath57 identified with the fiber @xmath684 . in the dismantling algorithm ,",
    "an element is removed from a list if it becomes redundant rather than inconsistent . both algorithms work in @xmath685 time , where @xmath686 is the maximum arity in @xmath44 .",
    "in this section we analyse the computational complexity of csp s whose basic relations are inferred from those of a first - order definable csp .",
    "let @xmath687 be a set of relations on the finite set @xmath46 .",
    "the _ relational clone generated by @xmath687 _ , denoted by @xmath688 , is the set of relations on @xmath46 inferred from the relations in @xmath687 , i.e. definable from relations in @xmath687 via primitive positive formulas .",
    "we now give equivalent combinatorial and algebraic descriptions of the relations in @xmath688 ( see e.g.  @xcite ) .",
    "recall from section [ section_reference ] that an operation @xmath290 on a set @xmath46 _ preserves _ a relation @xmath6 on @xmath46 if @xmath290 is a homomorphism from @xmath251 to @xmath2 where @xmath689 .",
    "[ 6constr ] let @xmath687 be a finite set of relations on @xmath46 and let @xmath6 be a @xmath690-ary relation on @xmath46 .",
    "then the following conditions are equivalent :    1 .",
    "@xmath691 ; 2 .",
    "every operation on @xmath46 that preserves every relation in @xmath687 also preserves @xmath6 ; 3 .",
    "there exists a ( primitive positive ) formula @xmath692 where @xmath206 is a conjunction of atomic formulas with relations in @xmath693 such that @xmath694 if and only if @xmath695 holds ; 4 .",
    "there exists a structure @xmath696 of the same signature as the structure @xmath697 , and elements @xmath698 such that @xmath699    a relation @xmath6 of arity @xmath700 is _ redundant _ if there exist indices @xmath701 such that @xmath702 for any tuple @xmath5 ; otherwise we say that @xmath6 is _",
    "irredundant_. if there exist indices @xmath701 such that @xmath702 for any tuple @xmath5 , and furthermore there exist at least two distinct values @xmath69 and @xmath70 that appear as the @xmath48-th coordinate of tuples in @xmath6 , then we say that @xmath6 is _",
    "biredundant_. stated differently , @xmath6 is biredundant if the projection of @xmath6 onto two indices yields the equality relation on a set with at least 2 elements .",
    "let @xmath2 be a core structure such that @xmath2-csp is first - order definable , and let @xmath4 be a structure whose basic relations are contained in the relational clone generated by the basic relations of @xmath2",
    ". then    1 .",
    "the problem @xmath4-csp is in * l * ; 2 .",
    "if @xmath4-csp is not first - order definable , then it is * l*-complete ; 3 .",
    "if none of the basic relations of @xmath4 is biredundant then @xmath4-csp is first - order definable ; if @xmath4 is a core the converse holds as well .",
    "the first two statements follow from theorem 5 of @xcite and theorem 3.1 of @xcite . indeed , the problem @xmath703(@xmath4-csp ) is definable in symmetric datalog , which is enough to ensure that @xmath4-csp is solvable in logspace . furthermore , every csp which is not first - order definable is * l*-hard .    for the third statement",
    "we argue as follows : suppose first that no basic relation of @xmath4 is biredundant . since @xmath2 is a core with first - order definable csp , by corollary [ 1antoa ] there exists a map @xmath290 which is a homomorphism from @xmath253 to @xmath2 .",
    "we shall prove that @xmath290 is also a homomorphism from @xmath704 to @xmath4 which will conclude the proof by corollary [ 1antoa ] .",
    "let @xmath705 .",
    "if @xmath6 is irredundant then in the description of @xmath6 in lemma [ 6constr ] ( 4 ) we may choose the elements @xmath379 to be distinct .",
    "let @xmath706 be homomorphisms from @xmath696 to @xmath2 yielding tuples in @xmath6 , and let @xmath707 be _ any _ map .",
    "it is easy to see that the map @xmath708 is a homomorphism from @xmath696 to @xmath2 , and hence @xmath290 is 1-tolerant for @xmath6 . in the case where @xmath6 is redundant",
    ", the argument is almost the same : if for some indices we have @xmath709 , since @xmath6 is not biredundant , it follows that the value of @xmath706 at @xmath93 and @xmath395 is a unique value , call it @xmath69 ; since @xmath290 is a near - unanimity operation by lemma [ nuf ] , it follows that the value of @xmath201 at @xmath93 and @xmath395 is the same and so the tuple produced by @xmath201 is in @xmath6 .",
    "conversely , suppose that @xmath4 is a core and that one of its basic relations is biredundant : we shall show that the structure @xmath580 does not dismantle to the diagonal .",
    "indeed , suppose that @xmath6 is biredundant and without loss of generality suppose that its projection on the first two coordinates is the equality relation on some subset @xmath57 of @xmath46 containing elements 0 and 1 .",
    "suppose that we have a dismantling of @xmath580 : let @xmath710 be the successive subsets of @xmath711 obtained by removal of single elements .",
    "we prove by induction that for every @xmath48 there exists a tuple of the form @xmath712 with all entries in @xmath713 .",
    "this is clear for @xmath714 .",
    "now suppose that there is such a tuple @xmath715 with all entries in @xmath713 and that @xmath716 is obtained from @xmath713 by removal of @xmath717 .",
    "if @xmath717 does nt appear in @xmath718 then we re done ; otherwise by definition of dismantling there exists some element @xmath719 that dominates @xmath717 and so the tuple obtained from @xmath718 by replacing every occurrence of @xmath717 by @xmath720 is in @xmath721 .",
    "it is clear that @xmath722 because otherwise the tuple @xmath723 would be in @xmath721 contrary to the fact that @xmath721 is biredundant .",
    "hence there is a tuple of the desired form with entries in @xmath716 , showing that no dismantling can end in the diagonal .",
    "we have described a simple polynomial - time algorithm that determines if a finite relational structure is a core with first - order definable csp ( theorem  [ focoreispoly ] ) , and have proved that deciding fo - definability is * np*-complete ( theorem  [ foisnpc ] ) .",
    "we have also given various characterisations of fo - definable structures in terms of sets of obstructions ( theorem  [ foequivalences ] ) , and proved that core structures with finite duality admit a 1-tolerant near - unanimity operation ( corollary  [ 1antoa ] and lemma  [ nuf ] ) .",
    "feder and vardi s theorem  [ tddecidable ] shows that the problem of determining whether an input structure @xmath2 has tree duality is decidable .",
    "in fact the proof of theorem  [ foisnpc ] also implies that this problem is np - hard , but for the moment it is not known to belong to np or even to p - space .",
    "it would be interesting to have these issues resolved .    in the case of first - order definable csp s , we now have an algorithm which outputs a yes - no answer to the question as to whether an input structure @xmath2 has a first - order definable csp . using lemma  [ treesofagivendiameter ] ,",
    "it is possible to modify it so that in the case where @xmath2-csp is first - order definable , it outputs a first - order sentence @xmath724 such that @xmath4 admits a homomorphism to @xmath2 if and only if @xmath724 is true on @xmath4 .",
    "however the upper bound on the length of @xmath724 involves a tower of exponents .",
    "it is not clear whether this is realistic ; @xcite reports cases where the length of @xmath724 can be logarithmic in terms of the size of @xmath2 , but there are no examples in the direction of the other extreme .",
    "e.  allender , m.  bauland , n.  immerman , h.  schnoor , and h.  vollmer .",
    "the complexity of satisfiability problems : refining schaefer s theorem . in _ proc .",
    "30th math .  found .  of comp .",
    "( mfcs05 ) _ , pages 7182 , 2005 .",
    "b.  larose and p.  tesson .",
    "universal algebra and hardness results for constraint satisfaction problems .",
    "http://www.informatik.uni-trier.de/%7eley/db/conf/icalp/icalp2007.html#laroset07[icalp 2007 ] , 267 - 278 ."
  ],
  "abstract_text": [
    "<S> we describe simple algebraic and combinatorial characterisations of finite relational core structures admitting finitely many obstructions . as a consequence , </S>",
    "<S> we show that it is decidable to determine whether a constraint satisfaction problem is first - order definable : we show the general problem to be * np*-complete , and give a polynomial - time algorithm in the case of cores . </S>",
    "<S> a slight modification of this algorithm provides , for first - order definable csp s , a simple poly - time algorithm to produce a solution when one exists . as an application of our algebraic characterisation of first order csp s </S>",
    "<S> , we describe a large family of * l*-complete csp s . </S>"
  ]
}