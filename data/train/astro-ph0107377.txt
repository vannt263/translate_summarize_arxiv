{
  "article_text": [
    "when monte carlo methods are used to compute the spectra of astronomical sources , it is advantageous to work with _ indivisible _ monochromatic packets of radiant energy and to impose the constraint that , when interacting with matter , their energy is conserved in the co - moving frame .",
    "the first of these constraints leads to simple code and the second facilitates convergence to an accurate temperature stratification .    for a static atmosphere",
    ", the energy - conservation constraint automatically gives a divergence - free radiative flux even when the temperature stratification differs from the radiative equilibrium solution .",
    "a remarkable consequence is that the simple @xmath0-iteration device of adjusting the temperature to bring the matter into thermal equilibrium with the monte carlo radiation field results in rapid convergence to the close neighbourhood of the radiative equilibrium solution ( lucy 1999a ) .",
    "an especially notable aspect of this success is that this temperature - correction procedure is geometry - independent , and so these methods readily generalize to 2- and 3-d problems .    for an atmosphere in differential motion , the energy - conservation constraint yields a radiative flux that is rigorously divergence - free in every local matter frame .",
    "determining the temperature stratification by bringing matter into thermal equilibrium with such a radiation field - i.e. , by imposing radiative equilibrium in the co - moving frame - is an excellent approximation if the local cooling time scale is short compared to the local expansion time scale .",
    "this condition is well satisfied for the spectrum - forming layers of supernovae ( sne ) and of hot star winds ( klein & castor 1978 ) .",
    "the constraint that the energy packets be indivisible is advantageous from the point of view of coding simplicity .",
    "the interaction histories of the packets are then followed one - by - one as they propagate through the computational domain , with there being no necessity to return to any of a packet s interactions in order to continue or complete that interaction .",
    "this is to be contrasted with a monte carlo code that directly simulates physical processes by taking its quanta to be a sampling of the individual photons .",
    "absorption of a monte carlo quantum is then often followed by the emission of several quanta as an atom cascades back to its ground state .",
    "multiple returns to this interaction are then necessary in order to follow the subsequent paths of each of these cascade quanta .",
    "the resulting coding complexity is of course compounded by some of these quanta creating further cascades .",
    "although coding simplicity argues strongly for indivisible packets , a counter argument is the apparent implied need to approximate the treatment of line formation .",
    "thus , in monte carlo codes for studying the dynamics of stellar winds ( abbott & lucy 1985 ; lucy & abbott 1993 ) or for synthesizing the spectra of sne ( lucy 1987 ; mazzali & lucy 1993 ) , the integrity of the packets could readily be maintained since lines were assumed to form by coherent scattering in the matter frame . but significantly , an improved sn code has recently been described ( lucy 1999b ) in which branching into the alternative downward transitions is properly taken into account without sacrificing indivisibility .",
    "accordingly , an obvious question now is whether monte carlo techniques can be developed that enforce energy - packet indivisibility and yet do not have to adopt _ any _ simplifications with regard to line formation .",
    "if this can be achieved , then monte carlo codes for general nlte transfer problems become feasible .",
    "as discussed in sect .",
    "1 , it is common in monte carlo transfer codes to quantize radiation into monochromatic energy packets .",
    "but matter is not quantized , neither naturally into individual atoms nor artificially into parcels of matter .",
    "instead , the continuum description of matter is retained , with macroscopic absorption and scattering coefficients governing the interaction histories of the energy packets .    nevertheless , it now proves useful to imagine that matter is quantized into _ macro - atoms _ whose properties are such that their interactions with energy packets asymptotically reproduce the emissivity of a gas in statistical equilibrium . but",
    "these macro - atoms , unlike energy packets , do not explicitly appear in the monte carlo code .",
    "as conceptual constructs , they facilitate the derivation and implementation of the monte carlo transition probabilities that allow in an accurate treatment of line formation .",
    "the general properties of macro - atoms are as follows :    \\1 ) each macro - atom has discrete internal states in one - to - one correspondence with the energy levels of the atomic species being represented .",
    "\\2 ) an inactive macro - atom can be activated to one of its internal states @xmath1 by absorbing a packet of kinetic energy or a packet of radiant energy of an appropriate co - moving frequency .",
    "\\3 ) an active macro - atom can undergo an internal transition from state @xmath1 to any other state @xmath2 without absorbing or emitting an energy packet .",
    "\\4 ) an active macro - atom becomes inactive by emitting a packet of kinetic energy or a packet of radiant energy of an appropriate co - moving frequency .",
    "\\5 ) the de - activating packet has the same energy in the macro - atom s frame as the original activating packet .",
    "figure 1 illustrates these general rules .",
    "an inactive macro - atom , with internal states shown schematically , encounters a packet of energy @xmath3 and is activated to one of these states .",
    "the active macro - atom then undergoes two internal transitions before de - activating itself by emitting a packet of energy @xmath3 .",
    "subsequently , energy packets will in general be referred to as @xmath4-packets but also as @xmath5- or @xmath6-packets when specifying their contents to be radiant or kinetic energy , respectively .",
    "2 , the concept of a macro - atom was introduced by stating some general properties concerning its interaction with @xmath4-packets .",
    "the challenge now is to derive explicit rules governing a macro - atom s activation , its subsequent internal transitions , and its eventual de - activation .",
    "asymptotically , the result of obeying these rules must be the emissivity corresponding to statistical equilibrium .      for the moment , we drop the notion of a macro - atom and consider a real atomic species interacting with its environment .",
    "let @xmath7 denote the excitation _ plus _ ionization energy of level @xmath1 and let @xmath8 denote the radiative rate for the transition @xmath9 .",
    "the rates per unit volume at which transitions into and out of @xmath1 absorb and emit radiant energy are then @xmath10 respectively , where @xmath11 .",
    "note the summation convention adopted for the suffix @xmath12 , which ranges over all levels @xmath13 , including those of lower ions .",
    "similarly , below , the suffix @xmath14 implies summation over all levels @xmath15 , including those of higher ions .    the corresponding rates at which kinetic energy is absorbed from , or contributed to , the thermal pool by transitions to and from level @xmath1 are @xmath16 where @xmath17 is the collisional rate per unit volume for the transition @xmath9 .",
    "if we now define the total rate for the transition @xmath9 to be @xmath18 , then the net rate at which level @xmath1 absorbs energy is @xmath19 this is an identity that follows directly from the defining eqs.(1 ) and ( 2 ) ; it is therefore quite general and does not assume statistical equilibrium .",
    "we now assume that the level populations @xmath20 are in statistical equilibrium . for level @xmath1 , this implies that @xmath21 a useful alternative representation of statistical equilibrium is obtained by multiplying eq.(4 ) by @xmath7 and then eliminating the term @xmath22 using eq.(3 ) .",
    "the result can be written in the form @xmath23 eq.(4 ) , the conventional equation of statistical equilibrium , balances the rates at which basic atomic processes excite and de - excite level @xmath1 . as such , it directly relates to nature s quantization of radiation into photons and of matter into atoms .",
    "in contrast ,",
    "eq.(5 ) , though mathematically equivalent , deals with macroscopic energy flow rates in a finite volume element .",
    "these flows can now be quantized into indivisible @xmath4-packets .",
    "moreover , we can think of the volume element as a macro - atom with discrete energy states .",
    "eq.(5 ) expresses the fact that in statistical equilibrium the contribution from level @xmath1 to the energy content of unit volume is stationary . in consequence ,",
    "the net rate at which level @xmath1 gains energy - the right - hand side of eq.(5 ) - equals the net rate of loss - the left - hand side .",
    "but the importance here of eq.(5 ) lies in the various terms contributing to gains and losses by level @xmath1 and their relevance for constucting transition rules for macro - atoms",
    ". the net rate of gain comprises the expected absorption terms @xmath24 and @xmath25 plus the terms @xmath26 and @xmath27 that clearly represent energy flows into @xmath1 from upper and lower levels .",
    "similarly , the net rate of loss comprises the expected emission terms @xmath28 and @xmath29 plus the terms @xmath30 and @xmath31 representing energy flows out of @xmath1 to upper and lower levels .",
    "the above remarks imply definitive values for the energy flows between level @xmath1 and other levels . but",
    "this is not true .",
    "if eq.(4 ) is rewritten as @xmath32 then comparison with eq.(5 ) shows immediately that an arbitrary quantity of energy @xmath33 may be added to @xmath7 and @xmath34 without invalidating this equation .",
    "but this merely shifts the zero point of the energy scale for excitation and ionization , which we are always free to do .",
    "nevertheless , this freedom implies a corresponding indefiniteness in the energy flow rates between levels .      notwithstanding this indefiniteness , we now interpret eq.(5 ) in terms of macro - atoms absorbing and emitting @xmath4-packets or undergoing transitions between internal states . in this interpretation , the terms @xmath24 and",
    "@xmath25 obviously represent the activation of macro - atoms to state @xmath1 due to the absorption of @xmath5-packets and of @xmath6-packets , respectively .    now consider an ensemble of active macro - atoms in state @xmath1 .",
    "for this ensemble to reproduce the behaviour of the real system , the relative numbers of the macro - atoms that subsequently de - activate with the emission an @xmath5- or @xmath6-packet or which make a transition to another internal state must be proportional to the relative values of the corresponding terms on the left - hand side of eq.(5 ) . accordingly , for an individual macro - atom in state @xmath1 , the probabilities that it de - activates with the emission of an @xmath5-packet or a @xmath6-packet are @xmath35 where @xmath36 similarly , the probabilities that it makes an internal transition to _ particular _ upper or lower states are @xmath37 unlike transition probabilities for real atoms , these analogues for macro - atoms depend on ambient conditions . consequently , in the course of a nlte calculation , they are iterated on just as are eddington factors in various other radiative tranfer schemes ( auer & mihalas 1970 ; hummer & rybicki 1971 ) .",
    "moreover , as with eddington factors , the monte carlo transition probabilities are dimensionless ratios that are likely to converge faster than do their dimensional numerators and denominators .      when eq.(5 ) is summed over all energy levels , the energy flows between different levels cancel , giving @xmath38 thus , in statistical equilibrium , the energy stored in the form of excitation and ionization is stationary . for the macro - atoms ,",
    "this is obeyed rigorously by each activation - de - activation event since the emitted packet s energy equals that of the absorbed packet - see figure 1 .",
    "monte carlo transition probabilities have been defined in sect . 3 , but their non - negativity was not established . of concern in this regard",
    "is stimulated emission when level populations are inverted .",
    "however , in anticipation of this issue , radiative rates were introduced without specifying whether stimulated emission contributes positively to @xmath8 or negatively to @xmath39 .",
    "we now exploit this flexibility in order to avoid negative probabilities .      in the general case",
    ", inverted level populations may occur - i.e. , @xmath40 for some @xmath41 .      in order to prevent the probabilities becoming negative when levels invert",
    ", stimulated emissions must be added to spontaneous emissions and _ not _ treated as negative absorptions .",
    "accordingly , for bound - bound ( b - b ) transitions , the radiative rates per unit volume are defined to be @xmath42 where @xmath43 and @xmath44 are the mean intensities averaged over the line s emission and absorption profiles - see mihalas ( 1978 , p78 ) .",
    "similarly , for free - bound ( f - b ) and bound - free ( b - f ) transitions , we define @xmath45 here @xmath46 and @xmath47 are the rate coefficients for spontaneous and stimulated recombinations to level @xmath1 , and @xmath48 is the uncorrected rate coefficient for photoionizations from level @xmath1 . each of these three quantities can be expressed as an integral over frequency involving the b - f absorption coefficient for an atom excited to level @xmath1 - see mihalas ( 1978 , pp130 - 131 ) .",
    "for collisions , a population inversion gives a negative rate if de - excitations are treated as negative excitations .",
    "this is avoided by defining @xmath49 with these expressions for the radiative and collisional rates , the probabilities defined by eqs.(7 ) and ( 9 ) are non - negative provided only that the @xmath7 s are non - negative .",
    "this latter condition is satisfied with the standard convention that the ground state of the neutral atom has zero excitation energy .      because @xmath50 and therefore @xmath24 are here defined without correcting for stimulated emission , the macroscopic line- and continuum - absorption coefficients that determine the flight paths of @xmath5-packets",
    "must also be defined without this correction .",
    "this ensures a positive absorption coefficient even for a transition with a population inversion .",
    "if the monte carlo transition probabilities result in a macro - atom de - activating radiatively from state @xmath1 , the next step is to determine the frequency of the photons comprising the emitted @xmath5-packet .",
    "first we suppose that @xmath1 corresponds to a bound level .    because @xmath51 and therefore @xmath28 here include stimulated emission , the process that radiatively de - activates the macro - atom may be either a spontaneous or a stimulated emission .",
    "the ratio of the probabilities of these alternatives is @xmath52 , where @xmath53 are the contributions to @xmath54 from spontaneous and stimulated emissions .",
    "knowing @xmath55 , we can choose between the two alternatives with a standard monte carlo procedure .",
    "thus , if @xmath56 is a random number from the interval @xmath57 , we select spontaneous emission if @xmath58 and stimulated otherwise .",
    "having thus decided the emission process , we must next choose a downward transition .",
    "for spontaneous line emission , the transition @xmath9 is selected with probability @xmath59 . for stimulated emission , on the other hand , the selection probability is @xmath60 .",
    "with the transition thus determined , the frequency @xmath61 of the @xmath5-packet is selected by randomly sampling the line s emission profile @xmath62 .",
    "thus , if @xmath56 again denotes a random number from @xmath57 , then @xmath61 is determined by the equation @xmath63 this equation can of course always be solved numerically for @xmath61 . however ,",
    "elegant and efficient procedures for sampling standard profiles are available ( lee 1974a , b ) .",
    "now we consider a macro - atom that de - activates from a continuum state @xmath64 . in this case , the probabilities of spontaneous and stimulated emission are in the ratio @xmath65 , where @xmath66 are the contributions to @xmath67 from spontaneous and stimulated emissions .",
    "thus @xmath61 is selected by first deciding between spontaneous and stimulated emission and then randomly sampling the energy distribution of the chosen process s recombination continua .",
    "if the above selection procedure rules that an @xmath5-packet is emitted spontaneously , then a new direction of propagation is chosen in accordance with this process s isotropic emission . on the other hand , for stimulated emission , the new direction of propagation is that of the stimulating photon . thus , the new direction will be in solid angle @xmath68 at @xmath69 with probability @xmath70 , where @xmath61 is the frequency of the emitted @xmath5-packet .",
    "accordingly , a monte carlo code that treats stimulated emission separately must store a complete description of the radiation field - i.e. , @xmath71 .      for problems where population inversions are not anticipated",
    ", we can usefully make the traditional assumption that lines have identical emission and absorption profiles and treat stimulated emissions as negative absorptions - see mihalas ( 1978 , p78 ) .",
    "the radiative rates for b - b transitions are then @xmath72 similarly , for f - b and b - f transitions , we define @xmath73 where the photionization coefficient is now corrected for stimulated recombinations .    for collisions ,",
    "the absence of population inversions allows us to treat de - excitations as negative excitations without the risk that eqs.(7 ) and ( 9 ) will give negative probabilities .",
    "accordingly , we now define @xmath74 this then implies that @xmath75 and therefore also @xmath76 for all @xmath1 .",
    "energy transfer from the radiation field to the thermal pool then occurs _ explicitly _ only via f - f absorptions .",
    "because @xmath77 and therefore @xmath24 are here defined with the correction for stimulated emission included , the macroscopic line- and continuum - absorption coefficients must also include this correction . in the posited absence of population inversions , these absorption coefficients are positive .",
    "because @xmath51 and therefore @xmath28 now exclude stimulated emission , the process that radiatively de - activates a macro - atom is always a spontaneous emission .",
    "if @xmath1 is a bound state , the frequency @xmath61 of the emitted @xmath5-packet is then decided as follows : the transition @xmath9 is selected with probability @xmath78 , and then @xmath61 is selected by randomly sampling this transition s emission profile , as in sect .",
    "4.1.3 .    for de - activation from a continuum state",
    ", @xmath61 is selected by randomly sampling the energy distribution of the spontaneous recombination continua .      because the de - activating process is in this case spontaneous emission",
    ", the new direction of propagation is selected according to isotropic emission .",
    "thus , we now do not need to store @xmath71 .",
    "in fact , from the monte carlo radiation field generated at one iteration , we only require the mean intensities @xmath79 .",
    "these allow us to compute transition probabilities from eqs.(7 ) and ( 9 ) for use during the next iteration .",
    "the procedures described in sects . 4.1 and 4.2 apply to",
    "both static and moving media .",
    "but for some important problems involving moving media , a substantial speeding up of the calculation with negligible loss of accuracy is possible by applying sobolev s theory of line formation . in doing so",
    ", we take advantage of a small dimensionless quantity - the ratio of a line s doppler width to the typical flow velocity , which implies an essentially constant velocity gradient over the zone in which a given pencil of radiation interacts with a particular line .",
    "the monte carlo codes for hot star winds and sne cited in sect .",
    "1 treat line formation in the sobolev approximation .",
    "the simplest case of this kind is that of homologous spherical expansion , as is commonly assumed for sne . this case will be treated here since it will be used in the test calculations of sect .",
    "generalization to a spherically - symmetric stellar wind is readily carried out by referring to castor & klein ( 1978 ) .",
    "we also assume no population inversions and so treat stimulated emissions as negative absorptions , as in sect . 4.2 .",
    "the radiative rates for b - b transitions are then @xmath80 here @xmath81 is the mean intensity at the far blue wing of the transition @xmath82 , and @xmath83 is the sobolev escape probability for this transition , given by @xmath84 \\;\\;\\ ; , \\ ] ] where @xmath85 , the transition s sobolev optical depth , is @xmath86 with @xmath87 being the elapsed time since the sn exploded .",
    "for f - b and b - f transitions , the rates are as in eq.(18 ) . for collisions ,",
    "the rates are as in eq.(19 ) .",
    "the absorption of @xmath5-packets by lines is determined by the sobolev optical depths given by eq.(22 ) .",
    "absorption of an @xmath5-packet to the continuum is determined by the conventional macroscopic absorption coefficient corrected for stimulated emission .",
    "the frequency of an emitted @xmath5-packet is decided as follows : for de - activation from a bound state @xmath1 , the transition @xmath9 is selected with probability @xmath88 , where @xmath28 is evaluated with eq.(1 ) using the decay rates from eq.(20 ) , and the emitted packet is assigned frequency @xmath89 - i.e. , it is in the far red wing of a line whose emission profile is approximated by a delta function .",
    "the packet s next possible b - b transition is therefore with the next line to the redward of @xmath90 ( abbott & lucy 1985 ) .",
    "for de - activation from a continuum state , the new frequency is , as in sect .",
    "4.2.3 , selected by randomly sampling the energy distribution of the spontaneous recombination continua .",
    "if an @xmath5-packet is emitted from a continuum state , the new direction of propagation is selected according to isotropic emission since the emission in this case is spontaneous . for de - activation from a bound state ,",
    "the emission is also isotropic since , for homologous expansion , there is no kinematically - preferred direction .",
    "this is not true for a stellar wind .",
    "the monte carlo transition probabilities derived in sect .",
    "3 are designed to reproduce asymptotically the emissivity of an atomic species whose level populations are in statistical equilibrium . to test this ,",
    "we now consider one - point problems with specified and fixed ambient conditions .",
    "such tests sensibly precede application to a general nlte problem , for then the local ambient conditions are everywhere being adjusted iteratively as the global solution is sought .      in the initial tests ,",
    "the monte carlo transition probabilities are applied to the model fe ii ion with @xmath91 levels used previously ( lucy 1999b ) to investigate the accuracy of approximate treatments of line formation in sne envelopes .",
    "the energy levels of the fe ii ion and the f - values for permitted transitions were extracted from the kurucz  bell ( 1995 ) compilation by m.lennon ( munich ) .",
    "einstein a - values for forbidden transitions are from quinet et al.(1996 ) and nussbaumer & storey ( 1988 ) .",
    "collision strengths , needed for sect.5.1.5 , are from zhang & pradhan ( 1995 ) and van regemorter ( 1962 ) .      in the first fe",
    "ii test , we neglect collisional excitations and , as previously ( lucy 1999b ) , take the ambient radiation field determining the quantities @xmath81 in eq.(20 ) to be @xmath92 with @xmath93 and dilution factor @xmath94 , corresponding to @xmath95 .",
    "the density parameter is @xmath96 , and the time since explosion is @xmath97 . with parameters specified , this one - point statistical equilibrium problem - eq.(4 ) for @xmath98 levels plus a normalization constraint",
    "- is non - linear in the unknowns @xmath20 because the rate coefficients in eq.(20 ) depend on the @xmath20 through the sobolev escape probabilities .",
    "fortunately , repeated back substitutions give a highly accurate solution @xmath99 in @xmath100 10 iterations .      with @xmath99 determined , the fe ii level emissivites @xmath28 and absorption rates @xmath24",
    "can be computed from eq.(1 ) .",
    "we now test the monte carlo transition probabilities by seeing how accurately they reproduce these values @xmath28 .",
    "note that it is sufficient to test _ level _ emissivities since if these are exact so also are the line emissivities computed as described in sect .",
    "4.3.3 .    in the following monte carlo experiment ,",
    "@xmath101 packets of radiant energy are absorbed and subsequently emitted by a macro - atom representing a macroscopic volume element of fe ii ions in the ambient conditions specified above .",
    "the energies of these packets are taken to be equal and given by @xmath102 , where @xmath103 .",
    "the calculation proceeds step - by - step as follows :    \\1 ) @xmath104 of the packets activate the macro - atom to internal state @xmath1 .",
    "\\2 ) the transition probabilities @xmath105 , @xmath106 and @xmath107 for a macro - atom in state @xmath1 are computed from eqs.(7 ) and ( 9 ) .",
    "\\3 ) the transition probabilities sum to one , so each corresponds to a segment @xmath108 of the interval ( 0,1 ) . a particular transition is therefore selected by computing a random number @xmath56 in ( 0,1 ) and finding in which segment it falls .",
    "\\4 ) if the selected transition is the de - activation of the macro - atom , we update @xmath109 to @xmath110 and then return to step 3 ) to process the next activation of state @xmath1 , or to step 2 ) to process the first of the packets that activate the macro - atom to state @xmath111 .",
    "\\5 ) if the selected transition is an internal transition to state @xmath2 , then we return to step 2 ) with @xmath2 replacing @xmath1 .",
    "\\6 ) when all @xmath101 packets have been processed , the final elements of the vector @xmath109 are the estimates of the level emissivities @xmath28      as a single measure of the accuracy of the estimated level emissivities , we compute the quantity @xmath112 this is the mean of the absolute fractional errors of the @xmath109 when weighted by @xmath28 .    figure 2 shows the values of @xmath113 , expressed as percentage errors , found in a series of trials with @xmath101 increasing from @xmath114 to @xmath115 . the values of @xmath113 decrease monotonically with increasing @xmath101 , falling to @xmath116 percent for @xmath117 .",
    "more importantly , the errors accurately follow an @xmath118 line , as expected if the only source of error are the sampling error at step 3 ) of the monte carlo experiments . accordingly , to the accuracy of these experiments , macro - atoms obeying the transition probabilities derived in sect .",
    "3 do indeed reproduce the emissivity of a gas in statistical equilibrium .",
    "also included in fig.2 are values of @xmath113 obtained when the transition probabilities are computed with excitation energies @xmath7 increased by 5ev .",
    "this is to investigate the consequences of the dependence of the energy flow terms in eq.(5 ) - and therefore also of the transition probabilities - on the zero point of the scale of excitation energy .",
    "these results also track an @xmath118 line and so indicate that the predicted emissivities are asymptotically independent of the zero point .",
    "but since the open circles are marginally higher , there is an indication that increasing the zero point gives slighty less accurate emissivities at a given @xmath101 .    in the monte carlo codes for hot star winds and sne cited in sect .",
    "1 , line formation is treated approximately , with either resonant scattering or downward branching being assumed .",
    "for both assumptions , @xmath119 , corresponding to a macro - atom for which de - activation always immediately follows activation - i.e. , @xmath120 for all @xmath1 . in this case , as indicated on fig.2 , @xmath121 percent .",
    "thus , when the points in fig.2 drop below this value , the success must be due to the internal , radiationless transitions governed by the probabilities @xmath106 and @xmath107 .",
    "the above experiments show that despite the formidable complexity of its level structure the fe ii ion s reprocessing of radiation is accurately simulated by the monte carlo transition probabilities .",
    "nevertheless , from a computational standpoint , a remaining concern is how many internal transitions - or jumps - does this require ? to answer this ,",
    "the number of jumps before de - activation was recorded for each absorbed packet in the @xmath117 trial and used to derive @xmath122 , the number of packets requiring @xmath2 jumps .    from @xmath122 , we find that the expected number of jumps is @xmath123 and that the probability of immediate de - activation - i.e. , zero jumps - is @xmath124 .",
    "evidently , fears of numerous , time- consuming internal transitions are ill - founded .",
    "figure 3 is a logarithmic plot of @xmath122 .",
    "this reveals a power - law decline with increasing @xmath2 but with alternating deviations indicating that an even number of jumps before de - activation is favoured .",
    "a simple model suggests the origin of this curious behaviour . consider a 3-level atom with @xmath125 and suppose that level 2 is metastable with @xmath126 . because @xmath127 , the macro - atom can only be activated to state 3 ; and because @xmath128 , the macro - atom can not de - activate from state 2 .",
    "moreover , since @xmath129 , eq.(9 ) gives @xmath130 , and so state 1 of the macro - atom can not be reached .",
    "accordingly , following activation at state 3 , the macro - atom de - activates with probability @xmath131 or jumps to state 2 with probability @xmath132 , from whence it returns to state 3 with probability @xmath133 .",
    "it is now simple to prove that the probabilty of @xmath2 jumps before de - activation is @xmath134 if @xmath2 is even , and @xmath135 if @xmath2 is odd . the fe ii ion s numerous low - lying metastable levels are presumably playing the role of level 2 and thereby favouring an even number of jumps .",
    "histograms @xmath122 have also been computed for two other cases .",
    "first , the above trial was repeated with the @xmath7 s increased by 5ev as in sect .",
    "this change increases @xmath136 - to 4.54 - as expected since the probabilities @xmath106 and @xmath107 are thereby increased and @xmath105 correspondingly decreased .",
    "evidently , the standard choice of energy - level zero point leads to the most computationally - efficient set of transition probabilities .    in the second case",
    ", @xmath137 is decreased from 0.5 to 0.067 , corresponding to @xmath138 .",
    "this change decreases @xmath136 - from 2.19 to 1.29 - as expected given the weakening of the radiative excitation rates .      in the above experiment",
    ", the emission derives entirely from radiative excitation since collisions were neglected .",
    "now we consider the opposite extreme by setting the ambient radiation field to zero but including collisions .",
    "the only parameters of this test are the electron temperature and density , and these are assigned the values @xmath139 and @xmath140 .",
    "the resulting statistical equilibrium problem is linear and so solved without iteration .",
    "for this solution , accurate values of the level emissivities @xmath28 are again computed from eq.(1 ) .",
    "the next step is to derive estimates of the level emissivities by repeating the monte carlo experiment of sect.5.1.2 .",
    "the only changes needed are the following : first , since the solution has population inversions the general formulation of sect .",
    "4.1 must be adopted to avoid negative probabilities .",
    "secondly , since a macro - atom is now always activated by a @xmath6-packet , their energies are taken to be @xmath141 , where @xmath142 .",
    "correspondingly , at step 1 ) of the experiment , @xmath143 .",
    "thirdly , since a macro - atom can now de - activate by emitting either an @xmath5- or a @xmath6-packet , only the former results in an updating of @xmath109 .",
    "the emission of a @xmath6-packet represents the return of energy @xmath3 to the therrmal pool .",
    "apart from these changes , the convergence experiment proceeds as in sects .",
    "5.1.2 and 5.1.3 .",
    "the result is a plot similar to fig.2 , but with @xmath144 percent for @xmath117 .",
    "evidently , the monte carlo transition probabilities are equally applicable to problems where collisional excitation is a source of emission .",
    "although the fe ii experiments demonstrate the validity of the monte carlo transition probabilities , a test including b - f and f - b transitions is of interest .",
    "accordingly , a convergence experiment at one point in a sn s envelope has also been carried out for a 15-level model of the h atom , with level 15 being the continuum @xmath64 .",
    "the 14 bound levels correspond to principal quantum numbers @xmath145 , with each level having consolidated statistical weight @xmath146 .",
    "as for fe ii , the ambient radiation field incident on the blue wings of the b - b transitions is @xmath147 , but now with @xmath148 and @xmath149 .",
    "however , beyond the lyman limit , we assume zero intensity , so that photoionizations occur only from excited states .",
    "correspondingly , recombinations to @xmath150 are excluded on the assumption of immediate photoionization .",
    "collisional excitations and ionizations are neglected .",
    "the density parameter is @xmath151 , the electron temperature @xmath152 , and the time since explosion @xmath153 . with parameters specified ,",
    "this non - linear statistical equilibrium problem can also be solved with repeated back substitutions , giving a highly accurate solution @xmath99 in @xmath154 iterations .",
    "with @xmath99 determined , monte carlo experiments as described in sect .",
    "5.1.2 were carried out to test if level emissivities are also recovered in this case . in fig.4 , two such trials , with @xmath155 and @xmath156 , are compared with the exact solution .",
    "the results show that excellent agreement is achieved for @xmath157 .",
    "note in particular the success with @xmath158 , which is the rate of ionization energy loss due to recombinations , and with @xmath159 , whose very low value is due to the strong trapping of @xmath160 photons .",
    "thus far , a monte carlo procedure has been used to validate the transition probabilities developed in sect.3 .",
    "this has the advantage of following closely and therefore illustrating their use in realistic nlte calculations .",
    "but for feasible values of @xmath101 , sampling errors limit the accuracy of such tests .    in order to test to higher precision ,",
    "approximate level emissivities @xmath161 can be computed recursively according to the following scheme : @xmath162 where @xmath105 is the radiative de - activation probability from eq.(7 ) and @xmath163 is the increment at cycle @xmath5 to the summation approximating the rate at which level @xmath1 gains energy - i.e. the right - hand side of eq.(5 ) .",
    "this increment is derived from the previous increment by applying the transition probabilities from eq.(9 ) .",
    "thus @xmath164 and the recursion cycles are initiated by setting @xmath165 this procedure is now applied to the fe ii test problem of sect .",
    "as with that experiment , the accuracy of the vectors @xmath161 are measured by computing @xmath113 defined by eq.(23 ) . for @xmath166 , @xmath113 drops below the value 0.36 percent found in sect.5.1.3 with @xmath117 - see fig.2 . as the recursion procedure continues further",
    ", @xmath113 decreases monotonically until at @xmath167 it drops to a value of @xmath168 , at which point machine precision or accumulated roundoff errors halt further progress .",
    "this test clearly confirms and strengthens the earlier tests of the monte carlo transition probabilities .",
    "the experiments of sect.5 demonstrate that , when computed with the exact level populations @xmath99 , the monte carlo transition probabilities applied to indivisible @xmath4-packets reproduce the exact level emissivities as @xmath169 .",
    "but this success , though necessary , does not of itself imply that the technique will be successful when applied to nlte problems .",
    "for example , if the monte carlo emissivities were to undergo large changes in response to small changes in @xmath20 , then we would reasonably suspect that the iterations inevitably required for a nlte problem would converge very slowly - or might even diverge . on the other hand ,",
    "if the emissivities are insensitive to changes in @xmath20 , then the prospects for successful applications are excellent",
    ".      this crucial question of sensitivity can be investigated by repeating the calculations of fe ii emissivities reported in sect.5.1 , but with @xmath20 perturbed away from @xmath99 . a convenient way of doing this is to replace @xmath99 by the boltzmann distribution at excitation temperature @xmath170 .",
    "then , for given @xmath170 , the corresponding level emissivities @xmath109 are obtained from a monte carlo trial with @xmath171 packets , and so are negligibly affected by sampling errors ( cf .",
    "fig.2 ) .",
    "now , for the given @xmath170 , we can also compute @xmath28 , the level emissivities predicted by the fundamental formulae - eqs.(1 ) and ( 20 ) in this case .",
    "this represents the standard approach to nlte transfer problems whereby the radiation field is computed from the radiative transfer eq .",
    "( rte ) with emissivity coefficients evaluated using the current estimates of @xmath20 .",
    "thus by comparing these two emissivity estimates @xmath109 and @xmath28 , we can see whether this monte carlo technique is potentally capable of yielding a superior estimate of the radiation field .    in fig.5 ,",
    "the quantities @xmath109 and @xmath28 obtained for @xmath172 are plotted against @xmath173 , the exact statistical equilibrium level emissivities - i.e. , the values corresponding to @xmath99 .",
    "remarkably , figure 5 shows that the monte carlo emissivities are far less sensitive to the departure of @xmath20 from @xmath99 than are the emissivities computed directly from the fundamental formula . for the most part , the @xmath109 are in error by @xmath174 dex , with little evidence of bias , while the @xmath28 are systematically offset by @xmath175 dex .",
    "to investigate whether this insensitivity is characteristic of the monte carlo procedure , the above test is now repeated with @xmath170 ranging from @xmath176 to @xmath177 and the resulting mean errors defined by eq.(23 ) plotted in fig.6 .",
    "we see that @xmath28 gives reasonably accurate emissivities only in the immediate neighbourhood of the minimum at @xmath178 . on the other hand , the values @xmath109 are accurate to @xmath179 dex across the entire range .",
    "the causes of these astonishing differences in sensitivity are of considerable interest . for @xmath28 , the strong sensitivity to @xmath170",
    "is readily understood .",
    "because the sum @xmath180 , an error in the population of the emitting level translates directly into an error in @xmath28",
    ".    now consider @xmath109 .",
    "this quantity is determined by the rate at which active macro - atoms reach state @xmath1 , and this happens by direct absorptions of packets into this state or by transitions from other states .",
    "either way , the accuracy of the source vectors @xmath24 and @xmath25 is clearly fundamental to the accuracy of the vector @xmath109 .",
    "but the dominant contributors to the elements of these source vectors - see eqs.(1 ) and ( 2 ) - are transitions from the ground state and from low - lying metastable levels , and the estimated populations of these levels are unlikely to be seriously in error . in particular , with an assumed boltzmann distribution over excited states , the @xmath20 of these low levels is insensitive to @xmath170 and do not differ much from @xmath99 .",
    "in contrast , the populations of high levels are quite likely to be badly estimated and are acutely sensitive to @xmath170 .",
    "another way of appreciating the differences in these approaches to calculating emissivities is as follows .",
    "the monte carlo procedure applies only to a state of statistical equilibrium and , as such , constrains every level s emissivity to be consistent with the rates of processes populating that level .",
    "in contrast , the fundamental emissivity formula applies also to states out of statistical equilibrium and so takes no account of whether the levels populations can be maintained .",
    "accordingly , with this monte carlo technique , the principle of statistical equilibrium is _ incorporated _ ( approximately ) as the radiation field is being calculated . on the other hand , when emissivities are computed from the fundamental formula , any consideration of statistical equilibrium is effectively being deferred until the updated radiation field has been determined .",
    "the likely beneficial impact of this insensitivity on the iterations needed to derive nlte solutions is worth stressing . with the conventional rte approach , an erroneously overpopulated upper level",
    "@xmath1 pollutes the radiation field with spurious line photons at frequencies @xmath181 , and these are sources of excitation for level @xmath1 when level populations are next solved for .",
    "similarly , an erroneously overpopulated upper ion pollutes the radiation field with recombination photons that are subsequent sources of photoionization for the lower ion . to some degree , therefore , such errors are _ self - perpetuating _ and so are not rapidly eliminated .",
    "this persistency contributes to the slow convergence typical of nlte codes .",
    "in contrast , with the monte carlo approach , this pollution does not happen and so - for sufficiently large @xmath182 - a high quality radiation field is obtained immediately provided that the initial populations of the low - lying levels are estimated sensibly .",
    "the monte carlo transition probabilities allow statistical equilibrium to be incorporated into the calculation of radiation fields for nlte problems .",
    "moreover , this is achieved without imposing the constraint of radiative equilibrium .",
    "accordingly , in principle at least , the technique applies equally to problems with non - radiative heating , such as stellar chromospheres .      in the absence of non - radiative heating , a nlte transfer problem",
    "must be solved subject to the constraint of radiative equilibrium .",
    "the incorporation of this _ additional _ constraint into the macro - atom formalism is readily understood .",
    "first suppose that collisional processes are neglected .",
    "the absorbed and the emitted @xmath4-packets are then always @xmath5-packets and they have identical energies - see fig.1 . thus , the constraint of radiative equilibrium is obeyed rigorously since it holds exactly for every activation - de - activation event , all of which are of the form @xmath183 , where @xmath184 denotes an active macro - atom .",
    "note also that since active macro - atoms do not appear spontaneously within the computational domain ( d ) , every monte carlo quantum s interaction history starts and ends as an @xmath5-packet crossing a boundary of d.    now suppose that collisions are included . in this case",
    ", a macro - atom activated by an @xmath5-packet can de - activate itself by emitting a @xmath6-packet , so that radiative equilibrium no longer holds exactly for each individual activation - de - activation event .",
    "however , the emitted @xmath6-packet is re - absorbed _ in situ _ by another macro - atom and thereby ( eventually ) converted into an @xmath5-packet . since this has the same energy as the original @xmath5-packet , radiative equilibrium holds for every sequence of in situ events that starts with the absorption of an @xmath5-packet and ends with the next emission of an @xmath5-packet .",
    "a typical in situ sequence is @xmath185 .",
    "if such sequences are abbreviated as @xmath186   \\rightarrow r$ ] , we see that the inclusion of collisions has not fundamentally changed the procedure and that radiative equilibrium is still rigorously obeyed .      in the presence of non - radiative heating ,",
    "the nlte problem is not subject to the additional constraint of radiative equilibrium .",
    "statistical equilibrium is incorporated with the macro - atom formalism as before , and the challenge now is to incorporate the creation of radiant energy within d due to the additional heating .",
    "this is accomplished by allowing for the spontaneous and random appearance within d of active macro - atoms with their number , locations and internal states @xmath1 all controlled by the collision source vector @xmath25 - cf .",
    "note that because this sampling of @xmath25 takes full account of the collisional creation of excitation , the emission of a @xmath6-packet is not now followed by its in situ re - absorption ; instead , the interaction history of that monte carlo quantum then ends and its energy is added to the thermal pool ( cf . sect.5.1.5 . ) .",
    "the radiation field generated by this procedure is not divergence - free but reflects the collisional creation of radiant energy due to an elevated temperature profile maintained by the non - radiative heating .",
    "the limited aim of this paper has been to see if monte carlo transfer codes whose quanta are indestructable energy packets can be constructed without resorting to simplified treatments of line formation . to this end",
    ", the concept of a macro - atom has been introduced and rules established governing its activation and de - activation as well as its transitions between internal states .",
    "these rules - the monte carlo transition probabilities - have been derived by demanding that the macro - atom s emission of @xmath5-packets asymptotically reproduces the local emissivity of a gas in statistical equilibrium ; and these rules validity has been confirmed with one - point test problems .",
    "evidently , the next step is to implement these transition probabilities in a code to solve a realistic nlte problem for a stratified medium and thus to investigate the practicality of this technique for problems of current interest . in a companion paper , a monte carlo nlte code treating the formation of h lines in a type ii sn envelope",
    "will be described and used to illustrate the convergence behaviour of iterations to obtain both the level populations and the temperature stratification .",
    "abbott d.c .",
    ", lucy l.b . 1985 ,",
    "apj 288 , 679 auer l.h . ,",
    "mihalas d. 1970 , mnras 149 , 65 hummer d.g . , rybicki g.b .",
    "1971 , mnras , 152 , 1 klein r.i .",
    ", castor j.i .",
    "1978 , apj 220 , 902 kurucz r.l . ,",
    "bell b. , 1995 , kurucz cd - rom no .",
    "23 lee j .- s .",
    "1974a , apj 187 , 159 lee j .- s .",
    "1974b , apj 192 , 465 lucy l.b . , 1987 , in : danziger i.j .",
    "eso workshop on sn 1987a , p. 417",
    "1999a , a&a 344 , 282 lucy l.b .",
    "1999b , a&a 345 , 211 lucy l.b . , abbott d.c .",
    "1993 , apj 405 , 738 mazzali p.a .",
    ", lucy l.b .",
    "1993 , a&a 279 , 447 mihalas d. , 1978 , stellar atmospheres ( 2nd ed . ) .",
    "w.h.freeman & co. , san francisco"
  ],
  "abstract_text": [
    "<S> transition probabilities governing the interaction of energy packets and matter are derived that allow monte carlo nlte transfer codes to be constructed without simplifying the treatment of line formation . </S>",
    "<S> these probabilities are such that the monte carlo calculation asymptotically recovers the local emissivity of a gas in statistical equilibrium . </S>",
    "<S> numerical experiments with one - point statistical equilibrium problems for fe ii and hydrogen confirm this asymptotic behaviour . </S>",
    "<S> in addition , the resulting monte carlo emissivities are shown to be far less sensitive to errors in the populations of the emitting levels than are the values obtained with the basic emissivity formula . </S>"
  ]
}