{
  "article_text": [
    "there is a general interest in constructing magnetohydrostatic models of the solar atmosphere .",
    "these models describe large - scale , long - lived , magnetic structures like sunspots ( _ e.g. _ @xcite ) , prominences ( _ e.g. _ @xcite ) , coronal loops ( _ e.g. _ @xcite ) , the coronal magnetic field on global scales ( _ e.g. _ ) , and low - lying magnetic structures in the upper photosphere and lower chromosphere ( _ e.g. _ @xcite ) . unfortunately , the equations of the model  the magnetohydrostatic equations  are a set of nonlinear partial differential equations that defy general analytic solution",
    ". only a handful of idealized analytic solutions are known , and existing numerical methods are typically limited to two dimensions .",
    "solution methods for the general three - dimensional equations are lacking , which limits the scope of the modeling . in this article",
    ", we present a new numerical scheme for treating the general three - dimensional problem .",
    "our method is an extension of the grad - rubin method @xcite to include a finite gravity force . + the magnetohydrostatic equations describe a magnetized plasma in which magnetic , pressure , and external forces are in mechanical equilibrium . in the solar context",
    ", the external force is usually gravity , implying that the condition for mechanical equilibrium is @xmath0 @xcite , where @xmath1 is the electric current density , @xmath2 is the magnetic field , @xmath3 is the gas pressure , @xmath4 is the gas density , and @xmath5 is the local acceleration due to gravity .",
    "the special case with @xmath6 is of interest to modeling fusion plasmas ( _ e.g. _ @xcite ) , but in this article we consider only the case with a finite gravity force , which is more relevant to modeling the sun . since @xmath1 is the curl of @xmath2 in accordance with ampre s law , the force - balance equation is nonlinear through the lorentz force term .",
    "it is this nonlinearity that makes the magnetohydrostatic equations difficult to solve .",
    "+ magnetohydrostatic models find various applications in solar physics ( _ e.g. _ ) .",
    "one area where they are becoming increasingly relevant is local helioseismology , where magnetohydrostatic sunspot models are used as the background atmosphere to magnetohydrodynamic wave propagation simulations ( _ e.g. _ @xcite ) .",
    "the present modeling is based on axisymmetric magnetohydrostatic solutions ( see @xcite for a full list of models ) and so is limited to monopolar sunspots . to construct atmospheres for more complex sunspot groups",
    "requires more general solution methods . + data - driven modeling of the coronal magnetic field is another area where three - dimensional magnetohydrostatic models have potential applications .",
    "the coronal magnetic field is often `` extrapolated '' from vector - magnetogram data based on a nonlinear force - free model ( _ e.g. _ ) .",
    "however , it is known that the magnetogram data represent the magnetic field at a height in the atmosphere where pressure and gravity forces , which the force - free model excludes , are significant @xcite .",
    "this inconsistency is a potential source of problems for the modeling ( @xcite,@xcite ) , and a self - consistent approach based on a magnetohydrostatic model has been suggested as a solution but never applied to actual data @xcite . to the best of our knowledge ,",
    "the only magnetohydrostatic extrapolations performed to date have been based on a special class of `` linear ''",
    "magnetohydrostatic solution that assumes a particular functional form for the current density .",
    "these solutions have been used to extrapolate the coronal magnetic field from magnetogram data for several studies ( _ e.g. _ ) + the nonlinearity of the magnetohydrostatic equations complicates their solution , and no method is known for constructing general analytic solutions .",
    "particular analytic solutions , however , can be derived by simplifying the equations at the expense of generality .",
    "one strategy is to reduce the dimensionality of the problem by assuming self - similarity @xcite , translational symmetry @xcite , or rotational symmetry @xcite .",
    "another approach , which produces three - dimensional solutions , is to impose a special form on either the current density or the magnetic tension @xcite .",
    "all these solutions are special cases  the general three - dimensional magnetohydrostatic problem remains unsolved . +",
    "a numerical approach can in principle address the shortcomings of the analytic methods . with this goal ,",
    "a number of numerical methods have been developed , although a majority have only been implemented in two dimensions .",
    "these methods include magnetohydrodynamic relaxation methods ( _ e.g. _ ) , fixed - point iteration methods ( _ e.g. _ @xcite ) , and nonlinear multigrid methods applied to the magnetohydrostatic equations formulated in inverse coordinates ( _ e.g. _ @xcite ) .",
    "this list is not exhaustive : @xcite provide a more complete list of references .",
    "+ less work has been done on numerical methods for the three - dimensional problem .",
    "@xcite develop a three - dimensional inverse coordinate nonlinear multigrid method .",
    "their method also solves the free - surface problem for a flux rope bounded by a current sheet .",
    "the optimization method that was originally introduced by @xcite for solving the nonlinear force - free equations has been extended to treat the magnetohydrostatic equations in cartesian @xcite and spherical coordinates .",
    "+ in this article we develop a fixed - point method for solving the general three - dimensional magnetohydrostatic equations in a cartesian box . in particular , we extend the method of @xcite to model a gravity force .",
    "the original grad - rubin method solves the magnetohydrostatic equations without gravity by replacing the nonlinear equations by a system of linear equations for each unknown variable , which are solved interactively .",
    "the linearization is achieved by constructing nonlinear terms using variables from previous iterations .",
    "for example , the lorentz force is constructed as @xmath7 } \\times \\mathbfit b^{[k]},\\ ] ] which is linear in @xmath8}$ ] , since @xmath9}$ ] is known from a previous iteration ( the superscript denotes the iteration number ) .",
    "this makes it possible to define a system of linear `` update equations '' that relate each variable at the current iteration to those known from previous iterations .",
    "the update equations are solved successively , and a solution to the complete nonlinear system is obtained when and if the iteration converges to a fixed point .",
    "this method has been previously used to solve the magnetohydrostatic equations with @xmath10 @xcite .",
    "it has also been used to solve the nonlinear force - free equations , which is the special case of the magnetohydrostatic equations defined by the condition @xmath11 . in this article",
    "we extend the method to solve the magnetohydrostatic equations with @xmath12 .",
    "+ constructing solutions using a fixed - point method has several potential advantages over the methods of @xcite and @xcite .",
    "firstly , unlike methods formulated in inverse coordinates , our method does not fix the toplogy of the magnetic field _ a priori_. secondly , the method does not overspecify the boundary - value problem like the optimization method .",
    "in this section we describe the details of the magnetohydrostatic model .",
    "we present the equations and formulate the magnetohydrostatic boundary - value problem .",
    "+ the magnetohydrostatic equations in cartesian coordinates are @xcite : @xmath13 @xmath14 and @xmath15 where @xmath2 is the magnetic field , @xmath1 is the electric current density , @xmath3 is the gas pressure , @xmath4 is the gas density , and @xmath16 is the acceleration due to gravity . for our model",
    "we will assume that the force of gravity acts in the negative @xmath17 direction and is a known function of @xmath17 .",
    "+ in addition to equations ( [ mhs_eq1])([mhs_eq3 ] ) , it is also necessary to specify an equation of state and an energy equation to close the system . for the equation of state , we use the ideal gas law , @xmath18 where @xmath19 is the ideal gas constant , and @xmath20 is the mean atomic weight , which may vary with position @xmath21 . since only the ratio @xmath22 is important",
    ", we introduce the scale height , @xmath23 and rewrite the equation of state as @xmath24    the final equation is the steady - state energy equation . a realistic equation , however , is nontrivial to construct . in the interior ,",
    "energy transport by convection is important , but is difficult to treat self - consistently without modeling flows .",
    "higher in the atmosphere , coronal heating must be treated , which is difficult because the underlying mechanism is uncertain .",
    "although there are some exceptions @xcite , explicit treatment of the energetics is often avoided for these reasons .",
    "for example , the method of models neither an energy equation nor an equation of state , and the method of @xcite treats energy transport implicitly by prescribing @xmath25 in the volume . for our model",
    "we adopt the latter approach and prescribe @xmath25 everywhere in the computational volume .",
    "+ in summary , the dependent variables of the model are @xmath2 , @xmath1 , @xmath3 and @xmath4 . it is assumed that both the scale height @xmath25 and the acceleration due to gravity @xmath16 are known everywhere in the volume , and so given either @xmath3 or @xmath4 , the other is known .",
    "+      we solve the model in the finite cartesian box @xmath26 the boundary of the domain , @xmath27 , is formed by the six planar faces of the box .",
    "+ working in cartesian coordinates simplifies the numerical implementation , but this geometry is unsuitable for modeling large - scale structures or the global magnetic field because the curvature of the sun can not be ignored at these scales .",
    "a correct treatment requires an implementation in spherical geometry , such as the magnetohydrostatic method of or the force - free methods of either or @xcite .",
    "nevertheless , the cartesian implementation can still be useful for structures of active - region size .",
    "+ to solve the magnetohydrostatic equations , boundary conditions are required on a subset of the dependent variables @xmath2 , @xmath1 , @xmath3 , and @xmath4 .",
    "since the pressure and density are related through the ideal gas law and since @xmath25 is prescribed everywhere , @xmath3 and @xmath4 are not independent  fixing both independently at the boundary is an overspecification . of the two , we prescribe boundary conditions on @xmath3 .",
    "+ all that remains is to specify the exact form of the boundary conditions on @xmath2 , @xmath1 and @xmath3 .",
    "we follow the approach of @xcite , who consider different formulations of the boundary - value problem for the special case with @xmath28 .",
    "the grad - rubin boundary conditions are the normal component of @xmath2 , @xmath29 the normal component of @xmath1 , @xmath30 and the pressure distribution , @xmath31 here @xmath32 is either @xmath33 or @xmath34 , which are the subsets of @xmath27 where @xmath35 and where @xmath36 respectively .",
    "this means that the boundary conditions on the pressure and current density are prescribed either at points in the boundary where @xmath37 or at points in the boundary where @xmath38 , but not both .",
    "the reason for this is that pressure and the field - aligned component of the current density obey hyperbolic transport equations along field lines ( see @xcite ) , and thus boundary conditions on @xmath39 and @xmath3 must only be prescribed at one end of each field line to avoid overspecification of the boundary - value problem . + in formulating the boundary - value problem , we also make the assumption that all field lines are connected to the boundary .",
    "this is again related to the hyperbolic character of the underlying equations  information in the boundary is transported into the volume along magnetic field lines , meaning points not connected to the boundary are undetermined .",
    "formulations that account for closed field lines are possible and are discussed by @xcite . since closed field lines are not considered , imposing boundary conditions at points where @xmath40 is also an overspecification , as field lines threading these points cross the boundary elsewhere , and therefore prescribing boundary conditions where @xmath40 violates the requirement that there be only one set of boundary conditions _ per _ field line .",
    "+ here we have presented a basic formulation of the boundary - value problem , however more complicated `` self - consistency '' methods that involve the solution of a sequence of boundary - value problems have been developed for the force - free equations @xcite .",
    "we note that a similar approach could be developed for the magnetohydrostatic problem .      rather than working with @xmath3 and @xmath4 directly , it is advantageous to reformulate the magnetohydrostatic equations in terms of the deviation from a gravitationally stratified background atmosphere .",
    "the pressure and density deviation due to the magnetic field can be orders of magnitude smaller than the pressure and density of the background and therefore are difficult to resolve numerically .",
    "in fact , the difference in magnitudes can lead to numerical instability , as discussed in appendix a. splitting @xmath3 and @xmath4 into background and magnetohydrostatic components and computing each separately mitigates this problem .",
    "+ the magnetohydrostatic equations are linear in @xmath3 and @xmath4 , so",
    "we may write @xmath41 and @xmath42 where @xmath43 and @xmath44 are due to a background atmosphere and @xmath45 and @xmath46 are the variations due to the presence of the magnetic field . note that the magnetohydrostatic components can be negative .",
    "+ the background pressure and density satisfy the hydrostatic force - balance equation @xmath47 and the equation of state @xmath48 where @xmath49 is the scale height for the background atmosphere . to uniquely determine @xmath50 and @xmath51 , it is necessary to prescribe the scale height @xmath49 in the volume and the pressure at either the top or bottom boundary , _",
    "i.e. _ @xmath52 from a purely mathematical standpoint , @xmath49 and @xmath53 may be chosen with some freedom .",
    "however , for numerical reasons , we choose to construct @xmath50 and @xmath51 as the pressure and density of the `` quiet sun '' and @xmath45 and @xmath46 as deviations from this background . in this context `` quiet sun '' refers to regions where the magnetic field is negligible .",
    "this interpretation of @xmath50 and @xmath51 requires that @xmath54 be the asymptotic form of @xmath25 in regions where the magnetic field is small . with this choice ,",
    "@xmath45 and @xmath46 are generally small in weak - field regions , which turns out to be important numerically ( see appendix a ) .",
    "+ with the pressure and density split , the magnetohydrostatic force - balance equation becomes @xmath55 and the ideal gas law becomes @xmath56 \\rho_{\\rm hs}.\\ ] ] the boundary conditions for @xmath45 are then @xmath57 we use the split form of the magnetohydrostatic equations to formulate our fixed - point iteration .",
    "in this section we describe the fixed - point iteration scheme for solving the boundary value problem presented in section [ sec_bvp ] .",
    "the numerical implementation of the method is presented later in section [ sec_numerical ] .",
    "+ to solve the model presented in section [ sec_equations_and_model ] , we employ an iterative scheme that extends the method of @xcite to include a gravity force .",
    "the method replaces the system of nonlinear equations with a set of linear equations that are easier to solve than the original nonlinear ones .",
    "the linear equations are solved iteratively and the solution to the nonlinear system is obtained when ( and if ) the iteration reaches a fixed point . + in the following we describe the steps in a single iteration of the method .",
    "we denote a variable after @xmath58 iterations by a superscript in square brackets , _",
    "e.g. _ @xmath9}$ ] denotes the magnetic field after @xmath58 iterations .",
    "in addition , we describe the magnetic field used to initialize the method .",
    "+      in principle the iteration can be initiated with any magnetic field that satisfies the boundary conditions given by equation ( [ bcs_bn ] ) , but in practice the simplest field to use is a current - free ( potential ) magnetic field @xmath59 } = \\mathbfit b_0 $ ] .",
    "this choice may be suboptimal , as other choices , like a nonlinear force - free field , may lie closer to the fixed - point and therefore reduce the number of iterations required to reach a solution .",
    "the advantage of using a potential field is that it is straightforward and fast to compute .",
    "+ the potential field is found by solving the magnetostatic equations @xcite @xmath60 and @xmath61 subject to the boundary conditions @xmath62 since the normal component of the magnetic field is prescribed on all six boundaries , it is necessary that the net flux over all the boundaries be zero in order for @xmath63 to be solenoidal in the volume .",
    "+      a single iteration of the scheme involves five steps . at each step",
    "the new value of a variable is computed by solving either an algebraic or differential equation .",
    "it is assumed that at the start of each iteration the magnetic field from the previous iteration is known .",
    "the potential field described in section [ sec_pot_field ] is used for the first iteration .",
    "in addition , it is assumed that @xmath51 and @xmath50 have been computed beforehand .",
    "+ here we enumerate the steps for a single iteration with iteration number @xmath58 .",
    "the updated variables have iteration number @xmath64 .",
    "the steps are as follows .",
    "[ p_update ] calculate @xmath65}$ ] , the pressure in the volume , by solving @xmath66}_{\\rm mhs } \\cdot \\mathbfit b^{[k ] } =     \\left ( \\frac{b_z^{[k]}}{h(\\mathbfit r ) } \\right ) p^{[k+1]}_{\\rm mhs }    + \\left ( \\frac{p_{\\rm hs}}{h(\\mathbfit r ) } - \\rho_{\\rm hs}(z)g(z ) \\right )              b_z^{[k ] } ,    \\label{iter_eq1}\\ ] ] subject to the boundary conditions for @xmath45 described in section [ sec_bvp ] .",
    "since @xmath51 , @xmath50 , @xmath25 , @xmath16 , and @xmath67}$ ] are known , equation ( [ iter_eq1 ] ) is linear .",
    "[ rho_update ] calculate @xmath68}_{\\rm mhs}$ ] , the gas density in the volume , by direct application of the ideal gas law @xmath69 } = \\frac{p_{\\rm mhs}^{[k+1]}}{g(z)h(\\mathbfit r ) }                   + \\frac{p_{\\rm hs}}{g(z)}\\left ( \\frac{1}{h(\\mathbfit r ) }                   - \\frac{1}{h_{\\rm hs}(z ) } \\right ) .",
    "\\label{iter_eq2}\\ ] ] 3 .",
    "[ jp_update ] calculate @xmath70}$ ] , the component of current density that is perpendicular to the magnetic field , in the volume .",
    "this is computed as @xmath71 } = \\frac {                               - \\nabla p^{[k+1]}_{\\rm mhs } \\times \\mathbfit b^{[k ] }                               + \\rho^{[k+1]}_{\\rm mhs } \\mathbfit g \\times \\mathbfit b^{[k ] }                              } {                              ||\\mathbfit b^{[k]}||^2                               } .",
    "\\label{iter_eq3}\\ ] ] 4 .",
    "[ a_update ] calculate @xmath72}$ ] , the component of the current density that is parallel to the magnetic field , in the volume .",
    "this component can be expressed as @xmath73 } = \\sigma^{[k+1]}\\mathbfit b^{[k]},\\ ] ] where @xmath74}$ ] is a scalar function that varies with position and satisfies the hyperbolic equation @xmath75 } \\cdot \\mathbfit b^{[k ] } = - \\nabla \\cdot \\mathbfit j_{\\perp}^{[k+1]}.    \\label{iter_eq_alpha}\\ ] ] the component @xmath72}$ ] is found by solving equation ( [ iter_eq_alpha ] ) subject to boundary conditions derived from those on @xmath39 and @xmath76 , _",
    "i.e. _ @xmath77 } \\right |_{\\pm \\partial v } =     \\left .",
    "\\frac{\\mathbfit j_{\\perp}^{[k+1 ] } \\cdot     \\hat{\\mathbfit{n } } - j_n}{b_n } \\right |_{\\pm \\partial v}.\\ ] ] 5 .",
    "[ b_update ] calculate @xmath8}$ ] , the new magnetic field in the volume , by solving ampre s law , @xmath7 } = \\mu_0 \\mathbfit j^{[k+1 ] } ,    \\label{iter_eq_ampere}\\ ] ] subject to the solenoidal condition @xmath78 } = 0,\\ ] ] and the boundary conditions on the normal component described in section [ sec_bvp ] . the current density in equation ( [ iter_eq_ampere ] ) is constructed from the components calculated in steps [ jp_update ] ) and [ a_update ] ) , _ i.e. _ @xmath79 } = \\mathbfit j_{\\perp}^{[k+1 ] }                       + \\sigma^{[k+1 ] } \\mathbfit b^{[k+1]}/\\mu_0.\\ ] ]",
    "this section describes the implemenation of the scheme presented in section [ sec_iter_method ] in code .",
    "+ the code is written in a combination of the fortran 2008 @xcite and c programming languages .",
    "it is parallelized for shared - memory parallel computers using openmp @xcite .",
    "the code supports calculations in either single , double , extended , or quadruple precision , although use of the latter two slows the calculation .",
    "+ the numerical mesh is constructed so that the spacing is uniform in any particular dimension but may differ between dimensions . in units of grid points , the domain has the total volume @xmath80 .",
    "each mesh point is @xmath81 where @xmath82 , @xmath83 , and @xmath84 .",
    "the grid spacing in each dimension is @xmath85 where @xmath86 or @xmath17",
    ".      calculation of both the potential field and the non - potential field requires the solution of a set of elliptic partial differential equations . by introducing the appropriate scalar and vector potentials ,",
    "both problems can be reduced to the problem of solving poisson s equation . + for the potential field calculation we introduce the scalar potential , @xmath87 , defined by @xmath88 this reduces the problem of solving the potential - field boundary - value problem from section [ sec_pot_field ] to solving laplace s equation @xmath89 subject to the neumann boundary conditions , @xmath90    for the magnetic field calculation in step [ b_update ] ) , only the non - potential component of the magnetic field needs to be updated . for this reason ,",
    "we express @xmath8}$ ] as @xmath91 } = \\mathbfit b_0 + \\nabla \\times \\mathbfit a_c^{[k+1]},\\ ] ] where @xmath63 is the potential field defined in section [ sec_pot_field ] , and @xmath92}$ ] is a magnetic vector potential . in the coulomb gauge (",
    "@xmath93}=0 $ ] ) , @xmath92}$ ] is a solution of poisson s equation , @xmath94 } = -\\mu_0 \\mathbfit j^{[k+1]}.\\ ] ] since @xmath63 is constructed to satisfy the boundary conditions defined by equation ( [ bcs_bn ] ) , it follows that the normal component of the non - potential component must vanish on the boundary .",
    "the boundary conditions on @xmath92}$ ] that achieve this are : @xmath95 } \\times \\hat{\\mathbfit{n}}\\right |_{\\partial v }   = 0,\\ ] ] and @xmath96 } \\cdot \\hat{\\mathbfit{n } } )    \\right |_{\\partial v } = 0.\\ ] ]    similar to @xcite , we employ under relaxation during the magnetic - field - update step in order to improve the numerical stability , _ i.e. _ rather than update @xmath8}$ ] directly , we set @xmath91 } = ( 1-\\omega)\\mathbfit b^{[k ] }                      + \\omega(\\mathbfit b_0 + \\nabla \\times \\mathbfit a_c^{[k+1]}),\\ ] ] where @xmath97 is a constant in the range @xmath98 $ ] .",
    "we find in practice that this improves stability of the iteration scheme without altering the fixed point . +",
    "many numerical methods exist for solving the laplace and poisson equations @xcite .",
    "we use a second - order finite difference multigrid scheme @xcite .",
    "the method is fast and scales well . for a mesh with uniform spacing in all dimensions ,",
    "the time to compute the solution has @xmath99 scaling , where @xmath100 .",
    "we employ a characteristic ( field line tracing ) method to solve the hyperbolic equations .",
    "we only present the numerical solution of equation ( [ iter_eq1 ] ) , as the method for equation ( [ iter_eq_alpha ] ) is similar .",
    "the partial differential equation , equation ( [ iter_eq1 ] ) , can be recast as a system of ordinary differential equations along each field line , _ i.e. _ the equation for @xmath101}_{\\rm mhs}$ ] can be expressed as @xmath102 where @xmath103 and @xmath104}}{||\\mathbfit b(s)^{[k]}||}.    \\label{eq_hyper_g}\\ ] ] here @xmath105 is the derivative along the length of a magnetic field line whose path is a solution of the field line equation @xmath106}}{||\\mathbfit b^{[k]}|| } ,     \\label{eq_fline}\\ ] ] where @xmath107 is the cartesian position along the field line . + the pressure is updated at each step by solving equations ( [ pc_update_ds ] ) and ( [ eq_fline ] ) for each point in the volume . for each mesh point",
    "@xmath108 in the volume , we solve equation ( [ eq_fline ] ) to determine the path of the field line that threads @xmath108 while simultaneously integrating equation ( [ pc_update_ds ] ) along this path .",
    "the calculation is halted when the field line crosses the boundary of the domain .",
    "we perform the calculation in both directions along the field lines and only impose boundary conditions at the endpoint on the boundary with the correct polarity for the boundary conditions . + we perform the integration using a fourth - order runge - kutta integrator with a fixed step size @xcite .",
    "since the path of the field line is not restricted to the numerical grid , trilinear interpolation is used to compute @xmath2 , and @xmath109 during the integration @xcite .",
    "we use an `` event - location '' method that combines interpolation and root finding to determine the location where the field line crosses the boundary @xcite .",
    "+ solving the hyperbolic system using runge - kutta methods is nontrival because it is not a standard initial - value problem : @xmath101}_{\\rm mhs}$ ] is unknown at the initial point @xmath110 .",
    "instead it is a boundary - value problem with boundary conditions on @xmath101}_{\\rm mhs}$ ] and @xmath111 known at different ends of each field line . at the start of the field line ( @xmath110 ) ,",
    "the value of @xmath111 is known , _",
    "i.e. _ @xmath112 , but the value of @xmath101}_{\\rm mhs}(0)$ ] is not , in fact , this is the value we wish to compute . at the point where the field line crosses the boundary @xmath113 ) , @xmath101}_{\\rm mhs}(s_0)$ ] is known from the boundary conditions on @xmath45 , but the crossing point @xmath114 is a priori unknown . in this form",
    "the boundary - value problem can not be solved using standard numerical methods for ordinary - differential equations ( _ e.g. _ runge - kutta methods ) . to solve this problem ,",
    "we introduce two auxiliary initial - value problems whose solutions , when combined , give the solution to the boundary - value problem .",
    "the auxiliary problems are of the standard form and can be treated with standard integration methods .",
    "this method is explained in appendix b. +      the background atmosphere is constructed by solving equation ( [ fb_hs ] ) using numerical quadrature . in order that @xmath54 approaches @xmath25 in weak - field regions ( see discussion in section [ sec_pd_decomp ] ) we take @xmath115 where the point @xmath116 is at the edge of the computational volume defined by equation ( [ eq_domain ] ) . for the boundary conditions for equation ( [ fb_hs ] ) ,",
    "we take @xmath117 with this choice it is necessary that regions of strong magnetic field be isolated from the boundaries .",
    "we use this corner point to define the background field for the calculations presented here , but it may not be appropriate in all cases and other choices are possible . +",
    "we have chosen to compute the background atmosphere using numerical quadrature as this method is applicable when @xmath49 is given in table form , which is the case for many popular model atmospheres ( _ e.g. _ @xcite ) .",
    "the code is not restricted to using tabulated background atmospheres and can use analytic background atmospheres too .",
    "the other steps involve the straightforward evaluation of algebraic equations .",
    "the exception is step [ jp_update ] ) , which requires the evaluation of numerical derivatives .",
    "we use a fourth - order finite - difference method to evaluate derivatives @xcite . in addition , when computing @xmath118 we use a `` safety factor '' @xmath119 in the denominator @xmath71 } = \\frac {                               - \\nabla p^{[k+1]}_{\\rm mhs } \\times \\mathbfit b^{[k ] }                               + \\rho^{[k+1]}_{\\rm mhs } \\mathbfit g \\times \\mathbfit b^{[k ] }                              } {                              ||\\mathbfit b^{[k]}||^2   + \\eta                              } .\\ ] ] this is needed in weak - field regions , where the truncation error in the numerical derivative can have a similar effect to that discussed in appendix a.",
    "we apply our code to a problem with a known analytic solution in order to test the fixed - point method in general and our implementation in code in particular .",
    "the goal is to show firstly that the scheme converges to a fixed point , and secondly that the numerical solution obtained thereby is consistent with the known solution within the margins of numerical error . in this way",
    "we establish that both the method and our code work .",
    "we perform calculations at four different resolutions to demonstrate the scaling of the numerical truncation error .",
    "we also determine how the total execution time of the code scales with grid size .",
    "+ the calculation is performed in non - dimensional units , but here we use dimensional quantities expressed in terms of unspecified characteristic values .",
    "for example , the domain size is given as @xmath120 , where @xmath121 is unspecified .",
    "+      to test the code we use the analytic magnetohydrostatic sunspot model of @xcite , which belongs to the class of self - similar solutions found by @xcite . in cylindrical polar coordinates ,",
    "the magnetic field for this solution is @xmath122\\ ] ] @xcite , where @xmath123 , @xmath124 is a free parameter that sets the width of the spot , and @xmath125 is a free parameter that determines the maximum field strength .",
    "the solution is axisymmetric and untwisted ( @xmath126 ) .",
    "+ for the tests , we use a solution with @xmath127 , and @xmath128 , where @xmath121 and @xmath129 are an unspecified characteristic length scale and magnetic field strength , respectively .",
    "the dimensions of the domain are @xmath130 , and @xmath131 .",
    "we perform four calculations at different resolutions with 20 iterations of the method applied starting from a potential field in each case . the number of grid points in each direction are equal , _ i.e. _ @xmath100 , but @xmath132 takes the values @xmath133 , @xmath134 , @xmath135 , and @xmath136 in the four cases .",
    "we first demonstrate that the iteration has converged to a fixed point by measuring the change in the magnetic field between iterations using the metric @xmath137}b_{\\rm max } = \\mbox{max}(|\\mathbfit b^{[k+1 ] } - \\mathbfit b^{[k]}| ) ,    \\label{eq_con_metric}\\ ] ] where @xmath138 is the componentwise absolute value not the vector norm , and @xmath139 is the maximum value over the domain and three components .",
    "the value of @xmath140}b_{\\rm max}$ ] is an upper bound on the pointwise change and is therefore small only when the change at every point is small .",
    "we regard an iteration as converged when @xmath140}b_{\\rm max}$ ] becomes small .",
    "this is a strict measure of convergence , as @xmath140}b_{\\rm max}$ ] will not decrease unless all three components of @xmath9}$ ] converge to a solution at every point in the volume .",
    "+ figure [ fig_conv ] shows @xmath140 } b_{\\rm max}$ ] _ versus _ iteration number @xmath58 for the four test cases . in each case",
    ", @xmath140 } b_{\\rm max}$ ] decreases monotonically by about six orders of magnitude over 20 iterations .",
    "given the small value of @xmath140 } b_{\\rm max}$ ] , we regard the iteration as converged in all four cases .",
    "we next measure the numerical truncation error by comparing the numerical solution at iteration 20 to the known analytic solution .",
    "to measure the difference between the analytic and numerical solutions , we use the two metrics @xmath141 and @xmath142 where @xmath143 is the analytic solution , and the operator @xmath144 is the average of @xmath138 over the domain and three components . as in section [ sec_convergence ]",
    ", @xmath138 is the componentwise absolute value .",
    "these metrics measure the maximum and average truncation errors respectively .",
    "+ it should be noted that @xmath145 is a particularly strict measure of the numerical error , since a discrepancy at a single point can significantly affect its value .",
    "we have chosen to use this metric as it is useful in detecting errors in the implementation of the boundary conditions . a systematic , resolution",
    "independent error at each of the @xmath146 points in a boundary layer introduces an error with scaling @xmath147 when averaged over the whole @xmath148 points in the domain .",
    "hence , the scaling of @xmath149 can not necessarily distinguish between a method that has @xmath147 truncation error in the volume , and a method that systematically fails at the boundary , due to , for example , coding errors .",
    "this is why we measure both the scaling for @xmath145 and @xmath149  the metric @xmath145 will not decrease with @xmath132 if systematic errors at the boundaries exist .",
    "+ figure [ fig_error ] shows the truncation error _ versus _ @xmath132 , the number of mesh points along each dimension .",
    "the top panel shows @xmath145 _ versus _",
    "@xmath132 ( circles ) .",
    "the solid line is a power - law fit to the data with power - law index @xmath150 .",
    "the bottom panel shows @xmath149 _ versus _",
    "@xmath132 ( circles ) .",
    "the solid line shows a power - law fit with power - law index @xmath151 .",
    "based on a visual inspection , there is good agreement between the fitted power - laws and the data in both panels , although the value of @xmath145 at @xmath152 is larger than the prediction of the fit .",
    "+ in addition to comparing the analytic and numerical solutions via metrics , it is important to perform a visual comparison between the field lines , as this gives some indication of how the numerical error is distributed spatially .",
    "figure [ fig_lines ] shows a comparison between the field lines of the exact solution ( blue lines ) and the numerical solution at different resolutions and iteration numbers ( red lines ) .",
    "panels ( a ) and ( c ) show the field lines of the exact solution ( blue lines ) _ versus _ the field lines of the initial potential field ( red lines ) for the @xmath153 and @xmath152 calculations , respectively .",
    "panels ( b ) and ( d ) show the field lines of the exact solution _ versus _ the field lines of the numerical solutions after 20 iterations of the method ( red field lines ) for the @xmath153 and @xmath152 calculations respectively . in all panels , the field lines are confined to the @xmath154 plane through the origin and only the subdomain with @xmath155 $ ] is shown .",
    "since the solution is axisymmetric , the two - dimensional slice gives a good indication of the solution in general .",
    "the tracing is initiated from starting points spaced equally along the @xmath156 axis at @xmath157 .",
    "the background image of each panel depicts @xmath158}||$ ] .",
    "we note that in the corners where the numerical and exact solutions are most discrepant , the magnetic field strength is smaller than that near the center by several orders of magnitude .",
    "+ it is also important to check the numerical error in the thermodynamic quantities",
    ". figure [ fig_pressure ] shows maps of the quantity @xmath159 where @xmath160 is the analytic solution , and @xmath138 is the absolute value .",
    "the top panel shows @xmath161 for the @xmath153 case , and the bottom panel shows @xmath161 for the @xmath152 case . in both panels",
    "we only show a slice through the @xmath154 plane as in figure [ fig_lines ] .",
    "finally , we compute the total time required to perform 20 iterations of the method on an eight - core processor .",
    "figure [ fig_time ] shows the total run time in seconds _ versus _ @xmath132 . a power - law fit to the data",
    "has a power - law index of @xmath162 meaning the run time has approximate @xmath163 scaling .",
    "we present a new fixed - point iteration method for solving the magnetohydrostatic equations in a three - dimensional cartesian box and its implementation in code .",
    "we apply the code to a known analytic solution to verify that it works as expected .",
    "we perform the calculation at four different numerical resolutions to determine how this affects the convergence and numerical accuracy of the method as well as the calculation time . + we find that the fixed - point iteration converges in the sense that the change in the magnetic field between iterations , as measured by the metric @xmath164 ( equation ( [ eq_con_metric ] ) ) , decreases by approximately six orders of magnitude over 20 iterations .",
    "the decrease in @xmath164 appears to be exponential with a rate that does not depend strongly on the number of grid points .",
    "although the method converged for all the cases presented , we found that if the resolution was made very low , by either using a small @xmath132 or a large domain , then the method would not reach a fixed point . in this limit",
    ", we expect that the solution was dominated by the numerical truncation error .",
    "+ we also measure the numerical truncation error of the method by comparing the known analytic solution to the numerical solution .",
    "we do this for calculations at four different resolutions in order to establish a scaling law for the truncation error .",
    "we find that for the metric @xmath145 , which is sensitive to the maximum truncation error , the power - law index is @xmath150 , as determined by a fit to the data .",
    "for the metric @xmath149 , which is sensitive to the average truncation error , we find the power - law index of the fit is @xmath151 .",
    "the theoretical maximum truncation error in the field - line tracing solution to the hyperbolic equations is expected to have @xmath147 scaling ( see the discussion in @xcite ) , while the maximum truncation error for the second - order finite - difference solution to the elliptic equations is expected to have @xmath165 scaling .",
    "these represent worst - case error estimates and in practice we would expect to find a power - law index for the truncation error somewhere in between one and two , which is what we find .",
    "we note some departure from the fit for @xmath145 at @xmath152 .",
    "the value here is approximately half that at @xmath166 , so while it does not lie on the fitted line , it is still consistent with the maximum theoretical error scaling of @xmath147 .",
    "+ we also perform a visual comparison between the field lines of the numerical and analytic solutions . after 20 iterations ,",
    "the two sets are almost indistinguishable , except for field lines in the lower corners of panels ( b ) and ( d ) in figure 3 .",
    "we found that the field lines in this region can change significantly with even small changes in the electric current density .",
    "the region may have the largest error because the analytic solution in this region departs significantly from the initial potential field .",
    "the magnetic field in this region is also very weak compared with the field at the center of the domain .",
    "we emphasize that the discrepancy decreases with resolution ( as can be seen in figure [ fig_lines ] ) , and would not appear to be due to the local failure of the method .",
    "+ we also establish a scaling law for the total execution time of the code .",
    "we find that for a grid with @xmath132 grid points in each dimension , the total run time has @xmath163 scaling .",
    "this scaling is consistent with force - free codes based on the grad - rubin method @xcite . as in the case of the force - free codes , the time - consuming step is the field line tracing .",
    "we note that although the scaling is similar , the magnetohydrostatic code is significantly slower in absolute terms because a single iteration of the magnetohydrostatic method involves more stages than the force - free grad - rubin method . +",
    "our method requires that all field lines connect to the boundary , but no actual constraints on the connectivity are imposed during the iteration to enforce this . in one sense",
    "this is an advantage of the method , because it means the method can compute solutions whose topologies differ significantly from the magnetic field used to initiate the calculation .",
    "however , in another sense it is a weakness , because there is nothing to prevent closed field lines from forming during the calculation , at which point the calculation can not proceed .",
    "we find that in our tests the appearance of closed field lines is generally in response to the formation of strong electric currents in weak - field regions .",
    "future versions of the method could solve a more general formulation of the boundary - value problem that accounts for closed field lines . despite this limitation ,",
    "the method is still applicable to a range of interesting problems .",
    "+ finally , we note that the test case used is particularly simple .",
    "in particular , because it is untwisted , step iv ) of the method is not tested .",
    "the numerical methods are similar to those used to solve step [ p_update ] ) , and we have tested the method on analytic solutions with a finite @xmath167 but no gravity , and we have found that the known solution is well reproduced .",
    "this gives us confidence that the method would work when applied to a case with both a finite twist and gravity force .",
    "we stress that although the test case was axisymmetric , since we work in cartesian coordinates , our calculation was three - dimensional .",
    "+ the work presented here has several limitations that could be addressed with future work .",
    "the fixed - point method could be generalized to explicitly model the energetics via an energy equation similar to the approach of @xcite . regarding the code itself , no significant optimization",
    "has yet been performed on the current first version , which could be addressed in the future .",
    "+ in this article we present a new iterative method for solving the magnetohydrostatic equations in a three - dimensional cartesian domain and the details of an implementation of the method in code .",
    "we use our code to reconstruct a known analytic solution and thereby establish the correctness of the code and the viability of the method in general .",
    "this work is a step towards the generation of realistic three - dimensional magnetohydrostatic models of the solar atmosphere .",
    "+      in this appendix we explain why the decomposition of the pressure into a magnetohydrostatic and a hydrostatic components presented in section [ sec_pd_decomp ] is necessary for the stability of the fixed - point method .",
    "we find that without solving for these components separately , an instability occurs due to the failure to achieve exact hydrostatic force balance in weak - field regions .",
    "+ in terms of the total pressure , @xmath3 , and density , @xmath4 , the update equation for the perpendicular electric current density is @xmath71 } = \\frac {                               - \\nabla p^{[k+1 ] } \\times \\mathbfit b^{[k ] }                               + \\rho^{[k+1 ] } \\mathbfit g \\times \\mathbfit b^{[k ] }                              } {                              ||\\mathbfit b^{[k]}||^2                              } .",
    "\\label{eq_jp_norm}\\ ] ] using this equation rather than equation ( [ iter_eq3 ] ) results in the formation of spurious electric currents in weak - field regions , where the denominator becomes small but the numerator remains finite due to numerical error . to understand this ,",
    "let @xmath3 and @xmath4 be split as in section [ sec_pd_decomp ] .",
    "equation ( [ eq_jp_norm ] ) then becomes @xmath71 } = \\frac {                               ( - \\nabla p^{[k+1]}_{\\rm mhs } \\times \\mathbfit b^{[k ] }                               + \\rho^{[k+1]}_{\\rm mhs } \\mathbfit g \\times \\mathbfit b^{[k ] } )   +                              ( - \\nabla p^{[k+1]}_{\\rm hs } \\times \\mathbfit b^{[k ] }                               + \\rho^{[k+1]}_{\\rm hs } \\mathbfit g \\times \\mathbfit b^{[k ] } )                              } {                              ||\\mathbfit b^{[k]}||^2                              } .\\ ] ] in principle , the second term in the numerator is zero , however , in practice this is not achieved numerically , which introduces an error , @xmath168 , in the numerator .",
    "the functional form of @xmath168 depends on the details of the numerical implementation , but , in general , its magnitude varies with position and decreases with resolution . in weak - field regions @xmath45 and @xmath46 are small , and thus the perpendicular current density has scaling @xmath169}||$ ] .",
    "the hydrostatic component of the atmosphere is independent of the magnetic field , and so the error @xmath170 is not necessarily small in weak - field regions .",
    "this results in the formation of strong spurious currents in weak - field regions because the denominator @xmath158}||$ ] becomes small while the numerator remains finite .",
    "these currents can prevent the method from converging .",
    "here we provide the details of the pressure update step . + to update the pressure at each iteration it is necessary to solve the equations @xmath171 and @xmath172 in the volume at each cartesian mesh point @xmath173 .",
    "the functions @xmath174 and @xmath175 are defined by equations ( [ eq_hyper_g ] ) and ( [ eq_hyper_f ] ) , respectively .",
    "the boundary conditions are @xmath176 and @xmath177 where @xmath178 is the point where the field line crosses the boundary with the polarity over which boundary conditions are prescribed . +",
    "this is not an initial - value problem because @xmath179 and @xmath3 are not known simultaneously at either @xmath180 or @xmath181 .",
    "application of a standard iterative method for solving ordinary - differential equations ( like the runge - kutta method ) is therefore impossible , because the iteration can not be initialized without knowledge of both @xmath179 and @xmath3 at the same point .",
    "the problem , however , can be reformulated into two auxiliary initial - value problems that can be solved with a straightforward application of standard methods . + first",
    "consider @xmath160 , which is the solution to the equation @xmath182 with initial condition @xmath183 . also consider @xmath184 , which is the solution of the homogeneous equation @xmath185 with @xmath186 . in both cases",
    "the equation and initial condition for @xmath179 are the same as the original problem .",
    "note that @xmath187 , where @xmath188 is a scalar , is also a solution to equation ( [ eq_ap3 ] ) .",
    "it follows that , since equation ( [ eq_ap1 ] ) is linear , @xmath189 is also solution of equation ( [ eq_ap1 ] ) .",
    "the variable @xmath188 can be treated as a free parameter and chosen such that @xmath190 at the point where the field line crosses the boundary , _",
    "i.e. _ @xmath191 with this choice , @xmath192 is a solution to the original boundary - value problem : it satisfies equation ( [ eq_ap1 ] ) and the boundary conditions defined by equation ( [ eq_bc_apa ] ) .",
    "it follows that the value of @xmath45 at the point @xmath110 , with cartesian coordinates @xmath173 , is @xmath193 hence the solution to the boundary - value problem can be found by computing @xmath188 , which requires solving the two initial - value problems for @xmath160 and @xmath184 . the simplest choice for the constants @xmath194 and @xmath195 is @xmath196 and @xmath197 , although other combinations are possible .",
    "the initial - value problems for @xmath160 and @xmath184 are in the standard form and can be treated using a straightforward application of a method like runge - kutta .",
    "plane through the origin . in panels ( a ) and ( b )",
    ", the red field lines belong to the initial potential field and the solution calculation after 20 iterations of the fixed - point method , respectively , for the calculation with @xmath153 .",
    "panels ( c ) and ( d ) show the same for the @xmath152 calculation . in all panels",
    "the field lines are traced from starting points spaced equally along the @xmath156 axis , meaning the density of field lines is not indicative of field strength . ]",
    "plane through the origin . in panels ( a ) and ( b ) , the red field lines belong to the initial potential field and the solution calculation after 20 iterations of the fixed - point method , respectively , for the calculation with @xmath153 .",
    "panels ( c ) and ( d ) show the same for the @xmath152 calculation . in all panels",
    "the field lines are traced from starting points spaced equally along the @xmath156 axis , meaning the density of field lines is not indicative of field strength . ]",
    "plane through the origin . in panels ( a ) and ( b )",
    ", the red field lines belong to the initial potential field and the solution calculation after 20 iterations of the fixed - point method , respectively , for the calculation with @xmath153 .",
    "panels ( c ) and ( d ) show the same for the @xmath152 calculation . in all panels",
    "the field lines are traced from starting points spaced equally along the @xmath156 axis , meaning the density of field lines is not indicative of field strength . ]",
    "plane through the origin . in panels ( a ) and ( b ) ,",
    "the red field lines belong to the initial potential field and the solution calculation after 20 iterations of the fixed - point method , respectively , for the calculation with @xmath153 .",
    "panels ( c ) and ( d ) show the same for the @xmath152 calculation . in all panels",
    "the field lines are traced from starting points spaced equally along the @xmath156 axis , meaning the density of field lines is not indicative of field strength . ]    ) between the pressure of the analytic solution and the numerical solution after 20 iterations of the method for @xmath153 ( top panel ) and @xmath152 ( bottom panel ) .",
    "note that the scales on the color bars are different . ]    ) between the pressure of the analytic solution and the numerical solution after 20 iterations of the method for @xmath153 ( top panel ) and @xmath152 ( bottom panel ) .",
    "note that the scales on the color bars are different . ]",
    "63 # 1isbn # 1#1#1#1#1#1#1#1_#1_#1*#1*#1#1#1#1#1#1#1#1#1#1#2#1#1#1#1#1_#1_#1#1#1*#1*#1#1#1_#1_#1#1#1#1#1#1#1#1#1#1#1 # 1http://dx.doi.org/#1 [ ] # 1http://arxiv.org / abs/#1 [ ] # 1http://adsabs.harvard.edu / abs/#1[]#1#1#1#1#1#1#1#1#1#1#1#1"
  ],
  "abstract_text": [
    "<S> magnetohydrostatic models of the solar atmosphere are often based on idealized analytic solutions because the underlying equations are too difficult to solve in full generality . numerical approaches , too , are often limited in scope and have tended to focus on the two - dimensional problem . in this article we develop a numerical method for solving the nonlinear magnetohydrostatic equations in three dimensions . our method is a fixed - point iteration scheme that extends the method of grad and rubin ( _ proc . </S>",
    "<S> 2nd int . conf . on peaceful uses of atomic energy _ </S>",
    "<S> * 31 * , 190 , 1958 ) to include a finite gravity force . </S>",
    "<S> we apply the method to a test case to demonstrate the method in general and our implementation in code in particular . </S>"
  ]
}