{
  "article_text": [
    "over the past decade , spatially adaptive methods have been developed to calculate gravitational forces in n - body simulations .",
    "these include tree codes ( appel , 1985 ; barnes and hut , 1986 ) , fast multipole methods ( greengard , 1987 ) , and adaptive grids ( couchman , 1991 ) .",
    "as the number of particles in an n - body simulation grows , so do the density contrasts .",
    "hierarchical methods can follow extremely large dynamic ranges in densities at modest additional cost per force evaluation .",
    "however , large ranges in densities also imply a large range in time scales ( @xmath0 ) .",
    "if we take the final state of a simulation and weight the computational work done on particles not uniformly but inversely with their natural timesteps , we find a potential gain of @xmath1 .",
    "temporal adaptivity is one of the last algorithmic areas where we can target an order of magnitude improvement .",
    "hence , we seek a hierarchical integrator , , a method such that particles are on adjustable individual timesteps .",
    "the most commonly used time integration scheme for n - body simulations is the leapfrog method .",
    "leapfrog has several advantages over other methods .",
    "1 ) for second order accuracy only one force evaluation and one copy of the physical state of the system is required .",
    "this is particularly beneficial for n - body simulations where the cost of a force evaluation is very expensive .",
    "2 ) the force field in an n - body simulation is not very smooth , so higher order does not necessarily mean higher accuracy .",
    "3 ) it is a symplectic integrator , , it preserves properties specific to hamiltonian systems .",
    "see channell and scovel ( 1990 ) for a review of symplectic integrators .",
    "gravitational n - body systems are hamiltonian , and therefore they should benefit from the use of an integrator that conserves phase space volume and has no spurious dissipation",
    ". this could be especially important in self - gravitating systems where a dissipation time scale that is linked to the dynamical time can lead to a runaway to spuriously large densities .",
    "_ leapfrog is a second order symplectic integrator requiring only one costly force evaluation per timestep and only one copy of the physical state of the system . _",
    "these properties are so desirable that we concentrate on making an adaptive leapfrog .",
    "hierarchical leapfrogs have been used before ( porter 1985 ; ewell 1988 ; hernquist and katz 1989 ) , but they were not symplectic (  4 ) .",
    "there exist symplectic integrators with individual but _ fixed _",
    "timesteps for either particles or modes ( saha & tremaine 1994 ; skeel & biesiadecki 1994 ; lee , duncan & levison 1997 ) .",
    "hut , makino & mcmillan ( 1995 ) proposed an iterative scheme for choosing timesteps for a single particle in a rapidly varying potential , but each iteration involves a force evaluation that is prohibitively expensive for large n simulations (  2 ) .",
    "section 2 describes the theory behind a hierarchical integrator .",
    "section 3 describes tests of this integrator on a single particle in a potential , and section 4 will present tests of the integrator on full n - body systems .",
    "we discuss the implications of these results in section 5 .",
    "a symplectic integrator is an exact solution to a discrete hamiltonian system that is close to the continuum hamiltonian of interest .",
    "therefore , it preserves all the poincar invariants and places stringent conditions on the global geometry of the dynamics .",
    "an obvious example is total energy conservation in a system with a time - independent hamiltonian or the conservation of angular momentum in axisymmetric systems ( zhang & skeel 1995 ) .",
    "a symplectic integrator will exactly conserve the energy in the discrete hamiltonian that is an approximation to the true energy of the system .",
    "this approximate energy oscillates about the true energy without any numerical dissipation .",
    "the difference between the discrete and continuum hamiltonians can be viewed as a small perturbation given by the truncation error of the integrator .",
    "the error is a hamiltonian ! if the error hamiltonian is a sufficiently small perturbation , then the kam theorem ( arnold 1978 ) guarantees that the invariant curves destroyed are a set of finite measure . in other words , almost all orbits that are stable in the real system",
    "will continue to be stable in the numerical system .",
    "an illustration of these advantages is shown in figure [ phase ] . here the radial velocity , @xmath2 , is plotted against the radius , @xmath3 , for an ellipticity , @xmath4 kepler orbit using a leapfrog integrator and using a fourth order runge - kutta integrator . in each integration",
    ", approximately 24 steps were taken per orbit , and the integrations ran for 16 orbits . note how the leapfrog integrator oscillates about the true solution but always remains on a one dimensional surface .",
    "this indicates that it is indeed conserving an energy - like quantity ,  having the orbit constrained to a one dimensional surface shows the existence of an isolating integral of motion . on the other hand ,",
    "the runge - kutta orbit slowly becomes more circular .",
    "the poor performance of the runge - kutta integrator is remarkable given that it is a fourth order integrator and uses four times as many force evaluations as the leapfrog integrator .",
    "also note the large wiggles in the leapfrog integration at apoapse .",
    "these are indicative of the proximity of resonant islands that would lead to a instability for larger timesteps .",
    "the leapfrog integrator can be written as @xmath5 where @xmath6 is the position vector of a particle , @xmath7 is the velocity , @xmath8 is the acceleration , and @xmath9 is the timestep .",
    "when several of these steps are put together , the two position updates can be combined to a single update @xmath10 to @xmath11 , and the resulting alternation between updating @xmath6 and @xmath7 gives leapfrog its name .",
    "the symplectic nature of leapfrog can be seen by noting that the position update is equivalent to evolving the system exactly under the hamiltonian @xmath12 , and the velocity update is equivalent to evolving the system under the hamiltonian @xmath13 , where @xmath14 is the potential generating the accelerations .",
    "we will call the operator that evolves the system under @xmath15 the `` drift '' operator , @xmath16 , and the operator that evolves the system under @xmath17 the `` kick '' operator , @xmath18 . , where @xmath19 are the phase space coordinates and @xmath20 are poisson brackets , then formally @xmath21 , and @xmath22 .",
    "] it can be shown that ( see saha and tremaine , 1992 for details ) the combination of operators @xmath23 evolves the system under a hamiltonian @xmath24 where @xmath25 is of order @xmath26 .",
    "the existence of this surrogate hamiltonian ensures that the leapfrog is symplectic and second order .",
    "since the hamiltonian is symmetric with respect to @xmath15 and @xmath17 , the combination of operators @xmath27 is also a symplectic second order integrator .",
    "explicitly , this is @xmath28 higher order symplectic integrators can be constructed from combinations of leapfrog steps ( yoshida 1990 ) .",
    "each @xmath29th order leapfrog integrator requires @xmath30 force evaluations and only one copy of the physical state of the system .",
    "unfortunately , constructing a variable step - size method by choosing a new timestep after each leapfrog step gives very disappointing results ( calvo and sanz - serna , 1993 ) .",
    "some simple schemes can be shown to have no rigorous stability criterion for any step size ( skeel 1993 ) .",
    "several explanations have been given for this behavior . the simplest is to note that a variable step integrator is evolving a dynamic system with state variables ( @xmath6 , @xmath7 , @xmath9 ) .",
    "the projection onto the phase space coordinates ( @xmath6 , @xmath7 ) can not be described by a hamiltonian .",
    "skeel and gear ( 1992 ) consider a one step symplectic operator of the form @xmath31 and show that if @xmath32 is symplectic for a constant step size , it will not in general be symplectic for variable step size . another way to see",
    "this problem is to notice that the time reversibility has been broken : if we step forward in time and then step backward , we do not end up at the same point because of the change in timestep . since symplectic implies time reversible , such an operator is not symplectic .",
    "integrators that are time reversible are referred to as reflexive by kahan ( 1993 ; see also kahan and li 1997 ) who argues that reflexivity is the key to the robust properties of  updating formulae \" rather than symplecticity .    a strategy to make leapfrog reflexive are clear from a cursory look at its evolution operators .",
    "the operation @xmath23 is reversible if we use an `` select '' operator to choose the timestep , @xmath33 , such that the time reversibility is retained .",
    "hut , makino , and mcmillan ( 1995 ) achieve this by using an implicit definition of the timestep : @xmath34.\\ ] ] so , the beginning and end of the step are required to agree on the timestep .",
    "one can solve for @xmath9 iteratively , and very good results are obtained even with only one or two iterations .",
    "( this result is also clear from kahan 1993 ) .",
    "this iterative scheme poses several problems when applied to a large n - body simulation .",
    "it requires backing up timesteps , throwing away expensive force calculations , using auxiliary storage and must specify a method for synchronizing the particles for mutual force evaluations .",
    "however , we can also see an alternative means to restore reflexivity .",
    "let us choose a select operator @xmath33 that commutes with @xmath18 , so that @xmath35 is equivalent to @xmath36 .",
    "since @xmath18 only changes the velocities and not the positions , an @xmath33 operator that depends entirely on positions satisfies the commutation requirement . as we shall show below , this is not strictly time reversible .",
    "however , since the operators read the same forward and backward , we will refer to @xmath35 as a `` palindromic '' integrator .",
    "synchronization can be maintained by only choosing timesteps that are a power - of - two subdivision of the largest timestep , @xmath37 .",
    "that is , @xmath38 where @xmath39 is the timestep of a given particle , and @xmath40 is an integer ( see hernquist and katz , 1989 ) . combining this synchronization procedure with the @xmath35 evolution operation we have the following ( recursive ) algorithm for a timestep .",
    "1 ) drift the particles forward @xmath41 .",
    "2 ) apply the select operator .",
    "if it accepts this step , then finish the step with @xmath42 and @xmath43 .",
    "otherwise , drift the particles back @xmath41 and take two timesteps using @xmath41 .",
    "the algorithm can be expressed recursively in the following pseudo - code :    here , drift(@xmath9 ) applies @xmath44 to all particles , kick(@xmath9 ) applies @xmath45 to particles with timestep @xmath9 and select ( ) decides to which timestep the particles belong , with the side effect of finding the minimum timestep , @xmath46 .",
    "we will refer to the traditional method of choosing a timestep at the beginning of the integration step as @xmath47 .",
    "as an example of how this procedure works , consider figure [ umbrella ] . in this diagram",
    "we consider the case where there are particles on three separate timesteps .",
    "the arcs represent drifting the particles , and the vertical slashes represent either an select or kick of particles at that timestep .",
    "starting at point 0 , all particles are drifted to point 1 and evaluated for whether they are on the largest timestep .",
    "then all particles are drifted to point 2 and those particles not on the largest timestep are evaluated for whether they are on the middle timestep .",
    "then all particles are drifted to point 3 where those particles on the smallest timestep are kicked .",
    "all particles are then drifted to point 2 where particles on the middle timestep are kicked , then to point 4 where particles on the smallest timestep are kicked , then to point 1 where particles on the largest timestep are kicked .",
    "then all particles are drifted to point 5 where again all particles not on the largest timestep are evaluated for whether they are on the middle timestep .",
    "then the appropriate particles are kicked at points 6 , 5 , and 7 .",
    "finally all particles are drifted to point 8 and a single large timestep is complete .",
    "there are several things to note about the above algorithm .",
    "one is that it is not unique .",
    "it uses a `` top down '' approach by trying the largest timestep and reducing it until it is deemed appropriate .",
    "a `` bottom up '' scheme can be implemented where a smallest timestep is tried first .",
    "secondly , this algorithm is not exactly time reversible .",
    "scenarios can easily be constructed where a forward step followed by a backward step will not come back to the initial conditions .",
    "an example is shown in figure [ oops ] .",
    "the circle delineates the boundary between region 1 , where one timestep is needed , and region 2 , where a timestep of 1/2 the timestep in region 1 is needed .",
    "if we start a particle in region 2 , it is drifted forward , found to still be in region 2 , so two timesteps are taken .",
    "if we start the particle in region 1 and go backward , it is possible that the drift leaves the particle still in region 1 , so only one timestep is taken going backward , and we do not arrive at the point from which we started .",
    "finally , since several selects may be done for every kick , the efficiency of this algorithm depends upon select being able to quickly decide an appropriate timestep given the particle positions . a suitable criterion that depends only on the positions",
    "is one based upon the local dynamical time @xmath48 . with this criterion",
    ", select will pick the largest timestep @xmath9 such that @xmath49 where @xmath50 is a constant to be determined based on stability and accuracy requirements . with this criterion , region 2 in figure",
    "[ oops ] is a high density region while region 1 has low density .",
    "similar problems to this loss of reflexivity can occur in the iterative schemes ( hut , makino , & mcmillan 1995 ; kahan 1993 ) if the starting guess of an iteration is preconditioned by the history of the particle .",
    "that is , the loss of reflexivity depends as much on the choice of a  top down \" approach as on the select operator .",
    "our first test is the motion of a test particle in the one dimensional effective potential of the kepler problem .",
    "if the integrator performs well , these tests will guide our choice of @xmath50 for later applications .",
    "the timestep criterion in equation [ dencrit ] is not straight - forward to implement in this case , since the density is zero anywhere outside the central source .",
    "therefore , in this test we determine the timestep by the enclosed density , @xmath51 where @xmath52 is the mass of the central object .",
    "figure [ keplere ] shows the relative change in total energy as function of time for several integrators .",
    "the orbit has eccentricity @xmath4 , and is evolved for about 100 periods .",
    "results for two values of @xmath50 for the @xmath35 method are plotted as well as a result for @xmath47 .",
    "a fixed step integration was also run , and its energy nearly coincides with the @xmath53 @xmath35 method . from the energy plot , it appears that the @xmath35 method with @xmath54 is indeed symplectic .",
    "in contrast , the @xmath47 method with the same timestep criterion experiences a secular drift in the energy .",
    "the savings in force evaluations is also significant . a fixed timestep integration with similar energy errors required 50000 force evaluations to accomplish 100 orbits while the adaptive timestep integration required less than 16000 , a savings of over a factor of 3 for this moderate eccentricity orbit .",
    "also , it can be seen from the energy plot that @xmath55 is needed for the adaptive algorithm to be stable .",
    "this is because a stable orbit , having one integral of motion for each degree of freedom , should be quasiperiodic , which the @xmath54 line appears to be . , and any function of the phase space coordinates , @xmath56 can be expressed as @xmath57 where @xmath58 and @xmath59 are constants . ] for @xmath50 larger than this , the method does not appear to be symplectic , but the changes in energy appear to be due to instability , (  integrals being destroyed ) rather than a secular buildup of truncation error .",
    "a more realistic test of the integrator is the motion of a single particle in the potential of an isothermal sphere .",
    "as well as having a density defined everywhere , allowing the use of the local density in the timestep criterion , the potential is similar to that of globular clusters , galaxies and clusters of galaxies in our large n - body simulations . figure [ isoe ] shows the energy conservation for the @xmath47 and @xmath35 methods for a particle in the potential of a singular isothermal sphere .",
    "the ratio of apocenter to pericenter is 3.2:1 .",
    "the density used for choosing the timestep is the local density of the isothermal sphere . again",
    "the @xmath47 shows a secular drift in the energy , while the @xmath35 has the characteristics of a symplectic method .",
    "also note that in the case of an isothermal sphere , the method is stable for @xmath60 .",
    "for our purposes , the real proof of a given integration method is how well it performs in an actual n - body code . in this section",
    "we test the above methods in two complementary systems .",
    "the first is a king model  a model which , in the absence of collisional relaxation , should remain static .",
    "the second is a cosmological simulation of a universe dominated by cold dark matter ( cdm ) .",
    "this case is very dynamic , with structure evolving on all scales .",
    "all the simulations below were performed with _ pkdgrav _",
    "( dikaiakos & stadel , 1996 ; stadel & quinn , in preparation ) , a parallel code that uses a binary tree with a barnes and hut ( 1986 ) style opening criterion to make the gravity calculation order @xmath61 . to mitigate the effect of force errors",
    ", we use an opening criterion @xmath62 , and accelerations from cells are expanded to hexadecapole order in all the following simulations .",
    "before we test the multistep model in a full n - body simulation , let us explore the more basic question of what single fixed timestep is appropriate for an astronomically interesting n - body model",
    ". for our tests we will use a @xmath63 king model realized with 100,000 particles evolved for 100 central dynamical times .",
    "this is representative of a galaxy halo over its lifetime in a typical cosmological n - body simulation .",
    "energy conservation is a typical measure of the quality of a simulation , but more appropriate measures should involve the convergence of scientifically interesting quantities . for the king model tests we will use the radial density profile which should remain constant in a collisionless simulation . in figure [ leapfden ]",
    "we compare the density profile of the initial king model with that at the end of a simulation with various timestep sizes evolved over 100 central crossing times .",
    "all models were integrated with fixed step leapfrog using timesteps of either 1.0 , 0.3 , 0.1 , or 0.03 times the central dynamical time . from the figure , we see that @xmath64 is needed to maintain the central density of the king model .",
    "figure [ leapfeng ] shows the evolution of the total energy for these same simulations .",
    "note that an energy conservation of better than 3% is needed to preserve the density profile of this king model .    in order to use a density criterion to determine timesteps in a general n - body simulation ,",
    "it is necessary to have a method for calculating the local density for every particle in an arbitrary distribution .",
    "we use a smooth particle hydrodynamics estimate of the density by smoothing over a fixed number of nearest neighbors with a cubic spline kernel .",
    "the smoothing length , @xmath65 , is adaptive and is set so that there are exactly 64 particles within @xmath66 .",
    "the kernel is made symmetric using the `` gather - scatter '' algorithm as described in hernquist and katz ( 1989 ) .",
    "we show the radial density profiles for adaptive timestep integrations in figure [ dakdden ] . from the figure",
    ", we see that , as in the single particle case , @xmath67 is needed to integrate this model with reasonable accuracy . the @xmath35 integration with @xmath54 needed a factor of 6 less force evaluations than the fixed step integration with @xmath68 , or a factor of 2 less than the fixed step , @xmath69 integration .",
    "as shown in figure [ dakdeng ] , the energy conservation of the adaptive scheme is comparable to the fixed step integrator . also shown in the figures are results for the @xmath47 integrator .",
    "it appears that at the level of accuracy needed to integrate this king model for 100 dynamical times , the secular drifts introduced by the @xmath47 integrator do not significantly affect the integration .    before testing timestepping in a cosmological simulation",
    "we first note that the standard leapfrog difference equations used in cosmological simulations with comoving coordinates are not done in canonical coordinates and are apparently not symplectic . however , as shown in the appendix , a symplectic integrator can easily be derived , for which the `` drift '' and `` kick '' operators are @xmath70 where the variables are as defined in the appendix .",
    "we use this integrator in the tests that follow .",
    "this integrator has another advantage over the standard leapfrog difference equations in that it can be used to implement both the @xmath71 and @xmath72 form of leapfrog .",
    "the standard equations can only be derived for @xmath71 .",
    "the @xmath72 form of leapfrog can have advantages over @xmath71 ( see the discussion of costs in  5 ) .",
    "energy conservation may be a an even poorer criterion for determining the accuracy of a cosmological integration .",
    "this owes to the possibility of making small errors in calculating the energy of the uniform background that can dominate the total error budget and mask any problems in the structure of interest .",
    "nonetheless , it pays to examine the evolution of the energy .",
    "it was transients in the energy at the beginning of the cosmological simulations that made us suspect that the integration was not in canonical coordinates , leading to the results in appendix a. but , these large transients in energy had little effect on the three dimensional structure , underscoring our point that it may be a poor diagnostic .",
    "small changes in the way that two simulations handle global energy may be an interesting clue to other aspects of the integrator .",
    "since there is no analytic model for the full three dimensional formation of non - linear cosmological structure , we have to use another simulation to determine the ground truth .",
    "therefore , we test the goodness of a given timestepping algorithm by examining its convergence to a simulation with a large number of timesteps for all particles . this convergence will be assessed based on properties of the groups that are formed and the internal structure of the largest group .",
    "the fiducial simulation is of a standard cdm dominated universe in a periodic box of size @xmath73 ( @xmath74 ) on a side realized on a grid of @xmath75 particles .",
    "this implies a particle mass of @xmath76 .",
    "a spline softening is used with a softening length of @xmath77 .",
    "the initial conditions were imposed on the particles at a redshift of 49 using the zeldovich approximation .",
    "the small size of this box means it does not accurately represent large scale structure , but it does guarantee significant non - linear evolution and a stringent test for the time integrator .",
    "the first convergence test is the density profile at the end of the simulation of the largest halo as identified using a friends - of - friends grouping algorithm .",
    "the object in question has a total mass of @xmath78 within the virial radius and a maximum circular velocity of @xmath79 .",
    "this test looks at how the timestep algorithm affects the structure of well resolved objects in the simulation . since structure forms hierarchically",
    ", the objects in the largest clusters will have experienced a complicated history with several dynamical times in previous generations of structure .",
    "any effect that accumulates with dynamical time is most likely to betray itself in the center of the richest cluster .",
    "comparisons of the density profile of this object in various integrations are shown in figure [ cosmoprof ] .",
    "the fixed step run used 4000 steps in a hubble time .",
    "the @xmath35 and @xmath47 runs used @xmath54 .",
    "as might be expected , the timestep criterion used for the king model simulation performs well in accurately modeling the density profile of this cluster - size object .",
    "looser criteria ( @xmath80 ) fail to capture the central density of the object , just as in the static king model .",
    "our second criterion is the cumulative mass fraction in groups , also as identified by the friends - of - friends algorithm with a linking length of 0.26 times the mean interparticle separation .",
    "this linking length corresponds to an enclosed density equal to the virial density assuming an isothermal sphere .",
    "here the motivation is to see the effect of the timestep algorithm on the smallest objects we can resolve .",
    "the cumulative mass fraction of halos is plotted in figure [ cmf ] .    for the smallest objects ,",
    "the density criterion does not do well .",
    "there is a significant decrease in the number of objects formed with less than one hundred particles in the simulation using the density timestep criterion .",
    "it may not be surprising that particles residing in halos with comparable or fewer particles than that used by the smoothing kernel are unable to accurately estimate their local density .",
    "on the other hand , a simulation using a ( non - time symmetric ) multi - stepping algorithm based on the acceleration of the particles reproduces the numbers of objects seen in the fixed step simulation all the way down to 8 particles .",
    "( the discrepancy seen at about 500 particles per group is due to a merger occurring at the end of the simulation . )",
    "first , we examine our results in terms of the number of timesteps needed to accomplish a given simulation with reasonable accuracy .",
    "we will determine the number of fixed steps before looking at the gain from hierarchical timestepping .",
    "for an equilibrium model where we wish to maintain the overall density profile , the answer is straightforward : the timestep should be set to @xmath81 , where @xmath82 is the maximum density . for a cosmological simulation ,",
    "more assumptions need to be made .",
    "consider a simulation in which the largest halo has a circular velocity , @xmath83 , that is roughly constant with radius down to some core radius , @xmath84 .",
    "if we wish to accurately model this halo , then our timestep criterion must be @xmath85 where @xmath86 is the ( roughly constant ) central density , and we have assumed spherical symmetry . now consider a simulation with a halo with @xmath87 where our goal is to resolve its structure within @xmath88 . in units of the hubble time ,",
    "@xmath89 , we have @xmath90 for @xmath91 , this gives 33,000 steps per hubble time .",
    "previous estimates of the timestep conclude that @xmath92 timesteps are needed per hubble time , where @xmath93 is the gravitational softening length ( lake  1995 ) .",
    "this is consistent with our estimate if we assume that the gravitational softening is 1/5 the core radius we wish to resolve .    to evaluate the performance of a multistep integrator",
    ", we must determine the `` fixed costs '' required for any level of the timestep hierarchy as well as the costs in determining the timestep level assigned to each particle .",
    "the total cost of force evaluations is then added and amortized over the longest timestep .",
    "for example , a tree code requires that the tree is built for all the particles regardless of the number of particles requiring force evaluations .",
    "indeed , for a standard particle mesh code , the forces at every grid point are either calculated or not",
    ". the only part of the force evaluation that is not part of the fixed cost would be the trivial interpolation of the force onto particles .",
    "so , essentially all the costs are fixed and no gain is possible .",
    "first , we consider the costs in the @xmath47 scheme with our tree code , _ pkdgrav _ , and assume that the cost of actually moving the particles and evaluating the timestep is negligible .",
    "a single base step with @xmath3 different timesteps separated by a factor of two , will have a cost of @xmath94 where @xmath95 is the cost to build the tree , @xmath96 is the cost of calculating the force on a single particle , and @xmath97 is the number of particles on a timestep @xmath98 of size @xmath99 times the base step . for a fixed timestep simulation with all particles at the smallest timestep , the cost would be @xmath100 comparing these two costs , it is easy to see that if @xmath95 dominates the computation , then in the limit of large @xmath3 , the @xmath47 scheme would a factor of two _ more _ expensive than the single step calculation . on the other hand ,",
    "if @xmath95 is negligible , then the maximum speedup would be a factor of @xmath101 if almost all the particles were on the largest timestep .",
    "for a given ratio , @xmath102 , between @xmath95 and the cost of evaluating all the forces , @xmath103 , there is a maximum speedup of @xmath104 for large @xmath3 , and almost all of the particles on the largest timestep .",
    "note that for an @xmath105 scheme this maximum speedup would be a factor of two larger since gravity evaluations for larger timesteps are synchronized with those of smaller timesteps , and the same tree can be used for both . for _ pkdgrav _ on the king model with 100,000 particles , the ratio @xmath102 is about @xmath106 , giving a maximum speedup of about 22 .    for the symplectic scheme with a density criterion , the cost of evaluating the timestep is non - negligible , and we must account for it .",
    "it also has a fixed cost part for building the tree , @xmath107 , and a per particle cost , @xmath108 . in terms of these costs",
    "the total cost of a base step is now @xmath109 if the tree build costs and per particle costs for selecting the timestep and evaluating the forces are similar , then the symplectic scheme would be a factor of two more expensive than the non - symplectic scheme . for _ pkdgrav _",
    "running on a 100,000 particle king model , the per particle cost of the density criterion is a factor of 19 smaller than the per particle cost of a force evaluation , and the tree build for a density tree is 50% faster than for a gravity tree .",
    "the maximum speedup assuming an optimum particle distribution is then about 13 .    for realistic particle distributions",
    ", the speed up can be much smaller , especially since a few particles ( 0.1% in the 100,000 particle king model ) end up on timesteps smaller than the single stepping timestep .",
    "the speedup of the multistep run over the single step run as calculated from the above formulae is about a factor of 4 .",
    "note that we have neglected some costs such as particle pushing and the inefficiency of calculating forces for a few particles on modern pipelined processors .",
    "the actual factor in wall clock time is 2.7 .    for non - equilibrium situations such as cosmological simulations ,",
    "a multistep scheme offers additional speedups since it can adapt to the changing time scales in the simulation .",
    "an example of the timestep evolution is shown in figure [ cosmostep ] . here",
    ", the fraction of particles at a particular timestep or larger is plotted as a function of time .",
    "note how almost all particles start out on a very small timestep at the beginning of the simulation when the universe is very dense , and generally migrate to larger timesteps as the simulation progresses .",
    "one could make adjustments for this trend in a single step simulation by transforming to an appropriate variable ,   expansion factor instead of time ( as in efstathiou  1985 ) , but as can be seen from the figure , a simple monotonic transformation would not capture all the complexities of the changing time scales .",
    "furthermore , one would need different transformations for different cosmological models .",
    "finally , to keep the integrations in canonical coordinates would require that the gravitational softening length is fixed in coordinates that were different from either comoving or physical ( see appendix a ) .    from our pragmatic standpoint as users of n - body simulations",
    "to model complex phenomena , the gain from symplectic integrators is their ability to tolerate greater truncation errors in numerical simulations of hamiltonian systems .",
    "this , in turn , allows for longer timesteps and shortens the computer time needed to complete the simulation .",
    "similarly , individual timesteps in a particle simulation allows one to concentrate the computational effort on those particles with the shortest dynamical times that require it .",
    "either of these is beneficial only if their advantages outweigh their cost , whether in computational effort or algorithmic complexity .    for a system like the solar system that is simulated for billions of dynamical times ,",
    "a symplectic integrator has obvious advantages .",
    "any dissipation introduced by truncation error has dire consequences that are easily observable  a planet may spiral into the sun .",
    "the alternatives to symplectic integrators are either very high order integrators or extremely short timesteps , or both .",
    "even a computationally expensive symplectic integrator can be an overall winner against these alternatives .",
    "( wisdom and holman , 1991 ; saha and tremaine , 1992 . )    for other systems , such as galaxies or large scale structure , the situation is not so clear .",
    "these systems are simulated for at most a few hundred dynamical times , and drifts in conserved quantities due to truncation error will not be as noticeable . in these marginal cases , a symplectic integrator will only be beneficial if it is simple to implement and computationally cheap . in this paper",
    "we focus on a criterion based on the local density for this very reason : the algorithm for estimating the local density is very fast compared to calculating gravity .",
    "unfortunately , this criterion is not ideal , particularly for cosmological simulations .",
    "is there a better criterion ?",
    "if we use the kick - drift - kick form of leapfrog , one could imagine a timestep criterion that depends only on the velocity , and therefore commutes with the drift operator .",
    "an example would be @xmath110 , where @xmath93 is the force softening .",
    "three objections can immediately be raised against such a criterion .",
    "first , it is not galilean invariant",
    ". a particle moving with respect to the coordinate system of the simulation will be on a different timestep than one that is at rest irrespective of the forces acting on the particle .",
    "second , if the acceleration of a particle is nearly opposite to its velocity at the beginning of a timestep , then the timestep can be chosen such that the velocity is nearly zero at the middle of the timestep where the select decision is made .",
    "such particles will thereby be always put on a very long timestep .",
    "third , the choice of @xmath93 to set the scale assumes that the dynamical times are set by two - body encounters . for a particle orbiting in a cluster , it is the cluster density rather than two - body encounters that set the dynamical time . on the other hand , in a cluster with significant substructure",
    "the timestep should be set by the encounters with this substructure . in this case",
    ", @xmath111 might be an accurate estimate of the timestep .",
    "an obvious criterion is the acceleration , for example @xmath112 .",
    "this commutes with the kick operator because kick changes only the velocities , and the acceleration is only a function of the positions .",
    "so one could easily use it as the select operator in @xmath35 just like we use the density criterion .",
    "however , the acceleration is just the thing that we are trying to minimize calculating . using it as a timestep criterion will cancel the computational savings we are trying to achieve with multistepping . for an @xmath47 method ,",
    "this is not a problem since one could use the last calculation of the accelerations that were used to advance the velocities .",
    "this luxury is not available for the @xmath35 method , and one would have to evaluate the acceleration of a particle many times during the select phase .",
    "one could also imagine criteria based on higher order terms , such as the magnitude of the divergence of the acceleration , or the time derivative of acceleration .",
    "however , these tend to be even more expensive to calculate than the acceleration .",
    "although our @xmath35 method appears to be symplectic when tested with single particle integrations , it is not the best integrator for general n - body problems .",
    "we simply do not have a suitable select operator that commutes with either the drift or kick operator , that is computationally cheap to evaluate compared to an acceleration , and that returns an accurate timestep in all cases .",
    "the local density criterion does well on the first count but only occasionally satisfies the second .",
    "this problem was foreshadowed by the inability to define the local density in the kepler case and having to resort to a global criterion that used the enclosed density . when calculated in a cosmological simulation by averaging over the nearest @xmath29 particles",
    ", it erased substructure with @xmath113 particles .",
    "we have not exhausted the search for an ideal timestep criterion , and there yet may be something that fits these stringent requirements .",
    "nevertheless , the criterion we have explored in this paper may be very useful in simulations where structure is defined by large numbers of particles , such as in the modeling of galactic structure .    for more general cosmological n - body simulations we advocate either the @xmath47 or @xmath105 method using @xmath114 and/or ( if clusters have significant substructure ) @xmath115 to choose the timestep .",
    "using tests similar to those described for our symplectic integrator we determined that an appropriate choice for @xmath50 is 0.3 ( for plummer softening 0.4 ) to insure stability of the integration .",
    "although this algorithm is not symplectic , it appears to give accurate results for quantities of interest in a cosmological n - body simulation .",
    "this work was supported in part by nasa hpcc / ess grant nag 5 - 2213 and by nasa astrophysics theory grant nagw-2523 .",
    "we also wish to acknowledge useful discussions with scott tremaine .",
    "the equations of motion in a comoving coordinate frame are traditionally presented as @xmath116 where the primed quantities refer to the comoving coordinate frame , @xmath117 is the expansion factor , @xmath118 is hubble s constant , and @xmath119 is the mean background density .",
    "these can be integrated using the difference equations @xmath120 ( see hockney and eastwood , 1981 . )",
    "however , these equations do not appear to be symplectic , , there is no known generating function that produces this transformation",
    ".    however , by making a suitable canonical transformation , one can easily derive an integrator that is symplectic .",
    "the lagrangian for the particle motion in the comoving frame is @xmath121 with the ( time dependent ) generating function @xmath122 , this transforms to @xmath123 where @xmath124 ( see peebles , 1980 . )    switching to the hamiltonian formalism , the momentum canonical to @xmath125 is @xmath126 , and the hamiltonian is @xmath127 although this hamiltonian is time - dependent , it is separable , so the `` drift '' and `` kick '' operators are easily derived as : @xmath70 where @xmath9 is the step size .",
    "note that it is assumed here that there is no explicit time dependence in @xmath128 ;  any softening of the potential must be constant in comoving coordinates . for standard cosmologies",
    "the integrals in the above operators can be easily evaluated .",
    "for example in a critical density universe , @xmath129,\\ ] ] and @xmath130.\\ ] ] for non - flat matter dominated universes , it is convenient to use the parametric solutions ( peebles , 1980 ) , @xmath131 where the constants @xmath132 and @xmath133 are @xmath134 @xmath135 is the curvature radius and the integrals are @xmath136,\\ ] ] and @xmath137 ; } & \\omega & > 1 \\cr & \\displaystyle{= { b \\over a^2 } \\left [ \\coth { \\eta(t ) \\over 2 } - \\coth { \\eta(t + \\tau ) \\over 2 } \\right ] ; } & \\omega & < 1 .",
    "\\cr } } \\ ] ] the above operators can be used to build leapfrog or higher order symplectic integrators for particle motion in comoving coordinates ."
  ],
  "abstract_text": [
    "<S> leapfrog integration has been the method of choice in n - body simulations owing to its low computational cost for a symplectic integrator with second order accuracy . </S>",
    "<S> we introduce a new leapfrog integrator that allows for variable timesteps for _ each _ particle in large n - body simulations . </S>",
    "<S> tests with single particles in fixed potentials show that it behaves as a symplectic integrator . </S>",
    "<S> we then examine the results of both standard leapfrog and our temporally adaptive leapfrog on full n - body integrations of clusters and large scale structure establishing accuracy criteria for both methods . </S>",
    "<S> the adaptive method shows significant speed - ups over single step integrations  but the integrator no longer appears to be symplectic or , in the case of large scale structure simulations , accurate . </S>",
    "<S> this loss of accuracy appears to be caused by the way that the timestep is chosen , not by the integrator itself . </S>",
    "<S> we present a related integration technique that does retain sufficient accuracy . </S>",
    "<S> although it is not symplectic , it is apparently better than previous implementations and is our current integrator of choice for large astrophysical simulations . </S>",
    "<S> we also note that the standard leapfrog difference equations used in cosmological n - body integrations in comoving coordinates are not symplectic . </S>",
    "<S> we derive an implementation of leapfrog that is in comoving canonical coordinates to correct for this deficiency .    # </S>",
    "<S> 1#2#3#4    # 1#2#3    # 1    = cmbx10 = cmbx7 = cmbx5 = = = # 1#1 </S>"
  ]
}