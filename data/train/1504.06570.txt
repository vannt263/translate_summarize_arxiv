{
  "article_text": [
    "modern survey astronomy is leading to extremely large samples of source populations amenable to subtle statistical analyses .",
    "the precision astrophysical investigations that are thereby enabled require high fidelity simulations to properly interpret the observations .",
    "in addition to detailed simulations of astrophysical environments ( e.g. @xcite ; @xcite ; @xcite ) , it is increasingly important to build high fidelity end - to - end simulations of the instrumentation as well",
    ". this can be important for design and optimization of the telescope and camera , for planning future astronomical observations , and for building sophisticated analysis software prior to data taking .",
    "in addition , simulated data can be processed along with the actual observed data through the same analysis pipelines , so that the flaws , biases , and efficiencies of the analyses can be determined accurately .",
    "such an approach is now an indispensable part of modern particle physics ( @xcite ; @xcite ) , high energy astrophysics ( @xcite ; @xcite ; @xcite ; @xcite ; @xcite ) , optical astronomy using adaptive optics ( @xcite , @xcite , @xcite , @xcite , @xcite ) , and has recently become more common in optical survey astronomy ( @xcite , @xcite , @xcite ) . in this work ,",
    "we outline a method for high fidelity optical astronomical image simulation appropriate for survey telescopes .",
    "the goal of this work is to produce high fidelity simulated optical astronomical images .",
    "the level of detail necessary to achieve high fidelity can be precisely defined by considering the measurable properties of the images that we are interested in reproducing .",
    "we can divide those measurable image properties into two categories : 1 ) primary image properties and 2 ) secondary image properties .",
    "the primary image properties are : the point - spread - function ( psf ) full width at half maximum ( fwhm ) , the photometric zeropoint , the plate scale ( or astrometric scale ) , and the background intensity level .",
    "these quantities are predicted from physical effects in the instrument / atmosphere system . if we are only interested in simulated images that correctly reproduce those four primary properties , it is possible to use an empirical parametric approach .",
    "for example , the photometric zeropoint and the object s flux within a band can be used to calculate an object s intensity .",
    "the psf fwhm and the object s spatial distribution yield its observed morphology .",
    "the astrometric scale determines the location in the image , and the background provides the extra uniform intensity level . in many cases ,",
    "such a simulator would be sufficient to predict what a basic image would look like from an astronomical telescope .",
    "however , a simplified simulation tool that only matches these four properties is insufficient for detailed applications .",
    "it is significantly more difficult to predict more complex secondary image properties using parametric models .",
    "examples include : the psf radial profile , the psf size wavelength dependence , the spatial variation of the psf size , the psf shape ( notably , ellipticity ) , the psf shape wavelength dependence , the psf shape spatial decorrelation , the psf shape spatial variation , the differential astrometric shift non - linearity with field angle , the differential astrometric non - linearity with wavelength , the differential astrometric decorrelation with angle , the differential astrometric decorrelation variation , the photometric chromaticity , the photometric variation in time , the photometric variation with field angle , the background variation in time , the background spatial dependence , and the background wavelength dependence .",
    "understanding such properties is essential for subtle statistical analyses associated with galaxy shape measurements , stellar astrometry , and precision photometry .",
    "some of the astrophysical investigations that require such analyses include : photometry of supernovae for measuring the expansion rate of the universe ( @xcite , @xcite ) , using stellar proper motions and parallax measurements to map the structure and kinematics of the milky way ( @xcite ; @xcite ) , measurement of large scale galaxy structure statistics ( @xcite ) , and studies of weak gravitational lensing for both dark matter and dark energy investigations ( @xcite ) .    in this paper",
    ", we describe a simulation tool that takes explicit account of all the detailed atmosphere , telescope , and camera physical effects that determine the propagation of light to the focal plane .",
    "we show that the relevant physics can be most efficiently encoded in terms of photon manipulations .",
    "the goal of this work is to be able to predict all of the primary and secondary image properties from physical models of the atmosphere and instrument within the context of a photon monte carlo approach .",
    "we use very few approximations , and the overall simulation accuracy has been carefully controlled to ensure that calculational errors are small in comparison to the statistical uncertainties associated with measurements of typical sources in the survey .      in this work",
    ", we are interested in simulating images containing large numbers of astronomical objects ( typically , millions ) in the visible and near infrared wave - band ( @xmath0300 to @xmath01200 nm ) that would be obtained in an optical survey . a complete physical simulation with no approximations would take account of the detailed material properties of every element of the telescope and camera and their response to all external forces and temperature variations , a complete hydrodynamic treatment of the atmosphere , and simulation of the full quantum mechanical nature of light .",
    "however , such a rigorous approach is unwieldy , and unnecessary , since a number of key simplifying approximations can be introduced for optical survey telescopes which are non - diffraction limited .",
    "a telescope is non - diffraction limited if    @xmath1 > > \\frac{\\lambda}{d}\\ ] ]    where @xmath2 is the wavelength , @xmath3 is the diameter of the telescope , @xmath4 is the focal length of the telescope , @xmath5 is the fried parameter , and @xmath6 is the characteristic size of aberrations introduced by the telescope and camera .",
    "the fried parameter describes the characteristic beam diameter where the optical phase rms value is close to 1 radian ( @xcite ) .",
    "thus , the first ratio is associated with distortions introduced by optical turbulence ( usually named seeing ) , while the second accounts for imperfections in the optical system .",
    "it is convenient to rewrite this condition in the form :    @xmath7   > > 1\\ ] ]    where @xmath8 is the focal ratio of the system , @xmath9 . for most ground - based optical telescopes the value of @xmath5 lies between 5 and 30 cm , depending on atmospheric conditions .",
    "for modern survey telescopes like lsst ( 8.4 m diameter primary ) , the first ratio is much larger than unity , so throughout this work , values are referenced to 500 nm as this is the standard convention in the literature . ] . in addition , to achieve wide fields of view over a range of wavelengths , practical issues cause these telescopes to be somewhat aberrated , so that the second ratio is generally greater than unity as well .",
    "if some of the physical effects ( e.g. either large aberrations from atmospheric turbulence or large telescope optics aberrations ) cause the system to be non diffraction - limited , we can consider standard ray optics techniques for those parts of the photon simulation .",
    "this does not preclude the use of quantum mechanical calculation or wave - like interference computational techniques at the appropriate physical places as we discuss in  2.1 .",
    "the initial implementation of the data describing a telescope and site in phosim is lsst .",
    "lsst is a wide - field ground - based telescope with extremely large etendue ( the product of the effective area and the field of view ) , 320 @xmath10 , roughly a factor ten higher than all previous facilities .",
    "the large etendue will enable an unprecedented survey of the optical sky .",
    "it also results in a very high anticipated data rate of 15 terabytes of images per night .",
    "lsst is an extreme case of the optical survey regime discussed above .",
    "it is also the most challenging telescope to simulate computationally because of the large quantity of data .",
    "we have therefore chosen to construct the simulator to simulate lsst and focus on that application primarily in this paper .",
    "however , we have written the simulation code to keep the lsst design data separate from the physics algorithms , so other telescopes can be simulated with this code as well .",
    "lsst will be constructed on the el pen peak at the cerro pachn ridge in chile at 2660 m above sea level .",
    "the site is expected to deliver a median seeing of 0.67 arcseconds ( with 0.44  as the 25th percentile and 0.81  as the 75th percentile ) .",
    "lsst is an 8.4 m optical telescope with a three mirror modified paul baker design to allow for a large unaberrated field of view .",
    "it has an effective f/ # of 1.23 .",
    "it has three correcting lenses and complement of filters as part of a 3.2 gigapixel camera .",
    "the camera has 189 individual 4k x 4k ccds .",
    "the 6 filters ( u , g , r , i , z , y ) cover the wavelength region from 300 to 1100 nm .",
    "the intrinsic aberrations of the optical system , the residual aberrations after compensation of the active optics control system using curvature sensors , and the charge diffusion in the devices is expected to contribute about 0.4 arcseconds to the psf ( @xcite ; @xcite ) .",
    "the simulation work described here is embodied in a publically available code called the photon simulator or phosim .",
    "the code and the documentation are located at https://www.bitbucket.org/phosim/phosim_release .",
    "phosim is a stand - alone code that requires catalogs of astrophysical objects ( positions , fluxes , shape , spectra , etc . ) and operational parameters ( pointing information , instrument configuration , etc . ) as input .",
    "the output of phosim is a stream of images .",
    "the user can create the inputs to either match a real observation or to create a hypothetical observation .",
    "the combination of the operational parameters and astrophysical catalog data is called an _ instance catalog _ and is described in  3 . internally",
    ", phosim uses the physics of the atmosphere , telescope , and camera to predict high fidelity images based on the input and is described in the following section .",
    "in the following , we describe the complete set of atmosphere / instrument physics that is encapsulated in the phosim code .",
    "we describe how the physical interactions can be computed in terms of photons manipulations .",
    "given the simulation regime (  1.3 ) and the simulation goals (  1.2 ) it is ideal to adopt a monte carlo approach .",
    "the basic monte carlo approach has been an essential part of computational physics for some time ( @xcite ; @xcite ; @xcite ) . in our case ,",
    "the monte carlo is implemented by following individual astrophysical photons .",
    "thus the integral over the time - dependent , angle - dependent , and energy - dependent incident radiation field is accomplished by simply following individual photons throughout the atmosphere / instrument system .",
    "this is particularly important because a large fraction of the physical effects have wavelength and angle - dependent properties .    in certain contexts ,",
    "the photon s propagation can be represented using ray optics . however , as we show in this formalism , this does not preclude us from using a diffraction calculation for perturbing elements with a wavefront shift smaller than the photon wavelength , a quantum mechanical calculation for photon - atom interactions , or an electromagnetic wave interference calculation at interface boundaries .",
    "thus , ray optics is the methodology we use to represent the photon s interaction with physical elements where ray optics is appropriate , whereas more complex wave optics ( or quantum mechanical physics ) can describe the photon in other areas .    in ray optics ,",
    "the photon state can be represented by a set of eight numbers ( ignoring polarization ) : a vector describing the photon s current position ( @xmath11 ) , a unit - vector describing the angle of propagation ( @xmath12 ) , a time stamp when the photon arrived at earth ( @xmath13 ) , and a wavelength for the photon ( @xmath2 ) . throughout the simulation of the physics",
    ", 3 possible alterations of the photon s variables may occur : 1 ) the photon s trajectory may change and therefore the unit - vector changes its value , 2 ) the photon s position may change as it propagates along its path , and 3 ) the photon may be removed ( most likely because it scattered in an uninteresting direction ) . to a good approximation ,",
    "the photon s wavelength does not change and the time stamp of the photon can be regarded a constant , since a photon moves from the top of the atmosphere to the detector in less than 30 @xmath14 and none of the physical models have rapid changes on that time - scale . by the end of the calculation , we may have converted the photon into an electron in the detector .",
    "the electron similarly can be described by the same formalism , except that the magnitude of the velocity is the relevant quantity instead of the wavelength .",
    "we are therefore using a photon monte carlo method to simultaneously manage the change in trajectory as well as the change in intensity or throughput .",
    "the first step of the simulation is to create the photons from astrophysical sources .",
    "this involves populating the quantities describing a photon .",
    "the propagation direction for a photon coming from a source at a position ( @xmath15 ) is determined by a unit vector , @xmath16 and @xmath17 that is calculated from the current bore - sight of the telescope ( @xmath18 ) according to    @xmath19    @xmath20    @xmath21    where @xmath22 represents a vector cross product .",
    "the coordinate system is then in the telescope s frame where @xmath17 is the optical axis .",
    "we calculate the angle of propagation by first calculating a source vector , @xmath23    @xmath24    and convert the vector into tangent coordinates by    @xmath25    where @xmath26 indicates a dot product .",
    "the source s position is assumed to have astronomical aberration included .",
    "the time stamp , @xmath13 of the photon is chosen in a poisson manner by considering the total exposure time , @xmath27 and a uniform random number , @xmath28    @xmath29    where we include a time offset , @xmath30 , if we are simulating a sequence of exposures .",
    "this will affect other quantities in the case of transient or moving objects .",
    "we determine the photon s initial position , @xmath11 , by first sampling the annular pupil of the primary mirror by choosing the photon s position in polar coordinates ,    @xmath31    where u and v are uniform random numbers , @xmath32 is the outer radius and @xmath33 is the inner radius . the outer and inner radius can be chosen to be slightly larger than the actual physical aperture to allow for photons that scatter into the aperture .",
    "then , we calculate @xmath34 and @xmath35 , and determine the @xmath36 position by using the mirror surface function , @xmath37",
    ". then , we move the photon to the top of the atmosphere @xmath38 .",
    "@xmath39 is calculated using @xmath40 where @xmath41 is the top of the atmosphere ( 100 km ) .",
    "we choose the wavelength of the photon by sampling from a spectral energy distribution describing the source .",
    "spectral energy distributions ( seds ) are normally quoted in terms of flux units ( ergs @xmath42 s@xmath43 @xmath44 ) at given wavelength interval in the spectrum .",
    "we can convert this into a relative probability of a photon appearing in a given wavelength interval by dividing by the average photon energy and multiplying by the wavelength interval .",
    "then we sample from this distribution by converting into a cumulative distribution and drawing a uniform random number .",
    "we blur the wavelength by the bin width . by convention",
    ", we use the part of the sed with wavelength less than 1200 nm ( which would be appropriate for lsst ) .",
    "we also draw the photon in the rest frame of the object , and then redshift the photon by multiplying the wavelength by 1+z .",
    "this allows us to re - use the seds for different galaxies at different redshifts , and still obtain a diversity of galaxy colors .",
    "sources that are extended on the sky are treated by first choosing the direction , @xmath12 , using the procedure above for the nominal center ( @xmath45 , @xmath46 ) of the source emission , but then perturbing the unit vector by a structural model for the spatial emission .",
    "we can use a paraxial ray approximation to perturb the values of @xmath47 and @xmath48 and then renormalize the unit vector .",
    "the most useful spatial model we have constructed is an ellipsoidal sersic distribution .",
    "the intensity of light of the sersic distribution ( @xcite ) is given by    @xmath49    where @xmath5 is the scale radius , @xmath50 is the sersic index , and @xmath51 is a normalization constant for each @xmath50 .",
    "we then draw a value of @xmath52 from this probability distribution , and then choose the distance along the major and minor axes as @xmath53 and @xmath54 where @xmath55 and @xmath56 are model inputs . finally , we rotate the major and minor axes by a rotation angle , @xmath57 . in practice ,",
    "we have found it useful to represent galaxies as a pair of ellipsoidal sersic models where one represents the bulge and one represents the disk .",
    "each component has a different sersic index , their centers are possibly offset , and they can have different major and minor axes . a pair of ellipsoidal sersic models results in a 12 parameter model with reasonable fidelity",
    ".    for more accurate galaxy morphology simulations , another common model we include is to simply input _ truth _ images of the source before it would have been observed through the effects of the atmosphere and telescope .",
    "we use this by using this truth image as the 2 dimensional probability distribution of finding a photon in a given angular pixel .",
    "we then select photons from this distribution .",
    "we also allow for an arbitrary rotation and scaling that places the source at different distances and orientations .",
    "the truth images can either come from other telescopes ( particularly those taken with a night with better seeing or a space - based telescopes ) , or be generated by another simulation .",
    "a simple perturbation to the spatial models is to include the effect of weak gravitational lensing for distant galaxies .",
    "this is accomplished by taking the photon s relative position to the source s center @xmath58 and apply the matrix    @xmath59    where @xmath60 , @xmath61 , and @xmath62 are the usual weak lensing shear and convergence parameters . the user s cosmological simulation can estimate these parameters from the individual foreground dark matter distribution for each galaxy individually .",
    "we handle moving objects ( e.g. solar system objects or satellites ) by simply perturbing the initial photon direction by a proper motion vector ( in units of angle per time ) and multiplying by the photon s relative time stamp .",
    "this results in streaks when the full simulation is completed . both of these effects can also be handled by a distorted truth image , but are added options since they can be applied to objects when expressed as catalog entries .",
    "there are a large number of photons that contribute to the optical sky background .",
    "we model these photons from 3 sources : airglow from the dark sky , reflected moonlight , and additional emission near twilight .",
    "we also simulate light from a dome screen through the same mechanism .",
    "for each of these forms of diffuse light , we model them by a collection of sources uniformly spaced on the celestial sphere .",
    "this is necessary to allow for complex spatial gradients .",
    "we space the sources by 15 arcseconds , and draw photons from a two dimensional spatial gaussian having a standard deviation of 15 arcseconds .",
    "this results in a statistically uniform illumination pattern , but limits us to not have a spatial variation of the illumination patterns on scales smaller than 15 arcseconds . for each diffuse model",
    ", we therefore need to predict the intensity of light across the field on 15 arcseconds scale .    for the simulation of airglow emission",
    ", we use a spectral energy distribution taken from @xcite . the overall intensity for a given exposure",
    "is simulated as having a r band magnitude from a gaussian distribution with mean of 22.08 and a standard deviation of 0.9 .",
    "we then predict a relative variation across the field using spatial power spectrum measurements of @xcite where the variation was proportional to @xmath63 and normalized to be 3% at 1 degree .",
    "we also increase the emission in proportion to the zenith angle ( @xcite ) .",
    "the mean sky background and its variation are consistent with the measurements of @xcite .",
    "the moon s intrinsic brightness as a function of its phase and altitude follows the calculation of @xcite .",
    "we use an empirical lunar spectrum for its sed .",
    "we then need to predict the brightness where the telescope is pointing . here",
    "we use the @xcite formula that has terms for the rayleigh and mie scattering of the moonlight . @xcite",
    "only calculated the lunar brightness for one band so we simply scale the rayleigh term by inverse wavelength to the fourth power .",
    "conversely , mie scattering is approximately wavelength independent .",
    "the sky brightness is increased near twilight according to the sun s altitude using a color - dependent model of @xcite .",
    "the total number of photons for a particular source is calculated by considering the ab magnitude at a particular wavelength .",
    "we have found it most convenient to normalize the spectrum at a wavelength of 500 nm divided by @xmath64 of the source .",
    "we then convert the flux nearest that wavelength to units of ergs @xmath42 s@xmath43 hz@xmath43 .",
    "then , we convert the sed to a relative fraction of photons in each bin . using the probability of finding a photon in the bin near the reference wavelength , 500 nm/@xmath65 , one can then calculate the total number of photons per sq .",
    "centimeter per second from that source at all wavelengths .",
    "this convention is most useful using a un - redshifted spectrum , since the same sed can be used for multiple sources at different redshifts .",
    "conversely , this does not preclude a user redshifting a sed before input and then setting the redshift to zero .",
    "the total number of photons ( without including any efficiency losses ) is calculated by multiplying by the aperture area and exposure time .",
    "we then modulate that expected photon count rate using a poisson distribution .",
    "a final step of the sky simulation is to remove some fraction of the photons due to dust absorption .",
    "we use two dust extinction curves : the @xcite model and the @xcite model .",
    "each model has two parameters : @xmath66 and @xmath67 .",
    "the models are stored in a variety of grid lookup tables and the dust is applied by first calculating the optical depth , @xmath68 , using the photon s wavelength .",
    "then we destroy photons with probability @xmath69 . performing dust extinction through a monte carlo approach",
    "conveniently also avoids construction of a unique sed for every single source . for extra - galactic sources",
    ", we have the option of applying the dust absorption both before and after the redshift of the photon , representing absorption in the galaxy as well as in the milky way .",
    "after creation of the photons from the astrophysical and sky emission , we then propagate the photons through an atmosphere simulation .",
    "we first describe the structure of the atmospheric components , and then describe how the photon interacts with those components .",
    "we model the atmospheric structure by a series of plane - parallel layers .",
    "each layer covers the absorption and turbulence blurring between two altitudes .",
    "the propagation of a ray from one layer to the next is straightforward using plane - parallel layers .",
    "the photon s position can be updated using @xmath38 where the scalar distance , @xmath39 is calculated from    @xmath70    where @xmath71 is the altitude of the interface between the two layers and @xmath72 is the same as in  2.2 .",
    "atmospheric turbulence is known to significantly degrade overall image quality of astronomical telescopes .",
    "the energy power spectrum of atmospheric turbulence is known to have a power spectrum that approximately follows the scale - free kolmogorov spectrum ( @xmath73 ) , so the largest powers are on the largest scales ( @xcite ) .",
    "this spectrum extends down to the viscous limit ( a few mm ) and up to the scale where the turbulence is driven . the complete spectrum is often parameterized by an outer scale , @xmath74 , and a flat power spectrum above that point ( @xcite ) ,    @xmath75    the justification of using this spectrum to describe the real atmospheric turbulence has been established in detail ( @xcite ) .",
    "the use of a von karman spectrum rather than a kolmogorov spectrum has several observational consequences ( @xcite ) .",
    "other more complex power spectra are sometimes considered ( @xcite ) and non - kolmogorov effects are an active area of turbulence research , but astronomical image quality is generally not particularly sensitive to these details .",
    "the temperature variation produced by this airflow turbulence pattern leads to index of refraction variations that affect light propagation ( see e.g. @xcite ) .",
    "the deviation of index of refraction from unity ( @xmath76 ) is approximately linearly proportional to the pressure and inversely to the temperature , and the effect of pressure fluctuation is negligible compared to the temperature variation .",
    "so therefore the same turbulent eddies produce index of refraction variations with the same spectrum as the temperature variation .",
    "the entire effect of the turbulence on light propagation is then represented by a phase shift as a function of spatial position ( i.e. , a phase screen ) .",
    "furthermore , the turbulence pattern itself for a particular layer is known to not change significantly during the time it takes to cross the aperture of the telescope ( a fraction of a second ) . to a good approximation , the pattern tends to drift with some wind velocity vector and remain essentially frozen during its aperture crossing ( taylor hypothesis ; @xcite , @xcite , @xcite ) .",
    "in addition , the most significant turbulence tends to occur stochastically in relatively narrow interfaces due to either differential shearing of the atmosphere or vertical instabilities .",
    "hence , it is very common to represent the turbulence as a series of _ frozen _ plane - parallel two - dimensional screens where the three - dimensional structure for a given slab of the atmosphere has already been collapsed into two dimensions .    we therefore propagate light through a series frozen - phase screens drifted by wind velocity vectors .",
    "this simulation approach is standard in the adaptive optics community and is well studied ( e.g. @xcite , @xcite , @xcite , @xcite , @xcite ) .",
    "however , we made two novel innovations to suit our particular problem that are not standard techniques .",
    "first , instead of propagating light through by computing the full diffraction integral , we used a novel geometric raytracing approximation for the low - frequency part of the phase screen described in  2.3.2 .",
    "second , we constructed the phase screens on four different scales and repeated the three smaller phase screens on the larger scales .",
    "the tiling scheme has been previously explored by @xcite for a single scale , and here we simply extend the method to four scales .",
    "this general approach is necessary to capture the large scales involved in the simulation of a wide - field telescope like lsst .",
    "in particular , the screen size , @xmath77 has to be large enough to not repeat during an exposure time ( @xmath78 ) and large enough to not repeat when off - axis sources are considered ( @xmath79 , where @xmath80 is the height of the highest layer ) .",
    "we therefore use a linear superposition of four 1024 by 1024 pixel screens having a pixel size of @xmath81 , @xmath82 , @xmath83 and @xmath84 cm .",
    "every pixel in the 5 km x 5 km screen is therefore unique .",
    "numerical artifacts result from certain alignments of patterns along the fundamental axes of the screens with the wind direction ( 0 , @xmath85 , @xmath86 , @xmath87 , etc . ) since the patterns may be repeat and a small part of the screen gets used .",
    "however , the actual atmosphere has about a 5 degree per minute drift of the wind direction ( @xcite ) , which makes these artifacts not occur in the complete simulation when this effect is turned on .",
    "this is particularly important in the detailed simulations of wavefront images .",
    "we drift the turbulence screens according to a wind model where we predict a wind vector as a function of height for a particular observation . in order to determine where a photon hit a screen at a given layer , we first calculate the x and y position .",
    "we then calculate the pixel in the appropriate screen given two components of the wind vector for each screen .",
    "the arrival time of the photon then dictates exactly which pixel is used . using the noaa ncep / ncar reanalysis monthly database for a particular location",
    ", we fit the historical data to a weibull distribution ( k=2 ) for the wind velocity .",
    "both the wind direction and magnitude have a seasonal distribution .",
    "we drift the wind direction during an exposure according to measurements of @xcite .    in order to construct the turbulence screens ,",
    "we require the single parameter , the outer scale , of the @xcite model for each screen . within the context of this model",
    ", it is often argued that this varies as a function of height , has a large time variation , and likely has a log - normal distribution ( e.g. @xcite , @xcite , @xcite ) .",
    "a log - normal distribution is a good match to the lsst site where the mean ( 35.6 m ) and median ( 26.7 m ) parameters were measured by @xcite .",
    "the possible altitude - dependence of the outer scale is still an active area of research ( e.g @xcite ) , so we do not have an altitude - dependence to the outer scale .    to predict the relative turbulence intensity as a function of altitude",
    ", we construct an interface based on the model of @xcite for the cerro pachon site .",
    "however , other sites can clearly be represented by different set of parameters as is evident in the general nature of the parameterization below . in this model",
    ", they use a 7 layer model ( a ground layer and 6 layers at 0.5 , 1 , 2 , 4 , 8 , and 16 km ) . with a series of measurement",
    "they then quantified the 25th , 50th , and 75th percentile of the turbulence integral , @xmath88 , where @xmath89 is the refractive index structure function and @xmath80 is the altitude .",
    "we then use these percentiles and represent the complete distribution of @xmath90 at each altitude as a lognormal distribution .",
    "@xcite found that the turbulence intensity of the ground layer was largely independent of the other layers .",
    "the free atmosphere layers , however , were highly correlated as seen by comparing figure 5 and table 3 in @xcite .",
    "therefore , we use a single random number for the free atmosphere and a single random number for the ground layer .",
    "this then tends to produce poor seeing when either the free atmosphere or the ground layer is particularly turbulent .",
    "we can use this model in two different ways .",
    "first , if a random atmosphere is desired , we simply draw turbulence intensities from this model .",
    "second , to obtain a particular seeing , we run this model hundreds of time to produce the desired seeing . in either case",
    ", the final turbulence intensity values are used to normalize each screen .",
    "in addition to the screens of turbulence , we track four components that represent the bulk air located between the screens : the density of the atmosphere vs. height , the density of water vapor vs. height , the density of molecular oxygen vs. height , and the density of ozone vs. height ( @xcite ; @xcite ) .",
    "these profiles are then used to calculate the column density between layers ( @xcite , @xcite ) we calculate the column density relative to the appropriate altitude .",
    "we also modulate the overall column density from one simulation to the next by a lognormal distribution with width equal to 0.18 , 0.20 , 0.002 , and 0.01 for water , ozone , molecular oxygen , and the overall density , respectively .",
    "this represents the natural time - dependent variation .",
    "when the telescope is not pointed at zenith , we increase the column density by the exact zenith - dependent airmass .",
    "we recalculate this for every photon separately since the variation of airmass across the field can be significant for wide fields .",
    "we then use these column densities to calculate the optical depths , which is described in  2.4.2 .",
    "the local column density is also perturbed by a factor of @xmath91 of a screen with an arbitrary variation pattern at each layer . in this way",
    ", the opacity will vary slightly from exposure to the next , and it will vary across the field in a complex way with amplitude , @xmath92 . however , the parameterization of reasonable variation patterns is still an active area of research .",
    "we also have clouds screens to represent the relative opacity of cloud absorption at various heights .",
    "the cloud screens have an exponential structure function with a angular coherence scale of 2 degrees to be consistent with the measurements of @xcite based on sdss wide field images .",
    "we assumed that the structure is isotropic , but clearly have non - isotropic structure that could be related to the wind direction .",
    "we use two layers of clouds each with a different wind velocity to create a partly realistic complexity that would at least mimic the difficulties for photometric calibration . the photon interactions with all the components and properties of the atmosphere are described in the following sections .      an important component of the atmosphere simulation is the propagation of the photons through the turbulent screens . the theory of how light propagates through a turbulent medium has been extensively studied ( @xcite , @xcite , @xcite , @xcite , @xcite ) , and it is common to use hugyens - fresnel scalar diffraction theory , which represents light as a monochromatic wave having a scalar amplitude at all spatial positions . the so - called _ geometric optics limit _ , where non - linear effects can be ignored , is valid when the characteristic height of turbulent layers in the atmosphere is less than the square of the characteristic turbulent cell size divided by the wavelength in which the observation is performed    @xmath93    for typical atmospheric conditions at good sites , h @xmath94 10 km , and l @xmath94 10 cm , which means that this condition is essentially satisfied across the entire optical band : @xmath2 = 0.3 to 1 @xmath95 m . in this limit",
    ", we can write the psf in terms of the fraunhofer integral ( see e.g. @xcite ) . here , the instantaneous psf is given by the square of the fourier transform of the electric wave amplitude , can be written as @xmath96 . however , for the exposures considered here the amplitude fluctuation is negligible and the last factor has no effect on the image , so only the second factor is relevant in the above integral . ] over the pupil plane    @xmath97    where k = @xmath98 , @xmath12 is the unit vector pointing to that particular point on the focal plane , and @xmath99 is the telescope pupil transmission . for the usual small angular displacements appropriate to the psf",
    ", @xmath12 has coordinates ( @xmath100 , @xmath101 , 1 ) , where @xmath100 and @xmath101 are coordinates in the focal plane with units of angle .",
    "the phase , @xmath57 , which appears in this expression is the total phase shift produced by all of the atmospheric layers along the line of sight due to variations in the index of refraction .",
    "note that the psf can also be expressed as the fourier transform of the correlation function of the exponential of the complex phase    @xmath102    the turbulence in the atmosphere is a stochastic process , which means that both the phase correlation function and the psf will depend strongly on time through the variation in the random structures of the various atmospheric layers that cross the pupil plane at any particular instant .",
    "however , for an exposure of finite duration , a larger footprint on these atmospheric layers is observed , which means that the effective psf is averaged over such structures , and it is meaningful to estimate it via statistical techniques . in the adaptive optics literature , it is common to talk about two distinct limits : the long exposure limit , in which one takes a complete average over the turbulent structure on all spatial scales , and the short exposure limit , in which one takes some average over scales which are small compared to the diameter of the pupil , but ignores the effects of much larger scales .",
    "the latter is appropriate , because as we show below , the primary effect of the larger scales for short exposures is image displacement , not an increase in psf width .    if we are interested in estimating psf anisotropy and decentering for moderate exposures , an intermediate limit is required .",
    "since there are no preferred axes in the problem , the long exposure limit , which involves a full statistical average over all of the turbulent structures must clearly yield a circularly symmetric psf with no decenter",
    ". however , there are significant variations in the image motion for moderate exposures , which are in fact the principal causes of residual anisotropies , so these must be modeled correctly .",
    "that means that the short exposure limit is also inappropriate .",
    "the intermediate limit can be found by separating out the contributions to the psf from structures on large and small scales . in what follows ,",
    "we provide a formal justification for how that works in detail .",
    "we first define the separate contributions to @xmath57 that are contributed by large and small scales    @xmath103    where @xmath104 is the contribution from structures with wavenumber larger than some critical value , @xmath105 , and @xmath106 is the contribution from structures with wavenumber less than @xmath105 .",
    "we choose @xmath105 such that structures with larger wavenumbers are very well sampled during the exposure , so that the long exposure limit is indeed applicable on those scales , and we can estimate their contribution statistically . for wavenumbers",
    "less than @xmath105 , we effectively compute @xmath106 directly for a simulated exposure by generating phase screens with appropriate resolution , i.e. with a sampling @xmath107 .    note that because the psf is insensitive to the mean phase , both @xmath106 and @xmath104 can be taken to have mean zero , with no loss of generality .",
    "then , the correlation function , @xmath108 , that we introduced earlier , can be written in the form    @xmath109    as indicated , we evaluate the first complex exponential term in the integral by taking a statistical average of turbulent structures at higher wavenumbers .",
    "that clearly removes an explicit dependence on @xmath110 , so it is possible to express the correlation function as the product of two separate correlation functions for the two separated wavenumber regimes    @xmath111    the psf due to the atmosphere is the fourier transform of the correlation function .",
    "it can therefore be represented as the convolution of the separate psf contributions from large and small wavenumbers    @xmath112    as indicated above , for wavenumbers larger than @xmath105 , we can average over the turbulent structure , because these scales are well - sampled even for moderate exposures .",
    "the analysis follows closely that which is typically invoked for the long exposure limit .",
    "specifically , we assume the kolmogorov theory of turbulence , which posits that energy is injected into an atmospheric layer on large scales and cascades down to smaller and smaller scales via turbulent eddies , until it eventually can be dissipated by molecular viscosity .",
    "the instability is characterized by the reynolds number . for typical atmospheric parameters ,",
    "the reynolds number remains above the critical value down to scales of order millimeters , while energy is injected on scales of 10 meters .",
    "therefore , the structure is turbulent over a very broad range of wavenumbers .    in kolmogorov s statistical treatment ( @xcite ) , the rate of energy per unit mass that is injected is equal to that which is dissipated down through the cascade to smaller and smaller scales .",
    "simple dimensional arguments then suggest that the characteristic velocities obey the relation    @xmath113    which means that the temperature fluctuations are proportional to @xmath114 .",
    "index of refraction variations are basically proportional to the temperature fluctuations , so they are proportional to @xmath114 as well . integrating over a layer , which is thick compared to the characteristic eddy size , leads to a two - dimensional phase power density proportional to @xmath115 , where @xmath52 is a spatial scale on the two - dimensional layer . in spatial frequency space ,",
    "the power spectral density is then proportional to @xmath116 .",
    "the full expression for this power spectral density is    @xmath117    here @xmath118 is the so - called structure parameter .",
    "it is a measure of the distribution of seeing contributions as a function of altitude .",
    "it has units of @xmath119 .",
    "we now consider @xmath120 . taking the average over the turbulence yields    @xmath121    expanding the complex exponential as a taylor series , and recognizing that @xmath122 is a gaussian random variable with mean zero ,",
    "it is clear that the odd moments vanish , so that @xmath123 can be written in the form    @xmath124    where @xmath125 is the phase structure function , given by    @xmath126 ^ 2 > \\ ] ]    note that this can be written as    @xmath127\\ ] ]    where    @xmath128    is the correlation of the phase itself .",
    "since @xmath129 is the fourier transform of the phase power spectral density , so the phase structure function can be written as an integral over spatial frequency for the turbulent layer .",
    "since we only want the contribution due to wavenumbers greater than @xmath105 , we can truncate this integral accordingly .",
    "the resulting expression is    @xmath130 \\phi_\\phi ( \\kappa ) \\kappa d \\kappa\\ ] ]    the equations above yield a closed form expression for @xmath131 . the fourier transform of that expression gives us @xmath132 .    for wavenumbers smaller than @xmath105",
    ", the statistical average can not be invoked if we hope to make a useful model of the anisotropy and decenter . in this regime",
    ", we have to calculate the phase screens directly .",
    "the exact approach would be to fourier transform those phase screens , but this is computationally intensive for screens large enough for large field of views , especially when one considers the motion of the screens associated with the wind velocities during the nominal exposure .",
    "instead , we adopt a computationally much faster approach , which utilizes the refractive approximation . that approximation can be justified at these large scales by the following argument .",
    "consider a two - dimensional turbulent patch on the phase screen of characteristic size @xmath52 .",
    "radiation can interact with that patch in two related but distinct ways : first , if there is a gradient in the index of refraction over the patch , it will act like a prism , so that the light will be refracted at a finite angle .",
    "this displaces the image of a star , i.e. gives rise to image motion without increasing the image width .",
    "second , the finite size of the turbulent patch gives rise to diffraction .",
    "this increases the width of the image , without , in general , causing significant displacement .",
    "the two effects depend very differently on the size of the patch .",
    "as discussed earlier , the phase power for kolmogorov turbulence is proportional to @xmath115 .",
    "we show below that the image displacement due to refraction is given by    @xmath133    so @xmath134 is proportional to @xmath135 . for diffraction on the other hand ,",
    "@xmath134 is proportional to @xmath136 , so the former is dominant on large scales , while the latter is dominant on small scales .",
    "the two effects are nearly exactly equal at the scale of the fried parameter , @xmath5 , which is a measure of the seeing , and is defined by the relationship    @xmath137    for good seeing sites , @xmath0 0.6 arcsec , @xmath5 @xmath0 10 cm or so .",
    "therefore on scales significantly larger than this , approximating the effect of the turbulence purely refractively is appropriate .",
    "the argument for the refractive approximation is even stronger if the primary effects one is interested in involve psf asymmetry and decenter . since a given scale",
    "is sampled multiple times over the pupil plane during a finite length observation , the net effect of image displacement due to that scale is reduced by a factor of @xmath138 , where n is the number of samplings . since @xmath139 is inversely proportional to @xmath140 then @xmath138 is proportional to @xmath52 , so the contribution to psf asymmetry and decenter scales like @xmath141 , i.e. the largest scales completely dominate .",
    "the arguments above suggest that the natural choice for @xmath142 is of order @xmath143 . at smaller wavenumbers , refraction is dominant , and we can ignore diffraction completely . at larger wavenumbers , diffraction is dominant , but the full effect of the turbulence can be modeled statistically . the fact that @xmath5 is much smaller than the aperture of the telescope for modern telescopes like lsst means that this approach works extremely well for our application .",
    "the scale of the fried parameter is sampled many times in the pupil plane , so even invoking the refractive approximation will merely cause circularly symmetric image blur with a characteristic width of @xmath144 .",
    "that is what a true diffraction calculation would give anyway for the contribution from this scale .",
    "the analysis above suggests an especially simple implementation approach for an image simulation code . the refractive approximation",
    ", formally , corresponds to an expansion of @xmath145 as a taylor series in @xmath52 , and only keeping the first term    @xmath146    when that substitution is made , we get    @xmath147    where @xmath148 is the diffraction profile of the telescope itself .",
    "so the effect is purely image displacement .",
    "that means that the refractive approximation can be trivially implemented using ray optics : we bring photons individually down through atmospheric layers , and simply deflect them according to the local gradient of the phase .",
    "this will work as long as the resolution of the phase screens does not exceed @xmath105 .",
    "this functionally accounts for the contribution @xmath149 as shown above , the total psf is the convolution of the psf s from the lower and higher wavenumber regimes .",
    "the convolution of two probability distributions gives the total probability of displacement if the contribution of each process is completely independent .",
    "for @xmath150 , we have a closed form expression for this probability distribution .",
    "we can thus sample that distribution , in both magnitude and direction , and give the photon a second deflection accordingly .",
    "this two - kick raytrace then fully accounts for the net affect of that phase screen on all spatial scales .",
    "numerically , we implement the two - kick raytrace by first generating two sets of turbulent screens ( 4 for each layer ) : the first ( @xmath106 ) with turbulence generated from the van karman spectrum only with wavenumber below @xmath142 and the second ( @xmath104 ) with wavenumbers above @xmath142 . in practice , we found choosing @xmath151 to produce the most stable and accurate results , which is consistent with the estimate discussed above .",
    "for the interactions of photons with the first set of screens we use the refractive approximation implemented by taking the derivative of the phase .",
    "this interaction produces the ellipticity and image motion of the psf . the interaction with the second set of screens",
    "is accomplished by asymptotically averaging the aperture - weighted fourier transform of these screens and producing a single time - averaged psf .",
    "this is equivalent to the long - exposure psf for just this high frequency set of screens , and is equivalent to the closed - form solution we discussed above but in practice we use our exact generated screens .",
    "the effect of this second set of interaction adds additional wings to the psf as expected .",
    "the two are implemented in sequence by performing the convolution in a monte carlo .",
    "we scale the angular displacement in proportion to @xmath152 , which is consistent with the overall scaling from complete diffraction calculations ( @xcite ) . if we choose @xmath142 to be an arbitrarily large number and therefore use the refractive approximation with the entire spectrum , then we get an unphysical circularly symmetric psf which is consistent with behaviour in @xcite , so the hybrid approach is necessary for proper treatment of the high frequency power .",
    "thus in this approach we are making two approximations that are testable : 1 ) that the refractive approximation is valid for the first set of screens and any speckle inference structure averages sufficiently and 2 ) that the time - averaging of the small spatial scales is applicable .",
    "we test this combination of these two approximations quantitatively in  4 demonstrate its validity for reasonable exposure times @xmath153 .",
    "the net effect of this hybrid approach is that the computational efficiency is about four orders of magnitude larger than by using a pure fourier approach .",
    ", for a screen area of @xmath154 where @xmath3 is the telescope aperture and @xmath155 is a typical wind velocity and @xmath156 is the exposure time .",
    "alternatively , our approximation only involves a mathematical operation for each photon for the refractive calculation , and a one time diffraction calculation for all sources .",
    "thus , the computational speed up scales as @xmath157 . for @xmath158 , @xmath159 , @xmath160 , @xmath161 , and @xmath162 ,",
    "this ratio is @xmath163 and is close to the actual observed computational ratio . ]",
    "we simulate molecular opacity by considering the wavelength - dependent optical depth through each segment of the atmosphere layers .",
    "we use the hitran database to calculate the absorption line cross - section for the water and molecular oxygen absorption lines ( @xcite , @xcite , @xcite , @xcite , @xcite , @xcite , @xcite ) .",
    "we follow the methodology described in the appendix of @xcite to calculate the absorption line intensity .",
    "we include pressure broadening so we get a different opacity at each altitude .",
    "we use the formulae of @xcite for the calculation of the cross - section due to ozone .",
    "the opacity of the atmosphere is determined by calculating the local optical depth for each segment of the photons path . between each atmospheric screen",
    "the column density of each molecular species of the atmosphere is calculated by integrating the density profiles in our bulk atmosphere model and the path length the photon .",
    "thus , the probability that the photon is destroyed along its particular path segment is equal to @xmath164 where    @xmath165    where the sum is taken over all the species of molecules .",
    "we also include the opacity due to aerosol scattering by including an additional contribution to the optical depth given by :    @xmath166    where @xmath167 and @xmath168 are the default parameters , but vary at different sites due to a different mixture of aerosol types .    when a photon hits a cloud screen pixel it has some probability of being absorbed ( destroyed or lost by scattering outside the aperture ) .",
    "we use an average opacity of 0.85 magnitudes for each of the two clouds screens with a 1 @xmath169 normal variation equal to the chosen mean opacity divided by 11.3 .",
    "the latter value was chosen so that the structure function normalization is consistent with that determined by @xcite .",
    "we chose to make the variance proportional to the mean since the measurements of @xcite demonstrated that when the total cloud opacity is larger , there also seems to be a proportionally larger photometric variation .",
    "this results in an average total opacity of 1.2 magnitudes , and has a broad distribution , and is reasonably well matched to typical photometric variation of actual sites .",
    "these parameters may be different for different sites .",
    "atmospheric dispersion is simulated by using the index of refraction in air from @xcite    @xmath170 @xmath171    where @xmath172 is the air pressure ( in mmhg ) , @xmath173 is the water pressure ( in mmhg ) , and @xmath174 is the ground temperature ( in c ) .",
    "this shifts the angle of the photon depending on its wavelength by a small angle .",
    "the direction of the shift is calculated by determining the vector to the zenith .",
    "the net atmospheric dispersion of the center of the field can be offset for a nominal wavelength .",
    "the simulation of the telescope and camera optics is performed by defining a series of surfaces that separate the obvious volumes composed of various media ( e.g. air , silicon , glass , vacuum ) .",
    "we first describe the geometry of the telescope and camera optics , and then discuss the photon interactions .",
    "the optical elements of telescopes can often be described by cylindrically - symmetric aspheric surfaces ,    @xmath175    where the height as a function of radius , @xmath176 , is expressed in terms of a radius of curvature , @xmath177 , a conic constant , @xmath62 , and higher order coefficients , @xmath45 .",
    "lenses are described by two aspheric surfaces ( front and back ) , whereas mirrors are described by a single surface .",
    "the specification of these surfaces then define the regions where the glass is located . in those regions",
    "we compute the index of refraction using the sellmeier equation ( @xcite ) ,    @xmath178    we specify the detector plane by a series of rectangular devices each having a nominal center ( x , y ) , a number ( @xmath179 , @xmath180 ) of square pixels having fixed pixel size , @xmath92 . for the index of refraction inside the silicon ,",
    "we use    @xmath181    where @xmath182 is the energy of the photon in ev ( @xcite ) . additionally , the regions of the telescope / camera system that are not held at vacuum have the refraction index of air given by @xcite as described in  2.3",
    ". we also model the three - dimensional spider support structure as a series of rectangular volumes .",
    "therefore , the combination of the series of aspheric surfaces , detector elements , and the indices of refraction of the media uniquely specify the configuration of the telescope / camera optics design .    an important aspect of the simulation is to perturb the optical elements and detector segments from their nominal positions due to expected small misalignments . with real telescopes a large part of the image quality budget is dominated by errors from misalignments and surface deformations of the optical elements .",
    "this is due to either fabrication or assembly errors , or environmental effects .",
    "environmental effects include changes in temperature that misalign or deform optical elements , gravitational vector changes due to the different pointing orientations inducing misalignments and deformations , and other mechanical forces including wind and seismic variations .",
    "modern telescopes use control systems that attempt to correct for most of these environmental changes , but also may induce additional misalignments and surface deformations due to their residual inaccuracy . to account for all of these possible perturbations ,",
    "the simulator includes a misalignment and surface deformation for every optical element .",
    "the misalignments include the 6 degrees of freedom : decenter ( 2 ) , defocus , and euler rotations ( 3 ) .",
    "we model the surface perturbations using a zernike expansion up to 5th order .",
    "parameters describing the tolerance for each degree of freedom are input to phosim for any optical design .",
    "we are currently developing an interface to input actual engineering finite element calculations for the distortions and misalignments of surfaces for the lsst system specifically .",
    "the simulator can then choose a distorted surface based on various state variables ( temperature , elevation , and actuator positions ) .",
    "a tracking model perturbs the entire telescope and camera system .",
    "the model simply perturbs the position of the photons in the reference frame of the camera and telescope , and represents the residual tracking errors that are expected for a nominal tracking system with parameters describing the tracking tolerance and update timescale ( default of 0.1 seconds ) .",
    "we have implemented a gaussian random walk model that varies throughout the exposure sequence .",
    "every 0.1 seconds , a random walk step is taken in both elevation , azimuth , and rotation of the camera .",
    "the mean step is calculated so that the final rms size of the jitter after a given exposure time meets the expected tolerance .",
    "thus , the temporal spectrum is purely white up to 0.1 seconds . between every 0.1 seconds ,",
    "the jitter is interpolated .",
    "we also include errors in the effective exposure time of the shutter .",
    "as the photon is propagated through the telescope / camera optical system , it experiences a set of photon interactions .",
    "the first involves dome seeing .",
    "we model dome seeing by perturbing the photon s trajectory by an isotropic gaussian angular distribution equal to the expected contribution .",
    "if the effective eddy size in the dome is sufficiently small this is a valid approximation , but if it is not then some of the dome turbulence can still be accommodated in the ground layer .",
    "some of the dome turbulence may have a limited drift speed depending on the airflow in the dome .",
    "an essential calculation is to find the location of each photon hit on a given surface .",
    "consider a photon at position @xmath183 with a unit vector trajectory of @xmath12 .",
    "we loop through all possible surfaces by calculating the ray intersection distance . in order to find the intersection of a ray with a given surface with height , @xmath184",
    ", we move the ray a scalar distance , @xmath39 , and minimize , @xmath185    @xmath186    where the surface includes the zernike deformations . before calculating the intercept we make a three dimensional euler transformation and spatial transformation of the photon s position and trajectory to place the photon into the frame of the optic .",
    "the above equation can be solved exactly ( @xmath187 ) for quadratic surfaces , so we first approximate @xmath37 with a parabolic approximation , @xmath188 , and solve the equation for @xmath189 .",
    "we then compute @xmath185 between the actual surface and the position using the propagation distance , @xmath190 , and choose a new value of @xmath39 equal to    @xmath191    we iteratively change @xmath39 using this equation until it converges to within a tolerance of 0.01 microns . for even highly aspheric surfaces",
    "the method usually converges in 3 to 5 iterations , which is essential for the computational efficiency of the code , since there are many surfaces in a typical telescope .",
    "when the next interaction surface is chosen , the photon is moved to the new position .",
    "if the surface is a mirror we reflect the ray across the normal to the mirror using a three - vector computation .",
    "the normal has been pre - calculated for all surfaces including the surface perturbations .",
    "the ray s propagation vector , @xmath12 is then modified . if the surface is a lens , we refract the ray by applying snell s law , also using a three - vector computation with the indices of refraction on the two sides of the surfaces determined by the formulae discussed above .",
    "we currently assume that the index of refraction is constant within the material for a given wavelength , but implementation of spatial varying indices of refraction is straight - forward .",
    "the detector elements and lens elements are treated identically as equivalent optical surfaces .",
    "the optical elements have an interference coating that may affect the transmission of the photon .",
    "the probability of transmission is a function of both incident angle and the wavelength .",
    "we include the full wavelength band in the simulation , so out of band filter leaks can be properly modeled .",
    "the two dimensional transmission probability is calculated using a full electro - magnetic interference boundary calculation through the actual surfaces .",
    "when the photon reaches a coating , we use its wavelength and angle to decide whether it is reflected or transmitted .",
    "if the interacting surface is the mirror , the photon is destroyed if it is not transmitted . in the case of filter coatings or lens and detector anti - reflective coatings",
    ", the photon can be reflected backwards .",
    "thus , we use the same reflection algorithm and allow the photon to propagate backwards .",
    "this implies that ghost patterns are included in the simulation .",
    "we currently have a four column interface which accepts coating reflection and transmission functions that are a function of both angle and wavelength .",
    "coating descriptions are typically defined in this form , but we also have an external code for the complete em multi - layer calculation which can calculate this format when the multi - layer structure is known .    note that we have already included the effect of the diffraction of the telescope pupil in the small - scale phase screen of  2.3.2 .",
    "the point - spread - function therefore properly includes an airy - like component due to the entrance pupil .",
    "there is some freedom , however , in whether or not to imprint the spider pattern in the fourier calculation .",
    "if we do that , there is a significant variation in the projected spider size when light at large off - axis angles is included and , in principle , every source has a slightly different diffraction pattern .",
    "alternatively , we can use the edge diffraction calculation method of @xcite , where the photon s position is shifted by an angular deflection of @xmath192 , where @xmath2 is the wavelength of the photon and @xmath193 is the closest distance a photon ray gets to the edge of any part of the spider structure .",
    "thus , @xmath193 can be calculated in fully three - dimensions and this calculation then results in both the correct geometric shadowing of the spider structure as well as the radial envelope of the diffraction spikes , but not any interference modulation of the diffraction spike pattern .    to represent the incoherent scattering that occurs from micro - roughness on the mirror surfaces",
    ", we use a simple empirical model for large angle scattering .",
    "the micro - roughness of mirrors ( at the nm level ) primarily causes photons to scatter to very large angles ( few arcminutes ) . at the current time , we have not implemented a physical model for this , but instead invoked an empirical radial distribution determined for stars measured with the gemini south telescope :    @xmath194 .",
    "we set the fraction of light in this diffuse halo compared to the core at a fixed fraction , @xmath8 .",
    "therefore , at the start of the telescope simulation the photon has a probability , @xmath8 , of being scattered according to the above formula .",
    "the best fit profile had a value of @xmath195 .",
    "there may be a contribution due to mie scattering from dust particles included in the above formulae ( @xcite ; @xcite ; @xcite ) .    to determine the probability of photoelectron conversion in the silicon detectors , we calculate the mean free path of the photon as it enters the silicon .",
    "the absorption coefficient depends on the device temperature and the photon energy , @xmath196 according to the model of @xcite ,    @xmath197    @xmath198+a_d \\sqrt{e_{\\gamma } -e_{gd}(t)}\\ ] ]    where @xmath199 is given by    @xmath200    where @xmath201 , @xmath202 , @xmath203 , @xmath204 , @xmath205 , @xmath206 , @xmath207 , @xmath208 , @xmath209 , @xmath210 , @xmath211 , and @xmath212 .",
    "the mean free path is then calculated by taking the inverse of the absorption coefficient .",
    "we then calculate the actual conversion path length by taking the mean free path and multiplying by an exponentially distributed random number .",
    "if the conversion length exceeds the full depth of the silicon , we allow for reflection off the backside of the device .",
    "if reflection occurs , we continue the conversion calculation on the reflected ray .",
    "the reflection probability actually depends on a full em interference calculation that can result in fringing .",
    "we calculate the reflection probability using a single layer of silicon with a height that is a function of position that depends on our perturbations using an em single - layer calculation .",
    "the silicon interference probability then depends on the index of refraction on the front surface and on the back surface as well as the photon polarization .",
    "we also include the possibility that the photon converts in an effective _ field - free _ region at the back surface .",
    "on the back surface of devices there may be a residual field - free region due to the manufacturing process ( such as using laser annealing ) . to simulate this effect , we simply remove any electrons that have converted in the field - free dead layer .",
    "this then will have the correct wavelength - dependence based on the photon conversion mean free path .",
    "after the photon has converted to an electron , we simulate the charge diffusion profile as it is drifted to the readout . to do this ,",
    "we have developed a model of the electric field profile in the silicon .",
    "@xmath213    where v is the overdepletion potential , @xmath214 is the silicon thickness , @xmath215 is the permittivity in silicon , and @xmath216 is the doping density function which is given by    @xmath217    note , that the impurity density , @xmath218 is not necessarily a constant due to the difference in segregation coefficient between the dopant and the silicon .",
    "the impurity may have a `` tree - ring '' pattern centered on the axis of the original boule .",
    "the relevant electron transverse diffusion at each height is calculated with gaussian diffusion width , @xmath219 , where @xmath3 is the diffusion coefficient , @xmath220 , and the collection time is @xmath221 .",
    "we have included the effect of the velocity saturation of the electron in the expression for @xmath222    @xmath223    where @xmath224 , @xmath174 is given in k , and @xmath182 is given in v / cm .",
    "after we compute the charge diffusion at the position in the silicon , we use the gaussian width to move the electron laterally in the silicon and place it at the readout surface .",
    "finally , the electron s position is quantized by determining in which pixel it is located .",
    "in addition to the diffusion there is a small lateral mean shift due to any small lateral field .",
    "these lateral field result from impurity variations , edge effects , charge stops , and accumulated charges during the exposure .",
    "characterizing these lateral fields in silicon devices is an active area of research ( e.g. @xcite ) .",
    "the lateral kick the photon receives during its drift is given by    @xmath225 @xmath226    we allow for simple parameterizations of the transverse field to add this complication . we are continuing to evaluate the ideal parameterization based on real devices .",
    "the lateral field is also known to modified by the accumulated charge ( @xcite ) .",
    "in addition to lateral field , real devices may not have perfectly square pixels due to lithography errors , which can be simulated by simply making a non - regular map for the pixels at the readout .",
    "the simulation proceeds by collecting electrons in pixels .",
    "we simulate the effect of charge saturation and bleeding by first not allowing a given pixel to exceed the full well depth in electrons , @xmath227 .",
    "once the full well depth is exceeded we move that electron towards the end of the row in either direction .",
    "we do not allow the electrons to move past the implant at the center of the device , and place the electron in the closest unfilled pixel along that row .",
    "once the entire row has exceeded the full well depth , we remove the electron entirely .",
    "this then approximates the effect of bleeding .",
    "actual images of cosmic rays are added to the simulated images using real data from thick silicon devices @xcite . to do this",
    ", we constructed postage stamp images of 130 different actual cosmic ray events .",
    "we then add these randomly to our simulated images using two important calculations . to determine how often to place a cosmic ray in the image",
    ", we use the production rate of 0.04 cosmic rays per sq .",
    "centimeter of silicon per second .",
    "the actual cosmic rays are expected to be a combination of gamma rays from local ground radiation and muons and other particles from atmospheric particle interactions .",
    "our data have some combination of the two , but perhaps not in the correct proportions .",
    "a second calculation gives us the scaling of electrons in the cosmic ray data , to the appropriate volume of silicon of the simulated pixels .",
    "this correctly normalizes the correct number of ionized electrons in the simulated devices .",
    "hot pixels are added to the image by randomly choosing a fraction of the pixels and then placing electrons equal to the full well depth .",
    "similarly , a fraction of the pixels are flagged as dead and then the electrons are removed from those pixels .",
    "hot columns are simulated by selecting some fraction of pixels that are the ends of hot columns and then setting those pixels and the pixels behind that pixel in the readout chain to full well depth .",
    "dark current is computed for the length of exposure , and modeled by randomly adding a number of electrons to each pixel with gaussian error .",
    "the ccds are segmented according to the amplifier readout scheme .",
    "rows or columns are added according to the number of pre - scan or over - scan pixels .",
    "each pixel is then assigned a readout sequence according to the parallel and serial charge transfers .",
    "electrons then have some probability of being shifted to a pixel behind it in either the serial or parallel direction during the readout .",
    "we found that it was necessary to perform a shift for every pixel individually , since the cte values can be quite high with modern devices ( @xmath228 ) , and it is not possible to make a multinomial approximation for this effect .",
    "we then loop through the pixels in readout order .",
    "read noise is implemented by using a gaussian with mean equal to the expected read noise value .",
    "we also vary this value between amplifiers .",
    "finally , the digitization process can be approximated by    @xmath229    where @xmath230 is the number of electrons in a given pixel , @xmath231 is the gain , @xmath173 is the full well depth , @xmath232 is the bias , and @xmath139 is a non - linearity factor . we have not implemented a detailed model of gain and bias variations across each segment or as a function of time , but we do vary these parameters between amplifiers . we also have implemented possible digitization errors in which each bit is modified by    @xmath233    and then the final adu value is given by    @xmath234    where the @xmath235 values are empirically determined estimates that keep the digitization from being perfect .",
    "the software is constructed to simulate a series of images in identical form to what a real telescope would produce .",
    "the input resembles the combination of operational commands a real telescope operator would execute , and a set of astrophysical catalogs .",
    "the final output is a sequence of fits images produced from individual amplifier chains of ccd devices .",
    "following , we discuss the overall architecture and numerical implementation of the physics we described in  2 .",
    "phosim is written in object - oriented c++ code .",
    "the codes are run with python scripting .",
    "the overall architecture is shown in figure 1 .",
    "the c++ code is divided into 5 parts : the atmosphere creator , the instrument configuration , the trim program , the photon raytrace , and the electron to adc codes .",
    "the codes are configured to simulate a particular visit ( a series of exposures at a given place on the sky ) .",
    "the first two codes set up all the input data that are required to describe the current atmosphere and instrument configuration . the trim program is then run for every chip where the astrophysical catalog is reduced to only objects that have a significant chance of producing photons on that particular chip ( either object centered in the projected sky tile for that chip or particular bright objects that may have a large scattering halo or scattered ghost photons ) .",
    "this facilitates parallelizing the calculation .",
    "the photon raytrace simulates the individual photons through the atmosphere , telescope , and camera and collects the converted photo - electrons in an image .",
    "finally , the electron readout is simulated and the image is digitized in the electron to adc code .",
    "the input and output to the code are well defined .",
    "the input consists of an _ instance catalog _ , which is a list of objects in the sky at the particular time of the observation and a description of all the properties needed in  2.2 .",
    "the instance catalog also includes the commands that a telescope operator would have available and other environmental parameters that may affect how the observation would be done .",
    "other astrophysical information , such as the position of the sun and moon is included as well .",
    "we also have a physics command file as an optional second input .",
    "this includes any commands to override our representation of the most realistic physics .",
    "this can be used in a large number of ways including by turning off a subset of effects in a modular way or setting parameters to specific values .",
    "those are useful options , both for validation and testing , and also for studying the physics that might lead to a systematic error in a particular image processing algorithm .",
    "the main output of the code is raw digitized fits images for every amplifier on every ccd .",
    "there are alternative other outputs as well that are unavailable with a real telescope .",
    "we can output an event file , which describes the interaction position of every photon as it is propagated through each layer or surface .",
    "we also can output the actual number of photons detected from every source and the mean coordinate of those photons .",
    "this information would be only approximately known from the images .",
    "we also can output the relative throughput of photons at each layer or optical surface .",
    "the phosim code only has two package dependencies : cfitsio ( @xcite ) and fftw3 ( @xcite ) , and is otherwise built using both standard c / c++ libraries and custom numerical codes .",
    "this allows us greater custom numerical detail , and makes the installation straightforward .",
    "the entire phosim code is designed so it can be implemented easily on grid computing .",
    "the architecture was designed so that i / o would be minimal and the simulations could be done in parallel at the chip level .",
    "the package can be run with both a script for laptop / desktop simulations and another script that uses condor to generically run simulations on grid computing systems ( @xcite ) .",
    "we have built an extensive validation framework with the phosim code .",
    "the framework includes both unit testing and integration testing .",
    "the unit testing executes individual functions to assess whether the return values obtain the correct values .",
    "integration tests run the entire suite of code and determine whether measured properties of images obtain measured values within a specified tolerance .",
    "integration tests use instance catalogs of a limited number of objects ( usually stars and galaxies ) , and then use the configuration files to run the photon simulator in a variety of configurations .",
    "we describe some of the results of the validation tests in  4 .",
    "the entire photon simulation package is on a git repository that is available at https://www.bitbucket.org/phosim/phosim_release .",
    "associated documentation is available at this site .",
    "we release a tagged version several times per year .",
    "we use a modern modular object - oriented software design approach where the speed of the code is a very important consideration that we discuss in the following section .",
    "there are a variety of numerical implementation details specific to each of the implemented physical effects .",
    "in general , monte carlo simulation times are proportional to the number of points in the monte carlo integration ( in our case , the numbers of photons ) and a fixed overhead associated with setup . either reducing the time per photon or reducing the number photons that need to be simulated can minimize the simulation time . for the former , minimizing the number of mathematical operations done on each photon reduces simulation time . removing redundant calculations by saving values in pre - calculated tables",
    "wherever possible is one key to optimization .",
    "we do this for the shapes of the optical surfaces , transmission curves , turbulence screens , optical depths , etc .",
    "the overall reduction of the number of lines of code that need to be executed in the inner loops is also important , so this has been a priority throughout its development .",
    "currently , we are simulating a photon in about 2 @xmath14 on a 2.5 ghz processor , implying a very efficient number of calculations per photon .",
    "this can possibly be improved further ( and has during the recent development ) , but it is a fairly small number of operations considering the detailed physics and fidelity constraints .",
    "we profile the code periodically , and the various parts of the calculation described in  2 contribute roughly equally at the current time since obvious bottlenecks have been removed .",
    "we have performed another set of optimizations that reduce the overall numbers of photons that need to be simulated .",
    "these optimizations have a minimal effect on the fidelity , and all the optimization can be turned off for detailed comparisons .",
    "we have three such optimizations that we call : 1 ) dynamic transmission optimization , 2 ) saturated object simulation , 3 ) and background optimization simulation .",
    "dynamic transmission optimization works by attempting to guess whether the given photon has any chance of surviving the monte carlo simulation .",
    "the most common way for a photon to be removed is by not surviving the filter transmission .",
    "a simple optimization is to pre - roll the random numbers at the start of the simulation of the photon .",
    "we then store a worst - case transmission curve for each atmospheric layer and surface coatings for each wavelength as the simulation is running .",
    "this is necessary because of the complication that our transmission functions are not only wavelength - dependent but they may be angle - dependent and time - dependent as well . therefore , we simply estimate first if the photon has any chance of surviving the series of transmission functions before the photon is simulated through the full physics .",
    "this improves the simulation speed by an order of magnitude , and has a negligible change on the photometry .",
    "a second optimization is the saturated object simulation optimization .",
    "the brightest stars in a typical field contain a very large fraction of all the photons .",
    "however , the vast majority of those photons end up in a saturated bleed trail that has a negligible amount of useful information . to take advantage of this",
    ", we have built an optimization that makes the ray represent n photons instead of just one when it is highly likely that ray will end up in a saturated bleed trail .",
    "this can be done at run - time as soon as the pixels start to saturate and exceed the full well depth for a given source . to simulate the wings of the saturated source accurately with the right statistical properties , we are able to keep track of the rays that might end up in the wing from large angle scattering ( either diffraction spikes , mirror surface microroughness , or diffraction in the atmosphere )",
    ". we can then enhance the probability of those events happening by artificially looping over that physics @xmath139 times .",
    "we then choose @xmath139 such that the probability of the photon being kicked by an angular distance greater than the current minimum radius of the saturation pattern , @xmath5 , is greater than a value , @xmath6 .",
    "normally , @xmath6 would be a small quantity ( few percent ) without optimization , but here we enhance its probability to @xmath236 .",
    "we preserve probabilities , however , by letting the ray represent @xmath237 photons , if it is not a large angle photon .",
    "@xmath237 is given by    @xmath238    on the other hand , we only let the ray represent one photon if it is a large angle photon .",
    "similarly , we conserve the photon detection probability by letting the ray represent @xmath139 photons , if it is removed .",
    "thus , the algorithm still simulates one photon at a time for virtually all photons that will be measurable in the image ( the wings ) , but simulates several at a time for photons in the saturated bleed trail or those not detected at all .",
    "the final optimization involves the simulation of the background photons from airglow , scattered moonlight , twilight , or dome light simulations .",
    "since these photons outnumber the astrophysical photons , it is important to simulate them efficiently . on the other hand",
    ", we found that using parametric models of the background ( i.e. trying to predict the flux in each pixel and then adding noise ) did not result in high enough accuracy for some of the more subtle physics details .",
    "an algorithm that facilitates faster simulations is to represent the ray as @xmath139 photons for part of the simulation .",
    "when the photon is closer to the pupil plane , a diffuse illumination pattern will produce an nearly identical photometric response for small angular distances .",
    "equivalently , most of the differences in background from one pixel to the next occur because of physical effects near the image plane .",
    "therefore , when the photon reaches the detector we can randomly spread the @xmath139 photons in a gaussian pattern ( with @xmath169 of several arcseconds width ) and simulate the detector physics one photon at a time . to not induce fluctuation patterns , @xmath139 should be chosen so that we do not simulate many more than @xmath239 where @xmath92 is the photons per pixel .",
    "this results in two orders of magnitude faster background simulation , and varying degrees of accuracy depending on the choice of @xmath139 and @xmath169 . with the default parameters , a reduced @xmath240 of 1.1",
    "is obtained for comparing the images of off - axis chip simulation with this optimization turned on and off .",
    "for detailed studies of either bright stars or background models the optimizations can be turned off so photons are properly simulated one photon at a time for complete accuracy .",
    "we implemented the lsst design details through a series of data input files .",
    "the physics code is written deliberately without including any reference to lsst - specific data , so implementation of other telescopes is straight - forward through an alternative set of design files .",
    "we do not describe the detailed design parameters of lsst here , but table 1 lists the variety of design information that is needed to describe a telescope and site . the physics implemented above should be appropriate for most optical survey telescopes without significant modification",
    ". there may be possible extensions to other specialized systems as well , such as an adaptive optics telescope , where the effect of the ao control loop on the residual phase error would have to be considered .",
    "an application to a space - based telescope would be straight - forward as well . extending the physics wavelength coverage into",
    "the uv and further into the ir would also require little modification . however , the validation studies we pursue below are most appropriate for simulating optical survey telescopes .",
    "ll optical prescription for & type of optic , @xmath241 + every optical element & position , outer / inner radii , @xmath62 , + & @xmath242 , @xmath243 , @xmath244 , @xmath245 , @xmath246 , @xmath247 , @xmath248 , @xmath249 + & medium adjacent to surface + focal plane geometry & position , pixel size , pixel # s , + for every device & thickness , readout speed , + & shape distortion parameters + surface perturbation & distribution parameters + and misalignments for & + every degree of freedom & + coating for & transmission probability + every optical surface & vs. angle and wavelength + device data & hot / dead pixel rate , + for every sensor & hot column rate + readout data & amplifier segmentation , + for every amplifier & pre / over - scans , read noise , + & serial and parallel cte , gain , + & bias , non - linearity + site data & turbulence distribution + for every layer & outer scale distribution + & wind vector distribution + location & latitude , longitude , altitude    in figure  [ fig : label2 ] , we show the path of the photon through the large dynamic range of scales in the photon simulation .",
    "the top left image shows the path of photon in a cylindrical column through the atmosphere , the bottom left and bottom center images show the photons moving through the telescope system , and the bottom right image shows the conversion of photo - electrons in the silicon .",
    "the top image then shows the resulting images of stars and galaxies are they are collected in pixels .",
    "this figure does not completely show the physics detail in the simulation .",
    "figure  [ fig : label3 ] , however , demonstrates the physics detail by simulating a single star and successively turning on more physical effects in the simulation .",
    "each separate part of the simulation contributes in different ways to the size and shape of the psf , the photometric intensity , and the astrometric position of the image .",
    "the star was simulated in the u , i , y filters and combined to be a three - color rgb image , so that the chromatic effects can be seen .",
    "figure  [ fig : label4 ] shows a simulation of a star through the same optics and atmosphere configuration , but at a point 1 degree away from the center of the field . through comparison of these two figures , the subtle spatial dependence of the psf and photometric properties can be seen .",
    "table 2 summarizes the relevant physical effects that determine the particular image properties .",
    "figure  [ fig : label5 ] is a collection of 3 amplifier images with various stars and galaxies using catalogs generated by @xcite .",
    "every photon has been simulated and sampled from the spectral energy distributions and spatial models in the catalog .",
    "ll photometric acceptance & geometric acceptance , coatings , + & photo - electric conversion , + & atmosphere opacity , clouds + psf size & optical design + & atmospheric turbulence + & perturbations and misalignments , + & dome seeing , tracking + & charge diffusion + & mirror micro - roughness + astrometric scale & optical design , + & atmospheric dispersion , + & tracking , + & perturbations and misalignments + background level & diffuse airglow , + & reflected moonlight , + & geometric acceptance , + & coatings , + & photo - electric conversion , + & atmosphere opacity , clouds + psf shape and variation & atmosphere turbulence , + & optical design , + & lateral detector fields , + & atmospheric dispersion , + & misalignments and perturbations + differential astrometry & atmosphere turbulence , + & atmospheric dispersion , + & lateral detector fields , + photometric variation & coating non - uniformity , + & lateral detector fields + & interference non - uniformity + background variation & rayleigh and mie scattering , + & airglow variation +    to date , we have validated the most critical aspects of the simulator . however , a complete validation is beyond the scope of this work and awaits wider community involvement using real data from astronomical telescopes .",
    "following , we discuss the most critical aspects of addressing any possible _ calculational _ errors ( i.e. given an ideal setup can phosim properly calculate a set of given quantities ) .",
    "the larger future validation , however , involves possible _ representational _ errors ( i.e. does the simulator accurately reproduce the image properties from a given telescope and site ) .",
    "representational errors are much harder to address , since they involve understanding the exact characteristics of the telescope , camera , and site and not just the correct implementation of the physics of photon and electron propagation .",
    "the required calculational accuracy of phosim is a complex topic .",
    "as described in the previous sections , we avoid making approximations , unless they result in orders of magnitude faster simulation rates .",
    "thus our goal is to make the physics as complete and accurate as possible .",
    "although there is a vast range of science applications that would place disparate requirements on simulation accuracy , a first order estimate of required accuracy can be obtained by considering the statistical error for measuring various attributes of the point spread function .",
    "if the calculational error is significantly below the statistical error for a source with a given number of photons then the error will be unobservable .",
    "in the appendix , we estimate generically that in an optical survey the brightest new source will have statistical photometric error of @xmath250 millimags , a fwhm uncertainty of @xmath251 milliarcseconds , a centroid uncertainty of @xmath252 milliarcseconds , and an ellipticity uncertainty of 1.4% .",
    "below , we show that the known calculational errors of phosim are significantly below those thresholds .    for the calculational validation of the atmosphere simulation ,",
    "we show typical phase screens in figure  [ fig : label9 ] .",
    "three examples of 50 m by 40 m phase screens of the combined 7 layer set of screens after combining the screens on the 4 different pixel scales are shown . despite the complexity in constructing these images",
    ", they qualitatively resemble phase screens generated using standard techniques ( @xcite , @xcite , @xcite , @xcite , @xcite ) , but we have a representation of the phase over several kilometers .",
    "a quantitative validation is shown in the upper left panel of figure  [ fig : label9 ] where we calculate the two dimensional structure function of the phase screen and compare with the analytic calculation of @xcite for a pure kolmogorov spectrum and the numerical integral of @xcite for various values of the outer scale for a von karman spectrum .",
    "no visible artifacts can be seen in the structure function .",
    "the propagation of light through the phase screens uses the hybrid propagation technique that can be compared with a traditional fourier approach .",
    "this is shown in figures [ fig : label10 ] and  [ fig : label11 ] .",
    "figure  [ fig : label10 ] shows an instantaneous exposure , whereas figure  [ fig : label11 ] shows a typical 15 second lsst exposure .",
    "the psf using both numerical approaches is calculated and compared on lsst pixel scale ( bottom ) and finer scale ( top ) .",
    "the residual subtracted psfs ( right ) show no obvious biases or errors .",
    "quantitative comparisons can be made by measuring weighted moments and computing the centroid and ellipticity . even for bright stars ,",
    "the statistical errors in the centroid and ellipticity are statistically consistent using the two approaches . to quantify this , we performed two dozen simulations of stars using the two approaches and plot the measured ellipticities and centroids demonstrating a high correlation in figure  [ fig : label12 ] .",
    "the differences are shown in the histogram in the right panel and are consistent within statistical errors .",
    "this histogram can be used to set an upper limit to the error of the technique of 0.60 milliarcseconds for the centroid error and 0.0046 for the ellipticty error .",
    "thus , the only significant error of this light propagation technique may be for arbitrarily short exposures with diffraction limited telescopes where the hybrid technique will not reproduce the speckles in figure  [ fig : label10 ] .",
    "however , as we discussed in  1.3 , this is not relevant for optical survey telescopes .    for the calculational validation of the instrument simulation ,",
    "we show a spot diagram simulation in figure  [ fig : label13 ] . a spot diagram is produced in phosim by turning off detector effects , ignoring perturbations and misalignments of the optics , and by making arbitrarily small pixels .",
    "we compare the result of 5 different monochromatic simulations for a 1.4 degree off - axis point with the commercial raytrace code , @xcite .",
    "the rms spot size is about 0.1 arcsecond , so smaller than a single pixel .",
    "the x - axis in figure  [ fig : label13 ] subtracts off the large positional offset expected for such an off - axis source of 254911.0 @xmath253 .",
    "this demonstrates that we are correctly predicting the positions of photons at least to the 7th digit .",
    "a detailed ray - by - ray comparison can be used to assess the quantative accuracy of the geometric raytrace .",
    "we find that the discrepancy in ray positions has an average displacement of 0.18@xmath253 , most likely due to the numerical accuracy with which we store surface maps .",
    "note that this is less than 1/50th of an lsst pixel .    for the verification of photon throughput",
    ", we simulate a top hat spectral energy distribution , and verify the analytic prediction for the number of photons .",
    "we then compare the detected number of photons with the analytic calculation    @xmath254    where @xmath80 is planck s constant , @xmath255 is the ab magnitude at 500 nm , @xmath256 is the exposure time , @xmath257 and @xmath258 are the inner and outer radii of the aperture , and @xmath259 and @xmath260 are the wavelength limits of the top hat .",
    "figure  [ fig : label14 ] shows the number of photons generated using phosim as compared with the analytic prediction using square spectral energy distributions , the aperture of lsst , and the exposure time .",
    "the results are consistent within statistical errors , and well below any reasonable science application with phosim since the mean inaccuracy is 0.45 millimags ( @xmath261 ) .",
    "thus , the numerical simulation of the atmosphere and instrument is sufficient for nearly all practical science cases .",
    "there is still considerable work to validate representational errors .",
    "figure  [ fig : label15 ] shows the speed of the calculation , and demonstrates the efficiency of the photon monte carlo approach .",
    "the speed is proportional to the number of photons for unsaturated sources ( above 15th magnitude ) and is approximately 400,000 photons / s on a typical workstation ( 2.5 ghz mac intel processor ) .",
    "background photon simulations are considerably faster ( factor of 60 ) , and saturated sources are as well ( factor of 8 for a 12th magnitude star ) due to the optimization described in  3.2 .",
    "the computation takes about 3 hours for a single chip of lsst ( 13 by 13 arcminutes ) filled with a typical distribution of stars and galaxies for a 15 second exposure .",
    "thus , despite the physics complexity pursued in this work , we can simulate typical individual sources which may have thousands of photons in a few milliseconds . using large scale computing",
    ", we have run the code on about 2000 processors simultaneously for a variety of data challenges to simulate lsst simulations for the data management team .",
    "therefore , during these runs we are already generating data within reach of the actual real time image production rates of the future highest data rate telescope ( lsst ) . where @xmath262 is the number of chips in the focal plane ( 189 ) and @xmath263 is the number of processors .",
    "] since the simulations are done in parallel , there is no barrier to scaling to arbitrarily large numbers of cores .",
    "we have demonstrated the implementation of atmospheric and instrumental physical effects appropriate to astronomical image simulation for optical survey telescopes .",
    "the simulation approach using a photon monte carlo is both efficient and flexible .",
    "simulations with this level of physics detail are remarkably fast with the photon monte carlo methodology .",
    "detailed second order image properties can be studied in analyses that require high precision ( e.g. astrometry , detailed psf modeling , photometric calibration ) using this simulation tool .",
    "there are a variety of ways to improve and extend the code further .",
    "future work involves validating physics techniques and adding more details to the representation of the instrument and site characteristics .",
    "the most important fidelity improvements are : 1 ) a physical model predicting the perturbations and misalignments , 2 ) a description of lateral charge diffusion associated with electric field distortions , and 3 ) more accurate atmosphere site models for both turbulence and opacity .",
    "detailed validation may be achieved by greater community involvement with the simulations of existing telescopes in various configurations , an we expect that this tool will be useful for many different science applications .",
    "jrp acknowledges support from purdue university , the department of energy ( de - sc00099223 ) , national science foundations research experience for undergraduates ( reu ) for purdue physics , the lsst project ( c44054l ) , and large - scale computing support from the rosen center for advance computing ( rcac ) at purdue university .",
    "we thank the lsst internal reviewers , j. thaler , m. jarvis , & d. kirkby , for helpful comments and a careful reading of this manuscript .",
    "we thank an anonymous referee for very helpful comments that improved this manuscript .",
    "abahamid et al .",
    "2004 , a&a 422 , 1123 .",
    "ackermann et al . 2012 , apjs 203 , 4 .",
    "adams & skrutskie 1996 , 2mass airglow experiment final report .",
    "agnostinelli , s. et al .",
    "2003 , nuclear inst . and methods a , 506 , 250 .",
    "allison , j. et al .",
    "2006 , ieee trans . on nuclear science 53 , 1 , 270 .",
    "andersson , k. a. , peterson , j. r. , madejski , g. 2007 , apj 670 , 1010 .",
    "antilogus et al .",
    "2014 , j. inst .",
    "vol 9 , c03048 .",
    "beland , r. & j. brown 1988 , phys 37 , 419b .",
    "bertin , e. 2009 moemorie della societa astronmica italiana 80 , 422 .",
    "boccas , m. 2004 , gemini technical note : cp seeing & gs iq .",
    "b. , norman , b. ellsworth , g. james , r. 1999 , j atmos . ocean tech .",
    "16 , 1884 .",
    "britton , m. c. 2004 , proc .",
    "spie 5497 , 290 .",
    "cardelli , clayton , mathis 1989 , apj 345 , 245c .",
    "calzetti , d. et al .",
    "2000 , apj 533 , 682c .",
    "clifford , s. f. 1978 , chapter 2 in laser propagation in the atmosphere , vol .",
    "condor , http://research.cs.wisc.edu/condor/    coulman , c. , vernin , j. coqueugniot , y , caccia , j. l. 1988 , apopt 27 , 155 .",
    "connolly , a. et al .",
    "davis , j. et al . ,",
    "spie 8443e , 1 .",
    "doty , j. , images of cosmic rays in thick devices , priv .",
    "comm .    de vries , w. , olivier , s. , asztalos , s. , rosenberg , l. , & baker , k. 2007 , apj 662 , 744 .",
    "dobke , b. m. , johston , d. e. , massey , r. et al .",
    "2010 , pasp 122 , 947 .",
    "eisenstein , d. j. et al .",
    "2005 , apj 633 , 560 .",
    "ellerbroek , b. l. 2002 , proceedings of the beyond conventional optics , 229 .",
    "favre , a. , gaviglio , j. , & dumas , r. 1952 , proc , 8th int .",
    "conf . for appl .",
    ", instanbul 304 .",
    "filippenko , a. v. 1982 , pasp 94 , 715    freniere , gregory , & hassler 1999 , spie 3780 .    fried , d. l. 1965 , opt .",
    "soc am , 55 , 1427 .",
    "frigo , m. & johnson , s. g. , proc .",
    "ieee 93 ( 2 ) , 216 .",
    "fryxell , b. et al .",
    "2000 , apjs 131 , 273 .",
    "goodman , j. 2004 , `` introduction to fourier optics '' .",
    "green , a. wagner , j. , mann a. 1988 , appl . opt .",
    "27 , 2266 .",
    "hill , r. j. & clifford , s. f. 1978 , josa , vol .",
    "68 , issue 7 , 892 .",
    "high - resolution transmission molecular absorption database ( hitran ) code 2014 , http://www.cfa.harvard.edu/hitran .",
    "hoeg , e. et al .",
    "2000 , a&a 355 , l27 .",
    "ivezic , z. et al .",
    "2008 , astro - ph/0805.2366 .",
    "ivezic , z. et al .",
    "2007 , aj 134 , 3 , 973 .",
    "jolissaint , l. 2010 , jeos vol 5 .",
    "king , i. , pasp , 79 , 226 .",
    "kotov , i. et al .",
    "2007 , nuc .",
    "instr . & meth .",
    "res . a , 568 , 41 - 45 .",
    "kolmogorov , a. m. 1941 ( in tikhomirov , v. m. selected works of a. n. kolmogorov ) .",
    "krisciunas & shaefer 1991 , pasp 103 , 1033 .",
    "lane , r. g. , glindemann , a , & dainty , j. c. 2002 , waves in random media , vol .",
    "2 , issue 3 .",
    "le louarn , m. 2002 , proceedings of beyond conventional optics , 217 .",
    "liou , k. n. , `` introduction to atmospheric radiation '' , san diego : academic p , 2002 .",
    "lsst reference design document , http://lsst.org/files/docs/lsst-refdesign.pdf    lucke , r. l. & c. y. young 2007 , ap opt vol .",
    "46 no . 4 , 559 .",
    "mahrt , l. 2010 , appl .",
    "meterology & climatology , v. 50 , 144 .",
    "martinez , p. , kolb , j. tokovinin , a. , & sarazin , m. 2010 , a&a 516 , a90 .",
    "mandelbaum , r. , hirata , c. m. , leauthaud , a. , massey , r. j. , & rhodes , j. , mnras 420 , 1518 .    metropolis & ulam , 1949 , jasa 44 , 335 - 341 .",
    "monet , d. et al .",
    "2003 , aj 125 , 984 .",
    "patat . , f. , ugolnikov . , o. s. , & postylyakov , o. v. 2006 , a&a 455 , 385 .",
    "pence , w. , in asp conf .",
    "172 , adas & s viii , ed .",
    "mehringer , plante , roberts ( sf : asp ) , 487 .",
    "perlutter , s. et al .",
    "1999 , apj 517 , 565 .",
    "peterson , j. r. , jernigan , j. g. , kahn , s. m. 2004 , apj 615 , 545 .",
    "peterson , j. r. , marshall , p. j. , andersson , k. a. 2007 , apj 655 , 109 .",
    "phillip & taft 1960 .",
    "poyneer , van dam l. , veran , j. 2009 , josa a , vol .",
    "26 , issue 4 , pp .",
    "833 - 846 .",
    "racine , r. 1996 , pasp 108 , 699 .",
    "rajakan , k. sing , r. , shechun j. , solid state electronics 22 , 793 .",
    "riess , a. g. et al .",
    "1998 , aj 116 , 1009 .",
    "roddier , f. 1981 , progress in optics 19 , north holland amsterdam .",
    "roddier , f. 1995 , a&ss , 223 , 109 .",
    "rothman , l. s. et al .",
    "2009 , jqsqr 100 , 533 .",
    "rothman , l. s. et al . 2005 , jqsqr 96 , 139 .",
    "rothman , l. s. et al .",
    "2003 , jqsqr 60 , 665 .",
    "rothman , l. s. et al .",
    "1998 , jqsqr 82 , 5 .",
    "rothman , l. s. et al .",
    "1992 , jqsqr 48 , 469 .",
    "rothman , l. s. et al .",
    "1987 , app . opt .",
    "26 , 4058 .",
    "sander , s. p. et al .",
    ", 2006 , chem . kin . & photochemical data for use in atmospheric studies , pasadena jpl pub , 2006 .",
    "sellmeier , 1871 .",
    "srsic , j. l. , 1963 , baaa 6 , 41s .",
    "schmidt , j. d. 2012 ,  numerical simulation of optical wave propagation .",
    "springel , v. 2005 , mnras 364 , 110 .",
    "stone , j. et al .",
    "2008 , apjs 178 , 137 .",
    "tatarski , v. i. 1961 , wavefront propagation in a turbulent medium , dover , new york .",
    "taylor , g. i. 1938 , proc .",
    "soc . , a 165 , 476 .    tokovinin , a. , sarazin , m. , & smette , a. 2007 , mnras 378 , 701 .",
    "thomas & stramnes , radiative transfer in the atmosphere and ocean , cambridge : cambridge up , 1999 .",
    "tokovinin , a. & travouillon , t. 2006 , mnras 365 , 1235 .",
    "tyson , j. a. , wenk , r. a. , & valdes , f. 1990 , apj 349 , 1 .",
    "ulam , s. , richtmyer , r. d. , von neumann , j. , lams-551 .",
    "ulam , s. , proceedings of the international congress of mathematicians 2 , 264 - 275 .",
    "von karman , t. 1948 , proc .",
    ", 34 , pp .",
    "530 - 539    vorontsov , a. m. , paramonov , p. v , valley , m. t. & vorontsov , m. a. 2008 , waves in random and complex media , vol 18 , no .",
    "zemax code 2014 , http://www.radiantzemax.com/en/zemax/",
    "to determine the statistical error on a source s attributes , we simulated a ellipsoidal gaussian with @xmath139 photons with psf of size , @xmath169 .",
    "we then measured the source s attributes ( fwhm , ellipticity , flux , and centroid ) by a weighted second moment method .",
    "we confirmed the scalings that the statistical error for the photometric flux is @xmath264 , the error on the fwhm is @xmath265 , the error on the centroid is @xmath266 and the error on the psf ellipticity is @xmath267 .",
    "science applications can be done with objects of all brightnesses and therefore values of photons , @xmath139 , but note that for an optical survey most of the interesting new sources will be near the detection threshold .",
    "this occurs when      where @xmath139 is the number of photons from a source in a single frame , @xmath4 is the number of co - added frames , @xmath92 is the effective number of pixels the source is distributed over , @xmath56 is the background rate per pixel per frame , and @xmath269 is the source signal to noise .",
    "generically , @xmath92 is around @xmath250 to sample the psf but not reduce sensitivity , @xmath56 is in the range from 10 to @xmath270 to be sky - noise limited but not limit the dynamic range of a ccd up to the full well depth ( typically @xmath271 with modern devices ) , and a reasonable detection threshold would have @xmath269 of 10 .",
    "therefore , @xmath139 would typically be between @xmath272 and @xmath273 for a source at the survey s detection threshold . conservatively ,",
    "if we consider sources an order of magnitude brighter than the detection threshold , then the brightest new source in a survey would then have around @xmath274 counts in a single exposure or @xmath275 counts in the co - added exposures . for seeing of 0.5",
    " , the statistical uncertainty of the object s attributes in a single exposure would have a photometric error of @xmath250 millimags , a fwhm of @xmath251 milliarcseconds , a centroid error of @xmath252 milliarcseconds , and an ellipticity error of 1.4% .",
    "therefore , a reasonable set of requirements for the accuracy of an optical survey simulator is that any known calculational inaccuracy is below several millimags of photometric error , several milliarcseconds of fwhm and centroid error , and percent - level ellipticity error",
    ". this would be sufficient to not add a significant systematic simulation error on an object s attribute for a source with less than @xmath163 photons in a single exposure or @xmath163 combined photons in a co - added exposure . in most cases , the simulation error would not occur in the same way in a series of simulated exposures so the single epoch requirement would be sufficient , but if it did , the error would , for example , result in a factor of 10 stricter requirements for 100 frames . in either case",
    ", the scalings in this appendix can be used to estimate the errors on a given object that is the study of a science case ."
  ],
  "abstract_text": [
    "<S> we present a comprehensive methodology for the simulation of astronomical images from optical survey telescopes . </S>",
    "<S> we use a photon monte carlo approach to construct images by sampling photons from models of astronomical source populations , and then simulating those photons through the system as they interact with the atmosphere , telescope , and camera . </S>",
    "<S> we demonstrate that all physical effects for optical light that determine the shapes , locations , and brightnesses of individual stars and galaxies can be accurately represented in this formalism . by using large scale grid computing , modern processors , and an efficient implementation that can produce 400,000 photons / second </S>",
    "<S> , we demonstrate that even very large optical surveys can be now be simulated . </S>",
    "<S> we demonstrate that we are able to : 1 ) construct kilometer scale phase screens necessary for wide - field telescopes , 2 ) reproduce atmospheric point - spread - function moments using a fast novel hybrid geometric / fourier technique for non - diffraction limited telescopes , 3 ) accurately reproduce the expected spot diagrams for complex aspheric optical designs , and 4 ) recover system effective area predicted from analytic photometry integrals . </S>",
    "<S> this new code , the photon simulator ( _ phosim _ ) , is publicly available . </S>",
    "<S> we have implemented the large synoptic survey telescope ( lsst ) design , and it can be extended to other telescopes . </S>",
    "<S> we expect that because of the comprehensive physics implemented in phosim , it will be used by the community to plan future observations , interpret detailed existing observations , and quantify systematics related to various astronomical measurements . </S>",
    "<S> future development and validation by comparisons with real data will continue to improve the fidelity and usability of the code .    </S>",
    "<S> = 1 </S>"
  ]
}