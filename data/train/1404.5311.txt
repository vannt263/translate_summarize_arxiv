{
  "article_text": [
    "in the standard @xmath1 cold dark matter ( @xmath1cdm ) cosmology , the first stars are expected to form at redshifts @xmath2 in dark matter ( dm ) ` minihaloes ' with masses @xmath3 ( for recent reviews , see * ? ? ? * ; * ? ? ? * ) .",
    "the primordial gas synthesized in the big bang accretes on to these haloes and heats to the virial temperature of @xmath4 . at the centre of the halo , molecular hydrogen ( h@xmath0 ) forms via associative detachment of neutral hydrogen with negatively charged hydrogen ( h@xmath5 ) , which in turn forms via radiative association of neutral hydrogen with free electrons left over after recombination @xcite .",
    "the internal ro - vibrational transitions of h@xmath0 are excited by collisions with other species , and their decay produce cooling radiation that facilitates the further collapse of the gas .",
    "detailed three - dimensional simulations of primordial star formation have shown that the onset of h@xmath0 cooling in sufficiently massive haloes results in runaway collapse to a density of @xmath6 , where @xmath7 denotes the volumetric number density of hydrogen nuclei , and @xmath8 is the critical density at which the ro - vibrational levels of h@xmath0 become populated according to local thermal equilibrium ( lte ; * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "the gas cools to a minimum temperature of @xmath9 , which is set by the change in the scaling of the cooling rate from @xmath10 to @xmath11 for @xmath12 , and the microphysics of the h@xmath0 molecule .",
    "the collapse rate decreases and the cloud ` loiters ' at this density and temperature until it has accreted a jeans mass of @xmath13 .",
    "the cloud then decouples from the dm potential and begins to collapse under its own gravity . at densities @xmath14 ,",
    "the h@xmath0 fraction rapidly increases due to three - body reactions @xcite , and the rapidly increasing cooling rate may trigger a chemothermal instability that results in subfragmentation of the cloud @xcite . at densities",
    "@xmath15 , the stability of the cloud is restored due to the increasing optical depth of the gas to h@xmath0 line emission @xcite .",
    "the second radiative coolant that becomes important is collision - induced emission , which operates at densities @xmath16 @xcite .",
    "finally , chemical cooling due to the dissociation of h@xmath0 molecules precedes the near - adiabatic evolution of the gas at the highest densities @xcite .",
    "one of the most important transitions that occurs during the initial collapse phase is the transition from optically thin to optically thick h@xmath0 line cooling .",
    "previous studies have shown that the chemical and thermal evolution of the gas at high densities depend sensitively on how rapid this transition occurs @xcite .",
    "however , an accurate solution requires the hydrodynamic evolution of the gas to be solved alongside the multifrequency radiative transfer of h@xmath0 line emission .",
    "this has so far only been possible in one - dimensional calculations @xcite . in three - dimensional simulations ,",
    "the computational cost associated with the integration of the six - dimensional photon distribution function is prohibitively expensive .",
    "previous studies have therefore resorted to the escape probability formalism , where the optically thin cooling rate is multiplied by an escape fraction that models the probability of a photon to escape from the cloud .",
    "the escape fraction is usually derived from local properties of the gas . in @xcite , a density - dependent fit for the escape",
    "fraction was obtained from the detailed one - dimensional calculations of @xcite .",
    "this method was used in @xcite .",
    "other studies assumed that the velocity gradient in the central , jeans - unstable cloud allows the radiation to escape relatively easily , and used the @xcite method to obtain the escape fraction ( e.g. * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "the sobolev method has been traditionally applied to stellar atmospheres and molecular clouds @xcite , and is valid if the scale on which the velocity varies is much smaller than the scale on which other properties of the gas vary .",
    "in particular , it is not well suited to treat turbulent gas clouds @xcite . nevertheless , the results obtained with the sobolev method in three - dimensional simulations agree relatively well with those of the fitting function of @xcite , even though is not clear how accurate both methods really are @xcite .",
    "we here address this issue by performing the first three - dimensional simulations of primordial star formation that include multifrequency radiative transfer for optically thick h@xmath0 line emission . in section  [ sec_chem ]",
    ", we present a new primordial chemistry and cooling network implemented in arepo , and in section  [ sec_rad ] describe the ray - tracing scheme used to compute the radiative transfer . in section  [ sec_sim ] , we describe the set - up of the simulations , and in section  [ sec_res ] present our results .",
    "finally , in section  [ sec_sum ] we summarize and draw conclusions .",
    "all distances are quoted in proper units , unless noted otherwise .",
    "one of the most important ingredients of primordial star formation simulations is a comprehensive chemistry and cooling network .",
    "we here describe a new solver implemented in arepo that combines a non - equilibrium solver for low densities with an equilibrium solver for high densities .",
    "this tiered approach allows us to seamlessly model the extremely large dynamic range of more than @xmath17 orders of magnitude in density that builds up in self - gravitating , primordial gas clouds .",
    "we use an operator - split approach to solve for the coupled evolution of the chemical abundances and internal energy of the gas , represented by a system of first - order differential equations : @xmath18 where @xmath19 denotes the chemical species and internal energy , @xmath20 is a function that incorporates the rate equations , and @xmath21 denotes the time .",
    "the time dependency implicitly includes all external dependencies , such as on density and redshift . for a given hydrodynamic time step @xmath22 ,",
    "the above differential equation is integrated using the publicly available solver sundials cvode , which employs a variable order , variable step multistep backward differencing scheme @xcite .",
    "we model three independent chemical species : h@xmath5 , h@xmath0 , and h@xmath23 .",
    "the abundance of h@xmath5 may be trivially derived from that of h@xmath23 , such that only the abundances of h@xmath0 and h@xmath23 are included in @xmath19 .",
    "the electron abundance is trivially given by @xmath24 , and that of neutral hydrogen by @xmath25 , where @xmath26 denotes the ratio of the number density of chemical species @xmath27 to the number density of hydrogen nuclei .",
    "the latter is given by @xmath28 , where @xmath29 is the cosmological mass fraction of hydrogen , @xmath30 the volumetric mass density , and @xmath31 the mass of the hydrogen atom .",
    "since reactions involving helium are comparatively unimportant at the densities and temperatures modelled here , we assume that it remains chemically inert and is in the ground electronic state . because of the tight coupling of some of the chemical rates to the internal energy , a relative accuracy of @xmath32 is necessary to avoid significant spurious oscillations .",
    "below @xmath33 , the chemical species are no longer evolved accurately , which avoids an unnecessary computational overhead .",
    "[ cols=\"<,<,<,<,<\",options=\"header \" , ]      the chemical and thermal processes included in our reaction network are shown in table  1 , together with the corresponding rate coefficients and references . to enable fast look - up",
    ", the rates are linearly interpolated from a table with @xmath34 logarithmically spaced temperature bins between @xmath35 and @xmath36 . because of the comparatively large reaction rates , we assume that h@xmath5 is in chemical equilibrium : @xmath37 where @xmath38 denotes the rate coefficient for the formation of h@xmath5 via radiative association of hi and free electrons , and @xmath39 the rate coefficient for the destruction of h@xmath5 by associative detachment with hi . the latter reaction results in the formation of h@xmath0 .",
    "molecular hydrogen may also be formed by three - body reactions involving three hydrogen atoms or two hydrogen atoms and one hydrogen molecule , while it is destroyed by collisions with hydrogen atoms and molecules , as well as radiation in the lyman ",
    "werner ( lw ) bands : @xmath40 where @xmath41 denotes the specific intensity in the lw bands in units of @xmath42 .",
    "we use the recently updated rate coefficients for associative detachment and three - body h@xmath0 formation of @xcite and @xcite , respectively .",
    "the shielding factor for incident lw radiation is given by @xmath43},\\notag\\end{aligned}\\ ] ] where @xmath44 , @xmath45 is the effective h@xmath0 column density ( see section  [ sec_sob ] ) , @xmath46 , and @xmath47 the thermal velocity of the h@xmath0 molecules : @xmath48 here , @xmath49 denotes the mass of the h@xmath0 molecule , @xmath50 boltzmann s constant , and @xmath51 the temperature of the gas @xcite .",
    "the collisional dissociation rates are obtained from the three - body formation rates by applying the principle of detailed balance : @xmath52 where @xmath53 is the equilibrium constant : @xmath54 and @xmath55 denotes planck s constant , @xmath56 the binding energy of h@xmath0 , and @xmath57 and @xmath58 the partition functions of atomic and molecular hydrogen , respectively : @xmath59 where @xmath60 is the degeneracy of state @xmath61 with energy @xmath62 . in the case of atomic hydrogen , @xmath63 , @xmath64 , and @xmath65",
    "denote the ionization energy of atomic hydrogen , and the sum is truncated at @xmath66 . in the case of h@xmath0 , only the ro - vibrational transitions of the electronic ground state are modelled , such that @xmath67 , where @xmath68 denotes the rotational quantum number . the energy levels are taken from @xcite , using vibrational quantum numbers @xmath69 and rotational quantum numbers @xmath70 , which is sufficient for the regime in which h@xmath0 cooling is important .",
    "the formation and destruction of ionized hydrogen is governed by collisional ionization with electrons and the inverse process , recombinations .",
    "the recombination rate at high densities is obtained by applying the principle of detailed balance to the collisional ionization rate of @xcite : @xmath71 where @xmath72 and @xmath73 is the mass of the electron . at low densities ,",
    "the case b recombination rate of @xcite is used , which includes recombinations to all levels except the ground state .",
    "the two regimes are smoothly adjoined by a transition function , such that the net h@xmath23 formation rate is given by @xmath74 where @xmath75 and @xmath76 .",
    "this ensures that the h@xmath23 abundance approaches the thermal equilibrium abundance at high densities , since we do not include the inverse reactions for recombinations to all hydrogen levels ( reaction  9 in table  1 ) .      the rate of change of the volumetric internal energy density @xmath77 is given by @xmath78 where @xmath79 denotes heating due to chemical processes , and @xmath80 cooling due to radiative processes .",
    "we only include the chemical heating and cooling of the gas due to the formation and destruction of h@xmath0 , since significant amounts of h@xmath23 are formed only at very high densities , where the abundances become inaccurate due to various non - ideal gas effects @xcite .",
    "the chemical heating rate may therefore be conveniently written as @xmath81 the radiative cooling rate is given by @xmath82 and includes h@xmath0 line cooling , h@xmath0 collision - induced emission , ly@xmath83 cooling , and inverse compton scattering of electrons with cosmic microwave background ( cmb ) photons .",
    "the h@xmath0 line cooling rate is discussed in detail in section  [ sec_line ] .",
    "the cooling rate due to collision - induced emission is given by @xmath84 where @xmath85 and the escape fraction are taken from @xcite .",
    "the latter is given by @xmath86 where @xmath87 and @xmath88 .",
    "the ly@xmath83 cooling rate is given by : @xmath89 where @xmath90 is taken from @xcite , and @xmath91 the latter approximately reproduces the temperature  density relation found in the one - zone models of @xcite .",
    "finally , the ic cooling rate is given by @xmath92 where @xmath93 is taken from @xcite .",
    "the h@xmath0 line cooling rate is obtained by adjoining the rate in the limit @xmath94 with the lte rate @xcite : @xmath95 in the above equation , the low - density rate is given by @xmath96 where @xmath97 is taken from @xcite . if the gas is optically thin , the cooling rate may be calculated directly from the einstein coefficients corresponding to the individual ro - vibrational transitions of h@xmath0 : @xmath98 where @xmath99 denotes the energy emitted by the transition from the upper state u to the lower state l , @xmath100 the einstein coefficient , and @xmath101 the number density of h@xmath0 molecules in the upper state .",
    "the einstein coefficients are taken from @xcite .",
    "the relative numbers of h@xmath0 molecules in the upper and lower states are given by @xmath102 this allows the cooling rate per h@xmath0 molecule to be tabulated as a function of temperature : @xmath103      @xcite assumed that the optically thick cooling rate can be obtained from the optically thin cooling rate via @xmath104 where @xmath105 for @xmath106 and @xmath107 for @xmath108 .",
    "the parameter @xmath109 is given by @xmath110 where @xmath111 and @xmath112 .",
    "this formula reproduces the slope of the fit to the detailed one - dimensional calculations of @xcite , but has the advantage of a continuous derivative at @xmath113 .",
    "@xcite were the first to use the sobolev method to model optically thick h@xmath0 line transfer in primordial gas clouds .",
    "they computed the escape fraction for each individual transition : @xmath114 where @xmath115 and @xmath116 here , @xmath117 denotes the cross - section for the transition @xmath118 , and @xmath119 the sobolev length .",
    "the cross - section corrected for stimulated emission is given by @xmath120\\phi_{\\rm ul},\\ ] ] where @xmath121 denotes the speed of light , and @xmath122 is the line profile for thermal doppler broadening : @xmath123}.\\ ] ] in the above equation , @xmath124 denotes the frequency , @xmath125 , and @xmath126 is the thermal doppler broadening parameter : @xmath127 unless noted otherwise , terms involving the cross - section are evaluated at the centre of the line .",
    "@xcite computed the sobolev length and escape fraction along the principal axes of the computational domain , and averaged the escape fractions along the different directions to obtain the overall escape fraction .",
    "we here follow @xcite and compute the sobolev length as @xmath128 where @xmath129 is the velocity of the gas , and @xmath130 the jeans length .",
    "the limiter in the above equation ensures that the sobolev length remains smaller than the jeans length if the divergence of the velocity is small . to speed up the computation of the optically thick cooling rate ,",
    "we follow @xcite and write equation  [ eq_tau_ul ] as @xmath131 where @xmath132 is the effective h@xmath0 column density : @xmath133 the optically thick cooling rate can thus be tabulated as a function of temperature and column density . for the latter , we use",
    "@xmath134 logarithmically spaced bins between @xmath135 and @xmath136 .",
    "finally , the frequency - dependent radiative transfer of h@xmath0 line emission may be computed accurately and self - consistently with the ray - tracing method described in section  [ sec_rad ] . for computational efficiency , the cooling rate per h@xmath0 molecule due to each transition is tabulated as a function of temperature : @xmath137 we also tabulate the effective cross - section : @xmath138 and the level - averaged cross - section : @xmath139 these are used to compute the attenuation of the radiation .      the pressure , temperature , and internal energy density of the gas are related via @xmath140 where @xmath141 and @xmath142 denote the mean molecular weight and adiabatic index of the gas , respectively .",
    "the latter is given by @xmath143 where the sum extends over all chemical species .",
    "in our case , the adiabatic index is given by @xmath144 where @xmath145 and @xmath146 .",
    "the adiabatic index for a monatomic gas is given by @xmath147 , and for h@xmath0 by @xmath148 where @xmath149 .",
    "the second term in this equation accounts for the vibrational degrees of freedom of h@xmath0 @xcite .",
    "in analogy to the adiabatic index , the mean molecular weight of the gas is given by @xmath150 where @xmath151 denotes the particle mass of species @xmath61 . here , this simplifies to @xmath152      once the density exceeds @xmath153 , the h@xmath0 abundance may be safely assumed to be in thermal equilibrium @xcite .",
    "this simplifies the chemistry , since updating the h@xmath0 abundance only requires the solution of an implicit equation instead of a coupled differential equation . for a new internal energy ,",
    "the updated h@xmath0 abundance must be consistent with the chemical heating and cooling of the gas due to the formation and dissociation of h@xmath0 : @xmath154 where @xmath155 and @xmath156 are the internal energy density and h@xmath0 abundance at the beginning of the time step . according to equation  [ eq_eq_h2 ] ,",
    "the h@xmath0 abundance is related to the temperature via @xmath157 which is solved with a bisection method that uses @xmath158 as an initial guess for the internal energy . here",
    ", @xmath159 , @xmath160 , and @xmath161 gives robust minimum and maximum values .",
    "for each new guess of the internal energy , the adiabatic index , mean molecular weight , and temperature are updated using the h@xmath0 fraction at the beginning of the time step .",
    "this does not result in a substantial error , since the adiabatic index and mean molecular weight do not change much over a single time step .",
    "the updated temperature is used to compute the equilibrium constant @xmath53 , which is then used to solve the above equation .",
    "the physically meaningful solution is the negative branch of @xmath162 where the coefficients are given by @xmath163 a subtle problem arises if @xmath164 is much smaller than @xmath165 . in this case",
    ", @xmath166 may be truncated due to rounding errors , which results in @xmath167 and @xmath168 .",
    "this unphysical solution is avoided by a taylor expansion of @xmath166 around @xmath169 : @xmath170 for @xmath171 , the h@xmath0 abundance is therefore given by @xmath172 where we have exploited the fact that @xmath173 .",
    "once the new h@xmath0 abundance has been obtained , the new internal energy density is used as a solution if @xmath174 .",
    "this comparatively high accuracy is necessary to obtain a self - consistent solution at the very high densities and temperatures within metal - free protostars .",
    "after the equilibrium step is completed , the non - equilibrium solver is used to update the h@xmath23 abundance as well as the internal energy density , which is subject to radiative cooling . the equilibrium and non - equilibrium steps",
    "are subcycled on a time step : @xmath175 where we have found that @xmath176 suppresses visible fluctuations .    for @xmath177",
    ", the h@xmath23 abundance also converges to the thermal equilibrium value @xcite . as opposed to h@xmath0",
    ", we do not account for the chemical heating and cooling of the gas due to changes in the h@xmath23 abundance .",
    "a further simplification arises due to the fact that the h@xmath0 abundance generally decreases to well below unity as the h@xmath23 abundance increases to unity .",
    "the resulting equation is therefore comparatively simple : @xmath178 the root of this equation is found using the same bisection method as for the h@xmath0 abundance , but with @xmath179 .",
    "since the h@xmath0 abundance may depend sensitively on the h@xmath23 abundance , the latter is updated first .",
    "we investigate the accuracy and reliability of the chemistry network with an idealized dynamical model for self - gravitating , primordial gas clouds .",
    "we assume that the clouds are uniform , spherically symmetric , and collapse at the free - fall rate . in this case , the density increases according to @xmath180 where @xmath181 denotes the free - fall time : @xmath182 and @xmath183 is the gravitational constant .",
    "the internal energy density evolves according to @xmath184 where the first term denotes the adiabatic heating rate due to the collapse of the cloud , and the second term the net cooling rate due to all other processes .",
    "the clouds are set up with an initial temperature of @xmath185 at @xmath186 , a redshift of @xmath17 , and initial abundances @xmath187 and @xmath188 .",
    "these abundances are also used in the full three - dimensional simulations .",
    "the effective h@xmath0 column density is obtained using the jeans length instead of the sobolev length .    in fig .",
    "[ fig_chem ] , we show the evolution of the cloud when h@xmath0 cooling operates ( solid line ) , and when it is suppressed up to the critical density @xmath189 by a lw background with a strength of @xmath190 ( dotted line ) .",
    "the former case represents the collapse of the gas in a minihalo with @xmath191 , and the latter in an atomic cooling halo with @xmath192 .",
    "the resulting temperature and abundance profiles agree well with those found in previous studies ( e.g. * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "* ) . in the minihalo ,",
    "the characteristic drop in temperature to @xmath9 at @xmath193 is followed by a gradual increase to @xmath194 over many orders of magnitude in density . in the atomic cooling halo ,",
    "the gas remains nearly isothermal with @xmath195 up to a density of @xmath196 , where the gas becomes optically thick to continuum radiation .",
    "abundance , h@xmath0 abundance , and h@xmath23 abundance versus density in a simple one - zone dynamical collapse model .",
    "the solid line represents a minihalo , and the dotted line an atomic cooling halo , where h@xmath0 cooling is suppressed by a lw background .",
    "the profiles agree well with more detailed studies ( e.g. * ? ? ?",
    "* ; * ? ? ?",
    "* ) .,width=302 ]",
    "we here present a new multiline , multifrequency ray - tracing scheme that is capable of solving the static radiative transfer equation for point sources as well as diffuse emission .",
    "we describe the methodology and its application to h@xmath0 line transfer in primordial gas clouds , and show the results of a few idealized test simulations that demonstrate the accuracy and numerical convergence of the method .",
    "similar to the euler equations for a fluid consisting of massive particles , the radiative transfer equation for an ensemble of photons may be derived rigorously from the boltzmann equation .",
    "the photon distribution function @xmath197 is a function of position @xmath198 and momentum @xmath199 , and evolves according to @xmath200 where the term on the right - hand side denotes the change in @xmath197 due to the creation , destruction , or re - distribution ( scattering ) of photons by interactions with other particles .",
    "the left - hand side of this equation may be expanded to : @xmath201 where @xmath202 denotes the scale factor , and @xmath203 the normalized propagation direction of the photons .",
    "if relativistic effects are ignored , then @xmath204 and @xmath205 , such that @xmath206 this is the classical radiative transfer equation in terms of the photon distribution function . assuming that the interaction term varies on time - scales significantly larger than the light - crossing time , the time - dependent term on the left - hand side of the equation may be omitted , which yields @xmath207 if the gradient of the photon distribution function is projected along the propagation direction , the well - known ray - tracing equation is obtained : @xmath208 where @xmath209 is the spatial coordinate along the ray . for pure absorption , this simplifies to @xmath210 where @xmath211 is the absorption coefficient .",
    "this equation is trivially solved by @xmath212 where @xmath213 is the initial photon distribution function , and @xmath214 since photon numbers are conserved , equation  [ eq_fgamma ] may also be written as @xmath215 where @xmath216 is the number of photons in a given ray and frequency range .",
    "similar to the cooling or heating of the gas due to chemical processes , the heating of the gas due to radiation is modelled by an additional source term in the energy equation of the euler equations .",
    "we use an operator - split approach , such that the radiative heating rate is obtained from a ray - tracing step that succeeds the hydrodynamic step .",
    "since a complete voronoi tessellation of the computational domain is necessary to ensure that the neighbour lists that are used in the ray walk are complete , all cells must be evolved on the same time step .",
    "point sources may be initialized from a pre - defined list of points or the positions of individual cells . for diffuse radiation ,",
    "a fraction @xmath217 of all cells in the computational domain become sources . for each source",
    ", @xmath218 rays are cast using the healpix algorithm to find their position on the unit sphere , where @xmath219 is the initial healpix level @xcite .",
    "the rays from each source are then rotated using a random sample of the euler angles . for monochromatic radiation with a frequency @xmath124 ,",
    "the initial photon numbers are given by @xmath220 where @xmath221 is the source luminosity .",
    "the structure holding the ray data is stored on the mpi task associated with the ray .",
    "the corresponding task is found by using the mesh - generating point that is closest to the initial position of the ray .",
    "after the rays have been initialized , they are traversed until they reach the edge of the local computational domain .",
    "a global communication step then distributes the rays to their new domains , where the ray walk is continued .",
    "individual rays may be terminated once they reach the edge of the computational domain , or @xmath216 falls below @xmath222 , where @xmath223 may be set to a non - zero value in order to reduce the computational cost of the ray tracing .",
    "the traversal of the rays exploits a dynamically updated neighbour list , which for a given cell contains the indices of all neighbouring cells . in two dimensions , the next cell along a ray",
    "is found by locating the voronoi edge that it crosses .",
    "this is done by computing the intersections of the voronoi edges with the ray , and using the intersection that has the smallest distance to the starting point of the ray ( see fig .",
    "[ fig_vor ] ) . in three dimensions ,",
    "the intersections with the voronoi faces are instead computed .",
    "the distance @xmath224 to the next cell is returned and used for the computation of the optical depth .",
    "this step involves only a few arithmetic operations , and is therefore relatively inexpensive @xcite . as the rays are walked , the photon numbers are updated according to : @xmath225 where @xmath61 denotes the current cell , and @xmath226 .",
    "the heating rate of the cell due to the absorption of @xmath227 photons of energy @xmath228 is given by @xmath229 where @xmath230 is the volume of the cell .",
    "the scheme may also be used for multiline , multifrequency radiation transport . in this case , the number of photons in each ray is distributed to @xmath231 bins , and the absorption coefficient becomes a function of line and frequency .",
    "next to a constant angular resolution , the scheme also allows for spatially adaptive splitting of rays by exploiting the recursive nature of the healpix algorithm @xcite .",
    "the parameter @xmath232 controls the average number of rays per cell by comparing the opening angle associated with a ray , @xmath233 , where @xmath209 is the distance from the source , to an estimate of the cell area , @xmath234 , where @xmath235 relates the approximate size of a cell to its volume : @xmath236 .",
    "a parent ray is split into four child rays if @xmath237 , in which case the photons are distributed evenly among the new rays .",
    "the scheme also includes a tool for logging and storing the absorption profiles of a selection of rays using a list of unique ray ids .",
    "in addition , the photon escape fraction for each source is computed and stored in the simulation output .      for h@xmath0 line transfer , the relevant emissivities and cross - sections must be included .",
    "since the line widths are much smaller than the separation of the individual lines in frequency space , they may be treated independently .",
    "the emission rate per h@xmath0 molecule in each line is given by equation  [ eq_eps_h2 ] .",
    "the initial number of photons in cell @xmath61 due to the transition @xmath118 is therefore given by @xmath238 in the clouds considered here , the dominant broadening mechanism is thermal doppler broadening .",
    "the number of photons in each line is distributed to @xmath239 frequency bins with a maximum displacement of @xmath240 around @xmath241 , where @xmath242 is the doppler width of the emitting cell ( given by equation  [ eq_nud ] ) , and @xmath243 yields sufficient accuracy .",
    "the positions of the frequency bins , denoted by the index @xmath244 , are given by @xmath245 where @xmath246 finally , the number of photons in each bin is given by @xmath247 where @xmath248 and @xmath249 is a normalization constant : @xmath250    the frequency - dependent cross - section is given by equation  [ eq_cross ] , with the exception that the frequency in the frame of the cell under consideration is shifted with respect to @xmath251 : @xmath252 where @xmath253 is the relative velocity between cell @xmath61 and the source cell projected along the ray .",
    "based on the positions of the frequency bins , the cross - section may be written as @xmath254 where @xmath255 this equation may be simplified to @xmath256 where @xmath257 . the term @xmath258 may be omitted , since it is much smaller than the other terms for @xmath259 .",
    "the cross - section may differ from the original cross - section due to variations in the thermal doppler width and the relative velocity of the cells along the rays .",
    "the first effect is symmetric around @xmath241 , while the second may cause a shift in the peak of the cross - section to lower or higher frequencies . taken together , the optical depth for a given cell , line , and frequency may be written as @xmath260 where @xmath261 is given by equation  [ eq_cross_eff ] and is tabulated as a function of temperature , and @xmath262 is trivially computed from the tabulated @xmath263 , the square root of the ratio of the doppler broadening parameters , and the relative velocity .",
    "this minimizes the computational overhead for the @xmath264 computations of the optical depth per cell .",
    "if not all transitions for the h@xmath0 energy levels described in section  [ sec_chem ] are used , the specific cooling rates and cross - sections are tabulated only for the most luminous @xmath265 lines within each temperature bin . as a result",
    ", each cell emanates a different set of lines , and the cross - sections must be adjusted accordingly .",
    "this may substantially reduce the computational cost of the ray tracing , while only slightly reducing its accuracy .",
    "for example , the simulation described in section  [ sec_sim ] uses only @xmath266 lines , which results in an accuracy of @xmath267 per cent , but reduces the number of opacity calculations and the memory required for the storage of the rays by nearly an order of magnitude .      on a modern computing core ,",
    "the ray tracing is able to walk approximately one million cells per second .",
    "if more than one opacity bin per cell is used , the performance is approximately reduced by @xmath268 , where @xmath269 . assuming optimal parallelization and no communication cost , the wall - clock time required to complete the ray walk is approximately given by @xmath270 where @xmath271 is the number of cells walked per second , and @xmath272 the number of cores .",
    "for example , the simulation described in section  [ sec_sim ] uses @xmath273 and @xmath274 , with @xmath275 for this configuration . on 1024 cores ,",
    "a ray - tracing step should therefore take about @xmath276 .",
    "however , this theoretical peak performance neglects the significant computational overhead caused by the communication of the rays .",
    "the memory required to store the energy of the rays in single precision is @xmath277 , which amounts to @xmath278 in the above example . for each communication step , this amount of memory needs to be exchanged between tasks .",
    "we have found that this bottleneck typically reduces the performance by a factor of @xmath279@xmath280 .",
    "another problem is the significant imbalance in the number of rays stored on the tasks .",
    "since the domain decomposition is optimized for spatial proximity , while in centrally concentrated gas configurations most rays propagate from the centre to the edge of the computational domain , a significant imbalance accumulates as the rays are walked . on average ,",
    "the ray numbers differ by a factor of @xmath279@xmath280 , which leads to a similar reduction in performance .",
    "overall , the performance is therefore reduced by a factor of a few compared to the theoretical maximum . since the communication of the rays takes up a large portion of the total computational cost , it is not yet worthwhile to optimize the scheme for use on graphics processing units or coprocessors .",
    "the relatively high performance of the ray walk is achieved by various optimizations .",
    "first , arepo orders the cells in memory based on two nested peano  hilbert curves ,",
    "each consisting of @xmath281 elements per dimension . as the rays are walked , cells that are close to each other in space are therefore also close in memory .",
    "this facilitates a quick look - up of the properties of neighbouring cells .",
    "second , most quantities required for the computation of the optical depth are tabulated . since neighbouring cells have similar opacities , the variables required to compute the opacities are thus likely already stored in the cache .",
    "finally , for simulations run on modern intel cores , the intel compiler generates code that fully exploits the advanced vector extensions ( avx ) instruction set . in this case",
    "up to eight single - precision operations may be performed simultaneously . with these optimizations ,",
    "the calculation of the optical depth in the simulation discussed in section  [ sec_sim ] with @xmath282 opacity bins per cell is only a factor of @xmath283 slower than the case where one bin is used .    in order to reduce the cost of the communication in runs with large core counts",
    ", the ray tracing may be used with a hybrid shared / distributed memory scheme . in this case , the rays are distributed to multiple openmp threads , and each thread processes its own list of rays . since each thread is assigned nearly the same amount of rays , and the average computational cost associated with a ray does not fluctuate by much , the scheme achieves near ideal work balance .",
    "the use of multithreading is particularly advantageous for simulations with comparatively small cell counts per core . in the above example",
    ", the computational cost may be significantly reduced if the simulation is run with four tasks and four threads instead of @xmath284 tasks and one thread per node .",
    "we here use a series of idealized test calculations to investigate the accuracy and convergence of the ray - tracing scheme .",
    "the ray tracing may be run in a distinct mode in which @xmath285 cells are randomly chosen as sources , with luminosities that vary randomly within a pre - defined range .",
    "the attenuation along the rays is modelled with a spatially homogeneous absorption coefficient @xmath83 . in the limit of infinitesimally small volumes ,",
    "the radiative heating rate of cell @xmath61 is given by @xmath286 where the sum extends over all sources indexed by @xmath287 , @xmath288 denotes the luminosities of the sources , and @xmath289 their separation from cell @xmath61 .",
    "we note that the heating rate derived from the absorption of the radiation in the simulations is subject to a small systematic error due to the finite lengths of the cells in the direction of the rays . by varying the resolution of the mesh",
    ", we have verified that in the test cases presented below this error is small compared to the error that arises from the limited angular resolution of the ray tracing .    in the test calculations , we use uniform density boxes with @xmath290 cells .",
    "the mesh - generating points are displaced from a cubical lattice by @xmath291 , where @xmath292 is a random number in the range @xmath293 and @xmath294 is the grid spacing .",
    "the luminosities of the sources are varied by two orders of magnitude , and the absorption coefficient is given by @xmath295 in inverse units of @xmath209 .",
    "we perform a single ray - tracing step without any dynamical evolution , such that all gas properties except the heating rate remain unaffected . in fig .",
    "[ fig_tray_img ] , we show the heating rate averaged along one of the axis of the simulation box for one , @xmath17 , and @xmath296 sources .",
    "the first two cases demonstrate the adaptative resolution of the ray tracing using @xmath297 and @xmath298 , which is typically used for isolated point sources .",
    "the third simulation demonstrates an application to diffuse radiation , where @xmath299 , @xmath300 , and @xmath301 . evidently , the heating rate is isotropic around the individual sources , and shows the expected rapid decay with increasing distance .    a more quantitative analysis of the test calculations is shown in fig .",
    "[ fig_tray_err ] .",
    "the relative error is computed by comparing the analytic heating rate to that obtained with the ray tracing , averaged over all cells in the computational domain .",
    "the solid blue line shows the error as a function of @xmath232 for @xmath17 sources , corresponding to the test case shown in the middle panel of fig .",
    "[ fig_tray_img ] . as the number of rays per cell",
    "is increased , the heating rate converges nearly linearly , with an error of about @xmath302 per cent for @xmath303 .",
    "the other three profiles show the convergence for diffuse radiation , similar to the case shown in the right - hand panel of fig .",
    "[ fig_tray_img ] . in the first case , corresponding to the green dotted line , the angular resolution is varied while the other parameters are kept fixed , with @xmath304 and @xmath305 .",
    "similar to the case where @xmath232 is varied , the heating rate shows approximately linear convergence . however , this is somewhat misleading , since the change in angular resolution between two healpix levels is a factor of @xmath306 , while @xmath232 only varies by a factor of @xmath279 .",
    "the convergence rate is therefore sublinear .",
    "the dashed red line shows the error as a function of the source fraction for @xmath307 and @xmath305 . the error introduced by the fixed angular resolution becomes smaller as the number of sources",
    "is increased , but at a slower rate .",
    "finally , the dot  dashed cyan line shows the error as a function of @xmath223 for @xmath308 and @xmath304 . in this case",
    ", the solution rapidly converges to the @xmath308 case . for large optical depths , using @xmath309 may significantly reduce the computational cost of the simulation , while only slightly degrading the accuracy of the ray tracing . on the other hand , reducing @xmath217 typically results in a large error .",
    "these calculations show that the ray - tracing scheme is capable of reproducing known analytic solutions .",
    "the convergence rate depends on the physical problem under consideration .",
    "it is therefore essential to investigate the dependence of the error on the parameters of the ray tracing , and then choose the parameters such that the desired accuracy is achieved .",
    "for isolated point sources , the relevant parameters are @xmath232 and @xmath223 , while for diffuse radiation they are @xmath219 , @xmath217 , and @xmath223 .",
    "if multiple lines and frequency bins are used , the additional parameters @xmath265 and @xmath239 must be specified .    .",
    "the relative error is computed by comparing the analytic heating rate with that obtained with the ray tracing , averaged over all cells in the computational domain .",
    "the solid blue line shows the error as a function of the number of rays per cell for the test simulation shown in the middle panel of fig .",
    "[ fig_tray_img ] .",
    "the other profiles show the convergence rate for diffuse radiation , corresponding to the panel on the right - hand side of fig.[fig_tray_img ] .",
    "the green dotted line denotes the case where the angular resolution is varied , while the other parameters are kept fixed . in this case",
    ", the error decreases nearly linearly with increasing healpix level .",
    "the dashed red line shows the error as a function of the source fraction @xmath217 , and the dot  dashed cyan line as a function of the ray termination fraction @xmath223 . reducing the source fraction usually results in a large error , while an increased termination fraction may only slightly degrade the accuracy , but substantially reduce the computational cost of the ray tracing.,width=302 ]",
    "we here describe the set - up of the main simulations , which are performed with the moving - mesh code arepo @xcite . because of the very high computational cost of the h@xmath0 line transfer , we perform only one simulation where the ray tracing is fully coupled to the hydrodynamics . for the resolution study and other comparisons , we use the ray tracing as a post - processing tool on the output of the main simulation .      the cosmological parameters used to initialize the simulations are obtained from the cmb measurements by the _ wilkinson microwave anisotropy probe _ @xcite .",
    "these are the matter density @xmath310 , baryon density @xmath311 , hubble parameter @xmath312 , spectral index @xmath313 , and normalization @xmath314 .",
    "the matter power spectrum is evolved forward in time until @xmath315 , after which the zeldovich approximation is used to determine the initial displacements of the dm particles on a cubical lattice .",
    "we use a box with a side length of @xmath316 ( comoving ) , @xmath317 particles of mass @xmath318 , and a gravitational softening length of @xmath319 ( comoving ) , which corresponds to @xmath320 per cent of the initial mean interparticle separation .",
    "the dm simulation is evolved until the first halo grows to a virial mass of @xmath321 , which is evaluated by an on - the - fly friends - of - friends algorithm @xcite .",
    "once the target halo has been found , the simulation is centred on the halo and reinitialized with higher resolution .",
    "the dm particles in the target halo as well as a sufficiently large boundary region around it are traced back to their initial positions , which yield the lagrangian volume out of which the halo formed . in this region , each low - resolution particle is replaced by @xmath322 high - resolution particles , and augmented with additional small - scale power .",
    "gas cells are placed next to the dm particles , and the relative displacements are set to half of the initial mean interparticle separation , using a mass ratio @xmath323 . outside of the target region ,",
    "the resolution is decreased by factors of @xmath324 down to an effective resolution of @xmath325 , subject to the constraint that the accuracy of the gravitational tidal field around the halo is preserved .",
    "the dm particle and gas cell masses in the high - resolution region are @xmath326 and @xmath327 , respectively , and the gravitational softening length is @xmath328 ( comoving ) . the cosmological resimulations are evolved to a density of @xmath329 , where the maximum dynamic range that can be simulated efficiently is reached @xcite .",
    "the central @xmath330 of the box is cut out and reinitialized using inflow / outflow boundary conditions , and evolved to a density of @xmath331 .",
    "following @xcite , cells are refined if @xmath332 , where @xmath333 is the desired number of cells per jeans length , and @xmath334 is the jeans length evaluated at @xmath185 : @xmath335 to ensure an adequate resolution of the turbulent cascade , we use @xmath266 cells per jeans length . for this choice",
    ", the number of cells increases to @xmath336 at @xmath331 .",
    "using an even higher resolution would increase the computational cost of the ray tracing to a level where it is no longer possible to maintain the desired accuracy .",
    "next to the jeans refinement , we also refine cells if their mass increases to more than twice their initial mass .      in the resimulations , we use three different prescriptions for the optically thick h@xmath0 line cooling rate . in the first case , denoted by mh - fit , the density - dependent fitting function discussed in section  [ sec_fit ] is used . in the second case , denoted by mh - sob",
    ", we use the sobolev method described in section  [ sec_sob ] .",
    "finally , in mh - ray we use the ray - tracing scheme described in sections  [ sec_ray ] and [ sec_rad ] .",
    "since a relatively small courant factor of @xmath337 must be used for numerical stability of the hydrodynamic solver , the ray tracing is performed only every fifth time step .",
    "the simulations are run on nodes with two intel sandy bridge processors that have eight cores each , and @xmath338 of memory .",
    "for mh - fit and mh - sob , @xmath284 nodes with @xmath284 mpi tasks per node are used , while for mh - ray @xmath339 nodes with four tasks and four threads per node are used .",
    "the computational cost of the simulation is dominated by the ray tracing , which takes about @xmath340 for each step .",
    "since approximately @xmath296 time steps are necessary to evolve the simulations to a density of @xmath341 , the total wall - clock time is @xmath342@xmath279 months , which is equivalent to about one million cpu hours .",
    "we here present the resolution study that is used to gauge the parameters of the ray tracing , followed by a discussion of the results of the simulations .",
    "the parameters required to obtain the desired accuracy in the heating rate may be gauged with the resolution study shown in fig .",
    "[ fig_mh_err ] .",
    "the error is determined by comparing the heating rate for a certain parameter choice to the case where the parameter under consideration is set to the most accurate value .",
    "all other parameters are set to their default values .",
    "the calculations are performed using the final snapshot of mh - ray , and include gas at all densities relevant for optically thick h@xmath0 line emission . as opposed to the test calculations in section  [ sec_test ] ,",
    "the correct solution is not known .",
    "the true error may therefore be somewhat larger than that shown in fig .",
    "[ fig_mh_err ] . however , in almost all cases the error decreases at a nearly constant rate , which indicates convergence . assuming the errors associated with the variation of the individual parameters are uncorrelated , the total error is equal to the sum of the individual errors .",
    "the angular resolution is varied by increasing @xmath219 from @xmath343 to @xmath306 .",
    "we choose @xmath307 as the default value , since this yields an error of approximately @xmath279 per cent .",
    "the source fraction is varied between @xmath344 and 1 . however , since the resulting error is very large and shows poor convergence , we choose @xmath345 and thereby eliminate this source of uncertainty .",
    "this large error is partly due to the high optical depth of the gas at the highest densities , where a ray may be terminated in the same cell it was initialized in .",
    "the parameter @xmath223 is varied between @xmath337 and @xmath343 , and the resulting heating rate converges relatively quickly .",
    "we use @xmath346 , which yields slightly better than @xmath279 per cent accuracy and leads to a significant increase in performance .",
    "the number of h@xmath0 lines is varied between @xmath306 and @xmath347 , and displays a substantial increase in accuracy for @xmath348 .",
    "we therefore use @xmath349 , which yields an accuracy of approximately @xmath279 per cent . finally , the number of frequency bins is varied between @xmath279 and @xmath350 .",
    "the error decreases very rapidly with increasing resolution , as the error falls below @xmath351 per cent already for @xmath352 .",
    "even though @xmath306@xmath353 frequency bins would be sufficient , we use @xmath354 and thereby effectively eliminate this source of error . for @xmath307 , @xmath345 , @xmath346 , @xmath349 , and @xmath355 ,",
    "the overall error is therefore approximately @xmath320 per cent .",
    "line emission .",
    "the relevant parameters are the initial healpix level @xmath219 , the source fraction @xmath217 , the ray termination fraction @xmath223 , the number of lines @xmath265 , and the number of frequency bins @xmath239 .",
    "the error is determined by comparing the heating rate for a given parameter choice to the case where the parameter under consideration is set to the most accurate value , denoted by the number in the square brackets . with the exception of the source fraction ,",
    "the heating rate converges relatively well . assuming the errors associated with the variation of the individual parameters are uncorrelated , the desired accuracy can be achieved by choosing the parameters appropriately . in the fully coupled radiation hydrodynamics simulations , we use @xmath307 , @xmath345 , @xmath346 , @xmath349 , and @xmath355 .",
    "this results in an overall accuracy of @xmath283 per cent.,width=302 ]      the properties of the central gas cloud in the three simulations are shown in fig .",
    "[ fig_mh_img ] .",
    "the individual columns show the number density of hydrogen nuclei , temperature , and escape fraction in the central @xmath356 of the box at the final output time . in agreement with previous mesh - based studies , the gas clouds are centrally concentrated and have a filamentary morphology , which is indicative of turbulence @xcite . in mh - sob and mh - ray ,",
    "a single clump has formed , while in mh - fit the cloud has fragmented into two distinct clumps .",
    "similar subfragmentation was also found in the simulations of @xcite and @xcite .",
    "the cloud that forms in mh - sob is slightly more concentrated than in the other two cases .",
    "the temperature increases much more gradually than the density , and ranges from about @xmath357 at the edge of the cloud to @xmath358 at the centre . in mh - sob ,",
    "the cloud is somewhat cooler than in mh - fit and mh - ray .",
    "the escape fraction decreases to nearly @xmath359 at the centre of the cloud in mh - ray and mh - fit , while in mh - sob it decreases to only @xmath360 .",
    "the spatial pattern of the escape fraction in mh - sob is also very different from that in mh - fit and mh - ray .            in fig .",
    "[ fig_mh_pspace ] , we show the mass - weighted distribution of the gas in density and temperature , as well as the mass - weighted average temperature versus density . in mh - fit and mh - ray ,",
    "the temperature increases to @xmath361 at a density of @xmath362 , followed by a brief phase of nearly isothermal contraction to @xmath363 .",
    "the temperature then increases more sharply to @xmath364 at @xmath365 , followed by a more gradual increase to @xmath366 at @xmath331 .",
    "the thermal evolution of the gas in mh - sob is somewhat different . at a density of @xmath362 ,",
    "the temperature has already increased to @xmath367 instead of @xmath361 .",
    "the temperature then gradually rises to @xmath364 at @xmath368 , followed by a relatively sharp increase to @xmath366 at @xmath331 .",
    "the overall distribution of the gas shows more pronounced differences . in mh - sob ,",
    "the temperature dispersion at a density of @xmath369 is significantly larger than in the other simulations , and spans approximately a factor of @xmath320 .",
    "this is similar to the results of @xcite , where the sobolev method was used . in mh - fit ,",
    "the temperature varies only by a factor of @xmath279 , and in mh - ray the variation is nearly absent .",
    "the dispersion continues to decrease with increasing density , indicating that the cloud becomes increasingly spherically symmetric .",
    "the chemothermal instability that operates at these densities is significantly more pronounced in mh - sob , even though the cloud only fragments in mh - fit .",
    "this indicates that fragmentation during the initial collapse is highly stochastic in nature .",
    "the radial profiles of the number density of hydrogen nuclei , temperature , h@xmath0 fraction , escape fraction , radial velocity over sound speed , and root - mean - squared density contrast versus radius are shown in fig .",
    "[ fig_mh_rad ] .",
    "the latter is given by @xmath370 where the sum extends over all cells contributing to a radial bin , @xmath61 denotes the cell index , @xmath151 the mass , @xmath371 the density , @xmath372 the total mass in the bin , and @xmath373 the mass - weighted average density .",
    "the density profiles show that the flat core of the central , jeans - unstable cloud extends to a few au . outside of the core ,",
    "the density falls off as approximately @xmath374 , which is expected for an effective adiabatic index of @xmath375 @xcite .",
    "the temperature profiles show the same trends as in fig .",
    "[ fig_mh_pspace ] . in mh - sob ,",
    "the central temperature is somewhat lower than in mh - fit and mh - ray . as a result ,",
    "the h@xmath0 fraction in mh - sob is @xmath376 at @xmath331 , while in mh - fit and mh - ray slightly more h@xmath0 has been dissociated , with @xmath377 .",
    "the somewhat lower temperature in mh - sob also slightly increases the mach number of the inflow on a scale of @xmath378 .",
    "these differences can be attributed to the much higher escape fraction in mh - sob than in mh - fit and mh - ray , which also indirectly affects the growth of density fluctuations .",
    "this is evident from the density contrast shown in the bottom right - hand panel of fig .",
    "[ fig_mh_rad ] .",
    "the higher escape fraction in mh - sob results in a softer effective equation of state , which allows individual parcels of gas to become more dense than in mh - fit and mh - ray .",
    "the escape fraction at various peak densities is shown in the top panel of fig .",
    "[ fig_mh_fesc ] .",
    "apart from the varying sizes of the jeans - unstable cores , they do not differ much from the final profile .",
    "the various processes that operate in mh - ray can be understood from the bottom panel of fig .",
    "[ fig_mh_fesc ] , which shows the escape fraction for three different ray - tracing calculations in addition to mh - ray , denoted by mh - ray - m0 , mh - ray - m1 , and mh - ray - m2 . in mh - ray - m0",
    ", the line - averaged grey opacity of equation  [ eq_cross_avg ] is used . in this case , the optical depth is very large , since the lines that emit the most energy also have the highest cross - sections , while lines with a lower cross - section do not contribute substantially to the emission . in mh - ray - m1 ,",
    "the lines are treated separately using the cross - sections at the centres of the lines . in this case",
    ", the energy emitted in the more energetic lines can escape more easily , since the cross - sections are lower , resulting in an escape fraction that is up to two orders of magnitude higher than in the line - averaged case . in mh - ray - m2 , frequency - dependent emission and absorption",
    "are taken into account , but deviations in the thermal doppler width and relative velocities along the rays are neglected .",
    "since the cross - section is much lower in the wings of the lines , the associated energy can escape much more easily , increasing the escape fraction by up to an order of magnitude compared to the grey case .",
    "finally , in mh - ray all effects are taken into account . in this case , the escape fraction increases by about a factor of @xmath279 compared to mh - ray - m2 .",
    "we have verified that variations in the doppler width have almost no effect on the escape fraction .",
    "the observed difference is therefore due to the doppler shift induced by relative velocity fluctuations along the rays .",
    "fraction , escape fraction , radial velocity over sound speed , and root - mean - squared density contrast .",
    "the much higher escape fraction of h@xmath0 line emission in mh - sob results in a somewhat reduced central temperature , an increased h@xmath0 fraction , and a higher mach number for the radial inflow on a scale of @xmath379 compared to mh - fit and mh - ray .",
    "in addition , due to the softer effective equation of state , the density contrast in mh - sob is somewhat elevated.,width=302 ]    . during the initial collapse phase , the escape fraction in mh - ray agrees",
    "relatively well with the fitting function of @xcite , while for high optical depths the sobolev method overestimates the escape fraction by more than an order of magnitude.,width=302 ]    in fig .",
    "[ fig_mh_freq ] , we show the initial and final line profiles of the @xmath350 rays of the base healpix level around the densest cell in a ray - tracing calculation with @xmath297 , @xmath380 , and @xmath381 , using a snapshot when the density first exceeds @xmath365 . since the initial profiles are so similar , they are represented by the solid grey line .",
    "the final profiles are significantly distorted from their initial gaussian shape due to the strong attenuation along the rays .",
    "the various lines show differing amounts of absorption , but in general the centres of the lines are damped more strongly than the wings of the lines .",
    "the lines are also attenuated asymmetrically , which is caused by relative velocity fluctuations along the rays . in all but one case , the low - frequency end displays stronger attenuation , which indicates that a net gradient in the inflow velocity exists .",
    "however , the average shift is only @xmath382 , showing that relative velocities only mildly affect the escape fraction .        the dashed green line in the top panel of fig .",
    "[ fig_mh_fesc ] shows the escape fraction obtained with the sobolev method . for large optical depths",
    ", the escape fraction deviates by more than an order of magnitude from the correct solution .",
    "the large error may be attributed to the inherent assumption in equation  [ eq_tau ] that the velocity gradient that is present in the central , jeans - unstable cloud extends indefinitely",
    ". however , fig .",
    "[ fig_mh_rad ] shows that this is not the case .",
    "to first order , the infall velocity increases roughly linearly to the sound speed at the jeans length , and remains constant thereafter .",
    "the average velocity fluctuation is thus less than the sound speed .",
    "the escape fraction obtained for this idealized case is shown by the dashed red line in fig .",
    "[ fig_mh_fesc ] . in this case , denoted by mh - sob - m0 , the sobolev length is replaced by the jeans length , which yields a velocity gradient of @xmath383 .",
    "the resulting escape fraction is closer to the true solution than is the case for mh - sob , but nevertheless deviates by a factor of a few at both ends of the profile .",
    "this is due to the variation of the gas properties on scales smaller than the velocity varies , which violates the sobolev condition .",
    "the difference between mh - sob - m0 and mh - sob shows that large velocity gradients induced by the transonic turbulence throughout the cloud reduce the sobolev length by a factor of a few compared to the jeans length , resulting in a similar increase in the escape fraction .",
    "this is because the sobolev method assumes that the local velocity gradient is coherent throughout the entire cloud , while in reality the velocity can vary significantly on scales smaller than the jeans length , and has a mean that is approximately equal to the net infall velocity . if the sobolev method is used , the turbulence thus has a strong effect on the escape fraction , while a comparison of mh - ray - m2 and mh - ray in the top panel of fig .",
    "[ fig_mh_fesc ] and the results of fig .",
    "[ fig_mh_freq ] shows that the turbulence does not have a substantial effect in the case of mh - ray .",
    "the discrepancy in the escape fraction between mh - sob and mh - ray at the highest densities can thus exceed more than an order of magnitude .",
    "the fitting function of @xcite , on the other hand , agrees relatively well with the ray tracing during the initial collapse phase . in general , however , this will not be the case since the escape fraction depends on many factors , such as the density , temperature , velocity , the chemical and thermal rate equations , and the further evolution of the cloud .",
    "we here compare the results of our simulations to previous work .",
    "@xcite investigated the collapse of primordial gas clouds with smoothed particle hydrodynamics ( sph ) simulations , using the sobolev method to estimate the photon escape fraction .",
    "they found an escape fraction of @xmath384 at @xmath385 , which agrees reasonably well with mh - ray at this density , where @xmath386 .",
    "however , this does not agree with mh - sob , where the escape fraction is an order of magnitude higher",
    ". since the radial velocities are comparable in both studies , this difference is likely caused by the turbulence of the gas .",
    "this turbulence was not resolved in the simulations of @xcite , due to inherent limitations of the hydrodynamic solver employed @xcite .",
    "@xcite compared the escape fraction obtained with the sobolev method in an sph simulation to that described by the fitting function of @xcite .",
    "they found that the resulting escape fractions differed by about a factor of @xmath279 in the range @xmath387 .",
    "a somewhat more detailed study was carried out by @xcite .",
    "they found gas clouds that were substantially rotationally supported and had a smaller radial velocity gradient than in the one - dimensional calculations of @xcite and @xcite . as a result",
    ", they obtained escape fractions that were systematically smaller than those described by the fitting function .",
    "however , similar to @xcite , both studies did not resolve the turbulence of the gas very well .    despite the very different escape fractions obtained with the various methods ,",
    "the thermal evolution of the clouds does not differ by much .",
    "this is due to the strong temperature dependence of the h@xmath0 line cooling rate , which scales approximately as @xmath388 .",
    "even for an order of magnitude difference in the escape fraction , the temperature thus varies by less than a factor of @xmath279 .",
    "for example , @xcite employed the sobolev method using a moving - mesh approach and found an average temperature of @xmath389 at @xmath341 , while @xcite used the fitting function and found a central temperature of @xmath358 .",
    "other studies found values between these two extremes @xcite . here , we find that the central temperatures obtained with the various methods are in the range @xmath390@xmath391 , despite the highly discrepant escape fractions .",
    "next to the temperature , the h@xmath0 abundance varies as well .",
    "for example , in @xcite the gas remains fully molecular at @xmath331 , while in @xcite the h@xmath0 abundance drops to @xmath392 . in the present study",
    ", the h@xmath0 abundance only varies between @xmath393 and @xmath394 .",
    "we do find , however , a large difference in the dispersion of the temperature at a density of @xmath395 . in the most extreme case",
    ", @xcite found that the temperature can vary by a factor of @xmath283 and that some parcels of gas become gravitationally unstable . in the present study ,",
    "the temperature varies by less than a factor of @xmath279 , demonstrating that the thermal instability found in @xcite is caused by the overestimate of the escape fraction by the sobolev method .",
    "since the turbulence was well resolved in @xcite , the temperature dispersion is even larger than in studies that employed sph simulations ( e.g. * ? ? ?",
    "* ; * ? ? ?",
    "we note that another potential source of discrepancy is the rate used for three - body h@xmath0 formation and the inverse process , collisional dissociation .",
    "nearly all previous studies used the rates introduced in @xcite , which are intermediate in terms of the large uncertainty discussed in @xcite . in the present study ,",
    "we use the revised three - body formation rate obtained by the quantum - mechanical calculations of @xcite , which is about two times lower than the rate of @xcite at @xmath357 . since the difference is significantly smaller than in the case of the escape fractions",
    ", it likely does not have a substantial effect on the thermal evolution of the gas .",
    "we have performed the first three - dimensional simulations of primordial star formation that self - consistently model the multifrequency radiative transfer of h@xmath0 line emission .",
    "the simulations employ a new equilibrium / non - equilibrium primordial chemistry solver next to a new multiline , multifrequency ray - tracing scheme that is capable of adaptively refining rays based on the healpix algorithm @xcite .",
    "the latter can be used to solve the static radiative transfer equation for point sources as well as diffuse emission .",
    "both schemes have been implemented in the simulation code arepo .",
    "the chemistry solver is optimized for collapse simulations and is significantly faster than the solver used in @xcite .",
    "the ray - tracing scheme is capable of walking about one million cells per second , and can be parallelized using a hybrid distributed / shared memory scheme .",
    "the calculation of the optical depth for multiple lines and/or frequency bins uses tabulated opacities and exploits the intel avx instruction set , which boosts the performance to a level where the main bottleneck is the communication of the ray data among mpi tasks . for isolated point sources ,",
    "the parameters that govern the accuracy of the scheme are the initial healpix level , the average number of rays per cell ( for adaptive splitting ) , the minimum fractional energy of a ray before it is terminated , the number of lines , and the number of frequency bins . in the case of diffuse emission ,",
    "the angular resolution typically remains constant , while an additional parameter specifies the fraction of all cells that are sources .",
    "the reliability of both schemes is demonstrated with a series of idealized test calculations .",
    "the ray - tracing scheme is used to compute the radiative transfer of h@xmath0 line emission in an ab initio simulation of primordial star formation .",
    "we achieve an accuracy of @xmath320 per cent in the radiative heating rate by using @xmath396 opacity calculations per time step , amounting to a total wall - clock time of @xmath342@xmath279 months on @xmath397 state - of - the - art computing cores . in agreement with previous studies , we find that the gas becomes optically thick to h@xmath0 line emission at densities @xmath15 , and the line cooling rate is surpassed by collision - induced emission at @xmath398 .",
    "within this range , the spherically averaged escape fraction decreases from unity to @xmath399 , with a power - law slope of @xmath400 .",
    "this agrees relatively well with the fitting function of @xcite , which is based on one - dimensional radiative transfer calculations @xcite . during the initial collapse phase",
    ", the assumption of spherical symmetry appears to give relatively accurate results for the purpose of computing the h@xmath0 line transfer .",
    "however , since the escape fraction depends on many factors , such as the density , velocity , temperature , and the chemical and thermal rate equations , it is generally not advisable to use a fitting function .",
    "the escape fraction method also does not capture the diffusion of the radiation , which suppresses density fluctuations as the gas evolves into the optically thick regime .    by systematically increasing the physical detail of the radiative transfer",
    ", we have found that using multiple lines and frequency bins is essential .",
    "the lower cross - sections of the more sparsely populated lines can boost the amount of energy that can escape by many orders of magnitude .",
    "a similar effect becomes important if frequency - dependent emission and absorption are accounted for : the lower cross - sections in the wings of the lines allow significantly more energy to escape than in the grey case .",
    "finally , doppler shifts due to relative velocities along the rays increase the escape fraction by about a factor of @xmath279 .",
    "this effect is relatively small in comparison , since the infall velocity fluctuates by less than the sound speed , and results in a frequency shift of only @xmath401 .",
    "we have also compared our results to the escape fraction obtained with the sobolev method . for low optical depths ,",
    "the sobolev method somewhat underestimates the escape fraction , while for high optical depths the escape fraction is overestimated by more than an order of magnitude .",
    "this discrepancy arises because the sobolev method is only accurate if the scales on which the properties of the gas change are much larger than the sobolev length .",
    "this is not the case in the self - gravitating gas clouds that form in minihaloes , since the infall velocity typically varies by less than the sound speed .",
    "the discrepancy becomes even larger if the turbulence is well resolved . in this case",
    ", the local velocity gradient can be much larger than @xmath383 , resulting in a further increase in the escape fraction , despite the fact that the turbulent velocities nearly cancel each other within a jeans length , and thus have almost no effect on the escape fraction .",
    "previous studies found better agreement between the sobolev method and the fitting function of @xcite , since limitations of the hydrodynamic solver employed prevented the turbulence from being resolved @xcite . as a result ,",
    "the velocity gradient was dominated by the radial velocity gradient , resulting in a sobolev length that was significantly larger than the one found here .    for the above reasons , simulations that used the sobolev method and resolved the turbulence in the gas greatly overestimated the escape fraction @xcite .",
    "in particular , the cooling instability found in @xcite is largely an artefact of the sobolev method .",
    "however , due to the strong dependence of the h@xmath0 line cooling rate on the temperature , the overall thermal evolution of the cloud is much less affected .",
    "for example , in @xcite the temperature at @xmath402 is @xmath389 , while in @xcite the temperature is @xmath358 .",
    "the h@xmath0 abundance shows a similarly mild variation . in @xcite ,",
    "the gas remains fully molecular at a density of @xmath403 , while in @xcite the h@xmath0 has begun to dissociate , with @xmath392 .",
    "@xcite suggested that the reduced h@xmath0 fraction may reduce the ability of the cloud to fragment .",
    "however , since the gas becomes rotationally supported in a keplerian disc following the initial collapse , the resulting asymmetry may allow the cooling radiation to escape more easily than previous studies predicted @xcite .",
    "a definitive answer must await detailed radiation hydrodynamics simulations that evolve the collapse well beyond the formation of the first protostar .",
    "thg is indebted to volker springel for access to the simulation code arepo .",
    "thg would like to thank lars hernquist , laura sales , mark vogelsberger , volker bromm , and volker springel for stimulating discussions and feedback .",
    "the simulations were carried out at the texas advanced computing center ( tacc ) under xsede allocation ast130020 ."
  ],
  "abstract_text": [
    "<S> we investigate the collapse of primordial gas in a minihalo with three - dimensional radiation hydrodynamics simulations that accurately model the transfer of h@xmath0 line emission . for this purpose , </S>",
    "<S> we have implemented a multiline , multifrequency ray - tracing scheme in the moving - mesh code arepo that is capable of adaptively refining rays based on the healpix algorithm , as well as a hybrid equilibrium / non - equilibrium primordial chemistry solver . </S>",
    "<S> we find that a multifrequency treatment of the individual h@xmath0 lines is essential , since for high optical depths the smaller cross - section in the wings of the lines greatly increases the amount of energy that can escape . </S>",
    "<S> the influence of doppler shifts due to bulk velocities is comparatively small , since systematic velocity differences in the cloud are typically smaller than the sound speed . during the initial collapse phase , the radially averaged escape fraction agrees relatively well with the fit of ripamonti & abel . </S>",
    "<S> however , in general it is not advisable to use a simple density - dependent fitting function , since the escape fraction depends on many factors and does not capture the suppression of density perturbations due to the diffusion of radiation . </S>",
    "<S> the sobolev method overestimates the escape fraction by more than an order of magnitude , since the properties of the gas change on scales smaller than the sobolev length .    </S>",
    "<S> -1 cm    hydrodynamics  radiative transfer  stars : population  iii  galaxies : high - redshift  cosmology : theory  early universe . </S>"
  ]
}