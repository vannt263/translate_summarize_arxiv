{
  "article_text": [
    "three x - ray free - electron lasers ( xfels ) , lcls @xcite , scss @xcite , and the european xfel @xcite are currently under commissioning or under construction . these machines are based on the self - amplified spontaneous emission ( sase ) process @xcite-@xcite and will be operating with electron bunch durations of less than @xmath3 fs .    operational success of xfels will be related to the ability of monitoring the spatio - temporal structure of these sub-@xmath3 fs electron bunches as they travel along the xfel structure . however , the femtosecond time - scale is beyond the scale of standard electronic display instrumentation .",
    "therefore , the development of methods for characterizing such short electron bunches both in the longitudinal and in the transverse directions is a high - priority task , which is very challenging .",
    "a method for peak - current shape measurements of ultrashort electron bunches was proposed in @xcite .",
    "it uses the undulator - based optical replica synthesizer ( ors ) , together with the ultrashort laser pulse shape measurement technique called frequency - resolved optical gating ( frog ) @xcite .",
    "it was demonstrated in @xcite that the peak - current profile for a single , ultrashort electron bunch could be determined with a resolution of a few femtoseconds .",
    "the ors method is currently being tested at the free - electron laser in hamburg ( flash ) @xcite .",
    "recently , feasibility studies for integrating the ors diagnostics setup with a timing scheme for pump - probe experiments and with a scheme for output - power stabilization of an x - ray sase fel were presented in @xcite and @xcite .",
    "both schemes rely on an external optical laser to modulate the energy of an electron bunch in a short undulator .",
    "such energy - modulation is subsequently converted into density modulation by means of a dispersive section . since the ors setup already includes seed laser , energy modulator undulator and dispersion section , it is the most natural option to be considered in the implementation of both timing and stabilization schemes .",
    "in this paper we present a feasibility study for integrating the ors setup with a high - resolution electron bunch imager based on coherent optical transition radiation ( otr ) .",
    "electron bunch imagers based on incoherent otr constitute the main device presently available for the characterization of an ultrashort electron bunch in the transverse direction .",
    "they work by measuring the transverse intensity distribution .",
    "however , since no fast enough detector is presently available , the image is actually integrated over the duration of the electron bunch . therefore",
    ", incoherent otr imagers fail to measure the temporal dependence of the charge density distribution within the bunch . for these reasons ,",
    "the use of standard incoherent otr imagers is limited to transverse electron - beam diagnostics , to measure e.g. the projected transverse emittance of electrons .",
    "however , it is primarily the emittance of electrons in short axial slices fs ) bunch length . ] , which determines the performance of an xfel .",
    "there is , therefore , a compelling need for the development of electron diagnostics capable of measuring three - dimensional ( 3d ) ultrashort electron bunch structures with micron - level resolution .",
    "the main advantages of coherent otr imaging with respect to the usual incoherent otr imaging is in the coherence of the radiation pulse , and in the high photon flux .",
    "exploitation of these advantages lead to applications of coherent otr imaging that are not confined to diagnostics of the transverse distribution of electrons .",
    "the novel diagnostic techniques described here can indeed be used to determine the 3d distribution of electrons in a ultrashort single bunch . in combination with multi - shot measurements and quadrupole scans",
    ", they can also be used to determine the electron bunch slice emittance .",
    "the possibility of single - shot , 3d imaging of electron bunches with microscale resolution makes coherent otr imaging an ideal on - line tool for aligning the bunch formation system at xfels .",
    "future xfel operation will set tight tolerances on electron bunch trajectories .",
    "they need to be carefully monitored along the full - length of the machine . in order to ensure sase lasing at x - ray wavelengths ,",
    "a very high orbit accuracy of a few microns has to be ensured in the @xmath4 m long undulator .",
    "the resolution of incoherent otr imagers is not adequate to characterize the position of the center of gravity of an electron bunch with such accuracy .",
    "our studies show that coherent otr imaging can be utilized as an effective tool for measuring the absolute position of the electron bunch with the required micron accuracy .",
    "finally , the improvement of bunch - imaging techniques up to the microscale level does not only yield a powerful diagnostic tool , but opens up new possibilities in xfel technology as well .    a pioneering experiment for integrating the ors setup with a coherent otr imager",
    "was performed at flash .",
    "the energy of the coherent otr pulse was measured as a function of the position of a relatively short seed laser pulse along the ( long ) bunch , i.e. the slice peak - current was measured .",
    "first attempts to extract information about the correlation between longitudinal and transverse distribution also took place .",
    "these results , which should be considered as first steps into a novel direction of electron - beam diagnostics , are reported in @xcite .    in this work ,",
    "we illustrate the potential of the proposed coherent otr imager scheme for the case of the european xfel @xcite .",
    "we show that it naturally fits into the project",
    ". technical realization will be straightforward and cost - effective , since it is essentially based on technical components ( ors , otr diagnostics stations ) , which are already included in the design of the european xfel . in our analysis we considered the baseline parameters , so that our scheme can be implemented at the very first stage of operation of the european xfel facility .",
    "however , the applicability of our method is not restricted to the european xfel setup .",
    "other projects , e.g. lcls or scss @xcite may benefit from this work as well .    our paper is organized as follows . in the next sections [ sec : setup ] ,",
    "[ sec : otrsetup ] and [ sec : imager ] we introduce basic concepts and important details pertaining the optical replica method , the coherent otr generation and the image formation of a modulated electron bunch .    in section [ sec : ft ]",
    "we analyze a coherent otr imaging setup , the so called @xmath5 filtering architecture , which is relatively simple to implement experimentally .",
    "we demonstrate that such setup can be used to characterize electron density profiles on the microscale level .",
    "such resolution level can be reached by taking advantage of a number of options , including e.g. spatial filtering in the fourier plane and radial - to - linear polarization conversion , which make coherent otr imaging more accurate .",
    "diffractive imaging is one of the most promising techniques for microscale imaging of electron bunches , when a detector records the fraunhofer diffraction pattern radiated by the electron bunch .",
    "subsequently , an image can be reconstructed with the help of a phase retrieval algorithm .",
    "this method reduces the requirements on the optical hardware by increasing the sophistication in the post - processing of the data collected by the system . besides , a diffractive imaging setup has the same ultimate resolution of the @xmath5 coherent imaging setup .",
    "this extremely simple method is discussed for two versions , with and without the use of lenses , in section [ sec : diffite ] .",
    "fourier - transform holography ( fth ) is analyzed as another promising imaging method in section [ sec : holog ] .",
    "fth is a non - iterative imaging technique , so the image can be reconstructed in a single step deterministic computation .",
    "this is achieved by placing a coherent point source at an appropriate distance from the object and having the object field interfering with the reference wave produced by this point source , detecting the interference pattern in the fourier plane . for optical applications , the resolution of holographic techniques",
    "is not limited by size and quality of the point - like source . with the help of modern lithographic methods",
    "it is not difficult to produce a pinhole , unresolved at optical wavelengths , and let sufficiently bright radiation through it .",
    "the fast , unambiguous and direct reconstruction achieved in fth is attractive for coherent otr imaging of electron bunches .",
    "moreover , fth may also be used to generate a low - resolution image of the bunch to support diffractive imaging techniques . in this case",
    ", multiple references can be added to the fth setup in order to increase the a - priori information available .",
    "one of the main unsolved problems in xfel electron bunch diagnostics is the characterization of bunches that have significant distortions in transverse phase space , e.g. bunches whose transverse phase - space ellipse varies along the beam itself . in an rf photoinjector with perfectly working emittance compensation technique ,",
    "the electron beam transverse profile is axis - symmetric , and the twiss parameters are equal in all slices ( excluding the emittance , which varies ) . for a real beam ,",
    "the variation in the space charge forces can be significant and can not be properly compensated with a solenoid emittance compensation scheme .",
    "in addition , coherent synchrotron radiation ( csr ) related effects in bunch compressors can lead to further deviations from the axis - symmetric model .",
    "the knowledge of the variation of the phase - space ellipse along the bunch at the output of the bunch formation system could provide significant information about the physical mechanisms responsible for the generation of ultrashort bunches in xfels .",
    "if the 3d structure of electron bunches could be provided ( even as the result of a multi - shot measurement ) , a quadrupole - scan ( which is a multi - shot measurement method too ) could be used to provide phase - space density distribution measurements .",
    "twiss parameters in each slice could be reconstructed in this way .    as mentioned above ,",
    "the applications of coherent otr imaging are not confined to diagnostics of the transverse distribution of electrons projected along the longitudinal axis .",
    "simple extensions of our proposed diagnostic techniques allow for the characterization of the 3d structure of electron bunches with a multi - shot measurement .",
    "our approach , described in section [ sec : diffite ] , involves a combination of real and reciprocal space imaging spectrometers .",
    "both imaging setups use frequency filters to obtain the spectral data of the image .",
    "when the filter bandpass is changed , successive images are recorded at different wavelengths .",
    "this process is repeated , wavelength by wavelength , until the entire spatial spectral data is built up slice by slice .",
    "the result is the simultaneous knowledge of two `` 3d cubes '' of spectral data , one in the real space @xmath6 and the other in the reciprocal space @xmath7 , having indicated with @xmath8 the spatial frequencies relative to the @xmath9 and @xmath10 axis .",
    "application of e.g. the gerchberg - saxton algorithm @xcite , which is the first practical iterative algorithm to have been developed for solving the fourier - phase - retrieval problem , allows one to retrieve the spatio - temporal electron - bunch structure .    in section [ sec : diffite ] we also show how the determination of the projections of the cube of data in reciprocal space onto specific planes of interest is sufficient to reconstruct the electron - bunch structure , even without knowledge about the cube of spectral data in real space .",
    "the advantage of this method is that it requires no reference pulse shorter than the electron bunch ( i.e. no synchronization ) . in other words ,",
    "the optical replica pulse can be measured in the 3d fourier domain .",
    "we name this novel method frequency - resolved optical diffractive imaging ( frodi ) .",
    "frodi is further developed in section [ sec : diffite ] from a multi - shot to a single - shot technique to measure the 3d structure of a single electron bunch .",
    "this is accomplished by splitting the beam and simultaneously measuring orthogonal @xmath11 , @xmath12 and @xmath13 projections .",
    "the entire traces can be recorded by three detectors , and used to reconstruct the desired 3d electron - bunch structure .    while frog requires the use of nonlinear - optical process , frodi is a linear - optical method , and linear - optical processes do not require intense pulses .",
    "here we discuss about measurements of complicated pulses in three dimensions , and it is interesting to compare frodi with the well - known frog technique , which can measure complicated pulses in one dimension ( 1d ) . as was reported in @xcite concerning measurements of temporal structures in optical pulses : `` it can be shown that linear - optical methods can not completely measure ultrashort pulses '' .",
    "quite counter - intuitively , the measurement of 3d structures of optical pulses in time and space is simpler than the measurement of temporal 1d structures alone .",
    "however , in analogy with this fact , it is well - known that the two - dimensional ( 2d ) phase retrieval problem is solvable , unlike the 1d one . to detect the temporal structure of optical pulses ,",
    "frog requires the use of a nonlinear optical process , which allows to extend the 1d reconstruction problem to a 2d reconstruction problem .",
    "this involves an artificial 2d fourier domain .",
    "unlike it , frodi transforms the problem of measurement of 3d structures in time and space into measurements of the more natural 3d spatial - frequency and temporal - frequency domains .",
    "no prior information about the electron bunch structure is necessary to reconstruct the electron bunch density distribution from the experimental traces .",
    "our 3d imaging technique frodi turns out to be a relatively simple solution to a very complicated problem . for the 3d ( spatio - temporal ) electric field of optical replica pulses produced by optically - modulated electron bunches with spatio - temporal distortions ,",
    "different spatial frequencies are related to different temporal spectra ( i.e. spatial frequency and temporal frequency are coupled ) .",
    "multi - shot and single - shot techniques for the characterization of the electron bunch can also be based on fth setups .",
    "a new multi - shot technique for 3d imaging of the electron bunch based on frequency gated fth is discussed in section [ sec : holog ] . in the same section [ sec : holog ]",
    "we also consider spatio - temporal fth techniques .",
    "an extension of the method opens up the possibility for single - shot 3d imaging of ultrashort electron bunches .",
    "time - gated fth is the next class of techniques discussed in section [ sec : holog ] .",
    "the principle of this method is straightforward .",
    "a hologram records information about the object only when it is illuminated simultaneously by a coherent reference wave .",
    "then , when a short reference is used , the hologram is equivalent to a time - gated viewing system @xcite . we propose a method based on time - gated fth with multiple reference sources capable of characterizing the spatio - temporal structure of individual electron bunches .",
    "multiple , ultrashort ( about @xmath14 fs ) reference pulses are generated with a varying time - delay , so that several two - dimensional images ( frames ) of the electron bunch at different position inside the bunch can be reconstructed from a single holographic pattern .",
    "we call this technique holography optical time resolved imaging ( hotri ) .",
    "we conclude our work in section [ sec : conc ] .",
    "we propose to create a coherent pulse of optical radiation by first modulating the electron bunch at a given optical wavelength and , second , by letting it pass through a metal foil target , thus producing coherent optical transition radiation ( otr ) at the modulation wavelength .",
    "the radiation pulse should be produced in such a way as to constitute an exact replica of the electron bunch .",
    "such optical replica can be used for the determination of the 3d structure of electron bunches .",
    "although other projects may benefit from our study too , throughout this paper we will mainly refer to parameters and design of the european xfel .    in order to produce the optical replica we need to modulate the electron bunch at a fixed optical wavelength .",
    "one may take advantage of an optical replica synthesizer ( ors ) modulator @xcite , which we suppose to be installed after the bc2 bunch compressor chicane . a basic scheme to generate coherent otr",
    "is shown in fig .",
    "[ setupim ] .",
    "a relatively long laser pulse serves as a seed for the modulator , consisting of a short undulator and a dispersion section .",
    "the central area of the laser pulse should overlap with the electron pulse . in order to ensure simple synchronization",
    ", the duration of the laser pulse should be much longer than the electron pulse time jitter , which is estimated to be of the order of @xmath3 fs .",
    "foreseen parameters of the seed laser are : wavelength @xmath15 nm , energy in the laser pulse @xmath16 mj and pulse duration ( fwhm ) @xmath16 ps .",
    "the laser beam is focused onto the electron bunch in a short ( the number of periods is @xmath17 ) modulator undulator resonant at the optical wavelength of @xmath18 nm .",
    "optimal conditions of focusing are met by positioning the laser beam waist into the center of the modulator undulator , with a rayleigh length of the laser beam equal to the undulator length . since the electron betatron function @xmath19 ,",
    "the undulator length @xmath20 and the rayleigh length of the laser beam are of the same magnitude , the size of the laser beam waist turns out to be about @xmath21 times larger than the electron beam size . as a consequence , we can approximate the laser beam with a plane wave when discussing about the modulation of the electron bunch .",
    "the seed laser pulse interacts with the electron beam in the modulator undulator and produces an amplitude of the energy modulation in the electron bunch of about @xmath22 kev .",
    "subsequently , the electron bunch passes through the dispersion section ( with momentum compaction factor @xmath23 m ) , where the energy modulation is converted into density modulation at the laser wavelength .",
    "the electron bunch density modulation reaches an amplitude of about @xmath24 .",
    "finally , the modulated electron bunch travels through the otr screen .",
    "a powerful burst of otr is emitted , which contains coherent and incoherent parts .",
    "the coherent otr has much greater number of photons ( up to @xmath25 i.e. @xmath26j per pulse , as we will see ) , and can be used for diagnostic purposes .",
    "a quantitative treatment for coherent otr is presented in section [ sec : otrsetup ] . the way we can take advantage of coherent otr properties",
    "is discussed in the following sections .",
    "schematic diagram of the coherent imager .",
    "the working principle is based on the optical modulation of the electron bunch and on emission of coherent otr radiation from the metallic mirror.,width=434 ]    it should be mentioned that otr screens can be positioned at various locations down the electron beam line where electrons have substantially different energies . in the case of the european xfel @xcite ,",
    "the electron energy varies from @xmath27 gev ( second bunch compression chicane ) up to @xmath28 gev at the undulator entrance . for other machines ,",
    "these parameters differ . in the case of lcls @xcite",
    ", energies will range from about @xmath29 gev to @xmath30 gev .",
    "reference @xcite includes a discussion about how to avoid the influence of self - interaction effects in the ors setup , when the radiator is placed just behind the modulator .",
    "this case is practically realized , for example , when we want to use a 3d otr imager to align the bunch formation system , and the otr station is placed just after the ors setup behind the second bunch compressor at @xmath27 gev .",
    "the situation changes when the otr imager is placed behind the main xfel accelerator at @xmath28 gev , and the distance between ors modular and otr imager is in the kilometer scale . in section [ sub : probl ]",
    "we will present ideas how to avoid self - interaction effects in the high - energy case .",
    "when , instead , the ors setup and the otr imager are placed just behind the bunch compression system , it sufficient to use the ideas introduced in @xcite .      in order to use the coherent otr burst for diagnostic purposes , one has to ensure that an optical replica of the electron bunch is actually produced .",
    "in fact , the electron bunch density modulation can be perturbed by collective fields .",
    "it is therefore important to consider collective interactions ( radiation and space - charge fields ) influencing the operation of the optical replica modulator , to ensure that longitudinal dynamics in the optical replica modulator is governed by single - particle effects , independently of the presence of other particles .",
    "in particular , our method for electron - beam structure measurements is based on the assumption that the electron bunch density modulation does not appreciably change due to longitudinal space - charge ( lsc ) interactions , i.e. plasma oscillations , as the beam propagates through the setup behind the optical replica modulator , up to the otr station .",
    "thus , the passage of the modulated electron bunch through the setup must be studied .",
    "even when self - interactions are negligible , distortions can be introduced due to nonuniform local energy spread within the electron bunch .",
    "let us first consider under which conditions on the optical replica modulator , the energy - spread effects are negligible .",
    "the way the electron bunch is modulated in the modulator is quantitatively described in e.g. @xcite .",
    "the current @xmath31 at the exit of the dispersion section is found to be a composition of harmonics of the modulation frequency @xmath32 :    @xmath33   j_n\\left(n p_0 \\frac{\\omega_m r_{56}}{c \\mathcal{e}_0}\\right)\\cr & & \\times \\cos\\left[n \\omega_m \\left(\\frac{z}{v_z}-t\\right)\\right]~ , \\label{czonka}\\end{aligned}\\ ] ]    where @xmath34 kev is the initial energy modulation , @xmath35 is the nominal electron energy , @xmath36 is the local energy spread of electrons , @xmath37 is the longitudinal coordinate , @xmath38 is the longitudinal velocity of electrons and @xmath39 is the time .",
    "moreover @xmath40 indicates the bessel function of the first kind of order @xmath41 and , as before , @xmath42 is the momentum compaction factor .",
    "note that the current is , in general a function of the time , i.e. @xmath43 .",
    "however , throughout this paper we will make use of the adiabatic approximation , because the electron bunch is much longer than the modulation wavelength . as a result",
    ", we can consider @xmath44 as a local parameter , and discuss about local amplitude and phase of the density modulation .",
    "as one can see from eq .",
    "( [ czonka ] ) , the microbunching depends on the choice of the dispersion section strength .",
    "in fact , neglecting the exponential suppression factor in @xmath36 , the expression for the fundamental component of the bunched beam current is @xmath45 for @xmath46 , where @xmath47 , with @xmath48 , is a small dimensionless quantity known as the bunching parameter .",
    "one might think that all we have to do is to get the microbunching amplitude to a maximum by increasing the @xmath42 of the dispersion section , thus increasing the output power .",
    "in fact , it is possible to build a dispersion section with a large @xmath42 function .",
    "however , one of the main problems in the modulator operation is preventing the spread of microbunching due to local energy spread in the electron bunch . in other words , for effective operation , the value of the suppression factor in the exponential factor in eq .",
    "( [ czonka ] ) should be close to unity @xcite .",
    "the energy spread is not constant along the electron bunch .",
    "for example , the energy - spread distribution in the case of the european xfel is given in fig .",
    "[ espread ] , reproduced from @xcite .",
    "the maximal energy spread level is about @xmath16 mev .",
    "substituting numbers into the argument of the exponential function ( remember that the chicane of the modulator has dispersion strength @xmath49 m ) one finds that , for the first harmonic ( @xmath50 ) the exponential factor is about unity ( @xmath51 ) even for @xmath52 gev , which is the minimal energy considered .",
    "moreover , the second harmonic ( @xmath53 ) of the modulation is suppressed by an order of magnitude with respect to the first , due to the bessel @xmath54 factor .    as a result , in our case we can approximate eq .",
    "( [ czonka ] ) with    @xmath55~ , \\label{czonka2}\\end{aligned}\\ ] ]    which ensures that the bunching is uniform along the beam .",
    "calling @xmath56 $ ] the modulation phase , the current can be expressed as @xmath57 $ ] , where @xmath58 is the amplitude of our small ( @xmath59 ) density modulation , taken with its own sign .     energy spread profile ( rms , solid line ) at the entrance of the sase undulator ( after xfel tdr ) @xcite ) .",
    ", width=415 ]    let us now discuss distortions due to self - interaction effects . concerning the induced bunching inside the modulator undulator , perturbations due to collective effects are minimized up to a negligible level by using a small number of periods ( @xmath17 ) .",
    "this optimization is also important in order to increase the replica resolution and minimize slippage effects ( @xmath60 , @xmath61 being the electron bunch duration ) .",
    "concerning the effect of lsc interactions , one needs a more detailed analysis .",
    "the propagation of the induced electron bunch density modulation through the setup is a problem involving self - interactions .",
    "if the otr station is placed at a short distance ( say , a few meters ) from the modulator , e.g. to align the bunch formation system , plasma oscillations play no important effect , as it will be clear after reading the following analysis . however , the situation changes if one wants to characterize the electron beam after the linac , to monitor the electron bunch properties along the machine and , in particular , to monitor electron trajectories in the undulator .",
    "in fact , as the bunch progresses through the linac , the modulation of the bunch density produces energy modulation due to the longitudinal impedance caused by space - charge fields .",
    "this process is complicated by the fact that , due to the presence of energy and density modulation , plasma oscillations can develop .    as a result",
    ", the initial energy and density modulation of the electron bunch will be modified by the passage through the setup . in order to study the feasibility of our scheme one needs to estimate what modifications take place . for a given facility ,",
    "otr screens positioned at a higher electron energy translate into a longer distance between modulator and otr screen and , thus , into a stronger lsc influence .",
    "however , the evolution of plasma oscillations tends to slow down as the energy increases .",
    "this means that lcls is less affected than the european xfel , because the last magnetic bunch compressor at lcls is positioned at higher energy ( @xmath29 gev compared to the @xmath27 gev of the european xfel ) .",
    "schematic diagram of the european xfel setup from bc2 through sase1.,width=434 ]      let us consider the european xfel case , where self - interactions are more important ( see fig .",
    "[ xset ] ) .",
    "proceeding as in @xcite we find that energy and density modulation along the accelerator are linked by the following system of differential equations :    @xmath62    @xmath63 ~\\gamma\\left[0,\\frac{\\epsilon_n \\beta}{(\\gamma_0+g z)^3 \\lambdabar^2}\\right]}~ , \\label{modul2}\\end{aligned}\\ ] ]    where we assumed that @xmath64 , with @xmath65 the acceleration gradient and @xmath66 .",
    "the density modulation @xmath58 has been defined above , and the energy modulation is given by @xmath67 . here",
    "@xmath68 ka is the alfven current , @xmath69 is the normalized emittance , @xmath19 is the average betatron function and @xmath70 is the incomplete gamma function .",
    "usually , calculating self - interaction effects is rather challenging . in our case , however , we used the straightforward 1d model in eq .",
    "( [ daiacc ] ) and eq .",
    "( [ modul2 ] ) .",
    "remarkably , such model is not a rough approximation of reality , but it rather constitutes a quantitative approach .",
    "in fact , in our case study we deal with a very particular range of parameters where four asymptotic limits can be simultaneously exploited .",
    "first , retardation effects can be neglected due to a small current @xmath71 , and to the adiabatic acceleration limit ( see @xcite ) , we have @xmath72 for @xmath73 , corresponding to the lowest energy of @xmath27 gev , and @xmath74 for @xmath75 , corresponding to the highest energy of @xmath28 gev .",
    "note that the largest effects due to longitudinal impedance are expected in the first part of the acceleration process . ]",
    "second , the adiabatic approximation applies , i.e. @xmath77 .",
    "third , a pencil beam ( 1d ) approximation is valid because we have , for parameters specified here , @xmath78 . ]",
    "@xmath79 , with @xmath80 the bunch transverse dimension . finally , fourth",
    ", we can neglect the interaction of space - charge fields with material structures because @xmath81 , @xmath82 being the characteristic dimension of the vacuum chamber . as a result ,",
    "when dealing with an xfel setup and discussing about optical microbunching , we have a unique situation . if any of the conditions above ceases to be valid , the model in eq .",
    "( [ daiacc ] ) and eq .",
    "( [ modul2 ] ) ceases to be valid too , as it would be the case e.g. for calculations of impedance at lower frequencies .",
    "evolution of the electron bunch density modulation as a function of the distance from the modulator.,width=415 ]    let us then use eq . ( [ daiacc ] ) and eq .",
    "( [ modul2 ] ) assuming an average betatron function of about @xmath83 m along the main accelerator and a normalized emittance @xmath84 mm@xmath85mrad ( see @xcite ) .",
    "we set the acceleration length in the main linac equal to @xmath86 m. the undulator does not follow immediately the main linac , as it can be seen from fig .",
    "[ xset ] . for example , the sase @xmath16 undulator is preceded by a @xmath87 meters long straight section and by a collimation system , which is @xmath88 meters long . according to @xcite , the compaction factor of the collimator",
    "can be set to any value from @xmath89 mm to @xmath90 mm , with possibility of fine tuning ( not in real time ) of about @xmath91 m .    in practical situations ,",
    "one is interested in inserting otr screens just after the bunch compression chicane ( at @xmath27 gev ) or along the undulator at @xmath28 gev .",
    "the situation where the influence of self - interactions is most important is obviously at @xmath28 gev along the undulator . as shown in @xcite , the longitudinal lorentz factor @xmath92",
    "should be used in the undulator instead of @xmath93 . since @xmath94 , @xmath95 and @xmath96 differ of about an order of magnitude , hence a different influence of the lsc in the undulator compared to the straight section . in the undulator ,",
    "( [ daiacc ] ) and eq .",
    "( [ modul2 ] ) are modified to    @xmath97 ~\\gamma\\left[0,\\frac{\\epsilon_n \\beta}{\\lambdabar^2 \\gamma \\gamma_z^2}\\right]}~ , \\label{modul2x}\\end{aligned}\\ ] ]    where now @xmath98 . even for a simple case study where we set @xmath99",
    ", numerical analysis shows that our initial conditions @xmath100 and @xmath101 yield an unwanted evolution of @xmath102 as summarized in fig .",
    "[ modul ] .",
    "installation of a small dispersive element ( chicane ) after the collimation system will allow to compensate positional - dependent variations of the electron bunch density modulation level.,width=434 ]    as one may see , the electron bunch density modulation is diminished by at most @xmath103 at highest energies and at the end of the undulator .",
    "this constitutes a detrimental effect concerning our imaging techniques .",
    "in fact , we calculated @xmath102 assuming a fixed peak - current @xmath104 ka .",
    "however , the peak - current along the bunch is not constant , and from eq .",
    "( [ daiacc ] ) and eq .",
    "( [ modul2 ] ) follows that the modulation level varies along the bunch in a complicated way depending on the variation of the peak - current level .",
    "this effect is unwanted .",
    "in fact , different parts of the electron bunch should be given the right weight as concerns their contribution to radiation emission , meaning that the ( absolute ) charge modulation in each point of the electron bunch should be proportional to the charge density distribution of the unmodulated bunch .",
    "this can only be realized when the bunching factor is uniform along the bunch i.e. when it does not depend on the charge density distribution nor on the energy spread distribution .",
    "evolution of the level of the electron bunch density modulation for different values of the peak - current @xmath44 .",
    "here we account for the presence of a dispersive element @xmath105 m at the collimation system.,width=453 ]    yet , note that the change in the modulation level is small at any value of @xmath37 , i.e. @xmath106 . as a result , from eq .",
    "( [ daiacc ] ) and eq .",
    "( [ modul2 ] ) follows that , in first approximation , the current - dependent terms in both @xmath102 and @xmath107 depend on @xmath44 linearly .",
    "moreover , the design value for @xmath108 is negative .",
    "therefore , one may think of installing a small chicane as in fig .",
    "[ compe ] to organize a tunable negative compaction factor . calling with @xmath109 the total negative dispersion strength of collimator and chicane",
    ", we can compensate the current - dependent term in @xmath58 at the position of the extra - chicane by requiring :    @xmath110    note that from the differential equation for @xmath111 and @xmath102 we obtain    @xmath112    where @xmath113 , @xmath114 and @xmath115 follow from the integration of eq .",
    "( [ daiacc ] ) and eq .",
    "( [ modul2 ] ) , assuming @xmath116 in that equation .",
    "a proper choice of @xmath109 can compensate for the part of the electron bunch density modulation proportional to @xmath44 , but can not compensate for the term in @xmath117 .",
    "however , such term does not depend on the position inside the bunch and is not detrimental .    with this in mind , the easiest way to find",
    "the proper @xmath109 is to set @xmath118 and @xmath119 in eq .",
    "( [ modul2 ] ) , solve it for @xmath111 and find @xmath102 from eq .",
    "( [ daiacc ] ) . then , substitution of @xmath120 and @xmath102 in eq .",
    "( [ r56c ] ) allows one to obtain , for our parameter choice , @xmath121 m .",
    "the final step is to find the evolution of @xmath102 accounting for the presence of @xmath122 .",
    "note that here we implicitly modelled the collimator and the small chicane after it as a @xmath88-meter - long straight section followed by a single , localized dispersive element . since the actual setup is more complicated than that in our simple model , results reported here are for the sake of illustration only . however , detailed calculations would not present novel effects due to the influence of space - charge , so that exploitation of the tunability of @xmath122 is always possible , and our simple estimations are qualitatively correct .    results of numerical calculations for different values of the peak - current @xmath44 are shown in fig .",
    "[ modul2fig ] .",
    "the compensation effect of @xmath122 can be seen from the spread of the modulation levels before and after the dispersive element .",
    "in fact , from fig .",
    "[ modul2fig ] one can see that such spread is reduced from about @xmath123 to about @xmath124 after the compensation chicane , to increase up to @xmath125 at the end of the undulator .",
    "one concludes that lsc interactions do not introduce any undesired current - dependent modification to the amplitude of the level of the electron bunch density modulation with an accuracy @xmath126 of a few percent .",
    "we should stress that numbers considered in these examples are for the worst possible influence of lsc .",
    "as said before , at lcls these effects would be even less important , as one starts from higher energies after the second bunch compression chicane ( at @xmath127 gev ) .",
    "one can take advantage of coherent otr emission also at that facility , which will allow the electron bunch image not to be in the shadow of parasitic coherent otr emission @xcite .",
    "in fact , with a laser - heater @xcite , the induced uncorrelated energy spread is expected to limit the parasitic modulation of the bunch after the last compressor chicane to less than @xmath128 , which is much smaller compared to the @xmath24 modulation at optical wavelength induced on purpose in our scheme . in this case , the influence of parasitic microbunching is strongly reduced . ] .",
    "as mentioned before , in this paper we deal with two situations of practical interest , both common to the european xfel and lcls . in the first",
    ", the otr screen is positioned at low electron beam energy , just after the modulator . in the second",
    ", it is positioned at high electron beam energy , after the main linac and the collimator system , possibly within the undulator line .",
    "these two cases , shown in fig .",
    "[ compe ] , have differences , but the overall qualitative picture is similar .",
    "let us define the slowly varying envelope of the field in the space - frequency domain as @xmath129}$ ] .",
    "we will refer to this quantity simply as `` the field '' . here",
    "@xmath130 is the fourier transform of the electric field @xmath131 in the space - time domain , according to the convention : @xmath132 d t$ ] .",
    "note that @xmath133 indicates the transverse position vector",
    ".    we will be interested in the otr emission from an electron bunch modulated by the ors .",
    "the typical longitudinal bunch dimension is in the order of @xmath134 m ( fwhm ) , while the modulation wavelength @xmath135 m .",
    "then , the adiabatic approximation applies , and coherent otr emission is automatically characterized by a narrow bandwidth around @xmath136 .",
    "this means that we can use the expression for the otr field from a single electron in the space - frequency domain convolved with the instantaneous charge density distribution as a good representation of the instantaneous otr field . the otr field from a single electron in space - frequency domain",
    "is usually approximated as and the frequency @xmath137 will have a given , fixed value , we will not always include them in the arguments of the field . ]",
    "@xmath138 where @xmath139 is the first order modified bessel function of the second kind , @xmath133 is the observation position on the screen and @xmath140 is the electron position .",
    "( [ proptoff0 ] ) is the result of the ginzburg - frank theory @xcite .",
    "we will see that the field distribution at the otr screen is characterized by two scales of interest .",
    "one is associated with the transverse size of the electron bunch , @xmath141 m .",
    "the other is the typical size of the single - particle otr spatial distribution , which can be estimated from eq .",
    "( [ proptoff0 ] ) in the order of @xmath142 mm for the @xmath27 gev case , where we introduced the reduced wavelength @xmath143 . in our case study of interest @xmath144 , and eq .",
    "( [ proptoff0 ] ) can be approximated as    @xmath145    this fact will be exploited through all our paper .",
    "we should stress here the vectorial nature of the electric field , which always exhibits space - variant polarization .",
    "this suggests an electrostatic 2-d analogy with the electric field generated by an uniformly charged wire .",
    "for the parameters of our problem , this analogy is valid whenever @xmath146 .",
    "this includes , in particular the range @xmath147 .",
    "information about the electron bunch will be shown to be included in a small region of size @xmath148 m corresponding to the region of nonzero electron density on the otr screen , which we will call the `` bunch '' region , region a in fig .",
    "the region of interest of the imaging system is characterized by @xmath149 m , region b in fig .",
    "[ halo ] .    the field distribution for @xmath150 m does not depend on the transverse size of the electron beam .",
    "in other words , a filament beam approximation applies",
    ". we will refer to this region as the `` halo '' region , region c in fig .",
    "[ halo ] . note that in the halo region , information about the peak - current distribution is encoded in the dependence of field amplitude versus time .",
    "the regions a , b and c are not influenced by the position of magnetic structures .",
    "these become relevant at larger distances @xmath151 , region d in fig .",
    "note that the field in region d remains independent of emittance effects , i.e. the filament beam approximation is still valid .",
    "therefore , information about the peak - current distribution can be extracted from region d exactly as from region c.    it should be remarked that numbers given here refer to the relatively low electron beam energy case of @xmath27 gev , and should be multiplied by a corresponding factor when these considerations are extended to the high energy case of @xmath28 gev .",
    "gev.[halo ] , width=566 ]    as mentioned before , as a result of the adiabatic approximation , the field distribution seen on the screen actually depends on the instantaneous transverse charge density distribution . in the bunch region",
    ", the field distribution evolves due to the dependence of the electron bunch transverse size on the longitudinal coordinate , while in the halo region the field distribution is constant , although its amplitude depends on the peak - current .    in this paper",
    "we will be mainly interested in the field within the bunch region .",
    "this is important for imaging purposes .",
    "however , we will occasionally need to characterize the halo region too .",
    "for example , as we will see , there is a possibility of simplifying the optical replica setup for peak - current profile measurement by taking advantage of an otr screen as a radiator . in this case ,",
    "characterization of the halo region is needed .    outside of the bunch region",
    "an exact characterization of the field becomes more complicated , because the approximation of the single - electron field considered up to now ( proportional to @xmath139 ) fails when @xmath152 approaches @xmath153 .",
    "in fact , the influence of magnetic structures upstream of the otr screen starts to be important .",
    "fortunately , not the halo region , nor the d region for @xmath154 will be involved in the imaging process .",
    "in fact , for the halo region the filament - beam asymptote holds : in this region only information about the peak - current is encoded .      up to now we gave a picture of our problem introducing the parameter space of interest .",
    "based on the adiabatic approximation , we mentioned that the coherent otr field can be written as a convolution between the charge density distribution and the single - electron field .",
    "in particular , we used the ginzburg - frank formula to describe the field produced by a single electron on the otr screen ( proportional to @xmath139 ) .    with the help of similarity techniques it is possible to present qualitative arguments to explain why the ginzburg - frank formula can be used in our case study , and why we can neglect the presence of bending magnet and straight section in our setup .",
    "let us consider a setup composed by a bend , a straight section , and a target ( the otr screen ) .",
    "radiation characteristics were shown to depend on two dimensionless parameters @xcite :      where @xmath156 is the radius of the bend , the reduced wavelength of the radiation @xmath157 coincides , as before , with the reduced modulation wavelength @xmath158 , and @xmath159 is the length of the straight section .    by definition , @xmath160 is a measure of the straight section length @xmath159 in units of the synchrotron radiation formation length @xmath161{r^2 \\lambdabar}$ ] .",
    "the parameter @xmath162 , instead , is a measure of the straight section length @xmath159 in units of the characteristic length @xmath163 . in the case of a straight section of length @xmath159 ,",
    "the apparent distance travelled by an electron as seen by an observer is equal to @xmath164 . since it does not make sense to distinguish between points within the apparent electron trajectory such that @xmath165 , one obtains a critical length of interest @xmath166 .    it is known ( see e.g. @xcite ) that the ginzburg - frank theory used above is a limiting case of the more general edge radiation ( er ) theory . while the theory of edge radiation accounts for the presence ( but not for the detailed structure ) of magnetic elements , the ginzburg - frank theory does not . in the theory by ginzburg and frank , an electron coming from an infinitely long straight line ( @xmath167 ) and crossing an interface between vacuum and an ideal conductor is considered . as a consequence of the crossing ,",
    "time - varying currents are induced at the boundary .",
    "these currents are responsible for transition radiation .",
    "the metallic mirror , that is treated as the source of transition radiation , is usually modelled with the help of a physical optics approach .",
    "this is a well - known high - frequency approximation technique , often used in the analysis of electromagnetic waves scattered from large metallic objects .",
    "surface current entering as the source term in the propagation equations of the scattered field are calculated by assuming that the magnetic field induced on the surface of the object can be characterized using geometrical optics , i.e. assuming that the surface is locally replaced , at each point , by its tangent plane .",
    "one may talk of transition radiation in the sense by ginzburg and frank @xcite if @xmath168 , @xmath169 and , additionally , @xmath170 .",
    "in fact , when @xmath170 one can neglect the presence of the upstream bend in the setup , and consider only an electron crossing an interface between vacuum and an ideal conductor .",
    "condition @xmath171 means that the critical wavelength of synchrotron radiation from the bend is much shorter than the ( optical ) radiation wavelength we are interested in , i.e. @xmath172 .",
    "condition @xmath169 means that synchrotron radiation from bending magnet radiation is characterized by a significantly larger opening angle , compared to that of edge radiation . from the viewpoint of electromagnetic sources ( i.e. harmonics of the current and charge density )",
    ", @xmath169 means that a sharp - edge approximation can be enforced , i.e. one can neglect the way electromagnetic sources begin or cease to exist .     and divergence @xmath173 of a diffraction - limited source , and its relation with the formation length @xmath174 , which is interpreted as the apparent length of the source , adapted from @xcite.[diffrlim ] , width=415 ]    in our cases of interest",
    ", analysis shows that @xmath175 for the low energy case , @xmath176 for the high energy case , and in both cases @xmath169 , @xmath171 .",
    "although as discussed in @xcite .",
    "] @xmath177 , when @xmath146 ( i.e. within region b of fig .",
    "[ halo ] ) we can still use the ginzburg - frank theory and describe the field at the otr screen with a distribution proportional to the asymptotic expression for @xmath178/(\\gamma \\lambdabar)$ ] .",
    "in fact , on the one hand the parameter @xmath162 compares the length of the straight section @xmath159 to @xmath163 . on the other hand , however , if we are interested in a region of the otr screen such that @xmath179 , the effective formation length is decreased to about @xmath180 .",
    "we can easily estimate the relation between source size and formation length remembering that radiation from a single electron is diffraction limited and using for estimation the fact that for diffraction limited radiation the photon emittance is given by @xmath181 , where @xmath182 is the characteristic transverse size and @xmath173 is the characteristic divergence of the source ( see fig .",
    "[ diffrlim ] ) . since @xmath183 , one has @xmath184 , which yields @xmath185 .",
    "for example , for region a the effective formation length is of order of @xmath16 cm , while for the full region of interest of our imaging system ( region b ) we have @xmath186 cm .",
    "this is much shorter compared to the distance between the otr screen and the upstream bending magnet .",
    "thus , within the deep asymptotic region @xmath146 , i.e. within regions a and b of fig .",
    "[ halo ] , the ginzburg - frank formula can be applied , while it begins to be less and less accurate in region c , up to @xmath187 , where @xmath188 and @xmath176 .",
    "note that @xmath188 is the maximal formation length because , transversely , the radiation intensity is cut off at @xmath189 .",
    "further complications arise from the fact that the otr screen can be positioned within the undulator line . there",
    "the longitudinal velocity of electrons is effectively decreased , resulting in effectively weaker electromagnetic sources .",
    "the typical transverse size on the otr screen associated with the electromagnetic field decreases from @xmath153 to @xmath190 , where @xmath191 and @xmath192 for the sase1 undulator of the european xfel .",
    "this means that the transverse size decreases of about a factor @xmath193 , and @xmath194 is effectively increased .",
    "however , here we will be interested in much smaller transverse scales of order of the transverse size of the electron bunch @xmath195 m , whereas @xmath196 mm and @xmath197 mm .",
    "thus , we expect that the field distribution changes in the peripheral region between @xmath190 and @xmath153 in the halo region c , but not in the bunch region with @xmath198 nor in the region b. since , as we will see , these size modifications enter only logarithmically in the calculation of the number of photons , they may be neglected in first approximation .",
    "consider a setup composed by a bend , a straight section , and a metallic mirror . in order to solve the problem of field characterization , a virtual source method described in @xcite , based on the more general work @xcite , is taken advantage of . following that reference , and defining the electron charge as @xmath199",
    ", we obtain at the mirror position .",
    "] , i.e. at @xmath200 :    @xmath201 \\left .",
    "\\right.\\cr & & \\left.\\times \\exp\\left[\\frac{i \\omega { r}^2 } { 2 c l}\\right]\\frac{\\omega}{c l } \\int_0^{\\infty } d{r } ' { r } ' k_1\\left(\\frac{\\omega r'}{c \\gamma}\\right ) j_1 \\left(\\frac{\\omega { r}{r}'}{c l}\\right ) \\exp\\left[\\frac{i \\omega { r}^{'2 } } { 2 c l}\\right ] \\right.~,\\label{fieldtot2}\\end{aligned}\\ ] ]    which is valid for any value of @xmath162 under conditions @xmath202 and @xmath171 .",
    "note that the field is radially polarized .",
    "one may deal with two asymptotes of the theory for @xmath170 and @xmath203 .    as discussed before ,",
    "when @xmath170 eq .",
    "( [ fieldtot2 ] ) yields back the usual ginzburg - frank theory    @xmath204    the following result holds for the asymptote @xmath203 :    @xmath205~,\\label{vir4ec}\\end{aligned}\\ ] ]    which comes from the second term in eq .",
    "( [ fieldtot2 ] ) . the quadratic phase factor in eq .",
    "( [ vir4ec ] ) describes a spherical wavefront centered on the optical axis at the upstream edge ( the initial bend ) .",
    "the screen positioned at the downstream end of the setup detects an electric field given by the spherical wavefront in eq .",
    "( [ vir4ec ] ) from the upstream magnet at any value @xmath161{\\lambdabar r^2 } \\ll l \\ll \\gamma^2 \\lambdabar$ ] and for @xmath206{\\lambdabar / r}$ ] .",
    "note that when , additionally , @xmath207 , the quadratic phase factor in eq .",
    "( [ vir4ec ] ) can be dropped . in our cases of interest",
    "@xmath176 , which is outside the region of applicability of the two asymptotes in eq . ( [ vir4ea ] ) and eq .",
    "( [ vir4ec ] ) . however , if we are interested in imaging an electron bunch with transverse size @xmath79 we only deal with the bunch region , i.e. with the deep asymptotic region a in fig .",
    "[ halo ] , where @xmath208 . in this region ,",
    "the argument of the @xmath209 function under the integral sign in eq .",
    "( [ fieldtot2 ] ) is much smaller than unity , because @xmath210 due to the presence of the @xmath139 function under the same integral . as a result we can substitute @xmath211 $ ] with @xmath212 inside the integral",
    "then , the integration can be performed analytically .",
    "analysis of the result shows that the magnitude of the second term in eq .",
    "( [ fieldtot2 ] ) is much smaller ( of a factor of order @xmath213 ) than the first term in @xmath139 .",
    "we conclude that eq .",
    "( [ vir4ea ] ) holds within the bunch region a in fig .",
    "[ halo ] .",
    "proceeding to larger values of @xmath152 outside the bunch region a , i.e. outside the deep asymptotic region @xmath146 , and through regions b and c in fig .",
    "[ halo ] , eq .",
    "( [ vir4ea ] ) begins to be less and less accurate .",
    "however , as we will see , corrections to eq .",
    "( [ vir4ea ] ) enter only logarithmically in the calculation of the number of photons in the halo .",
    "therefore , as concerns photon number estimations , we may still use eq .",
    "( [ vir4ea ] ) in the halo region c with logarithmic accuracy .",
    "finally , let us discuss otr emission in the far - zone .",
    "fresnel propagation can be performed on eq .",
    "( [ vir4ea ] ) , yielding the following far - zone expression for the single - particle field    @xmath214 ~ , \\label{efarsum3}\\end{aligned}\\ ] ]    where @xmath215 , and @xmath37 is the distance between otr screen and observation plane .    the energy radiated per unit frequency interval per unit surface can be calculated as in @xcite . from the relation    @xmath216",
    "we have , in the far - zone :    @xmath217    one can write eq .",
    "( [ radden ] ) in terms of number of photons , giving    @xmath218    with @xmath219 the fine structure constant . here and in eq .",
    "( [ radden ] ) the superscript @xmath220 indicates that we are dealing with single particle emission .      coherent transition radiation has been introduced a long time ago into the array of beam diagnostics available for measuring the microbunching induced in sase fels in the infrared , visible and vuv regimes @xcite-@xcite .",
    "this microbunching diagnostics provides information about the longitudinal dynamics of the electron beam in the fel .",
    "there are other applications of coherent otr diagnostics .",
    "for example , recently , coherent otr imaging techniques were used for measuring the microbunching induced by the space - charge instability at different locations at lcls @xcite .",
    "all these applications are based on measuring the microbunching induced by fel or space charge interactions , effects which introduce distortions in the image formation .",
    "we explained how to avoid these effects in section [ sec : setup ] .",
    "having said this , we can apply our knowledge about the otr from a single electron to the case of an optically modulated electron bunch . in order to obtain the field from the electron bunch",
    ", a microscopic approach can be used where the single - electron field is averaged over the six - dimensional phase - space distribution of electrons . in this (",
    "lagrangian ) approach particles are labelled with a given index , and the motion of individual charges is tracked through space .",
    "one follows the evolution of each particle as a function of energy deviation @xmath221 , angular direction @xmath222 , position @xmath223 and arrival time @xmath224 at a given longitudinal reference - position . knowing the evolution of each particle , individual contributions to the field are separately calculated and summed up . due to the high - quality electron beams produced at xfels ( highly collimated and nearly monochromatic ) we have the simplest possible situation .",
    "namely , when performing otr calculations from an optically modulated electron bunch we can neglect both angular and energy distribution , and use a model of a cold electron bunch with given longitudinal , @xmath225 , and transverse , @xmath226 , charge density distributions . for a modulated electron bunch",
    "we write @xmath227 as    @xmath228 ~.\\label{ftautau}\\end{aligned}\\ ] ]    note that in general we have no factorization of the charge density distribution into longitudinal @xmath225 and transverse @xmath226 factors .",
    "however , here we will be interested in an estimate of the number of available photons and , with some accuracy , we can use a model with separable charge density distribution function .",
    "in fact , this assumption is not related to fundamental principles , and will only lead to a different numerical factor in the estimation of the number of photons .",
    "radial component of the otr field in the mirror plane , eq .",
    "( [ totalf2 ] ) , transverse ( gaussian ) charge density distribution @xmath229 , single particle field , eq .",
    "( [ vir4ea ] ) , scaling as @xmath230/(\\gamma \\lambdabar)$ ] , and its asymptote for @xmath146 scaling as @xmath231 . here",
    "the electron energy is @xmath27 gev , the electron bunch transverse rms size is @xmath232 m , the modulation wavelength is , as usual @xmath233 nm.,width=529 ]    in regions @xmath234 and @xmath235 of fig .",
    "[ halo ] we have @xmath176 , and one should use eq .",
    "( [ fieldtot2 ] ) to characterize the field . only where @xmath236 one may use the @xmath139 approximation in eq .",
    "( [ vir4ea ] ) , i.e. the ginzburg - frank approximation .",
    "however , as mentioned above , we may still use eq .",
    "( [ vir4ea ] ) in regions @xmath234 and @xmath235 with logarithmic accuracy when dealing with photon number estimations .",
    "the field distribution for the electron bunch at the otr screen in the space - frequency domain is essentially a convolution in the space domain of the temporal fourier transform of the charge density distribution and the temporal fourier transform of the single - electron field .",
    "when the charge density distribution of the electron bunch can be factorized as product of longitudinal , @xmath237 , and transverse , @xmath226 , factors , one obtains :    @xmath238    where @xmath239 is the fourier transform of the temporal charge density distribution @xmath237 .    assuming a gaussian transverse charge density distribution of the electron bunch with rms size @xmath80 , i.e. @xmath240 $ ] and substituting the single - particle otr field , eq .",
    "( [ vir4ea ] ) into eq .",
    "( [ totalf0 ] ) , we obtain    @xmath241~.\\label{totalf}\\end{aligned}\\ ] ]    eq .",
    "( [ totalf ] ) can be shown to be equivalent to    @xmath242\\int_0^\\infty d r ' \\frac{\\omega r}{\\gamma c } k_1\\left(\\frac{\\omega r'}{\\gamma c}\\right ) i_1\\left(\\frac{r r'}{\\sigma_r^2}\\right ) \\exp\\left[-\\frac{r'^2}{2 \\sigma_r^2}\\right]~,\\cr & & \\label{totalf2}\\end{aligned}\\ ] ]    where @xmath243 is the modified bessel function of the first kind .",
    "we plot the radial component of eq .",
    "( [ totalf2 ] ) in fig .",
    "[ field ] , together with the charge transverse density distribution @xmath244 , the single particle field in eq .",
    "( [ vir4ea ] ) and its asymptote proportional to @xmath231 for @xmath245 . for this example , the chosen energy is @xmath27 gev , the electron bunch transverse rms size is @xmath246 m and the modulation wavelength is , as usual , @xmath247 nm . as one can see from fig .",
    "[ field ] , outside the region b ( i.e. within regions c and d in fig . [ halo ] ) one has no more emittance effects , and emission can be considered as radiation from a filament electron bunch ( with no transverse dimensions ) .",
    "emittance effects are present within the b region and the a ( bunch ) region .",
    "they encode information about the transverse charge density distribution .",
    "note that the outer part of region b is already fitting well the filament - beam asymptote in the region @xmath146 , where it is well approximated by a @xmath231 behavior .",
    "finally , for values of @xmath248 we expect modifications of the @xmath139 behavior due to edge radiation contributions",
    ".    similarly to eq .",
    "( [ radden ] ) , we can calculate the spectral distribution of coherent photons on the otr screen by taking squared modulus of eq .",
    "( [ totalf0 ] ) . the field in the fraunhofer zone",
    "is linked to that at the otr screen position by a fourier transform .",
    "then , it can be seen that the spectral distribution of photons in the far - zone is equal to the product of the single - electron result in the far - zone , eq .",
    "( [ radden2 ] ) , @xmath249 and the squared - modulus of the structure factor    @xmath250 \\int d\\vec{l } f_l(\\vec{l } ) \\exp\\left[\\frac{i \\omega } { c } \\vec{\\xi}\\cdot \\vec{l}\\right]~,\\label{bigf}\\end{aligned}\\ ] ]    which can be expressed as    @xmath251    where @xmath239 and @xmath252 are the fourier transforms of the temporal and transverse charge density distributions ( and can be identified with the two factors in eq .",
    "( [ bigf ] ) ) .",
    "thus , one has    @xmath253    in case of a gaussian transverse charge density distribution we have :    @xmath254~ , \\label{fbarlll}\\end{aligned}\\ ] ]    a gaussian temporal electron bunch profile with an rms bunch duration @xmath61 and an amplitude of density modulation @xmath255 is also assumed .",
    "we define the function @xmath256 $ ] and , with the help of eq .",
    "( [ ftautau ] ) we obtain    @xmath257 + \\exp\\left[-\\frac{\\sigma_t^2}{2 } \\left(\\omega+\\omega_m\\right)^2\\right]\\right\\ } + \\exp\\left[-\\frac{\\sigma_t^2 \\omega^2}{2}\\right]~ , \\cr & & \\label{fbarrrr}\\end{aligned}\\ ] ]    where @xmath258 .",
    "we now apply an adiabatic approximation , which relies on the fact that the bunch duration @xmath61 is much longer than the period of the modulation . in other words , @xmath259 .",
    "this allows us to simplify eq .",
    "( [ fbarrrr ] ) as    @xmath260 ~ , \\label{fbar2}\\end{aligned}\\ ] ]    which is valid for frequencies @xmath137 around the modulation frequency @xmath32 . from eq .",
    "( [ fbar2 ] ) follows that radiation is exponentially suppressed for frequencies outside the bandwidth @xmath261 centered at the modulation frequency @xmath32 .",
    "since we are interested in coherent emission around the modulation wavelength , we can consider the wavelength in eq .",
    "( [ radden2 ] ) and eq .",
    "( [ fbarlll ] ) fixed . then , according to eq .",
    "( [ radden3 ] ) , the calculation of the angular distribution of photons emitted around @xmath32 amounts to a multiplication of eq .",
    "( [ radden2 ] ) by @xmath262 and by    @xmath263    leading to the following expression for the number of coherent otr photons emitted by an electron bunch per unit solid angle :    @xmath264~,\\label{radden4}\\end{aligned}\\ ] ]    where @xmath265 , @xmath162 being the azimuthal angle .      to estimate the total number of coherent otr photons it is sufficient to integrate eq .",
    "( [ radden4 ] ) over @xmath266 , giving    @xmath267~,\\label{radden5}\\end{aligned}\\ ] ]    where , as before , @xmath70 is the incomplete gamma function , and we defined @xmath268 .",
    "the parameter @xmath269 is analogous to a fresnel number in diffraction theory , and is the only ( dimensionless ) transverse parameter related to radiation emission in our gaussian model .    in the high energy case @xmath270 , whereas in the low energy case @xmath271 .",
    "considering @xmath272 , @xmath273 , i.e. about @xmath274 nc of charge , @xmath275 fs we obtain , for @xmath233 nm , a total number of about @xmath25 coherent photons per otr pulse into a @xmath14-nm bandwith into a @xmath3-nm bandwidth . ] .    in the limit for small values of @xmath269 one obtains the following asymptotic expression for eq .",
    "( [ radden5 ] ) :    @xmath276   ~,\\label{radden6}\\end{aligned}\\ ] ]    @xmath277 being the euler constant .",
    "the asymptote in eq .",
    "( [ radden6 ] ) can be exploited when dealing with xfel setups , because of the extreme high - quality of the electron bunch ( small emittance ) .",
    "as stated before , the electron beam size and the transverse dimension @xmath153 enter only logarithmically in the expression for the number of photons .",
    "therefore , the number of photons available is almost insensitive to the value of @xmath269 .    finally , it is interesting to estimate the number of coherent otr photons in the bunch region a , fig .",
    "[ halo ] . this can be done substituting eq .",
    "( [ totalf ] ) into eq .",
    "( [ radden0 ] ) and integrating over @xmath137 with the help of eq .",
    "( [ integrfor ] ) .",
    "this yields the energy radiated per unit surface on the otr screen .",
    "then , integrating over @xmath278 and dividing by @xmath279 yields about @xmath280 photons in the bunch region .      within the adiabatic approximation ,",
    "i.e. for @xmath281 , it makes sense to introduce an expression for the instantaneous power as a function of the peak - current @xmath282 and modulation @xmath283 .    to this purpose",
    "we consider , first , a stepped - profile model for the bunch @xmath284 for @xmath285 and zero elsewhere .",
    "we also suppose @xmath286 constant to start with .",
    "it follows that    @xmath287}{t(\\omega+\\omega_m)}+\\frac{\\sin\\left[t ( \\omega- \\omega_m)/2\\right]}{t(\\omega-\\omega_m)}\\right\\}~.\\cr & & \\label{fbarrrr2}\\end{aligned}\\ ] ]    then , in the limit for @xmath288 one has @xmath289 , and    @xmath290 \\left|\\vec{\\widetilde{e}}^{(1)}\\right|^2 ~ , \\label{pinst0}\\end{aligned}\\ ] ]    where @xmath291 power per unit surface .",
    "if now the peak - current @xmath43 and the modulation level @xmath292 are slowly varying functions of time on the scale @xmath293 , we can interpret eq .",
    "( [ pinst0 ] ) as the instantaneous power density at time @xmath39 , and with the help of eq .",
    "( [ efarsum3 ] ) we obtain the following expression for photon flux radiated into the unit solid angle :    @xmath294 ~. \\label{pinst01}\\end{aligned}\\ ] ]    eq .",
    "( [ pinst01 ] ) can be used in order to study the general case of an electron bunch with arbitrary gradient profile and amplitude of modulation .      to conclude this section",
    ", it is interesting to consider the effect of angular filtering @xcite . for mathematical simplicity ,",
    "let us introduce the angular filter profile through an amplitude transmittance @xmath295 .",
    "we choose a simple gaussian model for @xmath295 , and we write :    @xmath296~. \\label{anfil}\\end{aligned}\\ ] ]    then , the effect of angular filtering is accounted for by multiplying eq .",
    "( [ radden4 ] ) by @xmath297 , i.e. the squared of the amplitude transmittance , and by integrating over angles @xmath298 .",
    "one obtains    @xmath299~,\\label{radden5b}\\end{aligned}\\ ] ]    where @xmath300 .",
    "( [ radden5b ] ) is analogous to eq .",
    "( [ radden5 ] ) , where @xmath301 now plays the same role of the @xmath269 parameter and accounts for angular filtering effects .",
    "having characterized the radiation from an otr screen for both a single electron and an optically modulated electron bunch , we will now consider the physics of the image formation process .",
    "in particular we will discuss the otr imager setup up to the image plane where the detector is placed .",
    "a simple setup for otr imaging is schematically shown in fig .",
    "[ incotr ] .",
    "radiation is reflected by an annular mirror ( which allows the passage of the electron bunch ) and an image is formed in the image plane with the help of a converging lens . in this case , the object plane is the otr screen .    the annular - mirror design depicted in fig .",
    "[ incotr ] is usually applied in the measurement of transition radiation around the thz frequency range for longitudinal profile characterization .",
    "however , for optical frequencies ( @xmath302 m ) an important fraction of otr will be lost through the center hole .",
    "a possible solution to this problem is to avoid the use of an annular mirror as shown in fig .",
    "[ noanular ] , where a near - normal - incidence scheme is shown .",
    "note that in order to compensate for the small tilt - angle of the object plane one needs to tilt the image plane as well .",
    "the arrangement in fig .",
    "[ noanular ] is currently used for incoherent otr imaging of electron beams at lcls ( see e.g. @xcite ) .",
    "one should therefore consider the mirror design in fig .",
    "[ noanular ] , rather than that in fig .",
    "[ incotr ] .",
    "however , for the sake of simplicity of drawing , we will still refer to the non - tilted otr screen design in fig .",
    "[ incotr ] .",
    "this does not make any difference concerning the description of our methods .",
    "another optical system traditionally used for imaging purposes is the well - known two - lens image - formation scheme in fig .",
    "[ 4farr ] .",
    "this scheme allows for magnification by changing the focal distance of the second lens but for simplicity , in the following we will assume that the two focal distances are the same ( i.e. we consider @xmath303 imaging ) .",
    "this two - lens setup is usually employed for image - processing purposes , as it can be better used for image - modification compared to the single - lens system .",
    "therefore , in the following we will systematically consider the two - lens scheme in fig .",
    "[ 4farr ] instead of the single - lens scheme described in fig .",
    "[ noanular ] .     optical setup for incoherent otr imager . for high electron energies , the xfel case",
    ", an important fraction of the coherent otr radiation will be lost through the center hole of the mirror.,width=491 ]     optical setup for the near - normal - incident otr screen .",
    "the detector image plane is slightly tilted to compensate for the tilt of the object plane .",
    ", width=415 ]     a two - lens image - processing system .",
    "in order to perform fourier processing of the input signal a transparency and a polarization transformer can be inserted in the fourier plane to suitably modify the fourier transform of the object.,width=491 ]      given the two - lens setup discussed above , we first consider the relatively easy problem of characterization of single - particle radiation in the image plane .",
    "we introduce the lens transmission function    @xmath304~ , \\label{transm}\\end{aligned}\\ ] ]    where @xmath305 is the focal distance of the lens and @xmath306 is the pupil function of the lens , which may account for finite extent of the lens , apodization , aberrations and is , in general , a complex function of @xmath307 .",
    "we assume that the two lenses in fig .",
    "[ 4farr ] are identical .",
    "let us explicitly derive the field in the output ( image ) plane of the setup in fig .",
    "[ 4farr ] . in the following",
    ", it should be clear that we discuss about coherent imaging of an extended object .",
    "in fact , as we have seen in the previous section [ sec : otrsetup ] , the distribution of the otr field from a single electron is not point - like , but rather laser - like and in the xfel case its extension is macroscopic , in the millimeter scale .",
    "standard description of image formation by a lens is based on the assumption that optical systems are space - invariant , or isoplanatic @xcite . once the space - invariant condition has been assumed a linear - system treatment can be applied , which consistently considers a lens as linear filter .",
    "we recall that a linear filter is characterized by convolution equation of the form @xmath308 , where @xmath65 is the input function at the object plane , @xmath309 the impulse response and @xmath305 the output function in the image plane .",
    "imaging systems that use coherent light are linear in field amplitude , but are space invariant only under certain conditions @xcite .",
    "this means that the concept of impulse response or transfer function for coherent imaging has only a limited use .",
    "in particular , as we will see , a convolution equation of the form @xmath308 can be applied to lenses only after certain quadratic phase factors can be neglected within the field - propagation equation .",
    "then , the ( scaled ) pupil function plays the role of the amplitude transfer function for the system .    with reference to fig .",
    "[ 4farr ] we call with @xmath37 the coordinate on the optical axis , @xmath200 being the position of the object plane .",
    "thus , the position of the fourier plane is at @xmath310 , and that of the image plane is at @xmath311 .    within a paraxial treatment in the space - frequency domain , each polarization component of the field propagates in free - space from position @xmath312 to position @xmath37 according to    @xmath313 ~. \\label{fieldpropback}\\ ] ]    for each polarization component , we also introduce the spatial fourier transform of a field distribution    @xmath314~.\\label{fieldpropexpf}\\end{aligned}\\ ] ]    the propagation equation for the spatial fourier harmonics of the field in free - space is given by    @xmath315~. \\label{vecf}\\end{aligned}\\ ] ]    note that @xmath316 is the 2d spatial fourier transform , with respect to transverse coordinates , of the `` field '' @xmath317 , which is , in its turn , the temporal fourier transform of the electric field in the space - time domain . as a result , @xmath316 is actually a 3d fourier transform of the electric field in the space - time domain , with respect to time and transverse coordinates .",
    "it is , therefore , a function of the longitudinal coordinate @xmath37 .",
    "the relation between the field distribution on the pupil , @xmath318 , and the field distribution in the focal plane , @xmath319 , is given by    @xmath320}\\int d \\vec { { r}'}~ { \\widetilde{e } } ( f,\\vec { { r } ' } ) p(\\vec{r ' } ) \\exp{\\left[- \\frac{i \\omega ( \\vec{r}_f\\cdot\\vec{r'})}{c f}\\right]}~.\\label{fieldpropexpf}\\end{aligned}\\ ] ]    here @xmath321 indicates the field amplitude immediately in front of the lens .",
    "also , @xmath322 indicates the transverse position in the focal plane , i.e. at @xmath323 .",
    "use of the convolution theorem and eq .",
    "( [ vecf ] ) allow one to write eq .",
    "( [ fieldpropexpf ] ) as    @xmath324\\int d \\vec{u}~ \\mathcal{p}\\left(\\frac{\\omega \\vec{r}_f}{c f}-\\vec{u}\\right)\\cdot \\exp{\\left[- \\frac{i c f   { u}^2}{2 \\omega } \\right]}f\\left(0 , - \\vec{u}\\right)~,\\cr & & \\label{efp}\\end{aligned}\\ ] ]    where we defined    @xmath325 ~.\\label{apsfs}\\end{aligned}\\ ] ]    simple analysis , consisting of a change of variable ( @xmath326 ) followed by expansion of the quadratic phase factor in eq .",
    "( [ efp ] ) shows that the field in the focal plane , eq .",
    "( [ efp ] ) , can also be written as    @xmath327 \\mathcal{p}(\\vec{u } ) \\exp[i\\vec{u}\\cdot \\vec{r}_f]~.\\cr & & \\label{fplane}\\end{aligned}\\ ] ]    assume now that the pupil simply consists of a finite aperture .",
    "in other words ,    @xmath328    we indicate with @xmath329 the maximal transverse size of object . here and in the following",
    ", @xmath329 is the characteristic size of any object in the object plane . ] , which is a characteristic transverse scale of the problem .",
    "we also assume :    @xmath330    consider eq .",
    "( [ fplane ] ) . on the one hand ,",
    "the smallest structures in the fourier transform of the field in the object plane under the integral sign are of the order of @xmath331 , meaning that we can neglect variations of @xmath332 for frequencies @xmath333 . on the other hand",
    ", @xmath334 enters the integral sign as well , and has a width of @xmath335 .",
    "it follows that , for @xmath336 , one can neglect variations of @xmath332 in @xmath337 , and can simply take @xmath332 out of the integral sign .",
    "moreover , @xmath338 due to the width of the pupil . as a result , whenever @xmath339 the quadratic phase factor within the integral sign can be neglected and one obtains    @xmath340     left : a coherent object with characteristic size @xmath329 is spatially fourier transformed by a lens with focal length @xmath305 and an aperture of radius @xmath58 .",
    "the pupil aperture is placed directly against the lens . when the pupil aperture is much larger than a single fresnel zone , and the object size is a small fraction of the pupil size , the diffraction - limited optical system is space - invariant , i.e. isoplanatic .",
    "the concept of amplitude transfer function can be directly applied to the system , and the relation between pupil and amplitude transfer function is straightforward : the scaled pupil function plays the role of the amplitude transfer function .",
    "right : the pupil aperture is placed behind the lens in the focal plane . in this case",
    ", the pupil plays the role of a transparency , which sharply limits the range of fourier components passed by the system . under the accepted conditions ( [ bothc ] ) , left and right configurations are equivalent.,width=415 ]    as long as conditions ( [ bothc ] ) hold , it does not matter if we consider the aperture @xmath306 placed at the lens position , or at any other position between the lens and the fourier plane .",
    "this can be understood by inspecting eq .",
    "( [ fplane2 ] ) .",
    "in fact , eq . ( [ fplane2 ] ) is the same as for the case when a finite aperture is placed in the focal plane of a lens with non - limiting aperture .",
    "the situation is summed up in fig .",
    "[ sumup ] .",
    "the field in the image plane @xmath311 is obtained by taking eq .",
    "( [ fplane2 ] ) as a new object , and propagating the field through the second lens in fig .",
    "[ 4farr ] .",
    "one has    @xmath341 \\mathcal{p}(\\vec{v } ) \\exp[i\\vec{v}\\cdot \\vec{r}_i]~.\\label{iplane0}\\end{aligned}\\ ] ]    here @xmath342 indicates the transverse position in the image plane , i.e. at @xmath343 .",
    "when conditions ( [ bothc ] ) hold , one can show that eq .",
    "( [ iplane0 ] ) can be written as    @xmath344    in fact , @xmath345 , and the quadratic phase factor in eq .",
    "( [ iplane0 ] ) can be dropped due to @xmath339 . moreover , one always has @xmath346 .",
    "therefore @xmath347 , and also the linear phase factor @xmath348 can be dropped when conditions ( [ bothc ] ) hold .",
    "a further change of integration variable yields eq .",
    "( [ iplane ] ) .",
    "now , the autocorrelation integral in @xmath349 in eq .",
    "( [ iplane ] ) is equal to the fourier transform of @xmath350 done with respect to the transform variable @xmath351 .",
    "however , for our particular choice of @xmath306 , @xmath352 and the integral in @xmath349 simply equals @xmath353 . as a result    @xmath354    where we changed again @xmath355 to @xmath356 for notational reasons .",
    "the previous analysis of the field in the image plane , shows that the concept of coherent transfer function remains meaningful for diffraction - limited optical system when the pupil size is much larger than a single fresnel zone , and the physical size of the object is a small fraction of the pupil size ( see conditions ( [ bothc ] ) ) .",
    "note that both conditions ( [ bothc ] ) are satisfied in our case of single - electron imaging , because we assume that the numerical aperture is @xmath357 , @xmath358 m and @xmath359 cm .",
    "this automatically means that @xmath58 is in the centimeter scale , which is much larger than the scale of the coherent otr pattern , hence @xmath336 .",
    "also , one can see that @xmath339 .",
    "let us now consider the problem of otr pattern imaging from a single electron .",
    "first , note that eq .",
    "( [ iplane3 ] ) is valid for each polarization component . remembering eq .",
    "( [ vir4ea ] ) and its vectorial character one has    @xmath360    where @xmath361 indicates the coordinate in the object plane , and the superscript @xmath362 indicates the single - particle field . by virtue of the convolution theorem , eq .",
    "( [ iplane4 ] ) may also be written as    @xmath363 } \\int d \\vec { { r}}_f~ \\bigg\\{\\frac{2 e \\gamma^2\\vec{{r}}_f p(\\vec{r}_f)}{c   ( \\gamma^2 { r_f}^2 + { f^2 } ) } \\bigg\\}\\exp{\\left[- \\frac{i \\omega   ( \\vec{r}_i-\\vec{r}_0)\\cdot\\vec{r}_f}{c f}\\right]}~. \\label{fieldpropexpi2}\\end{aligned}\\ ] ]    thus , for our choice of pupil , and when conditions ( [ bothc ] ) hold , it does not matter if we consider the pupil aperture @xmath306 placed at the lens position , or in the fourier plane .",
    "the energy per unit frequency interval per unit surface in the image plane is given by    @xmath364    or equivalently by    @xmath365}\\right|^2~.\\label{raddenf2}\\end{aligned}\\ ] ]    eq .",
    "( [ raddenf ] ) ( or eq .",
    "( [ raddenf2 ] ) ) is the response to the single - electron source in the case when the ginzburg - frank formula is valid , when conditions ( [ bothc ] ) hold and , additionally , under the assumption of an ideal lens with a finite pupil aperture ( @xmath366 for @xmath367 and zero otherwise ) .",
    "in general , the single - particle field in the image plane , eq .",
    "( [ iplane4 ] ) ( or equivalently eq . ( [ fieldpropexpi2 ] ) ) , is non azimuthal symmetric . note that if @xmath306 is azimuthal - symmetric in the cylindrical coordinate system @xmath368 , where @xmath37 is the optical axis ( i.e. @xmath369 ) , eq .",
    "( [ raddenf2 ] ) reduces to    @xmath370    where we set @xmath371 for illustration . for an arbitrary offset @xmath361 , a generalization of eq .",
    "( [ raddenfsimm ] ) can be obtained substituting @xmath372 with @xmath373 .",
    "( [ raddenf ] ) ( or equivalently eq . ( [ raddenf2 ] ) )",
    "includes information about the optics , through @xmath374 , and about the way the electron input is converted into electromagnetic field , through the single - particle field . because of this , we will refer to @xmath375 , that is the image of otr produced by a single electron ( i.e. the impulse response for otr ) , as the _ particle spread function _ of the system .",
    "the particle spread function differs from the standard diffraction pattern from a point source , which is known in optics as the _ point spread function _ of the system and is defined as the squared modulus of the fourier transform of the pupil function .",
    "similarly , @xmath376 may be referred to as the _ amplitude particle spread function _ of the system .",
    "it should be remarked that the expressions for @xmath375 given above assume that no polarization component is selected .",
    "however , they can be easily modified to deal with such case .",
    "it is also interesting to note that for otr , the direction of the electric field depends on the transverse position ( because the field is radially polarized ) .",
    "the fact that a bessel @xmath209 function enters in eq .",
    "( [ raddenfsimm ] ) ( and not a bessel @xmath377 function as for point - source imaging ) is actually due to lack of azimuthal symmetry of the otr field .",
    "this fact is obviously responsible for a wider particle spread function .",
    "the lack of azimuthal symmetry can be better appreciated considering eq .",
    "( [ iplane4 ] ) ( or eq .",
    "( [ fieldpropexpi2 ] ) ) rather than eq .",
    "( [ raddenf ] ) ( or eq .",
    "( [ raddenf2 ] ) ) . since we are concerned with coherent imaging , the former two equations are the ones we will be actually dealing with .",
    "well defined algorithms exist for calculating the image for a complicated input signal ( i.e. an electron bunch with given transverse charge density distribution ) in the case of incoherent or coherent radiation . in both cases ,",
    "resolution of the image is strictly related to the particle spread function ( eq .",
    "( [ raddenf ] ) ) and the amplitude particle spread function ( eq .",
    "( [ iplane4 ] ) ) discussed above .",
    "let us introduce the electron density distribution of the electron bunch , @xmath378 .",
    "here we are interested , in particular , in the electron density distribution of a bunch crossing the bondary between vacuum and otr screen .",
    "let us also call @xmath379 the fourier transform of @xmath378 with respect to time .    in the coherent case ,",
    "the intensity distribution in the image plane is given by the squared modulus of the convolution of the amplitude particle spread function , eq .",
    "( [ iplane4 ] ) , with the electron beam transverse profile at frequency @xmath137 :    @xmath380    in the incoherent case , the intensity distribution in the image plane is given by an ensemble average of independent contributions of the form of the particle spread function , eq .",
    "( [ raddenf ] ) over the electron density distribution .",
    "these contributions can be ascribed to each electron , and are independent of one another .",
    "the ensemble average procedure amounts to a convolution of the particle spread function with @xmath381 therefore , one obtains :    @xmath382    note that both eq .",
    "( [ totintcoh ] ) and eq .",
    "( [ totintinc ] ) reduce to eq .",
    "( [ raddenf ] ) in the case of a single electron , i.e. for @xmath383 $ ] , where @xmath361 and @xmath384 indicate the electron offset and arrival time at a given longitudinal reference position .",
    "in practical cases of interest we will also introduce a fourier - plane mask with amplitude transmittance @xmath385 .",
    "thus , eq . ( [ fplane2 ] )",
    "is modified to    @xmath386    defining @xmath387 $ ] , one should therefore perform the substitution    @xmath388    in eq .",
    "( [ totintinc ] ) and eq .",
    "( [ totintcoh ] ) .    in both cases one needs to calculate the integral    @xmath389    which may be interpreted as a modified expression for the field accounting _ ad hoc _ for the presence of the spatial - frequency filter associated with the finite aperture of the lenses .",
    "( [ totintcoh ] ) and eq .",
    "( [ totintinc ] ) remain formally identical , but we now substitute the single particle field with @xmath390 . therefore , eq . ( [ totintinc ] )",
    "can also be written as :    @xmath391    similarly , eq .",
    "( [ totintcoh ] ) can be presented as    @xmath392      we now want to calculate the particle spread function of the system , which is essentially the radiation pattern produced by a single electron in the image plane .",
    "this is obtained from eq .",
    "( [ totintincmod ] ) or eq .",
    "( [ totintcohmod ] ) by substituting the transverse electron density distribution with a dirac @xmath194-function .",
    "discussing , for simplicity , the case @xmath393 one has    @xmath394    let us consider the simplest case when the fourier - plane mask is absent , i.e. when we account for a pupil which sharply limits the range of the fourier components passing through the system .",
    "when one deals with imaging properties , one is only interested in relative distributions of the radiation intensity . for the present discussion we are only interested in the relative distribution of the radiation intensity in the image plane . rewriting eq .",
    "( [ pasf ] ) , imaging of a single electron by a diffraction - limited , two - lens optical system gives    @xmath395    here @xmath396 .",
    "the resolution of the imaging system is related to the width of @xmath397 .",
    "the function @xmath398 is , instead , to be considered as a mathematical construct , which does not coincide with the field amplitude , being in fact the square root of the sum of the intensities along orthogonal polarization directions .",
    "the particle spread function of the system ( solid line ) , eq .",
    "( [ aaa ] ) , for @xmath233 nm and @xmath399 . the point spread function , for which @xmath400/ ( r_i \\theta_a)^2 $ ] , is shown for comparison ( dashed line).,width=415 ]    an example of the particle spread function @xmath397 for @xmath247 nm and @xmath399 is plotted in fig .",
    "[ a2 ] . in the region of interest for electron bunch imaging ,",
    "i.e. @xmath401 , the result is practically independent on the choice of @xmath93 for xfel setups . in this region ,",
    "one may approximate @xmath402 . as a result",
    "one may approximate the right hand side of eq .",
    "( [ aaa ] ) obtaining @xcite    @xmath403    where , as before , we set @xmath404 .",
    "the otr particle spread function is quite different compared with the point spread function @xmath405/ ( r_i \\theta_a)^2 $ ] for a circular pupil . in particular , as one can see from fig .",
    "[ a2 ] , in the case of the otr particle spread function the resolution is worse .",
    "finally , note that the function @xmath406 presented here does not account for the peculiar field polarization properties of otr .",
    "the same reasoning done to derive @xmath406 starting from eq .",
    "( [ pasf ] ) can be done separately considering the response to a single electron in the @xmath9 or in the @xmath10 polarization direction . in this case",
    ", one obtains the following amplitude particle spread functions for the orthogonal polarization components of the field in a cartesian coordinate system :    @xmath407    and    @xmath408      one will have the best resolution of the otr imaging system when the width of the particle spread function @xmath397 is minimized , the optimum being the point spread function , the dashed line in fig .",
    "[ imagp ] .",
    "such optimal situation is sketched in fig .",
    "[ imagp ] .",
    "once the wavelength is fixed , the resolution only depends on the numerical aperture of the system .",
    "note that , with reference to the system shown in fig .",
    "[ imagp ] , the field distribution in the focal plane is uniform , and the polarization is spatially invariant . as a result , the field in the image plane is azimuthal symmetric .",
    "it is the response of the system to a point source .    in the otr imaging case ,",
    "the situation is different , as one can see from fig .",
    "[ image ] .",
    "the very specific otr source is not point - like but , rather , laser - like with a polarization singularity . as a result , the field distribution in the focal plane is not uniform , and the direction of the electric field varies as a function of the transverse position . therefore , in our case we have two separate amplitude particle spread functions for two orthogonal polarization directions .",
    "they are not azimuthal symmetric , because they depend , respectively , on @xmath409 and @xmath410 , i.e. on cosine and sine of the azimuthal angle .",
    "therefore , in the image plane one obtains a non - azimuthal symmetric response , which worsens the resolution . only if one sums up the _ intensity _ patterns referring to the two polarization components for a single electron , one obtains an azimuthal symmetric distribution , since @xmath411 .",
    "two - lens imaging system with a point source.,width=529 ]    , width=529 ]     otr particle spread function synthesis by a fourier - plane filter and a polarization transformer.,width=529 ]     a practical arrangement of the coherent otr image - processing system.,width=491 ]    methods to improve the particle spread function for otr imager have been studied previously , e.g. in @xcite .",
    "the particle spread function is improved by selecting one polarization component of the field and by introducing a fourier filter with the help of a `` round , opaque mask placed in the back focal plane of the lens to prevent the passage of photons at angles smaller than the mask angular acceptance '' @xcite .",
    "selection of one polarization component of the field can improve the resolution in one projected direction ( @xmath9 or @xmath10 ) only , but not in both simultaneously .",
    "moreover , the other projection yields a much worse resolution .    here",
    "we propose a method to improve the particle spread function up to the best possible point spread function . our method is based on the introduction of a filter transparency ( mask ) with a particular amplitude transmittance and a polarization transformer in the fourier plane .    a sketch of the scheme is given in fig .",
    "[ ptfilt ] .",
    "use of a fourier - plane mask and a polarization transformer allows one to get back to the case shown in fig .",
    "[ imagp ] , where the field in the focal plane is uniform , and the polarization is spatially invariant . as a result ,",
    "one improves the otr particle spread function to obtain the usual point spread function .",
    "our scheme can be implemented in an otr imaging system as shown in fig .",
    "[ 4finte ] . down here",
    "we will consider in more detail the effect of both polarization transformer and amplitude mask .",
    "the function of the polarization transformer is to change the radially polarized otr into linearly polarized radiation as shown in fig .",
    "[ trasf1 ] . here",
    "we will consider , as an example of technical realization of a polarization transformer , a device recently demonstrated in @xcite .",
    "schematic plot illustrating the transformation of a radially polarized beam into a linearly polarized beam . instead of a continuous spatially varying retarder",
    ", a sectioned device can be used , where each section has different orientation of the optical axis of the half - wave plate.,width=415 ]    when a radially polarized beam passes through the transformer , each sector rotates the polarization vector by different angle . as a result , the polarization distribution just after the polarization transformer is nearly - linear .",
    "we can account for the polarization transformer in our expression for the field by replacing eq .",
    "( [ fieldpropexpi2 ] ) with    @xmath412 } \\int d \\vec { { r}}_f~ \\bigg\\{\\frac{2 e \\gamma^2 r_f p(\\vec{r}_f)}{c ( \\gamma^2 { r}_f^2 + { f^2 } ) } \\bigg\\}\\exp{\\left[- \\frac{i \\omega ( \\vec{r}_i\\cdot\\vec{r}_f)}{c f}\\right]}~ , \\label{fieldpropexpi2mod}\\end{aligned}\\ ] ]    where we set @xmath371 as before .",
    "consider now the amplitude particle spread function , eq .",
    "( [ fieldpropexpi2mod ] ) .",
    "suppose that we insert a transparency in the fourier plane , whose amplitude transmittance essentially yields an extra factor @xmath152 .",
    "in other words , we substitute @xmath413 in eq .",
    "( [ fieldpropexpi2mod ] ) with the product @xmath414 , with @xmath415 defining the a limiting aperture for the system . with the help of the cylindrical coordinate system",
    "@xmath416 we can integrate eq .",
    "( [ fieldpropexpi2mod ] ) over azimuthal coordinates , thus obtaining    @xmath417 } \\int_0^a d { r}_f~r_f^2~ t_m(r_f ) \\bigg\\{\\frac{2 e \\gamma^2 } { c ( \\gamma^2 { r}_f^2 + { f^2 } ) } \\bigg\\ } j_0\\left ( \\frac{\\omega r_i r_f}{c f}\\right)~. \\label{fieldpropexpi2mod0}\\end{aligned}\\ ] ]    let us now consider a mask characterized by    @xmath418    where @xmath419 is a common amplitude - attenuation coefficient ( equal to unity or smaller ) . in this case , assuming @xmath420 for simplicity , eq .",
    "( [ fieldpropexpi2mod0 ] ) is replaced by    @xmath421 } \\int_0^a d { r}_f~r_f^3~ \\bigg\\{\\frac{2 e \\gamma^2 } { c ( \\gamma^2 { r}_f^2 + { f^2 } ) } \\bigg\\ } j_0\\left ( \\frac{\\omega r_i r_f}{c f}\\right)~.\\label{fieldpropexpi2mod2}\\end{aligned}\\ ] ]    as noted before , in the region of interest for electron bunch imaging , i.e. @xmath422 , we can neglect the term in @xmath423 in the denominator of the integrand in eq .",
    "( [ fieldpropexpi2mod2 ] ) , which gives    @xmath424 } \\int_0^a d { r}_f~r_f~   j_0\\left ( \\frac{\\omega r_i r_f}{c f}\\right)~. \\label{fieldpropexpi2mod3}\\end{aligned}\\ ] ]    finally ) from the object plane ( @xmath200 ) to the fourier plane ( @xmath425 ) , one obtains a phase shift @xmath426 .",
    "this is the phase shift between `` impulse '' , the otr field on the screen and `` response '' , the otr field in the image plane ( the geometrical phase shift @xmath427 $ ] having already been accounted for in the relation between @xmath428 and @xmath429 ) .",
    "such phase shift represents the analogous of the gouy phase shift in laser physics . for azimuthal - symmetric beams ,",
    "the gouy phase shift is known to be @xmath430 . however , this result is not valid for eq .",
    "( [ vir4ea ] ) , where the cartesian components of the field depend on the azimuthal angle . after propagating to @xmath431 ,",
    "the result is the usual gouy phase shift @xmath430 .",
    "] ,    @xmath432 } j_1\\left(\\frac{\\omega r_i a}{c f}\\right)~. \\label{fieldpropexpi2mod4}\\end{aligned}\\ ] ]    rewriting eq .",
    "( [ fieldpropexpi2mod4 ] ) yields the well - known expression for the amplitude point spread function :    @xmath433    which is the diffraction pattern of a circular aperture , where @xmath434 , as usual , is the angular dimension of the pupil aperture .     the radial profile of the otr field from a gaussian electron bunch in the fourier plane , behind polarization transformer and linear mask.,width=453 ]    note that eq .",
    "( [ aac ] ) is only valid for some range of @xmath372 .",
    "in fact , the validity of eq .",
    "( [ aac ] ) for all values of @xmath372 would mean uniform field distribution amplitude in the fourier plane , while on the optical axis we always have zero amplitude . with our mask profile , eq .",
    "( [ tmmm ] ) , the validity region of eq .",
    "( [ aac ] ) is for @xmath435 .",
    "this corresponds to an improved pattern of the field profile in the fourier plane up to frequencies of order @xmath436 .    in principle",
    ", one may use a more complicated mask profile to improve the pattern in the fourier plane up to frequencies even much smaller than @xmath436 .",
    "yet , we can demonstrate that for the xfel case our simple choice of linear transmittance provides a sufficient accuracy .",
    "this fact is shown in fig . [ ftotr1 ] and fig .",
    "[ ftotr2 ] for the @xmath27 gev case , with @xmath437 cm and @xmath438 cm .",
    "[ ftotr1 ] shows the field profile generated by an electron bunch with transverse dimension @xmath439 m in the focal plane of the two - lens imaging system .",
    "note that the field has zero amplitude on the optical axis .",
    "this fact corresponds to deviations of the tails of the field distribution in the image plane relative to the gaussian shape , as shown in the inset fig .",
    "[ ftotr2 ] . however , as one can see , the field profile in the image plane shown in fig .",
    "[ ftotr2 ] is reproducing the bunch profile quite accurately .",
    "a gaussian fit of the field profile with a gaussian function yields @xmath440 m .",
    "the relative difference between @xmath80 and @xmath441 is thus about @xmath442 .     the radial field profile in the image plane ( solid line ) compared with the gaussian electron charge density distribution ( dotted line ) . in the inset",
    "we show the same plots on a different scale.,width=453 ]      no conventional resolution criterion can be applied for the particle spread function in eq .",
    "( [ pasf ] ) . however , with the help of our method we improved the particle spread function to obtain the ultimate resolution , so that the amplitude particle spread function is now equal to the amplitude point spread function , eq .",
    "( [ aac ] ) .    instead of dealing with the amplitude particle spread functions in eq .",
    "( [ apx ] ) and eq .",
    "( [ apy ] ) , we deal with the solution of a simple diffraction problem , where the field produced by a point source is diffracted by a circular pupil . therefore , the resolution analysis is reduced now to the theoretical framework of standard incoherent or coherent imaging theory ( see e.g. @xcite ) .",
    "one can take advantage of well - known resolution criteria like the rayleigh or sparrow criteria , or alternatively , of a formulation of the resolution problem in terms of optical transfer function ( otf ) , incoherent case or coherent transfer function ( ctf ) , coherent case .    in principle",
    ", our technique could be applied both for incoherent and coherent radiation . however , in the incoherent case , while spatial resolution improves towards the point source , limitations arise due to the small number of photons available . as a result ,",
    "the method described above is better applied for the coherent imaging case .",
    "when we deal with coherent otr imaging , limitations of techniques to improve the particle spread function due to a small number of photons can be avoided , given the much larger available photon flux .    as seen before",
    ", processing the spatial spectrum and polarization in the fourier plane allows us to reduce a vectorial problem to a scalar one , so that , instead of dealing with the amplitude particle spread functions in eq .",
    "( [ apx ] ) and eq .",
    "( [ apy ] ) we consider the scalar diffraction pattern in eq .",
    "( [ aac ] ) .",
    "thus , the imaging problem is reduced to an imaging problem for coherently radiating point sources .",
    "we note with @xcite that the rayleigh criterion is not suitable for defining the resolution in the case of coherent imaging , because it tends to underestimate the minimal distance where resolving two point sources is still possible .",
    "an acceptable resolution criterion turns out to be , instead , the sparrow criterion , stating that the minimal separation of two points on the otr screen is given by @xmath443 .",
    "this value may be compared with that given by the sparrow criterion for incoherent radiation , i.e. @xmath444 .",
    "such comparison suggests that incoherent imaging techniques would yield ( in the case of point emitters ) an ultimate resolution about @xmath445 better than that in the coherent case .",
    "however , as explained before , techniques to improve the particle spread function in the incoherent case are limited by the number of photons available .",
    "finally , it should be clear that the definition of resolution is somewhat arbitrary , as it consists in a single number , a figure of merit to be extracted according to some criterion or algorithm from the actual image .",
    "a more quantitative approach to the resolution problem would be to use the ctf representation , where the point spread function is given in terms of its spatial fourier transform .",
    "since one has    @xmath446\\right| \\propto \\mathrm{circ}\\left(\\frac{u c}{\\omega \\theta_a}\\right)~,\\label{aaccc}\\end{aligned}\\ ] ]    one recovers the result that the pupil behaves like a spatial filter .",
    "spatial frequencies up to @xmath447 are allowed to pass through the aperture without distortion , while higher frequencies are blocked .",
    "the resolution of the image of the electron bunch reduces to the standard diffraction - limited resolution of a point source .",
    "let us consider , as a numerical example , our particular case of an xfel with an ors setup .",
    "here we are dealing with coherent imaging .",
    "as shown above , an acceptable resolution criterion for the coherent imaging case is the sparrow criterion , which defines the resolution as @xmath448 . according to the sparrow criterion , for our case , i.e. for @xmath233 nm and @xmath449",
    ", we obtain @xmath450 m .",
    "it should be noted that both sparrow and rayleigh criteria can only be applied in the case of a fraunhofer diffraction pattern from a lens aperture . they can not be directly applied when one deals with a complicated otr particle spread function like that in eq .",
    "( [ aaa2 ] ) .",
    "therefore , up to now , the diffraction - limited resolution for otr imaging has been based on the estimation of an `` effective width '' of the otr particle spread function .    for example , in order to estimate the diffraction - limited resolution for the incoherent otr imager , authors of @xcite fit the particle spread function , eq .",
    "( [ aaa2 ] ) , to a gaussian function and calculate the @xmath451 width of the gaussian fit .",
    "they conclude that , for @xmath233 nm and @xmath399 , the particle - spread function given by eq .",
    "( [ aaa2 ] ) has a width of about @xmath452 m , and they consider this as a measure of the diffraction - limited resolution for their system .",
    "however , using their method , one concludes that the resolution for a point source is about three times better than what is predicted by the rayleigh criterion , which is given by @xmath453 .",
    "in fact , a resolution @xmath454 was reported in @xcite for the incoherent case and for a point - source .",
    "for example , following @xcite , one would obtain a resolution @xmath455 m , while according to the rayleigh criterion the resolution is @xmath456 m .",
    "the difference is due to the use of the width of the point spread function to define the resolution of the system in @xcite .",
    "the main result reached in this section is an optimization of the particle spread function of the system , so that the imaging problem can be reduced to the usual ( coherent or incoherent ) imaging theory for point - like radiators .",
    "this result is summarized in eq .",
    "( [ aac ] ) , presenting the amplitude particle spread function of the system after processing , which is equivalent to the amplitude point spread function .",
    "we have seen that otr pulses are intrinsically difficult to deal with , due to the presence of the polarization singularity of the otr field from a single electron , resulting in the space - variant polarization and in the singular behavior of the field amplitude .",
    "these difficulties can be avoided for instance if one uses coherent radiation emitted by a modulated electron bunch in the radiator - undulator of the ors , where the polarization is space - invariant , and the field amplitude has no singular behavior . yet , coherent undulator radiation is not suitable for imaging applications , while coherent otr is .",
    "in fact , coherent undulator radiation is highly collimated within an angle @xmath457 , @xmath20 being the undulator length , which in our case is smaller than a milliradian . therefore ,",
    "effectively , the numerical aperture of the imaging system is limited by the divergence of the undulator radiation , defining the resolution of the system . as a result",
    ", an electron bunch of a tens - micron - size can not be resolved with the help of undulator radiation .",
    "in contrast to this , the otr radiation pulse from a single electron has a non - limited angular distribution , and the resolution will only be limited by the numerical aperture of the optical system .",
    "this basic characteristics of otr plays an important role in both coherent and incoherent imaging .",
    "in the previous section we have shown that , due to the particular features of the otr source , the otr image of a single electron significantly deviates from the image of a point source .",
    "this fact causes problems concerning the measure of the charge density distribution .",
    "we demonstrated that the resolution can be improved with the help of a polarization transformer and a specific transparency in the fourier plane at the cost of reduction in photon density .",
    "techniques described in the previous section can improve the otr image from a single electron up to the standard diffraction pattern from a point source .",
    "we shall now discuss some practical aspects which are specifically related to the characterization of electron bunches in an xfel system , such as 3d electron bunch structure , signal - to - noise ratio , aberrations and alignment of mask and polarization transformer .",
    "normalized horizontal and vertical emittance as a function of the longitudinal position within the electron bunch taken from @xcite .",
    "the dashed line indicates the peak - current profile.,width=415 ]     , width=529 ]    the intensity profile in the image plane is readily calculated . in our case of interest radiation",
    "is coherent .",
    "therefore , we must convolve , in the space - frequency domain , the field given in eq .",
    "( [ fieldpropexpi2mod4 ] ) with the fourier transform of the electron density distribution @xmath379 , and take the squared modulus to get the energy radiated per unit spectral interval per unit surface    @xmath458    when dealing with xfel applications , it is important to realize that the electron - bunch slice emittance changes along the bunch , as one can see from the example shown in fig .",
    "[ emittance ] , which refers to the european xfel @xcite .",
    "note that even if the slice emittance were constant , some mismatch is always present , leading to a dependence of the electron bunch transverse size on the longitudinal coordinate ( see fig .",
    "[ blbl ] ) . a comparison of fig .",
    "[ emittance ] with fig .",
    "[ blbl ] shows that even in the part of the electron bunch where the emittance does not vary much there are significant changes in the transverse size . as a matter of fact",
    ", xfel beam formation systems will generate electron bunches that exhibit a coupling between space and time even in the case of nominal operation . as a result",
    ", optical replica pulses will also exhibit coupling between space and time , i.e. the electric field components in the space - frequency domain can not be factorized as a product @xmath459",
    ".     effect of the bandpass optical filter on recording the bandwidth - limited optical replica pulse by a single detector pixel.,width=529 ]     schematic diagram of coherent otr imaging of electron bunch without bandpass optical filter.,width=529 ]     schematic diagram of coherent otr imaging of electron bunch with bandpass optical filter .",
    "the setup with bandpass optical filtering can be used to reconstruct the ( x , y ) electron bunch projection.,width=529 ]     setup of high - resolution coherent otr imager with bandpass optical filter to reconstruct the ( x , y ) electron bunch projection.,width=453 ]    the detector automatically performs an integration over time of the intensity @xmath460 in the space - time domain , which can be extended over all times , because the detector is not fast enough to resolve a single radiation pulse .",
    "such integration over times is equivalent , due to parseval s theorem , to an integration over all frequencies of eq .",
    "( [ intba ] ) .",
    "therefore , the detector will record the energy per unit surface    @xmath461    let us define @xmath462 , as the electron density distribution of the unmodulated electron bunch . in the case of a bunch modulated with frequency @xmath32 , @xmath462 and @xmath463",
    "are linked by    @xmath464~ , \\label{duerho0}\\end{aligned}\\ ] ]    where @xmath255 is the modulation level .",
    "let us also call @xmath465 the fourier transform of @xmath466 with respect to time .",
    "since the adiabatic approximation applies , the function @xmath467 has a narrow bandwidth @xmath468 .",
    "thus , we can write @xmath469 , @xmath255 being the modulation amplitude . note that here we assume @xmath470 , an assumption justified in section [ sec : setup ] , where we discussed that the main goal of the ors setup is to produce an exact optical replica of the electron bunch .",
    "since @xmath466 is a positive function and @xmath255 is constant , the optical pulse is automatically bandwidth limited ) is actually based on the use of a weaker assumption than @xmath471 , namely @xmath472 . ] .",
    "the situation is described in the time domain by fig .",
    "[ bpfil ] ( top ) and fig . [ coima1 ] .",
    "the fact that @xmath473 , where @xmath474 , is implied by the validity of eq .",
    "( [ duerho0 ] ) with @xmath475 .",
    "note that if @xmath255 were not constant , @xmath467 would be a convolution of @xmath476 with the fourier transform of @xmath255 .    in fig .",
    "[ bpfil ] , the envelope of the optical replica pulse seen by a single pixel of the detector is shown as a function of time .",
    "this function is integrated by the detector pixel over a given temporal interval , which is longer than the duration of the pulse .",
    "as shown in fig .",
    "[ bpfil ] , the result is proportional to the time - integrated squared modulus of the amplitude of the pulse envelope . in its turn , the pulse envelope can be written as a convolution between @xmath466 and the point spread function @xmath477 , where the point spread function is calculated at @xmath478 because the adiabatic approximation holds .",
    "the detector thus records    @xmath479    which is equivalent to eq .",
    "( [ intba22 ] ) by means of parseval s theorem . neglecting",
    "the blurring one simply obtains    @xmath480    the right hand side of eq .",
    "( [ booo ] ) is an integral in time of the _ squared modulus _ of the charge density distribution , i.e. it is a _",
    "quadratic _ projection , along the temporal axis , of the charge density distribution .",
    "note that in the case of incoherent otr imaging ( still neglecting the blurring ) one would sum the intensity of all electrons independently . as a result , in order to obtain the energy absorbed by a detector pixel at a given transverse position @xmath342 , we need to sum over all the electron arrival times .",
    "therefore , the signal from each pixel will be proportional to the integral in time of @xmath481 , i.e. it is a _ linear _ projection of @xmath481 along the temporal axis .",
    "both linear and quadratic projections can be taken advantage of .",
    "they can be used for comparison with results of numerical simulations and they are both sensitive to perturbations of the transverse size of the bunch , which we need to monitor . however , also in the coherent otr imaging case it is possible to obtain the linear projection of the charge density distribution , instead of the quadratic projection , by inserting a narrow - band optical filter with bandwidth much smaller than the inverse duration of the optical pulse , and centered at the modulation frequency @xmath32 .",
    "calling with @xmath482 the filter transfer function , one obtains the following modification to eq .",
    "( [ intba22 ] )    @xmath483    due to the narrow - band nature of @xmath484 , and remembering that due to the adiabatic approximation @xmath469 , both @xmath485 and @xmath209 can be taken out of the integral in @xmath486 , thus yielding    @xmath487    in the time domain , the envelope of the optical replica pulse ( see also fig . [ bpfil ] ) coincides with the non - modulated electron density distribution , @xmath466 .",
    "one has    @xmath488    note that @xmath489 is a positive function , in contrast with the complex - valued function @xmath490 for @xmath491 .",
    "one sees that the detector just records the squared modulus of linear projection ( in time ) of the charge density distribution .",
    "the same conclusion can be reached directly in the time domain by inspecting fig .",
    "[ bpfil ] ( bottom ) and fig .",
    "[ coima2 ] .",
    "the optical - replica pulse is stretched by the optical filter to a duration of @xmath492 , with @xmath493 the duration of the original optical replica pulse .",
    "the result of this operation is another pulse whose envelope is given by the convolution between the envelope @xmath494 and the fourier transform of @xmath484 . since @xmath492 , the detector pixel sees the integrated intensity , that is just given by eq .",
    "( [ intba4b ] ) . a possible setup for high - resolution otr imaging for xfel setups including a bandpass filter is shown in fig .",
    "[ schemecoh ] . in closing , it is interesting to note that in the incoherent case one sums up intensities from single particle contributions .",
    "for example , in the case of the usual incoherent otr setup in fig .",
    "[ incotr ] ( with no image processing ) , the energy per unit surface in the image plane is given by :    @xmath495    which already presents a linear projection of the charge density distribution . from eq .",
    "( [ intba2 ] ) we see that , in the incoherent case , the spectral energy density per unit surface is proportional to @xmath496 ( neglecting the blurring ) , i.e. to the fourier transform of the charge density distribution at zero frequency .",
    "this follows from an average over ensembles . in eq .",
    "( [ intba2 ] ) , @xmath496 may also be presented as @xmath497 .",
    "then , based on eq .",
    "( [ duerho0 ] ) , which is valid in general , due to adiabatic approximation we have @xmath498 , for arbitrary modulation strength @xmath499 .      when an optical system acts as a linear , space - invariant filter for a complex field amplitude , it is referred to as isoplanatic .",
    "when a coherent optical system is isoplanatic , the effect of aberrations on its performance can be treated within the framework of a standard theory @xcite . however , in general , even aberration - free optical systems are not isoplanatic .",
    "some spatial phase distortion is unavoidably introduced , which severely modifies the intensity distribution of the image .    in section [ sec : imager ] we discussed the effect of non - isoplanatism on coherent image formation .",
    "we demonstrated that thin aberration - free lenses can only be considered as isoplanatic system if limitations ( [ bothc ] ) are satisfied .",
    "here we discuss the effect of non - isoplanatism on coherent imaging of extended objects when the thin lenses composing the optical system are no more aberration - free , and we discuss conditions when the standard isoplanatic theory can be applied .",
    "isoplanatic system in case of aberrations .",
    "when wavefront errors exist , we can imagine that a phase - shifting plate is placed at the aperture , thus deforming the wavefront .",
    "when the characteristic scale of the wavefront errors @xmath500 is much larger than a single fresnel zone , and the object scale @xmath329 is much smaller than @xmath500 , the optical system with aberrations is isoplanatic .",
    "the amplitude transfer function concept can be applied to such system and the generalized pupil function plays the role of the amplitude transfer function . in this case , left and right configurations are equivalent.,width=529 ]    consider fig .",
    "[ aberration ] .",
    "aberrations , i.e. wavefront errors , can be imagined as equivalent to a phase - shifting plate located at the aperture , which deforms the wavefront .",
    "the complex amplitude transmittance @xmath501 of the phase - shifting plate is given by    @xmath502 ~,\\label{trabe}\\end{aligned}\\ ] ]    where @xmath503 characterizes the aberration .",
    "as before , we indicate with @xmath504 the pupil function characterizing the lens aperture . the complex function @xmath505 is referred to as the generalized pupil function .    when an aberrated optical system is isoplanatic , the amplitude point spread function of the system is space - invariant , and is simply given by the fraunhofer diffraction pattern of the generalized pupil function @xmath505 , which is essentially its fourier transform .",
    "the generalized pupil function itself plays the role of the amplitude transfer function for the system . in this case , the spatial bandwidth of the amplitude transfer function is limited by the finite pupil aperture @xmath504 .",
    "the effect of aberrations consists in the introduction of phase distortions within the bandwidth of the amplitude transfer function .",
    "these phase distortions can have a severe effect on the fidelity of the imaging system .",
    "conditions for an aberrated optical system to be isoplanatic are easily derived on the basis of section [ sub : imsi ] .",
    "let us call with @xmath500 the characteristic scale of the wavefront error .",
    "suppose now that @xmath500 is much larger than a single fresnel zone , and that the object scale @xmath329 is much smaller than @xmath500 .",
    "in this case , the reasoning in section [ sub : imsi ] can be repeated replacing conditions ( [ bothc ] ) with    @xmath506    then , both eq .",
    "( [ fplane ] ) and eq .",
    "( [ iplane3 ] ) can be recovered , and the optical system is isoplanatic .    more generally , geometrical aberrations are described by the siedel wavefront representation @xcite :    @xmath507    where @xmath508 , @xmath509 , @xmath510 and @xmath511 are the amounts of defocus , spherical aberration , coma , and astigmatism .",
    "the quantities @xmath512 and @xmath513 are defined through    @xmath514    for the sake of illustration , it is interesting to discuss a particular example for the case of defocusing aberrations . in this case",
    "it is customary to introduce a quadratic phase error @xmath515 in the form    @xmath516    in eq .",
    "( [ phir2 ] ) , the characteristic scale @xmath500 is linked to the aberration strength by @xmath517 .",
    "therefore , from the second condition in ( [ bothc2 ] ) , one has @xmath518 , which means that @xmath508 should be much smaller than the number of fresnel zones on the aperture .",
    "similarly , from the first condition in ( [ bothc2 ] ) one has @xmath519 , meaning that the aberration strength should be much smaller than the ratio between the aperture area and the object area too .",
    "note that these conditions actually set criteria for the system to be isoplanatic in terms of aberration strength , diffraction , and geometrical dimension of the source compared with the pupil aperture @xmath58 .",
    "finally , note that in general , for an aberration of order @xmath41 , the aberration strength should satisfy the conditions @xmath520 and @xmath521 .    in our case of coherent otr imaging",
    ", the impact of chromatic aberrations on the system resolution can be avoided by taking advantage of the narrow bandwidth of the optical replica radiation pulse .      up to now we discussed two cases : a pupil consisting of a finite aperture only , and a pupil consisting of a finite aperture with aberrations .    in the case of a pupil without aberrations we saw , fig .",
    "[ sumup ] , that conditions ( [ bothc ] ) guarantee that the system is isoplanatic .",
    "the field in the fourier plane is the product of the fourier transform of the field at the object plane and the pupil function ( see eq .",
    "( [ fplane2 ] ) ) . based on eq .",
    "( [ fplane2 ] ) , we demonstrated that the position of the aperture can be located anywhere between lens and focal plane .",
    "introduction of a mask in the pupil .",
    "the problem is related to the so called inverse apodization . in this case",
    "the generalized pupil function @xmath522 has no characteristic size and , generally speaking , the optical system is non - isoplanatic . for coherent imaging of extended object some spatial phase distortions",
    "is introduced , which severely modifies the low ( spatial ) frequency components of the object spectrum.,width=453 ]    this reasoning was extended to the case of aberrations in the previous section [ sub : abee ] .",
    "there we saw , fig .",
    "[ aberration ] , that the same conclusions can be drawn whenever conditions ( [ bothc2 ] ) hold , which have the same mathematical structure of conditions ( [ bothc ] ) , with the only difference that they now include the characteristic scale of the wavefront error @xmath500 and not the size of the pupil aperture @xmath58 .",
    "both the problems that we discussed are related to coherent image formation theory .",
    "this knowledge can be applied to treat related technical issues .",
    "the goal of this subsection is to deal with the problem of alignment of optical elements along the optical axis . as was shown in section [ sub : lasttt ] ,",
    "[ sumup ] , a lowpass spatial frequency filter under conditions ( [ bothc ] ) is insensitive to the position of the filter ( which can be located anywhere between lens and focal plane positions ) .",
    "it is now a good time to generalize our considerations , and to examine the sensitivity to displacement of a fourier mask of particular interest .",
    "the mask that we want to consider has a profile given in eq .",
    "( [ tmmm ] ) , fig .",
    "this profile changes the shape of the optical transmission of the optical system . such changing",
    "is known in literature as apodization .",
    "our case is actually known as inverse apodization ( see e.g. @xcite ) because it suppresses the central part , and not the periphery of the optical signal .",
    "considerations made above will lead us to find isoplanatic conditions for a pupil with inverse apodization .",
    "the pupil function in this case given by the product @xmath522 .",
    "we start with eq .",
    "( [ fplane ] ) assuming that the second of conditions ( [ bothc ] ) is satisfied .",
    "this time , we analyze eq .",
    "( [ fplane ] ) in a different way . expressing @xmath523 in terms of a fourier integral , neglecting the quadratic phase factor in @xmath524 because of",
    "the second of conditions ( [ bothc ] ) , and integrating in @xmath525 we obtain    @xmath526~.\\cr & & \\label{fplaneee}\\end{aligned}\\ ] ]    now @xmath527 is our object , whose extension we estimate with the characteristic size @xmath329 .",
    "we begin by analyzing the case without mask , i.e. @xmath528 , using eq .",
    "( [ fplaneee ] ) . if also",
    "the first of conditions ( [ bothc ] ) is verified , @xmath336 , then we can have @xmath529 , meaning that the pupil is in the near zone .",
    "since @xmath530 ( otherwise the field at @xmath200 under the integral vanishes ) , due to the exponential factor in eq .",
    "( [ fplaneee ] ) , one is actually limited to the range @xmath531",
    ". then , @xmath532 , because @xmath533 .",
    "therefore , the pupil function @xmath306 can be taken out of the integral sign in eq .",
    "( [ fplaneee ] ) , meaning that it does not perturb the image of the object . in the case",
    "@xmath534 , since @xmath535 , the exponential term in eq .",
    "( [ fplaneee ] ) is of order unity for maximal values of @xmath536 .",
    "now the pupil operates as a cutoff filter , introducing a little blurring of the sharp edge on a scale @xmath537 .",
    "now let us turn back to the case a mask with inverse apodization is present .",
    "we can appreciate the difference compared to the previous case .",
    "when @xmath529 we can not take the generalized pupil function @xmath414 out of the integral sign anymore , because on the scale @xmath538 ( determined by imposing that the exponential term in eq .",
    "( [ fplaneee ] ) be at most of order unity ) we have significant variation of the generalized pupil function through @xmath539 , which does not present any characteristic scale of interest . when instead @xmath534 , we have the characteristic scale @xmath540",
    ". then , with accuracy @xmath541 we can take the generalized pupil out of the integral sign , because for these large values of @xmath542 the result of the integration changes little within excursions of @xmath530 .",
    "a qualitatively different result is reached , because low frequencies are always perturbed , while in the case of a simple pupil @xmath543 for @xmath336 .",
    "it is therefore impossible to apply the concept of amplitude transfer function to the system in fig .",
    "[ dof1 ] . in other words ,",
    "the system is not isoplanatic .",
    "note that inverse apodization is discussed in literature only in relation with incoherent imaging .",
    "if we were imaging an incoherent collection of point sources the problem of isoplanatism would not exist at all , and the autocorrelation function of the pupil actually would serve as transfer function of the system .",
    "however , this observation applies to an object consisting of an incoherent collection of point sources only , and not to the case of incoherent otr imaging , where we deal with an incoherent collection of laser - like sources . in this case",
    ", each source has a finite transverse extent , and the problem of isoplanatism exists exactly as in the coherent case .     in our case of interest ,",
    "the largest transverse electron - bunch size is small enough for its fraunhofer diffraction pattern to be formed at the pupil plane . as a result ,",
    "the most important part of the object spectrum ( mid - range and high spatial frequencies ) meet isoplanatic condition . for this range",
    "the generalized pupil function plays the role of amplitude transfer function .",
    "perturbations of low frequency components of the object spatial spectrum can only modify the intensity distribution on a scale of much larger size compared to the bunch size.,width=453 ]     when the transverse size of the electron bunch is small enough for its fraunhofer diffraction pattern to be formed at the pupil plane , mask and polarization transformer can be installed at arbitrary position within the focal distance.,width=415 ]    clearly , as soon as we consider inverse apodization for coherent imaging , the situation becomes complicated .",
    "nevertheless the isoplanatic conditions ( [ bothc2 ] ) can be satisfied for mid - range and high spatial frequencies of the object spectrum .",
    "fortunately , in the xfel case perturbations of the low spatial frequency components lead to the introduction of some background only , but not distortions in the electron - bunch image ( see fig .",
    "[ ftotr2 ] ) .    considering the specifics of our problems as illustrated in fig .",
    "[ dof2 ] , we are interested in spatial frequencies higher than @xmath544 , where @xmath329 is the largest size of interest in our object .",
    "thus , we are not interested in spatial frequencies lower than @xmath544 , which are modified by a shift in the mask position .",
    "this reasoning yields an effective scale @xmath500 on the inverse apodized pupil of order @xmath545 .",
    "such scale can be used in conditions ( [ bothc2 ] ) , which are now equivalent to    @xmath546    when condition ( [ bothc3 ] ) is satisfied , i.e. when the lens is in the far zone with respect to the object structure of size @xmath329 , conditions ( [ bothc2 ] ) are satisfied too , and one can shift the mask from the focal plane without appreciable effects .",
    "the far - zone condition ( [ bothc3 ] ) means that the transverse size of the object is much smaller than the size of the fourier pattern . intuitively , as it can be seen from fig .",
    "[ dof ] , when placed in the far - zone , the lens transforms a spherical wavefront from a point source into a plane wave . when the object has some transverse dimension @xmath329 , such that @xmath547 , one can neglect fresnel diffraction effects at the mask placed anywhere between pupil and fourier plane .",
    "thus , with accuracy @xmath548 , the wavefront behind the lens can be still considered plane and does not change at any position between lens and focal plane .    as a result , in the far zone",
    ", there is a very low sensitivity to mask and polarization - transformer displacement from the focal plane .      with the help of a polarization transformer and a fourier - plane mask , as schematically illustrated in fig .",
    "[ 4finte ] , we have seen in the previous section that spatial spectrum and polarization of otr radiation can be conveniently processed .    a schematic representation of the polarization transformer is shown in fig .",
    "[ trasf2 ] .",
    "the polarization transformer demonstrated in @xcite is composed of eight @xcite up to twelve @xcite sectors of half - wave retardation plates , each one with different orientation of the crystal s `` fast '' axis .",
    "the linear dimension of the device is of the order of a centimeter .",
    "a photonic crystal segmented half - wave - plate is the perfect radial - to - linear polarization converter for coherent otr imager . for a twelve segments device",
    ", the linear polarization purity can be as high as @xmath549 , with transformation efficiency of about @xmath550 .",
    "due to the good quality of the photonic crystal segmented half - wave - plates , the incident wavefront is negligibly perturbed .",
    "segmented half - wave plate with octonary sectors .",
    "arrows schematically show the direction of the fast axis of the crystal in each sector.,width=453 ]    both mask and polarization transformer are endowed with rotational invariance .",
    "their centers of rotation should coincide with the position of the optical axis , where the center of the fourier transform is located .",
    "the accuracy needed in the alignment of the fourier - plane mask and the polarization transformer is related to the fact that we wish to obtain a proper image within region b in fig .",
    "[ halo ] , i.e. @xmath551 m in the image plane for a focal distance @xmath552 cm .",
    "this maximal value of @xmath372 corresponds to a region in the focal plane given by @xmath553 m . within this accuracy , the electron bunch image will not be sensitive to transverse displacements of the center of the mask in the fourier - plane and of the polarization transformer with respect to the optical axis .",
    "this estimation also specifies the required manufacturing accuracy , close to the center of rotation , of the polarization transformer and of the mask in the fourier - plane , which should be in the range of about @xmath554 m .",
    "the signal - to - noise ratio of our system is strictly related to the practical resolution achievable .",
    "in fact , one has to make sure that the number of photons available are enough to allow implementation of the imaging scheme described above .    as an example , let us consider the case when the detector is a ccd camera .",
    "supposing that the ccd charge capacity is about @xmath555 electrons per pixel , and assuming a quantum efficiency of about @xmath556 , one concludes that the ccd camera will saturate at about @xmath557 photons per pixel or more .    for our particular case of coherent otr imaging , the estimated resolution according to the sparrow criterion",
    "is about @xmath558 m . because of the nyquist sampling theorem , the ccd pixel size should be about @xmath559 m .",
    "a typical ccd pixel size is about @xmath560 .",
    "thus , to resolve @xmath558 m features in the electron bunch , the magnification of the optical system should be about @xmath561 or more .",
    "choosing for simplicity the magnification @xmath562 , our zone of interest ( region b in fig .",
    "[ halo ] ) will result in an image size of @xmath563 in the image ( detector ) plane , i.e. @xmath564 pixels .",
    "similarly , the electron bunch density distribution ( region a in fig . [ halo ] ) of order of @xmath565 m is imaged into an area of about @xmath566 , i.e. @xmath567 pixels .",
    "assuming @xmath280 photons in the region of interest of the imaging system ( region b in fig .",
    "[ halo ] ) , we obtain about @xmath568 photons per pixel .",
    "the difference of four orders of magnitude beyond the saturation level of the ccd can be used to implement the particle - spread function improvement described in the previous section , which may be quite expensive in terms of photon budget .    obviously , in any case",
    ", we should make sure that no pixel on the ccd camera gets more than @xmath557 photons . from poisson statistics",
    "follows that the shot - noise level at saturation is about a fraction of a percent of the signal , i.e. the signal - to - noise ratio is a few hundreds .",
    "shot noise is the dominant cause of noise at high photon - level conditions .",
    "however , while the signal decreases , other sources of noise become important . as the photon level drops , also the shot noise level diminishes , and the ccd camera tends to become read - out - noise limited .",
    "assuming a read - out noise e.g. of order of @xmath14 electrons , a certain pixel operates in read - out - noise limited regime when the number of photons incident on that pixel is of order @xmath569 or less . at this photon level",
    "the shot - noise and the read - out noise are comparable .",
    "the signal - to - noise ratio is of order @xmath14 , and quickly decreases as the number of photons decreases .",
    "the dynamical range of our device is therefore of about @xmath127 orders of magnitude , i.e. the ratio between the full - well capacity and the read - out noise .",
    "up to now we proposed to process the particle spread function of the otr imager in order to improve the overall resolution of the system .",
    "we proposed to use coherently generated radiation but , from a fundamental viewpoint , techniques described in the previous section maybe implemented for incoherent radiation as well .",
    "the only problem using incoherent radiation is linked with the smaller number of available photons , compared to the coherent case , which makes the discussed technique unpractical . in other words ,",
    "up to now we took advantage of the coherent nature of otr in the sense that we exploited the large number of available photons .    the fact that we are dealing with coherent radiation",
    ", however , opens up new imaging possibility .",
    "namely , the detector can be directly installed in the fourier plane , and imaging from diffraction intensity measurements can be enforced .",
    "once the fourier transform of the object is known , the recovery of the image is reduced to the calculation of an inverse fourier transform .",
    "however , one can only measure the modulus of the fourier transform , and a phase - retrieval problem arises . with their algorithm @xcite , gerchberg and",
    "saxton demonstrated that numerical solutions to the two - dimensional phase retrieval problem is possible .",
    "a number of phase - retrieval algorithms were developed based on the original gerchberg - saxton algorithm .",
    "for the interested reader we refer to extensive reviews on the subject @xcite-@xcite .",
    "two issues need to be mentioned , which may affect the usefulness of the iterative phase - recovery method for our case .",
    "the first is the problem of uniqueness of the reconstructed object , the second is the speed of the algorithm , which may not be fast enough to perform coherent otr imaging at an acceptable repetition rate .    in the following",
    "we will study two cases when object and propagated field are related by a fourier transform . in the first case , the detector is placed in the focal plane of a lens . in the second , it is placed in the far ( fraunhofer ) zone of the propagated field .",
    "the lens setup allows one to control the image parameters , but it can potentially introduce aberrations .",
    "the lensless setup instead , is defined by the position of the detector only .",
    "lens - based setup for diffractive imaging of an electron bunch.,width=453 ]    let us consider the setup in fig . [ recon ] .",
    "a lens is used to obtain the fourier transform of the object in the focal plane .",
    "once the squared modulus of the fourier transform of the object is recorded , the object can be reconstructed with the help of an iterative phase - retrieval algorithm .",
    "let the object be placed in the front focal plane of the lens .",
    "the field across the back focal plane is given by eq .",
    "( [ fplane2 ] ) , where we neglect lens imperfections , and assume that conditions ( [ bothc ] ) are satisfied . by means of the convolution theorem ,",
    "the ( spatial ) fourier transform of the field in the object plane , which enters eq .",
    "( [ fplane2 ] ) , is given by the product of the fourier transform of the single - particle field and the fourier transform of the charge density distribution , @xmath570 .",
    "note that here we are discussing a 3d fourier transform , both with respect to time and space .",
    "in other words , @xmath570 is the 3d fourier transform of @xmath378 :    @xmath571\\exp[i\\omega t]~. \\label{varrhorhodef}\\end{aligned}\\ ] ]    accounting for the vectorial nature of the otr field , eq .",
    "( [ fplane2 ] ) can be written as    @xmath572     reconstruction of an object from the modulus of its fourier transform by using an iterative phase - retrieval method .",
    "for the electron - beam imager problem the a - priory constraint is the object nonnegativity . for this support phase retrieval",
    "is much easier and almost always unique .",
    "the method will open up the possibility of real - time , wavelength - limited optical imaging of electron bunches.,width=529 ]     structure of the coherent otr radiation pattern as observed in the fourier plane .",
    "parameters are as in fig .",
    "[ halo].,width=491 ]    the intensity in the fourier plane is thus given by    @xmath573    the processing of the intensity is better explained in fig .",
    "[ xy - proj ] , where the part of the scheme after the lens is zoomed - in .",
    "the detector is installed in the fourier plane .",
    "the structure of the coherent otr radiation pattern as observed in the fourier plane is shown in fig .",
    "[ zonerec ] .",
    "we are interested in the intensity distribution in the fourier plane , in contrast to the previously discussed cases when we were interested in the intensity distribution in the image plane .",
    "the situation is much simpler : in fact , eq . ( [ fplane2mody ] )",
    "consists of the product of a single - particle factor , the squared electron bunch structure factor , and the squared pupil function .",
    "this is due to the fact that the polarization of the coherent otr field in the fourier plane is radial .",
    "] , with respect to the optical axis , exactly as the polarization of a single - electron otr field .",
    "this property greatly simplifies the image processing , because we do not need a polarization transformer to deconvolve the electron bunch structure factor in the fourier plane .",
    "separation of the squared modulus of the spatial fourier transform of the charge density distribution from the squared modulus of the spatial fourier transform of the amplitude particle spread function may be done at software level , by taking the ratio of the experimental data with the ( known ) squared modulus of the spatial fourier transform of the amplitude particle spread function .",
    "an alternative possibility is to insert a filter in the fourier plane , as shown in fig .",
    "[ recon ] .",
    "the mask to be inserted has the same characteristics discussed in the previous section [ subsub : fpm ] .",
    "note that here we are considering a range of @xmath542 such that @xmath574 .",
    "this is our range of interest because the electron beam dimension @xmath575 ( see section [ sec : otrsetup ] ) is reciprocally related to the high spatial - frequency limit , so that the relativistic factor @xmath93 cancels out in eq .",
    "( [ fplane2mody ] ) .",
    "therefore , eq . ( [ fplane2mody ] ) is independent of @xmath93 , and the mask transmittance is given by @xmath539 in eq .",
    "( [ tmmm ] ) .",
    "note that here we implicitly assumed that a bandpass filter is used , as discussed in the previous section , to generate a linear integral of the signal .",
    "since such filter is tuned at @xmath32 , the intensity in the detector plane behind the mask and the bandpass filter is    @xmath576    where ( see eq .",
    "[ duerho0 ] ) @xmath577 , where @xmath578 is the spatial fourier transform of @xmath579 .",
    "the main difference to be remarked here , with respect to the discussion in the previous section , is that for diffractive imaging one needs a bandpass filter , while in the previous section one could choose between a linear or a quadratic integral projection of the signal .",
    "in fact , without a filter , one would record @xmath580 , and it would be problematic to reconstruct the structure of the electron bunch in real space . on the contrary ,",
    "once @xmath581 is measured , the solution of the phase retrieval problem yields back @xmath582 .",
    "note that the filter should have a bandwidth smaller than the bandwidth of @xmath583 .",
    "once the squared modulus of the spatial fourier transform of the electron - bunch projection along the time axis , @xmath584 , is obtained , one deals with a typical phase - retrieval problem .",
    "in fact , in order to reconstruct the object one needs to know both amplitude and phase of the diffraction field . however , the only directly - measurable quantity in the fourier plane is the intensity , which is proportional to the squared modulus of the field .",
    "determination of the missing phase from the observed intensity is known as phase - retrieval . in our case",
    ", @xmath585 must be obtained from the knowledge of @xmath586 .",
    "only when the phase of @xmath585 is known one can retrieve the object @xmath587 .",
    "the phase retrieval is typically based on an iterative transform algorithm ( ita ) @xcite , @xcite-@xcite .",
    "this cycles between real and reciprocal space , enforcing known constraints . in the reciprocal space , the known constraint is , naturally , the modulus of the fourier transform of the object .    in the real space , some generic constraints are usually granted too .",
    "first , any physical object is square - integrable .",
    "moreover , in real space , a finite support can be defined for any optical system .",
    "the support is defined as the set of points over which the object is nonzero , a finite support meaning that the object is nonzero only within a finite region of space .",
    "the shape of the object is usually required to be known in order to set the support constraint in the ita .",
    "this support is typically larger than the actual boundary of the object , in which case it is said to be loose .",
    "a method for finding an estimate of the loose support from the support of the autocorrelation function may be used .",
    "in fact , the autocorrelation of the object can be calculated from the intensity distribution in the fourier plane .",
    "hence , the support of the autocorrelation is known .",
    "then , from the support of the autocorrelation one can determine upper bounds on the support of the object , i.e. the loose support .",
    "once the loose support is constructed , the initial phase input to the iterative algorithm can be a random phase set .",
    "iteration by iteration , non - zero electron density outside the finite support is gradually pushed to zero . in the reciprocal space , the measured magnitude of the fourier transform of the object",
    "is enforced at each iteration .    since only the modulus of the fourier transform is measured",
    ", the uniqueness of the solution of the ita is a central question .",
    "when the object is complex , reconstruction is not trivial .",
    "although , usually , the ita gives good results , the uniqueness of the solution is not granted . however ,",
    "when an object is endowed with the property of nonnegativity , the application of iterative methods is drastically simplified .",
    "note that when our object is a temporal projection of @xmath588 , i.e. @xmath589 , we are dealing with a positive object , because @xmath588 is obviously a real positive function .",
    "besides the non - zero electron density outside the finite support , also the negative electron - density inside the support is pushed to zero , iteration after iteration .",
    "the ita will easily converge to the original object in the case of a two - dimensional phase - retrieval problem for positive images .",
    "reconstruction of an object from the modulus of its fourier transform using the phase - retrieval method .",
    "the object domain constraint is a low - resolution optical image . under such support",
    ", the method will open up the possibility of real - time , wavelength - limited imaging of electron bunches.,width=529 ]    when more a - priori information about the object is known , reconstruction becomes easier . in case a low - resolution image of",
    "the object is available , that image can be used as a constraint for reconstruction , and allows the ita @xcite to work much faster .",
    "this suggests the idea of combining , as illustrated in fig .",
    "[ recon2 ] , incoherent otr imaging and diffractive imaging in a single technique .",
    "one may register , as before , the squared modulus of the fourier transform of the charge density distribution with a coherent imager while , at the same time , a low - resolution image of the bunch may be taken with an incoherent imager . then , the low - resolution image can be used as a - priori information in the reconstruction process , allowing real - time , diffraction - limited resolution .",
    "an alternative application of diffractive imaging is a lensless setup .",
    "actually , lensless imaging is one of the most promising techniques for microscale imaging of an electron bunch .",
    "the high - momentum vectors available in the fraunhoffer diffraction plane can yield , in principle , wavelength - limited resolution without limitations which apply to lenses .",
    "simplest lensless setup for diffractive imaging of the electron bunch when the detector is placed in the fraunhofer diffraction plane .",
    ", width=415 ]     radiation intensity pattern in the detector plane for a lensless diffractive imaging setup with a metallic mirror as an otr screen .",
    "the problem is related to the fact that the otr halo is not small enough for its fraunhofer diffraction pattern to be formed in the detector plane . as a result",
    ", the fraunhofer diffraction pattern of the object can only be viewed with significant interference from the otr halo.,width=415 ]     image processing with an object plane mask for lensless diffractive imaging setup as possible solution of otr halo problem .",
    ", width=566 ]      in fig .",
    "[ diffim1 ] we describe a setup where one takes advantage of free - space propagation of the electric field to the object plane .",
    "ideally , detection should be performed in the fraunhofer diffraction region . however , in practical cases , the diffraction pattern from the charge density distribution overlaps with the otr halo , whose diffraction pattern may still be in the near zone , at the position of the detector plane .    with reference to fig .",
    "[ halo ] , specific regions on the otr screen are related to characteristic scales from tens of microns up to a millimeter .",
    "the far zone condition reads as @xmath590 , where @xmath329 is the characteristic object size and @xmath37 the position of the observation plane . for small features of @xmath591 m in region a , within the electron density distribution , the far - zone condition requires @xmath592 mm , but for the largest features in the halo region d we have @xmath593 , and for @xmath594 gev one needs @xmath595 m to reach the far zone , which is obviously unfeasible . in other words ,",
    "when one deals with the diffraction pattern from region d , the observation plane is in the very near zone .",
    "this fact leads to overlapping of the fraunhofer diffraction patterns of regions a and d , as shown in fig .",
    "[ diffim2r ] .",
    "in fact , consider a characteristic value @xmath596 mm for the very near zone , and @xmath597 m for the far zone .",
    "for the very near zone field , the size at the observation plane in the order of @xmath16 mm ( basically , the unvaried value of @xmath329 ) .",
    "for the far zone field one may estimate that the size in the detector plane is the coherent angle @xmath598 multiplied a typical value @xmath599 cm . as a result ,",
    "the size of the far - zone field at the observation plane is also about @xmath16 mm , hence the superposition of the two diffraction patterns , which makes difficult to practically realize the lensless diffractive - imaging setup .    a straightforward way to overcome",
    "this problem is to manipulate the distribution of the scattered field .",
    "actually , the problem is solved when the otr halo is suppressed .",
    "a square lattice of high - reflectivity metal disks with lattice parameter @xmath58 can be formed on the otr screen .",
    "the array should cover the region of interest only ( region b in fig .",
    "[ halo ] ) , which is smaller than the halo region . in this way",
    ", the electron bunch is practically sampled by the lattice of disks .",
    "the lattice parameter should be small enough , that when an electron bunch impinges on the screen one has @xmath600 , @xmath80 being the transverse rms size of the electron bunch , and @xmath601 the disk diameter .",
    "for example , an array of small disks of about @xmath602 m diameter , with separation of about @xmath603 m may be chosen , as indicated in fig .",
    "[ diffim2l ] . the ( fraunhofer ) diffraction pattern from each disk can be estimated as @xmath604 cm .",
    "therefore , it will only be limited by the aperture .",
    "in other words , with a resolution given by the numerical aperture of the system , we can consider these disks behaving like @xmath194-functions , compared to the electron - bunch scale .",
    "the fraunhofer diffraction pattern of the sampled electron bunch has now a much larger dimension compared with the original one .",
    "note that the implementation of this technique requires no optics , and does not impose stringent requirements on the detector .",
    "the field in the fraunhofer plane is given by the far - zone expression    @xmath605 \\vec{f}\\left(0,-\\frac{\\omega \\vec{r}}{c z } \\right)~ , \\label{fraunespr}\\end{aligned}\\ ] ]    where @xmath606 is the spatial fourier transform of @xmath607 ( see eq .",
    "( [ vecf ] ) ) .",
    "thus , assuming that we are sampling the field at the otr screen at positions @xmath608 , the sampled field in eq .",
    "( [ fraunespr ] ) amounts to    @xmath609~.\\label{ftsample}\\end{aligned}\\ ] ]    the problem rising due to the manipulation of the otr screen is significant . for the lensless setup we have @xmath610 proportional to the squared modulus of eq .",
    "( [ ftsample ] ) . in eq .",
    "( [ ftsample ] ) we perform a fourier transform of the electric field at the otr screen with a fixed boundary , that is the array frame . even without sampling scatters ( imagine in place of the scatter array e.g. a rectangular screen with high reflectivity and size of the order of the region b ) one has a complicated diffraction pattern for a single electron due , first , to the fixed frame profile and , second , to the vectorial properties of field . as a result",
    ", the single electron diffraction pattern can not be deconvolved anymore from the 2d fourier transform of the charge density distribution .    in this situation",
    "we should first reconstruct the field distribution on the otr screen .",
    "the complexity of the problem is now linked with the vectorial nature of the field .",
    "the squared modulus of eq .",
    "( [ ftsample ] ) actually consists in the sum of two diffraction intensity patterns from two orthogonal polarizations , and one should separately reconstruct both polarizations on the screen , i.e. field amplitude and direction .",
    "the problem can be equivalently stated considering a complex representation of the field as @xmath611 .",
    "the squared modulus of eq .",
    "( [ ftsample ] ) is the diffraction pattern from such field .",
    "thus , our problem is to recover the complex - valued function @xmath611 .",
    "note that @xmath612 .",
    "this is strongly related to two facts .",
    "first , within the ginzburg - frank theory the electric field from a single electron at the otr screen is not complex - valued .",
    "physically this means that , in this approximation , the otr field is characterized by a plane wavefront on the otr screen .",
    "second , the field on the otr screen is a convolution of the single - electron field with a positive function , the temporal projection of the electron density distribution , i.e. @xmath587 . in this case",
    ", the reconstruction of the complex - valued function @xmath611 directly presents information about the vectorial properties of the field , because the fact that @xmath611 is a complex - valued function is only related to such vectorial nature .      as usual in phase retrieval problems ,",
    "a - priori information about the object greatly enhances the efficiency of the iteration algorithm .",
    "in our case , we have a very well - defined boundary consisting in the sharp rectangular corners of the sampling grid .",
    "the grid is placed within the region b in fig .",
    "[ halo ] , meaning that all electrons are within the sampled area , and that the sampled area is completely illuminated , up to the boundary of the otr screen .",
    "thus , the edges of the grid - frame , i.e. of our object , are guaranteed to have a good contrast .",
    "this a - priori information is extremely useful as concerns the ability of reconstructing the electric field at the object plane .",
    "it is worth to restate this concept for the case described in eq .",
    "( [ ftsample ] ) .",
    "the solution of the 2d phase retrieval problem is unique , while that of the 1d problem is not .",
    "note that the fourier transform of the sampled object can be expressed in terms of a polynomial .",
    "in particular , eq . ( [ ftsample ] ) is a 2d discrete fourier transform , i.e. a 2d polynomial .",
    "the lack of uniqueness of the solution for the phase - retrieval problem is equivalent to the factorability of this polynomial . because of the fundamental theorem of algebra",
    ", the 1d phase - retrieval problem is known to present ambiguities .",
    "in contrast to this case , since polynomials in two variables are only rarely factorable , 2d sampled objects usually present a unique solution to the phase - retrieval problem .",
    "nevertheless , the reader should realize that the lensless imaging method stands on less solid ground , with respect to the lens - based setup discussed in the previous section [ sub : hr ] . in that section",
    ", we based our technique on well - known methods that can always be applied , without any problem , in the case of non - negative objects .",
    "in other words , proposals considered there are based on already experimented techniques , and will surely work without difficulties . in the present case we outlined a novel technique .",
    "we recognized a problem related to the fact that the otr halo is not small enough for its fraunhofer diffraction pattern to be formed in the detector planecm . ] . as a result ,",
    "the fraunhofer diffraction pattern of the object ( i.e. of the electron bunch ) includes significant interference from the halo .",
    "we sketched a possible solution to this problem , but we did not go deep into models and simulations .      the last step in our method consists in retrieving the charge density distribution from the knowledge of the electric field . to be specific ,",
    "since , as before , we used a bandpass filter centered at the modulation frequency @xmath32 , the electric field reconstructed by the iterative algorithm is @xmath613 .",
    "the fourier transform of the charge density distribution at @xmath614 ( i.e. @xmath615 ) is related to the field by the gauss law , and therefore    @xmath616    outside the electron bunch , the electric field has vanishing divergence .    the validity of eq .",
    "( [ gausslaw ] ) is strongly related to our analogy of the single - electron field with the field from a wire .",
    "such analogy is valid ( see eq .",
    "( [ proptoff ] ) ) for @xmath179 and , in particular , for @xmath617 , which is within the bunch region .",
    "then , our object can be expressed as a convolution between the charge density distribution ( that is , within the electrostatic analogy , the wires distribution ) and the electric field of each wire , scaling as @xmath231 .",
    "finally , it should be stressed out that the grid of scatters can be considered as a fixed reference frame .",
    "this allows to measure with high accuracy the absolute size of the electron bunch and the absolute position of its center of gravity as soon as the absolute position of the grid is known .        up to now we used coherent otr imaging techniques to obtain ( directly or after solution of a phase retrieval problem ) a projection of the charge density distribution , i.e. the time integral @xmath618 . here",
    "we will discuss how it is possible to combine diffractive imaging and direct imaging techniques to obtain the 3d electron bunch structure .    very recently in @xcite a combination of diffractive and direct imaging to obtain the spatio - temporal structure of a cylindrical - symmetric optical pulse was proposed and demonstrated . in this case , the 3d problem reduces to a 2d phase - retrieval problem .",
    "then , a spectrometer with a dispersive element could be used , rather than a plurality of bandpass filters which would have been necessary in the 3d case . the gerchberg - saxton algorithm @xcite",
    "could then be used to retrieve the phase along the spatial direction , and an independent frog measurement at a fixed transverse position allowed phase renormalization of the phases between different frequency slices .",
    "here we propose to use a similar idea for the full 3d problem .",
    "our setup records two 3d `` cubes '' of spectral data from the image both in real space and reciprocal ( i.e. spatially fourier - transformed ) space .",
    "these 3d cubes of information include two spatial dimensions and one spectral dimension in both domains .",
    "the technique is not based on a single - shot , but rather on a multi - shot measurement .",
    "the obvious requirement is , of course , the reproducibility of the 3d electron bunch density from shot to shot .",
    "a possible setup for the implementation of our method is sketched in fig .",
    "[ fgate ] .",
    "the otr signal is split by a semitransparent mirror into two parts , for the diffractive imaging , and for the direct imaging .",
    "the only difference to the setups described above for direct and diffractive imaging is that , now , the central frequency of the bandpass filter can be changed with high repetition rate , up to @xmath14 hz , that is the macropulse repetition rate of the european xfel .     combination of real and reciprocal space imaging spectrometers for characterizing the 3d electron density distribution by use of multishot measurements . , width=529 ]    due to the adiabatic approximation , the diffractive imaging setup records the distribution @xmath619 , where @xmath620 , and @xmath621 is , as usual , the shift of the central frequency of the bandpass filter from @xmath32 .",
    "the direct imaging setup records @xmath622 instead .",
    "thus , by scanning through @xmath623 , we obtain information about the modulus of the spatial fourier transform of the charge density distribution and about the modulus of the charge density distribution .",
    "both these distributions are recorded in the temporal - frequency domain , at different frequencies @xmath624 .",
    "note that , for @xmath491 , the quantity @xmath625 is not real .",
    "in other words , for each value @xmath621 , our setup records information about the modulus of the temporal fourier transform of the electron density distribution and its spatial fourier transform , but misses all information about phases .",
    "we are once more confronted with a phase retrieval problem , where we know @xmath619 , and @xmath622 , and we want to know @xmath625 ( or , equivalently , @xmath585 ) .",
    "the object to be reconstructed is now complex - valued , but we have strong a - priori information in both real and reciprocal space .",
    "the gerchberg - saxton algorithm @xcite , which was the first practical iterative algorithm to solve the fourier - phase - retrieval problem , constitutes a way to achieve the recovery of the phase from two intensity measurements in the image and in the fourier planes in an imaging system . since the introduction of the gerchberg - saxton algorithm ,",
    "numerous variations have been studied @xcite and may be possibly used instead of the original one .",
    "the gerchberg - saxton procedure gives amplitude and phase in @xmath133 ( or @xmath356 ) for each frequency .",
    "the algorithm is applied only along the spatial dimension , so that each frequency slice is independent of the other . in other words , there is a random phase jump between each frequency slice . yet , if we want to perform an inverse temporal fourier transform , we need to have information about the relative phases between different frequency slices .",
    "the setup in fig .",
    "[ fgate ] can not provide this information .",
    "it should be presented as a - priori knowledge .",
    "fortunately , this information is available from undulator optical replica synthesizer ( ors ) measurements @xcite .",
    "as discussed before , from the frog trace we can reconstruct amplitude and phase of the fourier transform of the longitudinal bunch profile . as a result ,",
    "if we integrate the charge density distribution over both transverse coordinates along a given slice , we can use the ors data as reference point for the phase and obtain the renormalized phase distribution within the slice .",
    "then , phases acquire sense , not only relative to other points within the same slice , but also relative to each point in other slices .",
    "we can then obtain the full 3d electron bunch structure by performing a final temporal fourier transform .",
    "the technique described above takes advantage of both real and reciprocal space imaging spectrometers to reconstruct the 3d complex - valued fourier transform of the electron density distribution .",
    "the major difficulty in applying this technique is that the 3d cubes of available spectral data are sliced at different frequencies , thus yielding @xmath626 in the reciprocal space , and @xmath627 in the real space .",
    "when @xmath628 , the object in real space , @xmath625 , is complex .",
    "once the phase problem is solved with the help of the gerchberg - saxton algorithm and reconstruction is done slice by slice , one still needs already available data to renormalize the relative phases between different slices .",
    "diffractive imaging spectrometer for characterizing the 3d electron density distribution by use of multishot measurements .",
    ", width=529 ]    another possible approach to obtain the full 3d electron bunch structure for a multi - shot measurement without these drawbacks makes use of a diffractive imaging spectrometer alone , as shown in fig .",
    "[ dspec ] . such setup",
    "allow to record the 3d cube of spectral data @xmath629 , which consists of less information compared to the technique described above .",
    "the method takes advantage of a different way of postprocessing the available data .",
    "for example , one can slice @xmath630 at @xmath631 in the @xmath632 plane , at @xmath633 in the @xmath634 plane , or at @xmath635 , in the @xmath636 plane .",
    "the advantage of slicing the available spectral data in this way is clear if one remembers that the iterative reconstruction algorithm aims to reconstruct e.g. @xmath637 , from the knowledge of @xmath638 . as we have seen before , the quantity @xmath637 is just the projection of @xmath639 along the temporal axis , i.e.    @xmath640    where we introduced @xmath641 as the temporal projection of @xmath588 .",
    "now we use the same relation between projections and inverse two - dimensional fourier transforms . in other words , the projections @xmath642 of @xmath588 along the @xmath9 axis , or the @xmath10 axis , defined by    @xmath643    and    @xmath644    are found by solving the phase retrieval problem for @xmath645 , or @xmath646 .",
    "an example of how such projections should look like , based on start - to - end simulations , is given in fig .",
    "[ blbl ] .",
    "one concludes that the objects to be reconstructed are , in these cases , real and non - negative . as we have seen before , this fact drastically simplifies the use of iterative reconstruction algorithms granting quick convergence .",
    "we are thus capable of recovering the three orthogonal projections of @xmath588 along @xmath39 , @xmath9 and @xmath10 .",
    "one may also recover other projections as well .",
    "for example , suppose that , instead of cutting the spectral data at @xmath633 ( or @xmath635 ) we cut it along another line , passing by the point @xmath647 but tilted of an angle @xmath648 with respect to the @xmath649 axis in clockwise sense .",
    "this means that we are simply performing a rotation    @xmath650    with respect to the new system @xmath651 , we are considering the cut @xmath652 , from which we can recover @xmath653 , which is the ( nonnegative ) projection of @xmath588 along the axis @xmath654 , where    @xmath655    obviously , we can choose whatever angle @xmath648 we like in the @xmath632 plane , but also in the @xmath636 plane , or in the @xmath656 plane . as a result we can retrieve any projection of @xmath639 on any plane in the @xmath657 space containing any of its axis .",
    "more in general , in our 3d cube of data there exists a very special point where all three frequencies @xmath621 , @xmath649 and @xmath658 are zero . we may consider any 2d plane passing through this point and reconstruct any projection in the real space - time domain under the positivity constraint .",
    "this information is sufficient to recover the 3d function @xmath639 .",
    "the method that we just proposed is a multi - shot technique operating in the 3d fourier domain , recording a 3d cube of information ( the intensity in the 3d fourier domain ) , and reconstructing the 3d real space - time electron density distribution through projections , which are recovered , in their turn , by reducing the phase - retrieval problem to the well - known 2d phase - retrieval problem under the nonnegativity constraint of the object .",
    "we name this technique `` multi - shot frodi '' ( frequency - resolved optical diffractive imaging ) .      in this section",
    "we use the new technique frequency - resolved optical diffractive imaging ( frodi ) , which was introduced above , for 3d imaging of an individual , ultrashort electron bunch . using a diffractive imaging spectrometer based on a wavelength - dispersive element ,",
    "this technique measures a 2d spectrum of a single pulse .",
    "frodi involves mapping the spatial frequency onto the transverse position , so that the relevant transverse spatial coordinate becomes the spatial - frequency axis , e.g. @xmath649 at @xmath635 .",
    "this can be accomplished with the help of a slit in the fourier plane centered on the optical axis .",
    "the temporal frequency is the other spatial coordinate , so that a detector can record the trace of a single pulse . in the previous section [ sub : mmulti ]",
    "we saw that retrieving e.g. the projection @xmath11 of the electron bunch from the trace @xmath659 is equivalent to the solution of a 2d phase - retrieval problem under non - negativity constraint .",
    "frodi allows measurements of the 3d structure of a single electron bunch .",
    "this is accomplished by splitting the optical beam and simultaneously measuring the orthogonal projections @xmath11 , @xmath12 , and @xmath13 .",
    "the respective 2d traces can be obtained on three separate detectors .",
    "thus , the method of projection considered above can be successfully applied in the single - shot case as well .",
    "the overall idea is to acquire a set of projections of the electron bunch in the @xmath660 space from a single shot , and to apply reconstruction techniques to retrieve the electron density distribution @xmath639 .",
    "a schematic of frodi , an apparatus capable of measuring three orthogonal projections of the electron density distribution for a single ultrashort electron bunch .",
    "this will allow retrieval of the full 3d structure of the electron bunch.,width=529 ]    the main difference compared with a multi - shot measurement is that we do not acquire the full spectral cube of information through the multi - shot measurements , but only a few projections , those necessary to successfully take advantage of tomographic reconstruction methods .    a possible realization of the single - shot frodi is shown in fig .",
    "[ bunchfrog ] .",
    "the otr radiation is redirected into three ( or more ) stations , where required slices of the 3d spectral cube of information are recorded . in the scheme in fig .",
    "[ bunchfrog ] we consider the three slices at @xmath633 , @xmath635 and @xmath661 .",
    "the projection along the time axis is recovered from the slices at @xmath662 .",
    "the setup used for this operation is the usual diffractive imaging spectrometer in fig .",
    "[ xy - proj ] , where the bandpass filter is tuned at @xmath662 .     beam geometry for measurements of the ( x , t ) electron bunch projection .",
    "the prism - lens combination constitutes a spectrometer.,width=453 ]     slit geometry for measuring different projections of the electron bunch with a single - shot 3d imager.,width=453 ]    the projections along the @xmath9 and @xmath10 axis are recovered from the slices at @xmath633 and @xmath635 . in order to obtain a two - dimensional trace in the @xmath634 plane ( or @xmath636 plane ) one needs a wavelength - dispersive element capable of encoding @xmath621 into the spatial transverse direction .",
    "this can be accomplished with the help of a setup like that in fig .",
    "[ xt - proj ] .",
    "the usual fourier mask is placed in the fourier plane , followed by a slit to select the slice at @xmath633 or @xmath663 . in principle",
    ", one may select other slices by tilting the slit at a given angle , as shown in fig .",
    "this is the equivalent of choosing a given angle @xmath648 in the discussion given in the previous section about the projection method .",
    "after the slit , the optical signal passes through a dispersive element , e.g. a simple prism , and the 2d trace in the @xmath634 or @xmath636 plane is subsequently recorded by a detector .",
    "all 2d traces are then used as an input for iterative retrieval algorithms , yielding back the projections of the charge density distribution @xmath639 onto the @xmath13 , the @xmath664 , and the @xmath665 plane .",
    "tomographic reconstruction follows from the knowledge of these projections .    as noted before",
    ", if more projections are needed one may extend the scheme in fig .",
    "[ bunchfrog ] including slits with different orientations .",
    "the problem of characterizing the 3d structure of an electron bunch from a single - shot measurement can now be solved by standard reconstruction techniques typical of tomography .",
    "the frodi concept proposed here is part of a new generation of electron - beam diagnostic techniques based on coherent optical light . it does not need any kind of synchronization ,",
    "is based on single - shot measurement , guarantees micron resolution , and operates in real time .",
    "demands on the detectors for the diffractive imaging case are qualitatively different from those for direct imaging . in the case of diffractive imaging , a certain structure of size @xmath329 on the object is related to a structure of size @xmath666 in the fourier plane .",
    "consider e.g. a focal distance of a few tens of centimeters .",
    "the smallest features to be distinguished on the object , of order of a few microns , correspond to structures of order of a centimeter in the fourier plane .",
    "similarly , the largest features , of order a few hundreds microns , correspond to structures of order of a hundred microns in the fourier plane .",
    "now , the irradiance on the detector decreases with @xmath667 as we move from the center to the periphery , due to the @xmath231 behavior of the spatial fourier transform of the single - particle field .",
    "as the photon density decreases , the relative importance of shot - noise increases , i.e. the signal - to - noise ratio gets worse . in particular , since shot - noise follows poisson statistics , we expect a degradation of the signal - to - noise ratio as @xmath668 .",
    "a way of avoiding this degradation is to bin the detector pixels properly ( or to use a _ ad hoc _ engineered detector with custom pixels of different shape and area ) .",
    "suppose that we bin the detector by first dividing the available area in circular sectors and then dividing again each circular sector in many radial slices of a given thickness . in this way , the area of each bin would increase quadratically with the radius , thus compensating the decrease of photon density .",
    "the number of photons per bin can be made constant by a proper binning . as a result ,",
    "the signal - to - noise ratio linked with shot - noise would not be subject to degradation anymore .",
    "a further natural development of our imaging techniques consists in the introduction of a known reference wave , transforming the previously discussed diffractive imaging setup into a setup capable of recording fourier holograms . since only one fourier transform is required to obtain digital reconstruction , fourier transform holography ( fth ) is far superior over all iterative phase retrieval methods in terms of computation time .",
    "a concept of a fth setup is sketched in fig .",
    "[ fhrecord ] ( see @xcite ) .",
    "we summarize here , for future use , the working principle of fourier holography .",
    "let us define the electric field in the object plane in the space - frequency domain @xmath669 for the object , and @xmath670 for the reference .",
    "later on we will see that in our case of interest complications are introduced by the space - variant polarization of the electric field in the object plane .",
    "however , for now we assume that @xmath671 and @xmath156 are scalar amplitudes , i.e. amplitudes of a fixed electric - field component .",
    "in the fourier plane we define @xmath672 and @xmath673 , where @xmath674 @xmath675 @xmath676 $ ] is the fourier transform of @xmath671 , and @xmath677 is similarly defined .",
    "the electric field in the fourier plane is given by the sum @xmath678 , where @xmath306 is the pupil function of the optical system , and we consider the system isoplanatic as before . since the pupil is considered as a simple circular aperture of radius @xmath58 , the pillbox function @xmath306 has the property @xmath352 as before .",
    "a detector will record a holographic pattern @xmath679 given by    @xmath680    an interference pattern is thus recorded in the fourier plane .",
    "such pattern is called a hologram .",
    "inspection of terms in eq .",
    "( [ hologram ] ) shows that the hologram is a superposition of the squared modulus of the fourier transform of the object , of the squared modulus of the fourier transform of the reference , and of interference terms .",
    "the squared modula carry no extra - information compared to what can be obtained from diffractive imaging techniques : information about the phase of the fourier transform of the object is not included there . such information is included , however , in the interference terms",
    "actually , it is fair to say that fourier holography works because the detector is a nonlinear device , yielding the squared modulus of the input amplitude , which includes interference terms .",
    "optical system used to record a fourier hologram .",
    ", width=415 ]    the field distribution of the reference wave is known .",
    "consider fig .",
    "[ fhrecord ] and suppose , which is the case for our setup , that the width of the reference source is of order of the optical wavelength of interest . then , the reference source can be considered as a point source .",
    "it follows that @xmath681 $ ] , @xmath682 being the vector position of the reference . substituting the expression for @xmath677 in eq .",
    "( [ hologram ] ) and taking the inverse fourier transform @xmath683 of the holographic pattern , one obtains    @xmath684(\\vec{r } ) & \\propto & \\mathcal{f}^{-1}\\left[p(\\vec{r}_f)\\left|\\mathcal{r}(\\omega , \\vec{r}_f)\\right|^2\\right](\\vec{r } ) + \\mathcal{f}^{-1}\\left[p(\\vec{r}_f)\\left|\\mathcal{o}(\\omega , \\vec{r}_f)\\right|^2\\right](\\vec{r } ) \\cr & & + \\int d\\vec{r ' } \\mathcal{p}^*(\\omega , \\vec{r}+\\vec{\\beta}-\\vec{r'})\\cdot { o}(\\omega , \\vec{r ' } ) \\cr & & + \\int d\\vec{r ' } \\mathcal{p}(\\omega , \\vec{r}-\\vec{\\beta}-\\vec{r'})\\cdot { o}^*(\\omega , \\vec{r ' } ) ~.\\label{hologram2}\\end{aligned}\\ ] ]    thus , with accuracy given by the dimension of the pupil aperture , the inverse fourier transform of the holographic pattern yields straightforwardly , through the interference terms , a direct image of the original object @xmath671 , and a conjugate image @xmath685 .",
    "note that such direct image is actually a convolution of the object with a specific point spread function .",
    "in fact , we always have blurring due to diffraction effects .",
    "the object and the reference source must be arranged with a separation larger than twice the object width ( this is called the fth condition ) .",
    "then , by inspection of eq .",
    "( [ hologram2 ] ) follows that the object is well - separated from the second term of eq .",
    "( [ hologram2 ] ) , which amounts to the autocorrelation function of the object .    for optical applications , the resolution of holographic techniques",
    "is not limited by size and quality of the reference source . with the help of modern lithography",
    "it is not difficult to produce an unresolved point source at optical wavelengths and let sufficiently bright radiation through it .       practical setup for fourier transform holography using a virtual reference point source .",
    ", width=453 ]    a big advantage of using fth techniques compared to diffractive imaging methods explored in section [ sec : diffite ] , is that no iteration algorithm is needed .",
    "thus , real - time , high - resolution imaging of the electron bunch is granted through fth .    a way a fth setup may be implemented",
    "is shown in fig .",
    "[ holog3 ] .",
    "it can be seen to consist of the previous diffractive imaging setup shown in fig .",
    "[ recon ] together with a reference source .",
    "the reference source is constituted by a screen with a reference pinhole illuminated by a laser pulse .",
    "the laser pulse should be synchronized to the electron bunch with sub - picosecond accuracy .",
    "the object wave and the reference wave are summed up with the help of a semitransparent mirror before the lens .",
    "note that , as was discussed before in section [ sec : diffite ] , and for the same reasons , a narrow bandpass optical filter centered at the modulation frequency is needed before the detector .",
    "a specific aspect of our case study , compared to usual fth setups , needs further investigations . as we mentioned before , we derived eq .",
    "( [ hologram2 ] ) under the assumption that @xmath671 and @xmath156 are scalar objects . in our case , however , the field distribution of the object wave in the fourier plane is radially polarized independently of the charge density distribution , as shown in fig .",
    "[ polfh ] .",
    "note that the object field distribution exhibits a complicated space - variant ( not radial ) polarization .",
    "since the setup is designed to resolve the object , we assume that the size of the fourier pattern of the object in the detector plane is much smaller compared to the available numerical aperture ( multiplied by @xmath305 ) .",
    "therefore , the fth condition is still formulated requiring that the separation between the reference source and the object should be larger than at least two times the characteristic size of the object .",
    "this means that @xmath686 should be taken larger than the object autocorrelation function in order not to superimpose the object image with the central spot .",
    "sketch of the polarization for object and reference wave in the hologram ( fourier ) plane . , width=453 ]    space - variant polarization yields difficulties when one tries to apply the fth algorithm in the usual way described above .",
    "namely , in our case , interference terms are multiplied by a factor depending on the position in the fourier plane .    to show this ,",
    "let us first introduce polar coordinates @xmath162 and @xmath542 , so that @xmath687 .",
    "supposing that the reference wave is linearly polarized along e.g. the @xmath9 direction , one has @xmath688 ( 1,0)$ ] and @xmath689 .",
    "it follows that eq .",
    "( [ hologram ] ) is modified to    @xmath690\\mathcal{o}(\\omega , \\vec{r}_f)\\cos(\\phi ) \\cr & & + p(\\vec{r}_f ) \\exp\\left[~~\\frac{i\\omega}{cf } \\vec{\\beta}\\cdot \\vec{r}_f\\right]\\mathcal{o}^*(\\omega , \\vec{r}_f)\\cos(\\phi)~.\\label{hologramb}\\end{aligned}\\ ] ]    in this case , taking the inverse fourier transform of eq .",
    "( [ hologramb ] ) would not give back eq .",
    "( [ hologram2 ] ) , due to the specific kind of position - dependent factor @xmath691 .",
    "the problem is that @xmath691 becomes zero for certain values of @xmath162 , and can be filtered out at the expenses of a reduced resolution only .",
    "schematic representation of digital fourier hologram recording and its numerical reconstruction . , width=529 ]    a possible solution",
    "consists in using a circularly polarized reference wave , instead of a linearly polarized one , fig .",
    "[ polfh ] . in this case",
    ", one has @xmath692",
    "( 1,i)$ ] . then",
    "( [ hologramb ] ) changes to    @xmath693\\mathcal{o}(\\omega , \\vec{r}_f)\\exp[i\\phi ] \\cr & & + p(\\vec{r}_f ) \\exp\\left[~ \\frac{i\\omega}{cf } ~ \\vec{\\beta}\\cdot \\vec{r}_f~\\right]\\mathcal{o}^*(\\omega , \\vec{r}_f)\\exp[-i\\phi]~. \\label{hologramc}\\end{aligned}\\ ] ]    eq .",
    "( [ hologramc ] ) includes a position - dependent factor as well .",
    "however , such factor never becomes zero , and it can be easily filtered out improving the resolution .",
    "a vortex phase mask @xmath694 $ ] can be applied , fig .",
    "[ digfh ] , for image processing purposes .",
    "note that one may choose whether to process the signal digitally , or to use additional hardware for this purpose .",
    "the same remark applies to further image processing described in the next section as well . to fix a particular case study we assume , for example ,",
    "that the vortex mask is included into the numerical image processing algorithm .",
    "applying the vortex mask one obtains    @xmath695 & \\propto & p(\\vec{r}_f)\\exp[-i\\phi]+ p(\\vec{r}_f)\\left|\\mathcal{o}(\\omega , \\vec{r}_f)\\right|^2\\exp[-i\\phi ] \\cr & & + p(\\vec{r}_f)\\exp\\left[-\\frac{i\\omega}{c f } \\vec{\\beta}\\cdot \\vec{r}_f\\right]\\mathcal{o}(\\omega , \\vec{r}_f)\\cr & & + p(\\vec{r}_f)\\exp\\left[~ \\frac{i\\omega}{cf } ~ \\vec{\\beta}\\cdot \\vec{r}_f~\\right]\\mathcal{o}^*(\\omega , \\vec{r}_f)\\exp[-2i\\phi]~. \\label{hologramc2}\\end{aligned}\\ ] ]    after taking the inverse fourier transform of the holographic pattern in eq .",
    "( [ hologramc2 ] ) , the object @xmath696 will appear again from the third term in eq .",
    "( [ hologramc2 ] ) .    because of the extra phase @xmath697 $ ] , which is now present in the first terms of eq .",
    "( [ hologramc2 ] ) , the fourier transform will be blurred , but its size can not be visibly changed because the object is assumed to have much larger size compared to the point - spread function .",
    "in fact , before multiplication by the vortex mask , the fourier transform of the object , @xmath698 , is automatically limited by the pillbox function @xmath306 , due to a finite numerical aperture of the optical system , which is unity for values of @xmath699 smaller than the numerical aperture , and zero otherwise .",
    "this pillbox function actually acts as the fourier transform of the point - spread function of the optical system . due to the presence of the vortex phase mask , the pillbox function",
    "is multiplied by the extra position - dependent phase - factor @xmath700 $ ] , and the point - spread function of the system is now given by the fourier transform of the product of the pillbox function by @xmath697 $ ] .",
    "note that here we cancelled the position - dependent phase - factor for the direct image term , thus obtaining a non - blurred image of the object , at the expense of blurring both the autocorrelation and the inverse image of the object .",
    "the analysis in @xcite , where one may find plots of the fourier transform of the product of a pillbox function and a vortex , allows to conclude that this fourier transform of the product of pillbox function and vortex is just a few times wider compared to the point - spread function ( which is the fourier transform of the pillbox only ) . as a result , after convolution with e.g. the autocorrelation function , we have practically the same size as before the convolution , and the fth condition holds .",
    "when we discussed diffractive imaging techniques in section [ sec : diffite ] we saw that the input to the phase retrieval algorithm is eq .",
    "( [ fplane2mody2 ] ) , which was obtained from eq .",
    "( [ fplane2mody ] ) through fourier filtering .",
    "note that eq .",
    "( [ fplane2mody ] ) is proportional to the squared modulus of the field at the fourier plane , eq .",
    "( [ fplane2mody0 ] ) . in our case of interest ,",
    "the fourier transform of the object , @xmath701 , coincides with eq .",
    "( [ fplane2mody0 ] ) .",
    "the difference with respect to that case is that , now , @xmath701 does not enter as a squared modulus in eq .",
    "( [ hologramc2 ] ) , but only linearly .",
    "therefore , at first glance , using the same spatial fourier filter as in the previous sections we can not optimize the image resolution anymore .",
    "however , if we properly introduce another filter after the screen with the reference source in fig .",
    "[ holog3 ] , we can optimize the image resolution and still keep the previous filter in the fourier plane . since the filter after the screen should work as a fourier filter partly countering the contribution of the filter in the fourier plane , it must be placed in the far - zone of the reference wave .",
    "if we indicate with @xmath702 the distance between the screen and the mask , and with @xmath601 the dimension of the reference source , the far - zone condition is @xmath703 .",
    "this is not a restriction .",
    "in fact @xmath704 , and the fraunhofer condition will always be satisfied behind a screen with such a pinhole .",
    "then , if we define the amplitude transmittance of the mask in the fourier plane @xmath539 , which is explicitly given by eq .",
    "( [ tmmm ] ) with @xmath705 , we should introduce a second mask with amplitude transmittance proportional to @xmath706 after the screen with the reference source .",
    "let us name such transmission function @xmath707 .",
    "the mask will be installed at some distance @xmath37 from the pinhole , in the far zone . due to the far - zone approximation ,",
    "angular openings @xmath513 are related to transverse sizes on the mask by @xmath708 .",
    "since we are only interested in @xmath709 we can set @xmath710 for @xmath711 .",
    "then , if the numerical aperture of the lens is given by @xmath712 , one can set @xmath713 for @xmath714 , with the condition @xmath715 .",
    "when this is done , given the input field    @xmath716    one can rewrite the third term in the pattern in eq .",
    "( [ hologramc2 ] ) with the help of eq .",
    "( [ fplane2mody ] ) as    @xmath695&\\propto & \\exp\\left[-\\frac{i\\omega}{c f } \\vec{\\beta}\\cdot \\vec{r}_f\\right ] \\varrho\\left(\\omega ,",
    "\\frac{\\omega \\vec{r}_f}{c f}\\right ) p(\\vec{r}_f ) ~. \\label{hologramc4}\\end{aligned}\\ ] ]    note that , as concerns the object signal , we deconvolve the electron bunch structure factor in the fourier plane .",
    "one should have a good signal - to - noise ratio , which is mandatory for success in the implementation of our scheme .",
    "such ratio is related to the manipulation of the reference source , i.e. of a laser source passing through two spatial fourier filters .",
    "the method of binning discussed in section [ sub : sn ] for increasing the signal - to - noise ratio may be taken advantage of .",
    "a natural extension of the fth imaging idea is to use the object wave to measure itself .",
    "this allows one to image the electron bunch without the need for a separate reference source .",
    "there are several approaches to self - referencing schemes in fth imaging .",
    "one version of these techniques makes use of the reference pulse which can be obtained from the object pulse itself using spatial filtering .",
    "an alternative to the scheme proposed in fig .",
    "[ holog3 ] would be , in fact , to split the optical replica pulse from the otr screen into two , and spatially filter one copy in order to obtain a reference pulse , i.e. a quasi - planar ( being spatially filtered ) wave in the detector ( fourier ) plane .",
    "this wave interferes with the second copy of the original pulse at some angle provided by the fth condition .",
    "of course , both pulses should be spectrally filtered with a narrow band - pass filter at frequency @xmath32 .",
    "note that in this geometry the object wave , i.e. the original optical - replica pulse , should be reflected a few times off mirrors and beam - splitters so that both object and reference pulses can be synchronized and combined in the detector plane .",
    "additionally , in our case the object wave should be attenuated of about two orders of magnitude to increase the contrast of the hologram .",
    "this kind of self - referencing fth schemes is based on the use of standard techniques and are widely discussed in literature , see e.g. @xcite .    in this section",
    "we consider a particular realization of self - referencing fth imaging , which is based on the use of the coherent otr halo to produce a reference wave . in this case",
    "we need to consider a relatively large size of the reference source . moreover , the reference wave has linear polarization .",
    "these facts imply the production of a lower - resolution image compared to the high - resolution image where an optimized reference source is used .",
    "however , due to the absence of an external reference source , the holographic setup turns out to be the same as for diffractive imaging .",
    "then , the low - resolution image can be used in combination with previously discussed diffractive imaging techniques .    in this way ,",
    "an implementation of fth schemes only consists in the addition of some modification in the otr screen to an already existing ( diffractive imaging ) setup , fig .",
    "[ recon ] .",
    "this is an obvious advantage , which opens up e.g. the possibility of simultaneously performing diffractive imaging and fth .",
    "for example , the original holographic pattern can be processed in parallel with eq .",
    "( [ hologramc4 ] ) .",
    "then , standard phase - retrieval techniques can be applied to the second term in eq .",
    "( [ hologram2 ] ) . the advantage of the combination of fth with iterative phase retrieval methods in x - ray applications has been already demonstrated experimentally in @xcite .",
    "setup for fourier holography , where the otr halo outside of the electron bunch profile is used to create a reference wave.,width=491 ]    a straightforward idea to implement an fth setup for low - resolution fth imaging without the help of an external laser is to take advantage of the large otr halo outside the electron bunch profile on the otr screen .",
    "a small disk with high reflectivity coefficient may be formed on the otr screen , like in fig .",
    "[ holog ] , and we also assume that the reflectivity of the entire otr screen is made lower .    the reliability of the image obtained by holography is an important advantage of fth over diffractive imaging .",
    "no iterative process is involved in the numerical reconstruction of the object image from the hologram .",
    "there are no convergence and uniqueness problems as in the iterative phase retrieval approach .",
    "however , in all fth techniques , the spatial resolution limit achievable is defined by the size of the reference source .",
    "the size of the reference source has a strong effect on the reference photon flux too .",
    "the smaller the source , the smaller the number of photons in the reference signal , the smaller the signal - to - noise ratio .",
    "thus , there is a limit to how small the size of the source can be .",
    "of course , in case an external laser is used to define a reference , one can think of focusing the laser on the reference pinhole , or to increase the power of the laser , up to some extent . in the setup in fig .",
    "[ holog ] , there is no such possibility .",
    "hence we need to consider a relatively large size of the reference source , fig .",
    "[ holog ] , which implies , in its turn , a lower - resolution image .",
    "such low - resolution image can be used , as explained before , as a strong support for diffractive imaging techniques , so that the iterative algorithm can run in real - time .",
    "however , it should be noted that since the otr halo is used to illuminate the reference source , one does not deal anymore with a circularly polarized reference wave . the electric field in the otr halo region is radially polarized .",
    "therefore , the polarization of the reference wave is linear .",
    "its direction coincides with the direction @xmath682 of the vector identifying the position of the reference scatter with respect to the center of the otr screen .    in this case one",
    "has @xmath688 \\vec{\\beta}/\\beta$ ] and @xmath717 .",
    "it follows that eq .",
    "( [ hologramb ] ) is modified to    @xmath718\\mathcal{o}(\\omega , \\vec{r}_f)~\\frac{\\vec{\\beta}\\cdot{\\vec{r}_f}}{\\beta r_f}\\cr & & + p(\\vec{r}_f ) \\exp\\left[~~\\frac{i\\omega}{cf } \\vec{\\beta}\\cdot \\vec{r}_f\\right]\\mathcal{o}^*(\\omega , \\vec{r}_f)~\\frac{\\vec{\\beta}\\cdot{\\vec{r}_f}}{\\beta r_f}~.\\label{hologrambsimp}\\end{aligned}\\ ] ]    since we want to use diffractive imaging as the main technique here , and the fth only provides a better support for the iterative algorithm , we may want to use a mask with amplitude transmittance @xmath539 given in eq .",
    "( [ tmmm ] ) in the fourier plane .",
    "however , in the case under consideration we can not use an additional mask for the reference source . as a result",
    ", we have a new situation concerning fth imaging .",
    "after the fourier mask , the third term in eq .",
    "( [ hologrambsimp ] ) reads    @xmath719 \\varrho\\left(\\omega ,",
    "\\frac{\\omega \\vec{r}_f}{c f}\\right ) p(\\vec{r}_f)~\\frac{\\vec{\\beta}\\cdot{\\vec{r}_f}}{\\beta}~. \\label{hologramc4simp}\\end{aligned}\\ ] ]    the factor @xmath720 appearing in the interference terms now yields a difference compared to the fth imaging technique described above .    taking the inverse fourier transform of eq .",
    "( [ hologramc4simp ] ) , we see that such interference term will not yield the function @xmath485 but , rather , the directional derivative of @xmath485 along the polarization direction of the reference signal , given by the unit vector @xmath721 , shifted of @xmath682 and properly scaled .",
    "this fact can be easily understood .",
    "first , we remember that , given the function @xmath722 , its directional derivative along the direction @xmath721 is given by    @xmath723    from eq .",
    "( [ dirder ] ) and from the properties of fourier transforms follows that    @xmath724(\\vec{r } ) = \\frac{i c f}{\\omega}\\vec{n}_{\\beta}\\cdot \\left\\{\\vec{\\nabla}\\mathcal{f}^{-1}\\left[f\\right](\\vec{r}_f)\\right\\}~. \\label{tfprop}\\end{aligned}\\ ] ]    thus , our method foresees the use of a known directional derivative of @xmath625 at @xmath662 as a support for diffractive image .",
    "the iterative algorithm will act on the autocorrelation term in the holographic pattern with a strong support , together with the positivity condition for @xmath587 .",
    "this should be sufficient to obtain real - time convergence of the iterative algorithm .",
    "note that the reference scatter has a high reflection coefficient . in order to provide a reflectivity contrast",
    "we should actually introduce an attenuator for the otr pulse .",
    "when we additionally introduce a mask we might end up with an insufficient photon flux in the detector plane .",
    "however , starting with diffractive imaging setups , we have a choice between two possibilities of imaging processing .",
    "we can use a transparency with amplitude transmittance as we discussed before , or we can use numerical processing . in the case of diffractive imaging and fth with external reference source",
    "we have such choice as well .",
    "since we already suppressed the otr screen reflectivity , the numerical image processing option is to be preferred . in this case , the numerical processing can be separately optimized for the fth image and for the di , which operates with the autocorrelation of the object .",
    "a natural generalization of ideas and observations in section [ sub : low ] consists in increasing the amount of a - priori information used in the iterative algorithm . in reference",
    "@xcite , a multiple reference source fth was used in the soft x - ray range to simultaneously record five images of the sample .",
    "it was demonstrated that averaging these images yields an improvement in the image quality due to enhancement of the signal - to - noise ratio .     a straightforward extension to the fourier",
    "transform holography technique is to introduce multiple reference sources .",
    "this method can be used to increase the amount of a - priori information used in iterative algorithm .",
    "the picture shows arrangement of the reference scatters on the vertices of a regular pentagon @xcite .",
    "the arrows show directions of the polarization of the otr field at the scatters .",
    "two redundant images of the bunch appear for each reference source .",
    "five independent images of the bunch can be recovered from the hologram and then used as support constraint for high resolution diffractive imaging.,width=491 ]    here we still consider the setup in fig . [ holog ] , but with several reference sources .",
    "the situation is illustrated in fig .",
    "[ holog4 ] where , for the sake of illustration , five references are considered . from each reference source",
    "one can reconstruct a directional derivative of the object .",
    "the a - priori knowledge of the ( different ) polarization directions of the field at the reference points on the otr screen can be used to retrieve the image from the hologram .",
    "one reconstructs different directional derivatives .",
    "therefore , the bunch profile can be reconstructed .",
    "note that the reconstructed fourier transform contains the autocorrelation of all reflecting structures .",
    "two redundant images of the object appear for each reference scatter .",
    "one image is the cross - correlation of the reference with the object , while the other , its complex conjugate , is located radially opposite to the origin .",
    "the autocorrelation contains five independent images of the object .",
    "the center is occupied by the autocorrelation of the object and of each reference scatter .",
    "images should tile , and not overlap on the autocorrelation .",
    "this is realized in the arrangement of the reference scatters on the vertices of a regular pentagon .",
    "it should also be noted that the previously discussed schemes using the otr halo as a reference source are particular cases of self - referencing fth measurements . in this case , the low - resolution image would serve as an input for the iterative phase retrieval algorithm , giving to the numerical algorithm a starting point closer to the real solution . in such combined approach",
    ", the larger features of the bunch are first imaged unambiguously by holography . by subsequent oversampling",
    "phasing , one can try to further improve the image resolution up to the diffraction limit .",
    "a combined fourier holography - oversampling approach has the advantage that high - resolution and real - time reconstruction can be reached simultaneously .        in section",
    "[ sec : diffite ] we proposed a technique to characterize the 3d electron density distribution taking advantage of a diffraction - imaging spectrometer , in multi - shot geometry .",
    "here we propose another technique for multishot measurement of 3d charge density distribution based on frequency - gated fourier holography .",
    "multishot measurement of the 3d structure of electron bunches by use of frequency - gated fourier transform holography.,width=529 ]    a possible realization of the method is schematically shown in fig .",
    "[ 3dmulti ] .",
    "the setup is very similar to that proposed in fig .",
    "[ holog3 ] for fourier holography imaging , except for two particulars .",
    "first , instead of a relatively long ( @xmath16 ps ) laser pulse we should use a @xmath14 fs laser pulse .",
    "second , instead of a fixed bandpass optical filter we consider an interchangeable bandpass filter with the same @xmath16 nm bandwidth , whose central frequency can be rapidly changed , with a repetition rate similar to that of the electron - bunch trains .",
    "the duration of a pulse @xmath725 is related to the spectral range @xmath726 ( in terms of wavelengths ) by @xmath727 .",
    "the laser pulse is chosen short enough so that the reference pulse has a spectral range ( about @xmath3 nm ) of the order of that associated with the minimal time scale which we are planning to resolve ( about @xmath14 fs ) .",
    "note that we do not have synchronization problem because when the combined electromagnetic disturbance from reference and object passes through the usual bandpass filter , the filter stretches it yielding a wave packet about @xmath16 ps long ( for a @xmath16 nm - bandwidth filter ) . as a result for overlapping reference and object pulses on the detector",
    "we only need sub - ps synchronization . if we now tune the bandpass filter to other frequencies , we can perform sliced measurements of @xmath627 within the predicted wide spectrum of the optical replica pulse due to varying transverse size along the electron bunch .",
    "we should reconstruct the 3d cube of data given by fourier transforming @xmath627 with respect to @xmath621 .",
    "note that , for @xmath491 , the quantity @xmath625 is not real , so we should address the problem that we can only reconstruct the relative phases in each frequency slice . yet ,",
    "if we want perform inverse temporal fourier transform we need to have information about the relative phases between slices .",
    "our setup can not provide this information .",
    "it should be presented as a - priori knowledge .",
    "the relative phases between slices can be measured using an undulator optical replica synthesizer ( ors ) @xcite .",
    "in other words , we assume that we are performing an extra frog measurement of the peak - current profile to correctly set the relative phase of each frequency - slice .",
    "is a purely linear optical scheme and does not require intense pulses .",
    "we assume that we perform an additional frog measurement over the undulator radiation in the ors setup @xcite , to define the relative phase of each fourier component . the undulator radiator in the ors setup yields energies of about a few tens microjoule per pulse , which is much more than the energy from the coherent otr pulse , and more than sufficient for frog measurements .",
    "]    we can then perform numerically , and with negligible computation time , the fourier transform of @xmath583 with respect to @xmath728 and have a high resolution image .",
    "we may note here that the possibility of reconstructing complex objects like @xmath627 is relatively recent and specific of digital recording only .",
    "we have a possibility to reconstruct taking the fourier transform of a complex object . because the reconstructed wave field is a complex function , both the intensity as well as the phase",
    "can be calculated .",
    "this is in contrast to the case of optical hologram reconstruction , in which only intensity is made visible . during many decades ,",
    "only optical reconstruction of holograms was used , and only the intensity distribution of the object was recorded .",
    "the present technique may be very attractive in practice .",
    "again , problems with iterative technique are avoided , and there are no difficulties related to synchronization for 3d characterization .",
    "the only limitation of this method is that it relies on a multishot geometry .      in the following we discuss an extension of the fth technique from the space into the space - time or , rather , into the space - frequency domain . in time - domain holography ,",
    "the reference pulse is a short pulse . during holographic recording ,",
    "the complex amplitude of the spectral component of each signal pulse is stored in a series of fringes , which arise as a result of interference with the corresponding spectral component from the reference pulse .",
    "this spectral holography technique was first proposed in @xcite , and experimentally demonstrated on the femtosecond time - scale in @xcite .",
    "a close analogy exists between fth of monochromatic waves and spectral holography of time - varying signals .",
    "this analogy results from the similarity between the equation describing spatial diffraction and temporal dispersion .",
    "spectral holography is also named by others `` spectral interferometry '' @xcite .",
    "it should be mentioned that interferometric stability is not required in our case , since this method is based on single - shot interference - pattern measurements .",
    "spectral interferometry may be coupled with spatial interferometry to preserve the spatial - phase information @xcite .    in @xcite , an extension of spatial holography and spectral interferometry into spatio - temporal holography",
    "was proposed and experimentally demonstrated , allowing for the reconstruction of the full spatio - temporal electric field from a single ultrashort laser pulse .",
    "such technique constitutes the state of the art as regards the diagnostics of ultrashort optical pulses .",
    "authors of @xcite deal with the problem of measuring an arbitrary pulse . as a result , they only use self - referencing schemes . therefore , they must take advantage of a - priori known information about the reference pulse in the temporal direction , meaning that they need frog measurement of the reference pulse after spatial filtering .",
    "since the technique is self - referencing , this requires a signal pulse with large energy .",
    "we deal , however , with a simpler situation . in our case",
    ", the optical replica pulse has a duration of @xmath729 fs , so that a laser with about @xmath14 fs - long pulses , which is available , can be used as an external reference source .",
    "therefore , there are no strict requirements on the energy of the signal pulse .",
    "multishot measurement of the 3d structure of electron bunches by use of spatio - temporal fourier transform holography.,width=529 ]    a possibility to extend fth techniques from the space to the frequency - space domain is illustrated in fig .",
    "we propose to use an imaging spectrometer with a dispersive element installed in the fourier plane of the coherent imaging system .",
    "the slit of the spectrometer is centered on the optical axis and can be rotated around the optical axis . in this way , we can record a two dimensional slice of data with spatial frequency on one axis and spectral wavelength information on the other .",
    "the reference source can be considered as a point source in the space - domain and as `` temporal point source '' , i.e. a `` short '' optical pulse in the time domain .",
    "object and reference source must be arranged in space with a separation twice larger than the object width ( this is the usual fth condition ) and must be arranged with a separation in time domain twice longer than the object pulse duration ( this is the temporal equivalent of the fth condition ) .",
    "problems with the polarization of the object are solved in the same way as for the frequency - gated fth imaging i.e. by using a circularly polarized reference pulse .",
    "the position of the slit and its relation with the polarization of the otr radiation pulse was already discussed when considering the frodi setup ( see fig .",
    "[ slit ] ) .",
    "the polarization of the otr radiation pulse will be selected by the slit orientation , and will always be linear independently of the orientation of the slit , because it is positioned in the spatial fourier plane and it is centered around the optical axis . as a result , with a circularly polarized reference source we will always have the same optimal interference for any orientation of the slit ( aside for a constant , unimportant phase in the hologram ) .",
    "this technique has the same advantages of holographic techniques .",
    "the only disadvantage is constituted by the need of additional hardware ( reference laser source ) , which is common to all frequency - gated fth techniques .",
    "however , no precise synchronization is needed : sub - ps accuracy will suffice .",
    "in fact , the only important point is that temporal separation will obey the temporal equivalent of the fth condition , also accounting for jitter . for the holographic technique to work",
    ", it does not matter if the temporal separation fluctuates from shot to shot .    similarly to frodi , this multishot geometry can be rearranged in a single shot geometry .",
    "several detection stations can be arranged to simultaneously measure few projections of the charge density distribution . moreover , as for frodi too , there is no need for a - priori information from frog measurements .",
    "the advantage with respect to frodi is that no ita is needed , which will substantially speed up the reconstruction process .      in the previous section we discussed spatio - temporal fth .",
    "this approach requires a well - characterized reference pulse . in this section",
    "we restrict our attention on self - referencing spatio - temporal fth , in which the optical replica pulse is used to measure itself .",
    "this allows one to reconstruct the 3d structure of the electron bunch without the need for a reference laser source .    in particular , in this section",
    "we discuss a method based on 2d shearing interferometry @xcite in the spatio - temporal frequency domain @xmath730 .",
    "shearing interferometry is a well - known technique for the measurement of wavefronts in the spatial domain .",
    "it operates by having the wavefront with phase function @xmath731 interfering with a test - replica of itself shifted ( laterally sheared ) along the @xmath9 axis by a distance @xmath732 .",
    "thus , at a given spatial point @xmath13 on the detector , the phase difference @xmath733 can be extracted from the measured interferogram .",
    "if @xmath732 is sufficiently small , such phase difference is proportional to the gradient @xmath734 .",
    "the unknown spatial phase @xmath731 can then be obtained ( up to an additional constant ) by integration .",
    "there is a well - known one - dimensional version of this technique to characterize ultrashort laser pulses , which is called spectral phase interferometry of the direct electric - field reconstruction ( spider ) @xcite .",
    "the spider technique uses the principle of spectral shearing interferometry to measure the spectral phase .",
    "typically , spider is based on the interference of two time - delayed replicas of the input pulse , which are also frequency - shifted by @xmath621 with the help of non - linear optical methods .",
    "the spectral gradient @xmath735 of the phase @xmath736 is then recovered from the one - dimensional interferogram .",
    "further integration yields back the phase @xmath736 .",
    "a one - dimensional shearing - interferometry setup in the temporal - frequency domain is more complicated than its spatial counterpart , because it requires non - linear optics to generate the spectral shear .",
    "however , the spider technique can be extended to allow for the reconstruction of the spatio - temporal phase from a measurement of the spatial gradient of the phase @xcite .",
    "self - referencing spatio - temporal fth concept : bs , beam splitter ; m , mirror .",
    "a michelson interferometer provides independent control of the spatial shear and delay between two copies of the input coherent otr pulse.,width=453 ]    in our case of interest , it is possible to completely characterize a slice of electric field @xmath737 as a function of @xmath137 and e.g. @xmath649 for a given @xmath635 , and subsequently scan the angle of the slice in the @xmath632 plane , corresponding to the @xmath738 plane , i.e. the fourier plane .",
    "we refer to the scheme in fig .",
    "[ spide ] .",
    "the phase @xmath739 can be measured with a spatial shearing interferometer , which generates two copies of the input field , one of which is spatially sheared by @xmath740 with respect to the other , and with relative spectral phase @xmath741 .",
    "the field at a given plane is imaged through the two arms of a michelson interferometer onto the slit of the imaging spectrometer , which is equipped with a dispersive element , so that the imaged intensity is given by    @xmath742\\right|^2~. \\label{iomux}\\end{aligned}\\ ] ]    if the fringe period due to the reference phase @xmath743 is sufficiently small , the interferometric component @xmath744 $ ] can be extracted with the help of fourier processing techniques .",
    "this can be obtained by using a temporal delay @xmath224 larger than a few times the duration of the optical replica pulse .",
    "the argument of the interferometric component is    @xmath745    through the settings of the michelson interferometer , one can control the shear @xmath740 and the delay @xmath224 .",
    "after subtraction of the reference phase from the right hand side of eq .",
    "( [ phiphi ] ) , one obtains the frequency - resolved spatial - gradient of the phase @xmath746 , which can be then integrated to give the phase @xmath747 , where @xmath748 is an arbitrary function of the frequency only .",
    "this function can be eliminated by renormalizing the phase at each @xmath137 for the fixed spatial frequency @xmath633 and @xmath635 to the phase obtained from the frog measurement of the peak - current profile in the ors undulator setup .",
    "in fact ,    @xmath749    the technique that we just described shares the same advantage of the spatio - temporal fth approach discussed in section [ sub : stf ] and , additionally , it does not need a reference laser source . the only disadvantage is constituted by the need for a - priori information from frog measurements .",
    "up to now we introduced 3d fth techniques , which operate in the fourier domain .",
    "these techniques require no special synchronization .",
    "this is one of their advantages . here",
    "we will introduce time - resolved fth techniques operating in real space - time domain , which are based on the fact that holograms record information about the object only under simultaneous illumination by a coherent reference wave @xcite .",
    "a laser capable of producing single pulses much shorter than the electron bunch is needed for time - resolved imaging .",
    "reference lasers with @xmath14-fs pulse duration are available .",
    "one of the main technical problems for time - resolved holography is the synchronization between reference and optical pulses .",
    "here we propose a way of getting around this obstacle by shifting the attention from the problem of synchronization to the problem of measurement of the slice peak - current .",
    "consider fig .",
    "[ currxfel ] , which shows the foreseen longitudinal bunch profile ( cited from @xcite ) . due to the strong non - linear dependence of the fel process on the peak - current ,",
    "only the central part is suitable for lasing .",
    "peak - current profile at the entrance of the sase undulator ( after xfel tdr ) .",
    ", width=415 ]     time - gated fth setup for imaging the slice of electron bunch with maximal peak - current .",
    "since the integral of the image of the electron bunch density distribution is known , the slice with maximal peak - current can be uniquely determined even when time jitter is present .",
    ", width=529 ]     sketch of principle for time - gated fth - imaging of the bunch slice with maximal peak - current .",
    ", width=491 ]    it is therefore of special interest to develop techniques capable of imaging the slice with maximal peak - current , with a typical width of about @xmath559 m ( or @xmath750fs ) .",
    "the setup of the proposed time - gated fth technique is shown in fig .",
    "[ sliceim2 ] .",
    "the method is based , as before , on the fourier transform holography .",
    "the idea is to use a very short reference laser pulse of the order of @xmath14 fs , i.e. the slice longitudinal dimension , in order to obtain contributions to the interference terms in the hologram from a single slicem up to the limit for projected emittance , depending on the reference pulse length . ] within the electron bunch .",
    "in contrast to the frequency - gated fth , no spectral filter is used ) can be replaced by numerical image processing before reconstruction . ] , so that the reference and the optical replica are not easily synchronized in the hologram plane .",
    "in fact , both optical replica and reference laser pulse are subject to time jitter in the order of @xmath729 fs , and sub - picosecond synchronization does not guarantee that the reference pulse overlaps with the maximum of the optical replica pulse in the hologram plane . in order to solve this problem",
    "one needs to discriminate the slice with maximal peak - current within the electron bunch from the rest of the beam .",
    "the duration @xmath751 fs of the reference pulse is relatively long due to the applicability of the adiabatic approximation , as @xmath752 at our selected optical wavelength , and it is relatively short compared to the electron bunch duration , as @xmath753 .",
    "setup for recording image of bunch slice with maximal peak - current using ultrashort seed laser pulse for optical replica synthesizer .",
    ", width=529 ]    a method for imaging the bunch slice with maximal peak - current is illustrated in fig .",
    "[ slicimfin ] . the hologram records information about the object only when it is illuminated with the coherent reference wave .",
    "one of the main technical problems for time resolved holography techniques is the relative synchronization of the reference laser pulse and the optical replica pulse from the otr screen .",
    "in fact , both optical replica and reference laser pulses are subject to time jitter .",
    "as mentioned above , we shift the attention from the problem of synchronization to the problem of measurement of the peak - current of the slice .",
    "if a relative peak - current is known for each slice , a sorting of results according to peak - current measurements uniquely gives the slice with maximal peak - current without knowledge of the delay between reference and object pulses .",
    "another technique closely related to the time - gated method for imaging of the electron bunch with maximal peak - current is shown in fig .",
    "[ slirec ] .",
    "the idea is to use a very short ( order of @xmath14 fs ) reference laser pulse in order to obtain the contribution from a single slice within the electron bunch ( see @xcite ) .",
    "as before , the arrival times between the laser pulse and electron bunches jitter from shot to shot . in the case of fig .",
    "[ slirec ] , we have the additional possibility to control the slice peak - current using a bolometer , i.e. measuring the total charge in the modulated slice on a shot - to - shot basis .",
    "subsequently , the acquisition system will discriminate the slice with maximal peak - current . in this case ,",
    "angular filtering of coherent otr is needed before the bolometer in order to select the halo part , whose energy - per - pulse does not depend on the transverse size of the electron bunch .",
    "simple method for solution of the double - valued ( peak - current ) function problem in multi - shot 3d electron bunch fth imaging .",
    "the reference laser pulse is split into two parts , where one is delayed with respect to the other of about half electron bunch duration .",
    "both pulses are passed through different quarter wave plates and as a result have different chirality .",
    "the pulses are recombined before being sent onto the focusing optics ( see fig .",
    "[ sliceim2 ] ) .",
    ", width=453 ]    the time - gated fth technique for imaging the electron - bunch slice with maximal peak - current can be extended to a scheme to provide the 3d image of the electron bunch in a multi - shot geometry .",
    "the idea exploits the jitter between the reference ( laser ) pulse and the electron bunch , i.e. the optical replica pulse .",
    "in fact , due to the presence of jitter , not only the slice with maximal peak - current will be recorded .",
    "the main problem is to discriminate , shot by shot , the longitudinal position of the slice in order to reconstruct the 3d image of the electron bunch .",
    "one can measure the peak - current of the slice as discussed before , with reference to fig .",
    "[ sliceim2 ] , but there is always an ambiguity on whether a slice with a given peak - current is located before or after the slice with maximal peak - current . in other words , with the exception of the slice with maximal peak - current , we have a difficulty with a double - valued function ( peak - current as a function of position ) for other peak - current values .    here",
    "we propose a solution to this problem with the help of a double reference pulse , which may be produced as shown in fig .",
    "[ chira1 ] .",
    "a @xmath14-fs linearly polarized laser pulse is first split into two identical pulses .",
    "the polarization of these pulses is changed from linear to circular with the help of two different quarter - wave plates , emerging with different chirality .",
    "finally , one of the two pulses passes through a delay stage of about half electron bunch duration or more before being sent to the focusing optics of the fth setup ( see fig .",
    "[ sliceim2 ] ) , so that one obtains two @xmath14-fs reference pulses with opposite chirality delayed of about @xmath3 fs as shown in fig .",
    "[ chira2 ] ) , left .",
    "schematic representation of 3d multi - shot measurements in a time - resolved fth setup . left : time diagram of the reference wave .",
    "right : temporal profiles as they appear in the hologram plane .",
    "the new method attempts to get around the jitter obstacle , by measuring the slice peak - current .",
    "if the relative peak - current is known for each slice , sorting the results according to the vortex sign at the central ( low spatial frequency ) region of the hologram uniquely gives the position of the slice within the electron bunch.,width=453 ]    we should now be able to distinguish among the three situations shown on the right of fig .",
    "[ chira2 ] . when this is accomplished , the 3d reconstruction can be successfully performed . due to the particular delay choice",
    ", there are no other beam geometries to be studied .",
    "the idea is to distinguish among the three situations on the right of fig .",
    "[ chira2 ] by studying the low - frequency part of the hologram , related to the halo regions c and d in fig .",
    "[ halo ] . in these regions ,",
    "the hologram shape will not depend on the transverse electron density distribution .",
    "use of numerical post - processing deconvolution ( instead of using two masks as in fig .",
    "[ sliceim2 ] ) will serve our purpose here .",
    "holographic patterns corresponding to ( a ) chirality @xmath754 of the reference , ( b ) chirality @xmath755 of the reference and ( c ) sum of the previous two cases.,width=491 ]    the shape of such kind of holograms `` is characterized by nearly parallel '' fringes , `` except for a forking pattern in the vicinity of the core '' @xcite , as shown in the example of fig .",
    "[ forks ] . for chirality @xmath754 ( bottom case on the right of fig .",
    "[ chira2 ] , corresponding to case @xmath756 in fig .",
    "[ forks ] ) the forking pattern will be directed upwards , for chirality @xmath755 ( upper case on the right of fig .",
    "[ chira2 ] , corresponding to case @xmath757 in fig .",
    "[ forks ] ) , downwards .",
    "when we have simultaneous overlapping of the two reference pulses with the optical replica pulse ( center case on the right of fig . [ chira2 ] , corresponding to case @xmath758 in fig . [ forks ] ) we have a combination of two forking patterns one upwards and the other downwards .",
    "it remains to be discussed whether the separation of the holographic fringes is enough to guarantee distinguishable patterns .",
    "the separation between the fringes depends on the transverse offset of the reference source relative to the object .",
    "when the offset of the reference source increases up to about @xmath759 , @xmath329 being the rms transverse electron bunch dimension , the fringes will be separated of a distance proportional to @xmath760 , which is much larger compared to @xmath436 . as a result , for the first fringe we will obtain a fork which is well distinguishable , meaning that it does not overlap with the bunch structure and it is not influenced by the structure of the single electron pattern .",
    "we can speculate that computerized analysis will easily distinguish among these three kinds of events , solving the problem of identifying the position of the slice within the bunch .",
    "there are many advantages related to the application of this technique .",
    "in fact , it avoids complications like the need for ita , it does not require a - priori information about the electron bunch structure ( i.e. can be used to measure ultra - short bunches ) and it does not require synchronization .      in this section",
    "we introduce a novel technique to characterize the 3d structure of the electron bunch .",
    "this technique combines multiple - reference fth ( section [ sub : mrf ] ) and time - gated fth ( section [ sub : mxp ] ) methods .",
    "the fact that multiple - reference fth may be naturally used for time - resolved experiments was first discussed in a concept presented in @xcite .",
    "multiple - reference fth can allow us to simultaneously record images of different slices of the electron bunch , thus providing a 3d image of a single electron bunch .",
    "our idea is to vary the time - delay of the reference sources .",
    "each reference source is a small disk with high reflectivity , and the distance from the reference scatter to the membrane is varied in order to create a time - delay between reference wave and otr object wave , fig .",
    "[ movie2 ] , left . as a result ,",
    "once the hologram is processed , different reconstructed object images will correspond to different slices with given time - delays along the electron bunch , fig .",
    "[ movie2 ] , right .",
    "membrane for time - resolved fth with reference scatters ( left ) and reconstructed holographic images of electron bunch slices ( right ) .",
    ", width=529 ]     3d electron bunch structure monitor by use of the hotri technique . ,",
    "width=529 ]    from the measurement using the setup shown in fig .",
    "[ movie1 ] , we can make a movie ( five frames with @xmath14 fs exposure - time and @xmath761 thz frame - rate ) of the electron bunch propagating through the otr screen , showing the electron density distribution against space and time .",
    "we named this novel technique holography optical time resolved imaging ( hotri ) .",
    "as we mentioned above , some coherent imaging techniques take advantage of the fact that the test pulse is bandwidth - limited . in this section",
    "we will discuss what conditions should be met for the optical replica pulse to be considered bandwidth - limited , and what is the impact of a phase - chirp on the different techniques proposed in this work .",
    "in section [ sec : setup ] we discussed the impact of self - interactions on the optical replica .",
    "we demonstrated that , in practical cases of interest , self - interactions effects and energy - spread influence can be neglected , and the amplitude of the bunching can be considered uniform along the bunch .",
    "this is sufficient to produce an optical replica of the electron bunch , that is a radiation pulse whose electric field amplitude is a replica of the charge density distribution of the electron bunch .",
    "the optical replica pulse can be used to characterize the longitudinal bunch profile of the electron bunch @xcite with the frog technique .",
    "it should be remarked , however , that the bunch compression procedure introduces an energy chirp in the electron beam after the magnetic chicane bc2 in the case of the european xfel , fig .",
    "[ compe ] .",
    "this chirp introduces , as it will be discussed below , a distortion into the phase of the bunching which is not important for the ors setup as concerns peak - current measurements , but is important when dealing with electron bunch imaging .",
    "a comprehensive analysis of the evolution of the longitudinal phase space after compression , including nearly all important physical effects ( space charge interactions , coherent synchrotron radiation ( csr ) , shape variation , resistive walls ) is given in @xcite .",
    "the longitudinal phase - space of the electron bunch just after the magnetic compressor bc2 , taken from @xcite is reproduced in fig .",
    "[ phspl ] .     the foreseen longitudinal phase - space distribution of electrons after the magnetic compressor bc2 at the european xfel , extracted from @xcite.,width=415 ]    the energy chirp shown in fig .",
    "[ phspl ] is due to a combination of different effects .",
    "in fact , energy chirp is intrinsically introduced in the framework of a single - particle dynamics during the bunch compression procedure , but it is modified by the presence of other wakefields . moreover , as noted in @xcite , the bunch formation system is composed by several chicanes , which complicates furthermore the situation .",
    "a qualitatively similar conclusion can be found in simulations for lcls ( see the study on longitudinal phase - space in @xcite ) .",
    "the measurement of the longitudinal bunch profile by frog is insensitive to the presence of the energy chirp and , better , as shown in @xcite , the ors can be used to measure the energy chirp . in fact , a frog device can measure the phase of the optical replica , and the phase is strongly related to the energy chirp by    @xmath762    however , the phase chirp of the optical replica pulse is , in its turn , related to whether or not the optical replica pulse is bandwidth limited .    for a bandwidth - limited pulse of duration @xmath493 and bandwidth",
    "@xmath621 one has @xmath763 .",
    "this implies that @xmath764 .",
    "also , for a bandwidth - limited pulse , one should have a constant phase i.e. , from a practical viewpoint , a phase - shift smaller than a radian along the pulse .",
    "a phase - chirp linear in time corresponds to a shift in the carrier frequency .",
    "one can account for such a chirp by introducing an effective carrier frequency .",
    "thus , we will neglect the linear phase - chirp and account for the non - linear phase - chirp only .",
    "we may restate the condition above , requiring that the non - linear chirp should be sufficiently small , and the phase distortion across the pulse should be smaller than a radian .    here",
    "we consider the low energy case of @xmath27 gev after the second bunch compressor , where the longitudinal phase - space is depicted in fig .",
    "[ phspl ] .",
    "the value of the momentum compaction factor is that of the ors dispersion section , i.e. @xmath765 m . with the help of eq .",
    "( [ chirphi ] ) , one can see that a phase shift @xmath766 of a radian corresponds to an energy shift of about @xmath767 mev along the pulse .",
    "considering the european xfel case , one should extract from the large linear chirp fig .",
    "[ phspl ] , the non - linear energy chirp component .",
    "a quick estimation shows that the non - linear component of the chirp is in the order of @xmath768 mev per bunch length , yielding a phase shift smaller than a radian .",
    "there is some room to optimize the situation by increasing the energy modulation introduced by the seed laser , increasing the energy in the seed laser pulse and subsequently decreasing the @xmath42 parameter in eq .",
    "( [ chirphi ] ) of a factor @xmath768 .",
    "it should be noted that the large chirp shown in fig .",
    "[ phspl ] is introduced _",
    "ad hoc _ at the european xfel ( and at lcls too ) in order to diminish csr effects in the chicane .",
    "additionally this also allows to compensate for the linear component of the energy chirp introduced by wakefields after the bunch formation system , which has opposite slope . in several situations of interest , the non - linear component of the chirp can be smaller at the end of the bunch formation system .",
    "having said this , it is interesting to discuss which techniques presented in this paper are influenced by the energy chirp of the electron beam , and which are not .",
    "first , let us consider methods that are not influenced . as we have seen in section [ sec : ft ] , direct ( coherent ) imaging without spectral filter allows one to record the integral of the squared modulus of the optical replica pulse , i.e. a quadratic projection . in this case , any phase deviation along the optical replica pulse is irrelevant .",
    "in fact , energy chirp only introduces a phase perturbation which depends on time and not on transverse coordinates , at least within a single - particle dynamics approximation in the bunch - formation system .    also techniques based on the a - priori use of information from independent frog measurements work , without modification , with and without chirp .",
    "this is the case when we combine real and reciprocal space spectrometers , fig .",
    "[ fgate ] , and when we consider frequency - gated fth , fig .",
    "[ 3dmulti ] .",
    "other techniques which are completely insensitive to energy chirp are spatio - temporal fth , fig .",
    "[ stft ] and hotri , fig .",
    "[ movie1 ] and , more in general , all time - gated fth techniques .",
    "this follows from the short duration of the reference pulse in all these cases , which is @xmath14 fs long and has a bandwidth of about @xmath3 nm .",
    "in fact , the non - linear energy chirp necessary to significantly perturb the operation of time - resolved techniques based on such kind of reference pulses can be estimated to be about @xmath3 mev , which is far from the design parameters of the european xfel and lcls . as a result , direct ( coherent ) imaging without spectral filter , techniques based on independent frog measurements , the spatio - temporal fth method and",
    "all time - gated fth techniques are insensitive to energy chirp .",
    "second , there are techniques that are influenced by the presence of energy chirp , but that may be easily modified to account for such presence .",
    "these are schemes operating in the frequency domain in the 3d imaging mode , i.e. the multishot measurement method based on the use of the projection algorithm , fig .",
    "[ dspec ] , and frodi , fig .",
    "[ bunchfrog ] . in order to account for the effects of the energy chirp , in these cases we can make use of the knowledge about the phase deviation along the optical replica pulse as measured by frog .",
    "this requires modification of the technique , because it implies an extra frog measurement .",
    "note that the required information is automatically available if we perform peak - current profile measurements .",
    "once the phase along the optical replica pulse is known , we can use it e.g. in the reconstruction of 2d traces for frodi .",
    "consider , for the sake of illustration , the @xmath11 projection .",
    "if we assume that the optical pulse is bandwidth - limited , its phase is constant , and @xmath588 and @xmath255 are real and positive ( see eq .",
    "( [ duerho0 ] ) ) , i.e. one can talk about the slowly varying real and positive envelope of the pulse is still a complex - valued function of @xmath621 . also note that in this case , @xmath769 .",
    "in other words @xmath625 at @xmath631 coincides with the temporal projection of @xmath588 . ] . if , instead , the optical pulse is not bandwidth",
    "limited , one has @xmath770 $ ] with @xmath771 constant and @xmath772 a non - zero phase due to energy chirp within the electron bunch .",
    "therefore , when the energy chirp is negligible , the envelope of the optical replica pulse is an exact replica of @xmath639 , i.e. of the electron density distribution , which is real and nonnegative .",
    "as seen before , this is enough to guarantee unique reconstruction of the object .",
    "the fact that the optical replica pulse envelope is real and nonnegative actually amounts to complete information about the phase of the pulse envelope , which is just constant .",
    "when non - negligible energy chirp is present , the pulse envelope is no more real , but the phase along the @xmath39 axis is nevertheless fully determined by the frog measurements , and this is enough to guarantee reconstruction .",
    "this allows to reconstruct any arbitrary projection @xmath773 , where @xmath774 is rotated of an arbitrary angle with respect to @xmath9 in the @xmath13 plane , but not the @xmath13 trace . anyway ,",
    "if a sufficient number of @xmath773 traces are known , this information is enough for reconstruction .",
    "note that the 3d optical replica pulse in the space - time domain can now be reconstructed as a cube of complex - valued data .",
    "the amplitude is proportional to @xmath639 .",
    "finally , third , all other techniques presented in this work , including direct ( coherent ) imaging with spectral filter , fig .",
    "[ schemecoh ] , linear projection diffraction imaging , fig .",
    "[ recon ] , and fth imaging of linear projection , fig .",
    "[ holog3 ] , can operate only with a bandwidth - limited optical replica pulse .",
    "note that when we extend these techniques to 3d reconstruction methods we can easily overcome the energy - chirp problem .",
    "however , when we deal with single @xmath13 projection measurement only , like in fig . [ schemecoh ] , fig . [ recon ] and fig .",
    "[ holog3 ] , this is not possible anymore and one should take care that the energy chirp is actually negligible .",
    "the study presented in this work opens up a novel field in high - energy , ultrashort electron beam diagnostic methods , based on the use of coherent optical transition radiation ( otr ) for 3d imaging of an ultrashort electron bunch by means of the optical replica synthesizer ( ors ) @xcite .",
    "the ors technique was proposed as an attempt to solve a very challenging problem , namely the longitudinal electron bunch diagnostics , by producing a 1d optical replica radiation pulse , thus reducing the electron bunch characterization problem to the 1d optical pulse characterization problem .",
    "the ors performs longitudinal diagnostics of ultrarelativistic , ultrashort electron bunches in two steps .",
    "first , an optical replica of the electron bunch is prepared .",
    "second , 1d characterization of the electron bunch is performed by a femtosecond oscilloscope . for this purpose",
    "the ors setup makes use of a commercially available frequency - resolved optical gating ( frog ) device .",
    "the availability of methods and instrumentation for measuring ultrashort optical pulses constitutes the main advantage of using an optical replica compared to other diagnostics schemes .    in the case of 3d characterization of an electron bunch we demonstrated that the same approach can be realized . in other words",
    ", the 3d imaging of an electron bunch with spatio - temporal coupling can be reduced to 3d characterization of an optical pulse with spatio - temporal coupling . however",
    ", the 3d problem has a different status compared to its 1d counterpart .",
    "in fact , the 3d problem was formulated only recently , and no commercial devices are yet available .",
    "this does not mean that the schemes discussed in this work constitute a challenge as concerns their technical realization .",
    "the 3d problem has a number of possible solutions , and this explains why some of the techniques proposed here ( frodi , hotri ) are completely original .",
    "note that our formulation of the 3d problem is less general than the one addressed by the optical community . in our case of interest ,",
    "the optical pulse is not arbitrary , but being the optical replica of an electron bunch , has a duration of about @xmath3 fs and has specific constraints like the bandwidth limit , or in more general cases , a phase which is a function of time only .",
    "this opens up the possibility to use some approaches , as fourier transform holography ( fth ) with reference source and its variations , which can not be applied for an arbitrary pulse .",
    "we proposed to use coherent otr as the source of radiation for the optical replica pulse . in the case of coherent otr",
    "we can take advantage of the large number of photons and of the coherent properties of the radiation pulse .",
    "we developed schemes based on direct coherent otr imaging , diffractive imaging , fth , and a combination of these techniques .",
    "in particular , novel techniques like frodi and hotri allow for the 3d characterization of ultrashort electron bunches by use of single and multishot measurements .",
    "we proposed to exploit the highly - developed software algorithms for diffractive imaging and fourier transform holography .",
    "reconstruction of 3d images in real space - time domain can be based on methods like the gerchberg - saxton algorithm , the fineup algorithm or their generalizations .",
    "moreover , similarly to the ors setup , we proposed to make use of the large selection of commercially available instrumentation for optical pulse diagnostics . performing diagnostics in the range of visible optics",
    "will greatly simplify a choice of optical elements or their manufacturing .",
    "also , ultrashort , up to @xmath14 fs , optical laser sources with any state of polarization are available as a reference sources . the same approach , to use already highly - developed devices , is proposed when considering 3d - imaging methods in the 3d fourier domain . for this kind of applications",
    "there is a need for optical systems capable of forming high - resolution images at different wavelengths .",
    "imaging spectrometers are instruments capable of providing this functionality .",
    "there are two types of imaging spectrometers .",
    "one type is based on the use of a plurality of bandpass filters to measure a 3d data cube in the 3d fourier domain for different frequencies .",
    "a second type is based on the use of a dispersive element , and it is particularly suitable for single shot 3d measurements .    due to the users needs , future xfels will operate with shorter and shorter electron bunches .",
    "our proposed diagnostic techniques have the potential for extensions from the @xmath3-fs time scale , which we discussed here , to the @xmath14-fs time scale of electron bunch duration by straightforward rescaling to shorter wavelengths .",
    "exploitation of shorter wavelengths is possible because our setups are based on linear optical elements only .",
    "the shortest possible wavelength compatible with glass optics is about @xmath4 nm , which corresponds to the fourth harmonic of a ti : sa laser . using particular geometries",
    ", frog devices can operate in this range as well @xcite .",
    "we regard the concepts presented here , based on the combination of ors with coherent otr imager setups , as the start of a novel direction in diagnostic methods .",
    "therefore , the present work should not be considered as comprehensive of all foreseeable applications . on the contrary",
    ", we hope that our work will stimulate interest and open the door to many new possibilities for ultra - fast electron bunch diagnostics .",
    "we thank our colleagues dirk noelle , harald redlin and william schlotter for useful discussions , massimo altarelli , reinhard brinkmann and edgar weckert for their interest in this work ."
  ],
  "abstract_text": [
    "<S> we describe a novel technique to characterize ultrashort electron bunches in x - ray free - electron lasers . </S>",
    "<S> namely , we propose to use coherent optical transition radiation to measure three - dimensional ( 3d ) electron density distributions . </S>",
    "<S> our method relies on the combination of two known diagnostics setups , an optical replica synthesizer ( ors ) and an optical transition radiation ( otr ) imager . </S>",
    "<S> electron bunches are modulated at optical wavelengths in the ors setup . when these electron bunches pass through a metal foil target , coherent radiation pulses of tens mw power are generated . </S>",
    "<S> it is thereafter possible to exploit advantages of coherent imaging techniques , such as direct imaging , diffractive imaging , fourier holography and their combinations . </S>",
    "<S> the proposed method opens up the possibility of real - time , wavelength - limited , single - shot 3d imaging of an ultrashort electron bunch .    </S>",
    "<S> * deutsches elektronen - synchrotron *    * + *    desy 09 - 069    may 2009    @xmath0    @xmath1    * method for the determination of the three - dimensional structure of ultrashort relativistic electron bunches *    @xmath2    gianluca geloni , petr ilinski , evgeni saldin , evgeni schneidmiller and mikhail yurkov    _ + deutsches elektronen - synchrotron desy , hamburg _ </S>",
    "<S> @xmath1 @xmath1 @xmath1 issn </S>",
    "<S> 0418 - 9833 @xmath1    * notkestrasse 85 - 22607 hamburg *    41.60.ap , 41.60.-m , 41.20.-q </S>"
  ]
}