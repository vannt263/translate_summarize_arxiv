{
  "article_text": [
    "the study of many problems of interest in astrophysics today benefits from or even requires the use of three - dimensional hydrodynamical or @xmath0-body simulations because the complex physical processes or the lack of symmetry involved prohibit analytic or reduced - dimensionality approaches .",
    "these problems span the entire range of astrophysical length scales , from black hole collisions and core - collapse supernovae to clusters of galaxies and the lyman @xmath1 forest .",
    "the advent over the past two decades of modern shock - capturing hydrodynamical algorithms and fast @xmath0-body methods , together with rapid advances in available computing power , has made such simulations feasible .    in these simulations",
    "one must make a distinction between collisional matter , in which the mean free path between particle collisions is much smaller than all length scales of interest , and collisionless matter , in which particles may free - stream between collisions on length scales important to the simulation . for collisional matter , a fluid description incorporating a pressure field and a single - valued bulk velocity field is appropriate ; shock waves can convert energy irreversibly from bulk kinetic form to internal form .",
    "for collisionless matter , the bulk velocity can take on multiple values at each point in space , and shock waves are not possible .    for simulations of galaxies , clusters of galaxies , and large - scale structure",
    "it is important to track both kinds of matter . on the length and time scales of interest in these simulations ,",
    "baryonic matter ( the intracluster or intergalactic medium ) behaves as a collisional fluid . although locally this gas may be partially or fully ionized , with collisions between ions and electrons occurring by means of randomly oriented magnetic fields , on resolvable length scales we may assume charge neutrality and ignore local deviations from fluid behavior ( e.g. , plasma instabilities ) .",
    "however , because we do not yet know the identity of the dark matter , we adopt the simplest hypothesis and assume that it is collisionless .",
    "the gravitational stability of apparently bound systems ( galaxies and clusters of galaxies ) in which baryons provide insufficient mass is still our best evidence for the existence of dark matter .",
    "thus the simplest hypothesis also treats the interaction between these types of matter as purely gravitational .",
    "cosmological simulations must track the evolution of both matter constituents in their mutual gravitational field .",
    "several codes now exist to simulate the combined evolution of collisional and collisionless matter in a cosmological setting .",
    "all treat the dark matter using superparticles which sample the particle distribution .",
    "these @xmath0-body codes differ in the methods they use to compute interparticle forces and to solve the hydrodynamical equations for the gas .",
    "methods for computing interparticle forces include direct summation ( pp , or particle - particle ) , tree algorithms ( hernquist 1987 ) , particle - mesh methods ( pm : hockney & eastwood 1988 ) , and combinations of direct summation and particle - mesh ( p@xmath2 m : efstathiou & eastwood 1981 ) . the tree and particle - mesh algorithms trade off force accuracy or spatial resolution for speed in comparison with direct summation , while variants of p@xmath2 m attempt to overcome the resolution limitations of pm techniques while retaining their speed .    the hydrodynamic solvers currently in use with particle codes include variants of smoothed - particle hydrodynamics ( sph : gingold & monaghan 1977 ; lucy 1977 ) and grid - based methods such as the piecewise - parabolic method ( ppm : colella & woodward 1984 ) and the total - variation - diminishing method ( tvd : harten 1983 ) .",
    "sph algorithms descended from astrophysical @xmath0-body techniques and use particles to approximate the behavior of the gas , treating gas particles as moving interpolation centers for quantities such as the gas pressure .",
    "typically sph codes achieve good spatial resolution in high - density regions but handle shocks and low - density regions poorly .",
    "examples of cosmological hydrodynamics codes based on sph include those of evrard ( 1988 ) , hernquist & katz ( 1989 ) , navarro & white ( 1993 ) , couchman , thomas , & pierce ( 1995 ) , steinmetz ( 1996 ) , and owen et al .",
    "grid - based methods , which are used widely in other areas of physics and in engineering , suffer from more limited resolution , but they handle high - density and low - density regions equally well , and with modern algorithms they handle shocks extremely well . moreover , it is more straightforward to add extra gas physics to grid - based codes .",
    "examples of grid - based cosmological hydrodynamics codes ( excluding those based on ppm , which are discussed below ) include the centered - difference code of cen ( 1992 ) , the tvd code of ryu et al .",
    "( 1993 ) , the softened lagrangian code of gnedin ( 1995 ) , and the moving - mesh tvd code of pen ( 1998 ) .",
    "comparisons of various cosmological particle- and grid - based codes have been performed by kang et al .",
    "( 1994 ) and frenk et al .",
    "( 1999 ) .",
    "the combination of pm for dark matter and ppm for gas has proven to be an especially useful method for cosmological simulations .",
    "accurate shock handling and straightforward implementation of subgrid physics argue for the use of a grid - based scheme for the gas .",
    "when using a grid for the gas , the most efficient means for obtaining the forces on the dark matter particles is the particle - mesh method , because the gas and dark matter both make use of the potential defined on the grid . also , because the gas grid limits the spatial resolution , the greater dynamic range of a tree code or direct summation solver for the dark matter is not as useful . in recent years",
    "several groups have independently developed pm - ppm codes to study large - scale structure and galaxy cluster formation ( bryan et al .",
    "1995 ; sornborger et al .  1996",
    "; gheller , pantano , & moscardini 1998 ; quilis , ibez , & sez 1996 , 98 ) and cluster evolution ( roettiger , stone , & mushotzky 1997 ) .",
    "these codes differ in a number of ways .",
    "the bryan et al .",
    ", sornborger et al . , and roettiger et al .",
    "codes use the lagrange - plus - remap formulation of ppm , whereas the gheller et al .",
    "code uses the direct eulerian formulation .",
    "little difference in numerical accuracy between the two formulations has been observed , but the lagrange - plus - remap formulation generalizes somewhat more readily to moving or adaptive grids .",
    "the bryan et al .",
    "code adds certain ad hoc modifications to the basic ppm scheme to improve the resolution of narrow density peaks , and more recently this code has been extended to include adaptive mesh refinement ( amr : norman & bryan 1999 ) .",
    "the quilis et al .",
    "code makes use of a linearized riemann solver due to roe ( 1981 ) , whereas the other codes use variants of the iterative riemann solver due to van leer ( 1979 ) .",
    "all of the codes except that of roettiger et al .",
    "use a green s function technique ( via the fast fourier transform , or fft ) to solve for the combined gravitational potential of the gas and dark matter .",
    "the roettiger et al .",
    "code uses a conjugate gradient solver ( hockney & eastwood 1988 ) for the poisson equation . to our knowledge ,",
    "all of the codes use cloud - in - cell ( cic ) weighting together with a variable - timestep time integration scheme for the particle - mesh code .",
    "we have developed a new pm - ppm code , called cosmos , for simulations of large - scale structure formation and galaxy cluster evolution .",
    "like gheller et al .",
    "( 1998 ) , we use the direct eulerian formulation of ppm , and like all of the above codes we use cic weighting and a variable timestep in our pm code . however , our code uses a full multigrid solver rather than an fft to obtain the gravitational potential , enabling us to handle nonuniform grids with isolated boundary conditions .",
    "also , we have implemented a nonideal equation of state following colella & glaz ( 1985 ) ( of use , for example , in ly  @xmath1 cloud and supernova simulations ) , and we implement cooling and multifluid source terms , as well as cosmological expansion terms , with a method similar to that used by kritsuk , bhringer , & mller ( 1998 ) .",
    "the hydrodynamical and gravitational components of cosmos have been used previously by ricker ( 1998 ) to study purely hydrodynamic cluster evolution , and the full code has been used by ricker & sarazin ( 2000 ) to simulate cluster mergers including gas and dark matter .    in this paper",
    "we describe the cosmos code and the results of our validation tests .",
    "section [ sec : equations ] discusses the physics included in the code and the corresponding equations . in section [ sec : numerical methods ] we discuss the discretization scheme used for the grid - based components of the code , the algorithms we use , and the modifications we have made to the standard algorithms to suit the requirements of cosmological problems .",
    "section [ sec : code tests ] describes the test problems we have used to validate the code .",
    "finally , section [ sec : conclusion ] summarizes the paper .",
    "in this section we describe the definitions and equations used in the cosmos code .",
    "all calculations take place in a three - dimensional computational volume in which positions are specified using comoving coordinates @xmath3 , where @xmath4 is a proper position vector and @xmath5 is the time - dependent cosmological scale factor .",
    "both dark matter and gas peculiar velocities @xmath6 are considered to be comoving ; thus @xmath7 for a particle at location @xmath8 .",
    "we define the comoving gas density and pressure as @xmath9 where @xmath10 and @xmath11 are the proper gas density and pressure , respectively .",
    "( we use the subscripts g and dm to distinguish quantities which apply separately to both the gas and dark matter . ) note that our definition of @xmath12 requires that the comoving internal energy density be given by @xmath13 where @xmath14 is the proper specific internal energy of the gas . for an ideal - gas equation of state with ratio of specific heats @xmath15 and average atomic mass @xmath16",
    ", we have @xmath17 where @xmath18 is the comoving temperature , and @xmath19 is the proper temperature .",
    "we also define the comoving potential @xmath20 as the solution at each simulation timestep to poisson s equation , @xmath21\\ .\\ ] ] here @xmath22 is the comoving density in dark matter particles , and the bar indicates a spatial average .",
    "the comoving total energy density of the gas is defined as @xmath23 where @xmath24 is the comoving speed of the gas .",
    "finally , for certain problems we make use of an equilibrium cooling function , which we denote by @xmath25 . for example ,",
    "cooling via optically thin thermal bremsstrahlung emission , assuming a fully ionized gas , would require @xmath26 .",
    "we use these definitions to transform the inviscid eulerian equations of hydrodynamics into a simple comoving form which , in a static universe ( @xmath27 ) , reduces again to the standard equations with comoving quantities equivalent to proper ones .",
    "the comoving gas equations solved by cosmos are as follows : @xmath28 = 0\\ ] ] @xmath29      + { { \\bf \\nabla}}p + 2{{{\\dot{a}\\over a}}}{{\\rho_{\\rm g}}}{{{\\bf v}}_{\\rm g}}+ { { \\rho_{\\rm g}}}{{\\bf \\nabla}}\\phi = 0\\ ] ] @xmath30 +     { { { \\dot{a}\\over a}}}\\left[(3\\gamma-1){{\\rho_{\\rm g}}}\\epsilon + 2{{\\rho_{\\rm g}}}v_{\\rm g}^2\\right ]     - { { \\rho_{\\rm g}}}{\\partial\\phi\\over\\partial t } + \\lambda = 0\\ ] ] @xmath31 - { { { \\bf v}}_{\\rm g}}\\cdot{{\\bf \\nabla}}p +     { { { \\dot{a}\\over a}}}(3\\gamma-1){{\\rho_{\\rm g}}}\\epsilon + \\lambda = 0\\ ] ] the equations are written in explicit conservation form . with the finite - volume discretization used in cosmos ( section [ sec : discretization ] ) , we can difference these equations ( except for the internal energy equation ) in such a way that errors in the advection terms do not affect global conservation of mass , momentum , and energy .",
    "we determine which energy equation to use in updating the pressure on the basis of the magnitude of the internal energy density . during a simulation timestep",
    "we update the internal energy and pressure according to the internal energy equation ( [ eqn : intener ] ) and the equation of state ( [ eqn : eos ] ) .",
    "we update the total energy using the total energy equation ( [ eqn : totener ] ) . at the end of the timestep ,",
    "if in any zone the condition @xmath32 ) with the updated values of @xmath33 , @xmath34 , @xmath35 , and @xmath20 , then use the equation of state to reset the pressure . if this criterion is not satisfied , we instead reset the total energy density in that zone using equation ( [ eqn : enerdef ] ) .",
    "this procedure permits us to maintain total energy conservation in regions where the pressure makes a significant contribution to the total energy while avoiding large round - off errors in the pressure where it is small .",
    "condition ( [ eqn : encriterion ] ) is generally satisfied except for high mach - number flows and in ` dust ' calculations where the gas pressure offers little support against gravity .",
    "similar methods based on energy ( bryan et al .  1995 ) and entropy ( ryu et al .",
    "1993 ) are used by other codes to handle such flows .",
    "equations ( [ eqn : continuity ] ) through ( [ eqn : intener ] ) suffice to describe the behavior of matter that is collisional on the length scales of interest to us .",
    "examples include the gas in stellar atmospheres and in clusters of galaxies .",
    "however , for collisionless matter components , such as galaxies and dark matter in clusters , we must solve the equations of motion for individual particles .",
    "these particles are subject only to gravitational forces ; hence a particle s comoving position @xmath36 and velocity @xmath37 evolve according to @xmath38 @xmath39 the second term on the left in the velocity equation representing the hubble flow due to uniform expansion .",
    "we solve the hydrodynamical equations described in section [ sec : equations ] on a nonuniform , finite , cartesian grid containing @xmath40 cells .",
    "the center of the ( @xmath41)-th cell ( @xmath42 , @xmath43 , @xmath44 ) is located at @xmath45(@xmath46 ) .",
    "the edges of this cell have @xmath47-coordinates @xmath48 and @xmath49- and @xmath50-coordinates that are similarly defined .",
    "we use a standard finite - volume discretization . a convenient way of expressing this discretization is as follows . we define a convolution operator which averages a variable over a cell volume : @xmath51 \\equiv { 1\\over\\delta x_i\\,\\delta y_j\\,\\delta z_k } \\int_{x-\\delta x_i/2}^{x+\\delta x_i/2}\\int_{y-\\delta y_j/2}^{y+\\delta y_j/2 } \\int_{z-\\delta z_k/2}^{z+\\delta z_k/2 } d^3x'\\,f({\\bf x}')\\ .\\ ] ] here @xmath52 is any scalar fluid variable ( e.g.  density or pressure )",
    ". now let @xmath53\\ ; \\ ] ] by substituting a taylor expansion for @xmath54 about @xmath55 we find that @xmath56 thus the fluid quantities manipulated by this finite - volume technique differ from those used in finite - difference methods by terms of order the square of the grid spacing .",
    "these cell averages are to be distinguished from cell - wall averages , which we define as follows for cell walls perpendicular to the @xmath47-axis : @xmath57 similar definitions apply for the other coordinate directions .",
    "if we write the fluid equations ( [ eqn : continuity ] )  ( [ eqn : intener ] ) with @xmath58 as the spatial variables , apply the convolution operator ( [ eqn : convop ] ) to both sides , apply the divergence theorem , and then let @xmath59 , @xmath60 , and @xmath61 , we obtain a set of spatially discretized equations . as usual ,",
    "the continuity equation becomes @xmath62 + & \\\\ \\label{eqn : spatdisc } & \\displaystyle\\frac{1}{\\delta y_j } \\left[{({{\\rho_{\\rm g}}}v_{{\\rm g,}y})_{i , j+1/2,k } -      ( { { \\rho_{\\rm g}}}v_{{\\rm g,}y})_{i , j-1/2,k}}\\right ] + & \\\\ \\nonumber & \\displaystyle\\frac{1}{\\delta z_k } \\left[{({{\\rho_{\\rm g}}}v_{{\\rm g,}z})_{i , j , k+1/2 } -      ( { { \\rho_{\\rm g}}}v_{{\\rm g,}z})_{i , j , k-1/2}}\\right ] = & \\ 0\\ .\\end{aligned}\\ ] ]",
    "the other fluid equations transform in a similar fashion . in this form the advection terms in equations ( [ eqn : continuity ] )  ( [ eqn : totener ] ) are conservatively differenced , because the same amount of each conserved quantity is subtracted from each cell as is added to its neighbors .",
    "the nonconservative advection term in the internal energy equation ( [ eqn : intener ] ) does not significantly affect global energy conservation , because wherever the internal energy density makes a large contribution to the total it is reset using the total energy density , which is conservatively differenced .    because the hydrodynamical equations are hyperbolic",
    ", we solve them by integrating forward in time from a given initial state .",
    "we use an explicit forward time difference , so for stability we limit the timestep using the courant - friedrichs - lewy ( cfl ) criterion ( roache 1998 ) : @xmath63\\ .\\ ] ] here @xmath64 is the ` cfl parameter ' , a number between 0 and 1 ( as close to 1 as possible for accuracy and for computational efficiency ) , and the minimization is taken over the entire computational grid .",
    "additional restrictions on the timestep due to gravitational acceleration ( @xmath65 ) , radiative cooling ( @xmath66 ) , and the @xmath0-body code ( @xmath67 ) are described in the following sections .",
    "we adopt a timestep @xmath68 which is the minimum of all of these restrictions : @xmath69\\ .",
    "\\label{eqn : dt}\\ ] ]    to obtain the fully discretized equations we average the spatially discretized equations over the time interval @xmath70 , where @xmath71 .",
    "the continuity equation then becomes @xmath72 \\\\",
    "\\label{eqn : fulldisc } & - &    \\displaystyle \\frac{\\delta t_n}{\\delta y_j }    \\left[{\\overline{({{\\rho_{\\rm g}}}v_{{\\rm g,}y})}_{i , j+1/2,k } -    \\overline{({{\\rho_{\\rm g}}}v_{{\\rm g,}y})}_{i , j-1/2,k}}\\right ] \\\\",
    "\\nonumber & - &    \\displaystyle \\frac{\\delta t_n}{\\delta z_k }    \\left[{\\overline{({{\\rho_{\\rm g}}}v_{{\\rm g,}z})}_{i , j , k+1/2 } -    \\overline{({{\\rho_{\\rm g}}}v_{{\\rm g,}z})}_{i , j , k-1/2}}\\right]\\ , \\end{aligned}\\ ] ] where bars indicate averages over @xmath70 .",
    "this is an exact equation for @xmath73 ; discretization error is introduced when we estimate the time - averaged fluxes ( @xmath74 , etc . )",
    "given the cell - averaged fluid variables at time @xmath75 , since the fluxes depend on cell - wall averages which must be determined through interpolation . in cosmos the interpolation and flux computation steps are handled using the piecewise - parabolic method ( ppm ) , which we discuss in the next section .",
    "to simplify the algorithm , we reduce this three - dimensional problem to a set of one - dimensional problems using standard operator splitting techniques .",
    "this allows us to use a one - dimensional hydrodynamics routine which operates on 1d work arrays , into which and out of which we swap rows or columns from the full grid as necessary . in the simplest form of operator splitting ,",
    "one advances every cell through @xmath68 using just the @xmath47-derivatives , then takes the results of this operation and advances them again through @xmath68 using just the @xmath49-derivatives , finally repeating the procedure using just the @xmath50-derivatives .",
    "this method produces an effective three - dimensional operator which is accurate to @xmath76 .",
    "we have found in spherical explosion tests that first - order splitting does not preserve rotational symmetry well .",
    "therefore we use the symmetrized operator splitting method of strang ( 1968 ) , which yields @xmath77 accuracy . for each successive pair of timesteps",
    "we perform first a sweep in @xmath47 , then a sweep in @xmath49 , then a sweep in @xmath50 , each for a full timestep .",
    "we then repeat these operators in reverse order for the second timestep .",
    "splitting techniques also generalize to the other operators in the problem . for the cosmological expansion terms we use the exact solution of @xmath78\\\\ { { \\partial\\over\\partial t}({{\\rho_{\\rm g}}}\\epsilon ) } & = & -{{{\\dot{a}\\over a}}}\\left(3\\gamma-1\\right){{\\rho_{\\rm g}}}\\epsilon\\ .\\end{aligned}\\ ] ] we solve the radiative cooling term using a semi - implicit numerical ode integrator . for stability",
    "both operators require timestep limitations : for the cosmological terms , we limit the change in @xmath5 during the timestep to @xmath79 or less , while for the radiative cooling term we use @xmath80 these timestep restrictions are considered along with the hydrodynamical and @xmath0-body restrictions in determining the actual timestep via equation ( [ eqn : dt ] ) .",
    "we also treat the gravitational acceleration terms in an operator - split fashion , but because they involve spatial derivatives , we must make a small modification to the ppm method to accomodate them .",
    "this modification is described by colella & woodward ( 1984 ) . in section",
    "[ sec : gravdisc ] we discuss further the discretization of the poisson equation and the expressions used for the cell - averaged gravitational acceleration in ppm . we impose the following timestep constraint due to the gravitational acceleration @xmath81 : @xmath82^{1/2}\\ .\\ ] ] in practice this criterion rarely determines the timestep .      to calculate the time - averaged fluxes we use the piecewise - parabolic method ( ppm ; colella & woodward ( 1984 ) ) , a high - order eulerian generalization of godunov s ( 1959 ) scheme .",
    "godunov schemes achieve very good resolution of flow discontinuities such as shocks without excessive dissipation or oscillations by solving a nonlinear flow problem at each cell interface .",
    "this property makes ppm ideal for solving a variety of astrophysical flow problems , since such problems often require narrow hydrodynamical features to be resolved with a small number of cells .    since the ppm algorithm is discussed in detail elsewhere , we limit ourselves to describing the special features of the version of ppm used in cosmos .",
    "we implement ppm using the direct eulerian formulation , and we include the modifications developed by colella & glaz ( 1985 ) for handling general equations of state using a variable ratio of specific heats @xmath15 .",
    "we use the approximate riemann solver described by van leer ( 1979 ) ; rarefactions are locally approximated as shocks , following colella ( 1985 ) .",
    "ppm uses information from four cells on either side of each cell at each timestep . at the boundaries of the computational region we therefore maintain four ` ghost zones ' containing boundary information .",
    "we set the values in these zones before applying each 1d differential operator .",
    "periodic boundaries , which are appropriate for large - scale structure simulations , are implemented by setting the ghost zones equal to the corresponding interior zones on the opposite side of the grid . for galaxy cluster evolution problems",
    "it is more desirable to control inflow and outflow rates than to have matter which disappears from the grid reappear on the opposite side .",
    "for inflow boundaries one sets the ghost zones to prescribed values ; for outflow , one typically uses neumann or zero - gradient boundaries ( roache 1998 ) . in the latter case",
    "the interior zones adjacent to the boundaries are simply copied into the ghost zones .",
    "for most astrophysical outflow applications this approach is fine , although strictly speaking when the outflow is subsonic one should use a method - of - lines - based approach to prevent reflections from propagating into the interior ( thompson 1987 ) .",
    "however , when zero - gradient outflow boundaries are used with a self - gravitating fluid , one must take care that the flow in the interior zones adjacent to the boundary is indeed directed outward , else the copying of the velocity component normal to the boundary into the ghost zones will create an artificial ( and destabilizing ) inward flux . for isolated problems we do not prescribe an inflow pattern .",
    "in such cases we therefore implement a form of vacuum boundary in which neumann conditions are used unless the normal velocity in the zones just interior to a boundary is directed inward .",
    "if the normal component of velocity is directed inward , we use dirichlet ( zero - value ) boundaries for it and neumann conditions for the other variables , and we zero the external fluxes ( resulting from the solution of riemann problems on the external boundaries ) if they happen to be inwardly directed . in isolated calculations , therefore , matter which leaves our computational grid disappears altogether and can not return . since the gas is self - gravitating , this would cause problems with the potential if a large clump of material were to leave the grid suddenly . we must therefore take care to select a large enough grid to prevent substantial amounts of material from leaving during the course of a simulation .        at the end of each timestep",
    "we solve the poisson equation ( [ eqn : poisson ] ) for the combined gravitational potential of the gas and dark matter .",
    "if we apply the spatial convolution operator to this equation and use taylor expansions about the cell walls to obtain cell - wall averages of @xmath83 , @xmath84 , and @xmath85 , we obtain the following second - order discretized version , in which only the @xmath47-derivatives are presented for clarity : @xmath86 + \\ldots = } \\hspace{3 in } \\\\",
    "\\nonumber & & { 4\\pi g\\over a^3 }      \\left[(\\rho_{{\\rm g,}ijk}+\\rho_{{\\rm dm,}ijk } ) -      \\overline{{{\\rho_{\\rm g}}}+{{\\rho_{\\rm dm}}}}\\right]\\ .\\end{aligned}\\ ] ] here we define @xmath87 the spatially averaged total density @xmath88 is subtracted from the total density to make the potential tend to zero at large distances from a point source .",
    "the cell - averaged dark matter density @xmath89 is provided by the particle - mesh code .",
    "the complicated form of equations ( [ eqn : discpois])([eqn : discpois coeffs ] ) is due to the nonuniform grid .",
    "if the spacings @xmath90 are identical , the left - hand side of equation ( [ eqn : discpois ] ) reduces to the usual second - order difference @xmath91 .",
    "the densities on the right - hand side of equation ( [ eqn : discpois ] ) are cell - averaged quantities , so the potential which results from solving this equation is also a cell - averaged quantity .",
    "this raises the question of how to obtain the gravitational acceleration @xmath81 , which the discretized gas momentum and energy equations require to be a cell - averaged quantity since it is a source term . with the spatial convolution operator we can obtain an expression for the @xmath47-component of @xmath81 : @xmath92\\ .\\end{aligned}\\ ] ]",
    "we compute the cell - wall - averaged potential ( @xmath93 , etc . )  from the cell averages @xmath94 using taylor expansions of @xmath95 about the cell walls in each direction . as an example , the results for @xmath96 and @xmath93 are @xmath97 where @xmath98\\over ( \\delta x_i+    \\delta x_{i\\pm1})(\\delta x_{i\\pm1}+    \\delta x_{i\\pm2})(\\delta x_i+\\delta x_{i\\pm1}+\\delta x_{i\\pm2})}\\\\ \\nonumber c^\\pm_{2,i } & \\equiv &    - { \\delta x_i\\delta x_{i\\pm1}\\over    ( \\delta x_{x\\pm1}+\\delta x_{i\\pm2})(\\delta x_i+\\delta x_{i\\pm1}+    \\delta x_{i\\pm2 } ) } \\ .\\end{aligned}\\ ] ] for each cell we calculate @xmath81 in this way using the cell average of @xmath20 in that cell and its four nearest neighbors in each coordinate direction , yielding second - order accuracy for @xmath81 .",
    "if the mesh spacing is uniform , the resulting expression for @xmath99 is @xmath100\\ .\\ ] ]      we solve the poisson equation ( [ eqn : poisson ] ) using the full multigrid ( fmg ) method ( brandt 1977 ; hackbusch 1985 ) .",
    "this method is as fast as the direct transform - based methods but can be parallelized more easily and in a more machine - independent fashion .",
    "it also generalizes more easily to nonuniform grids and nonperiodic boundaries .",
    "in addition to the finite - volume discretization described in the previous section , our multigrid implementation features the capability of handling isolated boundary conditions . note that our use of multigrid to compute the gravitational potential is to be distinguished from the solution of potential - flow problems in large - scale structure simulations , in which the hydrodynamical equations also are solved using multigrid techniques .    to implement fmg , we begin by constructing a hierarchy of nested grids , each of which is twice as coarse as the previous one ( figure [ fig : multigrid hierarchy ] ) .",
    "the hierarchy starts with a grid only a few zones across , on which the poisson equation can be solved directly , and ends with a grid identical to that used for the hydrodynamical equations . on each grid level fmg applies an iterative solution method ( here , jacobi ) , bringing errors on all length scales into convergence at the same rate .",
    "our multigrid scheme uses an ascending v - cycle ( figure [ fig : multigrid v - cycle ] ) .",
    "we begin with a guess for the solution on the coarsest grid .",
    "we first apply a few jacobi iterations to the guess ( this smooths the error modes with wavelengths which are short relative to the grid spacing ) , then ` prolongate ' this approximate solution to the next finer level .",
    "our prolongation operator is simple trilinear interpolation using cell - averaged quantities with nonuniform ( though nested ) grids .",
    "after performing a few jacobi iterations at this level , we then calculate the ` residual ' , the difference between the guess and the result of applying the laplacian operator to the density on this grid .",
    "since the poisson equation is linear , the solution to the residual equation is just the correction which must be added to the original guess to obtain the true solution .",
    "however , since long - wavelength error modes are responsible for the jacobi method s slow convergence , the residual on the second level will be dominated by errors that have long wavelengths relative to this grid and shorter wavelengths relative to the coarsest grid . to remove these errors , then , we ` restrict ' the residual back to the coarsest grid and there solve exactly for the correction ( actually several jacobi iterations on this level are sufficient ) . since we are using finite volumes , restriction is equivalent to simple averaging over the fine - grid zones which lie within a given coarse - grid zone . after solving on the coarsest grid for the correction ,",
    "we prolongate the correction back to the second level and apply it to the solution guess on this level .",
    "we repeat this v - cycle twice , then prolongate the solution guess to the next finer level , where we perform three more v - cycles , each time restricting all the way back to the coarsest level .",
    "we repeat this process until we reach the finest level ( the original grid ) .",
    "boundary zones for the multigrid solver must be maintained both on the sides and at the corners of the computational cube for each level of the grid hierarchy , although the corners are only used for prolongations .",
    "the grid levels are nested , so their external boundaries coincide , and dirichlet , neumann , or periodic boundaries are simple to implement .",
    "the primary complication lies in distinguishing between cell - averaged values and cell - wall - averaged values of the potential and the density ; the cell averages in the ghost zones must be chosen so as to make the cell - wall averages of the potential on the boundary possess the desired properties .",
    "we do this by writing the potential as a taylor series about the boundary location in the direction perpendicular to the boundary , then average the series over nearby cells , obtaining a set of equations for the cell - wall averages of the potential and its derivatives in terms of the ( known and unknown ) interior and ghost - zone cell - averaged potential .",
    "we invert these equations ( up to some limiting order ) to obtain the unknown ghost - zone cell average(s ) in terms of the known boundary values and interior - zone cell averages .",
    "isolated boundaries are boundaries outside of which the source function is identically zero . implementing them requires that we specify the value of the potential on the boundary surface . in order to solve for the gravitational potential of isolated matter",
    ", we use a variant of james ( 1977 ) method .",
    "we first calculate the potential assuming dirichlet boundaries .",
    "we then find the image distribution required to make the potential identically zero outside the boundary by evaluating the laplacian of this dirichlet solution on the boundary .",
    "finally , we calculate the isolated potential of the ( hollow ) image distribution by computing its moments up to some maximum multipole and solving with boundary values appropriate to the corresponding multipole expansion of the potential . by subtracting this from the dirichlet solution",
    "we obtain the desired isolated potential .",
    "we reduce the number of multipole moments required by first finding the center of mass of the image distribution and then performing the multipole expansion about this point .",
    "our method is somewhat similar to that of mller & steinmetz ( 1995 ) , who use a spherical - harmonic expansion of the original source function about the center of a spherically symmetric grid to compute the potential at each of the interior grid points .",
    "to handle collisionless components , such as dark matter and stars , we use an @xmath0-body code based on the particle - mesh ( pm ) method ( efstathiou et al .",
    "1985 ; hockney & eastwood 1988 ) . this technique speeds force calculations for particles by converting particle positions to densities on a grid , then solving the poisson equation on the grid using a fast direct or multigrid solver , and finally interpolating the potential from the grid to obtain forces at the particle locations . since we already need to solve the poisson equation on a grid for our hydrodynamical code , the particle - mesh method is ideally suited for integration with this code .",
    "we simply add the equivalent densities for the particles to the grid densities for the gas , then solve the poisson equation as usual . in our case , grid densities for the particles",
    "are computed using the cloud - in - cell ( cic ) operator .",
    "we also use this operator to compute interpolated forces .    other @xmath0-body methods , including particle - particle - particle - mesh ( p@xmath2 m ) and the tree methods ,",
    "are often used to follow the dark matter in cluster simulations . the p@xmath2 m method ( efstathiou & eastwood 1981 ) extends the resolution of particle - mesh by using direct summation for the force between particles lying within a single zone .",
    "tree methods ( hernquist 1987 ) , on the other hand , approximate the force due to distant groups of particles using their low - order multipole moments .",
    "however , because we are using a grid - based hydrodynamical method , we do not expect to resolve features smaller than a single zone .",
    "therefore the considerable execution time expended in the direct summation part ( which scales as the square of the number of particles ) of p@xmath2 m would be wasted . the extra resolution provided by tree codes",
    "would likewise be wasted .",
    "particle - mesh has another advantage for us over tree methods in the ease with which it can be integrated with the gas code .",
    "the main difference between the pm part of cosmos and the ` classic ' pm codes ( e.  g. , efstathiou et al .  1985 ) is our use of a variable timestep . in order to keep the computation accurate to second order",
    ", we need a more complicated version of the standard leapfrog update of position and velocity which makes use of the gravitational acceleration on each particle stored from the preceding timestep .",
    "the resulting update steps ( given here only for the @xmath47 component of position and velocity ) are @xmath101 for the position and @xmath102 \\left [ 1 - \\delta t_{n-1 } { a_n\\over 2 } + \\delta t_{n-1}^2 { a_n^2 +   2\\dot a_n\\over 12 } \\right]\\nonumber \\\\   & & - \\nabla \\phi_{n } \\left [ { \\delta t_{n-1}\\over 2 } + { \\delta t_n^2\\over 6\\delta t_{n-1 } } + { \\delta t_{n-1 } \\over 3 } - { a_n \\delta t_n \\over 6 } \\left ( \\delta t_n + \\delta t_{n-1 } \\right ) \\right ] \\nonumber \\\\   & & - \\nabla \\phi_{n-1 } \\left [ { \\delta t_{n-1}^2 - \\delta t_n^2 \\over 6\\delta t_{n-1 } } - { a_n \\delta t_{n-1 } \\over 12 } ( \\delta t_n + \\delta t_{n-1 } ) \\right ] \\label{eqn : timestep}\\end{aligned}\\ ] ] for the velocity . here",
    "we define @xmath103 . for the first half - timestep",
    "we use a first - order accurate expression to obtain @xmath104 from the initial conditions .",
    "note that the derivatives of the potential from the previous timestep ( here denoted @xmath105 ) must be retained .",
    "this is also necessary in the ppm code in order to make second - order accurate gravitational corrections to the riemann solver , as described by bryan et al .",
    "as with any scientific code of this complexity it is necessary to apply cosmos to a number of test problems with known solutions before using it on research problems . this is important not simply for the purpose of verifying that the code works as it should , but also because it gives us an intuitive understanding of the code s strengths and weaknesses .",
    "such an understanding is essential for making effective use of any hydrodynamical code .",
    "accordingly , we have performed a number of tests which exercise the various code modules in different combinations .",
    "we describe the test problems and the code s performance on each in this section .",
    "the widely used test problem due to sod ( 1978 ) is a riemann shock tube problem with initial conditions specially chosen to produce all three types of fluid discontinuity ( shock , contact discontinuity , and rarefaction ) . in this test",
    "we create two regions of constant density and pressure , separated by a plane whose normal forms specified angles with the @xmath47 and @xmath49 axes . to the left of the plane we set @xmath106 , and to the right we set @xmath107 and @xmath108 .",
    "the ratio of specific heats , @xmath15 , is 1.4 , and the fluid is everywhere at rest .",
    "this test is purely hydrodynamical ; no gravitational potential is used .",
    "the sod test enables us to determine if our code satisfies the shock jump conditions and whether it correctly determines the speed of each nonlinear wave . by performing this essentially one - dimensional test in three dimensions at an angle to the grid",
    ", we can also determine how well we can resolve shocks for realistic grid sizes in 3d .",
    "figure [ fig : sod snapshot ] plots our numerical solution to the sod problem against the analytic solution at @xmath109 .",
    "we used a @xmath110 uniform grid in the box @xmath111 ^ 3 $ ] ; the figure shows profiles taken as a function of distance @xmath112 along the line segment connecting ( 0,0,0 ) and ( 1,1,1 ) ( normal to the shock plane ) .",
    "the initial fluid discontinuity was located at @xmath113 . in constructing the initial conditions we smoothed the discontinuity in each variable over one zone s width to reduce the starting error resulting from the presence of all three nonlinear waves within one zone at early times . since errors in the contact discontinuity",
    "propagate at the speed of the fluid ( and hence of the discontinuity ) , they accumulate at the discontinuity , and any starting error will therefore be present at all later times . even with the initial smoothing a 2% error is present in the density in the three zones in front of the contact discontinuity ; this results in a similar error in the specific internal energy .",
    "apart from this error and a slight underestimation of the slopes in the leftward - moving rarefaction wave , the numerical solution is nearly exact .",
    "the position of each of the three discontinuities is correct , and the shock and contact discontinuity are each resolved using about two zones , despite the fact that the shock is moving at an angle to the grid .",
    "this excellent shock handling is one of the primary reasons for using ppm .      to determine how well our hydrodynamical code respects the @xmath114 rotational symmetry of our grid , and to determine whether this behavior carries over to a nonuniform grid",
    ", we studied the expansion of a strong spherical shock wave into a uniform medium . in this problem , which is again purely hydrodynamical",
    ", we deposit a quantity of energy @xmath115 into a small sphere of radius @xmath116 at the center of the grid .",
    "the pressure inside this volume , @xmath117 , is given by @xmath118 where for this problem we use @xmath119 .",
    "everywhere the density is set equal to @xmath120 , and everywhere but the center of the grid the pressure is set to a small value , @xmath121 .",
    "the fluid is initially at rest .",
    "sedov ( 1959 ) first obtained a self - similar analytic solution to this problem .",
    "a spherically symmetric shock wave develops ; the density , pressure , and radial velocity are all functions of @xmath122 where @xmath123 is a numerical constant depending only on @xmath15 . just behind the shock front at @xmath124",
    "we have @xmath125 where @xmath126 is the speed of the shock wave . near the center of the grid , @xmath127    in figure [ fig : sedov snapshot ] we plot the analytic solution at @xmath128 against the angle average of the numerical solution found by cosmos using a uniform @xmath110 grid in the box",
    "@xmath111 ^ 3 $ ] . at this time",
    "the shock front is located at @xmath129 .",
    "since the grid is cartesian , in the initial conditions we have attempted to minimize geometrical effects due to the shape of the grid by using an initial sphere of radius ( @xmath116 ) 3.5 zones . for each zone containing part of this sphere",
    "we weight the initial pressure according to the fraction of the zone which lies within the sphere using monte carlo averaging . despite these efforts some small errors of geometrical origin are still present , particularly in the velocity field , where some oscillation ( @xmath130 ) can be seen behind the shock",
    "the position of the shock itself is accurate to 12 zones , which is also the width of the shock in the numerical solution .",
    "however , because the shock is narrower than one zone in the analytic solution , the density and pressure in the numerial solution do not reach their maximum analytic values @xmath131 and @xmath132 .",
    "the density is also slightly underestimated near @xmath133 , as is the central pressure .",
    "given the use of a uniform , relatively coarse cartesian grid for this spherically symmetric problem , the position and shape of the shock are well - determined .",
    "to determine the effect of a nonuniform grid on our sedov solution , we solved the same problem on grids with different degrees of nonuniformity .",
    "( the grid in question is static , not an adaptive grid designed to track the explosion more accurately . ) in these runs the @xmath47-axis is nonuniform , and the @xmath49 and @xmath50 axes are uniform . along the @xmath47-axis",
    "the innermost @xmath134 zones are uniform with spacing @xmath135 . outside this region",
    "the zones increase in width by @xmath136 per zone toward the outer edges .",
    "each axis uses 64 zones ; the @xmath49 and @xmath50 axes each enclose the range @xmath111 $ ] , and for the @xmath47-axis we fix @xmath134 at 16 and @xmath135 at 1/64 , allowing @xmath136 to take on several values between 0 and 20% .",
    "( hence the box size in @xmath47 also varies . ) for each run the explosion is thus allowed to develop up to a certain point within the same uniformly gridded region ; thereafter part of the shock front expands into a region of nonuniform gridding .",
    "figure [ fig : sedov asymmetry plot ] shows , as a function of radius , the percentage change in the angle - averaged density at @xmath128 for several values of @xmath136 up to 20% .",
    "each density profile has been interpolated to the same uniform grid .",
    "because the shock is only partly resolved even on the uniform grid at @xmath128 , the increased zone width for large @xmath136 forces the shock to be substantially broadened , leading to an overestimate of the density ahead of the shock and an underestimate behind it .",
    "the average density is also underestimated by a constant 12% well behind the shock for @xmath137 because the broadened shock does not sufficiently compress the ambient medium .",
    "for @xmath138 the magnitude of these effects is much smaller .    as the explosion proceeds in the analytic solution , the width of the shock front increases , and its amplitude decreases .",
    "if the zone size increases much faster than the rate of increase of the width of the shock , the numerical solution will continue to degrade as the shock propagates outward . for this problem the value of @xmath136 at which the zone size begins to increase faster than the shock width appears to lie between 5% and 10% .",
    "in general , the amount of nonuniformity to use must be balanced against the need to resolve fine flow structures near the edge of the grid .",
    "if the zone size is permitted to be too large , the zone - averaged density , pressure , and velocity may be correct , but the position and size of flow structures will be poorly determined , and their dynamical effects ( such as heating and compression ) on the surrounding gas will also be in error .      using the jeans instability we verified that the gas dynamical terms involving the gravitational potential are correctly implemented in cosmos . to do this we studied the dispersion relation of stable perturbations to a uniform , self - gravitating medium .",
    "the initial conditions for this problem , which we solved in two dimensions with periodic boundaries , are , at time @xmath139 , @xmath140 \\\\",
    "\\nonumber p(x , y , t_i )     & = & p_0\\left[{1 + \\gamma\\delta\\cos(\\kappa",
    "x)\\cos(\\kappa y)}\\right ] \\\\ v_x(x , y , t_i )   & = & { \\delta|\\omega|\\over \\sqrt{2}\\kappa }          \\left[{\\sin(\\kappa x)\\cos(\\kappa y)\\over 1-\\delta\\cos(\\kappa x)\\cos(\\kappa y)}\\right ] \\\\ \\label{eqn : jeans initial conditions } \\nonumber v_y(x , y , t_i )   & = & { \\delta|\\omega|\\over \\sqrt{2}\\kappa }          \\left[{\\cos(\\kappa x)\\sin(\\kappa y)\\over 1-\\delta\\cos(\\kappa x)\\cos(\\kappa y)}\\right]\\ , \\end{aligned}\\ ] ] where the perturbation amplitude @xmath141 , and where @xmath142 is defined as follows . the stability of the perturbation is determined by the relationship between the wavenumber @xmath143 and the jeans wavenumber @xmath144 ( chandrasekhar 1961 ) , where @xmath144 is given by @xmath145 and where @xmath146 is the sound speed : @xmath147 if @xmath148 , the perturbation is stable and oscillates with frequency @xmath149 otherwise it grows exponentially , with a characteristic timescale given by @xmath150 .",
    "we checked the dispersion relation ( [ eqn : jeans dispersion relation ] ) for stable perturbations with @xmath151 by fixing @xmath152 and @xmath153 and performing several runs with different @xmath154 .",
    "we followed each case for roughly ten oscillation periods using a uniform @xmath155 grid in the box @xmath156 ^ 2 $ ] with units in which @xmath157 .",
    "( the box size is chosen so that @xmath144 is smaller than the smallest nonzero wavenumber which can be resolved on the grid .",
    "this prevents numerical errors at wavenumbers less than @xmath144 from being amplified by the physical jeans instability . )",
    "we then computed the oscillation frequency in each case by measuring the time interval required for the density at the center of the grid to undergo exactly ten oscillations .",
    "the resulting dispersion relation is compared to equation ( [ eqn : jeans dispersion relation ] ) in figure [ fig : jeans dispersion plot ] .",
    "it can be seen from this plot that our code correctly reproduces equation ( [ eqn : jeans dispersion relation ] ) . at the highest wavenumber ( @xmath158 ) , each oscillation is resolved using only about 9 cells , and the average timestep ( which depends on @xmath146 , @xmath159 , and @xmath160 , and has nothing to do with @xmath154 ) turns out to be about one - fifth of an oscillation . hence the frequency determined from the numerical solution for this value of @xmath154 is somewhat more poorly determined than for the other runs .",
    "overall , however , the frequencies are correct to about 1% .",
    "the cosmological pancake problem ( zeldovich 1970 ) provides a good simultaneous test of the self - gravity and cosmological expansion code .",
    "analytic solutions well into the nonlinear regime are available for both @xmath0-body and hydrodynamical codes ( anninos & norman 1994 ) , permitting an assessment of the code s accuracy . after caustic formation",
    "the problem provides a stringent test of the code s ability to track thin , poorly resolved features and strong shocks using most of the basic physics needed for cosmological problems .",
    "also , as pancakes represent single - mode density perturbations , coding this test problem is useful as a basis for creating more complex initial conditions .",
    "we set the initial conditions for the pancake problem in the linear regime using the analytic solution given by anninos and norman ( 1994 ) . in a universe with @xmath161 at redshift @xmath50 ,",
    "a perturbation of wavenumber @xmath154 which collapses to a caustic at redshift @xmath162 has comoving density and velocity given by @xmath163^{-1}\\\\ \\nonumber v(x_e;z )     & = & -h_0(1+z)^{1/2}(1+z_c){\\sin kx_\\ell\\over kx_\\ell}\\ , \\end{aligned}\\ ] ] where @xmath164 is the comoving mean density . here",
    "@xmath165 is the distance of a point from the pancake midplane , and @xmath166 is the corresponding lagrangian coordinate , found by iteratively solving @xmath167 the temperature solution is determined from the density under the assumption that the gas is adiabatic with ratio of specific heats @xmath15 : @xmath168^{\\gamma-1}\\ .\\ ] ] the mean temperature @xmath169 is specified at a redshift @xmath170 .    at caustic formation ( @xmath171 )",
    ", planar shock waves form on either side of the pancake midplane and begin to propagate outward .",
    "a small region at the midplane is left unshocked . immediately behind the shocks , the comoving density and temperature vary approximately as @xmath172 at the midplane , which undergoes adiabatic compression , the comoving density and temperature are approximately @xmath173 ^ 3          \\left[{3h_0 ^ 2\\mu\\over k_b\\bar{t}_{\\rm fid}k^2 }          { \\left(1+z_c\\right)^4\\left(1+z\\right)^3\\over",
    "1+z_{\\rm fid}}\\right]^{1/\\gamma}\\\\ \\nonumber t_{\\rm center } & \\approx &          { 3h_0 ^ 2\\mu\\over k_bk^2 } \\left(1+z\\right)^2          \\left(1+z_c\\right)^4{\\bar{\\rho}\\over\\rho_{\\rm center}}\\ .\\end{aligned}\\ ] ]    to test the convergence of the code , we performed several different one - dimensional pancake test runs with fixed perturbation wavelength and caustic redshift and varying spatial resolution .",
    "each run used @xmath174 , @xmath175 , and an initial redshift @xmath176 . in each run",
    "we also fixed @xmath177 , @xmath178  k , @xmath151 , @xmath161 , and @xmath179  km  s@xmath180  mpc@xmath180 .",
    "we assumed a 75% h/25% he composition for the purpose of computing the pressure using the temperature . using the analytic solution ( eqs .",
    "[ [ eqn : pancake soln 1 ] ]  [ [ eqn : pancake soln 2 ] ] ) , we computed l1 error norms for density and temperature in each run at @xmath181 , in the mildly nonlinear phase of the collapse .",
    "we define the l1 error norm as in equation ( [ eqn : l1 error ] ) below .",
    "the results appear in figure [ fig : pancake conv ] .",
    "the density converges slowly , with the error varying approximately as @xmath182 .",
    "the temperature converges more rapidly , with the error varying as @xmath183 for @xmath184 and then as @xmath185 for smaller @xmath159 .",
    "the roughly linear asymptotic convergence for the temperature is consistent with other work , for example that of bryan et al .",
    "( 1995 ) , but the density convergence rate is somewhat slower .",
    "nevertheless , the absolute error of a few percent for @xmath186@xmath187 is consistent with their results for both variables .    to examine the performance of cosmos on this problem in multidimensions , we performed a run with the same initial conditions using a doubly periodic @xmath188 grid .",
    "the pancake midplane was inclined @xmath189 to the @xmath47 axis , and the zone spacing was chosen so that two wavelengths fit into the box diagonal . in figure",
    "[ fig : pancake comp ] the results of this run are compared to the 256-zone 1d solution at three different redshifts corresponding to the mildly nonlinear regime ( @xmath190 ) , the time immediately following caustic formation ( @xmath191 ) , and a time well into the nonlinear , post - caustic evolution ( @xmath192 ) .",
    "the profiles for the @xmath188 run are derived by interpolating along the grid diagonal . in this run",
    "only 128 zones fit within a perturbation wavelength , so the spatial resolution is one - half that of the 1d 256-zone run . with the exception of the innermost 12 zones , the 2d results are typically within a few percent of the 1d results .",
    "differences of note include a 20% underdensity in the 2d case at @xmath190 and a significant overestimate in the central temperature at @xmath191 . in the latter case",
    "the caustic is unresolved by the mesh , and only the innermost zone is hot .",
    "the velocity in the innermost zone is different by as much as a factor of two at all three redshifts .",
    "we tested the potential solver with isolated boundaries using the miyamoto - nagai potential ( miyamoto & nagai 1975 ) .",
    "this is an axisymmetric , flattened potential designed to mimic the light distribution of a disk galaxy .",
    "it is given in cylindrical coordinates by @xmath193 where @xmath194 is the total mass , and the ratio of the axis parameters @xmath195 determines how flattened the potential is . as @xmath196 , @xmath197 tends toward the kuzmin disk potential , and as @xmath198 , @xmath197 tends toward the spherically symmetric plummer potential .",
    "thus for different @xmath195 values @xmath197 contains different contributions from high - order multipole moments , making this a good test of our moment - based isolated boundary solver .",
    "the density function corresponding to this potential is straightforward to derive using the poisson equation ; it is @xmath199^{5/2 }                \\left(z^2+b^2\\right)^{3/2}}\\ .",
    "\\label{eqn : miyamoto - nagai density}\\ ] ]    using this density function we computed miyamoto - nagai potentials with the isolated poisson solver in cosmos for @xmath200 , @xmath201 , and @xmath202 using a @xmath203 grid in boxes containing 9899% of the total mass . the innermost one - half of the zones in each dimension were uniform , and the remainder increased in width by 5% per zone toward the outside edges .",
    "we used units in which @xmath204 .    in our treatment of isolated boundaries",
    "we compute boundary values for the image potential using a truncated multipole expansion of the image mass distribution . to verify that this expansion was implemented correctly , we performed runs with four different values of @xmath205 , the largest multipole moment . in figure",
    "[ fig : miyamoto - nagai error plot ] we plot average errors for our computed potentials as a function of @xmath205 for our three values of @xmath195 .",
    "we define the error @xmath206 as @xmath207 where the sum is taken over all of the cells in the grid , and the total volume @xmath208 of the grid is the sum of cell volumes @xmath209 .",
    "figure [ fig : miyamoto - nagai error plot ] shows that including only the first three multipole terms already gives a fairly good estimate of the potential ; the maximum percentage error in any cell for @xmath210 is between 6.5% and 7.5% , and the plotted averages range from 2.2% to 2.7% .",
    "increasing the value of @xmath205 brings the average and maximum errors down substantially , showing that the isolated boundary solver is including higher - order moments properly .",
    "the curves begin to level off at values less than 1% above @xmath211 ; this level of error is consistent with the amount of mass which lay outside the grid and hence was excluded from each calculation .",
    "the maximum error at @xmath212 is about 1.5% in all three cases .    for other problems",
    "the multipole content of the density field may differ , so these test results do not show that 1% errors will be achieved with @xmath213 for any arbitrarily chosen density field",
    ". however , this will be true even for quite flattened density fields .",
    "errors caused by underestimating @xmath205 will be largest near the boundaries of the grid as long as most of the mass is near the center .      because of the particle - mesh force - smoothing procedure , dark matter particles experience an effective potential that deviates from the newtonian @xmath214 dependence at small interparticle separations @xmath215 .",
    "this deviation is greatest on length scales less than or comparable to the zone spacing @xmath216 .",
    "in addition , the introduction of a grid breaks the rotational symmetry of the equations of motion , so interparticle forces are not isotropic for @xmath217 .",
    "when performing simulations in which small - scale structure ( relative to the grid in use ) appears , it is important to have an estimate of the magnitude of these errors and the value of @xmath218 at which they become important .    to quantify these effects",
    ", we performed a test in which we chose 10,000 randomly placed pairs of particles on a @xmath219 grid , computed forces for each pair using the multigrid solver and particle - mesh code from cosmos , and tabulated the resulting forces as functions of the particle positions .",
    "the first particle in each pair was chosen to lie within one zone of the center of the grid , while the second particle was chosen to lie between 0.1 and 10 zones from the first , with a random position angle relative to the first . in this test",
    "each particle had unit mass , and the value of @xmath220 was unity . for the @xmath221th particle of the @xmath222th pair we computed radial ( @xmath223 ) and azimuthal ( @xmath224 ) force components relative to the line connecting the particle to its partner ; then for the pair we computed the average of the magnitudes of the radial and the azimuthal components for the two particles : @xmath225 where @xmath226 .",
    "we collected the particle pairs in radial bins of logarithmic width 0.05 , then computed mean and rms deviations for the binned forces .    in figure",
    "[ fig : force test ] we show the results as functions of radius .",
    "overall the results are comparable to those obtained by efstathiou et al .",
    "( 1985 ) : our effective particle force resolution is about two zones . for @xmath227 the mean radial force is 50% of the expected value , and the force anisotropy ( ratio of mean azimuthal to mean radial force ) is about 13% . for particle separations smaller than this , the mean radial force is proportional to @xmath215 , and the force anisotropy is roughly constant at around 7% .",
    "as @xmath228 the azimuthal force drops as @xmath229 , so the force anisotropy drops approximately as @xmath230 . at @xmath231",
    "the azimuthal force turns upward slightly ; this illustrates the effect of placing the second particle of some pairs within 45 zones of the grid boundary .",
    "we discuss this effect in more detail below .    for particle separations less than one zone , the rms deviations in the radial and azimuthal force components are each roughly constant at 20% and 5% , respectively , of the mean radial force . for @xmath232",
    "the radial rms deviation drops to about 7% of the radial mean , while the azimuthal rms deviation decreases almost as fast as the mean azimuthal force , becoming less than 0.2% of the radial mean at @xmath233 .",
    "the azimuthal rms deviation also shows a slight upturn for particles close to the boundary .    the deviations from a @xmath234 force law at large @xmath215 result from a self - force felt only by particles close to the edge of the grid .",
    "as hockney and eastwood ( 1988 ) show , self - forces arise in pm schemes when either the density assignment and force interpolation operators differ or the effective green s function @xmath235 fails to satisfy the criterion @xmath236 the effective green s function is related to the zone - averaged gravitational field @xmath81 by @xmath237 where @xmath238 is the density assigned to the grid by the particle - mesh scheme , @xmath239 is the volume of a single grid zone , and the sum is taken over all zones . because we use the cic operator both to assign densities to the grid and to interpolate forces to particle positions , any self - forces are due to errors in the potential which cause @xmath240 to violate equation ( [ eqn : green criterion ] ) . in our case ,",
    "errors in @xmath240 arise because we use a finite multipole expansion to obtain boundary conditions for isolated problems .",
    "we have examined this effect by performing another test in which one particle is placed at the center of the grid and the second particle is placed at increasing distances from the center along one coordinate axis . by varying the grid size , we can use this test to determine how close to the edge of the grid a particle can be before it experiences a significant self - force . for this test",
    "we use @xmath211 in the multigrid solver .",
    "figure [ fig : force test 2 ] compares the results on grids with @xmath241 , @xmath219 , and @xmath110 zones . in each case",
    "the force on the second particle begins to deviate from the expected value when the second particle is about five zones from the edge of the grid .",
    "note that the two - particle potential is more susceptible to this effect than the miyamoto - nagai test potential because of the relative importance in this case of mass close to the edge of the grid .",
    "the effect is important only for small numbers of particles close to the edge of the grid ; it is not important for particles near the boundary orbiting in the potential of a large group of particles near the center , and it is not present when periodic boundary conditions are used .        to account for the varying timestep size , cosmos implements equation ( [ eqn : timestep ] ) to update the dark matter positions and velocities . to test this algorithm , we set up two particles in a simple circular orbit and monitored the accuracy of the orbit as we varied the timestep @xmath68 and the zone size @xmath159 .",
    "in addition to testing the algorithm , this problem enables us to determine the regions in @xmath242 space that are appropriate for larger , more interesting problems .",
    "figure [ fig : dm_orbit ] shows the root mean square ( rms ) error in the interparticle separation after six orbital periods as a function of @xmath159 . for @xmath159 larger than the particle separation , the @xmath234 force is calculated incorrectly due to the mesh smoothing .",
    "the problem of resolving forces on scales smaller than a zone size is a well - known one ; figure [ fig : dm_orbit ] simply points out that our force resolution is roughly one or two zones .",
    "for very small @xmath159 , on the other hand , each particle traverses more than one zone in a single timestep , which again leads to large errors . to alleviate this second problem , in production runs we choose @xmath68 with the requirement that no dark matter particle travel more than a fraction @xmath243 of a zone during a single timestep : @xmath244\\ , \\ ] ] where @xmath245 are the indices of the zone containing the @xmath12th particle .",
    "figure [ fig : dm_orbit ] shows that setting this fraction equal to one is an acceptable choice .",
    "the two groups of points in this plot correspond to different ratios of the timestep to the orbital period .",
    "if we denote this ratio by @xmath52 , then we require @xmath246 for accuracy .",
    "the squares indicate runs with @xmath247 , and the triangles indicate runs with @xmath248 .",
    "if we choose @xmath249 , then the two groups of runs require @xmath250 and @xmath251 respectively .",
    "for the first group , runs with @xmath252 are observed to be relatively accurate , while for the second group , the error is low for @xmath253 . in the regime where the zone size is not too big or too small relative to the timestep",
    ", we see that the cumulative error does indeed scale as @xmath254 : the algorithm of equation ( [ eqn : timestep ] ) is accurate to second order .      a well - known cosmological problem with an analytic solution is the case of a spherical overdensity ( e.  g. , padmanabhan 1993 ) .",
    "the solution to this problem is best described in terms of the radius @xmath255 which encloses a mass @xmath194 at time @xmath256 : @xmath257       { 1 + \\delta_i \\over \\delta_i}\\ .",
    "\\label{eqn : shell}\\ ] ] here @xmath258 and @xmath259 denote the time and fractional overdensity at which the simulation starts .",
    "the parameter @xmath260 is a timelike parameter ; in a flat , matter - dominated universe , the redshift can be expressed in terms of @xmath260 as @xmath261^{-2/3}.\\ ] ] equation ( [ eqn : shell ] ) holds until the radius reaches a maximum value at @xmath262 , after which time virialization occurs .    on a @xmath219 grid with @xmath219 particles we set up spherically symmetric initial conditions . in units in which the cell size is unity , within a radius of five units from the center of the grid we constructed a uniform overdensity with @xmath263 . in an annulus ranging from @xmath264 to @xmath265 we placed an underdensity so that the average density within @xmath265 was equal to the background density .",
    "figure [ fig : dm_spherical ] shows the time evolution of several ( comoving ) radii , compared with the analytic result of equation ( [ eqn : shell ] ) .",
    "the larger shells track the analytic solution well , verifying that all factors of @xmath5 are correctly implemented in the dark matter code .",
    "as expected , the small shells do worse : the force on these shells comes predominantly from particles concentrated at a distance of one to two zones .",
    "the deviations from equation ( [ eqn : shell ] ) for these shells are consistent with the underestimate of the gravitational force introduced by the particle - mesh smoothing at this distance .",
    "the zeldovich pancake ( section [ sec : gas pancake ] ) also serves as a test of the @xmath0-body code .",
    "to initialize this problem , we place particles at the zone centers of a @xmath241-zone grid , then perturb their positions slightly in the @xmath47-direction by amounts @xmath266 with @xmath267 the unperturbed positions and @xmath154 an integer .",
    "small - scale perturbations correspond to large @xmath154 .",
    "we consider only perturbations which vary on scales larger than a zone width , ie .  those with @xmath268 . if the particles peculiar velocities @xmath269 are also proportional to @xmath270 , then in the linear regime ( assuming a flat universe ) both @xmath271 and @xmath269 should grow with time as the scale factor @xmath5 .    to determine how accurately their code could follow such perturbations , efstathiou et  al .  ( 1985 ) tabulated the rms deviation of position and velocity from the analytic solution for particles on a @xmath241 mesh .",
    "since we solve poisson s equation differently than the standard pm code , it is useful to compare our results with theirs . figure [ fig : cdeltarms ] shows the rms errors in position and velocity for linear perturbations with several different values of the wavenumber @xmath154 .",
    "the multigrid solver and variable - timestep integrator used in cosmos produce results quite similar to ( but slightly better than ) the fft / fixed - timestep technique used by efstathiou et  al .",
    "in this paper we have described cosmos , a new hybrid code for solving cosmological problems involving gas and collisionless matter , including self - gravity , cosmological expansion , and radiative cooling .",
    "cosmos solves the inviscid fluid equations using the piecewise - parabolic method on a static , nonuniform structured grid .",
    "the code treats collisionless matter using the cloud - in - cell variant of the particle - mesh method , and it computes the gravitational potential using a linear full multigrid solver .",
    "cosmos supports both periodic boundaries , suitable for large - scale structure problems , and isolated boundaries , suitable for simulations of isolated systems .",
    "this code has already been used to study mergers between clusters of galaxies by ricker ( 1998 ) and ricker & sarazin ( 2000 ) .",
    "several new features of cosmos distinguish it from other existing pm - ppm codes .",
    "in particular , the multigrid poisson solver can determine the gravitational potential of isolated matter distributions and properly takes into account the finite - volume discretization required by ppm .",
    "all components of the code are constructed to work with a nonuniform mesh , preserving second - order spatial differences .",
    "the ppm code uses vacuum boundary conditions for isolated problems , preventing inflows when appropriate .",
    "the pm code uses a second - order variable - timestep time integration scheme . in this paper",
    "we have discussed the equations solved by cosmos and described the algorithms used , with emphasis on these features .",
    "we have also reported on results from a suite of standard test problems , demonstrating that cosmos works as expected .",
    "in closing we note some implementation details .",
    "cosmos is designed to run on parallel computers using the parallel virtual machine ( pvm ) message - passing library .",
    "a version using the message - passing interface ( mpi ) is currently under development .",
    "also , cosmos features a modular design which simplifies the addition of new physics and the configuration of the code for different types of problems .",
    "the modular design of cosmos has served as the basis for flash , an adaptive mesh - refinement ppm code currently under development at the university of chicago asci flash center .",
    "details of the flash code design will appear in a forthcoming paper ( fryxell et al .",
    "1999 ) .",
    "pmr would like to thank craig sarazin for advice and support during the completion of this work and bruce fryxell , kevin olson , and peter macneice for useful and stimulating discussions during its initial stages .",
    "he also acknowledges support from nasa through a gsrp fellowship ( ngt-51322 ) and nag 5 - 3057 , as well as support from the doe asci flash center under contract b341495 .",
    "sd is supported by nasa under nag 5 - 7092 and the doe .",
    "dql acknowledges support from nasa under nag 5 - 2868 .",
    "the calculations reported here were performed at the pittsburgh supercomputing center , the san diego supercomputer center , and the texas advanced computing center .",
    "anninos , w.  y.  &  norman , m.  l.  1994 , apj , 429 , 434 brandt , a.  1977 , math .",
    ", 31 , 333 bryan , g.  l. , norman , m.  l. , stone , j.  m. , cen , r. ,  &  ostriker , j.  p.  1995",
    "comm . , 89 , 149 chandrasekhar , s.  1961 , hydrodynamic and hydromagnetic stability ( oxford : clarendon ) cen , r.  1992 , apjs , 78 , 341 colella , p.  1985 , siam j.  sci .",
    "6 , 104 colella , p.  &  glaz , h.  m.  1985 , j.  comp .",
    "phys . , 59 , 264 colella , p.  &  woodward , p.  1984",
    ", j.  comp .",
    "phys . , 54 , 174 couchman , h.  m.  p. , thomas , p.  a. ,  &  pearce , f.  r.  1995 , apj , 452 , 797 douglas , c.  c.  1992 , siam news , 25 , 14 efstathiou , g. , davis , m. , frenk , c.  s. , & white , s.  d.  m.  1985 , apjs , 57 , 241 efstathiou , g.  &  eastwood , j.  w.  1981 , mnras , 194 , 503 evrard , a.  e.  1988 , mnras , 235 , 911 frenk , c.  s.  et al .",
    "1999 , apj , 525 , 554 fryxell , b.  et al .  1999 ,",
    "apjs , submitted gheller , c. , pantano , o. ,  &  moscardini , l.  1998 , mnras , 295 , 519 gingold , r.  a.  &  monaghan , j.  j.  1977 , mnras , 181 , 375 gnedin , n.  y.  1995 , apjs , 97 , 231 godunov , s.  k.  1959 , mat .",
    "sbornik , 47 , 271 hackbusch , w.  1985 , multi - grid methods and applications ( berlin : springer - verlag ) harten , a.  1983 , j.  comp .",
    "phys . , 49 , 151 hernquist , l.  1987 , apjs , 64 , 715 hernquist , l.  &  katz , n.  1989 , apjs , 70 , 419 hockney , r.  w.  &  eastwood , j.  w.  1988 , computer simulation using particles ( bristol : iop ) kang , h. , ostriker , j.  p. , cen , r. , ryu , d. , hernquist , l. , evrard , a.  e. , bryan , g.  l. ,  &  norman , m.  l.  1994 , apj , 430 , 83 kritsuk , a. , bhringer , h. ,  &  mller , e.  1998 , mnras , 301 , 343 james , r.  a.  1977 , j.  comp .",
    "phys . , 25",
    ", 71 van leer , b.  1979 , j.  comp .",
    "32 , 101 lucy , l.  b.  1977 , aj , 82 , 1013 miyamoto , m.  &  nagai , r.  1975 , pasj , 27 , 533 mller , e.  &  steinmetz , m.  1995 , comp .",
    ", 89 , 45 navarro , j.  f.  &  white , s.  d.  m.  1993 , mnras , 265 , 271 norman , m.  l.  &  bryan , g.  l.  1999 , in numerical astrophysics 1998 , eds .",
    "s.  m.  miyama , k.  tomisaka ,  &  t.  hanawa ( boston : kluwer ) owen , j.  m. , villumsen , j.  v. , shapiro , p.  r. ,  &  martel , h.  1998 , apjs , 116 , 155 padmanabhan , t.  1993 , structure formation in the universe ( cambridge : cup ) peebles , p.  j.  e.  1993 , principles of physical cosmology ( princeton , nj : princeton univ .",
    "press ) pen , u .- l .  1998 , apjs , 115 , 19 press , w.  h. , teukolsky , s.  a. , vetterling , w.  t. ,  &  flannery , b.  p.  1992",
    ", numerical recipes in fortran , 2d ed .",
    "( cambridge : cambridge univ .  press ) quilis , v. , ibez , j.  m. ,  &  sez , d.  1996 , apj , 469 , 11 quilis , v. , ibez , j.  m. ,  &  sez , d.  1998 , apj , 502 , 518 ricker , p.  m.  1998 , apj , 496 , 670 ricker , p.  m.  &  sarazin , c.  l. , 2000 , in preparation roache , p.  j.  1998 , fundamentals of computational fluid dynamics , 2d ed .",
    "( albuquerque : hermosa ) roe , p.  l.  1981 , j.  comp .",
    "phys . , 43 , 357 roettiger , k. , stone , j.  m. ,  &  mushotzky , r.  f.  1997 , apj , 482 , 588 ryu , d. , ostriker , j.  p. , kang , h. ,  &  cen , r.  1993 , 414 , 1 sedov , l.  i.  1959 , similarity and dimensional methods in mechanics ( new york : academic ) sod , g.  1978 , j.  comp .",
    "phys . , 27 , 1 sornborger , a. , fryxell , b. , olson , k. ,  &  macneice , p.  1996 , astro - ph/9608019 steinmetz , m.  1996 , mnras , 278 , 1005 strang , g.  1968 , siam j.  numer .",
    ", 5 , 506 thompson , k.  w.  1987 , j.  comp .",
    "phys . , 68 , 1 zeldovich , ya",
    ".  b.  1970 ,  , 5 , 84"
  ],
  "abstract_text": [
    "<S> we describe a new hybrid @xmath0-body / hydrodynamical code based on the particle - mesh ( pm ) method and the piecewise - parabolic method ( ppm ) for use in solving problems related to the evolution of large - scale structure , galaxy clusters , and individual galaxies . </S>",
    "<S> the code , named cosmos , possesses several new features which distinguish it from other pm - ppm codes . </S>",
    "<S> in particular , to solve the poisson equation we have written a new multigrid solver which can determine the gravitational potential of isolated matter distributions and which properly takes into account the finite - volume discretization required by ppm . </S>",
    "<S> all components of the code are constructed to work with a nonuniform mesh , preserving second - order spatial differences . </S>",
    "<S> the ppm code uses vacuum boundary conditions for isolated problems , preventing inflows when appropriate . </S>",
    "<S> the pm code uses a second - order variable - timestep time integration scheme . </S>",
    "<S> radiative cooling and cosmological expansion terms are included . </S>",
    "<S> cosmos has been implemented for parallel computers using the parallel virtual machine ( pvm ) library , and it features a modular design which simplifies the addition of new physics and the configuration of the code for different types of problems . </S>",
    "<S> we discuss the equations solved by cosmos and describe the algorithms used , with emphasis on these features . </S>",
    "<S> we also discuss the results of tests we have performed to establish that cosmos works and to determine its range of validity . </S>"
  ]
}