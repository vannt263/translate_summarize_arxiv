{
  "article_text": [
    "the analysis of the spectral properties of the light intensity and its polarization state is the basis of modern solar physics .",
    "for over two decades , least - squares profile fitting has been the method of choice ( see @xcite @xcite ; @xcite @xcite and references therein ) .",
    "many different inversion codes , based on a variety of physical models , have been developed and used extensively for the determination of magnetic and thermodynamic conditions in the atmosphere .",
    "while the use of least - squares fitting has important benefits , there is an increasing demand for alternative procedures that are faster and more robust . by robust i mean capable of operating reliably without human intervention on a routine basis",
    "this demand is driven by the development of a new generation of spectro - polarimeters , which will deliver enormous data flows ( solis , @xcite @xcite ; solar - b , @xcite @xcite ; sunrise , @xcite @xcite ; dlsp , @xcite @xcite ) .",
    "the attention of solar physicist has turned in recent years towards a new breed of diagnostic techniques based on pattern recognition and machine learning .",
    "a considerable number of papers has been devoted to the investigation of these techniques ( @xcite @xcite ; @xcite @xcite ; @xcite @xcite ; @xcite @xcite ; @xcite @xcite ; @xcite @xcite ; @xcite @xcite ) .",
    "most of those works deal with the principal component analysis , which is a series expansion of the spectra .",
    "another line of research explores the use artificial neural networks ( anns ) , which show considerable promise for the inversion of spectral observations ( @xcite @xcite ; @xcite @xcite ) .",
    "the work presented here demonstrates the applicability of anns to actual observed data in typical working conditions .",
    "the radiative transfer computations that are needed to synthesize training profiles have been carried out using the milne - eddington approximation .",
    "this is helpful to simplify the problem and to allow for the synthesis of thousands of profiles in a reasonable computing time .",
    "all the calculations done for this work , and the cpu times quoted below , were obtained using a pentium  iv processor running at 1.2  ghz .",
    "the ann inversions require very little computational resolurces both in terms of processor speed and memory storage .",
    "the training algorithm , on the other hand , can be very demanding .",
    "an ann is a structure of interconnected neurons , where each neuron is a memory cell with the capability to store a real number .",
    "the number stored in a neuron can be modified according to the contents of its neighbors and the `` synaptic weights '' that connect each pair of neurons .",
    "a perturbation in the contents of a neuron propagates through the network following the structure of connections and synaptic weights . for a sake of tractability , it is customary to consider _ forward - propagating _ networks .",
    "these anns have a well defined signal propagation direction , starting at a set of input neurons and ending at the outputs .",
    "no feed - back loops are allowed in forward - propagating networks .    as a further simplification",
    ", we shall be concerned only with a particular network configuration : the _ multilayer perceptron_. in this configuration the neurons are arranged in successive layers .",
    "each neuron in any given layer has connections to all neurons in the previous layer .",
    "no connections are allowed between non - successive layers .",
    "an arbitrary number of intermediate layers may exist between the inputs and outputs .",
    "these are usually referred to as `` hidden '' layers in the ann literature",
    ". a schematic representation of a multi - layer perceptron with hidden layers is given in fig  [ fig : mlp ] .",
    "when a set of input data is introduced in the ann , it is propagated forward according to the following rule : @xmath1 in eq  ( [ annprop ] ) , @xmath2 represents the contents of neuron @xmath3 in layer @xmath4 , @xmath5 is the synaptic weight of the connection between this neuron and neuron @xmath6 in layer @xmath7 and @xmath8 is a bias level .",
    "we consider the input neurons as layer @xmath9 .",
    "one or more of the ann layers may have a non - linear `` activation function '' @xmath10 .",
    "the anns used in this work all have : @xmath11    the hyperbolic tangent is a common choice for the non - linear activation function in many ann applications and has been adopted here for that reason .",
    "other suitable functions are likely to exist , but will not be pursued here .",
    "after some experimentation with a simplified problem , the parameters @xmath12 and @xmath13 have been set to @xmath14 and @xmath15 , respectively .",
    "conceptually , a multilayer perceptron may be viewed as a non - linear mapping @xmath16 between two multi - dimensional spaces .",
    "we can write down : @xmath17 where @xmath18 is an n - dimensional input vector and @xmath19 is an m - dimensional output vector .",
    "it can be shown ( e.g. , @xcite @xcite ; @xcite @xcite ) that a multilayer perceptron with at least one hidden non - linear layer is able to approximate any continuous multidimensional non - linear function to any arbitrary precision , provided only that enough neurons are employed .",
    "this is a very interesting mathematical property that has received considerable attention in the ann literature , since it provides a solid foundation for many applications .",
    "an ann is fully characterized by its structure and the individual properties of its neurons .",
    "the network structure is defined by a set of parameters such as the number of layers @xmath20 , the number of neurons in a given layer @xmath21 ( where @xmath4 denotes the layer ) , and the activation function of each layer @xmath10 which can only be one of the two options given explicitly in eq  ( [ activation ] ) above . according to the choice of @xmath22 we shall use the terminology of linear / non - linear layers .",
    "the other set of parameters that completely defines an ann consists of the neural biases and synaptic weights ( @xmath8 and @xmath5 in eq  [ [ annprop ] ] ) for each single neuron .",
    "the most important difference between these two sets of parameters is that the network structure is established _ a priori _ for a given problem and then kept fixed throughout .",
    "the neuron properties ( synaptic weights and biases ) , however , are adaptive parameters that are continuously adjusted during the ann training process ( described below ) to optimize the network performance .",
    "although there are algorithms that modify the network structure during the training process seeking the optimum configuration , i have not made use of such techniques in the present work .",
    "the various ann structures used here are the result of a number of trial - and - error experiments",
    ". a detailed study of the impact that the ann structure has on its performance would be tremendously expensive from a computational point of view due to the long processing times involved in training a single network ( typically several days running on a modern workstation ) .",
    "the anns used for the calculations in this work have two linear and two non - linear layers interleaved .",
    "all layers , including the inputs , contain the same number of neurons ( rectangular anns ) .",
    "the exception to this is the aann of  [ sec : preproc ] which has a smaller number of neurons in one of the hidden layers .",
    "the previous section described the structure of a typical ann with particular emphasis on the case of the multilayer perceptron , because this is the type of ann employed here .",
    "however , nothing has been said thus far about the particular values that should be given to @xmath5 and @xmath8 .",
    "it is obvious that the behavior of the ann will be dictated by these parameters , which define the actual mapping @xmath16 performed by the ann .",
    "the optimal synaptic parameters are obtained by means of a `` training '' process . for the training",
    "we need a large set of input vectors @xmath23 and the solutions or outputs @xmath24 that we wish the ann to find ( for this reason the outputs are sometimes referred to as `` targets '' ) . to fix ideas ,",
    "suppose that we are training an ann to take a set of observed spectral profiles as inputs and return as outputs some parameters of the atmosphere in which the profiles originated ( e.g. , temperature , velocity or magnetic field ) . in this case",
    ", the @xmath23 are the observable quantities and the @xmath24 are the atmospheric conditions ( in practical situations , one should first pre - process the inputs and outputs as explained below ; therefore these parameters are related to the actual physical quantities but they are not the quantities themselves ) .",
    "it might seem that , in order to generate a suitable training set one needs to invert the @xmath23 in order to produce the @xmath24 , which would require the use of some sort of inversion procedure .",
    "however , this is not necessarily the case .",
    "one could start with the atmospheric parameters ( from which the @xmath24 are calculated ) and then solve the forward problem to synthesize spectral profiles ( thus obtaining the @xmath23 ) .",
    "when the input data are forward - propagated through the ann we obtain a set of outputs @xmath25 which are , in general , different from the targets @xmath24 .",
    "the training algorithm seeks to minimize the difference between the outputs @xmath25 and the targets @xmath24 over the entire training set , e.g. in a least - squares sense by minimizing @xmath26 . the most widely used procedure to accomplish this task is the _ back - propagation _",
    "algorithm , which performs a non - linear least - squares minimization of the distance between the network output and the targets ( @xcite @xcite ) .",
    "the back - propagation algorithm needs a starting guess for the synaptic parameters .",
    "i have found that a random initialization with a normal distribution works well for the applications described here .",
    "the amplitude of the distribution is set to 1/@xmath21 .",
    "this is done to ensure that the @xmath27 are of the order of 1 .",
    "otherwise one risks entering the saturation regime of the non - linear activation function . for the same reason it is important to pre - process the inputs and outputs with a linear transformation to bring them within the [ -1,1 ] interval ( or at least within that order of magnitude ) .",
    "this has been done here by subtracting the mean value and normalizing to the standard deviation of each parameter over the entire dataset .",
    "for a sake of simplicity , the anns used in this work have been trained to retrieve the magnetic field strength only .",
    "it is straightforward to train similar networks to retrieve any other model parameters that are deemed relevant .",
    "an alternative approach would be to train one single ann to retrieve all the parameters .",
    "unfortunately , numerical experimentation suggests that a much larger number of neurons is necessary if one wishes to achieve a comparable accuracy in each individual parameter , which increases the computational cost very rapidly .",
    "therefore , it is probably more efficient to train a separate ann for each parameter . in this manner",
    "the computing time for the training and the subsequent inversions scales linearly with the number of parameters .",
    "the additional expense for inverting more than one parameter is negligible , considering that a typical inversion such as the ones presented below take only a matter of seconds ( compared to several hours for a full milne - eddington inversion ) .",
    "the anns are trained in successive epochs .",
    "a batch of 15000 profiles are synthesized at each epoch of the training and presented to the network .",
    "the use of many batches helps to minimize `` overfitting '' , which is a common problem encountered in these applications .",
    "overfitting makes an ann reproduce noise or other irrelevant features of the dataset and lose generalization ability .",
    "in fact , accuracy and generalization ability are often opposing atributes and one needs to find an adequate compromise between the two .",
    "this is discussed in more detail in the following sections .",
    "the milne - eddington approximation is used for all the spectral synthesis calculations in this paper .",
    "this approximation considers that all the relevant parameters that enter the radiative transfer equation ( magnetic field , line strength , doppler width , and damping ) are constant with height in the line formation region , except for the source function which varies linearly with optical depth ( see , e.g. , @xcite @xcite for details ) . with these assumptions",
    "the solution to the radiative transfer equation is analytical , which alleviates considerably the burden of computing thousands of training spectral line profiles .",
    "in addition to these atmospheric parameters i consider a `` filling factor '' ( @xmath28 ) of the magnetic element , which is used to treat spatially unresolved fields .",
    "the magnetic profile is multiplied by @xmath28 and added a quiet - sun profile multiplied by @xmath29 .",
    "the starting model atmospheres for the spectral syntheses are random but based on a distribution obtained from actual solar data .",
    "i have used existing observations in the archives of the advanced stokes polarimeter ( asp , @xcite @xcite ; @xcite @xcite ) to obtain a realistic distribution of the milne - eddington parameters .",
    "histograms of some of the most relevant parameters are shown in fig  [ fig : histograms ] .",
    "the various atmospheric parameters are not independent of one another .",
    "fig  [ fig : correl ] shows the correlations existing between some relevant parameters .",
    "the use of solar distributions has the advantage of optimizing the network performance for the observations that one expects to find in the real sun ( at least in a statistical sense ) .",
    "the profiles calculated are those of the pair of lines near 6302   .",
    "the spectra are sampled in 52  m bins , about a factor of 4 lower than typical asp observations .",
    "the wavelength range where two telluric lines are present in actual observations is removed from the synthetic profiles .",
    "once the ann has been trained , two different tests are used to assess its performance .",
    "the first test uses synthetic profiles obtained from a milne - eddington inversion of asp observations .",
    "the inversions were carried out by @xcite @xcite using the code developed by @xcite ( @xcite ) .",
    "the observed region can be considered rather typical and contains significant areas of quiet sun , a fairly round sunspot and some plage , and has a fairly good spatial resolution ( @xmath301  ) consistently during the entire scan .",
    "fig  [ fig : maps ] shows several maps of the observed region .",
    "the test with synthetic profiles has the advantage that the sought solution is known beforehand .",
    "both the training and the validation data have been produced using the milne - eddington approximation , so the models are consistent physically .",
    "therefore , the errors obtained can be ascribed directly to the ann performance .",
    "unfortunately , the performance of an ann may be very different when it is applied to simplified synthetic profiles or to real observations .",
    "it is then crucial to consider a second test in which the validation data are observations . for this purpose",
    "i have used the spectral profiles from the asp dataset described above .",
    "the ann outputs are compared to the models resulting from the milne - eddington inversion to estimate the errors .",
    "let us first consider the most straightforward approach , which is to train the ann with synthetic profiles as explained in ",
    "[ sec : trainset ] .",
    "each input vector has a total of 80 elements , corresponding to 4 stokes parameters , 2 spectral lines and 10 spectral samples per line .",
    "output vectors have only 1 element , namely the intrinsic magnetic field strength ( see last paragraph of  [ sec : training ] ) .",
    "some basic pre - processing is applied to the synthetic profiles before they are presented to the ann .",
    "this is intended to reduce the dimensionality of the problem by removing trivial transformations .",
    "the following procedures are applied :    * the global bulk velocity is removed by shifting all profiles so that their stokes  @xmath31 `` center of symmetry '' are at the same position .",
    "the center of symmetry is defined so that the sum of quadratic differences of symmetric points in the line profile are minimal . *",
    "random noise is added to all profiles .",
    "the noise has a normal distribution and an amplitude of 10@xmath32 times the continuum intensity . *",
    "all profiles are normalized to their respective continuum intensity . * the spectral ranges of the two telluric lines",
    "are removed . * the mean and standard deviation of each spectral sample over the entire training set are computed .",
    "these are then used to normalize the inputs so that they are of the order of 1 .",
    "the same is done for the output magnetic fields .",
    "the ann is trained in successive epochs with batches of 15000 profiles . for each epoch",
    ", the back - propagation algorithm is applied until 500 iterations are performed or the last 50 iterations do not result in further improvement . after a training epoch",
    ", the ann is presented with 500 new profiles that were not included in the training set .",
    "this validation set is used to estimate the performance of the network when presented with new data .",
    "the training process is repeated in successive training epochs with different sets until the validation error converges ( i.e. , it no longer decreases with additional training batches ) .",
    "after the time - consuming training process ( @xmath02 days ) , the ann was tested with both synthetic and observed asp data .",
    "the results are presented in fig  [ fig : simplistic ] .",
    "the performance with synthetic data is very good , as seen in that figure .",
    "however , when faced with actual observations , this ann is unable to provide accurate field estimates below @xmath01  kg .",
    "the problem with observed profiles is that they exhibit conspicuous features that are not present in the training set .",
    "one has moderate to strong asymmetries and other departures from the ideal milne - eddington profiles that are unknown to the ann .",
    "this is not so serious in the case of traditional least - squares inversions because those codes find the solution that is closest ( in a least - squares sense ) to the observation .",
    "however , the situation is very different with anns . basically , our network is a multi - dimensional interpolating function , with the training set representing the gridpoints that the interpolating function mimics .",
    "when we introduce a point in the ann that is outside the domain of the training data , the network is forced to perform an extrapolation instead of an interpolation .",
    "there are two different approaches that one might take to overcome this issue .",
    "the first one is to take the observed profiles and pre - process them in order to bring them onto the milne - eddington hypersurface ( see @xcite @xcite for details ) . by doing",
    "this one is effectively looking for the closest milne - eddington profile to the observation .",
    "this milne - eddington profile is then the one that will be inverted by the ann .",
    "the second approach is to `` regularize '' the network to make it tolerant to small deviations of the profiles from the ideal shape .",
    "both of these strategies are explored in the next sections .",
    "let us consider first the approach of `` projecting '' the observed profile vector onto the hypersurface defined by synthetic milne - eddington profiles .",
    "this is implicitly done by traditional least - squares fitting codes , which find the milne - eddington profile that is closest to the observation .    in the context of ann inversion ,",
    "the vector projection is not implicit in the method , and this needs to be done explicitly ( e.g. as a pre - processing of the input data ) . in this section",
    "i explore a procedure by which an _ auto - associative _ neural network ( aann ) is used for pre - processing .",
    "a previous paper ( @xcite @xcite ) demonstrated the use of aanns to decompose and reconstruct spectral stokes profiles .",
    "the reader is referred to that paper for details but a brief explanation of aanns is given here for completeness .",
    "an aann is simply a neural network that is trained with targets equal to the input data ( @xmath33 ) .",
    "( obviously this requires the same number of neurons in the input and output layers . )",
    "an aann has at least one hidden layer ( the `` bottleneck '' layer ) that has fewer neurons than the input / output layers ( see fig  [ fig : aann ] ) .    for the application presented here we shall depart slightly from the conventional definition of aanns , but",
    "the underlying principle remains the same .",
    "one starts by synthesizing a large number of milne - eddington profiles that will be used as targets for the aann .",
    "these profiles are then distorted by artificially adding asymmetries , molecular lines with random positions and amplitudes ( like those found in the umbra of sunspots ) and noise .",
    "the quiet sun intensity profile used for the spatially - unresolved non - magnetic surrounding is randomized so that it is slightly different for each training datapoint .",
    "the relative velocity between magnetic and non - magnetic elements is random with an amplitude of 2 km  s@xmath34 .",
    "finally , both the perturbed and original profiles undergo basic pre - processing and normalization as explained in  [ sec : direct ] .",
    "the aann is trained using the perturbed profiles as inputs and the original milne - eddington ones as targets .",
    "the bottleneck layer of this network has only 11 neurons , which is also the number of free parameters in the atmospheric model . in principle",
    "it should be possible for the aann to extract a set of 11 parameters from the profiles from which these can then be reconstructed . in practice , however , there may be a significant loss of information due to the limited number of neurons present between the inputs and the bottleneck layer , which in turn limits the complexity of the non - linear transformations that the aann can do .",
    "moreover , the problem we are dealing with here is complicated because the inputs have been distorted .",
    "this means that the aann needs to find a suitable set of 11 `` features '' in the distorted spectra from which it can reconstruct a similar milne - eddington profile . effectively , the aann is doing the profile projection mentioned earlier , or at least an approximation to it .",
    "once the aann is properly trained , we can construct another network that will take the profiles pre - processed by the ann and do the actual inversion with them .",
    "notice that the `` inverting '' ann does not really need to take the full output vector from the aann .",
    "we can simply take the 11-parameter vector in the bottleneck layer .",
    "this are the parameters that the aann has determined contain all the necessary information to reconstruct the milne - eddington profiles .",
    "the full data inversion strategy proposed in this section is as follows .",
    "we first train an aann as explained above with distorted profiles as inputs and milne - eddington profiles as outputs .",
    "once this network has been trained we shall not make any further use of the layers behind the bottleneck layer .",
    "we then construct a second ann to do the inversion . to generate the training set for this new ann we must first pre - process all the training profiles with the aann .",
    "each training profile is propagated through the aann , but only up to the bottleneck layer .",
    "the features in the bottleneck layer are used as inputs to the inverting ann , whereas the targets are the magnetic field strength properly normalized as in  [ sec : direct ] .",
    "the results of the tests with this complex combination of inputs pre - processing and data inversion are shown in fig  [ fig : preproc ] .",
    "the performance with synthetic profiles has degraded somewhat with respect to the case of the direct approach ( section  [ sec : direct ] ) .",
    "however , we can see that now the accuracy of inversions with observed and synthetic profiles are very similar .",
    "the errors are reasonably small , close to ( and sometimes smaller than ) 100  g except for the range between 1  kg and 1.5  kg .",
    "this region is complicated because it contains most of the quiet sun fields , which usually have small filling factors .",
    "inverting these profiles is difficult because the polarization signals are typically much weaker ( in spite of the fact that the intrinsic field may be strong ) and there is rarely any linear polarization at all .",
    "the ann - based inversion tends to underestimate these fields , although the correct solution is still within the 1-@xmath35 scatter in the plot .",
    "the third strategy proposed in this paper is based on the concept of `` regularization '' , which aims at making the ann tolerant to small departures from the model .",
    "this is usually accomplished by training anns with noisy data . in our problem , however , the difficulties reside not only in the noise but more importantly in spurious features such as asymmetries or molecular lines that effectively produce distortions in the profiles .",
    "regularization may reduce the accuracy of an ann , especially when working with high - quality data .",
    "however , it makes it more robust and improves its generalization ability .",
    "one usually needs to find a suitable compromise between these two qualities .",
    "this section explores the applicability of a regularized ann for the inversion of spectral stokes data .",
    "i have trained a single ann with input profiles that have been distorted exactly as those for the aann in  [ sec : preproc ] and the magnetic fields as targets .",
    "the goal is to combine the two steps ( pre - processing and inversion ) in one .",
    "the overall training time is somewhat longer than in previous cases ( about 50% longer than the direct approach ) .",
    "the results of applying this ann to the test data are shown in fig  [ fig : regul ] . as before , the network performance with synthetic data is slightly worse than that of the direct approach .",
    "however , we gain an important benefit in that it can invert observations practically with the same accuracy as synthetic data . compared to the case of  [ sec : preproc ] , this particular ann performs only a little worse for the weaker fields ( below @xmath01  kg ) which are slightly overestimated .",
    "these points are found mostly in the outer penumbra ( some of them also in the quiet sun , but they are few ) .",
    "the quiet sun points between 1  kg and 1.5  kg are better retrieved than in the previous case .",
    "there is still a slight underestimation , but the effect is small .",
    "this paper shows that anns are a viable alternative to least - squares fitting for the routine analysis of large amounts of data .",
    "while their accuracy is somewhat lower , the ability to process much larger datasets will probably present advantages for some application .",
    "the cpu times required for the ann inversions presented here are @xmath010  seconds , compared to @xmath05  hours for the original milne - eddington inversion .",
    "furthermore , one does not have to be concerned with the algorithm finding secondary minima or not converging .",
    "strictly speaking , the ann inversion is not an inverse problem .",
    "it is rather a case of interpolating a multidimensional function that maps a set of gridpoints from the space of spectra into the space of models .",
    "it is important to emphasize that pattern recognition techniques are not meant to replace traditional least - squares fitting algorithms , but to complement them .",
    "for detailed studies of a smaller data subset or individual profiles , or if one needs to consider more realistic model atmospheres ( with line - of - sight gradients , non - lte effects , etc ) , it is still necessary to use a least - squares inversion .                                  , k. , elmore , d.  f. , lites , b.  w. , sigwarth , m. , rimmele , t.  r. , hegwer , s.  l. , gregory , s. , streander , k.  v. , wilkins , l.  m. , richards , k. , & berst , c. 2003 , in polarimetry in astronomy . edited by silvano fineschi .",
    "proceedings of the spie , volume 4843 , pp .",
    "414 - 424 ( 2003 ) . ,"
  ],
  "abstract_text": [
    "<S> this paper explores three different strategies for the inversion of spectral lines ( and their stokes profiles ) using artificial neural networks . </S>",
    "<S> it is shown that a straightforward approach in which the network is trained with synthetic spectra from a simplified model leads to considerable errors in the inversion of real observations . </S>",
    "<S> this problem can be overcome in at least two different ways that are studied here in detail . </S>",
    "<S> the first method makes use of an additional pre - processing auto - associative neural network to project the observed profile into the theoretical model subspace . </S>",
    "<S> the second method considers a suitable regularization of the neural network used for the inversion . </S>",
    "<S> these new techniques are shown to be robust and reliable when applied to the inversion of both synthetic and observed data , with errors typically below @xmath0100  g. </S>"
  ]
}