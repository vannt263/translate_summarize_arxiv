{
  "article_text": [
    "the detection of lines from local and distant objects has always been of great importance in astrophysics .",
    "it has been extensively used as indicator of redshift , as a measurement of the star formation activity of galaxies and as a probe of their internal structure . in the last few years",
    "an increasing interest has been devoted to the search of emitters ( laes ) at high redshift , which are expected to be characterized by a strong emission ( partridge and peebles 1968 ) , but significantly attenuated by dust absorption .",
    "in fact , it has been necessary to wait for dedicated large programs of deep narrow band searches like the large area lyman alpha ( lala ) and the subaru deep field survey to detect a significant number of emission galaxies at high redshift ( e.g. stern et al . 2005 ; iye et al .",
    "2006 ) and to get complete spectroscopic samples of laes at redshift @xmath1 , @xmath2 and @xmath3 ( e.g. hu et al .",
    "1998 , 2004 ; rhoads & malhotra 2001 ; kodaira et al . 2003 ; taniguchi et al .",
    "2005 ; kashikawa et al . 2006 ; murayama et al . 2007 ; dawson et al .",
    "strong lensing magnification has been necessary to move the detection frontiers even further , with several candidates currently observed up to @xmath4 ( _ e.g. _ pell et al .",
    "2007 ; stark et al . 2007 ) .",
    "the intense activity reported above is explained by the great interest in using laes as cosmological probes : laes are in fact the objects with the highest known @xmath5 and can be used to study large scale structures and galaxy formation in the high redshift universe .",
    "number counts , together with the statistics of line shapes , are extremely powerful observables from which inferring important information about _",
    "e.g. _ the properties of the intergalactic medium ( igm ) and the reionization era ( e.g. hu 2002 ; rhoads 2003 ; stern 2005 ) , the photoionization processes and uv photon production ( e.g. stark 2007 ) , the tomography of neutral gas , gas velocity field and star formation activity ( e.g. kodaira et al . 2003 ) .",
    "this predicting power relies on the fact that the line is shaped inside the galaxy interstellar medium and at high redshift is also affected by the igm opacity , which becomes non negligible to photons at @xmath6 ( fan et al .",
    "2006 ) .",
    "emission of photons from high redshift sources has also an impact on the detectability of 21  cm line from neutral hydrogen in the igm . at high redshift , the wouthuysen - field effect ( wouthuysen 1952 ; field 1958 , 1959 ) is in fact extremely efficient in decoupling the spin temperature of the gas , @xmath7 , from the cosmic microwave background ( cmb ) temperature , @xmath8 , allowing the 21  cm signal to be visible either in absorption or in emission .",
    "fluctuations in the flux , due both to inhomogeneous distribution of the radiation sources and to the scattering in the wings , can modify the expected signal ( e.g. barkana & loeb 2005 ; chen & miralda - escud 2006 ; chuzhoy & zheng 2007 ; semelin , combes & baek 2007 ) , at least as long as a strong background is not established and the radiation intensity reaches a saturation level ( e.g. ciardi & madau 2003 ; ciardi & salvaterra 2007 ) . for these reasons , it is important to follow the propagation of photons rather than assume a homogeneous background as it is generally done .    due to the resonant nature of the line propagation , a self - consistent and detailed treatment of the line radiation transfer is required in order to model properly how radiation affects the igm , as well as to understand how different physical processes shape the spectral features of laes . as a consequence of the great interest in this field ,",
    "several semi - analytic and numerical studies of the radiative transfer have followed the first pioneering papers on the subject ( osterbrock 1962 ; avery & house 1968 ; adams 1972 ; harrington 1973 ; neufeld 1990 ) .",
    "analytic solutions have been derived only for few simple geometrical gas configurations : static plane parallel slabs including dust ( neufeld 1990 ) , static uniform sphere ( dijkstra , haiman & spaans 2006 ) and uniform gas with pure hubble flow around a steady source ( loeb & rybicki 1999 ) .",
    "given the difficulties in the treatment of radiative transfer though , also the numerical approaches developed so far , mostly based on monte carlo techniques , have been in most cases specifically designed for particular physical configurations and problems : 1d dusty and optically thick media ( ahn , lee & lee 2000 , 2001 ) ; 3d arbitrary distribution of dustless gas with arbitrary bulk velocity field ( zheng & miralda - escud 2002 ) ; spherically symmetric collapsing gas clouds ( dijkstra , haiman & spaans 2006 ) ; scattering off opaque , dusty and moving clouds ( hansen & oh 2006 ) ; hubble like expansion flows of neutral gas ( loeb & rybichi 1999 ; kobayashi & kamara 2004 ) .",
    "other codes have been specifically designed for studying laes and pumping in a cosmological context ( gould & weinberg 1996 ; cantalupo et al .",
    "2005 ; tasitsiomi 2006 ; semelin , combes & baek 2007 ) .",
    "verhamme , schaerer & maselli ( 2006 , vsm06 ) have developed a general - purpose 3d radiation transfer code applicable to dusty media with arbitrary geometries and velocity fields .",
    "so far analytical , semi - analytical as well as numerical studies perform the radiative transfer as a post - process calculation by assuming a fixed ionization structure of the gas through which it propagates , while none of them has tackled the radiative transfer problem by taking into account the effect of an evolving ionization configuration .",
    "nevertheless , as we show in the following of this paper , this approximation results to be a poor one for some applications of interest , in particular for cosmological studies at high redshift , but also when modeling the emission from young galaxies .    in this paper",
    "we present , a new radiative transfer scheme which , for the first time in the literature , follows simultaneously the propagation of and ionizing radiation self - consistently .",
    "this allows us to investigate the effects of evolving ionization configurations on the propagation of radiation and on the shaping of the line emerging from single objects .",
    "the impact of an evolving ionization structure can in fact be significant and needs to be taken into account : the large cross - section of photons makes propagation dominated by resonant scattering with hi atoms and the random - walk - like nature of the process makes the characteristic time for photon propagation much larger than the one for ionizing radiation . if an ionizing continuum changes the ionization of the gas through which the photon is propagating , the amount of scattering suffered by the line photons before escaping will depend on the ionization history of the system . in this case",
    ", a joint treatment of both line and continuum transfer is needed to study the alterations in the spectrum occurring during the evolutionary stages of the ionized regions .",
    "the code presented in this paper is the first step in this direction . has been implemented as an extension of the 3d ray - tracing radiative transfer code for ionizing radiation ( ciardi et al .",
    "2001 ; maselli , ferrara & ciardi 2003 ; maselli & ferrara 2005 ; maselli , ciardi & kanekar 2008 ) , by developing a new independent algorithm which follows the path of line photons in time and space .",
    "as described in details in the following , this new algorithm makes extensive use of pre - compiled tables which have been derived by using the line transfer code mcly@xmath0 ( vsm06 ) and allows to compute in an extremely efficient way the path of line photons in arbitrary 3d gas distributions .",
    "the paper is structured as follows .",
    "section 2 is dedicated to a brief overview of and mcly@xmath0 , while in section 3 we describe the new method .",
    "some validation tests are shown in section 4 . in the last section we present a summary of the paper .",
    "in this section we give a brief description of the codes and mcly@xmath0 for the sake of providing a proper background for the description of given in section 3 .",
    "a more detailed description of the two codes is already in the literature : the details of implementation are given mostly in maselli , ferrara & ciardi ( 2003 ) , with updates on a new scheme for the background radiation field given in maselli & ferrara ( 2005 ) and on the latest version of the code in maselli , ciardi & kanekar ( 2008 ) .",
    "mcly@xmath0 algorithm is fully described in vsm06 .",
    "note that some nomenclature has been changed for clarity .",
    "is a 3d ray - tracing radiative transfer code based on monte carlo ( mc ) techniques that are used to sample the probability distribution functions ( pdfs ) of several quantities involved in the calculation , _",
    "e.g. _ spectrum of the sources , emission direction , optical depth . the mc approach and the code architecture",
    "assure a great flexibility in the application to a wide range of astrophysical problems and allow additional physics to be easily added with a minimum effort .",
    "the algorithm follows the propagation of the ionizing radiation through an arbitrary h / he static density field and at the same time computes the variations in temperature and ionization state of the gas .",
    "both multiple point sources , located arbitrarily in the box , and diffuse radiation ( _ e.g. _ the ultraviolet background or the radiation produced by h / he recombinations ) can be accounted for . in this paper",
    "we neglect the treatment of any background radiation for simplicity .",
    "the energy emitted by point sources in ionizing radiation is discretized into photon packets , beams of ionizing photons , emitted at regularly spaced time intervals .",
    "more specifically , the total energy radiated by a single source of luminosity @xmath9 , during the total simulation time , @xmath10 , is @xmath11 . for each source , @xmath12 is distributed in @xmath13 photon packets , emitted at the source location at regularly spaced time intervals , @xmath14 .",
    "the time resolution of a given run is thus fixed by @xmath13 and the time evolution is marked by the packets emission : the _ j_-th packet is emitted at time @xmath15 , with @xmath16 .",
    "thus , the total number of emissions of continuum photon packets is @xmath17 . in its latest version ( maselli , ciardi & kanekar 2008 )",
    ", the code allows for polychromatic packets whose content consists of photons distributed in various frequency bins which are populated according to the spectral shape assigned to the source .",
    "the emission direction of each photon packet is assigned by mc sampling the angular pdf characteristic of the source .",
    "the propagation of the packet through the given density field is then followed and the impact of radiation - matter interaction on the gas properties is computed on the fly . each time the packet pierces a cell @xmath18 , the cell optical depth for ionizing continuum radiation , @xmath19 ,",
    "is estimated summing up the contribution of the different absorbers ( @xmath20 , @xmath21 , @xmath22 ) .",
    "as the probability for a single photon to be absorbed in such a cell is : @xmath23 the number of photons absorbed in the cell @xmath18 is the fraction @xmath24 of packet content when entering the cell . in the polychromatic implementation , the same argument applies to the number of photons contained in each single frequency bin .",
    "the trajectory of the packet is followed until its photon content is extinguished or , if continuum boundary conditions are not assumed , until it exits the simulation volume .",
    "the time evolution of the gas physical properties ( ionization fractions and temperature ) is computed solving in each cell the appropriate discretized differential equations each time the cell is crossed by a packet .",
    "the reader is referred to maselli , ferrara & ciardi ( 2003 ) and maselli , ciardi & kanekar ( 2008 ) for more details .",
    "mcly@xmath0 is a numerical scheme for ly@xmath0 line radiative transfer , whose implementation is based on the basic structure of .",
    "mcly@xmath0 in fact uses the same mc sampling and ray - tracing techniques and it allows for arbitrary 3d hydrogen plus dust density distributions , as well as for arbitrary ionization , temperature and velocity fields .",
    "there are three physical processes , included in the code , which affect the propagation of the line radiation : ly@xmath0 line scattering , dust absorption and dust scattering . for the sake of simplicity , in this paper we concentrate solely on the effect of ly@xmath0 line scattering and we defer the treatment of the interaction between radiation and dust to future work .",
    "here we describe the basic structure of the algorithm in the absence of dust . for a more complete and accurate description the reader",
    "is referred to the original paper ( vsm06 ) .",
    "ly@xmath0 is the strongest @xmath20 transition , for which the cross - section assumes large values at frequencies near the line center , @xmath25 hz .",
    "it is convenient to introduce the frequency shift : @xmath26 where @xmath27 corresponds to the doppler frequency width and @xmath28 is the velocity dispersion of the maxwellian distribution describing the thermal motions , _",
    "@xmath29  km  s@xmath30 , with @xmath31 being the gas temperature in units of @xmath32  k. the other symbols have the usual meaning . here",
    "we neglect turbulent motions , but the option is available for their inclusion .",
    "the line radiation field is reproduced by emitting photons from each source and by following their path through the assigned gas distribution until they escape from the simulation box .",
    "the location of interaction between the photons and the gas is determined by mc sampling the pdf for the line optical depth a photon crosses before being scattered , @xmath33 . in other terms , the location of interaction is determined as the cell at which the total optical depth from the emission location , @xmath34 ( where the sum extends over all the cells crossed by the photon ) , becomes larger than @xmath35 , where @xmath36 is a random number extracted in the interval @xmath37 .    the next step , after assessing the absorption location , is to determine the photon frequency following a scattering with a hydrogen atom .",
    "to do this , the code first converts the frequency of the photon from the external ( observer ) frame , @xmath38 , to the one comoving with the fluid , @xmath39 , performing a lorentz transformation : @xmath40 where @xmath41 is the incoming photon direction and @xmath42 the bulk velocity of h atoms . due to the thermal motion of h atoms , scattering in the fluid comoving frame",
    "is not perfectly coherent . within the comoving framework and neglecting the recoil effect , partially coherent scattering can be described with a simple relation between the incoming , @xmath43 , and the outcoming , @xmath44 , frequency ( dijkstra , haiman & spaans 2006 ) : @xmath45 in the above equation @xmath46 is the atom velocity , while @xmath41 and @xmath47 are respectively the incoming and outcoming propagation direction .",
    "the code can model both isotropic and dipolar angular redistribution ; in this paper we use only the isotropic redistribution and sample randomly the outcoming propagation direction .",
    "once a new direction and frequency are assigned to the scattered photon , a new random @xmath36 is extracted to determine the next scattering location .",
    "this scheme is repeated until the photon escapes the simulation volume .",
    "in this section we describe , the first numerical scheme which combines the treatment of continuum and line transfer radiation . as mentioned in the introduction , the algorithm has been developed as an extension of , which provides the treatment of the ionizing radiation as described in the previous section and references therein .",
    "the extension indeed consists in a new algorithm developed to follow the propagation of photons through a given gas configuration while it is changed by ionizing radiation .",
    "in fact , although the continuum photon propagation proceeds undisturbed by the radiation field , radiative transfer is strongly affected by the change in the ionization state of the gas .    in order to perform the coupling ,",
    "it is necessary to introduce the time evolution for propagation , a feature commonly neglected in line radiative transfer codes like mcly@xmath0 .",
    "this is a crucial aspect because , due to the resonant scattering nature of transfer in a neutral medium , radiation can remain trapped for a substantial fraction of the simulation lifetime before being able to propagate away from its emission site , while the propagation time of the ionization front can be much shorter .",
    "thus , the change in the degree of ionization affects the propagation of the photons , while the latter induces no back reaction on the gas .",
    "note that , although photons , via scattering , can transfer some of their energy to the gas and heat it , in typical situations the effect is negligible and thus such heating is not generally included in radiative transfer codes .",
    "we defer the investigation of this issue in more detail to future work .    to correctly model the simultaneous propagation of the two radiations a combined approach",
    "is needed .",
    "this is a challenging task because of the very different nature of continuum and line transfer , in terms of _",
    "e.g. _ their path ( straight line versus random walk ) and time - scales ( see discussion above ) . the above differences are reflected also in the numerical implementation of line and continuum radiative transfer .",
    "for example , while in the case of ionizing radiation the time needed for a photon packet to travel a given distance does not depend sensibly on the physical properties of the gas but only on the physical distance crossed , the propagation of ly@xmath0 photons is very sensitive to the ionization state of the gas and extreme configurations can be faced , in which the photons scatter for the entire simulation time trapped in few cells without exiting the simulation volume .",
    "as the ionizing radiation scheme has not been modified , it will not be discussed further and in the following we will focus on describing the details of the line transfer part of the algorithm .",
    "the ly@xmath0 radiation is discretized in a large number of photons whose emission and propagation is dictated by the time - scale attached to the ionizing radiation evolution .",
    "in this way we are able to model the change in the ly@xmath0 propagation due to the variations in the gas ionization state . to correctly model the propagation of ly@xmath0 photons we need to follow every single scattering .",
    "as this would require a very large computational time , we use a statistical approach to the ly@xmath0 treatment .",
    "we have compiled 1085 tables by running mcly@xmath0 , in order to describe the physical characteristics of a photon after a scattering depending on the temperature and density of the gas and on the incoming photon frequency ( see appendix ) .",
    "the following part of this section is dedicated to a description of the various steps of the implementation .",
    "every ly@xmath0 emission is characterized by the generation of @xmath48 line photons emitted at the same time , @xmath49 .",
    "the parameter @xmath48 is chosen to optimize the resolution and the code performance .",
    "the code allows for two different methods for photon emission . in the first method",
    "the emission is regularly spaced in time as in the continuum emission . if , as in section  [ crash3 ] , we define @xmath50 as the total number of emissions of line photons , in this case :    @xmath51    with @xmath52 . + an alternative criterion for the emission follows the evolution of the ionization structure . in this case the emission time , @xmath49 , is linked to the volume averaged h ionization fraction , @xmath53 , and photons are emitted at the time @xmath49 when : @xmath54 @xmath55 is the chosen hii fraction variation in the gas and @xmath18 is an integer that covers values between @xmath56 and @xmath57 . while in the first formulation a constant emission rate is assured , in this case the emission rate is higher when the ionization state of the gas changes faster . in order to reproduce a constant emissivity even in the second formulation ,",
    "we assign a weight to each photon emitted at the @xmath18-th step : @xmath58 .",
    "when a spectrum is built , each photon contributes according to its weight .",
    "this allows to modulate the emission of photons based on the change of the ionization degree ( and thus to better sample the effect of ionization on scattering ) and at the same time to have a constant photon rate .    in the following tests",
    "the emission is assumed to be isotropic , but it is always possible to account for an arbitrary angular pdf .",
    "every emitted ly@xmath0 photon @xmath59 ( @xmath60 $ ] ) is described by its frequency in the comoving frame @xmath61 ( in this case we assume a monochromatic spectrum with @xmath62 , but a different spectrum can be used ) , position * p*@xmath63 ( which coincides with the source location ) , direction of propagation * k*@xmath64 , optical depth at which the scattering takes place @xmath65 ( as defined in sec .",
    "[ mclya ] ) and a characteristic time @xmath66 that is used to evolve the photon along the simulation timeline ( see next section ) . at any step of the simulation the @xmath59-th photon",
    "is always described by the quantities ( @xmath43 , * p * , * k*@xmath67 , @xmath68 , @xmath69 ) , where the index @xmath59 has been omitted for clarity . in the following",
    ", we will always omit it .      in section [ crash3 ]",
    "we have seen how the physical time of the simulation is driven by the emission of packets of ionizing radiation discretized in time units , @xmath70 .",
    "we are interested now to link the propagation of a ly@xmath0 photon to this timeline .",
    "let s assume that an ionizing photon packet has been emitted at @xmath71 , that the physical state of the gas has been evolved between @xmath71 and @xmath72 , and that a photon is emitted at the same time @xmath73 ; then its characteristic time is assigned the value @xmath74 .",
    "the propagation of the photon along the direction * k * is followed between @xmath69 and @xmath72 , and the line optical depth encountered along the path , @xmath75 , is calculated as described in section  [ mclya ] .",
    "in each cell crossed by the photon we check if a scattering takes place , _",
    "i.e. _ if @xmath75 becomes larger than @xmath68 .",
    "if there is no scattering , we follow the propagation until @xmath72 and at this point we store the photon s frequency @xmath43 , the updated position @xmath76 , and characteristic time @xmath77 . propagation direction * k*@xmath67 and optical depth for scattering @xmath68 remain unchanged .",
    "these information will be used to follow the photon evolution in the next time unit .",
    "we define this photon as `` active '' , in the sense that it is not trapped by scattering inside a cell but will resume its propagation in the next time unit .",
    "let s consider now the case in which the photon scatters during the time unit . unlike mcly@xmath0",
    ", this code does not follow every scattering inside the cell , but determines the properties of the outcoming photon by interpolation of pre - compiled tables ( see appendix a ) .",
    "given the gas temperature , @xmath78 , the line optical depth , @xmath79 , of the cell where the scattering takes place , and the frequency , @xmath43 , of the incoming photon , a linear interpolation of the tables is performed to obtain the distribution of frequencies of the outcoming photon , @xmath44 , and of the time interval that the photon is expected to spend inside the cell due to scattering , @xmath80 . from these distributions the code extracts the values for @xmath44 and @xmath80 that will be assigned to the photon .",
    "this approach allows for a tremendous gain in computational speed by adopting a statistical description of the scatterings that occur to the photon inside a cell , without following each one individually .",
    "the characteristic time is updated as @xmath81 .",
    "if @xmath82 the photon is put in a `` stand - by '' mode and its propagation is resumed ( with a new @xmath79 ) only when the simulation time becomes larger than @xmath69 .",
    "the procedure described above is repeated for ( i ) all the photons emitted at @xmath49 , ( ii ) all the photons `` active '' at @xmath71 and ( iii ) all the photons that exit the `` stand - by '' mode in this time unit .",
    "then , a new ionizing photon packet is emitted at @xmath72 and after it has been evolved up to @xmath83 the cycle starts again : all the `` active '' photons are evolved from @xmath72 to @xmath83 ; if there are `` stand - by '' photons with @xmath84 they are turned into `` active '' photons and evolved until @xmath83 ; if new photons are emitted in this time unit they as well are evolved until @xmath83 .",
    "if the ionizing radiation crosses a cell in which a ly@xmath0 photon is trapped by scattering , the change in the physical conditions of the cell should be taken into account , as this affect the characteristics of the outcoming photon . as an example , let s assume that a ly@xmath0 photon scatters in a cell at @xmath85 and that the time at which it exits the `` stand - by '' mode is @xmath86 .",
    "if the ionizing radiation crosses that cell at a time @xmath87 such that @xmath88 , the physical conditions in the cell change . to take into account the effect on @xmath44 and @xmath80 ,",
    "we recalculate them from the tables by using the values @xmath89 , @xmath90 modified by the ionizing radiation and @xmath91 as we do not have any information on the frequency of the ly@xmath0 photon at @xmath87 .",
    "when photons exit the simulation box , their frequencies are collected to calculate the outcoming time integrated spectrum . as discussed in section  [ lya_em",
    "] , each photon is counted according to its weight . to show the probability distribution of the outcoming radiation , spectra are normalized to the sum of all weights .",
    "the profile of the final spectrum strongly depends on the choice of the integration time . to build a spectrum we define an initial , @xmath92 , and a final , @xmath93 , time .",
    "all the photons that escape from the box in the interval @xmath94t_{out}^l;t_{out}^{l+1}]$ ] will contribute to the spectrum of the source . at the next output",
    ", all the photons collected in the interval @xmath94t_{out}^{l+1};t_{out}^{l+2}]$ ] will be used to build the spectrum .",
    "this procedure is followed until the end of the simulation .",
    "as in the case of the emission described in section  [ lya_em ] , the spectra can be produced regularly spaced in time or linked to the evolution of the ionization structure .",
    "thus , the time of the outputs is regulated by equations  [ em_1 ] and  [ em_2 ] , where @xmath95 and @xmath50 are replaced by @xmath92 and @xmath96 , respectively .",
    "spectra can also be built by choosing a pre - determined line of sight .",
    "in this section we perform tests for the parallel propagation of ionizing and radiation , which show how the evolution of the ionization structure alters the spectra of the outcoming radiation .",
    "all the tests have the same initial conditions , unless stated otherwise .",
    "we use a simulation box of 30  pc on a side , divided in @xmath97 cells .",
    "a monochromatic ionizing source , emitting photons with energy equal to 13.6 ev , is located at the center of the box ; the ionizing photon rate is @xmath98 .",
    "the ionizing radiation is discretized in @xmath99 photon packets .",
    "the same source emits also a monochromatic radiation .",
    "as we want to construct spectra at a fixed distance from the source , we distribute the gas ( h only , with density @xmath100  @xmath101 , @xmath102  @xmath103 , and temperature @xmath104  k ) in a sphere of radius @xmath105  pc around the central source . outside the sphere",
    "the density is set to zero , so that no interaction between radiation and gas takes place .",
    "the gas is initially neutral .",
    "every simulation is carried out for a physical time of @xmath106  yr . in our reference runs we have @xmath107 outputs and @xmath108 emissions of photons , each with @xmath109 photons .",
    "both the emissions and the outputs are dictated by the evolution of the ionization field .",
    "we will discuss the effect of a different choice for @xmath50 , @xmath110 and @xmath96 at the end of the section . in the following we present the results of our simulations for different choices of the dynamical state of the gas .",
    "the spectra shown are obtained integrating on all directions in order to achieve a better resolution , given the set of chosen parameters .      in this first test",
    ", the gas has no bulk velocity with respect to the central source .",
    "the top - left panel in figure  [ test_fig ] shows the spectra emerging from this configuration at times corresponding to volume averaged ionization fractions @xmath111 , which could be regarded as spectra of the source observed at different times elapsed since the source switches on .    the spectra shown here and in the rest of the paper have been built as described in section  3.3 . , _",
    "i.e. _ collecting the photons escaping the system when @xmath112 falls in an interval @xmath113 centered on the @xmath112 value selected for the output .",
    "the curve corresponding to @xmath114 is instead a collection of the escaping photons which starts when @xmath115 and ends at @xmath10 . for the combination of parameters chosen for the tests , at @xmath116",
    "the number of escaped photons is not sufficient to build a spectrum and also for @xmath117 the outcoming spectrum is very noisy . as expected , the spectra exhibit the two symmetric peaks characteristic of this configuration , although a direct , quantitative comparison with previous works ( _ i.e. _ dijkstra , haiman & spaans 2005 ) is not possible , as none included the effect of ionizing radiation . as the ionization increases , the peaks move towards @xmath118 because photons encounter less and less hi atoms along their path .",
    "at the same time , the width of the peaks become smaller . in this scenario",
    "we do not see a spectrum peaked at @xmath118 because the gas never gets completely ionized and , for a static configuration , also a little fraction of neutral gas far from the location of emission has a non negligible optical depth for photons in the line center .      in a more interesting case",
    "we simulate a homogeneous spherical cloud that collapses or expands . in these tests",
    "we sample a velocity field , in the gas sphere , described by @xmath119 .",
    "initially we choose @xmath120  km  s@xmath30 and @xmath121  km  s@xmath30 .",
    "the resulting spectra extracted at the same ionization fractions as for the static case are shown in figure  [ test_fig ] with a positive and a negative value for @xmath122 ( top - right and center - left panels respectively ) .",
    "as expected , the plots show specular spectra , due to the opposite direction of the bulk motion .",
    "when the gas is expanding the outcoming radiation is on the red part of the spectrum , while it lays on the blue side when we consider negative values for the velocity .",
    "this happens because the photons are seen doppler shifted according to the velocity of the atoms .",
    "this means that , if an atom has a positive velocity , in the atom rest frame a blue photon becomes a line center photon and is easily blocked by the higher optical depth ( compared to the optical depth in the wings ) .",
    "thus , a photon can escape only if it is shifted by scattering to the red side of the line .",
    "differently from the static case , here it is possible to have radiation at the central frequency @xmath118 also when ionization is not complete .",
    "this is a consequence of the fact that , due to the doppler effect , the line center photons are seen in the atom rest frame as red ( expanding gas ) or blue ( collapsing gas ) photons , in the wing , and thus encounter a lower optical depth .",
    "in addition , the higher is the absolute value of the velocity the bigger is the shift , so when the continuum radiation ionizes the regions closer to the source ( which have lower velocity and as a consequence a higher contribution to the opacity ) , the optical depth at the center decreases significantly because the external neutral layers of gas ( with a higher velocity ) give only a minor contribution .",
    "as a result , as ionization proceeds , we start seeing an increasing emission at the central frequency .",
    "more specifically , the spectrum corresponding to @xmath117 shows radiation at @xmath118 and a residual in the red ( blue ) part of the spectrum for positive ( negative ) velocities . as ionization proceeds ,",
    "the residuals become less pronounced and move towards the center , while the central radiation becomes stronger . in the last spectrum , when the gas is 99% ionized , there is still a residual because of the remaining neutral hydrogen fraction in the most distant regions of the gas sphere , where the photo - ionization rate is suppressed by geometrical dilution and by the residual inner opacity .    in the third case",
    "we consider a gas sphere collapsing with increasing velocity towards the center .",
    "the center - right panel of figure  [ test_fig ] shows profiles generated with a bulk motion characterized by @xmath123  km  s@xmath30 and @xmath124  km  s@xmath30 .",
    "these spectra are very similar to the ones obtained in the previous case , but as the absolute value of the velocities increases towards the center , the residual blue part of the spectra is more spread .",
    "note that also in this case the residual is reduced as ionization proceeds and the contribution to the opacity from the inner layers of gas is suppressed .    in the last case ( fig .",
    "[ test_fig ] , bottom - left ) we consider a gas which is collapsing near the source while the outer shells are expanding , with @xmath123  km  s@xmath30 and @xmath125  km  s@xmath30 .",
    "the first spectrum ( at @xmath126 ) is dominated by photons in the blue part and just a residual is present on the red side .",
    "in fact , blue photons have a larger probability to escape because the ionization front has not yet propagated far enough to suppress the contribution to the gas opacity from the gas collapsing towards the source . as the front proceeds ionizing the neutral hydrogen with negative velocities ( spectra at increasing @xmath112 ) , the red part of the spectrum becomes stronger while the blue part is suppressed , until , in the configuration with @xmath127 , it is smaller than the red one . as in the other tests ,",
    "the increment in the ionization degree reduces the number of scatterings , with the consequence of moving the two peaks towards the center , increasing their height and reducing their width .      in this section",
    "we examine the case of a source surrounded by an expanding shell , which has been extensively studied also by other authors ( ahn , lee & lee 2004 ; hansen & oh 2006 ; vsm06 ) . here , we are interested in the effects introduced on the spectrum by an ionizing source inducing a time evolution of the neutral gas in the shell . to simulate this configuration we have chosen a homogeneous density @xmath128  @xmath101 , temperature @xmath104  k , and radial velocity @xmath129  km  s@xmath30 .",
    "all the gas is distributed within a shell of thickness 4  pc located at a distance of 10  pc from the source , while no gas is present outside the shell .",
    "the corresponding column density is @xmath130  @xmath103 . to show the spectrum time evolution",
    ", we choose to plot the profiles corresponding to ionization fractions in the shell of @xmath131 ( fig .",
    "[ test_fig ] , bottom - right panel ) . for a better understanding of the spectral features , it is useful to discuss the possible different paths for an outcoming photon .",
    "following vsm06 ( see their fig .",
    "12 ) , we divide the outcoming photons in three different groups , depending on their scattering history :    * backscattered photons : photons that , after scattering in the shell , travel inward across the empty space before crossing again the shell .",
    "as these photons undergo multiple scatterings with the gas , they can escape once they are shifted on the red side of the line where the optical depth of the expanding shell is smaller .",
    "* diffused photons : all the photons which are diffused in the shell until they escape without backscattering .",
    "we expect these photons to contribute to a red bump in the spectra whose shift from the line center and intensity will depend on the neutral gas density and on the shell velocity .",
    "typically the frequency shift will be smaller than for backscattered photons as the number of scatters before escape is on average lower .",
    "* directly escaped photons : photons that have no interaction with the gas and keep their initial frequency ; in our case this group of photons will produce a peak at @xmath118 .",
    "it is important to underline that every group has a different characteristic time for escaping .",
    "in fact , directly escaped photons travel the shortest path . on the other hand , diffused photons scatter in a volume smaller than the backscattered photons and thus escape faster ; therefore the red bump associated to the diffused photons will typically appear before the feature produced by the backscattered photons .",
    "keeping in mind all the possible paths for photons , let us analyze the features in the spectra shown in the figure  [ test_fig ] ( bottom - right panel ) .",
    "the first profile ( @xmath132 ) exhibits a peak on the red side of the central emission , due to the diffused photons , that , as already mentioned , escape faster than backscattered photons and can already been seen in the initial stages of the shell ionization .",
    "directly escaped photons are present as well and their abundance increases with time . in the profile corresponding to an ionization degree of @xmath133 we can clearly see that a secondary bump is forming at lower frequencies . at this stage of the evolution , the backscattering photons are starting to escape from the shell with a frequency that is more shifted respect to the other photons , as explained above . when the ionization degree is @xmath134 , the backscattering bump is visible and dominant on the red peak due to diffused photons . in the profile corresponding to @xmath135",
    "the ionization front has suppressed most of the neutral gas and only a negligible fraction of radiation interacts with the residual gas in the shell ; the result is a small fraction of photons shifted on the spectrum s red side .      in the previous tests",
    "we have discussed how our time dependent treatment of the radiation allows to correctly establish the appearance at different times of spectral features which are usually integrated in the emergent spectra predicted with time independent formulations . here",
    "we investigate further on the importance of the joint propagation of and continuum radiation , by comparing results from two different approaches to simulate the spectra .",
    "the first one , widely used in the literature , performs a radiative transfer on a gas configuration given as initial condition , which can be _",
    "e.g. _ a constant density field or a snapshot of a numerical simulation . in this case",
    ", the gas configuration is kept constant throughout the entire radiative transfer and the spectra are built once all the photons have escaped the simulation volume .",
    "the other approach is the one described in this paper , starting from an initial gas configuration , the parallel propagation of continuum and line photons is followed and the spectra can be built at different times taking into full account the changes in the propagation due to the variations in the neutral gas distribution .    to show the impact of the two different approaches on the outcoming spectra , we consider the same configuration described in section  [ shell ] , an initial neutral expanding shell which is ionized by a central source emitting also photons .",
    "we compare the spectra obtained with at the times when the gas configuration is characterized by a mean ionization fraction inside the shell of @xmath136 and  0.66 , to those obtained running mcon the same gas configurations .",
    "while with mcthe spectra are built by integrating over the photons once they have all escaped the fixed hi distribution , the algorithm allows to account for the impact on the emergent spectra of the ionization history which led to those configurations .",
    "the results are shown in figure  [ shell_mclya_fig ] .",
    "+ a substantial difference is clearly visible in the spectra corresponding to @xmath137 . the spectrum simulated by mcly@xmath0 is characterized by two bumps associated with the diffused and backscattered photons .",
    "a very different profile is obtained with , where no backscattered photon has escaped at this time and only the single red peak corresponding to the diffused photons is present . as already underlined in section  [ shell ] the absence of backscattered photons is due to their larger escaping time .",
    "the profiles corresponding to @xmath138 are much more similar , because at this stage a significant fraction of the backscattered photons had enough time to escape the shell .",
    "nevertheless , there is still a difference in the amplitude of the peak at @xmath118 and of the bumps from the backscattered photons , which are also slightly more shifted .",
    "this difference is due to the memory of photons emitted in the previous stages of the source activity , when @xmath139 . in the mcly@xmath0 treatment",
    "all the emitted photons see the same mean shell opacity and the probability to have a direct escape is significantly higher then in the run , in which the photons see on average a larger shell opacity . as a consequence ,",
    "the fraction of photons with @xmath118 in is smaller and , at the same time , the photons that have remained trapped for a longer time exhibit a larger amplitude of the spectra and a larger shift to the red side of the central frequency .",
    "the time elapsed between the two spectra considered above is only about 100  yr . the time interval in which deviations from the `` instantaneous picture '' are significant is thus too small to allow observations to capture these stages .",
    "however , the example is useful to illustrate the relevant features and advantages of our approach .",
    "furthermore the deviations found could affect the gas state , _",
    "e.g. _ its spin temperature , independently from their observational detectability in the spectra .",
    "a similar test has been performed to infer the observability of the deviations in the spectra on larger scales . in this case",
    "we use a simulation box of 200  kpc on a side and a photo - ionization rate of the central source @xmath140 . in this test",
    "the gas is distributed in a sphere of radius @xmath141  kpc , with density @xmath142  @xmath101 ( corresponding to @xmath143  @xmath103 ) , while we keep the temperature @xmath104  k ; we also assume a velocity field corresponding to a hubble expansion with @xmath144790  km  s@xmath30  mpc@xmath30 .",
    "the simulation is carried out for a physical time of @xmath145  yr . in this case",
    "[ large_mclya ] ) the first spectrum is captured at the time @xmath146  yr ( corresponding to a mean ionization fraction of @xmath147 ) and the second at the time @xmath148  yr ( @xmath149 ) . while the mcly@xmath0 profile in the left panel of figure  [ large_mclya ] , is characterized by a large red bump and a small blue one , with the approach we find a lower fraction of photons escaping with blue frequencies and a larger red bump which",
    "is slightly shifted on redder frequencies .",
    "this effect results from keeping memory of the ionization history , since we take into account that before reaching the observed gas configuration most of the photons have been trapped on the boundary of the growing ionized region .",
    "the integrated optical depth along the full path traveled before escaping is therefore larger respect to the one computed in the mcly@xmath0 approach .",
    "this effect is also visible in the right panel of figure  [ large_mclya ] , where a larger red shift is present . in this case",
    "a larger fraction of trapped photons are now free to escape and the shift is more evident .",
    "the major result of these tests is that the emerging spectra keep memory of the ionization history which generates a given observed configuration and , to properly account for this effect , the self - consistent joint evolution of line and ionizing continuum radiation followed by our scheme is necessary .",
    "the extent of the difference between the two methods depends on the particular case considered , but it can be substantial and can thus affect the physical interpretation of the problems at hand . in a forthcoming study we will investigate in more detail which are the objects / configurations for which the ionization effects are expected to be relevant in shaping the observed spectrum .",
    "in addition , the time evolution that builds up the radiation field can be important when calculating the impact of such radiation on gas properties like the spin temperature , which is relevant for the prediction of the observability of 21  cm emission from neutral hydrogen at high redshift .",
    "we plan to include the computation of these effects in a forthcoming extension of the code .      in this section",
    "we investigate the dependence of the final spectra on the parameters @xmath50 , @xmath48 and @xmath96 defined in sections [ lya_em ] and [ spectrum ] .",
    "the convergence tests presented are performed by adopting the same conditions of the static case ( see sec .",
    "first we compare spectra built by integrating over the full simulation time , _",
    "i.e. _ we set @xmath150 .",
    "we have done several runs varying the number of emissions ( @xmath151 ) and setting @xmath109 .",
    "photons are emitted according to equation  [ em_2 ] , _ i.e. _ at regular ionization intervals . for @xmath152 ,",
    "the two emissions are performed at the beginning and once the ionization degree has become stationary .",
    "the results are shown in the top - left panel of figure  [ input_fig ] . from an inspection of the figure",
    "it is clear that 2 emissions are not accurate enough to properly describe the emergent spectrum .",
    "this is a consequence of the method described in section 3.1 for weighting the contribution to the spectrum from photons emitted at different steps .",
    "in fact , as the time between the two emissions is large , the weight assigned to the photons of the second ( and last ) emission is so large that the contribution from the photons of the first emission is negligible . moreover , at the time of the second emission ionization is almost complete and as a consequence the spectrum has two thin peaks very close to the central frequency and shows no large frequency shift due to scattering in a gas with larger opacity .",
    "so , in this case the outcoming spectrum is the result of transfer in an almost ionized sphere and the stages through which the gas reached such configuration are completely neglected .",
    "as the number of emissions is increased , the accuracy improves and convergence is reached when @xmath153 .",
    "we have then checked convergence of instantaneous ( vs integrated ) spectra , setting @xmath154 and performing again four runs with different numbers of emissions ( @xmath155 and @xmath156 ) and @xmath109 .",
    "figure  [ input_fig ] displays two sets of spectra , each corresponding to a fixed @xmath112 value : 0.4 ( top - right panel ) and 0.7 ( bottom - left panel ) .",
    "effectively , the spectrum corresponding to @xmath152 is built only with photons from the first emission , as the second is performed when @xmath157 . at @xmath158",
    "the spectra are all very similar because the gas opacity is sufficiently high to trap photons and those emitted close to the time when the spectrum is built are still scattering in the gas . on the contrary ,",
    "as ionization proceeds , photons emitted at later times encounter less neutral hydrogen and escape more easily , and their contribution to the outcoming spectrum increases . as a consequence",
    ", the case with @xmath152 , when photons have been emitted only at the beginning of the simulation , displays a broader and more shifted profile .",
    "finally , we use different values of @xmath159 , with @xmath108 and @xmath107 , to determine the smallest number of photons needed in each emission in order to achieve convergence . in the bottom - right plot",
    "we show profiles corresponding to an ionization fraction of @xmath160 .",
    "as expected , the increasing number of photons in every emission produces a smoother profile .",
    "we find that , for the configuration considered , the emissions characterized by @xmath161 photons are not accurate enough , and at least @xmath32 photons per emission are needed .",
    "in this paper we have presented , the first radiative transfer code for cosmological application that follows the parallel propagation of and continuum photons .",
    "since propagation is dominated by resonant scattering with neutral gas , the effect of a rapid change in the degree of gas ionization can affect the features of the emerging spectrum . to investigate this issue ,",
    "we have developed in the continuum radiative transfer code ( ciardi et al . 2001 ; maselli , ferrara & ciardi 2003 ; maselli & ferrara 2005 , maselli , ciardi & kanekar 2008 ) a new algorithm to follow the propagation of photons through a gas configuration while it is changed by ionizing radiation .    in order to perform the implementation , it has been necessary to introduce the time evolution for propagation , a feature commonly neglected in line radiative transfer codes .",
    "this is a crucial aspect because , due to the resonant scattering nature of transfer in a neutral medium , radiation can remain trapped for a substantial fraction of the simulation lifetime before being able to propagate away from its emission site , while the propagation time of the ionization front can be much shorter .",
    "another challenge of the implementation has been to reduce the computation time for the scattering .",
    "in fact , to correctly model the propagation every single scattering should be followed .",
    "as this would require prohibitively large computational times , we have used a statistical approach to the treatment .",
    "we have compiled tables using mcly@xmath0 ( verhamme , schaerer & maselli 2006 ) to describe the physical characteristics of a photon escaping from a gas cell where it was trapped by scattering as a function of the temperature and density of the gas as well as of the incoming photon frequency .",
    "the tables are called within . with this statistical approach",
    "we experience a drastic reduction of the computational time and , at the same time , an excellent agreement with the full radiative transfer computations .",
    "we have discussed the details of the code implementation and tested it for several gas configurations , including static spherical gas distribution , expanding and collapsing spheres and expanding shell .",
    "for all the configurations analyzed , reproduces emerging spectra with the qualitative features expected from theoretical models and discussed previously in the literature , while a more quantitative comparison has not been feasible as is the first code which couples the continuum and line transfer . with this implementation",
    ", it has also been possible to investigate how the line shape of the emergent spectra evolves with the gas ionization .",
    "although the specific results depend on the geometry of the gas and on the velocity field , common trends are found .",
    "the main results can be summarized as follows .    *",
    "while ionization proceeds the peaks on the blue / red side of the line center move closer to the central frequency , getting thinner and higher , as expected for a gas configuration with progressively decreasing optical depth . depending on the gas configuration ( _ e.g. _ in case of an expanding shell ) ,",
    "more complex features arise that can be associated to the different paths followed by the photons before escaping . * the emerging spectra",
    "keep memory of the ionization history which generates a given gas configuration . * the novel approach to transfer developed in allows to resolve the emergence of different spectral features at different times during the evolution of the ionization field .",
    "features emerging on different time scales are typically associated to the various paths traveled by the photons before escaping . *",
    "a comparison between our new algorithm to follow the propagation of photons and a full line radiative transfer shows an excellent agreement for different gas configurations and an enormous gain in computational speed .    in order to account for the effects discussed above a self - consistent joint evolution of line and ionizing continuum radiation",
    "as implemented in is necessary .",
    "a comparison between the results from our code and from scattering alone on a fixed density field shows that the extent of the difference between the emerging spectra depends on the particular configuration considered , but it can be substantial and can thus affect the physical interpretation of the problem at hand .",
    "a detailed discussion on which are the objects / configurations for which the ionization effects are expected to be relevant in shaping the observed spectrum is deferred to a forthcoming publication .",
    "nevertheless , we have here discussed two specific test configurations for which the coupling of continuum and line radiation would be necessary in order to recover correctly the emergent profile .",
    "these differences are due to the time evolution feature introduced in for photons which allows to keep track of the ionization history imprint on profiles for the first time in the literature .",
    "the time evolution that builds up the radiation field can be furthermore important when calculating the impact of such radiation on gas properties like the spin temperature , relevant to predict the observability of 21  cm radiation from the early universe . in a forthcoming extension of the code ,",
    "we plan to include the self - consistent calculation of the impact of the radiation on the gas temperature , together with the contribution to the radiation from recombinations occurring in the gas .",
    "the authors thank anne verhamme and daniel schaerer for providing the last version of the code mcly@xmath0 and for their comments .",
    "they are also thankful to andrea ferrara for stimulating discussions and sharp comments on the draft .",
    "am is supported by the dfg priority program 117 .",
    "99    adams , t. f. , 1972 , , 174 , 439 ahn , s.h . , lee , h.w . ,",
    "lee , h.m . , 2000 , jkas , 33 , 29 ahn , s.h . , lee , h.w . ,",
    "lee , h.m . , 2001 , , 554 , 604 ahn , s.h . , 2004 , , 601 , l25 avery , l. w. & house , l. l. , 1968 , , 152 , 493 barkana , r. & loeb , a. , 2005 , , 626 , 1 bunker , a.j . , et al . , 2003 , , 342 , l47 cantalupo , s. , et al . , 2005 , , 628 , 61 chen , x. & miralda - escud , j. , 2006 , astro - ph/0605439 chuzhoy , l. & zheng , z. 2007 , astro - ph/0706.0895 ciardi , b. , , 2001 , , 324 , 381 ciardi , b. & madau p. 2003",
    ", , 596 , 1 ciardi , b. & salvaterra , r. , 2007 , , 381 , 1137 dijkstra , m. , haiman , z. & spaans , m. , 2006 , , 649 , 14 dawson , s. , , 2007 , astro - ph7/0707.4182 fan , x. , strauss , m. a. , becker , r. h. ; white , r. l. , gunn , j. e. , knapp , g. r. , richards , g. t. , schneider , d. p. , brinkmann , j. & fukugita , m. , 2006 , apj , 132 , 117 field , g.b . , 1958 , proc .",
    "i.r.e . , 46 , 240 field , g.b . , 1959 , , 129 , 536 gould , a. & weinberg , d. h. , 1996 , , 468 , 462 hansen , m. , oh , s.p . , 2006 , , 367 , 979 harrington , j.p . , 1973 , , 162,43 hu , e. , , 1998 , , 502 , l99 hu , e. , , 2002 , , 568 , 75 hu , e. , , 2004 , , 127 , 3137 iye , m. , , 2006 , , 443 , 186 kashikawa , m. , , 2006 , , 648 , 7 kobayashi , m. a. r. , kamara , h. 2004 , , 600 , 564 kodaira , k. , , 2003 , pasj , 55 , 17 kunth , d. , , 1994 , , 282 , 709 loeb , a. , rybicki , g.b .",
    ", 1999 , , 524 , 527 maselli , a. , ferrara , a. & ciardi , b. , 2003 , , 345 , 379 maselli , a. & ferrara a. , 2005 , , 364 , 1429 maselli , a. , ciardi b. , & kanekar , a. , 2008 , in preparation murayama , t. , , 2007 , , 172 , 523 neufeld , d.a . , 1990 , , 350 , 216 osterbrock , d. e. , 1962 , , 135 , 195 partridge , r. b. , peebles , j. e. 1967 , , 147 , 868 pell , r. , , 2006 , rmxac , 29 , 132 rhoads , j. e. & malhotra , s. , 2001 , , 563 , 5 rhoads , j. e. , , 2003 , , 125 , 1006 semelin , b. , combes , f. & baek , s. , 2007 , , 474 , 365 stark , d. p. , , 2007",
    ", , 663 , 10 stern , d. , , 2005 , , 619 , 12 taniguchi , y. , , 2005 , pasj , 57 , 165 tasitsiomi , a. , 2006 , apj , 645 , 792 verhamme , a. , schaerer , d. & maselli a. , 2006 , , 460 , 397 ( vsm06 ) wouthuysen , s. a. , 1952 , , 57 , 31 zheng , z. , miralda - escud , j. , 2002 , , 578 , 33",
    "following the single scatterings of each ly@xmath0 photon can be extremely expensive ; in order to avoid it we have built tables by using a statistical approach that allows to retrieve the frequency of the outcoming photon , @xmath44 , and the time interval for which the photon is trapped in the gas by the scatterings , @xmath80 , given the frequency of the incoming photon , @xmath43 , the gas temperature , @xmath78 , and optical depth , @xmath79 , of the cell where the scattering takes place .",
    "we adopt the opacity at line center to characterize the optical depth of the gas in a cell .",
    "notice that the frequencies are always meant in the comoving frame .",
    "the tables are compiled in the following way . given a value for the input parameters ( @xmath78 , @xmath79 and @xmath43 )",
    ", we run the mcly@xmath0 code several times ( the results converge when 10000 photons are emitted ) to obtain values for @xmath44 and @xmath80 which are then binned in distribution functions .",
    "the @xmath44 distribution is binned using regular intervals of 0.5 .",
    "for @xmath80 we adopt equally spaced logarithmic bins of 0.014 .",
    "it is important to note that the value of @xmath80 , which depends on the distance traveled by the photon , is linked to the size of the cell .",
    "thus , the tables are compiled for a reference cell size , @xmath162 , but anytime they are accessed by , the value of @xmath80 obtained needs to be rescaled for the actual cell dimension , @xmath163 .",
    "the ranges that the tables cover are :      an example of @xmath44 and @xmath80 distributions is given in figures [ x_out ] and [ t_cell ] .",
    "figure [ x_out ] shows the distribution of @xmath44 for @xmath167  k , @xmath168 and different values of @xmath43 ( @xmath16920 , 30 and 40 ) .",
    "figure [ t_cell ] shows how the @xmath80 distribution changes for different values of the optical depth , @xmath170 ; here we fixed @xmath171  k and @xmath172 .",
    "the above tables are accessed by in the following way .",
    "if @xmath78 , @xmath79 and @xmath43 are within the range covered by the tables , the distributions for @xmath80 and @xmath44 are calculated by a linear interpolation and then the value used in for @xmath80 and @xmath44 is obtained by mc sampling the interpolated distributions .",
    "the interpolation scheme for @xmath80 is as follows . as a first step , the values of temperature @xmath173 and @xmath174 closest to @xmath78 for which @xmath175 are found . the same is done for the optical depths @xmath176 and @xmath177 , and the frequencies @xmath178 and @xmath179 .",
    "the weights to be assigned to each value are derived by linear interpolation . as an example we can consider a simple 1d case , with linear interpolation only on temperatures . in this case , @xmath180 , where the weights are @xmath181 and @xmath182 , with @xmath183 .",
    "the same procedure , extrapolated in 3d , produces a distribution of @xmath80 that will be randomly sampled in .",
    "the interpolation for @xmath44 follows the same steps , after a shift in the frequency space has been performed to assure that the correct distribution is obtained and no spurious peak forms . to understand how the @xmath44 interpolation works an easy example can be useful",
    "let us assume that our purpose is to reproduce the dashed profile centered in @xmath184 ( fig .",
    "[ x_out ] ) starting from the two profiles at @xmath185 and @xmath186 .",
    "if the interpolation were performed bin by bin without any previous shift ( _ e.g. _ the bin [ 19.5 - 20 [ of the solid curve with the bin [ 39.5 - 40 [ of the dashed - dotted curve , and similarly for all the bins ) , the result would be two smaller peaks centered at @xmath185 and @xmath186 , rather than one centered at @xmath184 . to perform a correct interpolation we need to center the solid and dashed - dotted profiles on @xmath184 and then interpolate .    to check the validity of our approach , we have compared the results from the full radiative transfer treatment ( using mcly@xmath0 ) with a case in which the tables were used . in figure",
    "[ comparison ] the distribution in frequency of 10000 ly@xmath0 photons escaping from a gas with temperature @xmath187  k , optical depth @xmath188 and frequency @xmath118 is shown .",
    "the dotted ( solid ) line in the upper panel indicates the results for the approximate ( full radiative transfer ) treatment using tables built with 10000 photons . in the bottom panel the difference between the two distributions is plotted , showing an excellent agreement , which is found also for different initial conditions .",
    "we perform the same check with a more complex gas distribution using the expanding shell described in section  [ shell ] . as the final spectrum",
    "is expected to have a wider frequency distribution , this test is performed to check the accuracy of the @xmath44 interpolation at larger frequency shifts .",
    "the results are shown in figure [ comparison_shell ] ; for both profiles we have used 400000 photons .",
    "also in this case an excellent agreement is found .",
    "as the changes in the gas properties during a simulation can be drastic , sometimes the values @xmath79 and @xmath43 can fall outside the range covered by the tables ( we do not expect @xmath78 to fall outside the range ) . in these cases",
    "we perform an extrapolation of the existing tables .",
    "more in particular , for @xmath189 we use the same distributions derived for @xmath190 .",
    "this is a good approximation as at these frequencies the cross section is small and scattering rare .",
    "the extrapolation for the optical depth works differently .",
    "if @xmath191 no interaction takes place and the photon propagates freely . if @xmath192 we divide the cell into @xmath193 sub - cells ( where @xmath194 is the number of divisions performed ) until each sub - cell has an optical depth @xmath195 . at this point ,",
    "every sub - cell is treated as a single cell ."
  ],
  "abstract_text": [
    "<S> in this paper we present , the first radiative transfer code for cosmological application that follows the parallel propagation of and ionizing photons . is a version of the continuum radiative transfer code with a new algorithm to follow the propagation of photons through a gas configuration whose ionization structure is evolving . the implementation introduces the time evolution for photons ( a feature commonly neglected in line radiative transfer codes ) and , to reduce the computational time needed to follow each scattering , adopts a statistical approach to the treatment by making extensive use of pre - compiled tables . </S>",
    "<S> these tables describe the physical characteristics of a photon escaping from a gas cell where it was trapped by scattering as a function of the gas temperature / density and of the incoming photon frequency . </S>",
    "<S> with this statistical approach we experience a drastic increase of the computational speed and , at the same time , an excellent agreement with the full radiative transfer computations of the code mcly@xmath0 . </S>",
    "<S> we find that the emerging spectra keep memory of the ionization history which generates a given ionization configuration of the gas and , to properly account for this effect , a self - consistent joint evolution of line and ionizing continuum radiation as implemented in is necessary . </S>",
    "<S> a comparison between the results from our code and from scattering alone on a fixed hi density field shows that the extent of the difference between the emerging spectra depends on the particular configuration considered , but it can be substantial and can thus affect the physical interpretation of the problem at hand . </S>",
    "<S> these differences should furthermore be taken into account when computing the impact of the radiation on _ </S>",
    "<S> e.g. _ the observability of the 21  cm line from neutral hydrogen at epochs preceeding complete reionization .    </S>",
    "<S> [ firstpage ]    radiative transfer - ionization - ly@xmath0 </S>"
  ]
}