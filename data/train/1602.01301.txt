{
  "article_text": [
    "3d single - particle imaging with x - ray free - electron lasers ( xfels ) is being actively pursued for its potential biological applications , which notably include determining the structures of single molecules @xcite .",
    "it is also one of the most challenging goals in x - ray laser science , because each diffraction measurement provides a very weak signal and is destructive .",
    "as few as @xmath0 photons per shannon - nyquist pixel ( at high scattering angles ) are expected for a 500 kda protein @xcite . to overcome low",
    "signal - to - noise , the experiment involves a large number of diffraction measurements ( 10@xmath110@xmath2 ) and each measurement must be of a new copy of the particle , which is assumed to have an identical structure .",
    "such datasets are achievable because xfels have high repetition rates ( @xmath3 100 hz @xcite ) and serial injection technology has been developed to continuously deliver fresh sample into the beam path @xcite .",
    "a consequence of this experimental approach is that particle orientation is not measured and must be determined by analyzing the diffraction data @xcite . in practice ,",
    "a single orientation is not associated with each diffraction pattern , but rather the low signal per pattern is more effectively handled by treating the data globally to directly obtain a 3d diffraction intensity volume @xcite . this intensity volume in then given as input for a phase retrieval algorithm that produces an image of the particle @xcite .      in order to assemble the two - dimensional noisy diffraction patterns into a consistent three - dimensional intensity function",
    ", numerous algorithms have been proposed to date .",
    "early work from huldt _",
    "et al._@xcite and bortel _ et al._@xcite classified patterns into classes , which were averaged to improve signal - to - noise prior to orienting the classes using common arcs of intersection .",
    "however , the classification is not suffiently accurate to handle the low signals expected in experiment @xcite .",
    "this approach has since been superseded by a variety of methods that treat the data globally to overcome the issue of noise .",
    "fung _ et al._@xcite proposed an algorithm based on a manifold embedding technique .",
    "this approach is based on a generative topographic mapping ( gtm ) , where each pattern is considered as a vector of the @xmath4-dimensional space of intensities , with @xmath4 the number of pixels on the detector .",
    "since a continuous rotation of the sample implies a continuous variation of the diffraction intensities , the images obtained should span a three - dimensional manifold embedded in @xmath4-dimensional space .",
    "the manifold is generated from a large number of diffraction patterns , and averaging out the closest diffraction patterns leads to the expected smooth manifold .",
    "however , a large number of diffraction patterns may be required to obtain a sufficiently smooth manifold @xcite .",
    "we note that this approach has been developed further recently in @xcite .",
    "more recently , diffusion map techniques have been developed to compute low - dimensional manifolds from xfel diffraction data @xcite . in practice",
    ", these techniques can generate more than three significant dimensions revealing other experimental variables such as changing beam conditions or sample heterogeneity .",
    "the advantage here is that the generation of the manifold is not biased by human assumptions .",
    "the challenge is the interpreting the manifold and identifying the correct relationship between the three degrees of freedom on the manifold and the rotation group .",
    "one way to explicitly relate the data - space to rotations is via mapping geodesics @xcite .    the first attempt to introduce geometrical constraints in the processing of diffraction patterns",
    "was taken by saldin _",
    "et al._@xcite , where the three - dimensional intensity function was expanded on the spherical harmonic basis .",
    "their approach was based the cross - correlation of the diffraction patterns and exploits the orthogonality of spherical harmonics to obtain a decomposition of the cross - correlation function .",
    "it is interesting to note that this method has been tested experimentaly @xcite on large dimers with known structure . for objects of known rotational symmetry",
    ", the correlation function can be converted into the 3d single - particle fourier intensity , which can then be converted to an image of the particle via phasing . for some time ,",
    "it was known how to extend this method to an asymmetric 3d object , but recently an algorithm has been proposed to phase directly from the correlation function @xcite .",
    "the correlation function can also be used with molecular replacement techniques @xcite .",
    "it has the added advantage that multiple particles can be illuminated per measurement , which not many other algorithms can handle .    in ref .",
    "@xcite , loh and elser have introduced the expansion - maximization - compression ( emc ) algorithm which relies on an expectation - maximization ( em ) technique . as a bayesian method",
    ", it aims to use known information about the noise statistics to handle very low signal - to - noise levels .",
    "the algorithm iteratively maximizes the likelihood of the reconstructed intensity given the set of diffraction patterns .",
    "the algorithm does not assign a single molecular orientation to each pattern , but rather it estimates the probability for a diffraction pattern to be associated with a certain orientation . recently , this algorithm has proven its feasibility with the reconstruction of mimivirus from experimental data collected at lcls @xcite .",
    "the emc algorithm is studied in detail in this work , with the introduction of several improvements .",
    "recently , walczak _",
    "et al._@xcite developed the bayesian approach further using seed structural models to speed up convergence and to discriminate between different conformations .",
    "finally , we note that tegze and bortel @xcite have proposed a simplified version of the emc algorithm , where the diffraction pattern orientation is fully assigned through the intensity best fit , rather than in a probalistic way .",
    "a drawback of the emc algorithm is that it is computationally expensive to implement on large datasets that are expected in experiment .",
    "the emc algorithm stores a matrix that grows proportionally with the number of diffraction patterns and must be recalculated at every iteration .",
    "this is not a trivial step if there are 10@xmath5",
    " 10@xmath2 measured diffraction patterns .",
    "hence , there is still scope to develop the emc algorithm further to enable parallelization and efficient computation .",
    "another related issue is analyzing smaller datasets at lower resolution , which would be very valuable during an experiment to provide feedback on data collection .",
    "algorithms that are readily scaled with the number of patterns and resolution are also valuable .    with these considerations in mind ,",
    "we study here the application of spherical harmonic analysis to the emc algorithm .",
    "our goal is to produce an emc algorithm that can be scaled in terms of angular and radial resolution .",
    "this facilitates starting with lower resolution reconstruction with less patterns , higher signal and less computational time , before proceeding to higher resolutions . by implementing the algorithm shell by shell",
    ", we also enable it to be easily parallelized .",
    "after reviewing the relevant properties of spherical harmonics in section [ sec : geom ] , we formulate the emc algorithm for a single q - shell in section [ sec : emc ] and impose an angular bandwidth limit .",
    "section [ sec : shell ] describes how reconstructions on neighbouring shells can be aligned via correlations , and finally numerical tests are provided in section [ sec : numeric ] .",
    "while our work improves upon the computational requirements for emc , it does not match the computational advantages of correlation methods based on spherical harmonics that do not require more memory as the number of patterns increases@xcite .",
    "as described above , however , correlation - based methods have other issues for particles without rotational symmetry , while emc has potential advantages for analyzing low signal data , which contributes to its popularity . explorations of how to retain the advantages of emc at lower computational expense are thus valuable for the development of xfel single particle imaging .",
    "the intensity function of a biomolecule @xmath6 is linked to @xmath7 the fourier transform of its 3d electron density @xmath8 , with @xmath9 and @xmath10 respectively the real and reciprocal space coordinates . during xfel experiment",
    ", each diffraction pattern is obtained from a randomly rotated copy of the biomolecule .",
    "a rotation of the molecule in the real space corresponds to the same rotation around the origin of the ewald sphere in the dual space .",
    "the accumulation of thousands of diffraction patterns from rotated molecules can cover a spherical volume in the reciprocal space , in order the reconstruct of the 3d intensity of the biomolecule .    with the notation previously introduced ,",
    "the fourier transform or molecular transform @xmath11 of the three - dimensional electron density of the molecule reads , @xmath12 the intensity function @xmath13 is defined as the square magnitude of the fourier transform of the electron density , up to a constant normalizing factor @xmath14 depending on the experimental conditions @xcite .",
    "thus we have the following @xmath15    in what follows , we will be using spherical coordinates for @xmath10 , meaning that its parametrization will be @xmath16 where @xmath17 is the radial coordinate , and @xmath18 are angular coordinates , where the polar angle is relative to the beam axis . in the following we make use of the shorthand notation @xmath19 , where @xmath20 is an unit vector pointing towards angular coordinates @xmath21 .    in order to take advantage of the symmetries of the intensity function @xmath13",
    ", we propose to consider it as a set of concentric shells of increasing radii .",
    "on such a shell of radius @xmath22 , where @xmath23 stands for the shell number , we define the intensity @xmath24 . in the reconstruction process",
    ", the three - dimensional intensity function will be recovered by assembling the reconstructed intensities over spherical shells .",
    "the shell - by - shell reconstruction can be made efficient using the fact that each @xmath25 can be decomposed on a spherical harmonic basis .",
    "such spherical basis is presented is section [ subsec : harmdcompi ] . before introducing this decomposition ,",
    "we first present the measurement model .      in order to perform shell - by - shell reconstruction of the intensity function ,",
    "we introduce a measurement model which relates diffraction data to the corresponding part of the intensity on each shell . in this model ,",
    "as shown in figure [ fig : shellprocessingmethod ] , the corresponding _ diffraction patterns _ on a spherical shell @xmath23 are mono - dimensional , _ i.e. _ circles on this spherical shell . formally , we denote by @xmath26 the _ detector _ on the shell , that is the reference sampling points .",
    "@xmath26 is defined as the set of @xmath27 _ pixels _ coordinates on the spherical shell @xmath28 and given by @xmath29 where @xmath30 is given in angular coordinates by @xmath31 $ ] , and @xmath22 is the radius of the spherical shell .",
    "the dependence of @xmath32 on the radius @xmath22 is a consequence of the scattering geometry .",
    "for completeness we recall that @xmath33 where @xmath34 is defined in terms of the wavelength @xmath35 , @xmath36 .    on the detector , the number of pixels contributing to a shell , _",
    "i.e._the number of pixels on a circle on the diffraction pattern increases with the radius @xmath22 .",
    "the number of points @xmath27 on the detector are scaled such that : @xmath37 where @xmath38 denotes the ceiling function , and @xmath39 is the reciprocal space pixel size .    finally ,",
    "each measurement @xmath40 , or diffraction pattern on a shell consists in a set of @xmath27 samples @xmath41 , @xmath42 given by a poisson model @xcite ( due to low - photon counts expected in single - particle experiments ) @xmath43 where the random rotation @xmath44 is drawn from the uniform distribution on the rotation group @xmath45",
    ".          the intensity on a given shell @xmath23 , _ i.e. _ @xmath28 , can be expanded on the spherical harmonics basis ( see appendix [ appendix_a ] for details ) as follows , @xmath46 where the coefficients @xmath47 are the spherical harmonic coefficients of the intensity function on the shell @xmath23 .",
    "it turns out that the spherical harmonic representation provide an efficient way to deal with the symmetries of the intensity functions . in the following ,",
    "we exploit the physical properties of the intensity function to simplify further the expansion above .",
    "first , intensity functions are by definition real - valued functions .",
    "as a consequence , its spherical harmonic coefficients exhibits the well - known conjugation property of spherical harmonics @xmath48 moreover , another interesting property is the centro - symmetry of intensity functions , also known as the friedel property .",
    "this symmetry property reads @xmath49 and it is straightforward to see that with this constraint every coefficient of odd degree @xmath50 is set to zero , @xmath51 finally , the finite size nature of the molecule in real space implies that the spectral representation on each shell is effectively bandlimited , meaning that the coefficients in the spherical harmonics expansion are non - zero up to a maximum degree @xmath52 @xmath53 where @xmath52 is the bandlimit on the shell @xmath23 , and where the sum has been restricted to even values of the degree @xmath50 . since friedel symmetry imposes condition ( [ eq : friedelsymmetrycoefficients ] ) on the coefficients , the value of @xmath52 is an odd number .",
    "it is interesting to note that rotational symmetries of the particle will further reduce the number of independent coefficients .",
    "this makes it easier to implement particle symmetry than for the cartesian sample of the intensity function used in the original emc algorithm and may improve performance in the case of highly symmetric particles .",
    "we develop in this section extension of the original emc algorithm @xcite to the spherical harmonic basis.precisely , we define an update rule in terms of the spherical harmonic coefficients of the shell intensity , and scale efficiently the computation time in terms of the bandlimit @xmath54 .    in",
    "what follows , all quantities with superscript @xmath55 denotes the corresponding values at the @xmath56-th iteration of the em algorithm .",
    "we start this section by recalling the framework of em algorithms . in general",
    ", em algorithms provide an efficient way to deal with missing data @xcite . in our spherical setting ,",
    "we design an em algorithm which updates the spherical harmonics coefficients at each iteration , namely we write the update rule @xmath57 where @xmath56 denotes the iteration index . note that we distinguish the estimated coefficients @xmath58 from the theoretical ones @xmath59 to avoid confusion . at each iteration of the em algorithm ,",
    "the likelihood of the estimated parameter @xmath58 given the set of measurements @xmath60 is increased .",
    "however , em - algorithms do not work directly with the likelihood function , but rather with the _ intermediate quantity _",
    "@xmath61 , whose value is determined in the expectation step ( e - step ) of the algorithm . for practical purposes ,",
    "we first introduce the intermediate quantity per pattern @xmath62 , which reads @xmath63p(\\bm r\\vert \\bm y_k , \\hat{\\bm c}^{(n)})\\mathrm{d}\\mu(\\bm r)\\ ] ] where @xmath64 denotes the ( bi)-invariant haar measure on @xmath45 .",
    "since the acquisitions @xmath65 are independent from each other , we can express the total intermediate quantity as the sum @xmath66 where the choice of the normalization made here is arbitrary .",
    "the maximization step can now be defined as the maximization of the ( total ) intermediate quantity , such that it reads @xmath67 we note here that there are potentialy several values of @xmath58 that maximize the intermediate quantity ; therefore uniqueness is not guaranteed .",
    "this is a general property of expectation - maximization algorithms .        considering the em algorithm expressed directly with the spherical harmonic coefficients",
    "is a complicated task , which leads to intractable maximizations procedures .",
    "rather than solving the problem directly in the spherical harmonic domain , we extend the original approach of loh and elser @xcite to a spherical framework .",
    "let us introduce a spherical intensity model , denoted by @xmath68 .",
    "this spherical intensity model @xmath68 can be expressed using a spherical harmonic expansion similar to ( [ eq : shintensitymodelgeneric ] ) .",
    "the corresponding intermediate quantity per pattern reads @xmath69\\\\ & \\times p(\\bm r\\vert \\bm y_k , w^{(n)}_{\\bm r})\\mathrm{d}\\mu(\\bm r )          \\end{split}\\ ] ] where @xmath70 is a shorthand notation for the set @xmath71 .",
    "recall that the @xmath72 denote the reciprocal space coordinates of the detector .",
    "now , let us give details on the different quantities above .",
    "the conditional probabilities read @xmath73 the first equality is simply the definition of the joint probability , whereas the second equality is obtained applying bayes rule .",
    "we note that those quantities involve the prior distribution on the orientations , _",
    "i.e. _ @xmath74 since the model @xmath68 is assumed deterministic .",
    "we assume there is no preferential orientation of the particle and that the distribution of orientations is uniform , which means with respect to the bi - invariant haar measure on @xmath45 that @xmath75 moreover , the poisson assumption on the photon count and the independence of each pixel yields to @xmath76 which gives the expression of the intermediate quantity per pattern    @xmath77\\prod_{i=1}^n(w_{i,\\bm r}^{(n)})^{y_{ik}}\\exp(-w_{i,\\bm r}^{(n)})\\ ] ]    where @xmath78 is a constant only depending on the data @xmath79 ( which is arbitrarly removed hereafter ) , and @xmath80 is a normalization constant given by @xmath81    now , we face the following problem of computing the integrals over the rotation group @xmath45 . unfortunately there is no exact way to do so due to the lack of quadrature formula for probability functions on the rotation group @xmath45 .",
    "nevertheless , the integrals above can be approximated via a discrete sum over elements of the rotation group .",
    "more precisely , if we suppose that we have some sampling set @xmath82 of size @xmath83 and whose elements are indexed by @xmath84 , the intermediate quantity reads    @xmath85\\prod_{i=1}^n(w_{ij}^{(n)})^{y_{ik}}\\exp(-w_{ij}^{(n)})\\ ] ]    where @xmath86 are equivalent to quadrature weights such that @xmath87 , @xmath88 , and where @xmath89 is obtained following the same guidelines .",
    "since the model @xmath68 is now evaluated at @xmath83 rotated versions of the original detector coordinates , we call it a _ tomographic model_. in a similar way , we define the _ tomographic grid _ coordinates as @xmath90 .    in short - form , we can rewrite the latter intermediate quantity as a function of the tomographic model @xmath91 where @xmath92 is given by @xmath93 finally , the corresponding expectation step of the em algorithm is given by @xmath94 the last expressions ( [ eq : definition_proba_pjk ] ) and ( [ eq : intermediate_quantity_lohelser ] ) are exactly the same as in ref .",
    "@xcite , as expected .",
    "the expression of the intermediate quantity ( [ eq : intermediate_quantity_lohelser ] ) is rather simple and allows for a closed - form maximization procedure , that is @xmath95    we note that in recent papers @xcite , where the emc algorithm is applied to experimental data , an update rule of the fluence in each diffraction pattern is also derived .",
    "here we make the simplifying assumption that the fluence in each diffraction pattern is constant .      by introducing a tomographic model @xmath68",
    ", the em - procedure has been made easier .",
    "however , our goal is to obtain an algorithm which updates the spherical harmonic coefficients up to some degree @xmath96 for the considered shell , and this is done by adding two extra steps , known as expansion and compression .",
    "first , we remark that the tomographic grid coordinates are treated independently : therefore there exists a lot of tuples @xmath97 such that the coordinates @xmath98 , @xmath99 are really close . to enforce the consistency of the estimated model",
    ", we introduce a _",
    "regular _ spherical grid @xmath100 and the corresponding regular model @xmath101 , whose nodes are given by @xmath102 .",
    "note that the grid depends on the bandlimit @xmath54 , allowing efficient scaling of the grid size .",
    "if the grid is well chosen and exhibits nice features , then the spherical harmonics coefficients @xmath103 up to some degree @xmath96 can be obtained using a fast implementation of the spherical harmonic transform .",
    "the above description actually corresponds to the compression step ( c - step ) , which can be schematically given by @xmath104 whereas the reverse operation is the expansion step ( e - step ) @xmath105      we make use of the material introduced in appendix [ appendix_a ] by choosing the healpix sampling scheme on the sphere for our grid @xmath100 .",
    "healpix grid on the sphere provides equal - area pixelization of the sphere , along with hierarchical resolution and numerous features @xcite .",
    "the compression step is performed as follows .",
    "we first determine the tomographic points @xmath98 belonging to each healpix pixel , and then the intensity value on this pixel is given by inverse distance weighting ( idw ) between the respective @xmath98 and the pixel center @xmath102 , @xmath107 the coefficients @xmath47 are then computed up to order @xmath96 as given by the sampling theorem ( [ eq : appendix_sampling_theorem_healpix ] ) using a fast spherical harmonic transform ( sht ) .",
    "the friedel symmetry is restored by canceling the coefficients for odd values of @xmath50 .",
    "the expansion step is done by the successive expansion of the coefficients @xmath47 to obtain @xmath101 , then by computation of the tomographic intensities by interpolation on the sphere .",
    "precisely the intensity @xmath101 is obtained by inverse sht , again implemented using the healpix package routines .",
    "the interpolation from the regular grid @xmath106 to the tomographic grid is done by bilinear interpolation using the four nearest - neighbors on the regular grid .",
    "several issues need to be considered when using the proposed spherical emc algorithm and the adaptive spherical emc algorithm given in pseudocode algortihms [ alg1 ] and [ alg2 ] respectively .",
    "we discuss thereafter the critical points to control in order to ensure proper behaviour of the reconstruction algorithms .      in general , initialization of em - like algorithms",
    "is critical .",
    "indeed , convergence is often guaranteed only to a local maximum of the likelihood . as a consequence ,",
    "a bad initialization of the algorithm may lead to local convergence to an undesired non - global minimum . in order to minimize such an effect ,",
    "an initialization procedure based on the bandlimit adaptive scheme proposed throughout this paper can be used .",
    "namely , since the algorithm estimates bandlimited intensity functions with increasing degree , it seems reasonable to initialize the algorithm with the previous estimated model , at bandlimit @xmath108 . at the first stage of the algorithm , corresponding to bandlimit @xmath109 , this is done the following way .",
    "first the tomographic model is initialized with the mean photon count ( mpc ) of the diffraction patterns on this shell .",
    "note that the mpc is defined here as an average over the detector pixels , not in terms of shannon - nyquist pixels .",
    "then , to avoid the algorithm stopping prematurely , we slightly pertubate the mpc .",
    "the initialized tomographic model then reads @xmath110 with @xmath111 and where the @xmath112 s are drawn uniformly on the interval @xmath113 $ ] . here",
    "@xmath114 is a randomization parameter , @xmath115 . finally , performing one compression step leads to the estimate of initial spherical harmonic coefficients @xmath116 , which completes the initialization step .",
    "another important point issue is the convergence assessment of the algorithm . in the general em algorithm setting",
    ", this is often done by monitoring the likelihood value , whose increments are given by the so - called _ fundamental inequality of em _",
    "@xcite @xmath117 the em algorithm then stops when likelihood increments become smaller than a certain threshold value . in the emc setting we added two extras steps , expansion and compression respectively , to make the expectation - maximization procedure tractable .",
    "this yields to a loss of important properties of the em algorithm , namely the likelihood @xmath118 is not forced to increment at each iteration , and the likelihood value is not directly available .    to obtain the likelihood value , it is thus necessary to proceed as follows .",
    "first recall that we have only defined the intermediate quantity @xmath119 for now .",
    "the likelihood is obtained the following way @xmath120 where the _ entropy _ @xmath121 is defined like in @xcite by @xmath122\\\\&\\times p(\\bm r\\vert \\bm y_k , w^{(n)}_{\\bm r})\\mathrm{d}\\mu(\\bm r )      \\end{split}\\ ] ] we are interested in the likelihood of the model at iteration @xmath56 , denoted by @xmath123 . using the expression above , it reads @xmath124 . using similar arguments as above",
    ", the latter quantity can be rewritten the following way @xmath125 we note that the quantity @xmath126 is exactly the _ mutual information _ quantity proposed by loh and elser ( * ? ? ?",
    "* equation 19 ) .",
    "our stopping criterion is now defined as follows . at each iteration , we compute the relative likelihood variation denoted @xmath127 .",
    "when the value of @xmath127 goes below a given threshold @xmath128 , then either the algorithm stops if the current value of @xmath54 is equal to @xmath129 , or restart with an increased bandlimit @xmath54 and uses the previously estimated spherical harmonic coefficients as a starting point .",
    "the computational time of the algorithm presented in this paper scales directly with the desired resolution of the desired reconstruction .",
    "actually , the most expensive part is the maximization step , which in our case scales as @xmath130 .",
    "it thus shows a clear dependence on the bandlimit @xmath54 , and on the number of pixels on the shell .",
    "this motivates the shell - by - shell approach : since inner and outer shells show two disjoints set of parameters ( small @xmath54 and @xmath27 for the inner shell , large @xmath54 and @xmath27 for the outer shells ) , it is interesting to gain computation time by parallelization of the shell reconstructions .    also , the increasing bandlimit approach is expected to lead to a better conditioning of the algorithm , limiting the number of iterations and improving the quality of the reconstruction .",
    "finally , we shall point out that the sampling of the rotation group used here is based upon harmonic analysis results on the rotation group .",
    "therefore , one may expect the harmonic approximation of integrals over @xmath45 used in the emc algorithm to perform equally well compared to the @xmath131-cell sampling scheme previously introduced @xcite .",
    "[ sec : shell ] since we have considered each shell separately ( which allows an efficient parralelization of the algorithm , and distribution of the data ) , the shells have to be realigned in order to form a consistent 3d function .",
    "namely , we want to minimize the quadratic error between two successive shells",
    ". the problem can be stated as follows , we need to find the rotation @xmath132 such that @xmath133 where we have introduced the rotation operator @xmath134 defined by @xmath135 .",
    "as the features shared by the shell intensities evolve with the radius @xmath22 , the spherical shell alignment problem between two consecutive shells is only significant if these are sufficiently close to each other .",
    "the alignment procedure is indeed expected to fail in the case where @xmath136 , that is the shannon - nyquist theorem is no longer verified in the radial direction .    in this paper",
    "the shell alignment problem is solved using correlations on the rotation group , using an approach proposed by kostelec and rockmore in @xcite . for an overview concerning the so - called _ rotational matching problem _ , see for instance @xcite and reference therein , especially for the rotational matching problem in biophysics .",
    "the problem as stated in ( [ eq : position_problem_shell_alignment ] ) is equivalent to maximizing the correlation of the two shell intensities , @xmath137 we remind that the shell intensities are also represented by their estimated spherical harmonic coefficients up to a given bandlimit @xmath54 ) , respectively @xmath138 and @xmath139 . using fourier analysis properties on the rotation group",
    ", the correlation above can be expressed the following way @xmath140 where we have introduced the wigner - d functions , @xmath141 , which are detailed in appendix [ appendix_b ] .",
    "now , using the same rotation group sampling as in the spherical emc algorithm , one can evaluate the correlation ( [ eq : correlation_practical ] ) efficiently .",
    "the rotation @xmath142 that leads to the higher correlation value between the two shells is then used to align the @xmath143 shell with the previous one .",
    "namely , the _ aligned _ spherical harmonic coefficients read @xmath144 by repetition of the same procedure for succesive shells , we are able to reconstruct efficiently the full 3d intensity function .    finally , a few non trivial points are to be mentioned .",
    "first , since the correlation is performed numerically on a discrete rotation sample , it is unlikely that the rotation leading to the higher correlation value will be the _ exact _ one .",
    "however , by increasing the size of the rotation sampling , the rotation estimation error will be further reduced . moreover , from a practical perspective , a good approximation of the correlation can be obtained using only spherical harmonics of low degree , even in the case of large bandlimits @xmath54 @xcite .",
    "this could be adequatly exploited to obtain low - resolution reconstructions efficiently .",
    "finally one can note that a method as been proposed in @xcite to improve the accuracy of the rotation matching , and could be efficiently applied in our context .",
    "in this section , we illustrate our approach with simulations .",
    "first , we show how the adaptive spherical emc can effectively reconstruct the shell intensity for different bandlimits .",
    "we illustrate the potential of the approach by considering three typical shells , an inner , middle and outer shell respectively .",
    "theoretical intensity functions corresponding to these three shells are presented in figure [ fig : theoreticalenergydistribution ] .",
    "the behavior of the algorithm with respect to the number of observations is also studied in detail .",
    "secondly , we investigate the full shell - by - shell reconstruction problem , and analyse the effect of the distance between shells on the resulting resolution .",
    "all simulations show results for the satellite tobacco necrosis virus ( stnv , pdb entry : 2buk ) , one of the smallest viruses known to date .",
    "the reciprocal space size of a pixel is @xmath145 @xmath146 .",
    "simulations are performed for a fluence @xmath14 corresponding to @xmath147 photons per pulse and @xmath148 @xmath149m@xmath150 focal spot area .",
    "corresponding mean photon count ( mpc ) per pixel are given in the top of figure [ fig : theoreticalenergydistribution ] .",
    "we note that the number of photons per pulse used here ( @xmath147 ) is about ten times higher than those currenlty available at xfel facilities .",
    "this choice is motivated here by the fact that it allows us to use less diffraction patterns to reconstruct the biomolecule , as the aim of this work is to demonstrate the feasability of the approach . as it will be seen in the next section ,",
    "using state of the art photon counts will lead to an higher number of diffraction patterns required for a given bandlimit @xmath54 .        in this section",
    "we address the important issue of the required number of diffraction patterns in single - particle experiments .",
    "namely , we ask the following question : given a specified shell , how many diffraction patterns are needed to reconstruct the intensity defined on this shell , for a given bandlimit @xmath54 ?",
    "this question is in general quite complex , and to allow further investigation we need to make some assumptions .",
    "the reconstruction of the intensity on the shell is conditional upon the ability to recover the orientation of each diffraction pattern , yet to have sufficient signal - to - noise ratio .",
    "it is expected that the number of diffraction patterns required will be governed by a combination of these two factors .",
    "when the signal - to - noise ratio is high , as expected for large biomolecules and viruses ( and already shown by a recent experiment @xcite ) , the orientation recovery problem drives predominantly the performances of reconstruction algorithms . in the sequel",
    ", we perform numerical analysis addressing the question stated previously , taking into account both orientation recovery issue and sufficient signal - to - noise ratio .",
    "let us consider a shell of radius @xmath22 , and that detector coordinates on this shell are given by equation ( [ eq : detector_definition_shell ] ) .",
    "we note that the number of pixels on the detector @xmath27 scales with the radius @xmath22 , given the pixel spacing @xmath39 .",
    "moreover , we fix a mean photon count per pixel on this shell .",
    "now , we define an equal - area grid on the sphere with healpix , with a resolution parameter @xmath151 .",
    "we draw an uniform random rotation from @xmath45 , and apply it to the detector coordinates . then",
    ", we draw @xmath27 samples from the poisson distribution of parameter @xmath152 .",
    "finally , we analyse which healpix pixels are visited by the non - zero pixels of this _ rotated detector _ and keep trace of this visit .",
    "the number of runs of this simulation until each pixel has been visited at least once gives us an estimate of the required number of diffraction patterns on this shell , for a given resolution @xmath151 .",
    "repeating this algorithm several times gives a fair estimate of this number .    here , we only analysed the number of required patterns in terms of the resolution parameter @xmath151 .",
    "recalling that @xmath151 is linked to the bandlimit @xmath54 by the approximate sampling theorem ( [ eq : appendix_sampling_theorem_healpix ] ) , we link each @xmath151 value with the maximum bandlimit @xmath54 available for this resolution parameter .",
    "extrapolation between missing @xmath54-values gives an estimate of the required diffraction patterns for any @xmath54 value .",
    "note that with this choice of detector geometry and for a given shell , the maximum value of @xmath54 available is given by @xmath153 .",
    "this simply means that the maximum bandlimit available increases with the shell radius .",
    "the results of the simulation are presented in figure [ fig : requiredpatterns ] . in the first row , we analysed the number of diffraction patterns needed in the case of three typical shells , inner , middle , and outer , and for different mpc on these shells",
    ". the mpc used here are @xmath154 , @xmath155 , @xmath148 , @xmath156 .",
    "first , one sees that for a given shell and bandlimit , the number of required patterns increases as the mpc decreases , as expected .",
    "similarly the patterns required increase with the bandlimit @xmath54 , given a certain shell and mpc .",
    "for a given bandlimit @xmath54 and a fixed mpc , the required number of patterns reduces as the shell radius increases .",
    "this is the expected behaviour , since at @xmath54 fixed , the area of each pixel on the sphere increases .",
    "moreover , we note that for each shell , the required number of patterns behaves as a power law of @xmath54 .    at the bottom of figure [ fig :",
    "requiredpatterns ] , the number of patterns required in the case of the stnv virus are presented .",
    "note that the number of required patterns increases with the shell radii , due to a lower mpc in the outer shells .",
    "black squares show the theoretical bandlimit of the shell intensity , calculated from figure [ fig : theoreticalenergydistribution ] by thresholding the relative energy per degree below some predefined threshold , typically @xmath157 in our experiments .     and",
    "mpc , where each plot correspond to different shell radii . in each plot",
    "the following mpc values were used @xmath158 , @xmath155 , @xmath148 , @xmath156 .",
    "( bottom ) corresponding required patterns in the case of the stnv virus , using mpc values shown in figure [ fig : theoreticalenergydistribution].,scaledwidth=49.0% ]      in the sequel , we investigate the behavior of the algorithm in three typical cases of shell intensity reconstructions : inner , middle and outer shell cases . the simulations presented here have been performed using 500 diffraction patterns for the inner shell case and 1000 diffraction patterns for the middle and outer shell cases .",
    "we make use of the adaptive shell emc algorithm presented earlier .",
    "this algorithm provides an adaptive reconstruction method based on the spherical harmonic decomposition of the shell intensity up to a maximum bandlimit @xmath129 .",
    "the inner shell case is represented in figure [ fig : reconstructioninner ] . from figure",
    "[ fig : theoreticalenergydistribution ] , the expected theoretical bandlimit is @xmath159 .",
    "one can notice that the likelihood improvements become rapidly very small , and that the number of iterations for each bandlimit @xmath54 is given by the minimum number of iterations imposed ( in our case 4 ) .",
    "this behavior is easily seen from the low - bandlimit distribution of the inner shell . as seen in the reconstruction provided ,",
    "the main features of the shell intensity are already reconstructed at @xmath109 , as expected .",
    "the middle shell case is represented in figure [ fig : reconstructionmid ] .",
    "again , using figure [ fig : theoreticalenergydistribution ] , we see that the expected theoretical bandlimit is now @xmath160 .",
    "the likelihood is improving over the different bandlimits , tending to smaller increments as the bandlimit increases .",
    "the reconstructions provided shows how the accumulation of spherical harmonic coefficients of higher degree improves the accuracy of the reconstruction .",
    "one can note that low - bandlimit reconstructions exhibit negative values ( up to @xmath161 , included ) ; therefore the negative values are thresholded to some small constant ( here @xmath162 ) .",
    "this stems from the fact that truncation of a spherical harmonic expansion of the non - negative function does not preserve the non - negativity of the function .",
    "finally , the outer shell case is represented in figure [ fig : reconstructionouter ] . in this case , the theoretical bandlimit is @xmath163 , as seen in figure [ fig : theoreticalenergydistribution ] . here , the likelihood tends to improve constantly as the bandlimit increases before stabilizing from @xmath164 .",
    "reconstructions provided show the frequency - like improvement as the bandlimit @xmath54 increases .",
    "truncated theoretical intensities for the respective @xmath54 values are also provided .",
    "however , one can notice the difference between the theoretical and reconstructed intensities .",
    "the reasons are twofold : first when estimating low-@xmath54 intensity functions , there is aliasing of power of higher degree coefficients ( @xmath165 ) , resulting in an higher overall energy in the reconstruction than in the truncated theoretical intensity .",
    "this is well shown by results in the cases @xmath166 and @xmath167 .",
    "the second results from an insufficient number of diffraction patterns , since for @xmath168 the reconstruction barely improves , whereas the truncated theoretical intensity continues to converge to the theoretical intensity .                      * 3c + & truncated & theoretical + @xmath109 & 0.152 & 0.171 + @xmath169 & 0.143 & 0.148 + @xmath161 & 0.0979 & 0.0998",
    "+    the shell - by - shell approach offers an efficient and faster method to distribute computation of the reconstructions .",
    "however , by considering the shells independently the radial information is lost .",
    "this radial information has to be retrieved during an alignment process , as described in section [ section : shellalignement ] .    using 1000 diffraction patterns , we reconstructed each shell intensity independently up to bandlimit @xmath161 and maximum frequency @xmath170 @xmath146 , for a reciprocal space spacing @xmath171 @xmath146 between the shells .",
    "the shells were then realigned using the above mentioned correlation method .",
    "results are presented in figure [ figure : fullreconstruction ] .    to evaluate numerically the performance of the method",
    ", we introduce an error metric based on the well - know @xmath172-factor , which is defined such that @xmath173 where @xmath174 denotes the reconstructed intensity , and @xmath175 is the theoretical intensity . here",
    "@xmath102 denotes the 3d - spherical grid points . to illustrate the reconstruction performances with the bandlimit @xmath54 ,",
    "we have computed the @xmath172-factor for @xmath176 reconstructions .",
    "we distinguished two cases , one where the theoretical intensity is truncated up to degree @xmath54 , and the other where the full theoretical intensity is considered .",
    "as shown by the results in [ table : rfactors ] , the @xmath172-factor decreases as @xmath54 increases , meaning that the reconstructed intensity function is improved over @xmath54 .",
    "also one notices that the @xmath172-factors for the truncated theoretical intensity is smaller than for the full theoretical intensity , which is consistent with the fact that the full intensity function is more _ complex _ than the truncated one .",
    "finally , one can note that different sources of estimation error arise in the shell - by - shell approach .",
    "one is related to the shell intensity estimation problem , where the finite number of diffraction patterns limits the actual accuracy of the reconstruction .",
    "the second one is due to the radial decoupling between the shells , which leads to an realignment error .",
    "the latter can be minimized by either increasing the size of the grid on which the @xmath177 correlation is performed , or either by using refinment methods such as in @xcite . as a consequence",
    ", the algorithm presented here may not be as accurate as the original emc algorithm in the case of low snr datasets .",
    "it is actually expected that the proposed approach is a compromise improved computational performance of a shell - by - shell approach and noise tolerance .",
    "here we have shown that a spherical harmonic basis is a convenient way to design an incremental , parallelizable approach to the reconstruction of 3d intensity functions from 2d xfel diffraction patterns .",
    "the proposed shell - by - shell algorithm allows control over radial and angular resolution , which can be gradually increased during the reconstruction .",
    "as a shell - by - shell approach is intrinsically parallelizable , it is potentially an efficient way to analyse the very large datasets expected in experiment . using numerical simulations ,",
    "we have studied how the number of patterns required for convergence depends on the signal and resolution .",
    "the spherical harmonic functions , or in short spherical harmonics , extend fourier analysis to the 2-sphere @xmath178 . formally , the spherical harmonic of degree @xmath50 and order @xmath179 is given by @xmath180 where @xmath181 is the associated legendre polynomial ( or generalized jacobi polynomial ) .",
    "for each integer degree @xmath182 corresponds @xmath183 orders @xmath179 , such that @xmath184 .",
    "the spherical harmonic functions form a complete orthonormal basis on the 2-sphere @xmath178 for square integrable functions . as a consequence any square - integrable complex - valued function @xmath185",
    ", @xmath186 can be decomposed onto spherical harmonics , @xmath187 where we have introduced the spherical harmonic coefficients @xmath188 , which are given by projection onto the respective spherical harmonic @xmath189 via the canonical inner product on @xmath190 , @xmath191 these coefficients are complex - valued , and the properties of the function @xmath192 ( real - valued , symmetries ) are encoded in the coefficients . as in classical fourier analysis , spherical harmonics exhibit parseval relation , that is the energy of @xmath192 is preserved in the spherical harmonic domain , @xmath193 it is often convenient to introduce a related rotation - invariant quantity , known as the energy per degree @xmath194 , defined by @xmath195",
    ".    for numerical purposes the infinite series expansion in the spherical harmonic decomposition in ( [ eq : appendix_infinite_sh_decomposition ] ) is not desirable .",
    "rather , we consider bandlimited functions on the sphere .",
    "we say that a function @xmath192 is bandlimited at @xmath54 ( or equivalently @xmath54-bandlimited ) if for all @xmath196 , the spherical harmonic coefficients are identically zero @xmath197 .",
    "in the following , we consider @xmath54-bandlimited functions only .      the forward and inverse spherical harmonic transform ( sht )",
    "are given by @xmath198 the computation of the forward sht requires the evaluation of an integral over the 2-sphere @xmath178 for each coefficient @xmath188 .",
    "the evaluation of such integrals can be done by conveniently sampling the 2-sphere , _ i.e._distributing nodes on the surface on the sphere in order to obtain a quadrature formula . to this aim ,",
    "a certain number of sampling schemes have been already proposed @xcite , often motivated by the analysis of the cosmic microwave background . in this work ,",
    "we use the healpix sampling scheme @xcite , which has been designed for high performance , fast and accurate computation of spherical harmonics on the sphere .",
    "the sphere is tessellated into curvilinear equal - area pixels , where the pixel centers are distributed on lines of constant latitude allowing faster computation of spherical harmonic functions due to the separation of angular variables in the spherical harmonics .",
    "the healpix sampling scheme is hierarchical and provides different levels of resolution through a parameter @xmath151 .",
    "the number of pixels @xmath199 at resolution @xmath151 is given by @xmath200 where the parameter @xmath151 is a power of @xmath201 , due to the construction of the grid .",
    "although healpix grid do not exhibit an exact sampling scheme , a very accurate estimate of the spherical harmonics coefficients in ( [ eq : appendix_sh_forward ] ) is obtained if the following condition is fulfilled ; @xmath202 this last formula stands for an approximate sampling scheme on the grid .",
    "the special orthogonal group in three dimensions @xmath45 denotes the set of real matrices @xmath203 which satisfy @xmath204 where @xmath205 is the transpose of the matrix @xmath132 , @xmath206 its determinant and @xmath207 the @xmath208 identity matrix @xcite .",
    "it is commonly parametrized by euler angles , @xmath209 where @xmath210 and @xmath211 . in the @xmath212 convention",
    ", the matrix @xmath213 reads @xmath214 where @xmath215 denote rotations around canonical axes @xmath216 and @xmath217 , respectively .",
    "these rotations reads explicitely @xmath218      harmonic analysis on the rotation group @xmath45 is conveyed by the irreducible representations of @xmath45 .",
    "this is direct consequence of the peter - weyl theorem in the @xmath45 case @xcite .",
    "namely , any square - integrable function @xmath219 can be decomposed as @xmath220 where the @xmath221 functions are the wigner - d functions and @xmath222 are the fourier coefficients obtained following @xmath223 the wigner - d functions are conveniently expressed using the @xmath212-euler angles parametrization , that is @xmath224 where @xmath225 is a polynomial in @xmath226 and @xmath227 .",
    "let us consider a @xmath54-bandlimited function @xmath192 on the rotation group , that is for all @xmath196 , @xmath228 .",
    "it is possible to compute its fourier transform exactly using the following equiangular sampling @xmath229 where the indices @xmath230 .",
    "equation ( [ eq : fourier_transform_so3 ] ) then reads @xmath231 where we have introduced a single index @xmath232 .",
    "the weights @xmath233 satisfy @xmath234 and read @xmath235\\right ) \\sin \\beta_{j_2}.\\ ] ]      note that in the emc algorithm , the above sampling set is used to approximate the value of the integral of some function .",
    "this operation corresponds actually to computing the first fourier coefficient @xmath236 .",
    "it can be shown that using only half the samples in each angle in the sampling described above is sufficient ( aliasing in the higher order coefficients is therefore tolerated ) .",
    "this remark allows us to obtain @xmath237 samples instead of @xmath238 , however this was not implemented here since the oversampling of the rotation group allows a better approximation of the intermediate quantity @xmath239 .",
    "37ifxundefined [ 1 ] ifx#1 ifnum [ 1 ] # 1firstoftwo secondoftwo ifx [ 1 ] # 1firstoftwo secondoftwo `` `` # 1''''@noop [ 0]secondoftwosanitize@url [ 0 ]",
    " + 12$12  & 12#1212_12%12@startlink[1]@endlink[0]@bib@innerbibempty \\doibase    http://dx.doi.org/10.1063/1.4918726 [ * * ,   ( ) , http://dx.doi.org/10.1063/1.4918726 ] @noop * * ,   ( ) @noop * * ,   ( ) @noop * * ,   ( ) @noop * * ,   ( ) @noop * * ,   ( ) @noop * * ,   ( ) @noop ( ) \\doibase http://dx.doi.org/10.1016/j.jsb.2009.01.005 [ * * ,   ( ) ] @noop * * ,   ( ) @noop * * ,   ( ) link:\\doibase 10.1098/rstb.2013.0326 [ * *",
    "( ) , 10.1098/rstb.2013.0326 ] ,   @noop * * ,   ( ) @noop * * ,   ( ) @noop * * ,   ( ) @noop * * ,   ( ) link:\\doibase 10.1073/pnas.1513738112 [ * * ,   ( ) ] ,   @noop * * ,   ( ) @noop * * ,   ( ) \\doibase http://dx.doi.org/10.1016/j.jsb.2012.04.014 [ * * ,   ( ) ] @noop * * , ( ) @noop * * ,   ( ) @noop ( ) @noop * * ,   ( ) @noop _ _  ( , ) @noop * * ,   ( ) @noop * * ,   ( ) @noop * * ,   ( ) @noop * * ,   ( ) @noop * * , ( ) @noop * * ,   ( ) @noop ( ) @noop _ _  ( ,  ) @noop _ _ ,  vol ."
  ],
  "abstract_text": [
    "<S> in 3d single particle imaging with x - ray free - electron lasers , particle orientation is not recorded during measurement but is instead recovered as a necessary step in the reconstruction of a 3d image from the diffraction data . </S>",
    "<S> here we use harmonic analysis on the sphere to cleanly separate the angular and radial degrees of freedom of this problem , providing new opportunities to efficiently use data and computational resources . </S>",
    "<S> we develop the expansion - maximization - compression algorithm into a shell - by - shell approach and implement an angular bandwidth limit that can be gradually raised during the reconstruction . </S>",
    "<S> we study the minimum number of patterns and minimum rotation sampling required for a desired angular and radial resolution . </S>",
    "<S> these extensions provide new avenues to improve computational efficiency and speed of convergence , which are critically important considering the very large datasets expected from experiment . </S>"
  ]
}