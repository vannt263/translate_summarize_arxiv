{
  "article_text": [
    "the very fast inversion of the stokes vector ( vfisv ; * ? ? ? * ) is a spectral line inversion code tailored and optimized to invert the full disk spectro - polarimetric data of the _ helioseismic and magnetic imager _ ( hmi )",
    "instrument @xcite on board the _ solar dynamics observatory _ ( sdo ; * ? ? ?",
    "hmi is a filtergram - type instrument that observes ( with one camera ) the stokes _ i _ , _ q _ , _ u _ , and _ v _ at six wavelength positions across the fe",
    "i 6173   spectral line for the full disk of the sun with 16 million pixels ( 4096@xmath04096 ccd ) every 135 s. all of the data pipeline procedures , and the spectral line inversion code in particular , have limited allowable runtimes in order to keep pace with the data flow rate and prevent a processing backlog .    in the forward problem",
    ", vfisv solves the radiative transfer equation ( rte ) for polarized light using the milne - eddington ( me ) approximation to generate a set of stokes profiles from a given model atmosphere @xcite .",
    "the me approximation assumes that all the parameters describing the atmosphere are constant along the line of sight ( los ) except for the source function , which varies linearly with optical depth .",
    "in addition , the generation of polarized radiation is formulated in the classical zeeman effect regime .",
    "traditionally , me models applied to polarized rte problems use up to eleven free parameters to describe the atmosphere in which the stokes profiles are generated .",
    "there are five thermodynamical parameters : the line - to - continuum absorption ratio , @xmath1 , the doppler width , @xmath2 , the damping parameter of the voigt function , @xmath3 , and the components of the linearized source function , @xmath4 and @xmath5 , respectively .",
    "the magnetic field vector is described by three variables , _",
    "i.e. _ the magnetic field strength , @xmath6 , its inclination with respect to the los , @xmath7 , and its azimuth in the plane perpendicular to the line of sight , @xmath8 ( which is referenced to a column of pixels on the hmi ccd and increases counter - clockwise ) .",
    "there are also two kinematic parameters : the doppler velocity , @xmath9 , and the macroturbulent velocity , @xmath10 .",
    "the former characterizes the macroscopic plasma speed , while the latter is generally used to model a combination of unresolved plasma velocity fields and instrument smearing effects - it is usually expressed in the form of a convolution of the stokes profiles with a gaussian function of width @xmath10 .",
    "vfisv makes explicit use of the measured hmi transmission filter profiles in the spectral line synthesis and hence does not need to use @xmath10 to account for the instrumental broadening , while the other thermodynamic parameters compensate for the unresolved velocities and any residual instrumental broadening . a standard additional geometrical parameter known as",
    "the filling factor , @xmath11 , quantifies the fraction of light within any given pixel that originates from a magnetized atmosphere .",
    "the optimization scheme of vfisv , based on a levenberg - marquardt ( lm ) minimization algorithm ( see * ? ? ?",
    "* ) , takes a set of observed stokes profiles and finds the model parameters that best describe the atmosphere in which they were generated .",
    "it achieves this by performing a non - linear minimization of a merit function , @xmath12 , that measures the similarity between the observed and synthetic stokes profiles in a least squares sense .",
    "vfisv is just one module among many in the data pipeline for the hmi instrument .",
    "it operates on level1.5 data ( the ` hmi_s.720s ` data - series ) from the vector camera of hmi averaged every 720 s @xcite and its output is fed to a disambiguation code ( see * ? ? ?",
    "* ) that resolves the @xmath13 azimuth ambiguity of the magnetic field vector .",
    "the original version of vfisv @xcite was developed before the launch of sdo , which took place on 11 february 2010 .",
    "the spectral line inversion code has been further optimized since hmi data became available online .",
    "the purpose of this paper is to describe the changes implemented in the code and its output since the launch of sdo .    the current version of the code is referred to as ` fd10 ` , which began as a number ( in this case 10 ) assigned to identify tests of various versions of the code on the full - disk ( fd ) data .",
    "the data series produced by vfisv ` fd10 ` in the hmi pipeline processing is called ` hmi.me_720s_fd10 ` and is available through jsoc ( joint science operations center ) .",
    "its name reflects the fact that it is a product of the milne - eddington inversion ( me ) every 720 s with the ` fd10 ` version of the vfisv code .",
    "this manuscript is organized as follows .",
    "section [ section : chi2-space ] reports on the changes in the code that alter the @xmath12-space and hence determine which families of solutions are preferred over others , whilst section [ section : speed ] describes all of the procedures and alterations that have a direct impact on the speed performance of the inversion but not on the final solution found by the algorithm .",
    "section [ section : conclusions ] sums up the improvements in speed and performance of the code and some bug fixes are reported in the appendix .",
    "the changes implemented in the vfisv code since 2010 that are discussed in this section have an impact on the position of the minimum of the merit function , @xmath12 , that the algorithm is designed to minimize .",
    "changes in the depth of the minima or the steepness of the function along a given parameter have an effect on the path that the algorithm takes to find a solution and on the solution itself .",
    "subject to the limits set on parameters as described in section 2.3 and table 1 , the objective of the code is always to find the global minimum .",
    "the inversion of the hmi stokes vector is based on a non - linear least - squares minimization of a merit function , @xmath12 , that measures the difference between the observed and synthetic stokes profiles ( _ i.e. _ the goodness of the fit ) .",
    "this merit function is defined as :    @xmath14    where @xmath15 is the number of degrees of freedom ( _ i.e. _ the number of data points minus number of free parameters in the model ) , obs and syn refer to the observed and synthetic stokes profiles , respectively , and @xmath16 represents the model atmosphere .",
    "the index @xmath17 denotes the 4 stokes parameters and @xmath18 denotes the wavelength positions .",
    "@xmath19 represents the photon noise , which is a function of the intensity and the polarization state for the intensity and the polarization : @xmath20 and @xmath21 .",
    "this arises as a consequence of the chosen polarization modulation scheme , described in @xcite ] .",
    "this is needed because a different number of filtergrams go into constructing the intensity and the polarization images .",
    "however , the intrinsic wavelength dependence of @xmath19 is not accounted for in ` fd10 ` , rendering it a function of the continuum intensity and the stokes parameter only .",
    "the weights , @xmath22 , are a set of four values ( one for each stokes parameter ) , whose purpose is to emphasize or de - emphasize the relative importance of a given stokes parameter with respect to stokes _",
    "i _ in its contribution to @xmath12 .",
    "the amplitude of the stokes _ v _ signal is usually @xmath23 ( where @xmath24 is the continuum intensity ) while stokes _ q _ and _ u _ are typically one order of magnitude smaller . for this reason , the contribution of the _ q _ , _ u _ , and _",
    "v _ profiles to @xmath12 is often almost negligible compared to that of stokes _",
    "i_. however , stokes _",
    "q _ , _ u _ , and _",
    "v _ carry most of the information about the magnetic field . while stokes _",
    "i _ is only sensitive to the magnetic field strength in strong field regions , it is independent of azimuth and only slightly dependent on the inclination with respect to the los .",
    "there are a number of factors that can negatively impact the quality of the fit of the stokes vector in an inversion .",
    "flatfielding errors or inaccuracies in our knowledge of the instruments s filter profiles could lead to systematic `` missfits '' of the stokes parameters . in the case of hmi ,",
    "the latter is likely to have a larger effect than the former .",
    "however , a more important source of error is that the physical model , @xmath25 , used to describe the atmosphere is not sufficiently realistic .",
    "whatever the reason , an error in the fitting of the stokes profiles will scale with their amplitude in the expression of @xmath12 , and because stokes _",
    "i _ is orders of magnitude bigger than _ q _ , _ u _ , and _ v _ , its contribution will override all of the others .",
    "in other words , a slight missfit of stokes _",
    "i _ will always yield a non - zero difference of @xmath26 in the expression of @xmath12 . due to the much larger amplitude of stokes _",
    "i _ compared to stokes _ q _ , _ u _ , and _ v _",
    ", this term can easily mask equivalent differences for the polarization profiles ( _ i.e. _ @xmath27 , with @xmath28 ) . in",
    "order to de - emphasize stokes _",
    "i _ relative to _ q _ , _ u _ , and _ v _",
    ", we use a set of weights , determined empirically , that balances out the amplitude of the different stokes signals in the expression of @xmath12 .    because the expression of @xmath12 acknowledges dependence of the photon noise on the stokes parameter ( @xmath29 and @xmath30 ) , it is useful to define the concept of _ effective weights _ as @xmath31 .",
    "the weight scheme currently adopted for vfisv is @xmath32 [ 1,5,5,3.5 ] ( or , equivalently , @xmath33[1,3,3,2 ] ) for [ _ i , q , u , v _ ] , respectively ( note that these weights are then squared in equation ( [ eq : chi2 ] ) ) .",
    "the effect of the weights is to change the shape of the @xmath12 function and how steep the gradients along the different model parameters are .",
    "the sun hosts a range of magnetic activity , producing an array of polarization signatures in spectral lines .",
    "it is common to weight the stokes profiles with a custom set of weights for each pixel , in order to balance out the amplitudes of the four stokes profiles . in the original version of vfisv , @xcite proposed @xmath34 and @xmath35 , where the weight for stokes _",
    "i _ was lowered more or less depending on the value of the continuum intensity for the pixel under consideration . however , for the sake of homogeneity , vfisv ` fd10 ` has been altered so that the weighting scheme is the same for each and every pixel .",
    "other instrument teams have implemented inversion codes with constant values for @xmath22 so that @xmath12 values can be more easily compared .",
    "for instance , merlin ( the spectral line inversion code for the _ hinode_/sot - sp data pipeline , which is direct heritage of the _ advanced stokes polarimeter _ inversion code @xcite ) , operates with constant values @xmath36=",
    "@xmath37 $ ] ( or , equivalently , @xmath38= @xmath39 $ ] ) for [ _ i , q , u , v _ ]",
    "this ratio for the weighting of the stokes profiles is standard for high spectral resolution data from spectrograph instruments .",
    "however , the spectral smearing induced by the width of the hmi transmission filter profiles produces qualitatively different spectral line shapes and depths that call for custom @xmath22 values .",
    "figure [ fig : weights ] shows the differences in the magnetic field strength ( top ) and inclination with respect to the los ( bottom ) , retrieved from the inversion of an ar observed by hmi using two different sets of weights , namely @xmath40 $ ] in the left panels , and @xmath41 $ ] in the right panels .",
    "the merlin weighting scheme ( left panels ) does not work for the hmi data , and the inhomogeneity in the retrieved magnetic field parameters becomes apparent in strong field regions .",
    "the chosen set of weights for the hmi data , @xmath41 $ ] , proved to yield the smoothest solution inside ars .",
    "the hmi vector team adopted the policy of uniform weights throughout the solar disk .",
    "the final choice of weights was selected to optimize the inversion results in active regions ( ars ) with the aim of achieving smooth solutions for the magnetic field inside the umbrae and avoid discontinueties that would arise from changing weights . as a side effect ,",
    "the weighting scheme is far from optimal for quiet sun , where the adopted set of weights leads to artifacts in the solution for the inferred magnetic fields - it exacerbates the `` horizontal field effect '' in which the inversion of pixels that have near - to - pure noise polarization signals will deliver a seemingly strong purely transverse magnetic field vector @xcite .      inverting the hmi data",
    "is challenging due to a combination of moderate spectral resolution and very coarse spectral sampling .",
    "since there are only six wavelength sampling positions across the 6173   fe i spectral line , we have a relatively small number of observations with which to constrain a model with up to eleven free parameters .",
    "observing a single spectral line instead of a line pair ( such as the 6302 and 6301   fe i line pair ) means we further decrease our ability to constrain the physical system . using two spectral lines , as _ hinode_/sot - sp does ,",
    "takes advantage of the different line formation physics ( as evident in the land factor ) to distinguish between parameters otherwise redundant . in general , there are degeneracies in the thermodynamical parameters of the model when carrying out the inversion .",
    "one approach to improving the performance of vfisv was to reduce the number of free parameters and thus decrease its degrees of freedom .",
    "early tests ( @xcite , figure 14 ) showed that it was possible to fix the damping to a constant value and to ignore the macroturbulence without a loss in accuracy in the determination of the magnetic field vector due to the sparse sampling of the spectral line . setting the damping to a fixed value reduced the computing time as well as the degeneracy of the results .",
    "originally , the damping parameter was set to a constant value of @xmath42 , but further analysis showed that when solved for as a free parameter , the average value was closer to @xmath43 for the height of formation of the 6173   line .",
    "therefore , the damping parameter was set to a constant value of @xmath43 for the production of ` fd10 ` data . furthermore , the magnetic flux , @xmath44 , is well - constrained in the fit , but the individual values of @xmath11 and @xmath6 are not . for this reason ,",
    "the filling factor is set to a constant value of @xmath45 . a limitation introduced by assuming @xmath45 is that the returned magnetic field strength value is in fact an area - averaged quantity @xcite . in areas with unresolved magnetic structures such as plage , where averaged values of @xmath11 are approximately 0.15 @xcite",
    ", the ` fd10 ` field strength values will be significantly lower than the intrinsic field strength that would result from an inversion in which the filling factor were allowed to be less than one .",
    "in addition , the inclination angle will be biased towards the line of sight @xcite .",
    ".upper and lower limits on the model parameters in vfisv . [ cols=\"<,^,^,^,^ \" , ]     [ table : limits ]    occasionally , the iteration algorithm will find a location with a low @xmath12 value , but unphysical parameters . in order to constrain the parameter search to a reasonable set of values , vfisv sets lower and upper limits to each of the physical parameters of the me model atmosphere ( see table [ table : limits ] ) .",
    "these limits must be physically meaningful , at least in those cases where the me parameter has a direct correspondence with a real physical magnitude . for instance",
    ", the magnetic field strength is not expected to exceed the 5000 g ( gauss ) limit , nor can it be less than 0 g. even if an ar did harbor magnetic fields stronger than 5000 g , the dynamic range of the hmi instrument only reaches up to @xmath46 g when accounting for the large range of spacecraft velocity @xcite , so the 5000 gauss ( g ) upper threshold covers the measurable range .",
    "occasionally , when the observed stokes profiles originate in the midst of very high field strengths ( _ i.e. _ very dark places inside large sunspot umbrae ) they challenge the dynamic range of the instrument and the inversion algorithm is unable to converge to the solution , hitting the hard limit set at 5000 g.    the limits on the los velocity , @xmath9 , were determined taking into account typical plasma motions at the photosphere , the effects of solar rotation , the satellite s orbit around the earth ( which , alone , induces doppler shifts of up to @xmath47 kms@xmath48 ) and the earth s orbit around the sun .",
    "the inclination with respect to the los can only vary between 0 and 180@xmath49 , and although the azimuth spans the entire 0 - 360@xmath49 range , there is an inherent 180@xmath49 ambiguity when determining it from the stokes profiles alone .",
    "the terms of the source function should add up to the continuum intensity , thus , neither of them is allowed to exceed @xmath50 .",
    "there is a strong degeneracy between these two parameters , hence an arbitrary lower limit was set , just to prevent negative values .",
    "the constraints on the rest of the variables were empirically derived and are justifiable from a @xmath12 minimization perspective .      in the case of vfisv ` fd10 ` , @xmath12 represents a hypersurface of eight independent variables ( _ i.e. _ the eight free parameters of the model atmosphere )",
    ". in reality , due to limitations of the model and the data , these parameters are not all independent .",
    "some degree of degeneracy exists among pairs and even combinations of several of them .",
    "this typically causes the @xmath12 function to host narrow flat valleys where the lm algorithm can not find the solution .",
    "one clear example of this is the degeneracy between the magnetic filling factor and the field strength in the weak field regime , _",
    "i.e. _ , the stokes profiles caused by a relatively - strong field with a small filling factor and those caused by a weak field with a large filling factor , are indistinguishable ( see , for instance * ? ? ?",
    "* ) . in the ` fd10 ` version of the hmi pipeline inversion code the filling factor",
    "is set to a fixed value of 1 , as described in section [ section : freeparams ] .",
    "another example of degeneracy between parameters is described in section [ sec : var_change ] .",
    "a related problem is the presence of multiple minima in the @xmath12 function . when there is a tendency for @xmath12 to host two or more minima of similar depth in different parts of the parameter space , the algorithm will lead to each of these solutions with a certain degree of probability .",
    "extensive tests of the inversion code on hmi data revealed a degree of degeneracy between @xmath1 and @xmath6 .",
    "this particular degeneracy presented itself as a consistent double minima in the @xmath12 function , with a bi - modal distribution of @xmath1 values .",
    "there would typically be two solutions with magnetic field strengths that differed by 100 - 300 g , one associated with a small value of @xmath1 and another one associated with a large value .",
    "there is no physical reason to expect a bimodal distribution of @xmath1 values .",
    "the degeneracy between _ b _ and @xmath1 is largely a consequence of the limited spectral resolution of the hmi data .",
    "milne - eddington inversion results of _ hinode_/sot - sp data ( which have a spectral sampling of @xmath51 m  per pixel ) largely favor lower values of @xmath1 .",
    "for this reason , high @xmath1 values were deemed unphysical , and an empirically determined regularization term was added to @xmath12 in order to get rid of them :    @xmath52    where @xmath53 and @xmath54 .",
    "this term penalizes high values of @xmath1 in the merit function and reduces the number of pixels that are susceptible to a double minima behavior .",
    "figure [ regularization ] shows the effects that different values of @xmath55 have on the histogram of @xmath1 .",
    "the solid line corresponds to the case with no regularization term in @xmath12 , in which case a bi - modal distribution of @xmath1 becomes apparent ( the arrow points to the secondary hump in the histogram , for @xmath56 ) .",
    "the typical distribution of @xmath1 values for vfisv ` fd10 ` is shown by the dashed line . with the constraint imposed by the regularization term ,",
    "the secondary hump disappears , and the inversion favors lower values of @xmath1 .",
    "this section reports on modifications of the vfisv code aimed at speeding up the inversion without altering the shape of the merit function .",
    "  from the center of the hmi spectral line .",
    "the vertical dashed lines delimit the range in which the forward modeling of the spectral line is calculated explicitly in the inversion code . ]",
    "figure [ fig : hmi_filters ] shows the six hmi transmission filters as a function of wavelength ( @xmath57 corresponding to the central wavelength of the fe i 6173   line ) . each filter profile is characterized by a distinctive primary lobe and a number of smaller side lobes throughout the wavelength domain .    in its forward modeling module",
    ", vfisv synthesizes the stokes profiles of the fe i 6173   spectral line with a relatively high spectral resolution .",
    "it then integrates in wavelength ( see equation ( 3 ) in * ? ? ?",
    "* ) the products of the spectral line with the six hmi filters to generate hmi - like stokes profiles .",
    "the result of this process , schematically shown in figure [ fig : hmi_sampling ] , is a set of synthetic filtered spectral profiles that are comparable to the data .",
    "the wavelength range and sampling used to synthesize the hmi spectral line and the filter profiles are customizable parameters in vfisv .",
    "the larger the range and finer the sampling , the more accurate the modeling of the spectral line will be . when synthesizing the fe i spectral line and applying the transmission profiles , it is necessary to account for the secondary lobes of the filters .",
    "not doing so will lead to an underestimate , of up to 7% , of the amount of light that passes through the filters ( see * ? ? ? * for details on the calibration procedure for the hmi transmission profiles ) .",
    "hence , it is important to extend the calculation as far into the wings of the line as practical .",
    "however , the wider the spectral range , the larger the number of wavelength points in the spectral line synthesis calculation .",
    "this becomes rather computationally expensive .",
    "it is possible to reduce the number of points by lowering the spectral sampling of the synthesis , but this can only be done in detriment of the results .",
    "a compromise has to be reached between increasing the spectral range and reducing the sampling .",
    "an alternative approach is to compute the contribution of the filter profiles far out in the continuum without doing the forward modeling of the spectral line in this region and without compromising the wavelength sampling .",
    "figure [ fig : hmi_filters ] shows the hmi transmission profiles .",
    "the dashed lines represent the lower and upper wavelength boundaries within which the intensity profile of the hmi spectral line is always contained ( in the absence of zeeman splitting ) , when accounting for the doppler shifts induced by the dynamic range of the satellite , the solar rotation , and typical photospheric motions3.5kms@xmath48 line - of - sight velocity between the sun and spacecraft , @xmath582kms@xmath48 of solar rotation and @xmath581.5kms@xmath48 of photospheric plasma motions , the possible induced doppler shift can amount up to @xmath580.144  . under typical photospheric conditions ,",
    "the spectral line is less than 1  wide ( _ i.e. _ , less than 0.5  at each side of the position of the core ) , so the entire profile will always be contained in a @xmath59   range around the central wavelength , in the absence of a magnetic field that would induce a zeeman splitting . ] . in ` fd10 ` , vfisv does the forward modeling only in this _ inner _ range ( _ i.e. _ the spectral line is explicitly synthesized and the filter profiles are directly applied ) . in the _ outer _ range that goes farther into the wings the contribution of each filter profile is merely integrated , multiplied by the continuum intensity derived from the inversion and added to the synthetic stokes _",
    "( this does not affect stokes _ q _ , _ u _ , and _ v _ because the continuum polarization is negligible ) .",
    "this is a reasonable approach when we work under the assumption that there is no spectral feature in the _",
    "outer _ range .",
    "this strategy allows us to account for the contribution of the secondary and tertiary lobes of the instrument s transmission profiles without having to do the explicit calculation of the spectral line in this outer range .",
    "a series of tests revealed that the extended spectral range should at least cover @xmath60   from the line core , while the explicit calculation only needs to be carried out in the @xmath61   range .",
    "figure [ fig : filter_hacking1 ] shows the magnetic field retrieved from the inversion of an ar using the explicit forward modeling in the full @xmath60  spectral range . a comparison between this and the results of an inversion using only the _ inner _",
    "@xmath61   range , exposes the problems derived from not accounting for a large enough wavelength range in the synthesis of the spectral line ( left panel of figure [ fig : filter_hacking2 ] ) . here",
    ", the difference between the retrieved magnetic fields from both inversions is shown in the form of a scatter plot . inside the sunspot ( _ i.e. _ for large fields ) , the relative difference in the magnetic field strengths amounts as much as 5% .",
    "it is clear that the full wavelength range has to be considered in the calculation for the sake of accuracy .",
    "the right panel of figure [ fig : filter_hacking2 ] shows the difference in the inferred magnetic field strengths between the case of the explicit full range calculation and the hybrid approach described above ( in which the explicit calculation is done in the _ inner _",
    "@xmath61   range , and the remaining contribution of the spectrum is calculated implicitly ) . in this case , the number of pixels for which the difference in retrieved magnetic fields is large has been significantly reduced .",
    "since this hybrid approach allows us to limit the explicit calculation to a third of the total necessary spectral range , this technique results in a speed up of a full disk inversion by a factor of @xmath62 .      in exploring the details of the evolution of @xmath12 during the inversion of selected pixels using the original vfisv code",
    ", it became apparent that the path to convergence was not always the fastest or the most efficient one .",
    "this stemmed , partly , from the degeneracy among the physical parameters in the model atmosphere .",
    "for instance , there is a strong coupling between the terms of the source function , @xmath4 and @xmath5 .",
    "while the two parameters are difficult to determine individually , their sum is tightly constrained by the continuum intensity .    while this is not , in general , a major problem for an algorithm using the full hessian , we nonetheless chose to fit for @xmath4 and @xmath63 , in order to make the inversion more well behaved .",
    "when looking at the shape of the @xmath12 surface close to convergence as a function of different pairs of variables , the degeneracy problem becomes obvious .",
    "the left panel of figure [ fig : change_variable ] shows the logarithm of the @xmath12 surface as a function of @xmath1 on the _ x_-axis and the doppler width , @xmath2 , on the _ y_-axis .",
    "the contours show a narrow _ curved valley _ of minimum @xmath12 values , along which different combinations of the two parameters result in a very similar goodness of the fit .",
    "such a curved valley tends to lead to very poor performance of the lm algorithm .",
    "implementing a change of variable , that makes the contours of the @xmath12 surface closer to elliptical ( see right panel of the same figure ) , leads to a @xmath12 surface that is better approximated by a quadratic form in the parameters ( that is , has a larger range of validity of a taylor expansion using the first and second partial derivatives ) and , in turn , to a much improved convergence of the the lm algorithm",
    ". two changes of variable were implemented :    * @xmath4 and @xmath64 and @xmath65 * @xmath1 and @xmath66 and @xmath2    the variable changes are computed just before the matrix inversion and undone right after obtaining the improved model parameters ( see a schematic chart of the lm algorithm in @xcite ) .",
    "this means that the forward modeling and the definition of @xmath12 remain unchanged , and so does the physical model of the atmosphere . by definition",
    ", these variable changes do not alter the position of the minimum , expressed in the original variables , and so the position of the global minimum is unchanged .",
    "however , its path through the parameter space becomes more efficient after the variable change , which results in fewer iterations before convergence and hence a speed up of the inversion . the subsequent increase in speed achieved by the two variable changes described above results in a @xmath67 reduction in computing time for a full disk map in the hmi pipeline .      as part of the effort to speed up the inversions ,",
    "the iteration algorithm of vfisv was significantly improved .",
    "standard lm techniques are good at finding local minima in the minimization problem .",
    "however , they lack the capability to search the entire parameter space in pursuit of a global minimum .",
    "the approach that was followed for the ` fd10 ` version of the hmi pipeline inversion has two levels of operation .",
    "the lower level takes an initial guess for the parameters and uses a lm algorithm to find a local minimum .",
    "the upper level tries to determine if the best solution found so far is the global minimum , and if not , a new initial guess is provided and the module calls the lower level again to try to find the global minimum ; we call this a _ restart_.    several upper - level algorithms were tested against one another . in order to assess their performance ,",
    "the quality of the fits obtained needed to be evaluated and compared to the time spent converging to the solution .",
    "the selected time criterion was the average number of iterations per pixel .",
    "while this is not exactly proportional to the running time , it is a good proxy .",
    "the criterion chosen to assess the quality of fits was the fraction of pixels for which the fitted @xmath12 was within a given tolerance of that at the global minimum .    in order to evaluate the algorithms ,",
    "a number of test datasets were selecthed that varied in complexity of the magnetic field and covered a range of line - of - sight spacecraft - to - sun velocities .",
    "unfortunately , the solution of the inversion problem ( _ i.e. _ the global minimum ) for real observations of the sun is unknown .",
    "therefore , the performance of the different algorithms had to be tested against some approximation to the solution .    in order to find the best estimate of the global minimum , a fixed version of vfisv",
    "was used to invert the test dataset one hundred times , each time with a different initial guess that was chosen at random spanning the entire parameter space . for each inversion",
    "the code was forced to do two thousand iterations , allowing for restarts whenever the algorithm converged to a solution or failed to converge at all .",
    "for each pixel , the solution with the lowest value of @xmath12 among the one hundred inversions was selected to represent the global minimum .",
    "a composite set of inversion results was put together using the best solution for each pixel in the field of view .",
    "this was labelled as the _ gold standard _ ( gs ) and has an associated @xmath68 map .",
    "the lower level of the algorithm is a fairly standard lm algorithm .",
    "the control parameter @xmath18 is lowered by a factor of 5 if @xmath12 decreases by more than a trivial amount ( 0.0001 ) , with a lower bound for the value of 0.0001 , and otherwise increased by an amount that depends on @xmath18 ( 10 if @xmath69 and 20 otherwise ) . at each step , the parameter limits are enforced , as are limits on the changes in some variables .",
    "it should also be noted that the model derivatives are only calculated when @xmath12 improves @xcite , thereby saving a considerable time over always calculating them .",
    "the iteration stops if @xmath18 exceeds a certain value ( 100 ) or if the total number of iterations exceeds an upper bound ( 200 ) .    at the end of each execution of the lower layer ,",
    "the upper layer determines if a new initial guess for the model parameters should be tried , in which case , it generates one .",
    "a number of variations of the upper - level algorithm were thoroughly tested .",
    "they mostly differed in the way the new initial guess was chosen .",
    "the criteria for when a new guess and a subsequent restart is implemented were determined in a semi - empirical manner and were tailored to the ` hmi.s_720s ` data series .",
    "what follows is a description of the condition clauses for the upper - level algorithm implemented in ` fd10 ` in order to find a global minimum in the inversion problem .",
    "this particular set of conditions was chosen because it showed the best compromise between speed and convergence to the _ gold standard_.    at the end of the first execution of the lower level code , the algorithm will likely exit the iteration loop and the inversion will spit out a solution . however , for the pixels that meet one of the following criteria , one single restart will be enforced :    * the field is low ( @xmath70 g ) or high ( @xmath71 g ) . *",
    "the @xmath12 is larger than 20 .",
    "* @xmath72 for @xmath73 g .",
    "* points with large magnetic field inclinations or low values of the doppler width ( @xmath74 ) .    at the end of the second execution , an upper - level decision to implement further restarts will be made based on the following criteria :    * low ( @xmath75 g ) or high ( @xmath76 g ) fields , where @xmath77 is the number of restarts already performed .",
    "* inclination within 30 degrees of vertical .",
    "* very low field ( @xmath78 g ) points with @xmath79 and @xmath80 .",
    "for the first and all subsequent odd restarts , a tailored guess is made as to a good new starting point in the parameter space .",
    "for the even numbered restarts , a random model perturbation is used . in most cases , the new initial guess will converge to the same solution as an earlier one .",
    "an additional control parameter is flagged when , after the first restart , the algorithm shows signs of heading inevitably to the same solution again , in which case it forces the exit of the iteration loop to avoid unnecessary iterations .",
    "the algorithm will never allow the total number of iterations ( _ i.e. _ the sum of the iterations performed in all the restarts ) exceed the maximum allowed ( 200 ) .",
    "the combination of the lm with this upper - level algorithm ensures that the global minimum is almost always found without using an excessive amount of computing time .",
    "the statistics for vfisv ` fd10 ` code are as follows :    * of all the pixels , @xmath81 have not converged to within 0.1 of the @xmath68 value and @xmath82 have not converged to within 0.01 of the @xmath68 .",
    "* of the pixels with @xmath83 300 g , @xmath84 have not converged to within 0.1 and @xmath85 not to within 0.01 of @xmath68 . *",
    "the rms error in @xmath6 is 3.00 g. * the average number of iterations is 28.22 .",
    "the first initial guess of the atmospheric parameters for the inversion algorithm is mostly tailored to each pixel , although some of the parameters are given the same initial value for the entire field of view .",
    "this is true for the magnetic field strength , which is always initialized at 150 g , and its los inclination , which is started at 90@xmath49 .",
    "however , other parameters are initialized differently for each individual pixel .",
    "a weak field approximation is used to calculate the initial value for the azimuth ( @xmath86 ) , and a rough guess , based on the wavelength shift of the spectral line , is estimated for the velocity . the source function and its gradient",
    "are constrained to add up to the continuum intensity , and an estimate of the doppler width ( @xmath2 ) is obtained from the shape of the spectral line . however , these first guesses are not crucial because the restart system described above erases any memory of the initialization , especially for the pixels with a relatively large magnetic signal , for which restarts are enforced until the maximum allowed number of iterations is reached .",
    "some of the changes to the vfisv code reported in this paper were aimed at speeding up the code while having little or no impact on the accuracy of the solution found by the inversion algorithm .",
    "these include measures that prevent the algorithm from performing unnecessary calculations and from following inefficient paths through the parameter space in pursuit of the solution .",
    "certain modifications tried to palliate other performance issues that arise from the degeneracy among the atmospheric model parameters ( which lead to multiple minima in the @xmath12 ) from the sometimes inadequate simplicity of the model chosen to represent the complexity of the real sun , and from the data themselves , which have limited spectral and spatial resolution , are affected by photon noise , _",
    "etc_.    throughout this manuscript we organized the changes into two classes : those that altered the shape of the @xmath12 function ( and hence the model atmosphere ) , and those that did not .",
    "however , they are not all independent of one another , and they operate together to improve the overall efficiency and performance of vfisv in the hmi data pipeline .    * a set of weights for the stokes profiles that provided the smoothest possible solution inside active regions was chosen . this renders less than optimal results in weakly magnetized areas where the polarization profiles are heavily dominated by the noise .",
    "because of the smearing effect of the transmission filter profiles of the hmi instrument , the standard weighting system used to invert datasets from spectrograph type of instruments ( such as asp or _ hinode_/sot - sp ) , does not work with hmi data .",
    "a custom set of weights was chosen and applied uniformly over the entire fov . * a regularization term that penalizes high values of @xmath1",
    "was added to the merit function .",
    "this mitigates the double minima problem in the parameter space and helps prevent the code from converging to unphysical solutions . * limits on the range of each atmospheric parameter",
    "were set to prevent the algorithm from probing extreme unphysical values . * a diagnostic procedure that identifies possibly problematic pixels enforces a series of inversion restarts that attempt to localize the global minimum .",
    "coupled to this , a discriminating convergence criteria ensures a very accurate solution while keeping the average number of iterations relatively low ( @xmath87 ) . *",
    "a major speed improvement ( about 64% reduction in computing time ) was achieved , without compromising the accuracy of the solution , by considering a spectral range of @xmath60   around the central wavelength but limiting the explicit forward modeling calculation to an inner @xmath61   range .",
    "this hybrid approach accounts for the light that passes through the secondary lobes of the hmi transmission filter profiles without doing the detailed spectral line calculation far out into the continuum .",
    "* an additional 10% increase in speed was obtained after performing two changes of variable on the atmospheric model parameters before solving the linear system of equations at each iterative step .",
    "this modification prevented the code from performing useless iterations in the parameter space by helping it find a more direct route to the solution .",
    "* coding errors were identified and corrected . some of these are reported in the appendix .",
    "much of the reported effort was supported by stanford university nasa grant nas5 - 02139 for sdo / hmi commissioning and pipeline code implementation ; kdl and gb also acknowledge po # nng12pp28d / c # gs-23f-0197p from nasa / goddard space flight center .",
    "the national center for atmospheric research is sponsored by the national science foundation .",
    "[ section : bugs ]    this section reports some coding mistakes that have been spotted in vfisv since its original release and that have been fixed in the ` fd10 ` hmi data pipeline version .",
    "this version can be found through the jsoc ( joint science operations center ) cvs tree at stanford .",
    "the voigt function is a computationally intensive part of the forward modeling of the spectral line . in order to speed up the calculation ,",
    "the actual voigt function is only computed for small parts of the spectral range , close to the line core and far into the wings . in the intermediate wavelength regime",
    "the voigt function is approximated by a taylor expansion using a lookup table for the taylor coefficients as a function of the central wavelength of the voigt profile .",
    "two bugs were found in the coding of the voigt function of the spectral line .",
    "an error in the wavelength indexing for the lookup table ( inside the ` voigt _ ` ` taylor.f90 ` routine ) resulted in sudden unphysical changes in the integrated area of the voigt profile as a function of the central wavelength .",
    "this led to a periodic roughness pattern of the @xmath12-surface that resulted in the appearance of multiple local minima along the magnetic field direction when the algorithm was approaching the solution . instead of being evenly spread ( due to the effect of the photon noise )",
    ", the solutions would preferentially fall along ridges with an 11 gauss periodicity in the magnetic field .",
    "a second coding mishap in the calculation of the voigt profile was a missing factor of 2 in the computation of the imaginary part of the taylor expansion of the voigt function , which affected the magneto - optical effects in strong field regions .",
    "this error is heritage of the same missing factor of 2 in a fortran routine ( ` voigt.f ` , originally developed by harvey and nordlund ) , that calculates the voigt function .",
    "this routine has been used in a number of spectral line inversion codes for the calculation of the line profiles .",
    "albeit small , the effect on the synthetic stokes profiles lead to inhomogeneous patterns in the inverted magnetic fields inside sunspot umbrae .",
    "the photon noise in the observed stokes profiles propagates to the atmospheric model inferred by the inversion .",
    "when the algorithm has converged and the optimal model has been found , vfisv computes the formal uncertainties corresponding to each physical parameter .",
    "the variance associated with the retrieved model parameter @xmath88 is taken to be proportional to the corresponding diagonal element of the inverse of the curvature matrix @xmath89 ( see , for instance , * ? ? ?",
    "* ) :          the non - diagonal elements of the inverse of the curvature matrix , @xmath92 , are proportional to the covariances , @xmath93 , between each pair , @xmath88 and @xmath94 .",
    "these elements give a sense of the degeneracy between any two given parameters of the model atmosphere .",
    "an index switch inside the nested loop that calculates the elements of the covariance matrix ( subroutine ` get_err ` of the ` inv_utils.f90 ` module ) led to huge uncertainty values that were many orders of magnitude too large . after correcting for this problem ,",
    "the magnitudes of these formal uncertainties lie within reasonable values and compare to those obtained through a monte carlo experiment ."
  ],
  "abstract_text": [
    "<S> the very fast inversion of the stokes vector ( vfisv ) is a milne - eddington spectral line inversion code used to determine the magnetic and thermodynamic parameters of the solar photosphere from observations of the stokes vector in the 6173   fe i line by the _ helioseismic and magnetic imager _ ( hmi ) onboard the _ solar dynamics observatory _ ( sdo ) . </S>",
    "<S> we report on the modifications made to the original vfisv inversion code in order to optimize its operation within the hmi data pipeline and provide the smoothest solution in active regions . </S>",
    "<S> the changes either sped up the computation or reduced the frequency with which the algorithm failed to converge to a satisfactory solution . additionally , coding bugs which were detected and fixed in the original vfisv release , are reported here . </S>"
  ]
}