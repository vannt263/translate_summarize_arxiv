{
  "article_text": [
    "procedures for the generation of cosmological @xmath1-body simulations have become increasingly sophisticated in recent years .",
    "we have now developed an algorithm for assessing in great detail , and with considerable speed and accuracy , the effects of the large - scale mass distributions within these simulations on the passage of light from sources at great distances .",
    "there are numerous methods for studying such ` weak ' gravitational lensing , the most common being ` ray - tracing , ' in which individual light rays are traced backwards from the observer , and the deflections occuring at each lens - plane are calculated .",
    "the lens - planes are two - dimensional projections of the mass content within a small redshift interval , usually equal to the simulation box depth .",
    "schneider and weiss ( 1988b ) have used this method by shooting , typically , @xmath2 rays through the lens - planes to strike the source plane within a chosen square region , called the detection field .",
    "each plane is divided into @xmath3 pixels , typically , and the particles ( stars in this case ) are categorised as near or far for computational purposes .",
    "the deflection by stars further away than about 8 pixel dimensions from the centre of each pixel is approximated in a taylor series , whilst the deflections due to the nearby stars are computed individually .",
    "the rays are shot through a cylinder with a radius such that the rays meet the source plane in or near the detection field .",
    "they claim that the resulting amplification factors are hardly affected by edge effects caused by strong lensing of rays outside the shooting cylinder , but which might strike the detection field .",
    "the amplification factors are determined directly from the mapping of the rays onto the pixels of the detection field .",
    "jaroszyski et al .",
    "( 1990 ) evaluate the matter column density in a matrix of pixels for each of the lens - planes , based on their simulation boxes . by making use of the periodicity in the particle distribution orthogonal to the line of sight , they are able to arrange for each ray traced to be centralised within planes of one full period in extent . in this way ,",
    "the deflections on each ray take account of all the matter within one complete period .",
    "they calculate , not deflection angles , but the two two - dimensional components of the shear , ( see section 5.3 ) , as ratios of the mean convergence of the beam . to do this , they assume that the matter in each of the @xmath4 pixels resides at the centre point of each pixel . to follow the shearing across subsequent planes they recursively generate the developing jacobian matrix for each ray , in accordance with the multiple lens - plane theory , ( see section 5.3 ) .",
    "wambsganss ( 1990 ) uses the ` ray - tracing ' method to study microlensing , wambsganss , cen and ostriker ( 1998 ) use it with cosmological @xmath1-body simulations , and wambsganss et al .",
    "( 1997 ) use the method for studying the dispersion in type ia supernov .",
    "they randomly orient each simulation box , and project the matter contained within each onto a plane divided into pixels .",
    "they choose the central @xmath5mpc @xmath6mpc region through which to shoot rays , ( @xmath7 is the hubble constant in units of 100  km  s@xmath8  mpc@xmath8 ) , but account for the deflections of the rays in terms of all the matter in the plane of @xmath9mpc @xmath10mpc . however , to speed up the computation , a hierarchical tree code in two dimensions is used to collect together those lenses ( pixels ) far away , whilst treating nearby lenses individually .",
    "the matter in each pixel , which measures @xmath11kpc @xmath12kpc , is assumed to be uniformly spread .",
    "the multiple lens - plane theory , ( see section 5.3 ) , is used for large numbers of rays to compute the mappings of images and sources , the distribution of magnifications , and statistics of angular separations of multiple images .",
    "marri and ferrara ( 1998 ) select a total of 50 planes , evenly spaced in redshift space , between redshifts of @xmath13 and @xmath14 .",
    "their two - dimensional matter distribution on each plane consists of point masses without softening , so that their approach produces very high magnifications ( greater than 20 ) for each of their chosen cosmologies , using the ` ray - tracing ' method .",
    "premadi , martel and matzner ( 1998 ) have used 5 different sets of initial conditions for each @xmath1-body cosmological simulation , so that the plane projections of each simulation box can be chosen randomly from any one of the 5 , and then randomly translated , using the periodic properties of each box . in this way they are able to avoid correlations in the large - scale structure between adjacent boxes",
    ". a considerable improvement to the ` ray - tracing ' method has then been made .",
    "they solve the two - dimensional poisson equation on a grid , and invert the equation using a two - dimensional fast fourier transform ( fft ) method , to obtain the first and second derivatives of the gravitational potential on each plane . from this data , cumulative deflections and the developing jacobian matrix",
    "can be obtained , which provides the data for determining overall magnifications .",
    "an alternative to the conventional form of ` ray - tracing ' was introduced by refsdal ( 1970 ) , who used the ` ray - bundle ' method .",
    "the principle here is to trace the passage of a discrete bundle of light rays as it passes through the deflection planes .",
    "the advantage of this method is that it provides a direct comparison between the shape and size of the bundle at the observer and at the source plane , so that the magnification , ellipticity and rotation can be determined straightforwardly .",
    "fluke , webster and mortlock ( 1998a , b ) use the ` ray - bundle ' method , and have found that bundles of 8 rays plus a central ray adequately represent a circular image which is projected backwards .",
    "they shoot large numbers of bundles through two - dimensional planes , as above , formed by projecting their simulation cubes , which have comoving sides of @xmath15mpc .",
    "the shooting area is limited to @xmath16 , and the deflection angles are calculated by considering the matter contained within a chosen radius , typically @xmath17mpc from the central ray .",
    "a novel approach to weak gravitational lensing has been used by holz and wald ( 1997 ) .",
    "they lay down a set of spheres between the observer and source , each containing an individual probability distribution of matter , in which a ` newtonianly perturbed ' robertson - walker metric is used .",
    "a scalar potential , related to the density perturbations , can then be evaluated , and this allows integration along straight lines through each sphere , to determine the angular deviations and shear .",
    "tomita ( 1998a ) evaluates the potential at some 3000 positions between the observer and a source at @xmath18 , by using the periodic properties of each simulation cube to position it such that each evaluation position is centrally placed in the appropriate cube . to trace the paths of the light rays",
    ", they solve the null - geodesic equations , and use an analytical expression to determine the average potential through the interval between each pair of evaluation positions .",
    "our motivation for the development of an algorithm to apply in three - dimensions has stemmed from concern with possible limitations in the two - dimensional planar approaches to weak gravitational lensing .",
    "we therefore considered the following .",
    "first , we wanted to investigate rigorously the conditions for equivalence of results obtained from three - dimensional realisations and two - dimensional planar projections .",
    "we show in appendix b , that the shear values at a point in the two - dimensional projection are equal to the integrated three - dimensional values along the line of sight through one period ( or cube dimension ) , in general , only if the distribution of mass is periodic along the line of sight , and the angular diameter distances through the depth of one period are assumed to be constant .",
    "second , we wanted a method which would unambiguously provide accurate values for the shear components , as if the contribution from all matter , effectively stretching to infinity , was included .",
    "errors may occur in other methods if the contribution from matter within only a finite radius of the evaluation position is counted .",
    "for example , whilst jaroszyski at al .",
    "( 1990 ) include the matter contained within a plane of one complete period , wambsganss ( 1990 ) , wambsganss et al .",
    "( 1997 ) and wambsganss et al .",
    "( 1998 ) introduce a slight bias , because rays near the edge of their shooting area are closer to the edge of the single period plane than rays near the centre of the shooting area .",
    "fluke et al .",
    "( 1998a , b ) typically consider a region of radius @xmath17mpc in simulations with a period of @xmath15mpc .",
    "we investigate how quickly the shear component values converge to their true values , as increasing volumes of matter are included surrounding the evaluation position , and we report our findings in section 4 .",
    "third , to achieve shear values consistent with those in a realistic universe , it is necessary to deal with the ` peculiar potential , ' @xmath19 , which is related to the full gravitational potential , @xmath20 , through the subtraction of a term depending upon the mean density .",
    "this approach , which we describe fully in appendix a , ensures that we deal only with light ray deflections arising from departures from homogeneity ; in a pure robertson - walker metric we would want no deflections .",
    "the approach is equivalent to requiring that the net total mass in the system be set to zero , so that for every mass there is a balancing uniform negative background mass .",
    "this net zero mass requirement is achieved very simply in systems of particles which are periodically distributed in all dimensions , and we are therefore able to accommodate it easily in our algorithm .",
    "fourth , we wanted to be able to apply our algorithm to cosmological simulations which were representative of the large - scale structure in the universe , rather than distributions of point masses . this has frequently been attempted by assuming each particle to be softened with the profile of an isothermal sphere .",
    "we wanted to improve on this by allowing the softening for each particle to reflect the environment in which it is located , so that large clusters and other dense structures dominate the light deflections , whilst the effects of isolated particles are minimised .",
    "this motivated us to consider the introduction of a variable softening facility to our algorithm .",
    "finally , a three - dimensional approach allows the use of the appropriate angular diameter distances at every single evaluation position within the three - dimensional realisation .",
    "the two - dimensional methods discussed above necessarily assume that all the lensing mass within a given plane is at the same angular diameter distance , because the overall depth of the lens is considered to be small compared with the observer - lens , observer - source , and source - lens angular diameter distances .",
    "however , the depth of a single simulation cube employed in weak lensing , ( in our case @xmath21 mpc ) , is not insignificant . by using the ` thin plane approximation , ' in which matter in a small redshift interval is projected onto a plane , we are able to show that errors may be introduced .",
    "it is not possible to quantify these errors in general , because they will vary from simulation to simulation , depending on the specific mass distributions .",
    "however , we show in section 4.2 that the scaling factors for the computed shear components can vary by as much as 9% through the depth of those simulation boxes contributing the most to the magnification .",
    "the considerations above finally led us to develop an efficient fast fourier transform ( fft ) programme , whose data output could be manipulated with the appropriate angular diameter distances at every evaluation point .",
    "the primary output of the programme is the matrix of second derivatives of the gravitational potential at each of the specified evaluation positions within a periodic three - dimensional distribution of smoothed particle masses .      in section 2",
    ", we describe the general principles employed in the standard particle - particle , particle - mesh ( p@xmath0 m ) algorithm , and then how it has been extended for the evaluation of the shear components .",
    "we explain the introduction of variable softening into the code , which allows each particle to be represented as a distributed mass .",
    "this variable softening smooths away the high frequency information in very high density clumps , thus avoiding strong scattering , and also allows particles in low density regions to be spread more widely to give more realistic density values .    in section 3 , we describe our testing procedures for the code .",
    "the first of these compares the computed shear components at a large number of points surrounding a single massive particle , with values derived from the ewald ( 1921 ) summation technique .",
    "the second test compares values of the normalised trace of the shear matrix with density values derived using an independent method , a smoothed particle hydrodynamics , sph , algorithm .",
    "section 4 emphasises two advantages of our new algorithm .",
    "first , we demonstrate the slow convergence of shear values to their true values , as increasingly large volumes of matter are included surrounding an evaluation position .",
    "this suggests the need , in general , to include the effects of matter well beyond a single period transverse to the line of sight .",
    "secondly , we show that , by considering all the matter in a cubic simulation to be at the same angular diameter distance , sizeable errors may be introduced to the absolute shear values , and to calculations of the magnification along a line of sight .",
    "section 5 describes the cosmological @xmath1-body simulations we are using for the application of the new algorithm , and explains our choice of the appropriate minimum value for the variable softening . the multiple lens - plane theory ( described by schneider , ehlers & falco , 1992 ) is summarised for the determination of magnification distributions along large numbers of lines of sight through the simulations .",
    "we then provide some preliminary results to show the efficacy of the method .",
    "these include ( a ) plots of the magnification as it develops along a line of sight , ( b ) values for the shear and convergence in a given cosmological simulation , and ( c ) distributions of the magnification due to weak lensing for isolated simulation boxes .",
    "finally , we outline our proposed future work , which will link simulations together to provide a complete realisation from a distant source to an observer in the present epoch .",
    "this will enable us to compare the results from different cosmologies .",
    "section 6 summarises our conclusions about the algorithm and its applicability .    in appendix",
    "a , we describe how the peculiar potential relates to that in a universe with large - scale homogeneity .",
    "we show how use of the peculiar potential , which takes account of departures from homogeneity through the subtraction of a term including the mean density , allows the shear to be correctly computed .    in appendix b ,",
    "we investigate rigorously the equivalence between two - dimensional and three - dimensional periodic approaches , in the absence of discrete angular diameter distances within the realisations .",
    "the treatment details the conditions under which the two approaches may be considered to be equivalent .    in appendix c , we summarise the ewald ( 1921 ) summation method , which we have used to assess the accuracy of our new code .",
    "we describe the method in outline , and compare the treatment with the p@xmath0 m method .",
    "finally , we develop the equations for the summation method which we have used in the testing of the results from our new algorithm .",
    "in this section we describe the numerical method used for measuring the local 3-dimensional shear in simulation data .",
    "the technique is an extension of the standard 3 m  algorithm familiar from cosmological particle codes .",
    "we begin with a brief review of the 3 m  method and then describe how it has been extended for the shear calculation .",
    "the 3 m  algorithm was developed in the context of particle simulations of plasmas by hockney , eastwood and co - workers , ( see hockney & eastwood , 1988 , for a full description ) , as an efficient method for calculating the pairwise interactions of a large number of particles . in the cosmological context , with the method being used to calculate forces arising from a large number of self gravitating particles , the method has two important attractions .",
    "first , for a nearly uniform distribution of particles , the computational cost is of order @xmath22 where @xmath1 is the number of particles , rather than the normal @xmath23 scaling behaviour expected for a nave computation of the forces on @xmath1 particles from each of their @xmath24 neighbours .",
    "the second attractive feature for cosmology is that the method , in its standard form , has periodic boundary conditions , and thus lends itself naturally to the simulation of a small part of the universe with the remainder being approximated by periodic images of the fundamental volume .",
    "the key idea in the method is to decompose the pairwise interparticle force into a long - range and a short - range component which together sum to the required force . with a suitable choice of the decomposition",
    "we can ensure that the short - range force is compact ( that is , it is non - zero only within a finite radius , i.e. , the ` search radius ' ) and that the long - range component has a band - limited harmonic content such that it can be accurately represented by sampling with a regular grid of a convenient mesh size .",
    "the total force is then accumulated on particles by summing directly a contribution corresponding to the short - range component of the force from nearby particles within the search radius , together with the long - range component which is interpolated from a smoothly varying force derived from the regular mesh .    in practice ,",
    "the calculation of the short - range force ( from the direct particle - particle ( pp ) sum over near neighbours ) and the long - range force ( from the particle - mesh ( pm ) field calculation ) depend on each other only to the extent that the accumulated force from the two should sum to the required total force .",
    "the two calculations may be performed in either order : here we shall describe the pm calculation first .    the heart of the pm calculation is the solution of poisson s equation on a grid via a rapid elliptic solver ; the method used here is fast fourier transform ( fft ) convolution .",
    "a mesh - sampled density is obtained by smoothing the particle distribution onto a regular grid with an appropriate kernel .",
    "the properties of the kernel are chosen to filter the high frequencies present in the distribution so that the smoothed distribution may be adequately sampled by the mesh .",
    "the mesh potential is then obtained from the mesh density by fft convolution .",
    "an advantage of using an fft method is that it is possible to substantially reduce translational and directional errors in the mesh - computed quantities by judicious adjustment of the fourier components of the green s function . for the standard force calculation ,",
    "the components of the green s function are optimized such that the rms deviation of the computed force from the desired force is minimized .",
    "full details of these techniques may be found in hockney & eastwood  ( 1988 ) .",
    "a key feature of the method is that the fourier - transformed density field may be smoothed by using a high frequency filter .",
    "this suppresses aliasing and leads to a more accurate pairwise force ; that is one which has less positional and rotational dependence relative to the grid .",
    "derivatives of the potential may then be obtained at mesh - points using standard finite difference techniques .",
    "a 10 point differencing operator is used here to minimize directional errors in the computed differences , ( see couchman , thomas & pearce , 1995 ) .",
    "values of the potential and its derivatives at arbitrary points in the computational domain are then obtained by interpolation from the mesh values .",
    "( using the same kernel for interpolation as was used for particle smoothing ensures that particles do not experience self - forces in the standard 3 m  method . )    the accumulation of the pp component of the force on a particle from near neighbours is achieved by re - gridding the particles onto a mesh which has a cell size such that the side is equal to the radial distance at which the short - range force falls to zero .",
    "this mechanism enables the neighbours contributing to the short - range force to be found efficiently by searching over the cell in which the particle in question lies and its 26 neighbouring cells .",
    "a disadvantage of this technique is that as particle clustering develops in a simulation the average number of neighbours rises , causing the method to slow as the number of pp contributions which must be computed increases .",
    "a technique to overcome this deficiency in simulation codes has been developed , ( couchman , 1991 ) , but the problem will not be of concern in this paper where we shall be concerned only with limited clustering .",
    "the method leads to accurate interparticle forces with the force error ( arising from the mesh aliasing ) being controlled by the degree of high frequency filtering employed in the fourier convolution",
    ". a greater degree of attenuation of the high frequency components reduces the error but leads to a ` smoother ' mesh force .",
    "this requires that the direct - sum search be performed out to larger radii , which in turn requires a search over a greater number of particles leading to a slow - down in the execution of the code .",
    "the method may be described schematically in the following terms .",
    "suppose that the total pairwise potential required is @xmath25 , where @xmath26 is the radial distance from a particle .",
    "then we compute this as @xmath27 , where @xmath28 for @xmath29 , is the pp component and @xmath30 is the mesh part .",
    "the functional form of @xmath31 is coulombic on large scales ( neglecting for the moment the effect of the periodic images ) , with perhaps a softening at small scales to allow for the fact that each particle may represent a very large astrophysical mass , and to ameliorate certain numerical problems in the simulation code such as two - body scattering .",
    "the 3 m  method computes forces , or first derivatives of the potential , @xmath19 , at a point by splitting the contribution of the density distribution into two components as described above .",
    "the potential itself is also computed as a simulation diagnostic in many standard 3",
    "m  implementations using the same splitting technique . in principle , any other non - local function computed from the field may be treated in the same way , and this is the approach taken here for the shear components , @xmath32 .",
    "the implementation details specific to the calculation of the shear values will be discussed here .",
    "the short - range part of the shear field at a point is accumulated directly from neighbouring particles from the appropriate cartesian projections of the analytic function : @xmath33 where the sum is over all neighbour particles and @xmath34 is the separation of a neighbour particle from the point at which the shear is desired .",
    "( we have used the prime notation to denote derivatives with respect to radial separation . ) the short - range part of the field may be computed to machine accuracy .",
    "the long - range part of the shear field is derived by taking a second difference of the force values as computed in the standard 3mmethod .",
    "the only difficulty is that differencing the mesh field magnifies the noise which is present as a result of aliasing .",
    "reducing this noise requires more filtering in the fourier domain with a corresponding increase in the short - range cutoff , @xmath35 .",
    "optimization of the green s function appropriate for the shear calculation is done in a manner similar to that used for the force calculation .",
    "we minimized the sum of the squares of the deviations of all nine components of the shear , although a number of other reasonable possibilities exist . minimizing the deviation of the diagonal components , for example , produced results that were little different .",
    "it would be possible to compute the mesh shear components by inverse fourier transform of @xmath36 directly for each @xmath37 , @xmath38 such that @xmath39 , thus avoiding the real - space differencing .",
    "it would still be necessary to filter the field , however , and for the differencing operator used , the very small increase in accuracy would not justify the added computational cost of several further ffts .",
    "an important feature of numerical particle codes is the use of particle ` softening ' .",
    "the effect of this is that each particle in the code represents not a point mass but a distributed mass with some given ( fixed ) radial profile .",
    "softening is introduced primarily to avoid artificial ( or numerical ) relaxation ; that is , close two - body encounters leading to spurious energy redistribution in the system . since in most simulations",
    "we are attempting to model the cosmic matter density as a collisionless fluid , this is a useful approach .",
    "( note that the particle softening referred to here is distinct from the high frequency filtering , or smoothing , employed in the pm part of the calculation . )    in numerical particle simulation codes it is usual to employ a global softening for all particles ( which may , however , vary in time ) . as the particle distribution evolves and particles cluster the low density regions are represented by fewer particles .",
    "in a simulation computing interparticle forces to evolve the distribution of particles , this is of little consequence .",
    "however , if we wish to compute the shear values at some position on a ray passing through a low density region it may never come within the softening of the widely spread particles in the region . since we are interested in the trace of the shear matrix , which is equivalent to the density , this would suggest that the density at this point was zero .",
    "( in fact the density would be negative since the total mass in the periodic simulation cube must be zero . )",
    "this is unrealistic and does not accurately represent the matter density in these regions . increasing",
    "the softening would ameliorate this situation in the voids but would smooth away the high frequency information present in regions where the particles have clustered into high density lumps .",
    "the approach we have taken is to employ a variable softening , such that a particle in a region of low particle density has a ` size ' which is greater than that of a particle in a high density region .",
    "we have chosen a criterion similar to that used in hydrodynamic simulations using the sph method ( e.g. , gingold & monaghan , 1977 ) .",
    "each particle is chosen to have a softening such that its sphere of influence is proportional to the distance to its 32nd nearest neighbour . given these values the code appropriately modifies the short - range ( pp ) calculation to increment the shear components at a given point taking into account the varying sizes of the neighbouring particles .",
    "a minimal check of the technique may be made by computing the shear components at a large number of points surrounding a single massive particle .",
    "this is a useful test because the result is known analytically and it provides an immediate assessment of the errors present in the method .",
    "the test was made as follows .",
    "a single massive particle was placed at a random location in a mesh cell and the code used to measure the shear components at 16384 surrounding points located randomly in direction and distributed in radius such that there was an equal number of points per equal logarithmic increment in radius .",
    "the test was then repeated a further 34 times using the same evaluation positions , but different locations for the test particle designed to adequately sample the mesh cell .",
    "the shear components measured at each location were then compared with the true values derived from the ewald ( 1921 ) summation technique as described in appendix c. these comparisons are plotted in figure 1 .    @xmath40    panel a ) of figure 1 shows the absolute value of the radial component of the shear ( solid line ) as well as the fractional error in this quantity ( scattered dots ) .",
    "panel b ) shows the same quantities for the two transverse components . in both cases the measured values",
    "have been multiplied by an appropriate power of the separation , @xmath26 , such that a pure coulombic potential would show no radial variation .",
    "for the filtering chosen , the maximum error in these quantities is approximately 7 per cent , and occurs near the mesh scale used .",
    "the test was performed using a mesh of @xmath41 cells , but the errors are essentially independent of the mesh size for typical values of the softening .",
    "the cyclic error at small separations arises because linear interpolation into a look - up table is used for the short - range force .",
    "the few points lying above the main scatter of errors in panel b ) are due to one of the transverse components becoming very small with the consequence that the fractional error can become large .",
    "the rms error in our test on a single particle is less than 2 per cent .",
    "panel c ) plots the absolute value of the trace of the ewald - computed shear matrix and the fractional error of the computed trace values .",
    "the particle softening chosen for this test was 0.002 in units of the box side dimension and , because of the definition of the particle softening employed , this corresponds to the particle having a radial extent of 0.004 .",
    "the true value of the trace for smaller separations thus reflects @xmath42 times the density of the particle as required by poisson s equation . at larger separations",
    "the true density is -1 ( since the total mass in the system has to be zero ) , and thus the ewald - computed shear is @xmath42 .",
    "large errors occur in the trace values simply because the shear values individually are many orders of magnitude larger than @xmath42 and each is in error by a few percent ; we thus can not expect the sum of these large values to cancel to high precision to give the required result .",
    "this fact was one of the primary motivations for using a variable softening in which every position at which the shear was measured would lie within the effective radius of some particle . in this case we may expect that the computed values of the trace will have roughly the same fractional error as shown in panels a ) and b ) .",
    "this is discussed and tested further in the next section .",
    "finally , panel d ) shows the directional error between the principal eigenvector of the computed shear matrix and the separation vector .",
    "( the banding for small directional errors is due to numerical quantization in the computation of the directional error . )",
    "it is apparent that directional errors are very small in this method .",
    "note that the errors in the shear values computed from an _ ensemble _ of particles are , in general , much smaller than the pairwise errors shown in figure  1 .",
    "( for ensembles used in typical @xmath1-body simulations , the rms force errors are typically 0.3 per cent . )",
    "this is because the fourier representation of a general particle distribution will have a smaller high frequency content than the equivalent representation of a single massive particle and can thus be represented better by a given fixed grid . only if the pp and pm forces almost exactly cancel will the _ fractional _ errors be larger although in this case the absolute error will be small",
    ". there will be no appreciable change in the error values with larger mesh configurations normally used with @xmath1-body simulation data .      for a more realistic test of the code , we compare the computed shear trace with the density evaluated using a standard sph algorithm for one of our cosmological simulation boxes , described in section 5.1 .",
    "the sph programme evaluates a parameter , @xmath43 , at each particle in the simulation box , representing half the distance to the 32nd nearest neighbour .",
    "this parameter defines the volume for the density calculation , and the same parameter is applied in the shear code to establish an appropriate value of the softening for the particle .",
    "in addition , a specific smoothing function may be used to distribute the mass throughout the volume so defined .    to make a suitable comparison with the shear trace values , we have computed overdensity values from these densities , and compared the ratio of the overdensity and the trace with the overdensity values . in figure 2 , we plot the average value of this ratio in each overdensity bin .",
    "we have used a minimum value of 0.0005 for the variable softening , and analysed the data from 10000 particle positions .",
    "@xmath44    because of the very different ways in which the densities are determined ( from the shear trace in the new code , and from particle numbers in the sph programme , and the differing shapes of the softening functions used ) , we expect some dispersion in the values at all densities , and this is indicated by the 1@xmath45 error bars .",
    "the form of the plot is easily understood throughout its entire range . at low densities ,",
    "the sph density values are underestimated because isolated particles do not have the requisite number of nearest neighbours within the particle mesh . at high densities",
    ", the particle softenings will be at the same minimum level for all the particles , retarding the amount of increase in the shear trace values as the real density continues to rise .",
    "this effect causes the upturn shown in figure 2 , which occurs at the overdensity value of @xmath46 for a minimum softening of 0.0005 .",
    "the equality of the particle overdensities and shear trace values over more than three decades in density , gives us considerable confidence in the use of the shear algorithm generally , and for trace values determined at particle positions , or within the softening range .",
    "in the introduction we outlined some of the considerations we made before developing the new three - dimensional algorithm .",
    "we expressed concern that shear values in general may converge only slowly to their true limiting values as increasingly large volumes of matter are included around an evaluation position .",
    "if so , it would be essential either to take full account of the periodicity of matter orthogonal to the line of sight , or to include the effects of matter over considerable distances from the line of sight .",
    "we investigated this rate of convergence of the shear values for one of our simulation boxes , ( which we describe in section 5.1 ) . by using a straightforward direct - summation method for the particle contributions to the shear , we evaluated one of the off - diagonal two - dimensional shear components as we progressively added mass out to a radial extent of 2.5 box units . beyond a radius of 0.5 from the central position",
    ", the particles were laid down with the periodicity of the fundamental volume .",
    "the depth was one box unit throughout , because of the inbuilt periodicity along the line of sight .",
    "( we show in appendix b that provided there is periodicity along the line of sight , the two - dimensional shear values will equate with the three - dimensional results integrated over a single period . )",
    "figure 3 clearly shows that by including the matter within a single period only , ( to a radius of 0.5 ) , values for the shear components will , in general , be seriously in error .",
    "of course , different simulations and particle distributions will display different rates of convergence to the limiting values .",
    "however , it is quite clear that by making correct use of the periodicity in simulations ( as an approximation to the distribution of matter outside of each simulation cube ) , together with the net zero mass requirement , more realistic component values are achieved .",
    "other approaches which do not employ these two conditions may suffer from inadequate convergence to the limiting values .",
    "@xmath47      our three - dimensional approach allows the use of the appropriate angular diameter distances at every single evaluation position .",
    "this is not possible in two - dimensional approaches , where it is assumed that all the lensing mass is projected onto a plane at a single angular diameter distance .    by definition ,",
    "the angular diameter distance of a source is the distance inferred from its angular size , assuming euclidean geometry . in an expanding universe , therefore , the angular diameter distance becomes a function of the redshift of the source ( and of the observer ) .",
    "in addition , the inclusion of excess matter within the beam causes the beam to become more focussed , and makes the source appear closer than it really is . by considering the universe to be populated by",
    "randomly distributed matter inhomogeneities , but resembling the robertson - walker , friedmann - lematre model on large scales , ( see schneider , ehlers and falco , 1992 ) , a second order differential equation is obtained for the angular diameter distance , @xmath48 , in terms of the density parameter , @xmath49 , for the universe , and the redshift , @xmath50 , of the source : @xmath51    dyer and roeder ( 1973 ) made assumptions about the type of matter distribution to obtain a more general and practical equation .",
    "they assumed that a mass fraction , @xmath52 , ( called the smoothness parameter ) , of matter in the universe is smoothly distributed , and that the fraction @xmath53 is bound into clumps . then the equation for the angular diameter distance becomes @xmath54 in which shear , @xmath45 , is introduced by the matter distribution around the beam .",
    "they considered the following scenarios for the application of this equation .",
    "first , they considered a universe in which all the matter is bound into clumps , so that @xmath55 , and in which the light beam passes far away from the clumps .",
    "this is described as light propagating through an ` empty cone , ' and gives rise to maximal divergence of the beam .",
    "the second scenario is more general and practical , in that it uses an intermediate value for the smoothness parameter ( @xmath56 ) , but still requires the beam to pass far away from the clumps . in this case",
    "the beam contains a proportion of the smoothed matter distribution which introduces convergence , and hence some degree of focussing .",
    "the third scenario has @xmath57 , i.e. , an entirely smooth universe . here",
    "the smooth matter distribution is present within the beam , giving a ` full cone , ' or ` filled beam ' approximation .    in all of these scenarios",
    "the term including the shear in equation ( 2 ) is minimised , so that the final ` dyer - roeder equation ' becomes @xmath58 and can be solved for different values of @xmath49 and @xmath52 . for @xmath59 and @xmath57 (",
    "filled beam ) , schneider et al .",
    "( 1992 ) quotes the result for the angular diameter distance between an observer at redshift @xmath60 , and a source at redshift @xmath61 , as @xmath62,\\ ] ] or @xmath63 where @xmath64 is the dimensionless angular diameter distance , @xmath65 is the velocity of light , and @xmath66 is the hubble parameter .",
    "magnification values , @xmath67 , derived using dyer and roeder s angular diameter distances will be affected according to the approximation used .",
    "for example , rays passing close to clumps or through high - density regions will result in magnification in any approximation .",
    "if the empty cone approximation is used , then @xmath67 will be greater than 1 , and if the full cone approximation is used , then @xmath67 will be greater than the mean magnification , @xmath68 , since these would be the respective values in the absence of lensing .",
    "rays passing through voids will have @xmath69 in the empty cone approximation ( since the rays will be far from all concentrations of matter , and will satisfy the empty cone conditions ) .",
    "in the full cone approximation , @xmath70 because the rays will suffer divergence . however , the minimum value in this case will be , ( schneider et al . , 1992 ) ,",
    "@xmath71 ^ 2.\\ ] ] in addition , the mean value of the magnifications derived from a large number of lines of sight through a cosmological simulation should be close to unity in either the empty cone or the filled beam approximation .    in the testing of our new algorithm",
    "we have used the filled beam approximation ( @xmath57 ) to obtain the angular diameter distances . with variable softening",
    ", most of the rays will pass through a slowly varying density field , justifying this choice , although the smoothness parameter should be different from unity , and possibly should evolve slowly with time .",
    "( tomita , 1998b , finds , by solving the null - geodesic equations for a large number of pairs of light rays in four different cosmological @xmath1-body simulations , that the best value for @xmath52 is almost equal to 1 , although with considerable dispersion . ) however , the approximation that all rays should pass far from the clumps will not be strictly true , as shear on the light rays will be very much in evidence .",
    "we show in figure 4 the value of the factor @xmath72 , where @xmath73 is the dimensionless angular diameter distance from the observer to the lens ( here , the front face of each simulation box ) , @xmath74 is that between the lens and the source , and @xmath75 is that for the observer - source , where we have taken the source to be at a redshift of 5 .",
    "this factor , @xmath72 , is used to multiply the shear component values generated in the code , and we see that it has a peak near @xmath76 for a source redshift of 5 .",
    "the curve is very steep near @xmath77 indicating large fractional differences between the value of @xmath72 at the front and the back of simulation boxes at late times , where considerable structure may also be present .",
    "@xmath78    to obtain the absolute shear component values we must also introduce scaling factors which apply to the simulation box dimensions .",
    "the appropriate factor is @xmath79 , where @xmath80 for the simulation boxes we have used , which have comoving dimensions of @xmath81mpc .",
    "the @xmath82 factor occurs to convert the comoving code units into real units . by evaluating this factor at the front and rear faces of each simulation box",
    ", we can obtain an estimate of the maximum error associated with projecting the mass distribution onto a plane . in figure 5",
    ", we plot the percentage differences in this factor between the front and rear faces of each simulation box , and show the results for boxes of 50@xmath83mpc , 100@xmath83mpc , and 200@xmath83mpc comoving depths .",
    "the figure clearly indicates the possible presence of large errors when boxes are treated as plane projections .",
    "the errors are considerable at high and low redshifts , and , in particular , they are significant near @xmath84 , where the angular diameter factor @xmath85 is greatest . for simulation boxes of 50@xmath83mpc",
    "the difference is 4.5% near @xmath84 , for boxes of 100@xmath83mpc the difference is 9.0% , and for boxes of 200@xmath83mpc the difference is 16.3% , for a source at @xmath18 .    obviously , the front - rear differences are smallest in the smallest boxes , ( here 50@xmath83mpc comoving depth ) , but with small simulation boxes there are problems in adequately representing the extent of large - scale structure , and , as we have seen in section 4.1 , a serious question as to whether two - dimensional shear values can be correctly determined by considering matter out to such small radii in the transverse direction .",
    "even with 100@xmath83mpc boxes we have shown that the two - dimensional shear values can be seriously in error when only matter within the fundamental volume is included .",
    "with 200@xmath83mpc boxes , better convergence of values may be obtained because of the larger spread of matter transverse to the line of sight ; however , the range in the angular diameter distance factors along the line of sight is greater , introducing larger errors . to reduce this error",
    ", it may be thought that the boxes could be divided into a number of planes ; however , this procedure would give erroneous values for the shear because a full single period in depth is required , as we show in appendix b.    @xmath86    in section 5.3 we show that an approximation for the magnification in weak lensing is @xmath87 where the @xmath88 values are the two - dimensional ` effective lensing potentials , ' derived from integrating the three - dimensional components .",
    "consequently , we may also find that the errors in the shear component values , arising from ignoring the angular diameter distance factors through the simulation boxes , enter into calculations of the magnification .",
    "our three - dimensional shear code can be applied to any three - dimensional distribution of point masses confined within a cubic volume .",
    "each particle may be assigned an individual mass , although in our tests of the code , we have assumed all the particles to have the same mass . in addition",
    ", the code allows for either a fixed softening value for each particle , or a variable softening , dependent on each particle s density environment .",
    "we applied the code to the data bank of cosmological @xmath1-body simulations provided by the hydra consortium ( http://coho.astro.uwo.ca/pub/data.html ) and produced using the ` hydra ' @xmath1-body hydrodynamics code ( couchman , thomas and pearce , 1995 ) .",
    "our initial tests , described here , have used individual time - slices from these simulations using @xmath4 particles with a cold dark matter ( cdm ) spectrum in an einstein - de sitter universe .",
    "each time - slice has co - moving sides of @xmath21 mpc . since each is generated using the same initial conditions , we arbitrarily translate , rotate and reflect each time - slice to prevent the formation of unrealistic correlations of structure along the line of sight , when the boxes are linked together .",
    "the simulations used have density parameter @xmath89 and cosmological constant @xmath90 the power spectrum shape parameter , @xmath91 , has been set to 0.25 , as determined empirically on cluster scales ( peacock and dodds , 1994 ) , and the normalisation , @xmath92 , has been taken as 0.64 to reproduce the number density of clusters ( vianna and liddle , 1996 ) .",
    "the dark matter particle masses are all @xmath93 solar masses .",
    "we have chosen a softening function for the radial distribution of mass for each particle , such that light rays feel the existence of a smooth mass distribution .",
    "our code also allows for variable softening , so that each particle may be assigned its own softening - scale parameter , depending on the particle number - density in its environment . in this way",
    ", it can be used to minimise the effects of isolated single particles , whilst the smoothed denser regions are able to represent the form of the large - scale structure .",
    "the parameter we have chosen to delineate the softening scale for each particle is proportional to @xmath94 where @xmath95 is the radial distance to the particle s 32nd nearest neighbour .",
    "the value of @xmath43 is evaluated for every particle by applying our sph density programme , as described in section 3.2 , to each simulation box .",
    "we allow the maximum softening to be of the order of the mesh dimension for isolated particles , which is defined by the regular grid laid down to decompose the short- and long - range force calculations . in this way",
    "the density values are improved , as we described in section 2.3 .",
    "this also means that individual isolated particles are unable to strongly influence the computed shear values , in accordance with our need to study the broad properties of the large - scale structure , rather than the effects of individual particles .",
    "our new algorithm works with the ratio of the chosen softening ( proportional to @xmath43 ) for each particle , to the maximum value ( dependent on the mesh size ) , so that the parameter used has a maximum of unity .",
    "our method , which employs the variable softening facility , contrasts markedly with that of other workers . as an example , jaroszyski et al .",
    "( 1990 ) , who evaluate deflections due to density columns projected onto a plane , apply no softening function , except to assume that all the mass within each column is effectively located at its centre .    in the cdm simulations we have used , the minimum values for @xmath95 are of order @xmath96 ; e.g. , for the redshift @xmath97 box , the minimum @xmath98 , ( equivalent to @xmath99 kpc ) .",
    "this is comparable to the einstein radius , @xmath100 , for a large cluster of 1000 particles , ( for which @xmath101kpc for a lens at @xmath84 and a source at @xmath102 ) .",
    "consequently , by setting a working minimum value for the variable softening of @xmath96 we would rarely expect to see strong lensing due to caustics in our simulations . also , the radial extent of this minimum softening is of the order of galactic dimensions , thereby providing a realistic interpretation to the softening .",
    "having justified our chosen value for a working minimum value , it is also important to understand the sensitivity of our results to the input softening . figure 6 shows the distribution of magnifications due to a single simulation box ( @xmath97 ) , and assumed source redshift of 1 .",
    "the distributions using minimum softenings of 0.001 and 0.002 are extremely close , whilst the differences are more apparent with the minimum softenings of 0.003 and 0.004 .",
    "this is extremely helpful , because it means that if we set the minimum softening to 0.001 in the @xmath77 box ( equivalent to @xmath21 kpc ) and to 0.002 in the @xmath103 box ( also equivalent to @xmath21 kpc ) , then our results are likely to be little different from results using the same minimum softening throughout .    @xmath104    to highlight the sensitivity to the minimum softening , we plot in figure 7 the accumulating number of lines of sight having magnifications greater than or equal to the abscissa value .",
    "as expected , we see that the results using the smallest minimum softenings give rise to the highest maximum magnifications .    @xmath105      there are two very important properties of our three - dimensional algorithm for shear which make it eminently suitable for use within particle simulations .    first , each simulation box is treated as a periodic system , so that the contributions from all particles and their images are included in the shear computations .",
    "second , as far as we are aware , this is the first algorithm successfully adapted for @xmath1-body simulations , in which the shear components may be evaluated at a large number of locations throughout the extent of the box . in this way",
    "each of the selected locations may be considered as an individual deflection site , and deflections computed using individual angular diameter distances for each site .",
    "two - dimensional planar approaches , by contrast , are able to compute only one deflection for each ray at each projection plane , and such planes will be assumed to be at a single particular angular diameter distance .",
    "the first property of our algorithm gives confidence in the shear component values computed , whilst the second property enables us to trace the behaviour of rays throughout the full depth of each simulation box .",
    "to do this we construct a rectangular grid of directions through each box .",
    "since we are dealing with small deflections , and are interested only in the statistics of the output values , we consider each light ray to follow one of the lines defined by these directions through the box .",
    "the evaluation positions are specified along each of these lines of sight .",
    "the six independent second derivatives of the peculiar gravitational potential are calculated by the code at each of the selected evaluation positions throughout a simulation box .",
    "we then integrate the values in small chunks along each line , forming , essentially , a large number of planes through each simulation box .",
    "these integrated values form the input data to establish the elements of the jacobian matrix , @xmath106 , on each of the lines of sight for each of the deflection sites .",
    "we make use of the multiple lens - plane theory , which has been developed by blandford and narayan ( 1986 ) , blandford and kochanek ( 1987 ) , kovner ( 1987 ) , and schneider and weiss ( 1988a , b ) , and described in detail in schneider et al .",
    "( 1992 ) . at the first deflection site from the source",
    "we evaluate the components of the jacobian matrix , @xmath107 in which the two - dimensional ` effective lensing potentials ' are obtained from the three - dimensional second derivatives of the gravitational potential : @xmath108 where @xmath109 , @xmath110 , and @xmath111 are the angular diameter distances from the observer to the lens , the lens to the source , and the observer to the source , respectively . at subsequent deflection sites we obtain the developing jacobian matrix recursively ,",
    "since the final jacobian for @xmath1 deflections is : @xmath112 where @xmath113 is the unitary matrix , @xmath114 for the @xmath37th deflection , and each of the intermediate jacobian matrices can be written as @xmath115 where @xmath116 in which @xmath117 , @xmath118 and @xmath119 are the angular diameter distances to the @xmath38th lens , that between the @xmath37th lens and the source , and that between the @xmath37th and @xmath38th lenses , respectively .",
    "the magnification is , in general , @xmath120 so that we can assess the magnification as it develops along a line of sight , finally computing the emergent magnification after passage through an entire box or set of boxes .",
    "for example , figure 8 shows the development of the magnification through a single isolated simulation box ( @xmath97 ) with a chosen source redshift of 1 .",
    "the slightly different emerging magnifications arise because of the choice of different input minimum softening values .",
    "the figure shows an arbitrary line of sight , and we have assumed that the redshift varies linearly through the box .",
    "it should be noted that the magnifications derived using minimum softenings of 0.001 and 0.002 are almost identical .",
    "@xmath121    the convergence , @xmath122 , is defined by @xmath123 from the diagonal elements of the jacobian matrix , and causes isotropic focussing of light rays , and so isotropic magnification of the source .",
    "thus , with convergence acting alone , the image would be the same shape as , but of larger size than , the source .",
    "the shear , @xmath124 , in each line of sight , is given by @xmath125 this is sometimes written in component form : @xmath126 where @xmath127 and @xmath128",
    "shear introduces anisotropy , causing the image to be a different shape , in general , from the source .    with weak lensing , and these definitions",
    ", the magnification reduces to @xmath129 in the presence of convergence and shear , a circular source becomes elliptical in shape , with major and minor axes @xmath130 and @xmath131 so that the ellipticity , @xmath132 , is given by @xmath133 which reduces to @xmath134 in weak lensing .",
    "distributions and relationships amongst all these quantities can be determined straightforwardly .",
    "as an example , figure 9 shows the shear and convergence in a single ( assumed isolated ) simulation box , ( @xmath135 ) , with a source at redshift @xmath136 .",
    "the minimum ( variable ) softening has been set at 0.001 . as expected , the shear increases rapidly with increasing convergence , ( density ) , until a maximum value is reached where the minimum softening applies .",
    "measurements of the magnification and ellipticity show the linear dependences on @xmath122 and @xmath124 according to equations ( 21 ) and ( 25 ) , as expected .",
    "small departures from linearity are apparent only at high values of @xmath122 and @xmath124 .",
    "@xmath137    figure 10 is an example of the magnification distributions in three different simulation boxes , which are assumed to be isolated in space .",
    "we show the distributions for the @xmath77 box , the @xmath97 box , and the @xmath138 box , each with minimum softenings of 0.001 .",
    "a source redshift of @xmath139 has been chosen .",
    "( all the distributions have a mean magnification value of 1 . )",
    "@xmath140    in figure 11 we show the results from the same three simulation boxes , for a source at @xmath141 , but here assumed to be all located at the same position ( @xmath142 ) .",
    "this allows direct comparisons between the boxes to be made in terms of the formation of structure within them .",
    "for example , the later boxes show higher values for the maximum magnifications , and have shallower slopes in the distributions at the high magnification end .",
    "the peaks in the distributions for the later boxes occur at slightly lower magnification values , whilst all have mean magnifications of unity , as required .    @xmath143    by a simple extension of the multiple lens - plane theory , we are now able to take the emergent @xmath88 values from each simulation box , and feed them into a string of subsequent boxes . in this way , we are able to obtain all the necessary emergent parameters at @xmath77 arising from a source at high redshift",
    ". we shall be reporting on these results in a future publication .",
    "in this paper we have discussed our motivations for developing a new algorithm for use with cosmological @xmath1-body simulations in the study of weak gravitational lensing .",
    "we have also described the algorithm we have developed together with its variable softening refinement , and we have tested the output results from three - dimensional simulations against the ewald ( 1921 ) summation method for the shear components . we have described how the results from the new code can be applied to realistic simulations by including the appropriate angular diameter distances at every evaluation position . in this way",
    "it is very straightforward to compute the final magnifications , source ellipticities , shear and convergence values as a result of the passage of light through linked simulation boxes .",
    "the main points we have discussed are the following .",
    "appendix b rigorously shows that results from the two - dimensional and three - dimensional approaches to weak lensing are equivalent only if the mass distribution is periodic along the line of sight , a full period ( in depth ) is considered , and the angular diameter distances are assumed constant throughout the depth .",
    "\\2 . in order to evaluate the shear components correctly ,",
    "it is necessary to work with the peculiar potential , which we describe in appendix a. this applies equally to two - dimensional and three - dimensional methods .",
    "the results for two - dimensional planar projections may be invalid if matter outside the single period plane ( in directions orthogonal to the line of sight ) is not included .",
    "because of the slow convergence of the potential and shear components to their limiting values , it is necessary , in general , to include the effects of matter well beyond a single period , but depending on the specific mass distribution .",
    "the inclusion of the appropriate angular diameter distances at every evaluation position within a three - dimensional realisation avoids errors in the shear and magnification values .",
    "the errors incurred by treating simulation boxes as planes may be as much as 9% in a single box of depth 100@xmath83mpc at a redshift of 0.5 ( where the lensing effects are greatest , for a source at @xmath18 ) .",
    "( at low and high redshifts the fractional errors are greater . )",
    "the output from our algorithm is the three - dimensional shear components evaluated at a large number of positions within a periodic @xmath1-body simulation cube .",
    "the code itself is a development of the standard p@xmath0 m algorithm which determines forces ( the first derivatives of the potential ) , and the potential itself .",
    "the short - range part of the shear field at a point is accumulated directly from neighbouring particles , whilst the long - range part is obtained by taking a second difference of the force values .",
    "the computational cost of the p@xmath0 m method is low , being of order @xmath144 rather than of order @xmath145 .",
    "the pm calculation uses a fft method in which the density distribution is smoothed , and can be well sampled by the mesh .",
    "the mesh potential is then obtained by fft convolution .",
    "errors in the method can be minimised by suitable adjustment of the fourier components of the green s function .",
    "a key feature of the new algorithm is the facility to input a variable softening parameter .",
    "the feature enables particles in low density regions to have extended softening , so that nearby evaluation positions register a density rather than a complete absence of matter .",
    "by contrast , particles in highly clustered regions are assigned low softening values , and a selected minimum softening value is introduced to avoid singular ( strong lensing ) behaviour .",
    "the variable softening feature enables a much more realistic depiction of the large - scale structure within a simulation to be made .",
    "\\8 . in appendix c",
    "we summarise the ewald ( 1921 ) summation method , and develop the equations for use as a comparison with the values for shear obtained with our new algorithm .",
    "\\9 . by choosing an appropriate filter ,",
    "we are able to set limits for the maximum errors in the computed shear values from our code . in the tests , the maximum errors in both the radial and the transverse components of the shear are about 7 per cent for the effects of a single particle , when compared with the values obtained using the ewald formul .",
    "the rms errors are less than 2 per cent , and errors for ensembles of particles , to which we intend to apply the code , are typically 0.3 per cent ( rms )",
    ". the errors in the trace of the shear matrix can be large , because the trace frequently involves the addition of nearly equal and opposite ( but large ) values .",
    "individually , however , the errors in each component remain small .",
    "we have tested the data also against the output of a completely different programme for the density at particle locations .",
    "there is good agreement for the normalised density from this programme when measured against the shear trace from our new algorithm .",
    "the output from the code can be used together with the multiple lens - plane theory and appropriate angular diameter distances to obtain values for the magnification , source ellipticity , shear and convergence for a large number of lines of sight as they emerge from a simulation box .",
    "we show a typical distribution plot for the emerging magnification , having given proper consideration to the desired minimum value for the variable softening .",
    "we commend the algorithm for use in periodic @xmath1-body simulations from which the data can be manipulated to obtain emergent values from linked simulation cubes covering great distances . in this way",
    ", such a procedure also allows the comparison of results from different cosmologies .",
    "it is anticipated that our algorithm will become publicly available in enhanced form in due course .",
    "we are indebted to the facilities supported by nserc in canada , and to the starlink minor node at the university of sussex , for the preparation of this paper .",
    "we thank nato for the award of a collaborative research grant ( crg 970081 ) which has greatly facilitated our interaction .",
    "ajb is sponsored by the university of sussex .",
    "hmpc thanks the canadian institute for theoretical astrophysics for hospitality during the academic year 1996/97 .",
    "we have benefited also from valuable discussions with r. l. webster and c. j. fluke of the university of melbourne , and k. subramanian and d. roberts whilst they visited the university of sussex .",
    "a common method for modelling a section of the universe is to consider a distribution of masses within a triply periodic cube . in this appendix",
    "we examine how the peculiar potential in this model relates to that in a universe with large - scale homogeneity .      in friedmann  robertson ",
    "walker models when considering the growth of perturbations , gravitational lensing by cosmic structure , etc . , we are interested in deviations from homogeneity .",
    "the quantity of interest in this case is the _ peculiar _ potential .",
    "this is derived in the usual way by writing the equation of motion , @xmath146 for matter at position @xmath147 , in terms of a comoving coordinate @xmath148 , where @xmath149 is the expansion scale factor .",
    "the peculiar potential  the source for deviations from homogeneity  is @xmath150 the rate of change of expansion velocity , @xmath151 , is determined by the mean density of matter , @xmath152 , leading to the familiar results @xmath153 ( for full details see , for example , peebles ,  1993 ) .",
    "the peculiar potential arising from poisson s equation  ( [ eq : nablapec ] ) corresponds to a system with zero net mass on large scales .",
    "consider now a model universe of masses periodic in a cube of side @xmath154 .",
    "the forces generated by the matter distribution satisfy @xmath155 where is an integer triple .",
    "thus integrals , @xmath156 , where @xmath157 is an outward normal , taken over opposite faces of the cube , sum to zero , and @xmath158 over the surface of the cube vanishes .",
    "the divergence theorem and poisson s equation , @xmath159 , then imply @xmath160 and hence the total mass in the system is zero .",
    "this result is a consequence of solving poisson s equation in a periodic cube .",
    "we see that the real result for the shear , obtained from the second derivatives of the peculiar potential , @xmath19 , is related to the nave result based on the full gravitational potential , @xmath20 , through the use of @xmath161 .",
    "note that the zero mean density implicit in equation  ( [ eq : nablapec ] ) is a result of the coordinate transformation ; that this transformation is well motivated is a reflection of the large - scale homogeneity of the universe .",
    "the zero mean density in equation  ( [ eq : mzper ] ) , on the other hand , is simply a result of the imposed periodicity .",
    "the two views converge only for a periodic cube sufficiently large that the amplitude of the first few discrete fourier modes are small enough that they describe a smooth transition to a zero mean value and homogeneity .",
    "we begin by demonstrating a useful result relating the fourier transforms of continuous functions and the fourier coefficients of the periodic functions constructed from them .",
    "first , as a convenient mechanism for translating between fourier representations of continuous and periodic functions , we define the three - dimensional comb @xmath162 , where @xmath163 is an integer triple ( see , for example , hockney & eastwood  1988 ) . the fourier transform of this function is the comb @xmath164 .    consider the function , with period @xmath154 , constructed by periodically repeating @xmath165 : @xmath166 applying the fourier convolution theorem to equation  ( [ eq : fconv ] ) we see immediately that the fourier transform of the periodic function , @xmath167 , is @xmath168 where @xmath169 is the continuous fourier transform of @xmath165 .",
    "equation  ( [ eq : ctsper ] ) gives the fourier series representation of the periodic function directly and demonstrates the familiar result that the fourier coefficients of the continuous periodic function , obtained by accumulating repeats of the continuous function ( here @xmath170 obtained from @xmath165 ) , are the same as the fourier components of the continuous function at wavenumbers @xmath171 .",
    "this result is the analogue in real space of aliasing in fourier space .",
    "if the continuous function is zero outside the fundamental cell the periodic representation is simply obtained by tiling space with repeats of the fundamental cell .",
    "( this is the real - space analogue of a band - limited function . )",
    "consider now @xmath1 particles distributed in a cube of side @xmath154 .",
    "let the position of particle @xmath37 be @xmath172 .",
    "the density is then @xmath173 without , for the moment , requiring zero total mass . where necessary , we can consider a periodic density distribution constructed by tiling space with periodic repeats of the distribution in the fundamental cube : @xmath174    the gravitational potential at a point @xmath175 in the periodic system is @xmath176 where @xmath31 is the pairwise ` interaction ' potential ( or green s function ) .",
    "equation  ( [ eq : intconv ] ) may be interpreted in two ways .",
    "we may consider a periodic distribution of matter as in equation  ( [ eq : permass ] ) convolved with the regular interaction potential .",
    "alternatively , we can restrict attention to the matter in the fundamental zone and consider a modified interaction potential @xmath177 both of these interpretations will be useful .    using the result in equation  ( [ eq : intconv ] ) ,",
    "the fourier series coefficients of @xmath19 are , for @xmath178 and @xmath179 an integer triple , @xmath180 where @xmath181 is the continuous fourier transform of the particle distribution in the fundamental zone ( equation  ( [ eq : nopermass ] ) ) and @xmath182 is the continuous fourier transform of the interaction potential .",
    "requiring the mean mass to be zero is equivalent to subtracting a component equal to @xmath183 from the density in equation  ( [ eq : nopermass ] ) , or setting @xmath184 in equation  ( [ eq : phifs ] ) . with this modification equation  ( [ eq : intconv ] )",
    "becomes : @xmath185\\\\              & = & g\\left[\\sum_\\jn m_j \\varphi(\\vecx-\\vecxjn ) -{\\sum_j m_j\\over l^3 } \\sum_\\vecn \\int_{l^3 } \\varphi(\\vecx-\\vecn l -\\vecx^\\prime)\\ , d^3   \\vecx^\\prime\\right]\\\\              & = & g",
    "\\sum_j m_j\\left[\\sum_\\vecn \\varphi(\\vecx-\\vecxjn ) - { 1\\over l^3 } \\int\\varphi(\\vecx^\\prime)\\ , d^3 \\vecx^\\prime\\right]\\label{eq : perzerop}\\\\               & = & g \\sum_\\jn m_j \\left [ \\varphi(\\vecx-\\vecxjn ) -   { 1\\over l^3 } \\int_{l^3 } \\varphi(\\vecx^\\prime",
    "- \\vecn l)\\ , d^3 \\vecx^\\prime\\right],\\label{eq : perzero}\\end{aligned}\\ ] ] where @xmath186 and @xmath187 labels the image of the @xmath38-th particle in the image cell @xmath163 .",
    "we may write equation  ( [ eq : perzero ] ) as @xmath188 where we now have for the density @xmath189,\\label{eq : fulldens}\\ ] ] and equation  ( [ eq : phidag1 ] ) is now @xmath190.\\label{eq : fullvdag}\\ ] ] it is unnecessary for the mean value of _ both _ @xmath191 and @xmath31 to be zero .",
    "the form for the modified potential is convenient , however , since , for a potential which is coulombic at large scales , with @xmath192 , the form in equation  ( [ eq : fullvdag ] ) is convergent whereas the form in equation  ( [ eq : phidag1 ] ) is not : nor does the integral in equation  ( [ eq : perzerop ] ) converge .",
    "the fourier synthesis of the peculiar potential is @xmath193      the delta function in equation  ( [ eq : nopermass ] ) may be replaced by any compact even function , with volume integral equal to unity , to represent a distribution of softened particles .",
    "( the softening will be considered fixed for the present to permit fourier analysis . ) however , since it is only the _ interaction _ of the particles via the gravitational field which is relevant , we may , equivalently , describe any particle softening by modifying the pairwise ( coulombic ) potential , @xmath31 , at small separations .    from equation  ( [ eq : fpec ] ) we can immediately write @xmath194    for a coulombic interaction potential , @xmath195 , we have @xmath196 .",
    "if we set @xmath197 with @xmath198 , then @xmath199 describes the departure of the interaction potential from coulombic at small scales and , as we will see , plays the role of a particle softening .",
    "equation  ( [ eq : poiss ] ) becomes @xmath200 which is poisson s equation for a distribution of softened point charges ; @xmath201.\\ ] ]    note , that if we wanted the force on a softened particle from the distribution of softened particles ( rather than merely sampling the density field at a point ) , the appropriate interaction potential in fourier space would be @xmath202 .",
    "it is frequently assumed that for the purposes of determining deflections and shearing of light a three - dimensional mass distribution may be represented by a plane projection of the density . in particular , many workers in the field of gravitational lensing treat cosmological @xmath1-body simulation cubes as collapsed planes . in this appendix",
    "we investigate this assumption and show under what conditions the result holds .",
    "the result is approximate because of the need to apply the appropriate angular diameter distances at every deflection site ( or evaluation position ) . in our derivation",
    "we assume that these factors are constant along the line of sight through the projected volume , whereas in practice they will vary slightly through the simulation volume .",
    "( the technique developed in this work applies the angular diameter distances at every evaluation position within each three - dimensional realisation , and evaluates the shear components at many locations within each to enable a complete description of the shearing of a light ray during its travel through the simulation . )",
    "we will show that computations based on two - dimensional ( planar ) projections of three - dimensional ( periodic ) simulations are adequate provided : ( a ) the mass distribution is periodic along the line of sight , and a single ( full ) period is included in the projection ; ( b ) proper account is taken of the full transverse extent of matter , ( which should normally be assumed to be periodic , unless strong lensing by matter limited in extent is being considered ) ; by ignoring this requirement , it is likely that the convergence of deflection angles and shear components to their limiting values will not be achieved ; ( c ) the net zero mass requirement is adopted .",
    "consider the peculiar potential , @xmath203 , in a three - dimensional periodic system as given above in equation  ( [ eq : perzero ] ) : @xmath204.\\label{eq : ppotperb}\\ ] ]    as discussed in section  [ subsec : pecpot ] , the integral in equation  ( [ eq : ppotperb ] ) is finite and the sum over @xmath163 converges .",
    "although we will be considering derivatives of the potential  in which case the second , constant , term drops out  it is useful to have a rigorous convergent expression for the peculiar potential in a periodic system .",
    "we are interested in obtaining the integrated shear along a line - of - sight over one period : @xmath205 .",
    "we will begin by integrating the peculiar potential over one period : @xmath206 .    in the following",
    "we will split vectors over three dimensions into a two - dimensional component perpendicular to the line - of - sight and a component along the line - of - sight , here taken to be in the @xmath50 direction .",
    "a superscript asterisk is used to denote 2-dimensional quantities , e.g. , @xmath207 .",
    "then the two - dimensional potential is @xmath208 \\nonumber \\\\    \\hm&=&\\hm g \\sum_{\\jn^ * } m_j\\left [ \\int dz\\ , \\varphi(\\vecx-\\vecxjn , z - z_j )    -{1\\over l^2 } \\int\\!\\!\\int_{l^2 } \\varphi({\\vecx}^\\prime - \\vecn^ * l , z)\\ ,   d^2 { \\vecx}^\\prime dz^\\prime\\right ] \\nonumber \\\\   \\hm&=&\\hm g\\sum_{\\jn^ * } m_j\\left[\\varphi^*(\\vecx-\\vecxjn )    -{1\\over l^2 } \\int_{l^2 } \\varphi^*({\\vecx}^\\prime -   { \\vecn}^ * l)\\,d^2 { \\vecx}^\\prime\\right],\\label{eq : ppot2d}\\end{aligned}\\ ] ] where @xmath209 equation  ( [ eq : ppot2d ] ) is the 2-dimensional analogue of equation  ( [ eq : ppotperb ] ) , with the interaction potential , @xmath31 replaced by @xmath210 .",
    "thus the three - dimensional peculiar potential integrated over one period @xmath154 in one dimension , gives the same result as that obtained from the projected ( surface ) density of particles with a 2-dimensional interaction potential arising from the projection from of the 3-dimensional interaction potential .",
    "the corresponding results for the shear components , @xmath211 , @xmath212 , follow directly .      for the case of a coulombic potential in 3-dimensions , @xmath213 ,",
    "where @xmath214 , @xmath215 diverges .",
    "consider the two - dimensional potential over a finite range in z , @xmath216 , @xmath217 from equation  ( [ eq : ppot2d ] ) we can then write @xmath218\\right\\ } \\nonumber \\\\    & = & g\\sum_\\jn m_j \\left[2\\ln|\\vecx-\\vecxjn| - { 1\\over l^2 }    \\int_{l^2 } 2\\ln|{\\vecx}^\\prime - { \\vecn}^{*\\prime } l|\\,d^2 { \\vecx}^\\prime\\right].\\end{aligned}\\ ] ] thus , for @xmath195 , the appropriate two - dimensional potential is @xmath219 as expected .",
    "the discussion above applies to any suitably well - behaved interaction potential , @xmath31 . in particular , consider the case of a distribution of softened particles .",
    "this may be described in terms of an interaction potential which is coulombic at large scales but which falls below @xmath220 at small scales .",
    "it is most convenient to derive the appropriate @xmath210 in fourier space .",
    "we may set @xmath221 with @xmath222 ( see section  ( [ subsec : soft ] ) .",
    "the required two - dimensional fourier transform is then @xmath223    thus , for a given softening function @xmath224 , the appropriate function @xmath210 may be found , although an analytic solution may not be possible especially in view of the notorious difficulty of two - dimensional fourier integrals .",
    "in this appendix we turn to the numerical evaluation of sums for the potential and its derivatives in a periodic system such as those in equation  ( [ eq : ppotperb ] ) . for a coulombic potential @xmath225",
    "is divergent and the potential is only well defined ( and convergent ) if there is a uniform negative mass density to cancel the distribution of positive mass particles .",
    "even if this condition is met the sum for the potential is only slowly convergent and difficult to compute numerically .",
    "ewald ( 1921 ) proposed a method for computing such sums in the context of calculating lattice potentials of ionic crystals .",
    "the electrostatic problem suffers from exactly the same numerical difficulties as the gravitational problem ( the pairwise potential in each case is coulombic ) , and it is well known that navely summing over images of the fundamental cell gives an order - dependent result .",
    "note that the requirement for zero total mass is the same as the requirement in calculating crystal energies that the total charge be zero .",
    "we derive below ewald s method as it is applied to the problem of computing the gravitational potential and give expressions for the first and second derivatives of the potential  respectively the force and shear  and the total potential .",
    "we also demonstrate the relationship of the p@xmath0 m technique to the ewald method .",
    "consider again a system of @xmath1 particles in a cube of side @xmath154 .",
    "the density is given by equation  ( [ eq : fulldens ] ) : @xmath226.\\label{eq : ewdens}\\ ] ] the second term on the right hand side of equation  ( [ eq : ewdens ] ) makes the mean density zero as required for the existence of a solution to poisson s equation .",
    "as noted in section  [ subsec : soft ] , the delta function in equation  ( [ eq : ewdens ] ) may be replaced by any compact even function , with volume integral equal to unity , to represent a distribution of particles with fixed softening . alternatively , and equivalently , the interaction potential may be suitably modified .",
    "the gravitational potential at a point @xmath175 within the cube is given by equation  ( [ eq : perzero ] ) @xmath227,\\label{eq : ewpec}\\ ] ] where the notation is as in section  [ subsec : pecpot ] .",
    "note that evaluating equation  ( [ eq : ewpec ] ) at a particle position , @xmath172 , will include the self energy of particle @xmath37 .",
    "the sum in equation  ( [ eq : ewpec ] ) converges very slowly and is ill conditioned for numerical computation .",
    "ewald  ( 1921 ) proposed splitting the coulombic potential into two components , @xmath228 where the functional form of the split is chosen so that the first component is dominated by quickly converging local contributions and the second contains the relatively smooth long range components of the field .",
    "the attenuation of high frequencies in the second component ensures rapid convergence of the corresponding sum when recast as a fourier series .",
    "ewald proposed taking @xmath229 , @xmath230 , where erf and erfc are the error and complementary error functions respectively .",
    "the parameter @xmath231 is chosen to optimize convergence of the resulting real- and fourier - space sums .",
    "for the moment we will not specify the functional form and will continue with the description in equation  ( [ eq : ewsplit ] ) .    if we ignore for the moment the mean contribution in equation  ( [ eq : ewpec ] ) ,",
    "we can write the potential as @xmath232 the second term is a fourier series sum over @xmath233 , @xmath179 an integer triple , because of the periodicity of the system . referring to the result in equation  ( [ eq : phifs ] ) we see that the fourier components @xmath234 are given by @xmath235 where @xmath236",
    "this is completely equivalent to the results of subsection  [ subsec : pecpot ] but with @xmath237 replaced by @xmath238 , the only difference being that there will be a much larger effective softening for @xmath239 .",
    "we will now ensure that the mean density is zero .",
    "it is not sufficient simply to set @xmath240 in equation  ( [ eq : ewpecsplit ] ) as part of the mean value of the field is contained in the first ( real - space ) term .",
    "the required potential is @xmath241    the continuous fourier transform of the potential in equation  ( [ eq : ewpecpot ] ) gives , after straightforward manipulation : @xmath242    = g\\widetilde\\varphi(\\veck)\\widetilde\\rho(\\veck),\\ ] ] and thus , as required , the potential is the convolution of the total density , @xmath191 , with the interaction potential , @xmath31 . of course , for @xmath243 and we recover poisson s equation in fourier space .    substituting for @xmath244 in equation  ( [ eq : ewpecfor ] ) and then using the result for @xmath234 in equation  ( [ eq : ewpecpot ] ) gives the final result @xmath245 the potentials @xmath246 and @xmath239 can be chosen so that both sums in equation  ( [ eq : ewfin ] ) converge rapidly .    for a given split of @xmath31 in equation  ( [ eq : ewsplit ] ) we can calculate @xmath247 and",
    "hence efficiently calculate the potential at a point for a given particle distribution . from the expression in equation  ( [ eq : ewfin ] )",
    "we may also derive expressions with similar desirable convergence properties for derivatives of the potential , such as the force and tidal field at @xmath175 : @xmath248 for the first and second derivatives of @xmath249 we have @xmath250 @xmath251 and @xmath252 @xmath253 r_\\mu r_\\nu + $ ] @xmath254 .    from equation  ( [ eq : ewpart ] ) we can immediately write @xmath255",
    "we can recast the first term as a fourier series , since it is periodic ; as before the coefficients for the fourier sum are the same as those for the continuous transform . using this result",
    "we obtain @xmath256 where the integral is over all space .",
    "note that the first sum includes the mean @xmath257 component .",
    "equation  ( [ eq : ewpoiss1 ] ) leads directly to @xmath258\\sum_j m_j\\bigg\\}.\\label{eq : ewpoiss2}\\ ] ]    if the interaction potential is coulombic on large scales , @xmath259 , then @xmath260 , provided that @xmath261 sufficiently rapidly with increasing @xmath262 ( this condition is satisfied for any practical splitting choice ) .",
    "equation  ( [ eq : ewpoiss2 ] ) then gives @xmath263 _ including the negative mean density _ as in equation  ( [ eq : ewdens ] ) .",
    "the total potential energy of the @xmath1 particles in the box including interactions with all images is @xmath264 ( ignoring again temporarily the mean contribution to the peculiar potential in equation  ( [ eq : ewpec ] ) ) .",
    "we can make use of the same splitting in equation  ( [ eq : ewsplit ] ) and the results that follow from it for the potential , provided that the condition @xmath265 is observed .",
    "this is straightforward to take into account in the real - space sum by directly omitting the terms @xmath266 .",
    "the fourier sum , however , expresses the long - range component as a field which , to be correct at all locations , must contain the contribution of particle @xmath37 . measuring the potential at @xmath172 using equation  ( [ eq : ewpecsplit ] ) will",
    ", therefore , include the self - energy of particle @xmath37 arising from the interaction potential @xmath239 . the self - energy contribution from particle @xmath37 to the fourier sum",
    "is @xmath267 .",
    "using equation  ( [ eq : ewfin ] ) we obtain , after a little manipulation , the result @xmath268      a number of choices are possible for the interaction splitting in equation  ( [ eq : ewsplit ] ) .",
    "of primary interest is good convergence of both the real - space and fourier - space sums .",
    "it is also important to choose splitting functions which allow an efficient numerical scheme to be constructed .",
    "the most commonly used is that given by ewald ( 1921 ) , but a number of others have been discussed in the literature ( e.g. , nijboer & de wette , 1957 ) .",
    "the ewald scheme is a one - parameter family with @xmath269 , and @xmath270 .",
    "the fourier transform ( in three - dimensions ) of @xmath239 is @xmath271 .",
    "the parameter @xmath231 is chosen to optimize convergence .",
    "nijboer & de wette  ( 1957 ) show that both the real - space and fourier - space series have the same rate of convergence if @xmath272 .",
    "satisfactory results are obtained for a range of values near this result .",
    "machine accuracy ( 32  bit ) can typically be achieved with this value of @xmath231 by extending the sums in real space and fourier space to a radial distance of roughly five image cells or fourier modes respectively .",
    "the analytic result is independent of the value of @xmath231 although the rates of convergence of the sums are affected .",
    "increasing @xmath231 causes a faster convergence of the real - space sum whilst requiring the accumulation of a greater number of terms in the fourier series to achieve a given precision . if @xmath231 deviates too much from the optimal value , one of the sums will require the accumulation of a large number of terms for good convergence and we will be faced with the original computational problem which the splitting was introduced to solve .    clearly each computation of the potential ( or force etc . ) requires o(@xmath1 ) operations , and so to find the force on each of @xmath1 particles , for example , requires o(@xmath145 ) operations , and so is not competitive with other methods currently available .",
    "the present attraction of the method is its simplicity and that it enables forces to be calculated to high precision .",
    "some improvement in computational efficiency can be obtained by noting that the fourier sums in equations  ( [ eq : ewfin ] ) and  ( [ eq : ewtotpot ] ) can be factorized . for equation  ( [ eq : ewfin ] ) ,",
    "for example , we can express @xmath273 as @xmath274 .",
    "the sum over @xmath38 can be precomputed and stored for the small number of wavenumbers @xmath275 required ( typically a few hundred ) .",
    "this reduces the cost of the fourier sum to an o(@xmath1 ) operation for a fixed number of wavemodes and allows the parameter @xmath231 to be increased , which reduces the work of the real - space sum .",
    "note that since @xmath239 is a real , even function , its fourier transform will also be real and even .",
    "this allows the complex exponential to be reduced to a cosine for numerical computation of the sum .",
    "( the factorization just described is then only marginally more complicated  see section  [ subsec : ewform ] . )",
    "the p@xmath0 m algorithm uses an interaction splitting which can be described using the same terminology set out above .",
    "the splitting employed is analogous in many ways to choosing a very large value of @xmath231 .",
    "this reduces the range over which the real - space sum must be accumulated and throws most of the work into the fourier sum . in p@xmath0",
    "m the real - space sum is reduced to such an extent that the effective range is much smaller than the periodic distance , @xmath154 .",
    "indeed a different functional split is commonly used in which @xmath246 is compact .",
    "this allows efficient techniques to be used in which only nearby particles need be included in the real - space sum . since the effective range of the real - space sum is now much less than the period distance @xmath154 , this part of the calculation now takes o(@xmath276 )",
    "operations to compute , where @xmath277 is the mean number of particles within the range of the function @xmath246 .",
    "provided @xmath277 does not become too large ( as it unfortunately will in gravitational simulations as clustering develops ) the real - space work is essentially o(@xmath1 ) . pushing much of the work into the fourier domain",
    "is only advantageous if efficient methods are available for accumulating the fourier sum and if we can avoid the convergence problems discussed above in accumulating forces from the fourier components .",
    "the fourier part of the p@xmath0 m method is best understood in terms of equation  ( [ eq : ewpecpot ] ) rather than equation  ( [ eq : ewfin ] ) .",
    "the key to the method lies in approximating the fourier components @xmath278 . instead of calculating afresh the fourier sum for each value of @xmath175 for which it is required , the result is interpolated from stored values discretized on a regular grid .",
    "provided the field is adequately sampled , the error in this procedure can be reduced to acceptable levels .",
    "the interaction splitting must be chosen such that the number of grid points available is sufficient to represent the harmonic content of the field . since the number of wavenumbers over which the field must be known may now be very large ( a consequence of the short range of the real - space sum ) , an efficient method for calculating the fourier components from the density field and interaction potential must be used .",
    "this is achieved by sampling the density field with a uniform grid and using a fast fourier transform ( fft ) technique for obtaining the potential . using",
    "an fft also ensures well - determined convergence properties for the fourier sums .      using the splitting described by ewald we will now write down explicit expressions for equations  ( [ eq : ewfin ] ) and  ( [ eq : ewtotpot ] ) which can be used to compute the potential , its derivatives and the total potential .",
    "we have @xmath229 , @xmath279 and @xmath280 .",
    "( the error function , @xmath281 , is @xmath282 .",
    "many approximations to erfc suitable for efficient numerical computation exist in the literature and are often also available in mathematical libraries on many current computers . ) to calculate @xmath283 we must take the limit of the transform of @xmath284 as @xmath285 .",
    "this gives @xmath286 .",
    "the value of @xmath287 .",
    "recall that the fourier modes are labelled by @xmath171 where @xmath179 is an integer triple . finally , define @xmath288 and @xmath289 putting all of this together we find : @xmath290 e^{-\\pi^2l^2/(l^2\\eta^2)}\\bigg\\},\\label{eq : ewpotform}\\end{aligned}\\ ] ] and @xmath291 e^{-\\pi^2l^2/(l^2\\eta^2 ) } - { 2\\eta\\over \\surd\\pi } \\sum_j m_j^2\\bigg\\}.\\end{aligned}\\ ] ]    derivatives of @xmath19 may be calculated trivially from equation  ( [ eq : ewpotform ] ) .",
    "we have : @xmath292{r_\\mu\\over r^3}\\bigg\\vert_{\\vec{r}=\\vecx-\\vecxjn}\\nonumber\\\\ & & + { 2\\over l^2}\\sum_{\\vec{l}\\ne0 } { l_\\mu\\over l^2 } \\big[c(\\vecl)\\sin(2\\pi\\vecl.\\vecx / l)-s(\\vecl)\\cos(2\\pi\\vecl.\\vecx / l)\\big ] e^{-\\pi^2l^2/(l^2\\eta^2)}\\bigg\\},\\end{aligned}\\ ] ] and @xmath293_{\\vec{r}=\\vecx-\\vecxjn}\\nonumber\\\\ \\noalign{\\medskip } & + & { 4\\pi\\over l^3}\\sum_{\\vec{l}\\ne0 } { l_\\mu l_\\nu\\over l^2 } \\big[c(\\vecl)\\cos(2\\pi\\vecl.\\vecx / l ) + s(\\vecl)\\sin(2\\pi\\vecl.\\vecx / l)\\big ]   e^{-\\pi^2l^2/(l^2\\eta^2)}\\bigg\\}.\\end{aligned}\\ ] ]"
  ],
  "abstract_text": [
    "<S> we have developed a new three - dimensional algorithm , based on the standard p@xmath0 m method , for computing deflections due to weak gravitational lensing . </S>",
    "<S> we compare the results of this method with those of the two - dimensional planar approach , and rigorously outline the conditions under which the two approaches are equivalent . </S>",
    "<S> our new algorithm uses a fast fourier transform convolution method for speed , and has a variable softening feature to provide a realistic interpretation of the large - scale structure in a simulation . </S>",
    "<S> the output values of the code are compared with those from the ewald summation method , which we describe and develop in detail . with an optimal choice of the high frequency filtering in the fourier convolution , the maximum errors , when using only a single particle , </S>",
    "<S> are about 7 per cent , with an rms error less than 2 per cent . for ensembles of particles , used in typical @xmath1-body simulations , </S>",
    "<S> the rms errors are typically 0.3 per cent . </S>",
    "<S> we describe how the output from the algorithm can be used to generate distributions of magnification , source ellipticity , shear and convergence for large - scale structure .    </S>",
    "<S> 3mp@xmath0 m # 1*#1 * # 1#2#3#4#5#1 , # 2 , # 3 , # 4 , # 5 # 1#2#3#1 , # 2 , # 3 , in press # 1#2#3#4#5#6#1 , # 2 , in # 3 , eds , # 4 . </S>",
    "<S> # 5 , p.  # 6 </S>",
    "<S> # 1#2#1 , # 2 , preprint = cmti7 # 1 # 1    = wncyr10 at 12pt = wncyr7 at 8.5pt = wncyr5 at 6pt = = = # 1#22.1pt-1.2pt/-1.2pt 2.1pt    galaxies : clustering  cosmology : miscellaneous  cosmology : gravitational lensing  methods : numerical  large - scale structure of universe </S>"
  ]
}