{
  "article_text": [
    "the field of astronomy has witnessed rapid growth over the past few decades leading to the division of astronomers into observers , instrumentationalists , and theorists . in recent years",
    ", there is even an increased specialization within these sub - classes ( e.g.  numericists vs.  semi - analytic theorists , spectroscopy vs.  adaptive optics imaging ) .",
    "similarly , as observatories approach billion dollar projects the complexity of building a facility - class instruments exceeds the capacity of a single astronomer .",
    "in contrast to the recent past , it is impractical for the majority of observational astronomers to design and fabricate a new instrument as the most efficient means of pursuing his / her scientific interests .    instead",
    ", modern observers now acquire and analyze data - sets without having even visited the telescope or even having developed intimate knowledge of the instrument .",
    "furthermore , many observers now rely on data reduction pipelines to produce calibrated , science - quality data without a comprehensive knowledge of the trade - offs and limitations considered by the software designer(s ) .",
    "although this trend toward virtual observing may improve the efficiency with which new data is obtained and analyzed , users of these tools are prone to having an incomplete understanding of his / her experiment .    motivated by these trends , we have written the following paper to document the design , usage , and data reduction pipeline of the mike echelle spectrometer @xcite .",
    "we discuss observational techniques for the calibration of these data , new algorithms to improve sky subtraction and flat fielding , and object extraction .",
    "although we focus on the mike spectrometer , we will give a pedagogical discussion that generalizes to the majority of echelle spectrometers in use today and in the future ( e.g.  hires , uves ; * ? ? ?",
    "* ; * ? ? ?",
    "portions of this manuscript also generalize to many of the low dispersion spectrometers in use today ( e.g.  deimos , fors , imacs ) .",
    "the principal goal of this paper is to describe the data reduction pipeline designed for the mike spectrometer and then generalized to the hiresxavier / hiredux ] , uves ( e.g. * ? ? ?",
    "* ) and esi spectrometers within the xidl packagexavier / idl / index.html ] maintained by jxp .",
    "many of the techniques we have implemented follow the standard lore of astronomical research , and we have benefited from many previous works on this topic ( e.g. * ? ? ?",
    "* ; * ? ? ?",
    "furthermore , our efforts have been inspired by ( and take advantage of ) the algorithms developed for the spectral reductions of the sloan digital sky survey ( sdss ; burles & schlegel , in prep . ) .",
    "several unique characteristics of the mike spectrometer ( e.g.  tilted sky lines ) , however , have inspired new techniques for wavelength calibration , flat fielding , and object extraction .",
    "we describe these in detail in this manuscript ; they may be of interest to future instruments where similar issues arise ( e.g.  x - shooter ; * ? ? ?",
    "the paper is organized as follows . in  [ sec : design ] , we describe the mike double echelle briefly and highlight points which directly influence the design and implementation of the reduction algorithms described in this paper . in  [ sec : pipe ] , we describe the layout of the software pipeline . in  [ sec : proc ] , we describe the image processing algorithms . in  [ sec : flatfield ] , we describe the flat field algorithms . in  [ sec : wave ] , we describe the wavelength calibration algorithms . in  [ sec : object ] , we describe object tracing and extraction .",
    "finally , we describe fluxing and coaddition algorithms in   [ sec : endgame ] .",
    "mike is a double echelle spectrograph which was designed for the magellan telescopes and installed on magellan ii ( clay ) during november 2002 .",
    "the standard configuration for mike is set by the cross - over wavelength of the dichroic ( originally at 4550  and now 4950 ) and delivers complete wavelength coverage from 33505000   ( blue ) and 49009500   ( red ) .",
    "the range can be adjusted down to @xmath1   and up to @xmath2   on the red and blue sides , respectively .    in order to understand the strategies employed for observing and for data reduction , it is important to review the basic aspects of the optical and mechanical design of the instrument .",
    "we summarize these below and refer the reader to @xcite and the mike user guide for a more complete description ( http://www.lco.cl ) .    the first optical element in mike beyond the slit is the dichroic window .",
    "the dichroic coating on the first surface reflects blue light and transmits red . after the dichroic , the two arms are independent but comprised of a similar train of optical elements .",
    "the beam on both sides is first converted from the f/11 focal ratio of the telescope to a roughly f/3.5 beam by a set of `` injection '' optics which essentially form a virtual image of the slit in the plane of each camera , offset from the ccd .",
    "a single set of large lenses then comprise the collimator / camera of each arm .",
    "these are used in double pass to first collimate the beam on its way to the dispersion elements , and then to focus the beam on its way back to the ccd .",
    "the gratings are used in quasi  littrow so that this virtual image of the slit and the echelle footprint are offset from each other in the focal plane of the camera / collimator . between the camera / collimators and the gratings ,",
    "both beams pass twice through a single prism on the red side and a pair of prisms on the blue side for cross dispersion .",
    "lcc focal ratio ( effective ) & f/3.9 & f/3.6 + scale at ccd & 8.2 pix/@xmath3 ( @xmath4pix ) & 7.5 pix/@xmath3 ( @xmath5pix ) + @xmath6/pixel ( unbinned ) & @xmath7 & @xmath8 + detector & @xmath9 ( 15@xmath10 m pixels ) & @xmath9 ( 15@xmath10 m pixels ) + gain & 0.47 e-/dn & 1.0 e-/dn + read noise & 2 e-/pix & 3.5e-/pix + dark current & 5 dn / pix / hr & 2 dn / pix / hr",
    "+ wavelength range & 32005000 & 490010,000 + resolution ( fwhm ; @xmath11 slit ) & 83,000 & 65,000 + resolution ( fwhm ; @xmath12 slit ) & 28,000 & 22,000 + echelle grating & r2.4 & r2 + prism ( cross disperser ) & fused silica , 38deg ( 2 prisms ) & pbm2 , 47deg ( 1 prism ) + [ tab : basic.params ]    the basic characteristics of the spectrograph are summarized in table [ tab : basic.params ] .",
    "in addition to these parameters , the detailed configuration of the dispersion elements has a variety of consequences for the spectral format .",
    "the most notable is that the quasi - littrow configuration of the grating causes the slits to be tilted along the orders so that sky lines are not aligned with the ccd rows / columns .",
    "this is a virtue in that it guarantees that any spectral feature from an extended source is sampled across several pixels in the spectral direction , regardless of slit width .",
    "this improves sampling of the sky lines and therefore sky subtraction .",
    "another important effect of the configuration is that a small amount of anamorphic magnification results in two ways : ( 1 ) there is a small difference in the width of the collimated beam off the grating along individual orders , and ( 2 ) there is a change in the beam width along and between orders due to angular deviation through the prisms .",
    "these both cause changes in the f/ # , and therefore pixel scale .",
    "changes along the order are minor .",
    "however the slit length in pixels changes by about 10% over each echelle spectrogram . in this pipeline , we therefore quantify spatial location along the slit in units of the slit length rather than absolute pixel units .",
    "this is an issue , for example , in tracing the location of the object along the slit , as it will move due to atmospheric refraction during any off - zenith observation .",
    "the primary motivation for using prism cross - dispersion is the high transmission efficiency provided .",
    "however the angular dispersion compared to a grating is limited by relatively small changes in glass index with wavelength ( @xmath13 ) , particularly at redder wavelengths .",
    "this limits the order separation .",
    "the prism apex angles and materials were chosen to obtain a minimum order separation of about @xmath14 , and a maximum slit length of @xmath15 is therefore available . to make full use of this length",
    ", some care is taken in the data - reduction pipeline to make use of the partially illuminated pixels at the ends of the slit , which requires that the intra - order regions of the ccd must be illuminated in the flat - fielding images .",
    "this can be done by inserting a holographic diffuser just after the slit ( before the dichroic ) that spreads the beam coming through the slit into a 5 degree cone .",
    "this is sufficient to spread the light at any wavelength over a 5075 pixel region and fill the intra  order pixels .",
    "flat fields taken with this slide in are referred to as `` milky flats '' or `` pixel flats '' in this pipeline .",
    "calibration of the full ccd in this way also allows good measurement and subtraction of scattered light ( see  [ sec : mflat ] ) .",
    "the instrument is used ( exclusively ) in a gravity - invariant mode .",
    "it rests on a mounting fixture which holds it a few millimeters from the nasmyth mounting flange .",
    "mike is not bolted to the flange because the flange must rotate in order to move the guiders around the sky as the field rotates with zenith angle .",
    "the field will rotate on the slit with time as a result , with mixed implications : an off - center source can move slightly relative to the center of the slit over a long ( 20 - 60 min ) exposure near zenith , however it is also possible to avoid placing neighboring objects in the slit by waiting for the field to rotate slightly .",
    "a clear virtue of the gravity  invariant mode is that the only mechanical motion that can occur in the spectrograph is due to thermal variations .",
    "these thermal changes are quite minor .",
    "the only significant motions of the spectrum on the ccd are caused by the thermal changes of the glass and air , both of which have significant changes in index with temperature ( @xmath16 ) .",
    "the orders can move in the spatial direction by 12 unbinned pixel over the course of a night .",
    "we track this motion by acquiring arc images in sequence with science exposures .",
    "the camera / collimators are mounted on rigid , flexure - mounted optical benches . because the image and object of the camera / collimators are in the same location  the virtual image of the slit is formed by the injection optics in the focal plane of the ccd  one can focus each arm by simply moving the optical bench relative to the ccd .",
    "a passive thermal compensation system ( an invar rod with a different coefficient of thermal expansion from the rest of the spectrograph ) keeps the instrument in good focus throughout the night , and season to season .",
    "the same focal settings have been optimal since the instrument was installed .",
    "mike includes an internal thorium - argon lamp for wavelength calibration and an incandescent lamp for flat fielding .",
    "the incandescent lamp can be used with the diffuser slide to fully illuminate the ccd ( including intra - order regions ) for pixel flats , or without to obtain ` uniform ' illumination of the orders that can be used to trace their location on the detector .",
    "we refer to the latter as `` trace flats '' , which we also use to obtain a slit profile and correct any micro - roughness or width - variability that may exist along the slit .",
    "it is also possible to take trace flats using the twilight sky , and in fact this is slightly preferable because it guarantees a truely uniform illumination of the slit .",
    "although all internal lamps are projected onto the slit with the appropriate f/11 beam ( as from the telescope ) , the incandescent lamp is diffused before reimaging to avoid producing bright spots ( images of the lamp filament ) along the slit .",
    "diffusion has been accomplished in a variety of ways over the years and has been uniform to better than a few percent when we have checked it . however the twilight sky is always guaranteed to be uniform .",
    "it is also possible to place an iodine cell in the optical path , although the data - reduction pipeline described here does not currently provide routines for exploiting this option .",
    "the pipeline includes routines for flux calibration .",
    "as with any spectrum taken through a narrow ( @xmath17 ) slit , the dependence of seeing on wavelength and atmospheric dispersion will lead to variable slit losses .",
    "this reduces the accuracy of relative flux calibration over a wide range in wavelength .",
    "however , another standard problem for echelle calibration is variable pupil centration on the grating(s ) with wavelength , field location , and instrument alignment . in our case ,",
    "the pupil is well centered on the grating with negligible vignetting for well - aligned targets in both arms of the spectrograph .",
    "however the pupil centration can be slightly better or worse from run to run because the instrument is not rigidly mounted to the nasmyth rotator .",
    "we find that in most of our data sets taken over the first 5 years ( tens of observing runs ) , the centration is quite good and variability of the flux calibration in overlapping orders is typically not worse than a few percent .",
    "this contrasts significantly with the results generally achieved with other echelle spectrometers ( e.g.  keck / hires * ? ? ?",
    "the dichroic is positioned in the optical path so that the incidence angle of the beam is 30 degrees from normal .",
    "the back surface of the dichroic slide is ar coated .",
    "unavoidably imperfect performance of both the dichroic and ar surfaces allow for weak ghosts to be created in the red - side spectra at the far blue range of its operation and in the blue side .",
    "in addition , there is the appearance of some ghosting from the face - on glue joints in blue side prisms .",
    "this section describes the layout of the code , the methods used to organize the data , and summarizes the motivations and key limitations of the data reduction pipeline . to clarify",
    ", this paper describes an idl implementation of a mike reduction pipeline .",
    "there is an entirely separate pipeline based on python that was written by d. kelson ( http://www.lco.cl/telescopes-information/magellan/instruments/mike ) . throughout the algorithms ,",
    "the detector is oriented in memory within idl such that rows correspond to spatial information and columns correspond to spectral information .",
    "the previous section discussed the general design of the mike spectrometer .",
    "common to most echelle spectrographs , there are only a few optical elements or detector configurations that can be adjusted by the observer . for mike , these are the ccd binning , slit plate position to choose the illuminated slit , and the angles of the dispersing elements . in practice , the dispersers are rarely adjusted because the standard setup provides nearly continuous wavelength coverage from @xmath18 .    throughout the remainder of the paper ,",
    "the term `` setup '' defines a unique configuration of the slit , ccd binning , and disperser angles . to properly reduce the data , one requires a full set of calibration exposures for each setup . in this sense",
    ", one must treat the observations and data reduction of each unique setup separately . because the slit is adjusted through an interface separate from the ccd controller interface , the slit plate position is not recorded in the fits header .",
    "although the slit could be determined automatically ( e.g.  by measuring the fwhm of the arc lines ) , we require the user to designate which exposures correspond to which setup .      basic characteristics of each data frame ( i.e.  each fits file ) are parsed from the fits header and recorded in an idl structure ( akin to a structure in c ) in a series of `` tags '' .",
    "these include the right ascension ( ra ) , total exposure time ( exp ) , ccd binning ( colbin , rowbin ) , etc .",
    "this structure is archived as a binary fits table that one can edit with standard fits tools ( e.g.  _ fv _ ) or simple idl scripts .",
    "the observer is required to identify the science and calibration frames of a unique setup ( via the setup tag ) and must identify and flag any corrupted , junk , or test frames .",
    "the pipeline structure is called into memory within the idl package and is passed to nearly every algorithm .",
    "this includes an algorithm which automatically identifies the exposure type ( e.g. _ bias , flat , arc , obj _ ) according to the length of the exposure , the total counts , and level of structure in the image .",
    "science exposures of a given setup are further parsed by the object name ( from the fits header ) and each unique target is assigned an integer obj_id value .",
    "most of the algorithms are then controlled with the idl structure , the setup number , and the obj_id value .",
    "all of the tasks can be carried out on the two cameras independently , as desired .",
    "the design of the reduction pipeline was guided in large part by our scientific interests .",
    "our primary targets are relatively faint ( @xmath19 ) , extragalactic sources with negligible ( quasars ) or small spatial extent ( globular clusters ) .",
    "our science goals generally required modest s / n ( @xmath20 ) and moderate spectra resolution ( @xmath21 ) .",
    "none of our science goals required accurate absolute fluxes .",
    "these characteristics describe many of the programs carried out with mike to date ( e.g. * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "* ) , but there is also a substantial community interested in very high s / n and/or high precision observations . with the above considerations in mind",
    ", we set out to achieve the following goals with our observing and data reduction procedures :    * achieve a relative wavelength error of less than 0.05pix and an absolute wavelength scale of better than 0.2pix . *",
    "achieve better than 10@xmath22 precision in the relative fluxing of objects .",
    "this is primarily for co - adding overlapping echelle orders .",
    "* implement bias subtraction and flat fielding procedures that remove pixel - to - pixel variations to better than 1@xmath22 statistical error without introducing @xmath23 systematic error . *",
    "maximize the number of pixels analyzed along the spatial dimension for sky subtraction .",
    "this is especially important for mike because of its relatively short slit length ( @xmath15 ) .",
    "* approach the poisson limit with sky subtraction and extraction .",
    "* perform an accurate measurement of the spatial profile and its variation with wavelength . *",
    "derive a 1d variance array which describes the principal sources of error ( poisson noise , read noise , flat fielding ) .",
    "* robustly flux calibrate and combine multiple exposures across diffraction orders to create a single 1-dimensional flux calibrated spectrum for each object .    of these , the most difficult requirement is flat fielding : there are challenges to obtaining appropriate calibration data ( e.g.  achieving sufficient counts at 3200 ) and also detector blemishes ( especially on the blue side ) that introduce @xmath24 systematic errors .",
    "granted the relatively narrow scientific programs which motivated our observing strategy and pipeline design , we caution about the following limitations .",
    "first , we have not carefully explored or addressed systematic errors at levels of @xmath25 .",
    "for example , detector blemishes ( pock marks ) are present in the red ccd .",
    "these are easily identified yet difficult to calibrate to better than the @xmath23 level .",
    "furthermore , we have not demonstrated that the algorithms which subtract scattered - light perform significantly better than @xmath23 precision .",
    "therefore , it may be difficult to recover very high s / n data ( @xmath26 ) with our procedures .",
    "second , we have not developed algorithms to properly subtract the sky background for observations of very bright or spatially extended objects ( i.e.  where the object exceeds the sky flux in every pixel along the slit ) .",
    "we have assumed that at least a few pixels in the slit are sky dominated or we skip sky subtraction altogether .",
    "third , we have not introduced algorithms to calibrate the iodine cell .",
    "the first step in all of the ccd pipeline routines is standard digital processing . in a custom",
    "routine , called ` mike_proc ' , we process both red and blue ccd data .",
    "this routine includes the following steps applied in sequence : ( 1 ) remove smooth overscan levels in both columns and rows ; ( 2 ) trim the data to the active 2048x4096 native pixels ; ( 3 ) apply the pixel - to - pixel flat ; ( 4 ) convert adu to electrons by applying the gain ; ( 5 ) calculate and record the inverse variance of the image , including readout noise .",
    "the final step adopts an algorithm which approximates the noise in the low count ( i.e.  poisson ) limit .",
    "each raw ccd frame is read into memory as standard unsigned 16-bit integers in the same state as it was saved at the telescope . the overscan regions and on - ccd binning is deduced directly from the raw image size under the assumption that the full frame was read to disk . for standard mike pipeline reductions , we do not subtract bias frames nor dark frames .",
    "we have constructed super bias and super dark frames , but no features were apparent and not nearly as significant as the structure that appears and varies in a frame - by - frame basis .",
    "we need to carefully model the overscan regions to remove the digital features in the ccd image .",
    "the first overscan region that is modeled includes all columns that readout immediately after each ccd row .",
    "first , we average these columns with 3-sigma clipping to produce a mean 1d overscan spectrum as a function of ccd row",
    ". then the routine convolves this spectrum with a 4th degree savitzky - golay filter having a symmetric width of 121 native pixels average ( figure  [ fig : bias ] ; upper panel ) .",
    "this averaged , filtered spectrum is replicated and subtracted from the entire , raw ccd frame .",
    "the same procedure is then applied to the set of rows immediately preceding the active ccd rows .",
    "similarly , a 73 native pixel savitzky - golay filter is convolved with the average overscan in each column ( figure  [ fig : bias ] ; lower panel ) .",
    "this result is replicated and subtracted from the entire ccd frame .",
    "there have been two ccd detectors used with the blue side of the mike spectrometer . at commission ,",
    "a site st-002a ccd with relatively poor quantum efficiency ( qe ) at @xmath27  was installed .",
    "this ccd was replaced on may 6 , 2004 with a lincoln labs ccid-20 device which has high qe down to the atmospheric cutoff .",
    "however , all data taken with the upgraded blue ccd between the dates of may 6 , 2004 and september 21 , 2005 suffer from a non - linearity in count rates . on the latter date ,",
    "the voltages were reset to correct this non - linearity . to deal with this non - linearity in affected data",
    ", we adjust the raw ccd counts after overscan subtraction by multiplying this correction factor ( cf ) to the processed electron counts on a pixel by pixel basis : @xmath28 any image pixel corrected to values over 50,000 electrons is capped artificially at that value , as this non - linearity correction is not reliable for such large corrections and one can assume these pixels are saturated .",
    "after overscan subtraction , the image is trimmed to active ccd pixels and zero now represents the average level of the overscan regions . assuming a flat - field of the pixel - to - pixel response has been created ( see  [ sec : mflat ] ) , the image is normalized directly by the pixel flat .",
    "the ccd gain is measured by assuming gaussian statistics in pairs of flat - field images , and is applied (  [ sec : mflat ] ) so that all ccd images are converted from digital counts ( adus ) to electrons measured .",
    "we estimate the error on each pixel and report this as the inverse variance : @xmath29 .",
    "the first estimate of this error is an approximation based solely on the measured number of electrons in each pixel as well as the global estimate of the readout noise in electrons .",
    "gaussian statistics dictates that the variance is simply the number of counts in the expectation . for faint sources ,",
    "the data provide only a very noisy estimate of the count rate .",
    "more importantly , one encounters a large systematic bias in the estimated error as the counts approach zero .",
    "in addition , the shape of the likelihood function starts diverging significantly from a simple gaussian which is assumed in the rest of the pipeline . in order to ameliorate these effects",
    "we approximate the variance with this function : @xmath30 where image(e@xmath31 ) is the observed number of electrons and rn is the image readout noise measured in electrons . at very small image(e@xmath31 ) values , this approximation avoids having unreasonably small variance values . the final correction is simply an addition in quadrature with the variance added by using a pixel flat .",
    "this correction can be minimized by taking a long series of flat exposures .",
    "the last step in the processing is to identify bad rows , passed in with the badrows keyword and subsequently set the inverse variance to 0 . for mike , the first two and",
    "last two rows of each ccd seem to always carry excess counts and are flagged with zero inverse variance ( zero weight ) by default .",
    "in this section , we describe the flat - field calibration frames and the algorithms which process and analyze these data .",
    "we use the frames for a variety of purposes , including ( 1 ) classic  pixel flats \" for image correction of relative pixel - to - pixel ccd response , ( 2 )  trace flats \" for definition of the spatial echelle order boundaries , and ( 3 )  slit flats \" for the characterization of the spatial profile of a uniformly illuminated slit in each echelle order .",
    "we describe the implementation of each of these steps in detail below .",
    "the first flat - field calibration routine , mike_mkmflat , produces a relative pixel flat - field image for both the blue and red cameras .",
    "the routine is straightforward : we use a stack of mike images obtained with the ` milky diffuser ' in the beam directly behind the slit to obtain smooth flux distributions in both the spatial and spectral directions ( these frames are referred to as milky flats ) . the practice of acquiring and analyzing a milky flat for pixel - to - pixel variations contrasts with standard practice in echelle spectroscopy .",
    "it has several advantages .",
    "first , we can correct for pixel sensitivity variations at and beyond the slit edge .",
    "this allows us to include several pixels at the slit edge boundary during sky subtraction and extraction .",
    "second , stray light ( including ghosts ) which often exhibits sharp features at random angles with respect to the echelle orders is smoothed out and its effects are minimized .",
    "third , it is easier to calibrate larger defects in the ccd and especially defects which partially cover an echelle order .",
    "finally , one is assessing the pixel - to - pixel quantum efficiency with the same color light as the science exposures .",
    "ideally , a stellar source is used in the blue milky flat to maximize counts at 3300and the internal flat - field lamp is used in the red to minimize the effects of sharp features ( e.g.  from atmospheric absorption features ) .",
    "each milky flat image is processed as described in @xmath32  [ sec : proc ] and the stack of images is co - added to produce a single milky flat image for each ccd ( a separate set of milky flats is required for each ccd binning used during data acquisition ) .",
    "we remove the large - scale flux variations as a function of position on the ccd ( the routine default is to resample at the 256 native pixel scale ) .",
    "then we apply a standard median filter in 1-dimension along ccd columns",
    "( in the spectral direction with a default width of 45 native pixels ) , on the assumption the calibration source has no small scale spectral features .",
    "this assumption breaks down for astrophysical sources with strong atmospheric telluric absorption bands observed with the red ccd .",
    "a 2-dimensional median filter ( default median box is 9 native pixels on a side ) is applied to the normalized milky - flat image processed above , and serves as a proxy for a model with which to reject the strongest features in the flat - field .",
    "normalized milky - flat pixels are masked if they or a neighbor inside the median box size deviate by more than 3% .",
    "finally , these masked pixels are replaced with a smoothed version of the normalized flat ( with masked pixels given zero weight , and a 2-d smoothing length of twice the median box ) .",
    "the processed milky - flat is normalized by this final smooth image to effectively remove the remaining large - scale fluctuations and the resulting image is stored as the normalized pixel - to - pixel flat . in figure",
    "[ fig : mflat ] , we show an example of the normalized flat - field of the red ccd in the middle panel . the co - added milky - flat image is shown before ( left panel ) and after ( right panel ) applying the processed pixel flat .",
    "one will notice that there are a large number of  pock \" marks ( moderate flat - field features ) on the red site ccd and the original blue site ccd .",
    "they cover about 40 native pixels each and have an areal density of 5000 pixels per ccd . reconstructing the pixel - to - pixel response",
    "as shown in figure  [ fig : mflat ] is limited by a systematic error of approximately 1% per pixel .",
    "the statistical uncertainty in the pixel flat is saved , and applied to the statistical error ( the inverse variance ) on all images when the pixel flat is applied .",
    "we calculate the gain between pairs of milky flats , with the estimator provided below .",
    "it is calculated from each pair of milky flats in sequence and the mean value is recorded for each image taken with this setup .",
    "a comparison image is made from the two flat images , @xmath33 and @xmath34 , as such :    @xmath35   \\cr 1 / < gain > = & variance(image ) .\\end{aligned}\\ ] ]    for a series of @xmath36 milky flat images , @xmath37 sequential pairings are analyzed , and the mean gain calculated from the @xmath37 pairings is used as the gain for all of the images being processed ( with appropriate binning and side ) .",
    "a short set of direct flat images ( without the diffuser behind the slit ) is used to both define the echelle order boundaries and the relative spatial cross - section of the slit profile .",
    "the source can either be a short exposure of the internal flat - field lamp or the twilight sky .",
    "the internal lamp is better suited for defining the order boundaries , and the twilight sky provides a better direct illumination of the focal plane .",
    "slit in pixels ( binned 2x from the native @xmath38 m pixels ) as a function of echelle order .",
    "the lower curves do not take into account the tilt of the slit , i.e.  it represents the slit length projected onto the rows of the ccd .",
    "the upper curves account for the tilt of the slit in the ccd frame .",
    "the bars indicate the variations within a given order .",
    ", width=336 ]     to 1 .",
    "the right - hand panel shows the pca coefficients as a function of echelle order .",
    "the code fits a 2nd order polynomial to the first pca coefficient in order to interpolate bad echelle orders or extrapolate to overlapping orders or regions with faint signal .",
    "one notes that the coefficients are essentially constant for pca coefficients 2 - 5 .",
    ", width=336 ]    as with the milky flats images above , a series of direct flat images are combined to yield a cleaned red and blue direct flat image , which we refer to as the combined  trace flats \" .",
    "the peaks in each trace flat image are located after applying a sawtooth filter in the spatial direction ( along rows ) .",
    "this procedure effectively locates the 50% level of both the left ( positive peaks ) and right ( negative peaks ) edges of the echelle orders in the trace flat images .",
    "echelle orders in which 90% or more of the order was traced along the length of the ccd are considered good , and used to predict the edges of the remaining order .",
    "we then calculate the center and width of each echelle order , which are functions of ccd row number .",
    "the order width varies very slowly across the ccd array ( see figure  [ fig : slitlen ] ) , and can be described by a 2-dimensional polynomial which is linear with respect to row number and quadratic with respect to order number .",
    "we fit the order center with a legendre polynomial as a function of ccd row number .",
    "we then use standard pca analysis @xcite of these order centers by searching for the principal components in the polynomial coefficients that describe the central column positions of the good orders .",
    "an example of these normalized basis functions are shown in figure  [ fig : pca ] in the left - hand panels ( above and beyond the 0th order shape which is simply the mean order position on the ccd ) .",
    "the linear combination of the functions when multiplied by the smoothly varying coefficients shown in the main panel of figure  [ fig : pca ] accurately describe the order centers ( for all rows and all orders ) on the ccd .",
    "to predict the locations of the remaining orders which fall on the ccd , but which had poorly defined edges , we simply use the extrapolated coefficients based on the fits to the well defined order centers .",
    "figure  [ fig : trace ] shows an example of the order definition for a trace flat observed with the blue camera .",
    "one might consider a slightly more simple procedure which is to extrapolate the polynomial coefficients describing the order centers as a function of order number .",
    "this usually produces unsatisfactory results due to the highly correlated condition of the coefficients .",
    "the principal components are defined to be orthogonal by definition , and the variation of each coefficients can be reliably extrapolated independently of the others . in the upper right corner of figure  [ fig : trace ]",
    ", one notes order traces extrapolated into regions with nearly negligible flux . the decomposition of the left and right edges into order centers and order widths produced very reliable edge definitions , and allows for automated localization of the orders with no human interaction .",
    "the pipeline routine responsible for determining the edge positions is called , mike_edgeflat , which produces an order structure with the prefix : ostr _ in the flats directory .",
    "the most involved correction derived from the flat - field calibrations is the slit profile correction , which we refer to as the  slit flat \" .",
    "once the echelle orders have been defined , and the wavelength image has been created from arc frame images ( see @xmath32  [ sec : arcimg ] ) we can measure the relative throughput of the spectrograph as a function of position along the 5@xmath3 slit length .",
    "although simple in principle , we invoke a number of steps in order to reliably measure the slit profile . in the case of no correction , a spatially uniform source ( like the dark night sky ) , would exhibit no change in the measured flux as a function of slit position . in order to correctly model the slit profile",
    ", the counts must approach zero in the gaps between the orders .",
    "a smooth scattered light image is constructed by fitting to the empirical counts in ccd pixels not associated with any echelle orders .",
    "the routine ( x_modelslit ) fits the scattered light row - by - row with 8 legendre polynomial coefficients .",
    "each pixel in the trace flat is assigned three values in addition to the counts measured in the combined direct flat : order number , relative wavelength ( recorded in pixels ) , and spatial slit position .",
    "the first two numbers are derived by the wavelength calibration procedures in the next section .",
    "the spatial slit position is measured as a quantity called slit fraction , which is normalized between -1 and + 1 , where -1 represents a pixel position exactly at the left edge of the slit - length , + 1 is the right edge , and 0 is a pixel at the exact center of the slit .",
    "more precisely , these values are in units of half slit - length ( hsl ) .",
    "a relative wavelength is given to each pixel by correcting for the tilt of the slit in the spectral direction and distance from the order center .",
    "order by order , the counts in each pixel are normalized by fitting a b - spline set of coefficients as a function of relative wavelength to the pixel counts in the central 70% of the slit ( @xmath39 ) .",
    "the b - spline breakpoints are separated by 1.2 ccd pixels in the spectral direction , which is sparse enough to suppress the high - frequency noise but dense enough to fit real spectral features in the twilight sky .",
    "the smooth b - spline spectrum is evaluated at all pixels falling in the current order , and the counts in each pixel are normalized by this evaluated fit . in addition , the inverse variance in each pixel is scaled accordingly to preserve the reported signal - to - noise in each pixel ( figure  [ fig : slitflat ] ) .",
    "now the spatial profile in each echelle order is fit in two steps .",
    "the first step is to fit the mean profile , which is accomplished by fitting a single b - spline function to all of the normalized counts in the order as a function of slit fraction .",
    "the b - spline is evaluated at unit intervals of 0.01hsl and stored from @xmath40 to + 1.25hsl .",
    "the 251 samplings of the mean profile per order is stored in the structure with the tag profile0 .",
    "any trend as a function of wavelength is fit with a linear dependence of row number and a b - spline fit to the residuals of the normalized trace flat about the mean evaluated b - spline .",
    "the typical linear deviations are around the 10% level along the length of a single order .",
    "these linear coefficients are sampled at the same 251 slit positions and stored as profile1 .",
    "one can reconstruct the appropriate slit profile for all rows in the order , for instance , the bottom row is given by profile0 - profile1 and the top row by profile0 + profile1 .",
    "the slit profile in each echelle order and the gradient of the profile with respect to position along the order are used to correct the spatial flux profile of the night sky before object extraction .",
    "the slit profile is not applied directly , given the low s / n region beyond the order boundaries , but rather the profile is used in the model basis of the sky background .",
    "we do find a difference in the recovered slit profile when a direct flat of the internal calibration lamp is compared to results of a direct flat of the twilight night sky .",
    "there is a significant linear gradient across the extent of the slit in the internal lamp images because of non - uniform illumination , and this slope is removed in the stored profile .",
    "this section describes the series of algorithms that calibrate the wavelengths for every pixel that falls within the echelle footprint . following standard practice ,",
    "the wavelength calibration is derived from the spectrum of a thar lamp observed with the same setup as the science exposures . while the spectrograph in standard observing mode does not physically move , and",
    "so does not have flexure , the spectrum can move on the ccd by several native pixels over a night due to changes in the temperature of the air , glass , and metal in the spectrograph .",
    "coeval calibrations are therefore important .",
    "below , we will describe both the calibration of individual thar spectral images ( `` arcs '' ) and the strategy we employ for obtaining shifts in the echelle footprint over a night , and between science exposures and their `` coeval '' thar exposures .",
    "our approach to wavelength calibration differs from standard practice in that we generate a 2d wavelength image from each arc frame . to do so , we begin by deriving a 1d wavelength solution along the spatial center of each echelle order",
    "we then trace the tilt of the thar lines out to the spatial edge of the order , and finally propagate the 2d solution for all pixels that fall within an order .",
    "it is worth noting that the tilt in the wavelength solution is advantageous to the data analysis in that it improves the sampling of sky lines , particularly near the nyquist limit ( i.e.  narrow slit ) .",
    "our specific treatment of this tilt is necessary because the tilt varies along and between echelle orders , and must be measured and accommodated across the full 2d spectrum to accurately subtract sky lines and extract the data .      an internal thorium - argon ( thar ) hollow cathode lamp",
    "is used to obtain the required intensity and line density as a function of wavelength for calibration .",
    "when an arc image is taken , the switch that turns on the lamp also moves a small mirror into optical path between the telescope and the slit plate , blocking the light from the sky and allowing an f/11 image from the lamp ( a bright spot , roughly 1 cm in diameter ) to be projected onto the slit instead .",
    "this configuration is difficult to miss in the picture displayed by the slit - viewing camera and , as such , acts as a convenient safety feature for distracted observers who might otherwise take an arc simultaneously with a science exposure .",
    "an exposure of 1 - 5 seconds provides sufficient lines for calibration of the full spectral range for all slit widths ( 0.352 arcsec ) .",
    "our standard calibration template includes 12 lines in the bluest orders and 2030 lines per order over most of the optical range .",
    "strongly saturated lines dominate the appearance of the arcs around 7500 . these do bleed electrons into neighboring columns , but they do not pose a calibration problem .",
    "a bigger issue is that the useful lines for calibration in the reddest orders ( @xmath41 , red order number less than 44 ) are fairly weak .",
    "exposure times on the red side should be dictated by these weak lines if the reddest orders are of scientific interest .    in this pipeline ,",
    "all wavelength calibrated data is converted from in - air wavelengths to vacuum wavelengths by default .",
    "it is important to realize that the change in the photon wavelength when traveling through a medium is a function of wavelength , unlike a doppler shift , so that this conversion will affect any analysis , even if a doppler shift is allowed . ,",
    "and in a medium of index , @xmath42 , is @xmath43 . for air , @xmath44 , in which @xmath45 @xcite . ]",
    "this conversion can be avoided , as desired , but the reason for making vacuum wavelengths the default is that while optical  wavelength lines are typically discussed at `` in - air '' wavelengths , uv  wavelength lines are always discussed at `` in  vacuum '' wavelengths .",
    "consequently the standard for galaxy and stellar spectroscopy is in ",
    "air wavelengths , while the standard for qso absorption line observations is in - vacuum . to understand the implications of this conversion",
    ", it is important to think about how the lines are produced and how the data are recorded .",
    "first , the photons from both astronomical sources and calibration lamps are produced in a vacuum , travel in air through the spectrograph , and are detected in a dewar under vacuum .",
    "the wavelengths designated to the lines in the arc spectrum will determine the definition of the wavelength calibration , and it will be appropriate for both astronomical sources and calibration lamps .",
    "if the line list for the arc lines gives in  air values , then the calibration is in - air and must be converted to vacuum to discuss uv wavelength lines .",
    "the first algorithm follows standard practice for echelle reduction .",
    "we perform basic overscan and bias subtraction and then flatten the blue ccd as described in the previous sections . with the red ccd , however , we skip the overscan subtraction ( although the average value is written to the bias row ) because the very bright arc lines near above 7500  tend to bleed into the overscan region .",
    "the code then calculates the image shift between the arc frame and the trace flat solution as described below .    for every echelle order , the code performs a pseudo - boxcar extraction by rectifying the order with linear interpolation and extracting the central column of each order",
    "the individual order extractions are stitched together to create a single array .",
    "this array is cross - correlated against the same construction from an archived , calibrated image using an fft algorithm .",
    "the peak in the fft sets the shift between the stitched 1d arcs of the archived and new arc images .",
    "the derived shift is then used to identify the physical order numbers of the new arc and to also predict the average shift in the spectral direction ( e.g.  due to changes in the echelle angle ) .",
    "each echelle order is then analyzed individually .",
    "its 1d spectrum is cross - correlated with an fft to the single - order 1d archived spectrum to improve the precision of the spectral shift .",
    "the code then derives a wavelength solution for the new 1d spectrum assuming the archived solution with the derived offset .",
    "the algorithm then identifies all thar arc lines using a peak finder which demands a high signal to noise ratio ( snr ) and a ` pointed ' feature whose fluxes in the central five pixels @xmath46 are appropriately rank ordered ( @xmath47 ) .",
    "those lines that satisfy this rank ordering and lie within three binned pixels of a laboratory - calibrated thar line are centroided and recorded .",
    "the line centroid is measured by ( i ) splining the flux of the central seven pixels , ( ii ) evaluating the peak of the spline , ( iii ) identifying the left - hand and right - hand edges of the spline corresponding to 33% of the peak , and ( iv ) averaging the two edges to derive the centroid .",
    "this algorithm is non - parametric and robust .",
    "the result is a high snr subset of thar lines with measured pixel centroids and known laboratory wavelengths .",
    "the code then performs a low order , legendre polynomial fit with aggressive rejection to the pixel values versus the logarithm of the laboratory wavelengths . by imposing the logarithm of the wavelength ,",
    "one significantly reduces a systematic bias which favors long  wavelength lines .",
    "this is less important for individual echelle orders ( where the wavelength range is only @xmath48 ) , but it is critical for the 2d polynomial fit described below .",
    "finally , the code again searches for thar lines in the 1d spectrum but using this fit for the wavelength solution and also allowing lines with lower snr in the image .",
    "a final 4th or 5th order legendre polynomial fit is derived , again with aggressive clipping .",
    "the final output for each order includes the 1d spectrum and the pixel centroids and thar wavelengths of all the ` good ' thar lines that were not rejected during the legendre polynomial fits .",
    "figure  [ fig : wav1d ] presents the residuals for legendre fits to echelle orders 75 to 80 from the blue camera of mike . in nearly every individual order",
    ", we achieved line residuals of rms@xmath49pix and a fit solution with rms@xmath50pix independent of binning .    4 ,",
    "two - dimensional legendre polynomial fit with bases of ccd row and echelle order number .",
    "the blue curves trace the wavelength values , echelle order by order , as a function of ccd row .",
    "the +-signs indicate the values of individual thar lines offset from the 2d solution by 500@xmath51 their residual .",
    "( lower ) similar to figure  [ fig : wav1d ] except the fit here corresponds to the 2d solution derived for the full image .",
    ", title=\"fig:\",height=336 ] 4 , two - dimensional legendre polynomial fit with bases of ccd row and echelle order number .",
    "the blue curves trace the wavelength values , echelle order by order , as a function of ccd row .",
    "the +-signs indicate the values of individual thar lines offset from the 2d solution by 500@xmath51 their residual .",
    "( lower ) similar to figure  [ fig : wav1d ] except the fit here corresponds to the 2d solution derived for the full image .",
    ", title=\"fig:\",height=336 ]    the next algorithm performs a 2d fit to all of the good thar lines for all of the echelle orders .",
    "the algorithm inputs the pixel ( row number of the line centroid ) , wavelength , and echelle order for each fitted line .",
    "it then performs a 2d legendre polynomial fit @xmath52 to the product of the arcline wavelength @xmath53 and its echelle order @xmath54 as a function of ( i ) the echelle order number and ( ii ) the row number @xmath55 ( e.g.  http://iraf.noao.edu/ ) @xmath56 with this basis , a well - behaved fit can be derived with 20 parameters ( four spectral and five along the prism dispersion [ @xmath57 ) ; the typical rms is @xmath58(  order # ) . by performing a 2d solution , one more confidently interpolates ( and occasionally extrapolates ) over regions of the arc image where there is a low density of calibrated thar lines .",
    "this is particularly important at the reddest wavelengths where there are many fewer lines for analysis .",
    "the resulting 2d fit describes the wavelengths along the center of each echelle order on the ccd .",
    "figure  [ fig : wav2d]a shows the full 2d solution for one example image as a function of row number .",
    "figure  [ fig : wav2d]b shows the solution for a subset of echelle orders and the measured rms of the fit .",
    "again , we generally achieve residuals of rms  @xmath59pix ( binned ) in each echelle order for the 20 parameter legendre polynomial . using the 2d solution",
    ", we can calculate the dispersion as a function of wavelength over the entire footprint of spectrum . in figure",
    "[ fig : wavdisp ] , we present the wavelength dispersion of the spectrometer as measured for an unbinned spectrum ( native pixels of 15@xmath10 m ) .     for the native ccd pixels , scaled by 1000 , for the red - side ( top ) and blue - side ( bottom ) cameras of mike .",
    "the black regions designate the 1st order blaze for each echelle order ( ranging from number 71 to 106 on the blue side and 37 to 70 on the red side ) . , title=\"fig:\",height=336 ]   for the native ccd pixels , scaled by 1000 , for the red - side ( top ) and blue - side ( bottom ) cameras of mike .",
    "the black regions designate the 1st order blaze for each echelle order ( ranging from number 71 to 106 on the blue side and 37 to 70 on the red side ) .",
    ", title=\"fig:\",height=336 ]          the algorithms discussed in the previous section generate a 2d legendre polynomial fit describing the wavelength value down the center of each echelle order .",
    "we now describe the algorithms which extend the wavelength solution throughout the full echelle footprint .",
    "the algorithms first identify and trace all high s / n arc lines in each order across the chip . in this manner",
    ", we measure the tilt of the lines as a function of wavelength and echelle order .",
    "specifically , we identify all 5 sigma peaks in the spectrum , independent of whether the peak corresponds to a well - calibrated thar line .",
    "we then trace the centroid of each line from the center of the order to the order edges using the idlspec2d algorithm _ trace_crude_. we found that each arc line is well described by a straight line ( i.e.  a slope ) ; the code measures and records the best - fit slope for each arc line .",
    "figure  [ fig : tilt ] presents the measured slopes for the thar lines as a function of ccd row in several echelle orders ( blue camera ) . in general",
    ", one has over 30 lines per echelle order for analysis .",
    "it is evident that the arc - line slopes vary across each echelle order .",
    "this is because the quasi  littrow angle ( @xmath60 ) changes as a function of position in the focal plane .",
    "similar to the analysis of the thar wavelengths , we fit a 2d legendre polynomial to the slopes of the arc lines across the full ccd .",
    "this 2d solution enables one to interpolate through regions of the ccd with a lower density of thar lines .",
    "together the wavelength values and arc line tilts at the center of each order is sufficient for assigning a unique wavelength to the center of every pixel on the ccd that falls in an echelle order footprint .",
    "this is done for all applicable pixels and a wavelength image is written to the disk for each arc frame .",
    "we do not solve for the case when orders overlap and assume a unique wavelength value for each pixel in the image .",
    "this wavelength image is calibrated in air and is stored with logarithmic values . by default ,",
    "the pipeline associates each scientific exposure with the wavelength image whose arc frame has the smallest difference in ut time from the start of each exposure .",
    "we do not interpolate between arc frame exposures , and simply use the nearest exposure in time .",
    "as described in @xmath32  [ sec : design ] , the footprint of the mike spectrometer is observed to shift throughout the course of the night , presumably because of thermal changes .",
    "therefore , the footprint which is traced by the flats acquired in the afternoon ( @xmath32  [ sec : tflat ] ) is generally offset from the one observed during the night .",
    "we measure this shift from the inner 17 orders using an algorithm similar to the one which measures the slit profile ( @xmath32  [ sec : slitprof ] ) . in this case , however , the algorithm is applied to the arc images . as with the slit profile",
    ", one must first have a good estimate of the slit tilt throughout the image .",
    "therefore , the steps described in the prior two subsections are first applied to one arc image ( the slit tilt does not vary significantly as the image shifts ) .    in each order",
    ", the code collapses all pixels with signal greater than 10 electrons as a function of distance from the center of the slit , normalized to @xmath61 by the average order width .",
    "we then measure the center of the arc profile by identifying where the flux dips to @xmath62 of the peak on each side of the profile and average the two edges .",
    "this center is compared with zero and gives the shift in pixels of the image parallel to the rows ( the shift along the columns is negligible ) .",
    "this process is performed on the 17 central orders and the best linear fit to the shift as a function of order number is found .",
    "the parameters of this fit are recorded in the main structure ( in the arc_xyoff tag ) and are used to shift the archived footprint onto the science and arc images .",
    "the final phase in the reduction of two - dimensional ccd images to 1-dimensional spectra involves the final localization and extraction of a single object in each mike exposure .",
    "the first step involves the tracing of the object , the definition of the object position with respect to the spatial position of the echelle orders . a first estimate of the local sky background is calculated by masking pixels within the object aperture ( default is the central 3.75@xmath3 of the 5@xmath3 slit ) and those with a slit profile value below 30% .",
    "the remaining steps incorporate an iterative series of object profile reconstruction as a function of wavelength and echelle order , slight tweaking of the initial object position given the mean object profile in each order , and finally , combined object and background extraction .",
    "once the echelle orders have been defined by the trace flat images , we determine the best spatial shifts from the traceflats to the appropriate arcframe associated with each science image ( see  [ sec : shift ] ) . each echelle order in the science frame",
    "is rectified ( just for the object tracing ) with the shifted order boundaries .",
    "the rectified order is collapsed along columns with median smoothing to reject unflagged cosmic rays and bad pixels . in the collapsed vector of each order",
    ", we locate the most significant peak within the slit and associate the fractional position between the order boundaries as the first guess for the location of the object where 0.5 corresponds to the center of the slit - length .",
    "if the object is detected in seven or more echelle orders , the fractional positions in the undetected orders are predicted by a simple linear fit to the detected positions as a function of order number .",
    "the fractional positions for the rectified orders ( whether measured or predicted ) are converted back to ccd pixel coordinates on the original science image based on the shifted order boundaries .",
    "we measure the object peaks in each ccd row in each order by iteratively calculating a flux - weighted mean of the object counts .",
    "the peak measurement is unbiased for well sampled profiles , but is subject to ccd artifacts and sharp sky features .",
    "each set of object centers , called a trace , is fit with a 6th order legendre polynomial weighted by estimated errors in the flux weighted centroids ( with an additional floor of 0.01 pixel error added in quadrature ) . in the fitting procedure , centroids which deviate by greater than 10@xmath63 from the polynomial fit are masked .",
    "echelle orders in which less than 50% of the measured centroids are rejected are considered useful for a subsequent pca analysis ( similar to the order - tracing analysis described in  [ sec : tflat ] ) . the polynomial coefficients from 1st to 6th order of the well constrained echelle orders",
    "are combined into orthogonal eigenfunctions .",
    "the useful traces are checked to see if their eigenvalues ( pca coefficients ) agree with simple interpolated predictions of the other traces .",
    "the worst outliers with a 1 pixel deviation in the primary eigenvalue or a 0.3 pixel deviation in the secondary eigenvalue level are rejected .",
    "the remaining eigenvalues are fit as a function of echelle order with low - order polynomials to predict the previously rejected traces , with a quadratic fit to the leading eigenvalues and a linear fit to the secondary eigenvalues .",
    "the remaining coefficients are simply replaced with the median value of all the good values .",
    "quasar as a function of echelle order for both the blue and red - sides of mike .",
    "the plus signs show the measured fwhm of the spatial profile in arcseconds assuming a gaussian profile .",
    "the systematic increase is primarily due to atmospheric effects .",
    "the diamonds and colored curves show the measured position of the object along the slit where 0.5 refers to the center of the slit - length .",
    "note that at echelle orders beyond 85 , the quasar exhibits no significant flux and our algorithm extrapolates the object centroid .",
    ", width=336 ]    we calculate the mean trace position ( the average spatial position of each trace over all rows ) with the following steps .",
    "first , we remove the high - order variations ( tilt , curvature , etc . ) by summing up the contributions from 1st order to 6th order and subtracting the sum from the measured mean trace position .",
    "second , the best quadratic fit to the mean residual trace positions are found , and the higher order contributions ( orders 16 ) are added back . the result is a trace of the object in each echelle order that relies on the principal components of the well traced orders and smooth fits to these coefficients . finally , we perform a last iteration and allow the traces which have sufficient signal - to - noise to adopt the empirically determined trace centers .",
    "object traces with low signal - to - noise or partial orders retain the interpolated values derived above .",
    "we show how the object trace can move relative to the center of the echelle order positions as the bottom set of open diamonds in figure  [ fig : fwhm ] .",
    "the routine invoked for object tracing is called mike_fntobj .",
    "an example of the final determined positions for an object observed with mike is shown in figure  [ fig : trcobj ] .",
    "quasar ( black indicates high intensity ) .",
    "overplotted on the image is the trace of the spatial center of the object profile as determined from a pca analysis of the full 2d frame .",
    ", width=336 ]      the next step in object extraction is to estimate the sky background as a function of wavelength and echelle order number . because this estimate is only used to derive the spatial profile of the object psf , accurate fitting of narrow emission lines is not critical .",
    "some fraction of the background arises in diffuse scattered light , and this is estimated by interpolating the pixel counts in the gaps of the echelle orders to all of the ccd .",
    "once the scattered light estimate has been subtracted , the remaining sky background is fit in each echelle order .",
    "a subset of the pixels in each order are used if they fall at least 1.9@xmath3 from the object centroid and have a slit profile value greater than 30% . for standard stars ,",
    "the default is to only use pixels at least 2.25@xmath3 from the object , although one is recommended to skip sky subtraction for very bright targets .",
    "the pixels designated from sky estimation are corrected by their corresponding slit profile values .",
    "these corrected pixels are then fit with a b - spline as a function of wavelength using the wavelength image map calculated in ",
    "[ sec : arcimg ] .",
    "the breakpoints defining the b - spline function are spaced with a separation of 1.2 times the local wavelength dispersion per pixel . after the b - spline fit has converged ,",
    "sky subtraction is as simple as evaluating the b - spline function for all pixels in the echelle order , correcting by the slit profile ( multiplying ) and subtracting the product from the scattered - light subtracted image .",
    "the routine that performs the initial sky - subtraction on all science images is called mike_skysub .    at this stage of the reduction",
    ", we finally have a fully characterized science image ( i.e.  flat - fielded , traced , wavelength calibrated , and background subtracted ) , and can perform optimal extraction in the empirical sense ( e.g. * ? ? ?",
    "* ) once the object profile is characterized as a function of wavelength . with higher signal - to - noise spectra",
    ", we can determine subtle variations in the object profile .",
    "below is the set of steps we follow to characterize the object profile which is then used to optimally extract the 1-dimensional spectrum in each echelle order . the list below is repeated iteratively for a default of three times , but can be set by the user when invoking the extraction algorithm mike_box .",
    "the first step is a standard boxcar extraction in each order , using an aperture with a default spatial extent of 3.5@xmath3 centered on the object trace .",
    "the boxcar extraction , along with the associated variance array , is stored in the final object extraction structure .",
    "the median signal - to - noise ratio ( msnr ) is calculated for the boxcar spectrum in each echelle order , and after this point , the orders are processed in order of decreasing msnr .",
    "the boxcar extraction is median smoothed and compared to the original spectrum to identify cosmic rays and other deviant spectral pixels .",
    "the non - deviant pixels are fit with a b - spline function with a breakpoint spacing that is twice the local pixel dispersion ( i.e.  every 2 spectral pixels ) . in this step",
    ", we are fitting for the spatial profile , so we normalize each ccd pixel in the 2d image by the boxcar extracted counts at the appropriate wavelength ( the bspline function representing the boxcar extracted flux is evaluated at every pixel in the order footprint ) .",
    "the pixels in the resulting normalized image have , by definition , a total spatial cross - section of unity in the boxcar region .",
    "this definition is one method to tie the optimally extracted fluxes to the same system as the boxcar extracted values .",
    "the object profile is fit with one of three methods based solely on the msnr determined for that echelle order .",
    "if the msnr is less than 2.5 , then a uniform gaussian profile is adopted with a fixed width .",
    "if at least 2 higher msnr orders have been extracted ( earlier in the processing ) , then the width of the gaussian profile is extrapolated from the processed orders .",
    "if an estimation of a width based on other profiles is not available , then a fixed width of 0.7@xmath3 is assumed ( comparable to the median seeing at las campanas ) . if the msnr is greater than 2.5 , then a gaussian is not assumed , and a full spatial profile is fit .",
    "if the square of msnr is greater than 500 , then the spatial profile is allowed to vary as a quadratic function of wavelength along the order .",
    "otherwise , a uniform profile is fit to all pixels in the order . even in the high msnr case ,",
    "a uniform profile is fit to the order , but the full variable profile is used in object extraction .",
    "the full - width , half - maximum ( fwhm ) is calculated empirically from the uniform profile and is used as a prior for subsequent lower msnr orders . in figure",
    "[ fig : fwhm ] , the calculated and extrapolated estimates of the spatial fwhm are shown as a function of echelle order .    ) is determined empirically by locating the points of half - maximum in the mean order profile .",
    ", width=336 ]    the biggest difficulty with an empirical determination of the object profile are the wings of the profile .",
    "these need to be well behaved to perform accurate extractions . in this implementation , we specify a separation from the object centroid , past which we extrapolate an exponentially decaying wing .",
    "the separation increases as a function of msnr , such that higher msnr orders require less extrapolation . to extrapolate , we find the best linear fit to the logarithmic profile as a function of spatial distance from the object centroid .",
    "we perform the extrapolations on left and right sides of the profiles separately and in each case we fit to the shape of the profile from the half - maximum to the cutoff distance determined by the msnr above .",
    "this procedure is very robust in practice and delivers realistic wings for the object profiles .",
    "the slope of the extrapolation is forced to be less than @xmath64 , because a higher slope would not have finite flux if extended to infinity . in figure",
    "[ fig : profile ] , we show an example of the object profile determined in a single mike echelle order . the ticks denote the extent of the scatter in the normalized image counts , while the solid lines represent the spatial object profile fit as described by a b - spline .",
    "just before the actual extraction occurs , we perform a check and correction to the object tracing .",
    "now that we have a well determined empirical profile for the order , we test the correlation of the profile at the current position compared to shifting the profile one pixel left or right .",
    "this check is done at each row in the echelle order , and we apply a smooth fit of the deviation away from zero offset .",
    "the trace correction is added to the object centroid array and is applied in the next iteration .",
    "330 ( see * ? ? ?",
    "the left most panel is the flattened , scattered light subtracted science frame .",
    "the 2nd and 3rd panels show the two - dimensional models of the object and sky spectra , respectively .",
    "the right most frames show the residuals about the best fit models , which are close to the poisson limit in all pixels except the brightest sky features . , width=336 ]    extraction is performed by fitting in the least squares sense to the full echelle order footprint with a simple linear model :    @xmath65    where x is in units of hsl , and @xmath66 is wavelengths . os and ss are the object spectrum and sky spectrum , respectively , while op and sp are the previously determined object profile and slit profile , respectively .",
    "the extraction is a simultaneous b - spline fit of both the object spectrum and the sky spectrum .",
    "the breakpoints for each spline are separated by exactly the local wavelength dispersion . for a standard mike echelle order which is 2048 rows high ( spectral binning of 2 )",
    ", there will be approximately 4096 free parameters in the simultaneous b - spline fitting .",
    "we then search for pixels deviating by greater than 10-sigma , and mask those pixels as well as the 12 closest neighbors under the assumption that these are cosmic rays . during the final iteration ,",
    "one last b - spline fit is performed with the final masking , and both the object and sky splines are sampled with uniform velocity dispersion on a fixed wavelength grid to facilitate combining multiple science exposures ( figure  [ fig : extract ] ) .",
    "one can output the model fits of the two - dimensional sky image , object image and object profile .",
    "in this section , we discuss the procedures which combine and flux calibrate the extracted spectra ( in separate echelle orders ) . the end product is a continuous , 1d spectrum calibrated to energy units with a relative accuracy of better than @xmath67 over 100  spectral regions . in practice , this involves combining the multiple exposures of a single target , fluxing , and then coadding the individual echelle orders .",
    "we present separate discussions of fluxing and coaddition .",
    "spectra acquired with echelle spectrometers are notoriously difficult to calibrate in absolute flux units .",
    "this can be attributed to a number of factors : narrow slits , scattered light , vignetting .",
    "it is generally difficult to achieve even an accurate relative fluxing of the data ( e.g. * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "furthermore , little attention is given to this problem because the analysis of echelle data usually involves normalizing the object s continuum flux level prior to measuring the optical depth and/or equivalent width of spectral features . in this respect",
    ", fluxing is mainly a convenience but not a necessity .",
    "nevertheless , the mike instrument has several characteristics which make it better suited to accurately flux ( see the introduction ) .     for all wavelengths longer than 4000 . at bluer wavelengths",
    ", the mike spectrum underestimates the flux by an increasing amount due to the uncorrected slit loss and additional atmospheric extinction as eg  21 was observed at higher airmass than ngc  7293 ( am=1.36 vs.  1.1 ) .",
    ", height=336 ]    we implement algorithms which follow standard procedure to generate a sensitivity function from observations of a spectrophotometric standard .",
    "this sensitivity function converts measured electrons per second per   to flux units ( erg s@xmath68 @xmath68 @xmath69 ) .",
    "it is determined by comparing the electron flux of the spectrometric standard with its absolute , previously calibrated flux .",
    "no corrections are made for slit losses or atmospheric extinction .",
    "these efforts are relatively shallow functions of wavelength and should not substantially affect the relative flux on scales smaller than 100 .",
    "furthermore , if one observes the science objects and standard under similar seeing conditions and at similar airmass , then these losses will be partially corrected .    the only significant challenge that we faced is that no spectrophotometric standards have been observed at echelle resolution . as such",
    ", we found it impossible to derive an accurate sensitivity function in spectral regions corresponding to absorption features in the standard star ( e.g.  the balmer series ) . in low dispersion spectrometers , one can clip these features by fitting a low order polynomial to the sensitivity function . in echelle data , however , a strong balmer line can encompass one or more echelle orders .",
    "for this reason , one should observe calibration standards with weak absorption lines .",
    "we also designed a graphical user interface which enables the user to identify and mask out absorption features when generating the sensitivity function .",
    "this is generally successful , although systematic errors are significant when the features coincide with the peak or edge of an echelle order .",
    "but for feige  110 .",
    "these results are more typical of standard performance .",
    "there is mild echelle order mismatch , especially in the first @xmath70 orders of each camera .",
    "the relative flux is very accurate for data redward of 4000 , but is underestimated at lower wavelengths .",
    "this is the result of additional slit loss and higher airmass than the calibration standard .",
    ", height=336 ]    in figures  [ fig : eg21 ] and [ fig : feige110 ] we present the fluxed spectra of two standard stars observed on 02 september 2004 with a 1@xmath3 slit under photometric skies .",
    "we calibrated these stars ( as described above ) by generating a sensitivity function from the spectrophotometric standard ngc  7293 observed at 1.11 airmasses .",
    "the spectrum of eg21 ( figure  [ fig : eg21 ] ) represents a nearly optimal example .",
    "the flux in overlapping regions of echelle orders is well matched , the strong balmer lines have appropriate shape , and the relative flux matches the calibrated values @xcite to better than 5@xmath22 for @xmath71 . at bluer wavelengths ,",
    "the flux is underestimated because of additional slit losses and atmospheric extinction ; the star was observed at a higher 1.36 airmasses .",
    "the results for feige  110 ( figure  [ fig : feige110 ] ) are more representative .",
    "there is a modest mismatch in the flux of overlapping echelle orders , especially the first @xmath70 orders in each camera .",
    "the mismatch is less than 10@xmath22 , however , and the combined spectrum ( grey ) follows the ` true ' calibration .",
    "the relative fluxing is better than 10@xmath22 redward of 4000 , and the spectrum underestimates the flux at bluer wavelengths for the same reasons as eg  21 .",
    "we emphasize , however , that the relative flux is excellent over spectral regions of less than 100 .",
    "it is instructive to analyze the sensitivity function to investigate the blaze function and instrumental response of mike .",
    "figure  [ fig : blaze ] describes the blaze function , normalized to unit flux at peak , for the blue camera as derived from the sensitivity function .",
    "the blaze function profile is nearly constant with echelle order when plotted as a function of the free spectral range ( fsr ) .",
    "the shape is well modeled by a 9th order legendre polynomial . which is the default function form for fitting the sensitivity function , which is shown in figure  [ fig : sensitivity ] .    ) , then the blaze functions shown in figure [ fig : blaze ] are obtained . ,",
    "height=336 ]      there are two important aspects to producing a final 1d spectrum from a series of science exposures : the coaddition of multiple exposures and the combination of overlapping echelle orders .",
    "the specific ordering of our algorithms are : ( 1 ) coadd multiple exposures of each echelle order ; ( 2 ) flux the individual echelle orders ; and ( 3 ) combine the echelle orders to produce a final , continuous 1d spectrum .",
    "we prefer this ordering because it maximizes the signal - to - noise for combining echelle orders , whose blaze edges may have relatively low signal .",
    "furthermore , the instrument is sufficiently stable that one can successfully combine individual echelle orders from multiple nights in an observing run without fluxing first .",
    "the fluxing algorithms were discussed above ; we now detail the coadding procedures .",
    "we remind the reader that the spectra have been extracted onto a fixed wavelength grid .",
    "no rebinning is required and registration of the spectra is trivial .",
    "the combination of multiple science exposures of the same object is performed separately on each echelle order , in sequence of red to blue .",
    "the orders are averaged together , weighting by the square of the median s / n ratio after first flagging outliers ( generally due to low - level cosmic rays ) . to carry out this calculation ,",
    "one requires two quantities : ( i ) the median s / n ratio for weighting the data ; and ( ii ) a scale factor which normalizes the spectra to a common intensity .",
    "the latter is necessary for properly averaging data when clipping outliers .",
    "these quantities are calculated relative to a designated ` template ' exposure , preferably the frame with largest signal .",
    "all pixels with s / n  @xmath72 ( designated hsnpix here ) are identified in the template exposure .",
    "if there are over 100 hsnpix , then the median s / n is measured from these pixels .",
    "otherwise , the code adopts weighting factors based on the relative exposure times .",
    "the algorithm also calculates a scaling factor by comparing the fluxes of the hsnpix for each exposure relative to the template .",
    "figure  [ fig : hsnpix ] presents an example of the relative flux for echelle order 91 of the blue camera for a pair of 2400s exposures taken in sequence .",
    "we show only the hsnpix and have median smoothed by 100 pixels .",
    "the median s / n per pixel is 6 for the template exposure .",
    "the algorithm scales the data differently depending on the number of hsnpix .",
    "if there are over 300 hsnpix , a line is fitted to the relative fluxes ( median smoothed by 100 pixels ) as a function of wavelength and applied to the full spectrum ( figure  [ fig : hsnpix ] ) .",
    "if there are 100 to 299 hsnpix , then the scale factor is the median of the relative fluxes . for fewer than 100 hsnpix",
    ", we adopt the relative exposure times as the scale factors .    .",
    "the dashed red line shows a linear fit to the median smoothed ratio values .",
    "this is used to scale the spectra prior to coaddition .",
    ", height=336 ]    the median s / n and median scale factors are recorded for each echelle order , in turn .",
    "after all of the echelle orders are analyzed , the algorithm re - evaluates the two quantities for those orders with fewer than 100 hsnpix .",
    "the code takes the median values of the two quantities from the nearest 5 orders that have ( i ) greater than 100 hsnpix and ( ii ) lie within 10 orders , if these conditions are met .",
    "this is implemented primarily on orders where a very large absorption feature ( e.g.  a damped ly@xmath73  line ) has significantly depressed the s / n of a single echelle order .    after scaling the data ,",
    "the algorithm compares the scatter between multiple echelle orders with the scatter predicted from the variance array .",
    "as described in @xmath32  [ sec : proc ] , the variance array includes estimates of the uncertainties associated with counting statistics and read noise . in general , we find that the scatter predicted from the variance array is 10 to 20@xmath22 lower than the observed scatter in multiple exposures .",
    "this could be explained by a modest overestimate of the ccd gain , but the algorithms which derive the gain are proper .",
    "we suspect that the additional scatter is due to systematic errors introduced by flat - fielding , sky subtraction , and wavelength calibration .",
    "our solution is to scale the variance arrays of all the exposures of a given echelle order by a single factor . in this manner",
    ", we demand that the observed scatter is consistent with that predicted from the variance arrays assuming @xmath74 statistics .",
    "if there are three or more exposures then the code flags and excludes any pixels that deviate by more than 5@xmath63 from the median value .",
    "clipping is rare for optimally extracted data ( or short exposures of bright targets ) and it is not necessary to repeat this step . finally , the data are averaged with weights proportional to the median s / n squared .",
    "the resulting data product is a series of combined , individual echelle orders .",
    "these data are fluxed with the sensitivity function derived from a spectrophotometric standard , as described in the previous section .",
    "the final step is to combine the edges of overlapping echelle orders .",
    "again , no rebinning is necessary and registration is trivial because the data were extracted onto a fixed wavelength grid . in the previous sub - section , we noted that the relative flux of the overlapping spectral regions generally agree to within 10@xmath22 ( figures  [ fig : eg21],[fig : feige110 ] ) .",
    "therefore , we simply average the data , weighting by the variance of each pixel . aside from a small spectral region ,",
    "one of the echelle orders will dominate the signal in the overlap region .",
    "we have described the software package mikeredux designed and developed to reduce the echelle images produced by the mike spectrometer .",
    "this code is publicly available and its primary algorithms have been applied to data reduction for other modern spectrometers .",
    "while development of this package has halted , one of us ( jxp ) plans to release a python - based code following many of the procedures described here .",
    "the strategies and implementations discussed here are the result of many fruitful conversations with our colleagues .",
    "in particular , jxp acknowledges dan kelson for inspiring some of the algorithms described here during the time they overlapped at carnegie , and rab thanks steve shectman for the countless days spent discussing all aspects of ( and building ) mike .",
    "we further thank r. cooke for his comments and criticisms on a draft of the manuscript .",
    ", r. _ et al . _",
    "2003 , in instrument design and performance for optical / infrared ground - based telescopes .",
    "edited by iye , masanori ; moorwood , alan f. m. proceedings of the spie , volume 4841 , pp .",
    "1694 - 1704 ( 2003 ) ."
  ],
  "abstract_text": [
    "<S> this manuscript describes the design , usage , and data - reduction pipeline developed for the magellan inamori kyocera echelle ( mike ) spectrometer used with the magellan telescope at the las campanas observatory . </S>",
    "<S> we summarize the basic characteristics of the instrument and discuss observational procedures recommended for calibrating the standard data products . </S>",
    "<S> we detail the design and implementation of an idl based data - reduction pipeline for mike data ( since generalized to other echelle spectrometers , e.g. keck / hires , vlt / uves ) . </S>",
    "<S> this includes novel techniques for flat - fielding , wavelength calibration , and the extraction of echelle spectroscopy . </S>",
    "<S> sufficient detail is provided in this manuscript to enable inexperienced observers to understand the strengths and weaknesses of the instrument and software package and an assessment of the related systematics .    </S>"
  ]
}