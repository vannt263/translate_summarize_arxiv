{
  "article_text": [
    "radiation transfer ( rt ) has been long recognized as a indispensable ingredient in numerically simulating many astrophysical phenomena including the reionization of intergalactic medium ( igm ) in the early universe , radiative feedback during the galaxy formation , and others .",
    "so far , varieties of numerical schemes for solving the rt in three dimensions are proposed during the last two decades @xcite , and some of them can be coupled with the hydrodynamic simulations @xcite thanks to not only the increase of the available computational resources , but also the improvement of numerical algorithms to solve the rt in many astrophysical conditions .",
    "most of the numerical schemes for rt can be divided into two groups : one is the moment - based schemes which solve the moment equation of the rt equation instead of solving the rt equation directly , and the other is the ray - tracing schemes . as for the moment - based schemes , the important advantage is that the computational costs scale with the number of mesh grids , @xmath1 and hence can be easily coupled with hydrodynamic simulations .",
    "the flux - limited diffusion ( fld ) scheme , which adopts the closure relation valid in the diffusion limit , is the most common among the moment - based schemes , while there are a number of more sophisticated schemes which close the moment equations with the optically thin variable eddington tensor approximation @xcite and the locally evaluated eddington tensor ( the m@xmath2 model ) @xcite .",
    "the accuracy and validity of the moment - based schemes are , however , problem - dependent .",
    "for example , the fld scheme has a problem in handling shadows formed behind opaque objects @xcite .",
    "while schemes with m@xmath2 model are capable of simulating shadows sucessfully , they can not solve the crossing of multiple beamed lights , where the beamed lights unphysically merge into one beam @xcite .",
    "therefore , the ray - tracing schemes are naturally chosen for solving the rt in situations that we are considering in the studies of galaxy formation and cosmic reionization , in which there exist a number of radiation sources .    in ray - tracing schemes , emission and absorption of radiation",
    "are followed along the light - rays that extend through the computational domain . as for the long - characteristics schemes @xcite",
    "in which light - rays between all radiation sources and all other relevant meshes are considered , the computational cost scales with @xmath3 in general cases and @xmath4 when we consider only the rt from point radiating sources , where @xmath5 is the number of point sources . on the other hand , for the short - characteristics schemes @xcite which are similar to the long - characteristics schemes but",
    "integrate the rt equation only along paths connecting nearby mesh grids , the computational cost scales with @xmath0 in general and @xmath6 for the rt from point sources .",
    "ray - tracing schemes are in principle versatile for any physical settings but computationally much more expensive than the moment - based schemes .",
    "due to such huge computational costs , rt simulations with the ray - tracing schemes have been applied only to static conditions or snapshots of hydrodynamical simulations in a post - process manner in many previous studies .",
    "some of the ray - tracing schemes are now coupled with hydrodynamical simulations adopting smoothed particle hydrodynamics ( sph ) codes @xcite and mesh - based codes @xcite , and they can handle the rt and its hydrodynamical feedback in a self - consistent manner .",
    "majority of these radiation hydrodynamics codes , however , consider the transfer of radiation only from point sources and ignore the effect of radiation transfer from spatially extended diffuse sources , such as the recombination radiation emitted from ionized regions and infrared radiation emitted by dust grains , since the computational costs for computing the transfer of diffuse radiation is prohibitively large .    specifically , in the numerical rt calculations of the hydrogen ionizing radiation , we usually adopt the on - the - spot approximation in which one assumes that the ionizing photons emitted by radiative recombinations in ionized regions are absorbed by neutral atoms in the immediate vicinity of the recombining atoms .",
    "however , adopting the on - the - spot approximation can fail to notice the important effects of diffuse recombination radiation in some situations .",
    "the roles of ionizing recombination photons in the epoch of cosmic reionization is discussed by a number of works @xcite .",
    "@xcite proposed the recombination photons produced in the fast accretion shocks in the structure formation in the universe as an possible source of ionizing photons responsible for the cosmic reionization , though @xcite showed that its impact on the cosmic reionization is not very significant .",
    "it is also reported that the recombination radiation plays an important role at transition regions between highly ionized and self - shielded regions @xcite . as for the effect of recombination photons on the galaxy - size scales",
    ", @xcite showed that the recombination radiation produces the lyman-`bump ' feature in the spectral energy distributions of high-@xmath7 galaxies , and also that the escaping ionizing photons from high-@xmath7 galaxies are to some extent contributed by the recombination radiation . @xcite also pointed out that the recombination radiation makes the major contribution to the photo - ionization at regions where the gas is self - shielded from the uv background radiation .",
    "the rt of infrared diffuse radiation emitted by dust grains plays an important roles in the evolution of star - forming galaxies , in which the radiation pressure exerted by multi - scattered infrared photons drives stellar winds . in most of numerical simulations of galaxy formation ,",
    "however , such momentum transfer is treated only in a phenomenological manner ( e.g. okamoto et al .",
    "2014 ) .    in this paper",
    ", we present a new ray - tracing scheme to solve the rt of diffuse radiation from spatially extended radiating sources efficiently on processors with highly parallel architectures such as graphics processing units ( gpus ) and multi - core cpus which are recently popular or available in near future .",
    "the basic idea of the scheme is based on the scheme presented by @xcite and ` authentic radiation transfer ' ( art ) scheme @xcite .",
    "generally speaking , development of such numerical schemes with high concurrency is of critical importance because the performance improvement of recent processors are achieved by the increase of the number of processing elements or cpu cores integrated on a single processor chip rather than the improvement of the performance of individual processing elements .",
    "the rest of the paper is organized as follows .",
    "section 2 is devoted to describe the numerical scheme to simulate the radiation transfer . in section 3",
    ", we present our implementation of the scheme suitable to highly parallel architectures such as gpus and cpus with multi - core architectures .",
    "we present the results of numerical test suits of rt of diffuse radiation in section 4 .",
    "the computational performance of our implementation is shown in section 5 .",
    "finally , we summarize our results in section 6 .",
    "in this section , we describe our ray - tracing scheme of diffuse radiation transfer .",
    "generally , the radiation field can be decomposed into two components .",
    "one is the direct incident radiation from point radiation sources , and the other is the diffuse radiation emerged from spatially extended regions . in our implementation , the rt of photons emitted by point radiation sources is computed separately from that of diffuse radiation . throughout in this paper , we consider the rt of hydrogen ionizing photons emitted by point radiation sources , and recombination photons emerged from the ionized regions as the diffuse radiation .",
    "we use the steady state rt equation for a given frequency @xmath8 : @xmath9 where @xmath10 and @xmath11 are the specific intensity , the optical depth and the source function , respectively .",
    "the source function is given by @xmath12 where @xmath13 and @xmath14 are the absorption and emission coefficients , respectively .",
    "the formal solution of this equation is given by @xmath15 where @xmath16 is the optical depth at a position along the ray .",
    "when we adopt the `` on - the - spot '' approximation in which recombination photons emitted in ionized regions are assumed to be absorbed where they are emitted , we neglect the source function , @xmath17 , and the formal solution is simply reduced to @xmath18      to solve the rt from point radiation sources , we compute the optical depth between each pair of a point radiation source and a target mesh grid , i.e. an end point of each light - ray ( see figure  [ fig : long ] ) . instead of solving equation ( [ eq : on_the_spot ] ) , we compute the radiation flux density at the target mesh grid as @xmath19,\\ ] ] where @xmath20 is the intrinsic luminosity of the @xmath21-th point radiation source , and @xmath22 and @xmath23 are the distance and the optical depth between the point radiation source and the target mesh grid , respectively .",
    "then , the photo - ionization and photo - heating rates of the @xmath24-th species contributed by the @xmath21-th point radiation source are computed by @xmath25 and @xmath26 respectively , where @xmath27 and @xmath28 are the ionization cross section and the threshold frequency of the @xmath24-th species , respectively . in the test simulations desribed in this paper , we compute these photo - ionization and photo - heating rates in a photon - conserving manner @xcite as described in appendix  [ app : photon_conserving ] .    , width=188 ]    for a single point radiation source , the number of rays to be calculated is @xmath1 , and the number of mesh grids traveled by a single light - ray is in the order of @xmath29 .",
    "thus , the computational cost for a single point radiation source is proportional to @xmath30 .",
    "therefore , the total computational cost scales as @xmath31 , where @xmath5 is the number of point radiation sources . for a large number of point radiation sources",
    ", we can mitigate the computational costs by adopting more sophisticated scheme such as the argot scheme @xcite in which a distant group of point radiation sources is treated as a bright point source located at the luminosity center with a luminosity summed up for all the sources in the group to effectively reduce the number of radiation sources and hence the computational cost is proportional to @xmath32 .",
    "we solve the equation  ( [ eq : rad_tr2 ] ) to compute the rt of the diffuse radiation .",
    "the numerical scheme we adopt in this work is based on the method developed by @xcite and art scheme @xcite , which is reported to have little numerical diffusion in the searchlight beam test like the long characteristics method although its computational cost is proportional to @xmath0 similarly to that of the short characteristic method @xcite . in this scheme",
    ", we solve the equation  ( [ eq : rad_tr2 ] ) along equally spaced parallel rays as schematically shown in figure  [ fig : parallel_ray ] .",
    "for a given incoming radiation intensity @xmath33 along a direction @xmath34 , the outgoing radiation intensity @xmath35 after getting through a path length @xmath36 of a single mesh is computed by integrating equation  ( [ eq : rad_tr2 ] ) as @xmath37 where @xmath38 is the optical depth of the path length @xmath39 ( i.e. @xmath40 ) , and @xmath17 and @xmath41 are the source function and the absorption coefficient of the mesh grid , respectively .",
    "the intensity of the incoming radiation averaged over the path length @xmath36 across a single mesh grid can be calculated as @xmath42 in addition to this , we have a contribution to the radiation intensity from the source function which we set constant in each mesh grid , and the total intensity averaged over the path length is given by @xmath43 for those mesh grids through which multiple parallel light - rays pass , the averaged intensity can be given by @xmath44 where @xmath45 and @xmath46 are the intensity averaged over the @xmath24-th light - ray and the optical depth of @xmath24-th light - ray in the mesh grids , respectively , @xmath47 is a contribution from the incoming radiation given by @xmath48 and the summation is over all the parallel light - rays in the same mesh grid .",
    "then , the mean intensity can be computed by averaging @xmath49 described above over all the directions as , @xmath50 where @xmath51 describes a vector toward the @xmath24-th direction and @xmath52 is the number of directions of light - rays to be considered , @xmath53 is the averaged intensity along the @xmath24-th direction calculated with equation  ( [ eq : path_averaged_intensity ] ) , and @xmath54 is given by @xmath55 then , the photo - ionization and photo - heating rates of the @xmath24-th species contributed by the diffuse radiation in each mesh grid can be computed as @xmath56 and @xmath57    as for the recombination radiation of ionized hydrogen ( hii ) regions , the number of recombination photons to the ground state per unit time per unit volume , @xmath58 , can be expressed in terms of the emissivity coefficient @xmath59 as @xmath60n_{\\rm e}n_{\\rm hii},\\ ] ] where @xmath61 is the lyman limit frequency , @xmath62 and @xmath63 are the recombination rates of hii as functions of temperature @xmath64 in the case - a and case - b approximations , respectively , and @xmath65 and @xmath66 are the number densities of the electrons and hii , respectively . in this work",
    ", we adopt a rectangular functional form of @xmath67 as @xmath68 where @xmath69 and @xmath70 is the frequency width of the recombination radiation and given by @xmath71 .",
    "thus , the source function is given by @xmath72 this spectral shape is the same as adopted in @xcite and @xcite , the results of which are compared with our results to verify the validity of our scheme .",
    "note that for the typical temperature of hii regions , @xmath73 , we have @xmath74 .",
    "calculations of the mean intensity based on equations  ( [ eq : rt ] ) to ( [ eq : mean_intensity ] ) are done in a monochromatic manner at the lyman limit frequency @xmath61 . in computing photo - ionization and photo - heating rates ,",
    "we assume that the mean radiation intensity @xmath54 has a rectangular functional form as @xmath75 therefore , the photo - ionization and photo - heating rates of neutral hydrogen can be rewritten as @xmath76 and @xmath77 respectively . in the test simulations described in section  [ sec : test ] , we fix the frequency width @xmath70 by assuming temperature of hii regions to be @xmath78 k , and the integrals in equations  ( [ eq : gamma_diff ] ) and ( [ eq : heat_diff ] ) can be estimated prior to the simulations .",
    "for the transfer of diffuse radiation with more general spectral form , we can easily extend our method described above by adopting a nonparametric functional form of radiation spectra as @xmath79 where @xmath80 is the rectangular function given by @xmath81 and @xmath28 is the central frequency of the @xmath24-th frequency bin .",
    "the number of light - rays parallel to a specific direction is proportional to @xmath82 , and the number of mesh grids traversed by a single light - ray is in the order of @xmath83 .",
    "therefore , the total computational cost is proportional to @xmath84 .",
    "the number of the directions of light - rays , @xmath52 , determines angular resolution of the rt of the diffuse radiation . in order to guarantee that light - rays from a mesh grid on a face of the simulation box reach all the mesh grids on the other faces ,",
    "@xmath52 should be in the order of @xmath82 . in the case",
    "that the mean free path of the diffuse photons is sufficiently shorter the simulation box size , however , such a large @xmath52 is redundant because only a small fraction of diffuse photons reach the other faces , and we can reduce the total computational cost by decreasing the number of directions , @xmath85 , while keeping the reasonable accuracy of the diffuse rt . thus , the number of directions should be flexibly changed depending on the physical state .    to achieve this , we use the healpix ( hierarchical equal area isolatitude pixelization ) software package @xcite to set up the directions of the light - rays .",
    "the healpix is suitable to our purposes in the sense that each direction corresponds to exactly the same solid angle and that the directions are nearly uniformly sampled .",
    "furthermore , it can provide a set of directions with these properties in arbitrary resolutions , each of which contains @xmath86 directions , where @xmath87 is an angular resolution parameter .",
    "since it is larger than the number of mesh grids on six faces of a cube with a side length of @xmath87 mesh spacings , @xmath88 , it is expected that a set of light - rays originated from a single point with directions generated by the healpix with an angular resolution parameter of @xmath89 get through all the mesh grids within a cube centered by the point with a side length of @xmath87 mesh spacings .",
    "thus , the optimal number of directions should be chosen so that the mean free path of the recombination photons is sufficiently shorter than @xmath90 , where @xmath91 is the mesh spacing .",
    "with photo - ionization and photo - heating rates computed with the prescription described above , time evolutions of chemical compositions and thermal states of gas are computed in the same manner as adopted in @xcite .",
    "details of the numerical schemes are briefly described in appendices  [ app : reaction],[app : heating_cooling ] and [ app : timestep ] .",
    "the chemical reaction rates and radiative cooling rates adopted in this paper are identical to those adopted in @xcite , and the literatures from which we adopt these rates are summarized in table [ tab : rate ] .",
    ".rates of chemical reactions and radiative cooling processes adopted in this paper .",
    "reference for radiative recombination rates ( rr ) of hii , heii and heiii in the case - a and case - b approximation ; collisional ionization rates ( cir ) of hi , hei , and heii ; recombination cooling rates ( rcr ) of hii , heii and heiii in the case - a and case - b approximation ; collisional ionization cooling rates ( cicr ) of hi , hei and heii ; collisional excitation cooling rates ( cecr ) of hi , hei and heii ; bremsstrahlung cooling rate ; inverse compton cooling rate ( ccr ) ; photoionization cross sections ( cs ) of hi , hei and heii .",
    "[ tab : rate ] [ cols=\"<,<\",options=\"header \" , ]     \\(1 ) @xcite ; ( 2 ) @xcite ; ( 3 ) @xcite ; ( 4 ) @xcite ; ( 5 ) @xcite ; ( 6 ) @xcite ; ( 7 ) @xcite ; ( 8) @xcite ;",
    "in this section , we describe the details of the implementation of the rt calculation of the diffuse radiation which performs effectively on recently popular processors with highly parallel architecture , such as gpus , multi - core cpus , and many - core processors . throughout this paper , we present the results using the implementation with the ` openmp ` and ` cuda ` technologies .",
    "the former is supported by most of the multi - core processors , and the many - core processors such as the intel xeon - phi processor , while the latter is the parallel programming platform for gpus by nvidia .    in the implementation on gpus with the `",
    "cuda ` platform , the fluid dynamical and chemical data in all the mesh grids are transferred from the memory attached to cpus to those of gpus prior to the rt calculations .",
    "after the rt calculations , ionization rates and heating rates in all the mesh grids computed on gpus are sent back to the cpu memory .      in the calculations of the transfer of the diffuse radiation described in the previous section , many parallel light - rays travel from boundaries of the simulation volume until they reach the other boundaries . on processors with highly parallel architecture ,",
    "a straightforward implementation is to assign a single thread to compute the rt along each light - ray and calculate the rt along multiple light - rays in parallel .",
    "such a simple implementation , however , does not work because some mesh grids are traversed by multiple parallel light - rays ( see gray mesh grids in figure  [ fig : parallel_ray ] ) , and in computing equation  ( [ eq : path_averaged_intensity ] ) , multiple computational threads write data to the identical memory addresses .",
    "thus , equation  ( [ eq : path_averaged_intensity ] ) has to be computed not in parallel but in a exclusive manner using the `` atomic operations '' . the use of the atomic operations , however , significantly degrade the parallel efficiency and computational performance in many architectures .    to avoid such use of atomic operations and the deterioration of the parallel efficiency , we split the parallel light - rays into several groups so that parallel light - rays in each group do not traverse any mesh grid more than once .",
    "for example , in two - dimensional mesh grids in figure  [ fig : parallel_ray ] , parallel light - rays are split into two groups each of which are depicted by blue and red arrows .",
    "one can see that light - rays in each groups do not intersect any mesh grids more than once .",
    "we can extend this technique to the three - dimensional mesh grids by splitting the parallel light - rays into four groups , where the light - rays in each group are cast from the two - dimensionally interleaved mesh grids as depicted by the same color in figure  [ fig : grouping ] .",
    ", width=260 ]      many recent supercomputers are equipped with multiple external accelerators such as gpus on a single computational node , each of which has an independent memory space . to attain the maximum benefit of the multiple accelerators ,",
    "we decompose calculations of the diffuse radiation transfer according to the directions of the light - rays , and assign the decomposed rt calculation to the multiple accelerators . after carrying out the rt calculation for the assigned set of directions , and computing the mean intensity with equation ( [ eq : mean_intensity ] ) averaged over the partial set of directions on each external accelerator , the results",
    "are transferred to the memory on the hosting nodes .",
    "then , we obtain the mean intensity averaged over all directions .",
    "in addition to the thread parallelization within processors , we implement the inter - node parallelization using the message passing interface ( mpi ) . in the inter - node parallelization , the simulation box is evenly decomposed into smaller rectangular blocks with equal volumes along the cartesian coordinate .    for the inter - node parallelization of the calculations of the diffuse radiation transfer , we adopt the multiple wave front ( mwf ) scheme developed by @xcite , in which light - ray directions are classified into eight groups according to signs of their three direction cosines , and for each group of light - ray directions ,",
    "the rt calculations along each direction are carried out in parallel on a `` wave front '' in the node space , while the rt for different directions are computed on the other wave fronts simultaneously . by transferring the radiation intensities at the boundaries from upstream nodes to downstream ones",
    ", one can sequentially compute the rt of diffuse radiation along all the directions in each group of light - ray directions . see @xcite for more detailed description of mwf scheme .",
    "in this section , we present a series of test simulations to validate our rt code .",
    "all the test simulations are carried out with @xmath92 mesh grids and the angular resolution parameter of @xmath93 unless otherwise stated .",
    "the first test is the simple problem of a hii region expansion in a static homogeneous gas which consists of only hydrogen around a single ionizing source . we adopt the same initial condition as that of test-2 in cosmological radiative transfer codes comparison project i @xcite , where the hydrogen number density is @xmath94 and the initial gas temperature is @xmath95 .",
    "the ionizing source emits the blackbody radiation with an effective temperature of @xmath96 , and @xmath97 ionizing photons per second and located at a corner of simulation box with a side length of 6.6 kpc . in this initial condition ,",
    "the recombination time is @xmath98 and the strmgren radius is estimated to be 5.4 kpc .",
    "figure  [ fig : test-1 ] shows the radial profiles of ionization fraction and gas temperature at @xmath99 , @xmath100 and @xmath101 .",
    "the solid lines with and without circles indicate the results with and without the on - the - spot approximation ( otsa ) , respectively . in the calculation with the effect of recombination radiation ,",
    "the ionized regions are more extended than those computed with the on - the - spot approximation , especially at later stages ( @xmath102 and @xmath103 ) because of the additional ionization of hydrogen by the recombination photons .",
    "to verify the validity of our scheme for the transfer of diffuse recombination radiation , we compare our results with the ones obtained with the one - dimensional spherically symmetric rt code by @xcite , which also incorporates the transfer of recombination photons emitted by the ionized hydrogen using the impact - parameter method .",
    "we find that the one - dimensional results with the effect of recombination radiation denoted by dashed lines show a good agreement with our three - dimensional results , indicating that our treatment of diffuse radiation transfer is consistent with that of well - established impact - parameter method .    ,",
    "@xmath100 and @xmath103 .",
    "solid lines with and without circles indicates the results with and without the on - the - spot approximation ( otsa ) , respectively .",
    "dashed lines show the results obtained with one - dimensional spherically symmetric code without the otsa presented in @xcite .",
    "[ fig : test-1],width=566 ]      in the second test , we compute the rt from point radiation source in the presence of a dense gas clump .",
    "a point radiation source is located at the center of the simulation box with the same side length as the test-1 ( 6.6kpc ) , and surrounded by the ambient uniform gas with the same hydrogen number density and temperature as the test-1 ( @xmath94 and @xmath95 , respectively ) .",
    "in addition , we set up a spherical dense gas clump with a radius of 0.56kpc centered at 0.8 kpc apart from the point radiation source along the @xmath104-direction .",
    "we set the density of the dense clump to 200 times higher than that of the ambient gas , and the temperature is set to 100k .",
    "the spectrum and luminosity of the point radiation source is the same as that in test-1 .    in figure",
    "[ fig : test-2-map ] , maps of the neutral fraction of hydrogen in the mid - plane of the simulation volume at @xmath105 , 100myr and 500myr are shown .",
    "one can see that the ionizing photons are strongly absorbed by the dense gas clump and conical shadows are created behind the gas clump in the both runs with and without the effect of recombination radiation . in the run without the on - the - spot approximation ( upper panels of figure  [ fig : test-2-map ] ) ,",
    "the recombination photons emitted by the ionized gas gradually ionize the neutral gas behind the dense gas clump . on the other hand , in the run with the on - the - spot approximation ,",
    "the boundaries of neutral and ionized regions are kept distinct because of the lack of recombination photons .",
    "this test is identical to test-6 in @xcite calculated with the start code . in the start code , the rt is solved with a ray - tracing scheme based on the sph technique , and the transfer of diffuse recombination radiation can be handled by allowing each sph paricle to radiate recombination photons .",
    "figure  [ fig : test-2-section ] shows profiles of gas temperature and hydrogen neutral fraction along the lines across the conical shadow shown in figures  [ fig : test-2-map ] and [ fig : test-2-t ] as well as the results obtained with the start code .",
    "one can see that both the results with and without the otsa are in fairly good agreement with each other , which supports the validity of our scheme for diffuse radiation transfer .    ,",
    "@xmath106 and @xmath107 .",
    "the lower and upper panels show the results with and without the on - the - spot approximation ( otsa ) , respectively .",
    "dashed vertical lines indicate the location along which the profiles of temperature and neutral fractions are presented in figure  [ fig : test-2-section ] .",
    "[ fig : test-2-map],width=377 ]     but shows the gas temperature maps in the mid - plane of the simulation box .",
    "dashed vertical lines indicate the location along which the profiles of temperature and neutral fractions are presented in figure  [ fig : test-2-section].[fig : test-2-t],width=377 ]     and [ fig : test-2-t ] with and without the otsa .",
    "results in @xcite are also shown for comparison.[fig : test-2-section],width=377 ]    in this test , we also perform runs with various angular resolution parameter @xmath87 in the rt calculation of diffuse radiation to see the effect of angular resolution .",
    "figure  [ fig : test-2-resolution ] shows maps of neutral fraction of hydrogen in the mid - plane of the simulation box at @xmath105 with angular resolution parameter @xmath87 of 16 , 4 and 1 .",
    "the results with @xmath108 and @xmath109 are in good agreement with one with @xmath93 in figure  [ fig : test-2-map ] , indicating that the angular resolution with @xmath110 is sufficient for the current rt calculations .",
    "the results with @xmath111 , however , have spurious features in the map of neutral fraction .",
    "these numerical artifacts can be ascribed to the low angular resolution of light - rays by the comparison of the mean free path of the diffuse recombination photons and @xmath112 . as described in ",
    "[ sub : angular_resolution ] , the mean free path of the diffuse photons should be sufficiently smaller than @xmath112 to compute the rt of diffuse photons accurately . for",
    "the recombination photons emitted by ionized hydrogens in the current setup , the mean free path in the neutral ambient gas is estimated as @xmath113 and the mesh spacing is @xmath114 .",
    "thus , it is quite natural to have strong numerical artifacts in the results with @xmath111 , because the mean free path is almost equal to @xmath112 , and the condition for the accurate rt calculation ( @xmath115 ) is not satisfied .     for different angular resolution parameter , @xmath108 , 4 and 1 from left to right .",
    "[ fig : test-2-resolution],width=377 ]      the third test computes the transfer of ionizing radiation incident to a face of the rectangular simulation box and the propagation of ionized region into a spherical dense clump .",
    "this test is indentical to the test-3 in @xcite .",
    "the size of the simuation box is @xmath116 kpc , and hydrogen number density and initial temperature are set to @xmath117 @xmath118 and @xmath119 k , except that a spherical dense clump with a radius of 0.8 kpc located at 1.7 kpc apart from the center of the simulation volume has a uniform hydrogen number density of @xmath120 @xmath118 and a temperature of @xmath121 k. the ionizing radiation has the blackbody spectrum with a tempearature of @xmath122 and constant ionizing photon flux of @xmath123 s@xmath124 @xmath125 at a boundary of the simulation box .",
    "myr , 3 myr and 15 myr .",
    "the lower and upper panels show the results with and without the on - the - spot approximation , respectively.[fig : test-3-fmap],width=377 ]     but shows the gas temperature maps in the mid - plane of the simulation box.[fig : test-3-tmap],width=377 ]     myr , 3 myr and 15 myr .",
    "solid lines with and without circles indicate the results with and without the on - the - spot approximation , respectively .",
    "dotted lines shows the results with rsph code  @xcite presented in @xcite with the on - the - spot approxiamtion .",
    "[ fig : test-3-prof],width=453 ]    figures  [ fig : test-3-fmap ] and [ fig : test-3-tmap ] shows the maps of hydrogen neutral fraction and gas temperature in the mid - plane of the simulation volume at @xmath126 myr , 3 myr and 15 myr from left to right , where the ionizing photons enter from the left boundary of the figures .",
    "we show the results with and without the on - the - spot approximation in the lower and upper panels , respectively .    at @xmath126 myr",
    ", the ionization front enters the spherical clump and a cylindrical shadow is formed behind the clump . at @xmath127 myr and 15 myr , the spherical clump is slightly ionized and the boundary of the shadow is ionized and photo - heated by the hard photons which penetrate the edge of the clump .",
    "these overall ionization and temperature structures with the on - the - spot approximation are consistent with the ones presented in @xcite .",
    "the effect of the recombination radiation is clearly seen in the results at 15 myr , in which the cylindrical shadow is significantly ionized and heated by the recombination photons emitted at the ambient ionized region .",
    "figure  [ fig : test-3-prof ] shows the profiles of ionized fraction and gas temperature along the axis of symmetry at @xmath126 myr , 3 myr and 15 myr , where we also plot the results of the ` rsph ` code @xcite which are computed with the on - the - spot approximation and presented in @xcite .",
    "our results with the on - the - spot approximation are consistent with the ones computed with the ` rsph ` code in @xcite .",
    "the effect of the recombination radiation is siginificant at @xmath127 myr and 15 myr in the ionized fraction profiles , in which the recombination photons accelerate the propagation of the ionization front in the run without the on - the - spot approximation .",
    "in this section , we show the performance of our rt calculations of diffuse radiation .",
    "the code for the transfer of diffuse radiation is designed so that it can be run both on multi - core cpus and gpus produced by nvidia .",
    "the performance is measured on the ha - pacs system installed in center for computational sciences , university of tsukuba .",
    "each computational node of the ha - pacs system consists of two sockets of 2.6 ghz intel xeon processor e5 - 2670 with eight cores based on the sandy - bridge microarchitecture and four gpu boards of nvidia tesla m2090 , each of which is connected to the cpu sockets through pci express gen2 @xmath128 16 link .",
    "thus , a single computational node provides 2.99 tflops ( 0.33 tflops by cpus and 2.66 tflops by gpus ) of computing capability in double precision .",
    "the upper panel of figure  [ fig : time_single ] shows wallclock time for a iteration of the diffuse rt calculation on a single node with various numbers of cpu cores and gpu boards .",
    "the wallclock times are measured for @xmath129 , @xmath92 and @xmath130 .",
    "the angular resolution parameter @xmath87 is set to @xmath131 so that @xmath112 is kept constant .",
    "note that the wallclock times are nearly proportional to @xmath0 as theoretically expected .",
    "the lower panel of figure  [ fig : time_single ] shows the performance gain of the diffuse rt calculation with multiple cpu cores and gpu boards relative to the performance with a single cpu core and a single gpu board , respectively .",
    "use of the multiple cpu cores and multiple gpu boards provides the efficient performance gains nearly proportional to the adopted numbers of cpu cores and gpu boards for @xmath132 and @xmath130 except for the fact that those with 16 cpu cores ( 2 cpu sockets ) is not very impressive even for @xmath133 because of the relatively slow memory access across the cpu sockets . on the other hand ,",
    "the performance gain for @xmath129 is somewhat degraded because of the overheads for invoking the multiple threads and communication overhead for data exchange between cpus and gpus .",
    "the performance with the aid of four gpu boards is nearly 7 times better than that with 16 cpu cores for @xmath130 mesh grids , while it is only 3.5 times better for @xmath134 mesh grids due to the communication overhead between cpus and gpus .",
    ", @xmath92 and @xmath130 are shown in the upper panel .",
    "a dotted line indicate the dependence of computational cost on a number of mesh grids , @xmath135 . in the lower panel ,",
    "we present the performance gains of diffuse rt calculation with multiple cpu cores and gpu boards relative to the performance with a single cpu core and gpu board , respectively .",
    "horizontal dotted lines indicates the performance gains of 2 , 4 , 8 and 16 from bottom to top .",
    "[ fig : time_single],width=264 ]    we compare the performance of our diffuse rt calculations with and without the ray grouping technique on gpus . in the implementation without the ray grouping technique ,",
    "we utilize the atomic operation provided by the ` cuda ` programming platform in computing the averaged radiation intensity ( equation  ( [ eq : averaged_intensity ] ) ) .",
    "figure  [ fig : time_atomic ] shows the performance gains obtained by the use of the ray grouping technique , where the individual performance is measured with a single computational node and four gpus .",
    "one can see that the use of the ray grouping technique significantly improves the performance of diffuse rt more than by a factor of two irrespective of the number of mesh grids .    ,",
    "@xmath92 and @xmath130 on gpus .",
    "the performances are measured on a single computational node and four gpus . [",
    "fig : time_atomic],width=264 ]    .",
    "[ fig : time_multi],width=264 ]     is shown in a dashed line .",
    "lower panel : fractions of wallclock times for mpi communication relative to total wallclock time elapsed in the calculations of diffuse radiation transfer in the runs with the use of gpus.[fig : time_comm],width=264 ]    the upper panel of figure  [ fig : time_multi ] shows the wallclock time of diffuse rt calculation performed on a single and multiple computational nodes with and without gpu boards , where we invoke one mpi process on each computational node . in the runs without the use of gpus , each mpi process invokes 16 ` openmp ` threads , while in the runs with the aid of gpus , we utilize four gpu boards on each computational node .",
    "we measure the wallclock time consumed for a single iteration of diffuse rt calculation for @xmath134@xmath136 mesh grids on 1 , 8 , and 64 computational nodes .",
    "the lower panel depicts the performance gain of the runs with 8 and 64 computational nodes relative to those with 1 and 8 computational nodes , respectively , where the ideal performance gain of 8 is shown by a dotted line . as for the runs without the use of gpus ,",
    "the parallel efficiency is reasonable when @xmath137 , where @xmath138 is the number of computational nodes in use . for a given number of computational nodes ,",
    "the runs with the use of gpus have poorer performance gains than those without it , mainly beacause the computational times in the runs with gpus are significantly shorter than those withtout gpus , and the mpi data communication , as well as the commnication between cpus and gpus , gets more salient .",
    "such communication overhead is proportional to the number of light - rays getting through the surface of the decomposed computational domains , @xmath139 .",
    "figure  [ fig : time_comm ] shows that the time consumed by the mpi communication is nearly proportional to @xmath140 , and that it occupies a significant fraction of the total wallclock time for a small @xmath1 .",
    "this scaling with respect to @xmath1 has weaker dependence on @xmath1 than the computational costs , @xmath141 .",
    "therefore , the overhead can be concealed for a sufficient number of mesh grids , and we have better parallel efficiency for a larger @xmath142 .",
    "in this paper , we present a new implementation of the rt calculation of diffuse radiation field on three - dimensional mesh grids , which is suitable to be run on recent processors with highly - parallel architecture such as multi - core cpus and gpus .",
    "the code is designed to be run on both of ordinary multi - core cpus and gpus produced by nvidia by utilizing the ` openmp ` application programming interface and the ` cuda ` programming platform , respectively .",
    "since our rt calculation is based on the ray - tracing scheme , the rt calculation itself can be carried out concurrently by assigning the rt calculation along each light - ray to individual software threads . to avoid the atomic operations in computing the averaged intensity ( equation  ( [ eq : path_averaged_intensity ] ) ) which can potentially degrade the efficiency of the thread parallelization",
    ", we devise a new scheme of the rt calculations in which a set of parallel light - rays are split into 4 groups so that parallel light - rays in each group do not get through any mesh grids more than once . as well as the thread parallelization inside processors or computational nodes , we also parallelize our code on a multi - node system using the mwf scheme developed by @xcite .",
    "we perform several test simulations where the transfer of photo - ionizing radiation emitted by a point radiating source and recombination radiation from ionized regions as diffuse radiation are solved .",
    "we verify the validity of our rt calculation of the diffuse radiation by comparing our results with the effect of recombination radiation and the ones with other two independent codes , the one - dimensional spherical code by @xcite and start code by @xcite .",
    "we also clarify the condition of the required angular resolution in our diffuse radiation transfer scheme based on the mean free path of the diffuse photons and the mesh spacing .",
    "we show good parallel efficiency of our implementation for intra- and inter - node parallelizations . as for the intra - node parallelization ,",
    "the performance scales well with the number of cpu cores and gpu boards in use , except for the one in the case that multiple cpu sockets are used as a single shared - memory system .",
    "the scalability of the inter - node parallelization with the mwf scheme is also measured for @xmath134 to @xmath136 mesh grids on up to 64 computational nodes and it is found that the inter - node parallelization is efficient when we have a sufficient number of mesh grids per node , @xmath143 and @xmath144 for the runs with and without gpus , respectively .",
    "the ray - grouping technique described in [ ss : ray_grounping ] is effective and significantly improves the performance of our rt calculations by a factor of more than two , at least on gpus ( nvidia tesla m2090 ) .    with our implementation",
    "presented in this paper , we are able to perform the diffuse rt calculations in a reasonable wallclock time comparable to that of other physical processes such as hydrodynamical calculations .",
    "this means that the calculations of the diffuse radiation transfer can be coupled with hydrodynamic simulations and we are able to conduct radiation hydrodynamical simulations with the effect of diffuse radiation transfer as well as the radiation transfer from point radiating sources in three - dimensional mesh grids .",
    "currently , we are developing such a radiation hydrodynamic code and , based on this , we will address astrophysical problems in which diffuse radiation transfer plays important roles .",
    "it should be noted that , though we present the implementations and the performance on the multi - core cpus and gpus produced by nvidia , our approaches presented in this paper can be readily applied to other processors with similar architecture , such as the intel xeon - phi processor or gpus by other vendors . in addition , our approach can be easily extended to adaptively refined mesh grids using the prescription described in @xcite , although we present the implementation for uniform mesh grids in this paper .",
    "we would like to thank tetsu kitayama for providing us with his radiation transfer code .",
    "we are also grateful to the anonymous referee for helpful comments .",
    "numerical simulations in this work have been carried out on the ha - pacs supercomputer system under the `` interdisciplinary computational science program '' in the center for computational sciences , university of tsukuba .",
    "this work was partially supported by japan society for the promotion of science ( jsps ) grant - in - aid for scientific research ( s ) ( 20224002 ) .",
    "to acknowledges the financial support of jsps grant - in - aid for young scientists ( b : 24740112 ) .",
    "kh acknowledges the support of mext spire field 5 and jicfus and the financial support of jsps grain - in - aid for young scientists ( b : 24740114 ) .",
    "we describe the photon - conserving evaluation of photo - ionization and photo - heating rates of a mesh grid contributed by a point radiating source , where the inner and outer intersections of a light - ray from the point raidating source and the mesh grid are located at @xmath145 and @xmath146 from the point radiating source .",
    "we consider a imaginary spherical shell centered at the point radiating source with inner and outer radii of @xmath145 and @xmath146 , respectively . the incoming photon number per unit time @xmath147",
    "is given by @xmath148 where @xmath149 is the luminosity density at a frequency @xmath8 , and @xmath150 is the optical depth between the point source and the inner side of the shell .",
    "the outgoing photon number per unit time from the outer side of the shell is written as @xmath151 where @xmath152 is the radial optical depth of the shell .",
    "then , the number of absorped photons per unit time @xmath153 is given by @xmath154 .\\ ] ] when we consider multiple chemical components , the absoption rate of the @xmath24-th species is rewritten as @xmath155,\\ ] ] where @xmath156 is a optical depth contributed by the @xmath24-th component , and @xmath157 is the total optical depth . since @xmath158 is equal to the number of ionization of the @xmath24-th species , the photo - ionization rate of the @xmath24-th component can be written as @xmath159 where @xmath28 is the threshold frequecy of the @xmath24-th species and @xmath160 is the number of @xmath24-th species in the shell .",
    "the photo - heating rate is similarly calculated in terms of @xmath161 as @xmath162",
    "the time evolution of the number density of the @xmath24-th chemical species can be schematically described by @xmath163 where @xmath164 is the collective production rate of the @xmath24-th species and @xmath165 is the destruction rate of the @xmath24-the species .",
    "for example , in the case of atomic hydrogen , @xmath166 and @xmath167 is given by @xmath168 where @xmath169 is the radiative recombination rate of hii , @xmath170 is the collisional ionization rate and @xmath171 is the photoionization rate of hi .",
    "these equations are numerically solved using the backward difference formula ( bdf ) @xcite , in which the number densities of the @xmath24-th chemical species at a time @xmath172 , @xmath173 , is computed as @xmath174 where , @xmath175 and @xmath176 are estimated with the number densities of each species at the advanced time , @xmath177",
    ". however , the number densities in the advanced time step are not available for all the chemical species in evaluating @xmath175 due to the intrinsic non - linearity of equation  [ eq : app_chem ] .",
    "thus , we sequentially update the number densities of each chemical species in the increasing order of ionization levels rather than updating all the species simultaneously .",
    "it is confirmed that this scheme is stable and accurate @xcite .",
    "the specific energy change for each mesh by the photo - heating and radiative cooling is followed by the energy equation @xmath178 where @xmath179 is the specific internal energy and @xmath180 and @xmath181 are the photo - heating and cooling rate , respectively and @xmath180 is given by @xmath182 the specific internal energy for each mesh is updated implicitly by solving the equation @xmath183 for @xmath184 , where the photo - heating @xmath185 and cooling rates @xmath186 are evaluated at the advanced time @xmath172 .",
    "since we solve the static rt equation ( [ eq : rad_tr1 ] ) , equations ( [ eq : app_chem ] ) for chemical reactions and ( [ eq : app_energy ] ) for photo - heating and radiative cooling have to be solved iteratively until the electron number density and specific internal energy in each mesh grid converges : @xmath187 and @xmath188 , where @xmath189 is set to @xmath190 , and @xmath191 and @xmath192 indicates the specific internal energy and the electron number density after the @xmath24-th iteration , respectively .",
    "the timestep in solving chemical reactions and energy equation , @xmath193 , is set to @xmath194 where the second term on the right hand side prevents the timestep from getting prohibitively short in the case that the gas is almost neutral , and @xmath195 and @xmath196 are set to 0.2 and 0.002 , respectively .",
    "the timestep , @xmath197 , with which we update the radiation field can be larger than the chemical timestep , @xmath198 by subcycling the rate and energy equations ( [ eq : app_chem ] ) and ( [ eq : app_energy ] ) . throughout in this paper , the timestep for the rt calculation is set to @xmath199 where @xmath200 is the chemical timestep for the @xmath24-th mesh grid , and we typically set @xmath201 so that the radiation field successfully converges with a reasonable number of iterations .",
    "janev r.  k. , langer w.  d. , post  jr d.  e. , evans  jr k. , 1987 , in janev r.k .",
    ", lnger w.d . ,",
    "evans , k. , eds , elementary processes in hydrogen - helium plasmas  cross - section and reaction rate coefficients .",
    "springer - verlag , berlin"
  ],
  "abstract_text": [
    "<S> we present a new numerical scheme to solve the transfer of diffuse radiation on three - dimensional mesh grids which is efficient on processors with highly parallel architecture such as recently popular gpus and cpus with multi- and many - core architectures . </S>",
    "<S> the scheme is based on the ray - tracing method and the computational cost is proportional to @xmath0 where @xmath1 is the number of mesh grids , and is devised to compute the radiation transfer along each light - ray completely in parallel with appropriate grouping of the light - rays . </S>",
    "<S> we find that the performance of our scheme scales well with the number of adopted cpu cores and gpus , and also that our scheme is nicely parallelized on a multi - node system by adopting the multiple wave front scheme , and the performance scales well with the amount of the computational resources . as numerical tests to validate our scheme and to give a physical criterion for the angular resolution of our ray - tracing scheme , we perform several numerical simulations of the photo - ionization of neutral hydrogen gas by ionizing radiation sources without the `` on - the - spot '' approximation , in which the transfer of diffuse radiation by radiative recombination is incorporated in a self - consistent manner . </S>"
  ]
}