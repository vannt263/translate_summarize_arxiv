{
  "article_text": [
    "in the theoretical and computational modeling of physical systems , including but not limited to condensed - matter materials @xcite , fluids @xcite , and biological molecules @xcite , it is very common to appeal to the concept of _ constraints_. when a given quantity related to the system under study is constrained , it is not allowed to depend explicitly on time ( or on any other parameter that describes the evolution of the system in the problem at hand ) . instead ,",
    "a constrained quantity is either set to a constant value ( _ hard _ or _ rigid _ constraints ) or to a function of the rest of degrees of freedom ( _ flexible _ , _ elastic _ or _ soft _ constraints ) ; in such a way that , if it depends on time , it does so through the latter and not in an explicit manner .",
    "the imposition of constraints is useful in a wide variety of contexts in the fields of computational physics and chemistry : for example , we can use constraints to maintain an exact symmetry of the equations of motion ; like in car - parrinello molecular dynamics ( md ) @xcite , where the time - dependent kohn - sham orbitals need to be orthonormal along the time evolution of the quantum - classical system , a requirement that can be fulfilled by imposing constraints over their scalar product @xcite . in a different context",
    ", we can use constraints , as in the blue moon ensemble technique @xcite , to fix some macroscopic , representative degrees of freedom of molecular systems ( normally called _ reaction coordinates _ ) , in order to be able to compute free energy profiles along them that would take an unfeasibly long time if we used an unconstrained simulation .",
    "probably the most common application of the idea of constraints , and the one that will be mainly discussed in this work , appears when we fix the fastest , hardest degrees of freedom of molecular systems , such as bond lengths or bond angles , in order to allow for larger time - steps in md simulations @xcite .    in any of these cases ( assuming that the dimensions of the spaces involved are all finite )",
    "the imposition of constraints can be described in the following way : if the state of the system is parameterized by a given set of coordinates @xmath0 , spanning the _ whole space _ , @xmath1 , and the associated momenta @xmath2 , a given _ constrained subspace _ , @xmath3 , of dimension @xmath4 ,",
    "can be defined by giving a set of @xmath5 independent relations among the coordinates ( in this work , we will only deal with holonomic , scleronomous constraints , i.e. , those that are independent both of the momenta and ( explicitly ) of time . ) : @xmath6    the condition of these constraints being independent amounts to asking the set of @xmath7 vectors of @xmath8 components @xmath9 to be linearly independent at the relevant points @xmath10 satisfying  ( [ eq : constraints1 ] ) , and it means that @xmath3 is a manifold of constant dimension in these points , which are called _",
    "regular_. moreover , this independence condition allows , in the vicinity of each point @xmath10 and by virtue of the implicit function theorem @xcite , to ( formally ) solve  ( [ eq : constraints1 ] ) for @xmath7 of the coordinates , which we arbitrarily place at the end of @xmath10 , splitting the original set as @xmath11 , with @xmath12 and @xmath13 .",
    "then , in the vicinity of each point @xmath10 satisfying  ( [ eq : constraints1 ] ) , we can express the relations defining the constrained subspace , @xmath3 , _ parametrically _ by @xmath14 where the functions @xmath15 are the ones whose existence the implicit function theorem guarantees .",
    "the coordinates @xmath16 are thus termed _ unconstrained _ and they parameterize @xmath3 , whereas the coordinates @xmath17 are called _ constrained _ and their value is determined at each point of @xmath3 according to  ( [ eq : constraints2 ] ) . in general , the functions @xmath18 will depend on @xmath16 , and the constraints will be said to be _ flexible _ @xcite . in the particular case in which all the functions @xmath18 are constant along @xmath3 , the constraints are called _ hard _ , and all the calculations are considerably simplified . in this work ,",
    "we tackle the general , more involved , flexible case .    of course , even if @xmath3 is regular in all of its points , the particular coordinates @xmath19 that can be solved need not be the same along the whole space .",
    "one of the simplest examples of this being the circle in @xmath20 , which is given by @xmath21 , an implicit expression whose gradient is non - zero for all @xmath22 .",
    "however , if we try to solve , say , for @xmath23 in the whole space @xmath3 , we will run into trouble at @xmath24 ; if we try to solve for @xmath25 , we will find it to be impossible at @xmath26 .",
    "i.e. , the implicit function theorem does guarantee that we can solve for _ some _ of the original coordinates at each regular point of @xmath3 , but sometimes the solved coordinate has to be @xmath25 and sometimes it has to be @xmath23 .",
    "nevertheless , we will assume this to be the case throughout this work , as is normally done in the literature @xcite , and thus we will consider that @xmath3 is parameterized by the _",
    "same _ subset of coordinates @xmath16 for all of its points .",
    "it is also worth mentioning at this point that , not only from the physical point of view all the constraints dealt with in this work are just holonomic constraints , but also the wording used to refer to the two _ flexible _ and _ hard _ sub - types is multiple in the literature . the first sub - type is called _ flexible _ in refs .",
    "@xcite , _ elastic _ in  @xcite , and _ soft _ in  @xcite ; whereas the second sub - type is called _ hard _ in refs .",
    "@xcite , just _ constrained _ in  @xcite , or _",
    "holonomic _ in  @xcite , _ rigid _ in  @xcite , and _ fully constrained _ in  @xcite .",
    "some of these terms are clearly misleading ( _ elastic _ , _ holonomic _ or _ fully constrained _ ) , and , in any case , so many names for such simple concepts is detrimental to understanding in the field .",
    "the situation is further complicated by the fact that , when studying the statistical mechanics of constrained systems , one can think about two different models for calculating the equilibrium probability density , whose names often collide with the ones used for defining the type of constraints applied . on the one hand , one can implement the constraints by the use of very steep potentials around the constrained subspace ; a model sometimes called _ flexible _",
    "@xcite , sometimes called _ stiff _ @xcite . on the other hand",
    ", one can assume the dalembert principle @xcite and hypothesize that the forces are just the ones needed for the system to never leave the constrained subspace during its dynamical evolution ; a model normally called _ rigid _",
    "the two statistical mechanics models have long been recognized to present different equilibrium probability distributions @xcite , and this is the major concern in the literature when discussing them . in refs .",
    "@xcite , the reader can find a very detailed discussion of this issue , which we only touch here briefly for completeness .",
    "it is worth remarking that the two types of constraints and the two types of statistical mechanics models can be independently combined ; one can have either the _ stiff _ or the _ rigid _ model , with either _ flexible _ or _ hard _ constraints , hence making any interference between the two sets of words undesirable .",
    "the wording chosen is this work is , on the one hand , fairly common , and on the other hand , non - misleading .",
    "now , if we take any physical observable @xmath27 , depending only on the coordinates ( not on the momenta ) , and originally defined on the whole space , @xmath1 , its _ restriction _ to @xmath3 is given by @xmath28 where the symbol has been deliberately changed in order to indicate that @xmath29 and @xmath30 are different functions .",
    "the derivatives of this observable along @xmath3 are thus @xmath31 where we have assumed the convention that repeated indices ( like @xmath32 above ) indicate a sum over the relevant range , and we have omitted ( as we will often do ) the range of variation of the index @xmath33 .",
    "in the case of hard constraints , i.e. , when the functions @xmath18 are all constant numbers @xmath34 , the above expression reduces to @xmath35 where @xmath27 must be a known function of @xmath10 ( in order to have a well - defined problem ) , and its derivative is typically easy to compute .",
    "however , if the constraints are of the more general , flexible form ( the ones tackled in this work ) , the calculation of the partial derivatives @xmath36 can not be avoided .    if the constraints are assumed to be flexible , it is common in the literature of molecular modeling to define these functions @xmath37 as the values taken by the coordinates @xmath17 if we minimize either the total or the potential energy with respect to all @xmath19 at fixed @xmath16 @xcite . since the energy functions used in molecular simulation are typically rather complicated , such as the ones in classical force fields , with a large number of distinct functional terms @xcite , or the effective nuclear potential arising from the solution of the electronic schrdinger equation in the ground - state born - oppenheimer approximation @xcite , the minimization of the energy with respect to the coordinates @xmath17 has to be performed numerically .",
    "hence , the functions @xmath37 , which are the output of this process , do not have a compact analytical expression that can be easily differentiated to include it in eq .",
    "( [ eq : derz1 ] ) ( this is even the case in very simple toy systems ; see the results and discussion section ) .    in this work",
    ", we present a parameter - free , exact algorithm ( up to machine precision ) to calculate the derivatives @xmath38 in such a case .",
    "although several methods exist in the literature @xcite for performing md simulations with flexible constraints , nobody has dealt , as far as we are aware , with the computation of these derivatives .",
    "since the general idea can be applied to any situation in which ( 1 ) we have flexible constraints , ( 2 ) that are defined in terms of the minimization of some quantity with respect to the constrained coordinates , we first introduce , the essential part of the algorithm based on these two points . then , we develop a more sophisticated application of this idea to the calculation of the derivatives along the constrained subspace of the euclidean coordinates of molecular systems",
    "; a problem that we faced in our group when trying to calculate the correcting terms associated to mass - metric tensor determinants that appear in the equilibrium probability density when constraints are imposed @xcite .",
    "finally , we perform a comparison between the results obtained with our exact algorithm and the calculation of the derivatives by finite differences ; this serves the double purpose of numerically validating the algorithm and showing the limitations of the latter method , which needs the tuning of a parameter for each particular problem .",
    "as we mentioned in the introduction , we assume that we are dealing with a constrained problem in which the functions @xmath37 in eq .",
    "( [ eq : constraints2 ] ) are defined as taking the values of the constrained coordinates @xmath19 that minimize a given function , @xmath39 , for each fixed @xmath16 , i.e. , @xmath40 where @xmath41 is a suitable open set in @xmath42 containing the point @xmath43 .",
    "depending on the particular application , one can ask the minimum that defines the functions @xmath37 to be global or just local .",
    "however , in the cases in which @xmath44 is the total or the potential energy of a complex molecular system , it may become very difficult to find its global minimum ( due to the shear number of dimensions of the search space ) , and the local choice is the only reasonable one @xcite .    in order to calculate the derivatives along @xmath3 of any physical observable function of the coordinates @xmath45 , like the one defined in  ( [ eq : restrictionx ] ) , we can always follow the finite - differences approach .",
    "however , as we discuss in the results and discussion section , finite differences presents intrinsic inaccuracies which are difficult to overcome , specially as the system grows larger .",
    "let us now introduce a different way to calculate @xmath46 which does not suffer from this drawback .",
    "the starting point is eq .",
    "( [ eq : derz1 ] ) in the introduction , which we copy here for the comfort of the reader : @xmath47    as we mentioned , the expression of @xmath27 , as well as the functions @xmath37 , must be known if we wish to have a well - defined constrained problem to begin with .",
    "therefore , the only objects that remain to be computed are the partial derivatives @xmath38 .    if we assume that we have available some method to check that the order of the stationary point is the appropriate one ( i.e. , that it is a minimum , and not a maximum or a saddle point ) , we can write a set of equations which are equivalent to eq .",
    "( [ eq : minimum1 ] ) , and which ( implicitly ) define the functions @xmath37 : @xmath48    now , we can take the derivative of this expression with respect to a given unconstrained coordinate @xmath49 : @xmath50 where @xmath51 , with @xmath52 , is the hessian matrix of @xmath44 evaluated at @xmath53 , and @xmath54 is the matrix of unknowns that we want to solve for . in the whole document",
    ", we adhere to the practice of using different types of indices in order to indicate different ranges of variation . here , for example , @xmath55 run from @xmath56 to @xmath8 ; @xmath57 run from @xmath56 to @xmath58 ; and @xmath59 run from @xmath60 to @xmath8 . in the next section",
    ", we need to use more types of indices , but the idea is the same .",
    "it is worth mentioning that similar equations to the ones above can be found in classical mechanics anytime that local coordinates are used ( the coordinates @xmath16 in this work ) .",
    "for example , the force in such a case is defined as @xmath61 and the chain rule can be used in a similar way to what we do here .",
    "note , however , that eq .",
    "( [ eq : minimum2 ] ) does not contain derivatives with respect to @xmath49 , but to the constrained coordinate @xmath19 .",
    "this makes the approach slightly different and , indeed , eq .",
    "( [ eq : derderv ] ) would become trivial in the most common hard situation tackled in the literature , where @xmath62 , @xmath63 .",
    "since we are , by hypothesis , in a minimum of @xmath44 with respect to the constrained coordinates @xmath17 , the constrained sub - block @xmath64 of the hessian is a positive definite matrix , and therefore invertible .",
    "hence , if we multiply eq .",
    "( [ eq : derderv ] ) by its inverse , denoted by @xmath65 , sum over @xmath32 , exploit the fact that @xmath51 and @xmath66 are symmetric , and conveniently rename the indices , we arrive at : @xmath67 which , as promised , allows us to find the exact derivatives @xmath68 with the only knowledge of the hessian of @xmath44 at the point @xmath69 , and , upon introduction of the result in eq .",
    "( [ eq : derz1bis ] ) , also the derivatives along the constrained subspace @xmath3 of any physical observable @xmath27 .",
    "as mentioned , several methods exist in the literature @xcite to perform md simulations with flexible constraints , however , none of them has tackled the calculation of these derivatives , which are very basic objects presumably to be needed in many future applications ( see , e.g. , refs .",
    "@xcite ) . of course",
    ", it is always possible to compute derivatives using the simple and straightforward method of finite differences . in this work",
    ", we use finite differences as a way of validating the new , exact method and ensuring it is error free .",
    "the accuracy of the new algorithm is only limited by the accuracy with which we can calculate the hessian of @xmath44 at @xmath69 and invert it ; there is no tunable parameter that we need to adjust for optimal accuracy , as in the case of finite differences ( see below and also results and discussion ) .",
    "this makes a difference because , in classical force fields @xcite and even in some quantum chemical methods ( e.g. , see chap .",
    "10 of @xcite ) , the hessian can be calculated analytically , without the need of finite differences .",
    "although no optimization of the numerical cost has been pursued in this work , some remarks can be made about it , in comparison with the cost of the finite - differences approach . in order to calculate the partial derivatives",
    "@xmath70 with respect to the unconstrained coordinates @xmath16 using finite differences , we need to :    1 .   minimize @xmath71 at fixed @xmath16 to find @xmath43 ( this step is common with the new method introduced here ) .",
    "2 .   calculate @xmath72 ( this step is common with the new method introduced here ) .",
    "3 .   choose a displacement @xmath73 and minimize @xmath74 at the point @xmath75 , where @xmath76 if @xmath77 and @xmath78 if @xmath79 .",
    "this yields @xmath80 at a nearby point in @xmath3 with @xmath81 displaced a quantity @xmath73 and the rest of unconstrained coordinates kept the same .",
    "4 .   calculate @xmath82 .",
    "calculate @xmath83 as the finite - difference approximation to the sought derivative @xmath70 at the point @xmath16 .",
    "note that the third point of this finite - differences approach is essentially a linear stability analysis .",
    "when strongly non - equilibrium points are present , such as in the examples discussed in the last section , this approximation fails and the fact that the new algorithm introduced in this work uses only quantities defined _ at the point _ @xmath16 becomes even more important .",
    "now , assuming that we have a good enough guess for the parameter @xmath73 , the cost of this procedure is dominated by the need to perform @xmath58 minimizations of the function @xmath44 , one in each of the directions corresponding to the unconstrained coordinates @xmath49 .",
    "if we denote by @xmath84 the average number of iterations needed for these minimizations to converge , and we define @xmath85 and @xmath86 as the numerical costs ( in computer time ) of computing @xmath44 and its first derivatives with respect to the constrained coordinates @xmath17 , respectively , we have that the average cost of calculating the sought derivatives @xmath87 using finite differences will be @xmath88 for local optimization methods such as the steepest descent or the conjugate gradient , or @xmath89 for monte carlo - based methods in which the derivatives of @xmath44 are not needed , such as simulated annealing @xcite .    on the other hand , the new algorithm does not require the extra minimizations , but it does require the calculation of the hessian of @xmath44 with respect to the internal coordinates ( whose cost we call @xmath90 ) , and the computation of the inverse of its constrained sub - block , @xmath91 , applied to each one of the @xmath58 @xmath7-vectors @xmath92 in eqs .",
    "( [ eq : derderv ] ) and  ( [ eq : fsolved ] ) , of cost @xmath93 ; resulting in a total cost of @xmath94 .",
    "the comparison between the two costs is not trivial and some remarks about it must be made : first , one must notice that the different individual costs involved , @xmath85 , @xmath86 , @xmath90 and @xmath93 , are strongly dependent on the characteristics ( 1 ) of the coordinates @xmath10 used and ( 2 ) of the function @xmath95 . for example , if the coordinates @xmath10 are the euclidean ones and the function @xmath95 is the potential energy of a molecular system as modeled by a typical force field @xcite , the most direct algorithms for calculating @xmath44 and its derivatives yield costs @xmath85 , @xmath86 and @xmath90 which are of order @xmath96 , @xmath97 and @xmath96 , respectively @xcite .",
    "however , if more advanced long - range techniques are used , such as the particle - particle particle - mesh ( pppm ) method @xcite , the fast multipole method @xcite or the particle - mesh ewald summation @xcite , these costs can be reduced to order @xmath98 or even @xmath8 ( for large @xmath8 and forgetting prefactors ) .",
    "also , as mentioned , if the coordinates used are not the euclidean ones but some internal coordinates such as the ones used in this work , these costs must change in order to account for the transformation between the two . if force fields are not used but , instead , @xmath95 is the ground - state born - oppenheimer energy as calculated using hartree - fock @xcite , then the most naive implementations yield costs for @xmath85 , @xmath86 and @xmath90 which are of order @xmath99 @xcite .",
    "the cost , @xmath93 , of calculating the inverse of @xmath91 applied to a vector @xmath92 can range from order @xmath8 to order @xmath100 depending on the sparsity of the matrix @xcite , which , in turn , depends again on the coordinates used and on the structure of @xmath95 .",
    "finally , additional qualifications may complicate the comparison , such as the architecture of the computers in which the algorithms are implemented , parallelization issues , or the fact that , e.g. , if we need the hessian for a different purpose in our simulation , such as the calculation of the corresponding correcting term that appears both in the constrained stiff model and in the fixman potential @xcite , then the ` only ' computational step we are adding is the inversion of a matrix .    despite the complexity and problem - dependence of the cost assessment",
    ", it must be stressed that , even in the cases in which the new algorithm turns out to be more expensive than the alternatives , the fact that it is exact and parameter - free might still make it the preferred choice in problems where high accuracy is needed .",
    "although a parameter - free structure does not guarantee higher accuracy , in this case it does , since our method can be identified as the proper limit of the finite - differences scheme when @xmath101 .",
    "this is illustrated in results and discussion .",
    "it is also worth remarking that the new method , as mentioned , is not needed to perform md simulations , which can be run without calculating any of the derivatives tackled in this work @xcite .",
    "our method is only needed when some observable in which these derivatives are included ( such as the aforementioned mass - metric tensor determinants ) needs to be computed . in such cases ,",
    "the only two options to get to the final result are either finite differences or our method , and the most convenient of the two has to be chosen ; even if its cost is a burden .      in this section",
    ", we will apply the general algorithm introduced above to calculate the derivatives along the constrained subspace of the euclidean coordinates of molecular systems in a frame of reference ( for ) fixed in the molecule .",
    "this problem has been faced by our group when trying to calculate the correcting terms associated with mass - metric tensor determinants that appear in the equilibrium probability density when flexible constraints are imposed @xcite .",
    "more specifically , these derivatives are needed to calculate the determinant of the induced mass - metric tensor @xmath102 that appears in the constrained rigid model , according to the formulae derived in ref .",
    "@xcite .",
    "in such a case , the system of interest is a set of @xmath103 mass points termed _",
    "atoms_. the three euclidean coordinates of atom @xmath104 in a for fixed in the laboratory are denoted by @xmath105 , and its mass by @xmath106 , with @xmath107 .",
    "however , when no explicit mention to the atom index needs to be made , we will use @xmath108 to denote the @xmath8-tuple of all the @xmath109 euclidean coordinates of the system .",
    "the masses @xmath8-tuple , @xmath110 , in such a case , is formed by consecutive groups of three identical masses , corresponding to each of the atoms .",
    "apart from the euclidean coordinates , one can also use a given set of _ curvilinear coordinates _ ( also called sometimes _ general _ or _ generalized _ ) , denoted by @xmath0 , to describe the system .",
    "both the coordinates @xmath25 and @xmath10 parameterize the whole space @xmath1 , and the transformation between the two sets and its inverse are respectively given by    [ eq : change_x_to_q ] @xmath111    we will additionally assume that , for the points of interest , this is a _ proper _ change of coordinates , i.e. , that the _ jacobian matrix _ @xmath112 has non - zero determinant .    now , we define a particular for _ fixed in the system _ to perform some of the calculations .",
    "to this end , we select three atoms ( denoted by 1 , 2 and 3 ) in such a way that @xmath113 , the position in the for of the laboratory of the origin of the for fixed in the system , is the euclidean position of atom 1 ( i.e. , @xmath114 ) .",
    "the orientation of the for @xmath115 fixed in the system is chosen such that atom 2 lies in the positive half of the @xmath116-axis , and atom 3 is contained in the @xmath117-plane , with projection on the positive half of the @xmath118-axis ( see fig .",
    "[ fig : axes_fixed ] ) .",
    "the position of any given atom @xmath104 in the new for fixed in the system is denoted by @xmath119 .",
    "also , let @xmath120 be the euler rotation matrix ( in the zyz convention ) that takes a free 3-vector of primed components , @xmath121 , to the for fixed in the laboratory , i.e. , @xmath122 @xcite .",
    "although the aforementioned curvilinear coordinates @xmath10 are a priori general , it is very common to take into account the fact that the typical potential energy functions of molecular systems in absence of external fields do not depend on @xmath123 nor on the angles @xmath124 , and to consequently choose a set of curvilinear coordinates split into @xmath125 , where the first six are these _ external coordinates _ , @xmath126 . as we mentioned before",
    ", @xmath127 describes the overall position of the system with respect to the for fixed in the laboratory , and its overall orientation is specified by the angles @xmath124 .",
    "the remaining @xmath128 coordinates @xmath129 are called _ internal coordinates _ and determine the positions of the atoms in the for fixed in the system @xcite .",
    "they parameterize what we shall call the _ internal subspace _ or _ conformational space _ , denoted by @xmath130 , and the coordinates",
    "@xmath131 parameterize the _ external subspace _ , denoted by @xmath132 ; consequently splitting the whole space as @xmath133 ( denoting by @xmath134 the cartesian product of sets ) .",
    "the position , @xmath135 , of any given atom @xmath104 in the axes fixed in the system is a function , @xmath136 , of only the internal coordinates , @xmath33 , and the transformation from the euclidean coordinates @xmath25 to the curvilinear coordinates @xmath10 in  ( [ eq : change_x_to_q_a ] ) may be written more explicitly as follows : @xmath137    although general constraints affecting all the coordinates @xmath10 [ like those in  ( [ eq : constraints1 ] ) ] can be imposed on the system , the already mentioned property of invariance of the potential energy function under changes of the external coordinates , @xmath131 , together with the fact that the potential energy can be regarded as ` producing ' the constraints @xcite , make physically frequent the use of constraints involving only the internal coordinates , @xmath33 : @xmath138    under the common assumptions in the introduction , these constraints allow us to split the internal coordinates as @xmath139 , where the first @xmath140 ones , @xmath141 , are called _ unconstrained internal coordinates _ and parameterize the _ internal constrained subspace _ , denoted by @xmath142 .",
    "the last @xmath5 ones , @xmath143 , correspond to the _ constrained coordinates _ in the introduction and are called .",
    "the external coordinates , @xmath131 , together with the unconstrained internal coordinates , @xmath144 , constitute the set of all _ unconstrained coordinates _ of the system , @xmath145 , which parameterize the constrained subspace @xmath3 , being @xmath146 .    in this situation , the constraints in eq .",
    "( [ eq : constraints3 ] ) are equivalent to @xmath147 and the functions @xmath148 are defined as taking the values of the coordinates @xmath19 that minimize the potential energy with respect to all @xmath19 at fixed @xmath144 @xcite .",
    "finally , if these constraints are used , together with  ( [ eq : change_x_to_q_2 ] ) , the euclidean position of any atom in the constrained case may be parameterized with the set of all unconstrained coordinates , @xmath16 , as follows : @xmath149 where the name of the transformation functions has been changed from @xmath30 to @xmath29 , and from @xmath150 to @xmath151 , in order to emphasize that the dependence on the coordinates is different between the two cases .    in order to calculate the derivatives along @xmath142 of the primed atoms positions , @xmath152 , with respect to the unconstrained internal coordinates @xmath144 ( needed , for example , in eq .",
    "( 28 ) of ref .",
    "@xcite to compute the determinant of the induced mass - metric tensor @xmath102 ) , we first differentiate with respect to @xmath153 in @xmath154 , arriving to the analogue to eq .",
    "( [ eq : derz1bis ] ) : @xmath155    now , the derivatives @xmath156 can be calculated using the general algorithm introduced in the previous section simply noticing that , in this case , @xmath44 is precisely the potential energy of the system .",
    "therefore , the only objects that remain to be computed are the derivatives @xmath157 and @xmath158 , which can be known analytically ( they are _ geometrical _ [ or _ kinematical _ ] objects , i.e. , they do not depend of the potential energy ) .",
    "we now turn to the derivation of an explicit algorithm for finding them and thus completing the calculation that is the objective of this section .    in the supplementary material of ref .",
    "@xcite , we give a detailed and explicit way for expressing any ` primed ' vector @xmath159 as a function of all the internal coordinates , in the particular coordination scheme known as sasmic @xcite .",
    "we could take the final expression there [ eq .",
    "( 5 ) ] and explicitly perform the partial derivatives , however , we shall follow a different approach that is both more straightforward and applicable to a larger family of z - matrix - like schemes for defining internal coordinates .    in non - redundant internal coordinates schemes , whether they are defined as in ref .",
    "@xcite or not , each atom is commonly regarded as being incrementally added to the growing molecule for its coordination .",
    "this means that the position of the @xmath160-th atom in the body - fixed axes is uniquely specified by the values of three internal coordinates that are defined with respect to the positions of three other atoms with indices @xmath161 .",
    "this is a very convenient practice , and we will assume that we are dealing with a scheme that adheres to it .    normally , the first of the three internal coordinates used to position atom @xmath104 is the length of the vector joining @xmath104 and @xmath162 .",
    "atom @xmath162 is commonly chosen to be covalently attached to @xmath104 and , then , the length of this vector is naturally termed _ bond length _ , and denoted by @xmath163 . a given function",
    "@xmath162 embodies the protocol used for defining this atom , @xmath162 , to which each ` new ' atom @xmath104 is ( mathematically ) attached ; a superindex , as in @xmath164 , indicates composition of functions , and the iteration of such compositions allows us to trace a single - branched chain of atoms that takes from atom @xmath104 to atom 1 , at the origin of the ` primed ' axes . if @xmath165 is a number such that @xmath166 , this chain is given by the following set : @xmath167    it is clear that , if we now change a given bond length @xmath168 associated to atom @xmath169 , atom @xmath104 will move if @xmath170 ; simply because atom @xmath169 _ will _ move and @xmath104 has been positioned in reference to atom @xmath169 s position .",
    "thus , if we define @xmath171 for any @xmath104 , @xmath172 , and accordingly denote by @xmath173 the unitary vector in the ` primed ' for that points from atom @xmath174 to atom @xmath169 , a change in the bond length associated to @xmath169 from @xmath168 to @xmath175 ( while keeping the rest of the internal coordinates constant ) will translate all atoms @xmath104 such that @xmath170 a distance @xmath176 along @xmath173 , having @xmath177 and hence @xmath178    the second internal coordinate , after @xmath163 , that is typically defined to position atom @xmath104 with respect to the ` already positioned ' part of the molecule is a so - called _ bond angle _ @xmath179 . to define this angle",
    ", we need an additional atom associated with @xmath104 , which we could denote by @xmath180 . although one can in principle think of the possibility of using different atoms @xmath181 and @xmath182 to define the bond angle than the one used to define the bond length , the common practice in the literature is to use the same three atoms @xmath162 , @xmath180 and @xmath183 , to define the three internal coordinates associated to @xmath104 .",
    "this is also the choice in the sasmic scheme and the one in this work .",
    "the angle @xmath179 is thus defined as 180@xmath184 minus the angle formed between the vectors @xmath185 and @xmath186 ( see fig .",
    "[ fig : rotation_bond_angle ] ) .",
    "now , the reasoning is the same as in the case of the derivative with respect to @xmath168 : for every atom @xmath187 that is the ` tip ' of the bond angle @xmath188 , the changes in this angle ( keeping the rest of internal coordinates constant ) will move atom @xmath169 and therefore all atoms @xmath104 that contain atom @xmath169 in the chain @xmath189 that links them to atom 1 .    if we now look at fig .",
    "[ fig : rotation_bond_angle ] , we see that a change from @xmath188 to @xmath190 amounts to rotate all atoms @xmath104 that contain @xmath169 in their chain to the origin an angle @xmath191 around the unitary vector @xmath192 , which is defined by @xmath193    the result , @xmath194 , of rotating a vector @xmath195 around the direction given by the unitary vector @xmath196 an amount @xmath197 is given by the well - known _ rodrigues rotation formula _",
    "@xcite : @xmath198    however , notice that , in order to define a rotation , it is not enough to specify the angle @xmath197 and the rotation axis @xmath196 , but one additionally needs to specify a fixed point ( which can actually be any of the points in a fixed line in the direction of @xmath196 ) .",
    "therefore , the above expression is only correct for either ` free ' vectors @xmath195 ( i.e. , those that are not associated to a given point in space ) , or for vectors @xmath195 whose starting point lies in the aforementioned fixed line .    the fixed point for the rotation we are interested in can be chosen to be @xmath174 and , using eq .",
    "( [ eq : rodrigues ] ) , we have that @xmath199 \\sin d\\theta   \\\\   & & \\mbox { } +   \\hat{\\theta}_\\varepsilon \\big [ \\hat{\\theta}_\\varepsilon \\cdot    \\vec{r}_{\\beta(\\varepsilon)\\alpha}(\\theta_\\varepsilon ) \\big ]     ( 1 - \\cos d\\theta)\\ . \\nonumber\\end{aligned}\\ ] ]    then , keeping the terms up to first order in @xmath191 , we can easily compute the derivative : @xmath200 which , since a variation of @xmath188 does not move atom @xmath174 ( i.e. @xmath201 ) , allows us to conclude that @xmath202 if @xmath203 .",
    "the third and last internal coordinate that is usually defined to position atom @xmath104 is a so - called _ dihedral angle _ @xmath204 . to define this angle ,",
    "we need a third atom associated with @xmath104 , which we could denote by @xmath183 .",
    "the angle @xmath204 is thus defined as the oriented angle formed between the plane containing atoms @xmath162 , @xmath180 and @xmath183 and the plane containing atoms @xmath104 , @xmath162 and @xmath180 .",
    "the positive sense of @xmath204 is the one indicated in fig .",
    "[ fig : rotation_dihedral_angle ] , and , although it is common to find two different covalent arrangements of the four atoms @xmath104 , @xmath162 , @xmath180 and @xmath183 , termed _ principal _ and _ phase _ dihedral angles , respectively @xcite , this does not affect the mathematical definition of @xmath204 given in this paragraph , nor the subsequent calculations .",
    "regarding the derivative of the ` primed ' position of atom @xmath104 with respect to a given @xmath205 , the only difference with the bond angle case is that , now , the rotation is performed around the direction given by the unitary vector @xmath206 ( see fig .",
    "[ fig : rotation_dihedral_angle ] ) .",
    "the fixed point can be again chosen as @xmath174 , and eq .",
    "( [ eq : dr_dtheta2 ] ) ( changing @xmath188 by @xmath205 and @xmath192 by @xmath206 ) , as well as the fact that changes in @xmath205 do not move atom @xmath174 , still hold",
    ". therefore , @xmath207 if @xmath203 .    in order to decide whether or not atom @xmath104 will move upon changes in internal coordinates associated to atoms @xmath169 that _ do not _ belong to @xmath189 we must first finish the story about internal coordinates definition .",
    "since the argument above to show that @xmath104 moved when @xmath203 was that @xmath169 _ itself _ moved and it was used to position @xmath104 , we must ask    1 .   whether or not there can be atoms that are also used to position @xmath104 but that do not belong to @xmath189 , and 2 .   what happens when we change the internal coordinates associated to them .",
    "the answers to these two questions depend on the particular scheme used to define the internal coordinates , and we will tackle them referring to the sasmic scheme @xcite , which is the one used in this work : according to the sasmic rules , there are only two situations in which an atom @xmath208 can be used to position atom @xmath104 , and they are depicted in fig .  [ fig : special_cases ] .    the first case , in fig .",
    "[ fig : special_cases]a , attains only the first atoms of the molecule .",
    "typically , atom 1 is not a first - row atom , but a hydrogen ( such is the case of the three molecules studied , for example , in results and discussion ) .",
    "hence , after positioning atoms 2 and 3 , which are typically first - row , it is more representative to choose atom 3 as @xmath180 and atom 1 as @xmath183 when positioning the rest of the atoms @xmath104 attached to atom 2 .",
    "this makes @xmath209 and hence @xmath180 qualifies as an atom that is used to position @xmath104 but which is not included in the chain @xmath189 .    the second case , in fig .",
    "[ fig : special_cases]b , corresponds to the situation in which the molecule divides in two branches , and it can happen all along its chemical structure . if atom @xmath169 is the atom that defines the only principal dihedral over the bond connecting @xmath210 and @xmath174 ( in the sasmic scheme , only one principal dihedral can be defined on a given bond @xcite ) , and atom @xmath104 belongs to a different branch than the one beginning in @xmath169 ( the branches are indicated with grey broad arrows ) , then the starting atom @xmath211 of the branch to which @xmath104 belongs ( @xmath211 can be @xmath104 itself ) must be positioned using a phase dihedral in which @xmath212 .",
    "thus , @xmath169 is an atom that is used to position @xmath104 , but which does not belong to the chain @xmath189 connecting @xmath104 to atom 1 .    in principle , any change in the internal coordinates of atom @xmath180 , in the first case , or in those of atom @xmath169 , in the second case , may move atom @xmath104 , however , due to the geometrical characteristics of the internal coordinates , this is not the case .    for example , it is easy to see that , in the case depicted in fig .",
    "[ fig : special_cases]a , a variation of the bond length @xmath168 ( denoting @xmath213 ) does not move atom @xmath104 . regarding the angles ,",
    "the dihedral @xmath205 is not defined because @xmath214 , and a change in @xmath188 can be seen to rotate atom @xmath104 with fixed point @xmath215 and around the axis given exactly by @xmath192 as defined in eq .",
    "( [ eq : theta_varepsilon ] ) .",
    "( it is not trivial to see that this motion keeps all the rest of internal coordinates constant , specially the phase dihedral @xmath204 .",
    "the authors found it helpful to imagine that atoms 1 , 2 and 3 lie in the plane of the paper , with @xmath192 and @xmath104 coming out of it towards the reader ; the first orthogonally and the second not . ) therefore , the derivative of the euclidean position of atom @xmath104 with respect to @xmath188 is also given by eq .",
    "( [ eq : dxp_dtheta1 ] ) in this special case .",
    "in the situation shown in fig .  [",
    "fig : special_cases]b , one can see that neither a change in @xmath168 nor in @xmath188 move atom @xmath211 nor @xmath104 .",
    "however , if we change @xmath205 , we need to move atom @xmath211 if we want to keep @xmath216 constant . therefore , atom @xmath104 moves in such a case and it does so by rotating with the same fixed point @xmath174 and the same axis @xmath206 as in the simpler cases depicted in fig .",
    "[ fig : rotation_dihedral_angle ] .",
    "this means that , again , we can calculate the sought derivative using the already justified eq .",
    "( [ eq : dxp_dphi1 ] ) .    in summary , only changes in bond lengths associated to atoms @xmath203 affect the position of atom @xmath104 : @xmath217 changes both in bond angles associated to atoms @xmath203 and to @xmath180 in fig .",
    "[ fig : special_cases]a affect the position of atom @xmath104 : @xmath218 \\\\ 0 & \\mathrm{otherwise } \\\\ \\end{cases}\\ ; \\ ] ] and changes both in dihedral angles associated to atoms @xmath170 and to those that define the principal dihedral at a branching point that leads to atom @xmath104 ( see fig .",
    "[ fig : special_cases]b ) can affect the position of atom @xmath104 : @xmath219 \\\\ 0 & \\mathrm{otherwise } \\\\",
    "\\end{cases}\\ .\\ ] ]    finally , the outline of the algorithm for calculating the sought derivatives @xmath220 along the constrained subspace @xmath142 is :    1 .",
    "calculate the chain @xmath189 that connects atom @xmath104 with atom 1 and identify the special cases depicted in fig .",
    "[ fig : special_cases ] .",
    "2 .   calculate the derivatives @xmath221 by solving the system of linear equations in  ( [ eq : fsolved ] ) .",
    "3 .   calculate the geometric derivatives @xmath222 and @xmath223 , for @xmath224 , using eqs .",
    "( [ eq : dxp_dr ] ) , ( [ eq : dxp_dtheta ] ) and  ( [ eq : dxp_dphi ] ) .",
    "4 .   plug all the calculated quantities into eq .",
    "( [ eq : der_xp ] ) et voil .",
    "in this section , we compare the finite - differences approach ( see methods ) to the new algorithm introduced in this work with two objectives in mind : the validation of the new scheme , and the identification of the most important pitfalls of the finite - differences technique , which are absent in the new method .",
    "it is worth stressing again that the method presented here is the first of its kind , as far as we are aware , and the finite - differences scheme is just a very natural and straightforward method that is always available when derivatives need to be calculated .",
    "in fact , the pitfalls of finite differences which we highlight in this section are very well known , although they have been seldomly presented in the context of molecular force fields .",
    "we hope that this section can be additionally useful to revisit this classical topic from a new angle .    to these two ends",
    ", we have applied the more specific algorithm introduced in the previous section for the calculation of the derivatives of the euclidean coordinates of molecular systems to the three biological species in fig .",
    "[ fig : molecules ] : methanol , n - methyl - acetamide ( abbreviated nma ) , and the tripeptide n - acetyl - glycyl - glycyl - glycyl - amide ( abbreviated gly3 ) . for each one of these molecules ,",
    "a number of dihedral angles describing rotations around single bonds ( and indicated with light - blue arrows in fig .",
    "[ fig : molecules ] ) have been chosen as the unconstrained internal coordinates , @xmath144 , spanning the corresponding constrained internal subspace @xmath142 .",
    "the rest of internal coordinates @xmath17 ( bond lengths , bond angles , phase dihedrals , and principal dihedrals over non - single bonds ) are flexibly constrained as described in the previous sections .",
    "the numeration of the atoms and the definition of the internal coordinates follow the sasmic scheme , which is specially adapted to deal with constrained molecular systems @xcite .    for methanol and nma , due to the small dimensionality of their constrained subspaces ,",
    "the working sets of conformations have been generated by systematically scanning their unconstrained internal coordinates at finite steps .",
    "for methanol , we produced 19 conformations , in which the central dihedral , @xmath225 , ranges from @xmath226 to @xmath227 in steps of @xmath228 .",
    "similarly , the systematic scanning of the unconstrained dihedrals in nma produced a set of 588 conformations in which the first and last angles , @xmath225 and @xmath229 , range from @xmath226 to @xmath227 , and the central one , @xmath230 , ranges from @xmath226 to @xmath231 , all in steps of @xmath232 .",
    "for gly3 , and in view of the dimensionality of its constrained subspace , 1368 conformations were generated through a monte carlo with minimization procedure .    at each one of these conformations , defined by the value of the unconstrained internal coordinates @xmath144 , the constrained coordinates",
    "@xmath17 were found by minimizing the potential energy @xmath233 at fixed @xmath144 , thus enforcing the constraints @xmath234 described in methods .",
    "let us remark that this fixing of the coordinates @xmath144 is just an algorithmic way of sampling the constrained subspace defined by the relations @xmath234 , and it does not imply that the coordinates @xmath144 are constrained ; indeed , they could take any value in the set of conformations , whereas the constrained coordinates @xmath17 are fixed by the aforementioned relations .",
    "the potential energy and force - field parameters were taken from the amber 96 parameterization @xcite , and local energy minimization with respect to the constrained coordinates was performed with gaussian 03 @xcite . at the minimized points , the euclidean coordinates ,",
    "@xmath235 , of all atoms in the system - fixed axes defined in the methods section were also computed .    in order to find the partial derivatives @xmath236 at the generated points by finite differences",
    ", we produced , for each conformation in the working sets , @xmath237 additional conformations , each one with a single coordinate @xmath153 displaced to @xmath238 .",
    "after the re - minimization of the constrained coordinates at the new points , we were in possession of all the data needed to compute the estimate of the sought derivative in eq .",
    "( [ eq : finite_differences ] ) for all unconstrained coordinates . in order to assess the behaviour and accuracy of the finite - differences approach",
    ", we performed these calculations for the values @xmath239 .    on the other hand , to calculate the derivatives @xmath240",
    "using the new scheme introduced in methods , we do not need to perform any additional minimization , but we need to know the hessian matrix of the second derivatives of @xmath233 with respect to the internal coordinates .",
    "the hessian in internal coordinates was calculated with the gaussian 03 package @xcite .    in order to compare the two methods , we turn first to the smallest system : methanol . in fig .  [",
    "fig : methanol_derivatives]a , we can see the value of the derivative @xmath241 of the @xmath25-coordinate ( in the ` primed ' axes , but we drop the prime from now on ) of hydrogen number 5 ( see fig .",
    "[ fig : molecules ] ) with respect to the unconstrained dihedral angle @xmath225 that describes the rotation of the alcohol group with respect to the methyl one .",
    "we can see that the agreement between the new algorithm and the finite - differences approach is good but not perfect , and that the discrepancy between the two is larger for the smallest ( @xmath242 ) and largest ( @xmath243 ) values of @xmath73 depicted in the graph .",
    "to track the source of this difference , we can take a look at eq .",
    "( [ eq : derz1bis ] ) , which gives the derivative @xmath240 as a function of simple , ` geometrical ' terms , @xmath244 and @xmath245 , and the numerical derivatives @xmath221 .",
    "of course , the choice of one method or another does not affect the former , but only the latter . in the particular case of @xmath241 in fig .",
    "[ fig : methanol_derivatives]a , if we remove the terms that are zero according to the rules in eqs .",
    "( [ eq : dxp_dr ] ) , ( [ eq : dxp_dtheta ] ) and  ( [ eq : dxp_dphi ] ) , eq .",
    "( [ eq : derz1bis ] ) becomes @xmath246    the numerical derivatives appearing in this expression that are related to the three constrained coordinates associated to atom 5 are shown in figs .  [",
    "fig : methanol_derivatives]b , [ fig : methanol_derivatives]c and [ fig : methanol_derivatives]d , respectively , where we can see that the discrepancy between the new algorithm and the finite - differences approach is more significant . for the bond angle @xmath247 in fig .",
    "[ fig : methanol_derivatives]b , we see that the derivative predicted by finite differences is close to zero for all values of @xmath225 and for all the tested @xmath73s , while the behaviour given by the new algorithm is more rich and substantially different .",
    "this large discrepancy is produced by the fact that bond lengths are very stiff coordinates in the energy function that we have used here , together with the default precision of the floating point numbers provided by gaussian 03 outputs . in table",
    "[ tab : methanol_hard ] , we can see indeed that the last significant figure of bond length @xmath247 only starts to change for @xmath248 , which makes any algorithm based on finite differences very unreliable for this particular quantity if small values of @xmath73 are used .",
    "the bond angles and dihedral angles , on the other hand , are somewhat less stiff than bond lengths , as it can also be seen in tab .  [ tab : methanol_hard ] .",
    "this makes their derivatives by finite differences more reliable , as one can observe in figs .",
    "[ fig : methanol_derivatives]c and [ fig : methanol_derivatives]d , where the discrepancy with the new method is apparent for small @xmath73 , but becomes gradually smaller as we increase it .",
    "of course , since , in the new method presented in this work , all quantities are computed at the non - displaced point @xmath249 , the problem regarding the number of significant figures does not appear .",
    "it is also worth remarking that , in the case of finite differences , the point in which this issue will appear depends on the number of bits used to represent coordinates , but it will always appear for some small enough value of @xmath73 .    as we noticed in fig .  [",
    "fig : methanol_derivatives]a , also in the case of the constrained internal coordinates the difference between the two methods starts to grow again when @xmath73 reaches @xmath250 or @xmath243 .",
    "this is easily understood if we think that only in the @xmath251 limit the estimate in eq .",
    "( [ eq : finite_differences ] ) converges to the actual value of the partial derivative .",
    "in fact , as the complexity of the system increases , the error introduced at large @xmath73 may come not only from continuous changes in the location of the constrained minima , but also , as fig .",
    "[ fig : metastable ] suggests , it may occur that , at a certain value of @xmath73 , the very _ identity _ of the minima is altered , thus introducing potentially larger errors . in fig .",
    "[ fig : metastable]a , we can see that the derivative @xmath252 in gly3 presents an unusually large error at the conformation 1044 . in fig .",
    "[ fig : metastable]b , we see that the minimum - energy value of @xmath253 , which is the dihedral angle associated to carbon 22 , describing the rotation around a given peptide bond ( see fig .",
    "[ fig : molecules]c ) , presents an abrupt change when @xmath73 reaches @xmath228 .",
    "if we think that the energy landscape of gly3 is indeed a complex and multidimensional one , it is not difficult to imagine that , as we change @xmath254 , i.e. , as we increase @xmath73 , the energy landscape is so altered that some minima disappear , some other appear , and the energy ordering among them is changed .",
    "in such a case , the structures found by the minimization procedure will be rather different between , say , @xmath249 and @xmath255 , thus producing a large error in the derivatives calculated by finite differences .",
    "again , the new algorithm , which only uses quantities calculated at @xmath249 , does not suffer from this drawback .    to sum up",
    ", the finite - differences method contains two sources of error which the new method does not present : one at small values of @xmath73 , related to the finite precision of the floating point numbers representing the internal coordinates , and the other at larger values of @xmath73 , stemming from the very definition of the partial derivative by finite differences , and aggravated by the complexity of the energy landscapes of large systems .",
    "if the derivatives are to be calculated using finite differences , an optimal value of @xmath73 must be chosen in each case so that the possible error is minimized .",
    "however , already in the simple example of methanol , we saw that the derivatives of different observables , in the same system , may behave differently as we change @xmath73 ( compare the bond length derivative in fig .",
    "[ fig : methanol_derivatives]b with that of the angles in figs .",
    "[ fig : methanol_derivatives]c and  [ fig : methanol_derivatives]d ) . in fig .",
    "[ fig : delta_system_tuning ] , we additionally see that the search for the optimal @xmath73 may be further complicated by the fact that the behaviour found also depends ( strongly ) on the system studied , and , in the case of the derivatives of the euclidean coordinates , on the position of the atom in the molecule .    in fig .",
    "[ fig : delta_system_tuning]a , we have plotted the normalized average of the absolute value of the error in the derivatives of the euclidean coordinates , @xmath256 , as a function of @xmath73 for the three molecular systems studied .",
    "this quantity is defined , for a given unconstrained coordinate @xmath153 , as @xmath257 where the index @xmath258 indicates the conformation in the working set , running from 1 to @xmath259 , fd stands for ` finite differences ' , na for ` new algorithm ' , and @xmath260 is a normalizing quantity for each coordinate @xmath261 chosen as @xmath262    the graphics in fig .  [",
    "fig : delta_system_tuning]a of this quantity correspond to the unconstrained dihedral angles @xmath225 , @xmath230 and @xmath254 of methanol , nma and gly3 , respectively ( see fig .  [",
    "fig : molecules ] ) .",
    "we observe that the average error as a function of @xmath73 presents significantly different behaviours in the three molecules , never being smaller than a 2% . additionally , in fig .",
    "[ fig : delta_system_tuning]b , we show the same error but this time individualized to the @xmath263-coordinate of three different @xmath264-row atoms of nma : c3 , n6 and c8 .",
    "although the overall behaviour of the error is similar for the three atoms , its size is not .",
    "all in all , we see that the need to tune for the optimal @xmath73 in the finite - differences approach not only produces unavoidable errors , but also it must be done in a per - system , per - observable basis , clearly complicating and limiting the use of this technique . the new algorithm , on the other hand",
    ", is only affected by the source of error related to the accuracy with which the hessian matrix of the potential energy can be calculated and inverted ; apart from this , which is a general drawback of any method implemented in a computer , its mathematical definition is ` exact ' , in the sense that it does not contain any tunable parameter , like @xmath73 , that must be adjusted for optimal accuracy in each particular problem .    also , and more importantly ( since the failure of finite differences was indeed predictable ) the good coincidence between the newly introduced , somewhat more involved method and the straightforward finite - differences scheme for the smallest system and in some intermediate range of values of @xmath73 allows us to regard the new scheme as validated and error - free .",
    "finally , despite what we discussed in the methods section , namely , that we have not pursued here the numerical optimization of the algorithm introduced , being our main interest to present the general theoretical concepts and to show that the new method is exact and reliable , we close this section with an example of a toy system to provide a clue that the new technique is at least feasible . before introducing the toy system",
    "it is worth noting that the examples tackled in this section are just particular cases , but the technique can be used in different systems and with different potential energy functions .",
    "when looking at the computer costs presented below , the reader should bear in mind that they may be not very significant ( due to the aforementioned lack of optimization ) and not very relevant ( due to the choice of a small toy system and a given potential energy function ) .",
    "of course , if any production runs using the new algorithm are attempted , a thorough numerical optimization and assessment should be performed , which we deem to be a very important next step of our work .",
    "the toy system is a 2-dimensional one , with positions @xmath25 and @xmath23 , and the following potential energy ( see fig .",
    "[ fig : v_toy ] ) : @xmath265    if we take a large enough @xmath58 , say @xmath266 , we see that the system will present a strong oscillatory motion in the @xmath23 coordinate , around approximately @xmath267 ( but not exactly , since the term @xmath268 slightly modifies the position of the minimum ) , and with harmonic constant approximately equal to @xmath269 . in the spirit of this work , since , due to energetic reasons",
    ", the value of @xmath23 will seldomly move far away from the value that minimizes @xmath270 for each @xmath25 , denoted by @xmath271 and implicitly defined by the following equation : @xmath272 we can kill this oscillatory motion by assuming that a flexible constraint @xmath273 exists . in such a case",
    ", @xmath25 plays the role of the whole set of unconstrained coordinates @xmath144 in the general formalism , and @xmath23 plays the role of the whole set of constrained coordinates @xmath17 .",
    "now , if we perform a ` molecular dynamics ' of this system , then we may need at some point to compute the derivative with respect to @xmath25 of some observable @xmath274 restricted to the constrained subspace @xmath275 ( for example , we may need this to calculate mass - metric tensor corrections at each time step @xcite ) .",
    "we can do so by using finite differences or the new technique introduced in this work . as we discussed in the methods section , for both approaches we will need to perform a minimization of @xmath270 at each fixed @xmath25 in order to find @xmath271 and @xmath276 , hence , being this step common , we will not consider it for the assessment of the differences in computational cost between the two methods .",
    "the additional computations that will decide which method is faster are :    * * for finite differences : * choose a displaced value of the unconstrained coordinate @xmath277 , minimize @xmath278 with respect to @xmath23 in order to find @xmath279 , as well as @xmath280 , and finally calculate the finite - differences estimation of the sought derivative : @xmath281 * * for the new method : * calculate the objects in eq .",
    "( [ eq : fsolved ] ) , perform the required inversion to find @xmath282 , calculate the objects in eq .",
    "( [ eq : derz1 ] ) , and finally find @xmath283 using this last expression . in this simple case ,",
    "all the objects to be computed are : @xmath284    the second - order derivatives of the potential energy can be easily calculated :    [ eq : der2_v_toy ] @xmath285\\big ) + \\frac{1 - 2xy \\tanh(xy)}{\\cosh^2(xy ) }   \\ , \\label{eq : der2_v_toy_b}\\end{aligned}\\ ] ]    and we can use them to find the derivative of @xmath271 through eq .  ( [ eq : fsolved ] ) : @xmath286 \\big/   \\left[\\frac{\\partial^2 v}{\\partial y^2}\\big(x , f(x)\\big)\\right ] \\ .\\ ] ]    the particularization of eq .",
    "( [ eq : derz1 ] ) to this simple case is @xmath287    in this section , for illustrative purposes , we have chosen a simple observable @xmath274 : @xmath288 i.e. , the distance of the particle to the origin of coordinates .",
    "hence , the remaining objects that we need to compute in order to apply the new technique to this problem are    [ eq : derx_v_toy ] @xmath289    we have calculated @xmath290 using both techniques for 11 different values of @xmath291 . this calculation has been performed in a desktop imac with a 2.66 ghz intel core 2 duo processor and 4 gb of 1067 mhz dd3 ram memory , running macosx snow leopard .",
    "the same compilation - time optimizations have been used in the two cases , and the common times have been subtracted as indicated before .",
    "it is also worth remarking that we have used brent s method @xcite for minimizing @xmath270 , and a different choice will change the comparison . in these conditions , the new technique has proved approximately one order of magnitude faster than finite differences , elapsing @xmath292 @xmath293s / point vs. @xmath294 @xmath293s / point .    in summary , in this work , we have introduced a new , exact , parameter - free method for computing the derivatives of physical observables in systems with flexible constraints .",
    "the new algorithm has been numerically validated in small molecules against its most natural alternative , finite differences . in doing so ,",
    "numerous pitfalls of the latter method have been demonstrated , all arising from the fact that it contains a tunable parameter that has to be optimally adjusted in each particular problem at hand . in a number of numerical experiments",
    ", we have shown that the finite - differences approach contains two unavoidable sources of error that are not present in the new method : on the one hand , the finite number of significant figures used to represent , in computers , the values of the optimized coordinates , together with the fact that these constrained coordinates are typically very stiff , make the changes in this quantities often unobservable or at least badly resolved , thus rendering the finite - differences derivatives unreliable for small values of the displacement parameter @xmath73 . on the other hand , the very fact that finite - differences derivatives only converge to the true ones for @xmath251 , complicated with the possibility that the energy landscapes of complex molecular systems may significantly change their structure when the unconstrained coordinates are displaced , introduce new errors as @xmath73 increases .",
    "these two sources of errors combined make compulsory the search of an optimal value of @xmath73 in each particular case , and also establish a minimum error below which is not possible to go , as it can be seen in fig .",
    "[ fig : delta_system_tuning ] .",
    "also , using a simple toy system , we have shown that the new technique can be faster than finite differences in certain situations . the new method introduced here , and it is already being successfully used in a number of works in progress in our group to compute the correcting terms appearing in the equilibrium probability distribution when flexible constraints are imposed on the system @xcite . moreover , given the almost ubiquitous occurrence of the concept of constraints all throughout the fields of computational physics and chemistry , it is expected that the method described in this work will find many applications in present and future problems .",
    "some examples have been already mentioned in the introduction , notably the case of ground - state born - oppenheimer md @xcite ( using , e.g. , hartree - fock @xcite ) , which can be regarded as a flexibly constrained problem in which the soft coordinates are the nuclear positions @xmath295 , the hard ones are the electronic orbitals @xmath296 , and the function to be minimized is the expected value @xmath297 of the @xmath295-dependent electronic hamiltonian in the @xmath8-electron slater determinant @xmath298 .",
    "we thank the reviewers of the manuscript for their insightful comments that have contributed to improve the final version .",
    "we aknowledge funding from the grants fis2009 - 13364-c02 - 01 ( micinn , spain ) , grupo de excelencia `` biocomputacin y fsica de sistemas complejos '' , e24/3 ( aragn region government , spain ) , araid and ibercaja grant for young researchers ( spain ) .",
    "r . has been supported by a jae - predoc scholarship ( csic , spain ) .",
    "43 [ 1]#1 [ 1]`#1 ` urlstyle [ 1]doi : # 1    m.  p. allen and d.  j. tildesley .",
    "_ computer simulation of liquids_. clarendon press , oxford , 2005 .",
    "j.  l. alonso , x.  andrade , p.  echenique , f.  falceto , d.  prada - gracia , and a.  rubio .",
    "efficient formalism for large - scale ab initio molecular dynamics based on time - dependent density functional theory .",
    "_ , 101:0 096403 , 2008 .",
    "x.  andrade , a.  castro , d.  zueco , j.  l. alonso , p.  echenique , f.  falceto , and a.  rubio .",
    "modified ehrenfest formalism for efficient large - scale ab initio molecular dynamics .",
    "_ j. chem .",
    "theory comput .",
    "_ , 5:0 728742 , 2009 .",
    "s.  belongie .",
    "rodrigues rotation formula . from mathworld",
    " a wolfram web resource .",
    "http://mathworld.wolfram.com/implicitfunctiontheorem.html , last accessed on 08/12/2009 .",
    "b.  r. brooks , c.  l. brooks  iii , a.  d. mackerell , l.  nilsson , r.  j. petrella , b.  roux , y.  won , g.  archontis , c.  bartels , s.  boresch , a.  caflisch , l.  caves , c.  cui , a.  r. dinner , m.  feig , s.  fischer , j.  gao , m.  hodoscek , w.  i m , k.  kuczera , t.  lazaridis , j.  ma , v.  ovchinnikov , e.  paci , r.  w. pastor , c.  b. post , j.  z. pu , m.  schaefer , b.  tidor , r.  m. venable , h.  l. woodcock , x.  wu , w.  yang , d.  m. york , and m.  karplus . : the biomolecular simulation program .",
    "_ j. comput",
    ". chem . _ , 30:0 15451615 , 2009 .",
    "r.  car and m.  parrinello",
    ". unified approach for molecular dynamics and density - functional theory .",
    "_ , 55:0 24712474 , 1985 .",
    "e.  a. carter , g.  ciccotti , j.  t. hynes , and r.  kapral .",
    "constrained reaction coordinate dynamics for the simulation of rare events .",
    "_ , 5:0 472477 , 1989 .",
    "d.  a. case , t.  a. darden , t.  e. cheatham  iii , c.  l. simmerling , j.  wang , r.  e. duke , r.  luo , m.  crowley , r.  c. walker , w.  zhang , k.  m. merz , b.  wang , s.  hayik , a.  roitberg , g.  seabra , i.  kolossvry , k.  f. wong , f.  paesani , j.  vanicek , x.  wu , s.  r. brozell , t.  steinbrecher , h.  gohlke , l.  yang , c.  tan , j.  mongan , v.  hornak , g.  cui , d.  h. mathews , m.  g. seetin , c.  sagui , v.  babin , and p.  a. kollman .",
    "university of california , san francisco , 2008 .",
    "m.  christen and w.  f. van gunsteren . an approximate but fast method to impose flexible distance constraints in molecular dynamics simulations .",
    "_ j. chem .",
    "_ , 122:0 144106 , 2005 .",
    "m.  christen , c.  d. christ , and w.  f. van gunsteren .",
    "free energy calculations using flexible - constrained , hard - constrained and non - constrained molecular dynamics simulations . _ chemphyschem _ , 8:0 15571564 , 2007 .",
    "w.  d. cornell , p.  cieplak , c.  i. bayly , i.  r. gould , jr .",
    "merz , k.  m. , d.  m. ferguson , d.  c. spellmeyer , t.  fox , j.  w. caldwell , and p.  a. kollman . a second generation force field for the simulation of proteins , nucleic acids , and organic molecules .",
    "_ , 117:0 51795197 , 1995 .",
    "c.  j. cotter and s.  reich .",
    "adiabatic invariance and applications from molecular dynamics to numerical weather prediction .",
    "_ bit num .",
    "_ , 44:0 439455 , 2004 .",
    "t.  a. darden , d.  york , and l.  pedersen .",
    "particle mesh ewald : an @xmath299 method for ewald sums in large systems .",
    "_ j. chem .",
    "_ , 98:0 1008910092 , 1993 .",
    "b.  a. dubrovin , a.  t. fomenko , and s.  p. novikov .",
    "_ modern geometry  methods and applications_. springer , berlin , 1992 .",
    "j.  w. eastwood and r.  w. hockney . shaping the force law in two - dimensional particle mesh models .",
    "_ j. comput .",
    "_ , 16:0 342359 , 1974 .",
    "p.  echenique .",
    "introduction to protein folding for physicists .",
    "_ contemp .",
    "_ , 48:0 81108 , 2007 .",
    "p.  echenique and j.  l. alonso .",
    "definition of systematic , approximately separable and modular internal coordinates ( sasmic ) for macromolecular simulation .",
    "_ j. comput .",
    "_ , 27:0 10761087 , 2006 .",
    "p.  echenique and j.  l. alonso . a mathematical and computational review of hartree - fock scf methods in quantum chemistry . _ mol . phys .",
    "_ , 105:0 30573098 , 2007 .",
    "p.  echenique and i.  calvo .",
    "explicit factorization of external coordinates in constrained statistical mechanics models .",
    "_ j. comput .",
    "_ , 27:0 17331747 , 2006 .",
    "p.  echenique , i.  calvo , and j.  l. alonso .",
    "quantum mechanical calculation of the effects of stiff and rigid constraints in the conformational equilibrium of the alanine dipeptide .",
    "_ j. comput .",
    "_ , 27:0 17481755 , 2006 .",
    "p.  echenique , c.  n. cavasotto , and p.  garca - risueo .",
    "the canonical equilibrium of constrained molecular models . in progress , http://arxiv.org/abs/1105.0374 , 2011 .",
    "d.  frenkel and b.  smit .",
    "_ understanding molecular simulations : from algorithms to applications_. academic press , orlando fl , 2nd edition , 2002 .",
    "m.  j. frisch , g.  w. trucks , h.  b. schlegel , g.  e. scuseria , m.  a. robb , j.  r. cheeseman , j.  a. montgomery , jr .",
    ", t.  vreven , k.  n. kudin , j.  c. burant , j.  m. millam , s.  s. iyengar , j.  tomasi , v.  barone , b.  mennucci , m.  cossi , g.  scalmani , n.  rega , g.  a. petersson , h.  nakatsuji , m.  hada , m.  ehara , k.  toyota , r.  fukuda , j.  hasegawa , m.  ishida , t.  nakajima , y.  honda , o.  kitao , h.  nakai , m.  klene , x.  li , j.  e. knox , h.  p. hratchian , j.  b. cross , v.  bakken , c.  adamo , j.  jaramillo , r.  gomperts , r.  e. stratmann , o.  yazyev , a.  j. austin , r.  cammi , c.  pomelli , j.  w. ochterski , p.  y. ayala , k.  morokuma , g.  a. voth , p.  salvador , j.  j. dannenberg , v.  g. zakrzewski , s.  dapprich , a.  d. daniels , m.  c. strain , o.  farkas , d.  k. malick , a.  d. rabuck , k.  raghavachari , j.  b. foresman , j.  v. ortiz , q.  cui , a.  g. baboul , s.  clifford , j.  cioslowski , b.  b. stefanov , g.  liu , a.  liashenko , p.  piskorz , i.  komaromi , r.  l. martin , d.  j. fox , t.  keith , m.  a. al - laham , c.  y. peng , a.  nanayakkara , m.  challacombe , p.  m.  w. gill , b.  johnson , w.  chen , m.  w. wong , c.  gonzalez , and j.  a. pople .",
    "gaussian 03 , revision e.01 , 2007 .",
    "aussian , inc . ,",
    "wallingford , ct .",
    "n.  g and h.  a. scheraga . on the use of classical statistical mechanics in the treatment of polymer chain conformation .",
    "_ macromolecules _ , 9:0 535 , 1976 .",
    "h.  goldstein , c.  poole , and j.  safko .",
    "_ classical mechanics_. addison - wesley , 3rd edition , 2002 .",
    "l.  greengard and v.  rokhlin .",
    "a fast algorithm for particle simulations .",
    "_ j. comput .",
    "_ , 73:0 325348 , 1987 .",
    "e.  helfand .",
    "flexible vs. rigid constraints in statistical mechanics .",
    "_ j. chem .",
    "_ , 71:0 5000 , 1979 .",
    "b.  hess , h.  saint - martin , and h.  j.  c. berendsen .",
    "flexible constraints : an adiabatic treatment of quantum degrees of freedom , with application to the flexible and polarizable mobile charge densities in harmonic oscillators model for water . _ j. chem .",
    "_ , 116:0 9602 , 2002 .",
    "j.  hutter and a.  curioni .",
    "car - parrinello molecular dynamics on massively parallel computers .",
    "_ chemphyschem _ , 6:0 17881793 , 2005 .",
    "f.  jensen .",
    "_ introduction to computational chemistry_. john wiley & sons , chichester , 1998 .",
    "w.  l. jorgensen and j.  tirado - rives .",
    "the opls potential functions for proteins .",
    "energy minimization for crystals of cyclic peptides and crambin .",
    "_ , 110:0 16571666 , 1988 .",
    "w.  l. jorgensen , d.  s. maxwell , and j.  tirado - rives .",
    "development and testing of the opls all - atom force field on conformational energetics and properties of organic liquids .",
    "_ , 118:0 1122511236 , 1996 .",
    "p.  kollman , r.  dixon , w.  cornell , t.  fox , c.  chipot , and a.  pohorill .",
    "the development / application of a minimalist organic / biochemical molecular mechanic force field using a combination of ab initio calculations and experimental data . in w.",
    "f. van  gunsteren , p.  k. weiner , and a.  j. wilkinson , editors , _ computer simulations of biomolecular systems _ ,",
    "volume  3 , pages 8396 .",
    "kluwer academic publishing , dordrecht , 1997 .",
    "d.  a. pearlman , d.  a. case , j.  w. caldwell , w.  r. ross , t.  e. cheatham  iii , s.  debolt , d.  ferguson , g.  seibel , and p.  kollman . , a computer program for applying molecular mechanics , normal mode analysis , molecular dynamics and free energy calculations to elucidate the structures and energies of molecules .",
    "_ , 91:0 141 , 1995 .",
    "p.  pechukas .",
    "comment on : ` flexible vs. rigid constraints in statistical mechanics ' .",
    "_ j. chem .",
    "_ , 72:0 6320 , 1980 .",
    "j.  w. ponder and d.  a. case .",
    "force fields for protein simulations .",
    "_ , 66:0 2785 , 2003 .    w.  h. press , s.  a. teukolsky , w.  t. vetterling , and b.  p. flannery .",
    "_ numerical recipes . the art of scientific computing_. cambridge university press , new york , 3rd edition , 2007 .    d.  c. rapaport .",
    "_ the art of molecular dynamics simulation_. cambridge university press , 2nd edition , 2004 .",
    "j.  p. ryckaert , g.  ciccotti , and h.  j.  c. berendsen .",
    "numerical integration of the cartesian equations of motion of a system with constraints : molecular dynamics of n - alkanes .",
    "_ j. comput .",
    "_ , 23:0 327341 , 1977 .",
    "t.  schlick , e.  barth , and m.  mandziuk .",
    "biomolecular dynamics at long timesteps : bridging the timescale gap between simulation and experimentation .",
    "_ , 26:0 181222 , 1997 .",
    "n.  g. van  kampen and j.  j. lodder . constraints .",
    "_ , 52:0 419424 , 1984 .",
    "e.  w. weisstein .",
    "ordinary differential equations . from mathworld",
    " a wolfram web resource .",
    "http://mathworld.wolfram.com/ordinarydifferentialequations.html , last accessed on 03/17/09 .",
    "j.  zhou , s.  reich , and b.  r. brooks .",
    "elastic molecular dynamics with self - consistent flexible constraints . _ j. chem .",
    "_ , 112:0 7919 , 2000 .",
    ", associated to atom @xmath169 , and the unitary vector @xmath192 corresponding to the direction around which all atoms @xmath104 with chains @xmath189 containing @xmath169 rotate if @xmath188 is varied while the rest of internal coordinates are kept constant . ]    , associated to atom @xmath169 .",
    "the positive sense of rotation is indicated in the figure , and we can distinguish between two situations regarding covalent connectivity : * a ) * _ principal dihedral angle _ , and * b ) * _ phase dihedral angle _ ( see ref .",
    "@xcite ) . ]",
    "connecting @xmath104 to atom 1 , but that are nevertheless used to position @xmath104 . ]     are indicated with light - blue arrows , and some internal coordinates and some atoms that appear in the discussion are specifically labeled .",
    "the constrained dihedral angle @xmath253 is indicated by a red arrow in gly3 . ]",
    "coordinate of atom 5 in methanol , * ( b ) * the bond length @xmath247 associated to it , * ( c ) * the bond angle @xmath300 , and * ( d ) * the dihedral angle @xmath301 as a function of the unconstrained coordinate @xmath225 .",
    "both the results of the new algorithm and those obtained by finite differences ( fd ) are depicted .",
    "the key for the different types of line is the same in the four graphs . ]     of the constrained dihedral angle @xmath253 , describing a peptide bond rotation in gly3 , with respect to the unconstrained coordinate @xmath254 for a selected set of conformations in the working set . *",
    "( b ) * minimum - energy value of the constrained dihedral angle @xmath253 in the conformation 1044 of gly3 for different values of the displacement @xmath73 in the unconstrained coordinate @xmath254 . ]    . * average normalized error in the derivatives by finite differences as a function of @xmath73 ( see the text for a more precise definition ) . * ( a ) * error averaged to all conformations and all atoms of the three molecular systems studied . * ( b ) * error averaged to all conformations of the @xmath263-coordinate of three particular @xmath264-row atoms in nma . ]    ) . *",
    "the range of @xmath25 and @xmath23 corresponds to the one explored in this work .",
    "contour level lines and colour level indication in the surface have been added for visual comfort .",
    "all units are arbitrary . ]",
    "* stiffness of the constrained coordinates in methanol * [ cols=\">,<,^,^,^\",options=\"header \" , ]     values of the constrained coordinates associated to atom 5 of methanol for different displacements @xmath73 in the unconstrained coordinate @xmath225 .",
    "the values correspond to the conformation with @xmath302 , and the number of significant figures presented is the default one provided by gaussian 03 ."
  ],
  "abstract_text": [
    "<S> in this work . we introduce an algorithm to compute the derivatives of physical observables along the constrained subspace when flexible constraints are imposed on the system ( i.e. , constraints in which the constrained coordinates are fixed to configuration - dependent values ) . </S>",
    "<S> the presented scheme is exact , it does not contain any tunable parameter , and it only requires the calculation and inversion of a sub - block of the hessian matrix of second derivatives of the function through which the constraints are defined . </S>",
    "<S> we also present a practical application to the case in which the sought observables are the euclidean coordinates of complex molecular systems , and the function whose minimization defines the flexible constraints is the potential energy . finally , and in order to validate the method , which , as far as we are aware , is the first of its kind in the literature , we compare it to the natural and straightforward finite - differences approach in a toy system and in three molecules of biological relevance : methanol , n - methyl - acetamide and a tri - glycine peptide . </S>"
  ]
}