{
  "article_text": [
    "liquid chromatography combined with electrospray ionisation mass spectrometry ( esi - ms ) is one of the most frequently used approaches for conducting metabolomics experiments @xcite .",
    "collision - induced dissociation ( cid ) is usually employed within this procedure , intentionally fragmenting molecules into smaller parts to examine their structure .",
    "this is called ms / ms or tandem mass spectrometry . a significant bottleneck in such experiments is the interpretation of the resulting spectra to identify metabolites .",
    "widely used methods for putative metabolite identification @xcite , using mass spectrometry , compare a collected ms or ms / ms spectrum for an unknown compound against a database containing reference ms or ms / ms spectra @xcite .",
    "unfortunately , current reference databases are still fairly limited , especially in the case of esi - ms / ms . at the time of writing , the public human metabolome database @xcite contains esi - ms / ms data for around 800 compounds , which represents only a small fraction of the 40,468 known human metabolites it lists .",
    "the publicly available metlin database @xcite provides esi - ms / ms spectra for 11,209 of the 75,000 endogenous and exogenous metabolites it contains , although more than half of those spectra are for enumerated tripeptides .",
    "the public repository massbank @xcite contains a more diverse dataset of 31,000 spectra collected on a variety of different instruments , including esi - ms / ms spectra for approximately 2000 unique compounds .",
    "however , set against the more than 19 million chemical structures in the pubchem compound database @xcite , an estimated 200,000 plant metabolites @xcite , or even the 32,801 manually annotated entries in the database of chemical entities of biological interest ( chebi ) @xcite , we see that ms / ms coverage still falls far short of the vast number of known metabolites and molecules of interest .",
    "consequently , there is substantial interest in finding alternative means for identifying metabolites for which no reference spectra are available @xcite . for these cases , one approach to metabolite identification involves first predicting the ms or ms / ms spectrum for each candidate compound from its chemical structure @xcite .",
    "the interpreter then uses these predicted spectra in place of reference spectra , and labels the target spectrum as the metabolite whose predicted spectrum is the closest match , according to some similarity criteria . a wide range of similarity criteria",
    "have been proposed , from weighted counts of the number of matching peaks @xcite , to more complex probability based measures @xcite .",
    "the upshot of this predictive approach is that only a list of candidate molecules is needed , rather than a complete database of reference spectra .",
    "however , the restriction to a list of candidate molecules means that this approach still falls short of _ de novo _ identification of unknown unknowns @xcite , -i.e .",
    "we can not identify molecules not in the list .",
    "the concept of computer - based ms prediction has been around since the dendral project in the 1960 s , when investigators attempted to predict electron ionization ( ei ) mass spectra using early machine learning methods @xcite .",
    "more recent approaches to this problem have generally taken one of two forms : rule - based or combinatorial .",
    "commercial packages , such as mass frontier ( thermo scientific , www.thermoscientific.com ) , and ms fragmenter ( acd labs , www.acdlabs.com ) , are rule - based , using thousands of manually curated rules to predict fragmentations .",
    "primarily developed for ei fragmentation , these packages have been extended for use with esi .",
    "this current work does not compare against these methods empirically , however in at least one study they have been found to have been out - performed by metfrag @xcite , to which we do compare",
    ". @xcite another knowledge - based approach , called massimo , combines chemical knowledge with data ; using logistic regression to predict fragmentation probabilities for a particular class of ei fragmentations @xcite .",
    "the other class of algorithms applies a combinatorial fragmentation procedure , enumerating all possible fragments of the original structure by systematically breaking bonds @xcite .",
    "first proposed by @xcite , this method has been incorporated into the freely available programs fid @xcite and metfrag @xcite .",
    "both identify the given spectrum with the metabolite that has the most closely matching peaks via such a combinatorial fragmentation .",
    "these programs also employ several heuristics in their scoring protocols to emphasise the importance of more probable fragmentations .",
    "fid uses an approximate measure of the dissociation energy of the broken bond , combined with a measure of the energy of the product ion .",
    "metfrag incorporates a similar measure of bond energy combined with a bonus if the neutral loss formed is one of a common subset .",
    "an alternative method , fingerid @xcite , takes advantage of the increasing number of available ms / ms spectra , by applying machine learning methods to this task .",
    "this program uses support vector machines ( svms ) to predict a chemical fingerprint directly from an ms / ms spectrum , and then searches for the metabolite that most closely matches that predicted fingerprint . @xcite .",
    "the main problem with the current combinatorial methods is that , while they have very good recall , explaining most if not all peaks in each spectrum , they also have poor precision , predicting many more peaks than are actually observed .",
    "metfrag and fid attempt to address this problem by adding the heuristics described above . in our work ,",
    "we investigate an alternative machine learning approach that aims to improve the precision of such combinatorial methods .",
    "we propose a method for learning a generative model of the cid fragmentation process from data .",
    "this model estimates the likelihood of any given fragmentation event occurring , thereby predicting those peaks that are most likely to be observed .",
    "we hypothesise that increasing the precision of the predicted spectrum in this way will improve our system s ability to accurately identify metabolites .",
    "@xcite    section [ sec : cfm ] provides details of our proposed model and the training method .",
    "section [ sec : results ] then reports the experimental results .",
    "we will assume the reader knows the foundations of esi ms / ms ; for an introduction to this process , see @xcite .",
    "[ [ sec : cfm ] ]    this section presents our model for the esi - ms / ms cid fragmentation process , which we call competitive fragmentation modeling ( cfm ) , and a method for deriving parameters for this model from existing ms / ms data .",
    "section  [ sec : se ] describes the simplest form of this method ; single energy competitive fragmentation modeling ( se - cfm ) .",
    "section  [ combinedenergymodel ] then presents an extension of this method , combined energy competitive fragmentation modeling ( ce - cfm ) , which aims to make better use of cid ms / ms spectra measured at different energy levels for the same compound .",
    "windows executables and cross - platform source code and the trained models are freely available at http://sourceforge.net / projects / cfm - id/. a web server interface is also provided at http://cfmid.wishartlab.com .",
    "section  [ sec : results ]      in single energy cfm ( se - cfm ) , we model esi - ms / ms fragmentation as a stochastic , homogeneous , markov process @xcite involving state transitions between charged fragments , as depicted in figure  [ fig : model](a ) .        [",
    "fig : model ]    more formally , the process is described by a fixed length sequence of discrete , random fragment states @xmath0 , where each @xmath1 takes a value from the state space @xmath2 , the set of all possible fragments ; this state space will be further described in section  [ statespace ] .",
    "a transition model defines the probabilities that each fragment leads to another at one step in the process ; see section  [ transitionmodel ] .",
    "an observation model maps the penultimate node @xmath3 to a peak @xmath4 , which takes on a value in @xmath5 that represents the m / z value of the peak to which the final fragment will contribute ; see section  [ observationmodel ] .",
    "se - cfm is a latent variable model in which the only observed variables are the initial molecule @xmath6 and the output peak @xmath4 ; the fragments themselves are never directly observed .",
    "each output @xmath4 adds only a small contribution to a single peak in the mass spectrum . in order to predict a complete mass spectrum",
    ", we can run the model forward multiple times to compute the marginal distribution of @xmath4 .",
    "we make the following assumptions about the cid fragmentation process .",
    "further details for the motivations of each are provided below , but these generally involve a trade - off between accurately modeling the process and keeping the model computationally tractable .    1 .",
    "all input molecules have a single positive charge and exist in their most common isotopic form",
    ". 2 .   in a collision",
    ", each molecule will break into two fragments .",
    "no mass or charge is lost .",
    "one of the two fragments must have a single positive charge and the other must be neutral .",
    "combined , the two must contain all the components of the original charged molecule , i.e. all the atoms and electrons .",
    "4 .   no further sigma bonds can be removed or added during a break , except those connecting hydrogens i.e .",
    "the edges in the molecular graph must remain the same .",
    "rearrangement of pi bonds is allowed and hydrogen atoms may move anywhere in the two resulting fragments , on the condition that both fragments satisfy all valence rules , and standard bond limitations are met e.g .",
    "no bond orders higher than triple .",
    "the even electron rule is always satisfied i.e .",
    "no radicals .",
    "assumption 1 is reasonable as we assume that the first phase of ms / ms successfully restricts the mass range of interest to include only the [ m+h]@xmath7 precursor ion containing the most abundant isotopes .",
    "since this ion has only a single positive charge , we can safely assume that no multiply - charged ions will be formed in the subsequent ms2 phase .",
    "ensuring that valid [ m+h]@xmath7 precursor ions are selected in ms1 is beyond the scope of this work ; see @xcite for a summary of ms1 data processing methods .",
    "assumptions 2 , 4 and 6 do not necessarily hold in real - world spectra @xcite .",
    "however including them substantially reduces the branching factor of the fragment enumeration , making the computations feasible . since these assumptions do appear to hold in the vast majority of cases",
    ", we expect that including them should have minimal negative impact on the experimental results .",
    "note that most 3-way fragmentations can be modeled by two sequential , 2-way fragmentations , so including assumption 2 should not impact our ability to model most fragmentation events .",
    "assumption 5 allows for mclafferty rearrangement and other known fragmentation mechanisms @xcite .",
    "our method for enumerating fragments is similar in principle to the combinatorial approach used in metfrag and fid @xcite , with some additional checks to enforce the above assumptions .",
    "we systematically break all non - ring bonds in the molecule ( excluding those connecting to hydrogens ) and all pairs of bonds within each ring .",
    "we do this one break at a time , enumerating a subset of fragments with all possible masses that may form after each break , .",
    "this subset is found by determining the number of additional electrons that can be allocated to either side of the break using integer linear programming e.g . breaking the middle bond in ccc[ch4 + ]",
    "( smiles format ) gives fragments c=[ch3 + ] ( mass=29.04da , loss cc ) and c[ch4 + ] ( mass=31.05da , loss c = c ) ,    the fragmentation procedure is applied recursively on all the produced fragments , to a maximum depth .",
    "the result is a directed acyclic graph ( dag ) containing all possible charged fragments that may be generated from that molecule .",
    "an abstract example of such a fragmentation graph is provided in figure  [ fig : fragmentationgraph ] .",
    "note that for each break , one of the two produced fragments will have no charge .",
    "since it is not possible for a mass spectrometer to detect neutral molecules , we do not explicitly include the neutral fragments in the resulting graph , nor do we recur on their possible breaks .",
    "however neutral loss information may be included on the edges of the graph , indicating how a particular charged fragment was determined .",
    "@xcite          our parametrized transition model assigns a conditional probability to each fragment given the previous fragment in the sequence @xmath6,@xmath8,  ,@xmath3 . in the case where @xmath9 has @xmath10 as a possible child fragment in a fragmentation graph , our model assigns a positive probability to the transition from @xmath11 to @xmath12 .",
    "furthermore , self - transitions are always allowed , i.e. the probability of transitioning from @xmath11 to @xmath13 is always positive ( for the same @xmath9 ) .",
    "we assign 0 probability to all other transitions , i.e. those that are not self - transitions , and that do not exist within any fragmentation graph .",
    "although the set of possible charged fragments @xmath14 is large , the subset of child fragments originating from any particular fragment is relatively small .",
    "for example , the requirement that a feasible child fragment must contain a subset of the atoms in the parent fragment rules out many possibilities .",
    "consequently most transitions will be assigned a probability of 0 .",
    "note that the assigned probabilities of all transitions originating at a particular fragment , including the self - transition , must sum to one .",
    "we now discuss how we parametrize our transition model .",
    "a natural parametrization would be to use a transition matrix containing a separate parameter for every possible fragmentation @xmath15 .",
    "unfortunately , we lack sufficient data to learn parameters for every individual fragmentation in this manner . instead , we look for methods that can generalize by exploiting the tendency of similar molecules to break in similar ways .      we introduce the notion of _ break tendency _ , which we represent by a value @xmath16 for each possible fragmentation @xmath15 that models how likely a particular break is to occur .",
    "those fragmentations that are more likely to occur are assigned a higher break tendency value , and those that are less likely are given lower values .",
    "we then employ a softmax function to map the break tendencies for all breaks involving a particular parent fragment to probabilities , as defined in equation [ rhoequation ] below .",
    "this has the effect of capturing the competition that occurs between different possible breaks within the same molecule .",
    "for example , consider the two fragmentations in figure [ fig : twobreaks ] . here ,",
    "although both fragmentations involve an h@xmath17o neutral loss , in the left - hand case , the h@xmath17o loss must compete with the loss of an ammonia group , whereas in the right hand case , it does not .",
    "hence our model might assign an equal break tendency to both cases , but this would still result in a lower probability of fragmentation in the former case , due to the competing ammonia .    two similar breaks , both resulting in an h@xmath17o neutral loss . the right case should be assigned a higher probability , as in the left case , the nh@xmath18 is also likely to break away , reducing the probability of the h@xmath17o loss . ]",
    "we model the probability of a particular break @xmath19 occurring as a function of its break tendency value @xmath20 and that of all other competing breaks from the same parent , as follows : @xmath21 where the sums iterate over all @xmath22 for which @xmath23 is possible .",
    "since the break tendency is a relative measure , it makes sense to tie it to some reference point . for the purposes of this model ,",
    "we have assigned the break tendency for a self - transition ( i.e. no break occuring ) to @xmath24 , which gives @xmath25 as shown in ( [ rhoequation ] ) .",
    "[ [ incorporating - chemical - features ] ] incorporating chemical features + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + +    we need to compute @xmath20 for @xmath26 . to do this",
    "we first define a binary feature vector @xmath27 to describe the characteristics of a given break @xmath15 .",
    "such features might include the presence of a particular atom adjacent to the broken bond , or the formation of a specific neutral loss molecule e.g .",
    "see section  [ sec : chemicalfeatures ] .",
    "we then use these features to assign a break tendency value using a linear function parameterized by a vector of weights @xmath28 i.e .",
    "@xmath29 . this",
    "can then be substituted into ( [ rhoequation ] ) to generate the probability of transition @xmath19 .",
    "the first feature of @xmath27 is a bias term , set to 1 for all breaks .",
    "note that the vector @xmath30 constitutes the parameters of the cfm model that we will be learning .",
    "we model the conditional probability of @xmath4 using a narrow gaussian distribution centred around the mass ) and hence can just use the mass here .",
    "] of @xmath3 , i.e. @xmath31 .",
    "the value for @xmath32 can be set according to the mass accuracy of the mass spectrometer used .",
    "so , we define this observation function to be the following @xmath33 our investigation ( see supplementary data ) of the mass error of the precursor ions in the metlin metabolite data used in section  [ sec : results ] found that the distribution of mass errors had a mean offset of approximately 1  ppm , and a narrower shape than a gaussian distribution .",
    "however , in order to model a more general mass error , not specific to a particular instrument or set of empirical data , we think the gaussian distribution is a reasonable approach .",
    "our system estimates the values for the parameters @xmath30 of the proposed model by applying a training procedure to a set of molecules @xmath34 , for which we have both the chemical structure and a measured ms / ms spectrum .    for the purposes of this work ,",
    "we assume we have a measured low , medium and high energy cid ms / ms spectrum for each molecule , which we denote @xmath35 ( @xmath36 , @xmath37 , @xmath38)@xmath39 each spectrum is further defined to be a set of peaks , where each peak is a pair @xmath40 , composed of a mass @xmath41 and a height ( or intensity ) @xmath42 \\subset \\mathbb{r}$ ] .",
    "note that each spectrum is normalized , such that the peak heights sum to 100 .    for this single energy version of the model ,",
    "we derive parameters for a completely separate model for each of the three energy levels , using data from that level only .",
    "note that if we had data for only one energy level , we could use this method to train a model using just that energy .",
    "however section  [ combinedenergymodel ] will extend this model to combine the three energy spectra for use in a single model . until then , we will use @xmath43 to denote whichever of @xmath36 , @xmath37 or @xmath38 we are currently considering .",
    "[ [ maximum - likelihood ] ] maximum likelihood + + + + + + + + + + + + + + + + + +    we use a maximum likelihood approach for parameter estimation .",
    "the likelihood of the data @xmath44 , given the parameters @xmath30 , and incorporating the previously defined transition function @xmath45 and observation function @xmath46 , is given by @xmath47 where @xmath48 denotes the children of @xmath9 in all fragmentation graphs containing it , and @xmath49 .",
    "however we are unable to maximize this function in closed form .",
    "instead we use the iterative expectation maximization @xcite technique .",
    "[ [ expectation - maximization - em ] ] expectation maximization ( em ) + + + + + + + + + + + + + + + + + + + + + + + + + + + + +    in the e - step , the expected log likelihood expression is given by @xmath50 where @xmath51 denotes the values for @xmath30 on the @xmath52-th iteration .",
    "substituting ( [ rhoequation ] ) and ( [ obsequation ] ) into the above and re - arranging in terms of all possible fragment pairs gives @xmath53 where @xmath54 @xmath55 and @xmath56    in the m - step , we look for the @xmath51 that maximizes the above expression of @xmath57 . noting that @xmath58 is independent of @xmath51 and denoting the @xmath59th component of @xmath30 as @xmath60 , @xmath61\\phi_{i , j}^{l } - \\hspace{-8pt}\\sum\\limits_{k\\in c(f_{i})}\\hspace{-8pt}\\phi_{i , k}^{l}\\rho(f_{i},f_{k};w)\\big)\\ ] ] where @xmath62 denotes the @xmath59th component of the feature vector @xmath63 and @xmath64 $ ] is the indicator function .",
    "this does not permit a simple closed - form solution for @xmath30 .",
    "however @xmath65 is concave in @xmath51 , so settings for @xmath51 can be found using gradient ascent .",
    "values for the joint probabilities in the @xmath66 terms can be computed efficiently using the junction tree algorithm @xcite .",
    "we also add an @xmath67 regularizer on the values of @xmath30 to @xmath57 ( excluding the bias term ) .",
    "this has the effect of discouraging overfitting by encouraging the parameters to remain close to zero .",
    "ms / ms spectra are often collected at multiple collision energies for the same molecule .",
    "increasing the collision energy usually causes more fragmentation events to occur .",
    "this means that fragments appearing in the medium and high energy spectra are almost always descendants of those that appear in the low and medium energy spectra , respectively .",
    "so the existence of a peak in the medium energy spectrum may help to differentiate between explanations for a related peak in the low or high energy spectra .",
    "for this reason , we also assessed an additional model , combined energy cfm ( ce - cfm ) , which extends the se - cfm concept by combining information from multiple energies as shown in fig .",
    "[ model ]  ( b ) .",
    "plow , pmed and phigh each represent a peak from the low , medium and high energy spectrum respectively .",
    "the fragment states , transition rules and the observation model are all the same here as for se - cfm .",
    "the main difference now is that the homogeneity assumption is relaxed so that separate transition likelihoods can be learned for each energy block i.e .",
    ", @xmath6 to @xmath68 , @xmath68 to @xmath69 and @xmath69 to @xmath70 , where @xmath71 , @xmath72 and @xmath73 denote the fragmentation depths of the low , medium and high energy spectra respectively .",
    "this results in separate parameter values for each energy , denoted respectively as @xmath74 , @xmath75 and @xmath76 .",
    "the complete parameter set for this model thus becomes @xmath77 .",
    "we can again use a maximum likelihood approach to parameter estimation based on the em algorithm .",
    "this approach deviates from the se - cfm method only as follows :    * for each energy level , ( [ gradequation ] ) is computed separately , restricting the @xmath78 terms to relevant parts of the model e.g .",
    "@xmath79 would sum from @xmath80 to @xmath72 when computing the gradients for @xmath75 , and from @xmath81 to @xmath73 when computing gradients for @xmath76 . *",
    "the computation of the @xmath82 terms combines evidence from the full set of three spectra @xmath83 . in se - cfm",
    ", we apply one spectrum at a time , effectively sampling from a distribution over the peaks from each observed spectra . in this extended model",
    "we can not do this because we do not have a full joint distribution over the peaks , but rather we only have marginal distributions corresponding to each spectrum .",
    "the standard inference algorithms e.g .",
    "the junction tree algorithm , do not allow us to deal with observations that are marginal distributions rather than single values .",
    "instead we use the iterative proportional fitting procedure ( ipfp ) @xcite , with minor modifications to better handle cases where the spectra are inconsistent ( not simultaneously achievable under any joint distribution ) .",
    "these modifications reassign the target spectra to be the average of those encountered when the algorithm oscillates in such circumstances .",
    "in this section we present results using the above described se - cfm ( @xmath84=2 ) and ce - cfm ( @xmath71=2 , @xmath72=4 , @xmath73=6 ) methods , on a spectrum prediction task , and then in a metabolite identification task .",
    "we used the metlin database @xcite , separated into two sets ( see description below ) each containing positive mode , esi - ms / ms spectra from a 6510 q - tof ( agilent technologies ) mass spectrometer , measured at three different collision energies : 10v , 20v and 40v , which we assign to be low , medium and high energy respectively .",
    "each set was randomly divided into 10 groups for use within a 10-fold cross validation framework .    1 .",
    "* tripeptides * : the metlin database contains data for over 4000 enumerated tripeptides .",
    "we randomly selected 2000 of these molecules , then omitted 15 that had four or more rings due to computational resource concerns , leaving 1985 remaining in the set .",
    "fragmentation patterns in peptides are reasonably well understood @xcite , leading to effective algorithms for identifying peptides from their esi ms / ms data e.g .",
    "@xcite . however , we think that the size of this dataset , and the fact that it contains so many similar yet different molecules , make it an interesting test case for our algorithms .",
    "* metlin metabolites * : we use a set of 1491 non - peptide metabolites from the metlin database .",
    "these are a more diverse set covering a much wider range of molecules .",
    "an initial set of 1500 were selected randomly .",
    "nine were then excluded because they were so much larger than the other molecules ( over 1000 da ) , such that their fragmentation graphs could not be computed in a reasonable amount of time .",
    "we also used an additional small validation set , selected because they were measured on a similar mass spectrometer , an agilent 6520 q - tof , but in a different laboratory .",
    "these were taken from the massbank database @xcite .",
    "all testing with this set used a model trained for the first cross - fold set of the metlin metabolite data ( @xmath85 of the data ) .    1 .",
    "* massbank metabolites * : this set contains 192 metabolites taken from the washington state university submission to the massbank database .",
    "all molecules from this submission were included that had ms2 spectra with collision energies 10v , 20v and 40v , in order to provide a good match with the metlin data .",
    "files containing test molecule lists and assigned cross validation groups are provided as supplementary data .",
    "the chemical features used in these experiments were as follows .",
    "note that the terms _ ion root atom _ and _ neutral loss ( nl ) root atom _ refer to the atoms connected to the broken bond(s ) on the ion and neutral loss sides respectively cf . , fig .",
    "[ fig : breaklabel ] .        * _ break atom pair _ : indicators for the pair of ion and neutral loss root atoms , each from \\{c , n , o , p , s , other } , included separately for those in a non - ring break vs those in a ring break e.g .",
    "[ fig : breaklabel]a ) : would be non - ring c - c .",
    "( 72 features ) * _ ion and nl root paths _ indicators for all paths of length 2 and 3 starting at the respective root atoms and stepping away from the break .",
    "each is an ordered double or triple from \\{c , n , o , p , s , other } , taken separately for rings and non - rings .",
    "two more features indicate no paths of length 2 and 3 respectively e.g .",
    "[ fig : breaklabel]a ) : the ion root paths are c - o , c - n and c - n - c .",
    "( 2020 features ) . * _ gasteiger charges _ : indicators for the quantised pair of gasteiger charges @xcite for the ion and nl root atoms in the original unbroken molecule .",
    "( 288 features ) * _ hydrogen movement _ : indicator for how many hydrogens switched sides of the break and in which direction i.e .",
    "ion to nl ( - ) or nl to ion(+ ) \\{0,@xmath86,@xmath87,@xmath88,@xmath89,other}. ( 10 features ) * _ ring features _ : properties of a broken ring .",
    "aromatic or not ?",
    "multiple ring system ?",
    "size \\{3,4,5,6 , other } ?",
    "distance between the broken bonds \\{1,2,3,4 + } ?",
    "[ fig : breaklabel]b ) is a break of a single aromatic ring of size 6 at distance 3 .",
    "( 12 features ) .    of these 2402 features ,",
    "few take non - zero values for any given break .",
    "many are never encountered in our data set , in which case their corresponding parameters are set immediately to 0 .",
    "we also append _",
    "quadratic features _",
    ", containing all 2,881,200 pair - wise combinations of the above features , excluding the additional bias term .",
    "again , most are never encountered , so their parameters are set to 0 .      for each cross validation fold , and the massbank validation set , a model ( trained as above ) , was used to predict a low , medium and high energy spectra for each molecule in the test set .",
    "the resulting marginal distributions for the peak variables are a mixture of gaussian distributions .",
    "we take the means and weights of these gaussians as our peak mass and intensity values .",
    "since all fragments in the fragmentation graph of a molecule have non - zero probabilities in the marginal distribution , it is necessary to place a cut - off on the intensity values to select only the most likely peaks . here",
    ", we use a post - processing step that removes peaks with low probability , keeping as many of the highest peaks as required to form at least 80% of the total intensity sum .",
    "we also set limits on the number of selected peaks to be at least 5 and at most 30 .",
    "this ensures that more peaks are included than just the precursor ion , and also prevents spectra occurring that have large numbers of very small peaks .",
    "these values were selected arbitrarily , but post - analysis suggests that they are reasonable ( see supplementary data ) .",
    "when matching peaks we use a mass tolerance set to the larger of 10  ppm and 0.01  da ( depending on the peak mass ) , and set the observation parameter @xmath32 to be one third of this value .",
    "[ [ metrics ] ] metrics + + + + + + +    we consider a peak in the predicted ms / ms spectrum @xmath90 to match a peak in the measured ms / ms spectrum @xmath91 if their masses are within the mass tolerance above .",
    "we use the following metrics :    1 .",
    "* weighted recall * : the percentage of the total peak intensity in the measured spectrum with a matching peak in the predicted spectrum : @xmath92 \\hspace{2pt}\\div \\hspace{-10pt}\\sum\\limits_{(m , h)\\in s_{m}}\\hspace{-12pt}h$ ] .",
    "2 .   * weighted precision * : the percentage of the total peak intensity in the predicted spectrum with a matching peak in the measured spectrum : @xmath93 \\hspace{2pt}\\div \\hspace{-10pt}\\sum\\limits_{(m , h)\\in s_{p}}\\hspace{-12pt}h$ ] .",
    "* recall * : the percentage of peaks in the measured spectrum that have a matching peak in the predicted spectrum : @xmath94 .",
    "* precision * : the percentage of peaks in the predicted spectrum that have a matching peak in the measured spectrum : @xmath95 .",
    "* jaccard score * : @xmath96 .",
    "the intensity weighted metrics were included because the unweighted precision and recall values can be misleading in the presence of low - level noise e.g . when there are many small peaks in the measured spectrum .",
    "the weighted metrics place a greater importance on matching higher intensity peaks , and therefore give a better indication of how much of a spectrum has been matched .",
    "however , these weighted metrics can also be susceptible to an over - emphasis of just one or two peaks , and in particular of the peak corresponding to the precursor ion .",
    "consequently , we think it is informative to consider both weighted and non - weighted metrics for recall and precision .",
    "[ [ models - for - comparison ] ] models for comparison + + + + + + + + + + + + + + + + + + + + +    : the pre - existing methods , e.g .",
    "metfrag , fingerid  do not output a predicted spectrum , but skip directly to metabolite identification .",
    "so , instead we compare against :    * * full enumeration * : this model considers the predicted spectrum to be one that enumerates all possible fragments in the molecule s fragmentation tree with uniform intensity values . * * heuristic * ( tripeptides only ) : this model enumerates known peptide fragmentations as described by @xcite , including @xmath97 , @xmath98 , @xmath99 , @xmath100 , @xmath101 , @xmath102 and immonium ions .    [ [ results ] ] results + + + + + + +    :    the results are presented in figure  [ fig : metricspeptides ] .        for all three data sets , se - cfm and ce - cfm obtain several orders of magnitude better precision and jaccard scores than the full enumerations of possible peaks .",
    "there is a corresponding loss of recall .",
    "however , if we take into account the intensity of the measured peaks , by considering the weighted recall scores , we see that our methods perform well on the more important , higher intensity peaks .",
    "more than 75% of the total peak intensity in the tripeptide spectra , and approximately 60% of the total peak intensity in the metabolite spectra , were predicted .",
    "the results presented in figure  [ fig : metricspeptides ] show scores averaged across the three energy levels for each molecule . if we consider the results for the energy levels separately ( see supplementary data ) , we find that the low and medium energy results are much better for all methods we assessed . for example , in the case of the low energy spectra , the weighted recall scores for se - cfm are 78% , 73% and 81% for the tripeptide , metlin metabolite and massbank metabolite data sets respectively , as compared to 73% , 29% and 37% respectively for the high energy spectra .",
    "the poorer high energy spectra results may be due to increased noise and a lower predictability of events at the higher collision energies .",
    "another possible explanation is that the even - electron rule and other assumptions listed in section  [ statespace ] may be less reliable when there is more energy in the system .    in the case of the tripeptide data ,",
    "our methods achieve higher recall scores and similar rates of precision to that of the heuristic model of known fragmentation mechanisms , resulting in improved jaccard scores .",
    "since peptide fragmentation mechanisms are fairly well understood , this result is not intended to suggest that our method should be used in place of current peptide fragmentation programs , but rather to demonstrate that se - cfm and ce - cfm are able to extract fragmentation patterns from data to a similar extent to human experts , given a sufficiently large and consistent data set . like our methods ,",
    "the heuristic models also perform better for the lower energy levels , with a weighted recall score of 66% for the low energy , as compared to only 24% for the high energy",
    ".    unsurprisingly , being a smaller and more diverse data set , the metlin metabolite results are poorer than those of the tripeptides .",
    "however the weighted recall for both our methods is still above 60% and the precision and jaccard scores are much higher than for the full enumeration , suggesting that the cfm model is still able to capture some of the common fragmentation trends .",
    "the weighted recall and precision results for the massbank metabolites are fairly comparable to those of the metlin metabolites .",
    "there is a small loss in the non - weighted recall , however this is probably due to a higher incidence of low - level noise in the massbank data .",
    "this results in a small loss in the average jaccard score .",
    "however these results demonstrate that the fragmentation trends learned still apply to a significant degree on data collected at a different time in a different laboratory .",
    "since this is the first method , to the authors knowledge , capable of predicting intensity values as well as m / z values , we also investigated the accuracy of cfm s predicted intensity values .",
    "we found that the pearson correlation coefficients for matched pairs of predicted and measured peaks , were 0.7 , 0.6 and 0.45 for the low , medium and high spectra respectively ( se - cfm and ce - cfm results were not significantly different ) .",
    "this indicates a positive , though imperfect correlation .",
    "full results and scatter plots are contained in the supplementary data .      here",
    "we apply our cfm ms / ms spectrum predictions to a metabolite identification task .",
    "for each molecule , we produce two candidate sets via queries to two public databases of chemical entities :    1 .",
    "we query the pubchem compound database @xcite for all molecules within 5  ppm of the known molecule mass .",
    "this simulates the case where little is known about the candidate compound , but the parent ion mass is known with high accuracy .",
    "2 .   we query kegg ( kyoto encyclopedia of genes and genomes ) @xcite for all the molecules within 0.5  da of the known molecular mass .",
    "this simulates the case where the molecule is thought to be a naturally occurring metabolite , but there is more uncertainty in the target mass range .    to conduct this assessment , duplicate candidates were filtered out i.e .",
    "those with the same chemical structure , including those that only differ in their stereochemistry .",
    "charged molecules and ionic compounds were also removed since the program assumes single fragment , neutral candidates ( to which it will add a proton ) . after filtering , the median number of candidates returned from pubchem was 911 for the tripeptides and 1025 for the metabolites .",
    "note that 9 tripeptides and 57 of the metlin metabolites were excluded from this testing because no matching entry was found in pubchem for these molecules .",
    "the kegg queries were only carried out for the metabolite data .",
    "the median number of candidates returned was 22 , however no matching entry was found in kegg for 833 of the metlin metabolites and 111 of the massbank metabolites .",
    "whenever a matching entry could be found , we ranked the candidates according to how well their predicted low , medium and high spectra matched the measured spectra of the test molecule .",
    "the ranking score we used was the jaccard score described in section  [ sec : spectrumprediction ] .",
    "we compared the ranking performance of our se - cfm and ce - cfm methods against those of metfrag  @xcite and fingerid  @xcite .",
    "we used the same candidate lists for all programs .",
    "for candidate molecules with equal scores , we had each program break ties in a uniformly random manner .",
    "this was in contrast to the original metfrag code , which used the most pessimistic ranking ; we did not use that approach as it seemed unnecessarily pessimistic .",
    "we set the mass tolerances used by metfrag when matching peaks to the same as those used in our method ( maximum of 0.01da and 10ppm ) .",
    "metfrag and fingerid only accept one spectrum , so to input the three spectra we first merged them as described by  @xcite : we took the union of all peaks , and then merge together any peaks within 10  ppm or 0.01  da of one another , retaining the average mass and the maximum intensity of the two .",
    "in fingerid we used the linear high resolution mass kernel including both peaks and neutral losses , and trained using the same cross - fold sets as for our own method .",
    "overall , we attempted to assess cfm , metfrag and fingerid as fairly as possible , using identical constraints , identical databases and near - identical data input .",
    "the results are shown in figure  [ fig : rankingresults ] .",
    "as seen in this figure , our cfm method achieved substantially better rankings than both the existing methods on all three data sets , for both the pubchem and kegg queries .",
    "when querying against kegg , our methods found the correct metabolite as the top - scoring candidate in over 70% of cases for both metabolite sets and almost always @xmath103 ranked the correct candidate in the top 5 . in comparison",
    ", metfrag ranked the correct metabolite first in approximately 50% of cases for both metabolite sets , and in the top 5 in 89% .",
    "fingerid ranked the correct metabolite first in less than 15% of cases .",
    "for pubchem , our methods performed well on the tripeptide data , identifying the correct metabolite as the top - scoring candidate in more than 50% of cases and ranking the correct candidate in the top 10 for more than 98% of cases .",
    "this is again convincingly better than both metfrag and fingerid , which rank the correct candidate first in less than 35% and 2% of cases respectively .    for the metabolite data , ce - cfm and se - cfm were able to identify the correct metabolite in only 12% and 10% of cases respectively , however given that this is from a list of approximately one thousand candidates , this performance is still not bad .",
    "once again , it is substantially better than metfrag and fingerid , which correctly identified less than 6% and 1% of cases respectively .",
    "our methods rank the correct candidate in the top 10 in more than 40% of cases on both data sets , as compared to metfrag s performance of 31% on the metlin metabolites and 21% on the massbank metabolites .",
    "additionally , the top - ranked compound was found to have the correct molecular formula in more than 88% of cases for se - cfm and 90% of cases for ce - cfm , suggesting that both methods mainly fail to distinguish between isomers . while the performance of all three methods ( cfm , metfrag and fingerid ) is not particularly impressive for the pubchem data sets ( i.e. @xmath10412% correct ) we would argue that the pubchem database is generally a poor database choice for anyone wishing to do ms / ms metabolomic studies . with only 1% of its molecules having a biological or natural product origin , one is already dealing with a rather significant challenge of how to eliminate a 100:1 excess of false positives .",
    "so we would regard the results from the pubchem assessment as a `` worst - case '' scenario and the results from the kegg assessment as a more typical metabolomics scenario .    the results for ce - cfm showed minimal difference when compared to those of se - cfm , casting doubt on whether the additional complexity of ce - cfm is justified .",
    "however we think this idea is still interesting as a means for integrating information across energy levels and may yet prove more useful in future work .",
    "( see section  [ sec : spectrumprediction ] ) , http://cfmid.wishartlab.com we encourage readers to make use of our executables and source code , made available at http://sourceforge.net / projects / cfm - id/.",
    "we have proposed a model for the esi - ms / ms fragmentation process and a method for training this model from data .",
    "the performance has been benchmarked in cross validation testing on a large molecule set , and further validated using an additional dataset from another laboratory .",
    "head - to - head comparisons using multiple data sets under multiple conditions show that the cfm method significantly outperforms existing state - of - the - art methods , and has attained a level that could be useful to experimentalists performing metabolomics studies .",
    "bolton e , wang y , thiessen p , bryant s ( 2008 ) pubchem : integrated platform of small molecules and biological activities . in : chapeter 12 in annual reports in computational chemistry ,",
    "vol  4 , american chemical society , washington dc                galezowska a , harrison mw , herniman jm , skylaris ck , langley gj ( 2013 ) a predictive science approach to aid understanding of electrospray ionisation tandem mass spectrometric fragmentation pathways of small molecules using density functional calculations .",
    "rapid communications in mass spectrometry : rcm 27(9):964970              hill",
    "aw , mortishire - smith rj ( 2005 ) automated assignment of high - resolution collisionally activated dissociation mass spectra using a systematic bond disconnection approach .",
    "rapid communications in mass spectrometry 19(21):31113118            kangas lj , metz to , isaac g , schrom bt , ginovska - pangovska b , wang l , tan l , lewis rr , miller jh ( 2012 ) in silico identification software ( isis ) : a machine learning approach to tandem mass spectral identification of lipids .",
    "bioinformatics 28(13):170513            levsen k , schiebel",
    "hm , terlouw jk , _",
    "et  al_(2007 ) even - electron ions : a systematic study of the neutral species lost in the dissociation of quasi - molecular ions .",
    "journal of mass spectrometry : jms 42:10241044            oberacher h , pavlic m , libiseller k , _",
    "et  al _ ( 2009 ) on the inter - instrument and the inter - laboratory transferability of a tandem mass spectral reference library : 2 .",
    "optimization and characterization of the search algorithm .",
    "journal of mass spectrometry : jms 44(4):494502"
  ],
  "abstract_text": [
    "<S> electrospray tandem mass spectrometry ( esi - ms / ms ) is commonly used in high throughput metabolomics . </S>",
    "<S> one of the key obstacles to the effective use of this technology is the difficulty in interpreting measured spectra to accurately and efficiently identify metabolites . </S>",
    "<S> traditional methods for automated metabolite identification compare the target ms or ms / ms spectrum to the spectra in a reference database , ranking candidates based on the closeness of the match . </S>",
    "<S> however the limited coverage of available databases has led to an interest in computational methods for predicting reference ms / ms spectra from chemical structures .    </S>",
    "<S> this work proposes a probabilistic generative model for the ms / ms fragmentation process , which we call competitive fragmentation modeling ( cfm ) , and a machine learning approach for learning parameters for this model from ms / ms data . </S>",
    "<S> we show that cfm can be used in both a ms / ms spectrum prediction task ( ie , predicting the mass spectrum from a chemical structure ) , and in a putative metabolite identification task ( ranking possible structures for a target ms / ms spectrum ) .    in the ms / ms spectrum prediction task , cfm shows significantly improved performance when compared to a full enumeration of all peaks corresponding to substructures of the molecule . in the metabolite identification task , cfm obtains substantially better rankings for the correct candidate than existing methods ( metfrag and fingerid ) on tripeptide and metabolite data , when querying pubchem or kegg for candidate structures of similar mass .    </S>",
    "<S> example.eps gsave newpath 20 20 moveto 20 220 lineto 220 220 lineto 220 20 lineto closepath 2 setlinewidth gsave .4 setgray fill grestore stroke grestore </S>"
  ]
}