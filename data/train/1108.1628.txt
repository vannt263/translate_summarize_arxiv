{
  "article_text": [
    "as the amount of available sequence data from genomes or proteoms rapidly grows , one is confronted with the problem that , for a given set of taxa , tree topologies relating homologous sequences of these taxa can ( and in practice often will ) differ from the each other , depending on which locus in the genome or which protein is used for constructing the tree .",
    "possible reasons for discordance among gene trees and the species phylogeny include horizontal gene transfer , gene duplication / loss , or incomplete lineage sorting ( deep coalescences ) .",
    "thus one is confronted with the task to determine the phylogeny of the taxa ( the ` species tree ' ) from a set of possibly discordant gene trees ( maddison @xcite , and maddison and knowles @xcite ) .",
    "several methods have been proposed and are used to infer a species tree from a set of possibly discordant gene trees :    \\(1 ) declaring the most frequently observed gene tree to be the true species tree was shown to be statistically inconsistent under the multispecies coalescent model by degnan and rosenberg @xcite , in cases where branch lengths of the underlying species tree are sufficiently small .",
    "\\(2 ) a popular approach for species tree reconstruction is by concatenating multiple alignments from several loci to one large multiple alignment and construct a single ` gene tree ' from this multiple alignment by standard methods .",
    "this approach was pursued e.g.  by teichmann and mitchison @xcite and cicarelli et al.@xcite . however , also this method was shown to be inconsistent under the multispecies coalescent by degnan and kubatko @xcite , if branch lengths on the species tree are sufficiently short .",
    "\\(3 ) similarly , the concept of minimizing the number of ` deep coalescences ' ( maddison @xcite ) was recently shown to be statistically inconsistent under the multispecies coalescent model by than and rosenberg @xcite .",
    "\\(4 ) on the other hand , it is well known from coalescent theory that the probability distribution of gene trees , or even the distributions rooted gene triplet trees , on a species tree uniquely determine the species tree if incomplete lineage sorting is assumed to be the only source of gene tree discordance .",
    "similarly ( see allman et al .",
    "@xcite ) , _ the distributions of unrooted quartet gene trees identify the unrooted species tree topology .",
    "_ however , as soon as triplet / quartet gene trees are inferred from experimental data , their distributions will differ from the theoretical ones , and this may lead to conflicts among the inferred triplets / quartets on the hypothetical species tree , a problem which is not straight forward to resolve ( ` quartet - puzzeling ' could be an approach to resolve this , see strimmer and von haeseler @xcite ) . also direct maximum likelihood calculations using gene tree distributions",
    "are very problematic due to the enormous number of possible gene trees on a given set of taxa .",
    "\\(5 ) recently liu and yu @xcite have proposed to use the ` average internode distance ' on gene trees as a measure of distance between taxa on species trees and apply classical neighbor joining to these distance data .",
    "they prove that this reconstructs the underlying species tree in a statistically consistent way .    in the present paper",
    "we propose a method to overcome many of the difficulties discussed above , and in particular to make the above mentioned result by allman et al.@xcite accessible in practice .",
    "that is , we describe a polynomial time algorithm ( in the number of taxa ) , which uses empirical distributions of unrooted quartet gene trees as an input , to estimate the unrooted topology of the underlying species tree in a statistically consistent way . due to the conceptual similarity to classical neighbor joining we call this algorithm ` quartet neighbor joining ' , or briefly ` quartet - nj ' .",
    "the fact that quartet - nj uses quartet distributions as an input makes it flexible in practice : quartet gene tree distributions can be obtained directly from sequence data ( as is described in the application to a prokaryote data set in section [ sect : appsim ] of this paper ) , or e.g.  from gene tree distributions , which is the type of input required by liu and yu s ` neighbor joining for species trees ' @xcite . also , quartet - nj is naturally capable of dealing with multiple lineages per locus and taxon .",
    "the paper is organized as follows : after a brief review of the multispecies coalescent model and distributions of quartet gene trees in section [ sect : mscm ] , we investigate in section [ sect : cherrypicking ] how to identify cherries on a species tree . to this end",
    "we show how to assign ` weights ' to unrooted quartet trees on the set of taxa , using the distributions of quartet gene trees , and how to define a ` depth ' for each pair of taxa . in analogy to classical cherry picking we",
    "prove that under the multispecies coalescent model any pair of taxa with maximal depth is a cherry on the species tree .",
    "moreover , we give an interpretation of this theorem by the concept of ` minimal probability for incomplete lineage sorting ' , in analogy to the concept of minimal evolution underlying classical neighbor joining .    in section [",
    "sect : algorithms ] we translate our cherry picking theorem into a neighbor joining - like procedure ( ` quartet - nj ' ) and prove that it reproduces the true unrooted species tree topology as the input quartet distributions tend to the theoretical quartet distributions .",
    "in other words , quartet - nj is statistically consistent .",
    "finally , in section [ sect : appsim ] we apply the quartet - nj algorithm to data from coalescence simulations , as well as to a set of multiple alignments from nine prokaryotes , in order to demonstrate the suitability of quartet - nj . in both situations",
    "we consider only one lineage per locus and taxon .",
    "we are going to present briefly the multispecies coalescent , which models gene ( or protein ) tree evolution within a fixed species tree .",
    "the material in this section is neither new nor very deep .",
    "rather this section is to be considered as a reminder for the reader on the relevant definitions , as well a suitable place to fix language and notation for the rest of the paper . for a more detailed introduction to the multispecies coalescent model",
    "we refer e.g.  to allman et al.@xcite .",
    "let us consider a set @xmath0 of @xmath1 taxa ( e.g.  species ) and a rooted phylogenetic ( that is : metric with strictly positive edge lengths and each internal node is trivalent ) tree @xmath2 on the taxon set @xmath0 .",
    "the tree @xmath2 is assumed to depict the ` true ' evolutionary relationship among the taxa in @xmath0 , and the lengths of its internal edges are measured in coalescence units ( see below ) .",
    "this tree is commonly called the _ species tree _ on the taxon set @xmath0 .",
    "it is a fundamental problem in phylogenetics to determine the topology of this tree .",
    "molecular methodes , however , usually produce evolutionary trees for single loci within the genome of the relevant species , and these _ gene trees _ will usually differ topologically from the species tree ( degnan and rosenberg @xcite ) .",
    "this has several biological reasons , like horizontal gene transfer , gene duplication / loss or incomplete lineage sorting .",
    "the latter describes the phenomenon that to gene lineages diverge long before the population actually splits into two separate species , and in particular gene lineages may separate in a different order than the species do .",
    "the multispecies coalescent model describes the probability for each rooted tree topology to occur as the topology of a gene tree , under the assumption that incomplete lineage sorting is the only reason for gene tree discordance .",
    "notation : we adopt the common practice to denote taxa ( species ) by lower case letters , while we denote genes ( or more general : loci ) in their genome by capital letters . e.g.  if we consider three taxa @xmath3 , the letters @xmath4 will denote a particular locus sampled from the respeceive taxa .",
    "( by abuse of notation , we will identify the leaf sets of both species _ and _ gene trees with @xmath0 ) .    considering only a single internal branch of the species tree , and two gene lineages within this branch going backwards in time , we find that the probability that the two lineages coalesce to a single lineage within time @xmath5 is given by @xmath6 where @xmath5 is in _ coalescence units _",
    "( that is number of generations represented by the internal branch divided by the total number of allele of the locus of interest , present in the population ) . in particular ,",
    "if the branch on the species tree has length @xmath7 , the probability that two lineages coalesce within this branch is @xmath8 .    from this ,",
    "nei @xcite derives the following probabilities under the multispecies coalescent model for a three taxon tree .",
    "denote the taxa by @xmath9 , the corresponding loci by @xmath4 , and assume that the species tree has the topology @xmath10 with internal edge length @xmath11 . then the probability that a gene tree sampled from these taxa has the topology @xmath12 is equal to @xmath13 while the other two topologies are observed with probability @xmath14 .    in @xcite degnan and salter",
    "show how to calculate the probabilities of a gene tree in a fixed species tree on an arbitrary taxon set .",
    "it turns out that these probabilities are polynomials in the unknonws @xmath15 , where @xmath16 denotes the length of the edge @xmath17 on the species tree .",
    "in particular , the multispecies coalescent model is an algebraic statistical model .      in the following we consider four taxon species trees on the taxon set @xmath18 , and we use newick notation to specify ( rooted ) species trees .",
    "for instance @xmath19 denotes the caterpillar tree with edge lengths @xmath20 and @xmath21 in coalescent units .",
    "moreover , unrooted quartets are denoted in the format @xmath22 , meaning the quartet gene tree which has cherries @xmath23 and @xmath24 .",
    "up to permutation of leaf labels there is only one additional tree topology on four taxa , namely the balanced tree @xmath25 . for both of these two species tree topologies",
    "it is not hard to calculate the probabilities of the tree possible unrooted quartet gene trees on @xmath0 , and one obtains    for both species tree topologies @xmath26 and @xmath27 the probabilities of unrooted quartet gene trees on @xmath0 have the same form and are given by the formulas @xmath28 [ lemquartetprob ]    in particular , the gene quartet distribution determines the _ unrooted _ species tree topology , but not the position of the root ( allman et al . ) .",
    "the sum of the internal edge lengths of the rooted species tree ( resp .",
    "the length of the internal edge of the unrooted species tree ) is given by the formula    @xmath29    returning to the study of the multispecies coalescent on species trees on arbitrary taxon sets , we deduce from the above that the quartets displayed on the species tree @xmath2 on the taxon set @xmath0 are exactly those which appear with a probability bigger than @xmath30 for any sampled locus .",
    "hence , the distributions of quartets determine uniquely the quartet subtrees which are displayed by the true species tree @xmath2 , and hence determine the unrooted topology of @xmath2 ( see allman et al.@xcite ) .    in the following two sections",
    "we describe a neighbor joining algorithm which makes this theoretical insight applicable in practice , meaning that it yields a method to estimate unrooted species trees from ( empirical ) distributions of quartet gene trees , which is statistically consistent under the multispecies coalescent model .",
    "statistical consistency of this algorithm will follow from the ` cherry picking theorem ' below .",
    "here we give a precise criterion , using theoretical distributions of quartet gene trees under the multispecies coalescent , to determine which pairs of taxa on the species tree are cherries .",
    "this criterion can as well be applied to estimated quartet distributions and thus enables us to recursively construct a species tree estimate from observed gene quartet frequencies in section [ sect : algorithms ] .      as always , we consider a fixed species tree @xmath2 on the taxon set @xmath0 , and we denote by @xmath31 the probability that a gene tree on @xmath0 displays the gene quartet tree @xmath32 .",
    "recall that by lower case letters @xmath33 we denote the species from which the genes @xmath34 are sampled . regardless of whether @xmath2 contains the ( species- ) quartet @xmath35",
    ", we can attach to it the following numbers :    [ defn : weight ] the _ weight _ of the quartet @xmath35 is defined as @xmath36 if the taxa @xmath37 are not pairwise distinct , then we set @xmath38 .    of course , if @xmath37 are pairwise distinct we may equivalently write @xmath39    if the quartet @xmath35 is displayed on the species tree @xmath2 , then the weight @xmath40 is precisely the length of the interior branch of the quartet @xmath35 .",
    "moreover , the other two weights , @xmath41 and @xmath42 , are less than zero . [ lem : weightdistance ]    the proof is immediate using equation : if the quartet tree @xmath35 is displayed on the species tree @xmath2 , then @xmath43 otherwise , if @xmath35 is not displayed on @xmath2 , then one of the other two quartet trees on @xmath44 is displayed , say @xmath45 , and we have @xmath46 since @xmath47 .    this little",
    "lemma motivates the following definition and a cherry picking theorem which is formulated and proved in close analogy to the ` classical ' one ( see saito and nei @xcite for the original publication , or pachter and sturmfels @xcite for a presentation analogous to ours ) .",
    "[ defn : depth ] for any pair of taxa @xmath48 we define the _ depth _ of @xmath49 to be the number @xmath50 ( recall that if @xmath51 then @xmath52 . )    [ thm : cherrypicking ] if a pair of taxa @xmath48 has maximal depth @xmath53 , then @xmath54 is a cherry on the species tree @xmath2 .",
    "as mentioned above , the proof of this theorem is parallel to the proof of the classical cherry picking result as presented in @xcite .",
    "we state it here for sake of completeness of our exposition .    as a first step ,",
    "we introduce the auxiliary values @xmath55 for every four taxon subset @xmath56 , as well as @xmath57 for every pair of taxa . obviously , if @xmath54 is a cherry on @xmath2 , then @xmath58 for all @xmath59 , and hence also @xmath60 . in general , for any pair of taxa @xmath49",
    "one has @xmath61 by lemma [ lem : weightdistance ] .",
    "we will now assume that the pair @xmath49 does _ not _ form a cherry on the species tree @xmath2 and prove that in this case there exists a cherry @xmath62 on @xmath2 such that the following inequalities hold : @xmath63 from this we deduce the claim of the theorem : if @xmath54 is not a cherry on @xmath2 , then it does not have maximal depth .",
    "we have to find a cherry @xmath62 on @xmath2 such that indeed @xmath64 holds . as we assume @xmath65 and @xmath66 not to form a cherry on @xmath2 , the unique path connecting @xmath65 and @xmath66 crosses at least two interior nodes ( symbolized as black dots in figure [ tree1 ] .",
    "we denote the number of internal nodes on this path by @xmath67 . to each @xmath68 a rooted binary tree @xmath69 is attached ( see figure [ tree1 ] ) .",
    "@xmath70 i & [ fillstyle = solid , fillcolor = black ] & [ linestyle = none]\\cdots & [ fillstyle = solid , fillcolor = black ] & j \\\\ & [ mnode = tri]t_{1 } & & [ mnode = tri]t_{r }   \\ncline{1,1}{1,2 } \\ncline{1,2}{1,3 } \\ncline{1,3}{1,4 } \\ncline{1,4}{1,5 } \\ncline{1,2}{2,2 } \\ncline{1,4}{2,4 } \\endpsmatrix $ ]    [ tree1 ]    by interchanging @xmath65 and @xmath66 , if necessary , we may assume that the number of taxa in @xmath71 is less or equal than the number of taxa in @xmath72 .",
    "first we consider the case that the subtree @xmath71 consists of a single leaf @xmath73 . in this case",
    "the pair @xmath74 is a cherry on @xmath2 , and it is easy to see that indeed @xmath75 .",
    "second , if @xmath71 has more than one leaf , let choose a cherry @xmath62 in @xmath71 ( every rooted binary tree with more than one leaf has at least one cherry ! ) .",
    "now we decompose the difference @xmath76 into six sums which will be treated separately : @xmath77 where @xmath78 inspection of the tree in figure [ tree1 ] immediately shows that each summand in @xmath79 is positive , and more precisely , greater or equal to @xmath80 .",
    "hence @xmath81 . in @xmath82 ,",
    "the expressions @xmath83 all vanish , hence this sum is positive .",
    "@xmath70 i & & & & & & p \\\\ & [ fillstyle = solid , fillcolor = black ] & [ linestyle = none]\\cdots & [ fillstyle = solid , fillcolor = black ] & [ linestyle = none]\\cdots & [ fillstyle = solid , fillcolor = black ] \\\\ j & & k & & l & & q   \\ncline{1,1}{2,2 } \\ncline{3,1}{2,2 } \\ncline{2,2}{2,3 } \\ncline{2,3}{2,4 } \\ncline{2,4}{2,5 } \\ncline{2,5}{2,6 } \\ncline{2,6}{1,7 } \\ncline{2,6}{3,7 } \\ncline{3,3}{2,4 } \\ncline{3,5}{2,4 } \\endpsmatrix $ ]    [ tree2 ]    the third sum @xmath84 might be negative - but not too negative : the situation is illustrated by figure [ tree2 ] ( which arises from the tree in figure [ tree1 ] by deleting the irrelevant subtrees @xmath85 ) , whose inspection shows that each for each summand @xmath86 we have @xmath87 thus we see @xmath88 , whence @xmath89 is positive .",
    "now we treat the frouth sum : if @xmath90 is a node in one of the subtrees @xmath85 , then @xmath91 , so @xmath92 is non - negative .",
    "more precisely we have @xmath93 . on the other hand ,",
    "the sum @xmath94 is greater or equal @xmath95 , whence also @xmath96 is positive . in total",
    "we have found that in any case @xmath97 , which proves our claim .",
    "as explained above , this suffices to prove the cherry picking theorem .      in practical applications one will not know the precise probability of each quartet gene tree @xmath22 .",
    "hence one has to use e.g.  relative frequencies as estimates .",
    "let us denote by @xmath98 the ( experimentally determined ) relative frequency of the gene quartet @xmath22 . in analogy",
    "to definitions [ defn : weight ] and [ defn : depth ] we make the following    the _ empirical weight _ of the quartet @xmath35 of taxa is defined as @xmath99 moreover , the _ empirical depth _ of a pair @xmath49 of taxa is defined as @xmath100    under the multispecies coalescent model , the relative frequency @xmath101 of a quartet gene tree @xmath32 is a statistically consistent estimator for its probability @xmath102 .",
    "hence the _ empirical _ depth @xmath103 of a pair of taxa @xmath104 is a statistically consistent estimator for @xmath53 . in particular",
    "this means : _ inferring a pair @xmath49 of taxa , where @xmath105 is maximal , as a cherry on the species tree is statistically consistent .",
    "_ more precisely , we have    [ cor : consistent ] let @xmath106 be the number of loci sampled from each taxon in @xmath0 and denote by @xmath107 the set of pairs of taxa at which @xmath105 attains its maximum .",
    "if the number of genes @xmath106 tends to infinity , then the probability that @xmath107 contains a pair which is not a cherry on the true species tree approaches zero .    as there are only finitely many taxa in @xmath0 , there is a strictly positive difference between the maximum value of @xmath108 on @xmath109 and its second biggest value .",
    "since moreover @xmath108 and @xmath105 are continuous , there exists an @xmath110 such that whenever @xmath111 , @xmath112 is maximal if and only if @xmath113 is maximal , and the claim follows from theorem [ thm : cherrypicking ] .",
    "but the probability that @xmath114 approaches 1 as @xmath106 grows , for any choice of @xmath115 .      recall that classical neighbor joining is a greedy algorithm which in each ` cherry picking ' step declares a pair of taxa to be neighbors if this minimizes the sum of branch lengths in the refined tree resulting from this step ( saito and nei @xcite ) . in other words , classical cherry picking and neighbor joining is guided by the principle of _ minimal evolution_. it turns out that our cherry picking result in theorem [ thm : cherrypicking ] can be interpreted in a similar fashion .",
    "let us make the following ad - hoc definition .",
    "let @xmath116 be independent random variables with values in @xmath117 , and let @xmath118 be the probability of @xmath119 for each @xmath120 .",
    "we call the geometric mean @xmath121{p_{1}\\dotsb p_{n}}\\ ] ] the _ average probability _ of the random experiments @xmath116 giving the result @xmath122 .",
    "let us now consider what the cherry picking theorem [ thm : cherrypicking ] does with a set of taxa @xmath0 , initially arranged as a star - like tree ( see figure [ fig : cherrypickingtree ] ) .",
    "consider two taxa @xmath123 fixed and let @xmath124 . on a species tree on @xmath0 which displays the cherry @xmath54 , this is the probability that a gene quartet tree sampled from the taxa @xmath37 differs from the species quartet tree @xmath35 .",
    "let @xmath125{\\prod_{k , l}q(ij , kl)}\\ ] ] be the average probability of discordance of a sampled gene quartet tree with the corresponding quartet on the species tree , for a set of four taxa containing @xmath65 and @xmath66 .",
    "we will also call this number the ` average probability of incomplete lineage sorting ' for quartets containing the taxa @xmath65 and @xmath66 . with this terminology ,",
    "the cherry picking theorem [ thm : cherrypicking ] can be phrased as follows .",
    "a pair of taxa @xmath48 is a cherry on the true species tree @xmath2 if it minimizes the average probability for incomplete lineage sorting for quartets containing the taxa @xmath65 and @xmath66 .",
    "[ thm : avprobincomplete ]    using theorem [ thm : cherrypicking ] we only have to show that @xmath126 is minimal if and only if @xmath53 is maximal . but",
    "this follows from the fact that @xmath127 where @xmath128 is a constant independent of @xmath104 .",
    "@xmath129 i & [ fillstyle = solid , fillcolor = black ] & [ fillstyle = solid , fillcolor = black ] \\\\    & [ fillstyle = solid , fillcolor = black ] & [ fillstyle = solid , fillcolor = black ] \\\\",
    "j & [ fillstyle = solid , fillcolor = black ] & [ fillstyle = solid , fillcolor = black ]   \\ncline{2,2}{1,1 } \\ncline{2,2}{1,2 } \\ncline{2,2}{1,3 } \\ncline{2,2}{2,3 } \\ncline{2,2}{3,1 } \\ncline{2,2}{3,2 } \\ncline{2,2}{3,3 } \\endpsmatrix & & \\psmatrix[mnode = circle , linewidth=1pt , rowsep=1 cm , colsep=1 cm ] i & & [ fillstyle = solid , fillcolor = black ] & [ fillstyle = solid , fillcolor = black ] \\\\   & [ fillstyle = solid , fillcolor = black ] & [ fillstyle = solid , fillcolor = black ] & [ fillstyle = solid , fillcolor = black ] \\\\",
    "j & & [ fillstyle = solid , fillcolor = black ] & [ fillstyle = solid , fillcolor = black ]   \\ncline{2,2}{2,3 } \\ncline{2,2}{1,1 } \\ncline{2,2}{3,1 } \\ncline{2,3}{1,3 } \\ncline{2,3}{1,4 } \\ncline{2,3}{2,4 } \\ncline{2,3}{3,4 } \\ncline{2,3}{3,3 } \\endpsmatrix \\end{tabular } $ ]    [ fig : cherrypickingtree ]",
    "in this section we discuss how the above cherry picking result can be used to design an algorithm which estimates a species tree from ( observed ) gene quartet tree frequencies .",
    "the first version of our neighbor joining algorithm reconstructs the underlying species tree from the ( theoretical ) gene quartet tree distributions .",
    "[ alg : naive ] * input * : a set of taxa @xmath130 containing at least four elements , and for each quartet @xmath131 with @xmath132 the probability @xmath133 of the quartet @xmath134 under the multispecies coalescent model on the species tree @xmath2 .    *",
    "output * : the species tree @xmath2 .",
    "* step 0 . * set @xmath2 to be the graph with vertex set @xmath0 and with empty edge set .    * step 1 . * if @xmath135 go to step 4 .",
    "* for each unordered pair @xmath136 calculate the depth @xmath53 . let @xmath137 be a pair of taxa with maximal depth .",
    "add a node @xmath20 to @xmath2 and draw edges from @xmath65 to @xmath20 and from @xmath66 to @xmath20 .",
    "replace @xmath0 by @xmath138",
    ".    * step 3 .",
    "* for each quartet @xmath139 with @xmath140 set @xmath141 and for all quartets @xmath142 which do not contain @xmath20 set @xmath143 .",
    "replace @xmath144 by @xmath145 .",
    "go to step 1",
    ".    * step 4 . *",
    "if @xmath146 , then add a vertex to @xmath2 and draw edges from this new vertex to the three elements of @xmath147 .",
    "each calculation of @xmath53 requires @xmath148 logarithms and additions .",
    "repeating this for every pair @xmath104 of taxa gives a computational complexity of @xmath149 for step 2 .",
    "this is also the complexity of one iteration of the algorithm . since each step will identify exactly one cherry , we need @xmath150 iterations to reconstruct @xmath2 , which gives a total complexity of @xmath151 for algorithm [ alg : naive ] .",
    "it is rather straightforward to improve step 2 so that the algorithm requires only @xmath149 arithmetic operations ( see subsection [ subsect : complexity ] ) .    using the result of theorem [ thm : avprobincomplete ]",
    ", we may summarize : _ with algorithm [ alg : naive ] we have described a greedy algorithm which inferes in each step the cherry which requires minimal incomplete lineage sorting .",
    "_ further , the fact that cherry picking is statistically consistent implies that also species tree estimation by algorithm [ alg : naive ] is statistically consistent :    let @xmath106 be the number of loci sampled from each taxon in @xmath0 and denote by @xmath152 the estimate for the species tree produced by algorithm [ alg : naive ] .",
    "if the number of genes @xmath106 goes to infinity , then the probability that @xmath152 equals the true species tree @xmath2 approaches 1 .",
    "this follows by a repeated application of corollary [ cor : consistent ] .    in practical applications two problems may occur using algorithm [ alg : naive ] :",
    "first , there might be several non - disjoint pairs of taxa with maximal depth .",
    "this could be resolved by chosing one of these pairs randomly .",
    "a more serious problem occurs when many of the empirical gene quartet distributions are 0 .",
    "this will be discussed in the following subsection .",
    "algorithm [ alg : naive ] works well if one uses as input the theoretical probabilities for quartet gene trees .",
    "it also works well , if one uses relative quartet frequencies which are ` very close ' to the probabilities @xmath102 ( and in particular non - zero ) . in other cases ,",
    "the result might be problematic , as we are going to explain now .",
    "imagine that for some reason ( e.g.  very long branch lenghts on the species tree ) the observed quartet gene trees reflect very precisely the topology of the species tree .",
    "this might mean in the extreme case that for every four - taxon subset @xmath153 one observes only this very quartet gene tree which is displayed also by the ( unknown ) species tree . in some sense this situation should be optimal , since the observed gene quartet trees fit together without conflict and thus yield an unambiguous estimate for the species tree .",
    "however , let us run algorithm [ alg : naive ] with the empirical depth function @xmath105 in place of @xmath108 and consider any pair @xmath104 of taxa .",
    "regardless of the choice of @xmath65 and @xmath66 , there exist @xmath154 such that @xmath35 is a quartet on the species tree , and hence by our assumption @xmath155 . calculating the empirical depth of @xmath49 yields @xmath156 thus _ every _ pair @xmath49 maximizes @xmath105 , and",
    "so in each iteration of algorithm [ alg : naive ] the choice of a cherry is completely arbitrary .",
    "so this procedure fails in a situation , which has to be considered the ` easiest ' possible in some obvious sense .",
    "a possible solution to this problem is to perturb the arguments in the logarithms in equation by a small number @xmath157 . in other words , we fix @xmath158 and calculate , for each pair of taxa @xmath104 , the ` perturbed depths ' @xmath159 obviously , for @xmath160 we have @xmath161 and @xmath162 , for all pairs @xmath163 . from this",
    "we obtain the following easy    assume that the theoretical probabilities @xmath102 are known for each four taxon subset @xmath164 and are used as input for algorithm [ alg : naive ] .",
    "then there exists a constant @xmath165 such that algorithm [ alg : naive ] computes the same results with @xmath166 in place of @xmath108 , for each @xmath167 .",
    "in other words , if @xmath168 is the species tree inferred by algorithm [ alg : naive ] with @xmath166 in place of @xmath108 , then the limit @xmath169 exists and is equal to @xmath170 . [",
    "lem : epsilon ]    this follows from the fact that @xmath2 is a binary tree , that there are only finitely many values of @xmath108 and that @xmath171 depends continuously on @xmath172 .",
    "this suggests that for practical applications it will be reasonable to fix @xmath173 ` small enough ' , and run algorithm [ alg : naive ] with the perturbed empirical depth function @xmath174 in place of @xmath108 in order to avoid ` infinite depths ' as in the discussion at the beginning of this subsection .",
    "hence we obtain the following modification of algorithm [ alg : naive ] .",
    "[ alg : improved ] *",
    "input * : a finite set of taxa @xmath175 , a ` small ' constant @xmath157 , and for each four taxon subset @xmath176 the relative quartet gene tree frequencies @xmath177 , @xmath178 , @xmath179 .    * output * : an unrooted tree @xmath180 on @xmath0 which is our estimate for the topology of the species tree @xmath2 on @xmath0 .",
    "* algorithm * : run algorithm [ alg : naive ] with the depth function @xmath53 substituted by the empirical depth @xmath181 .",
    "the result of this calculation is @xmath180 .    indeed ,",
    "if we apply this modified algorithm to the problematic situation at the beginning of this subsection , we will obtain ( for any choice of @xmath172 ) a fully resolved correct estimate for the species tree @xmath2 .",
    "of course , this algorithm has the same complexity as algorithm [ alg : naive ] .",
    "we want to claim that , for sufficiently small values of @xmath172 , quartet - nj produces a asymptotically correct estimate of the true species tree on @xmath0 . to this end , we first prove    there exists a constant @xmath165 such that for all @xmath182 the trees @xmath180 are equal . in other words , the limit @xmath183 exists . [",
    "lem : epsilon_empirical ]    since there are only finitely many cherries to pick , we may restrict our considerations to the picking of the first cherry .",
    "we have to distinguish two cases : first assume that there are taxa @xmath104 such that @xmath184 , i.e. the set @xmath185 is nonempty . if @xmath172 is small enough , then the maximum of the values of @xmath174 is attained at one of the pairs in @xmath186 .",
    "at which of those pairs the maximum is attained then only depends on the number of summands in @xmath181 which approach infinity as @xmath172 tends to zero .",
    "this number is clearly independent of @xmath172 , whence the set of potential cherries to pick is independent of @xmath172 .    in the second case , there are no elements in the set @xmath186 .",
    "this means that each of the perturbed empirical depths @xmath181 approaches the _ finite _ value @xmath103 as @xmath172 tends to zero .",
    "this again means that , for @xmath172 small enough , the pair which maximizes @xmath174 does not depend on @xmath172 .    combining this with lemma [ lem : epsilon ] we obtain the desired result .    the limit @xmath187 exists and is a statistically consistent estimate for the true species tree @xmath170 . in particular ,",
    "quartet - nj ist statistically consistent .",
    "[ thm : main ]    the existence of the limit in the theorem is established by lemma [ lem : epsilon_empirical ] .",
    "it remains to prove that it is a statistically consistent estimate for @xmath2 .",
    "recall that the definition of the function @xmath181 depends on the relative frequencies @xmath101 .",
    "if we consider the probabilities @xmath102 known and fixed and moreover fix the pair of taxa @xmath49 , then we may consider the function @xmath188 depending on the ` variables ' @xmath101 and @xmath172 .",
    "this is a continuous function which vanishes on the line @xmath189 .",
    "thus for every @xmath115 there exists an open ball centered at @xmath190 which is mapped to @xmath191 by @xmath192 . in particular , there exists a positive constant @xmath193 such that for every @xmath49 we have @xmath194 if @xmath195 and @xmath196 . if we chose @xmath115 small enough",
    ", we thus may conclude that @xmath197 for every @xmath196 and for all relative frequencies satisfying @xmath195 .",
    "moreover , by lemma [ lem : epsilon ] we may assume , by reducing @xmath198 if necessary , that @xmath199 for every @xmath196 .",
    "taking this together we obtain that , provided @xmath195 for every quartet @xmath35 , @xmath200 .",
    "since @xmath101 is a statistically consistent estimate for @xmath102 , this proves that @xmath201 is a statistically consistent estimate for @xmath2 .",
    "the question of how to find an appropriate @xmath202 to run the neighbor joining algorithm will of course depend on the special problem instance and is left open here .      here",
    "we briefly mention a complexity reduction for the quartet neighbor joining algorithm . since algorithm [ alg : naive ] and [ alg : improved ] are completely equivalent in this respect , we formulate this reduction only with the simpler notation of algorithm [ alg : naive ] .",
    "we consider step 2 in algorithm [ alg : naive ] . in our present formulation ,",
    "this step calculates the depth @xmath53 by adding up @xmath148-many quartet weights for each pair of taxa @xmath104 .",
    "however , most of these quartet weights will not have changed during the last iteration of the algorithm .",
    "assume that in the previous iteration the cherry @xmath203 was identified and joined by a new vertex @xmath20 .",
    "then for any pair of taxa @xmath104 which are still present in @xmath0 we may calculate the new depth @xmath204 from the old one by the formula @xmath205 this reduces the complexity of step 2 from @xmath206 to @xmath207 , and hence the overall complexity of algorithms [ alg : naive ] and [ alg : improved ] are reduced by this modification to @xmath149 .",
    "in order to test quartet neighbor joining on real data , algorithm [ alg : improved ] was applied to a set of protein sequences from nine prokaryotes , among them the two archaea _ archaeoglobus fulgidus _ ( af ) and _ methanococcus jannaschii _ ( mj ) , as well as the seven bacteria _ aquifex aeolicus _ ( aq ) , _ borrelia burgdorferi _ ( bb ) , _ bacillus subtilis _ ( bs ) , _ escherichia coli _ ( ec ) , _ haemophilus influenzae _ ( hi ) , _ mycoplasma genitalium _ ( mg ) , and _ synechocystis sp . _ ( ss ) .",
    "the choice of organisms follows teichmann and mitchison @xcite , while the multiple sequence alignments where taken out of the dataset used by cicarelli et al .  in @xcite .",
    "for each of the 28 protein families in the list    1 .",
    "ribosomal proteins , small subunits : s2 , s3 , s5 , s7 , s8 , s9 , s11 , s12 , s13 , s15 , s17 , l1 , l3 , l5 , l6 , l11 , l13 , l14 , l15 , l16 , l22 ; 2 .",
    "trna - synthetase : leucyl- , phenylalanyl- , seryl- , valyl ; 3 .",
    "other : gtpase , dna - directed rna polymerase alpha subunit , preprotein translocalse subunit secy ,    a distance matrix was calculated using belvu @xcite with ` scoredist'-distance correction ( sonnhammer and hollich @xcite ) . for each distance matrix ,",
    "a set of quartet trees was inferred in the classical way by finding , for each four taxon set @xmath208 , the unrooted quartet @xmath32 which maximizes the value @xmath209 where @xmath210 denotes the respective entry in the distance matrix .",
    "algorithm [ alg : improved ] was then run with the parameter @xmath211 , and @xmath212 on the quartet distribution obtained from analyzing all the 28 protein families above , and in a second try on the quartet distributions obtained only by the ribosomal proteins .",
    "the resulting tree topologies are depicted in figures [ fig : all ] and [ fig : ribosomal ] , respectively ( the root of these trees is of course not predicted by algorithm [ alg : improved ] .",
    "rather it was placed a posteriori on the branch which separates archaea from bacteria on the unrooted output of the algorithm . )",
    "the different choices of @xmath172 did not affect the result in these calculations .",
    "as a first test of performance of algorithm [ alg : improved ] two series of simulations were performed as follows . for a certain choice of a species tree @xmath2 on a set of taxa @xmath0",
    ", a coalescent process was repeatedly simulated using the coalescence package of mesquite @xcite , @xcite .",
    "each simulation yielded a set of gene trees on @xmath0 , and from these the frequency of each unrooted quartet gene tree with leaves in @xmath0 was determined .",
    "these frequencies where then submitted to algorithm [ alg : improved ] and the resulting ( unrooted ) tree was compared with the ( unrooted version of the ) species tree @xmath2 .",
    "we report here the proportion of correct inferences of the unrooted species tree in the different situations .    in the first series of simulations the underlying species tree was the 5-taxon caterpillar tree @xmath213 , with all internal branch lengths set equal ( of course , the length of the pending edges does not have an impact , as we consider only one lineage per taxon ) .",
    "algorithm [ alg : improved ] was run 1000 times using 5 , 10 , 20 and 50 sampled gene trees per trial , 500 times using 100 gene trees , 250 times using 200 gene trees , and 100 times using 500 simulated gene trees per trial .",
    "the proportion of trials which yielded the correct unrooted species tree topology is reported in table [ tab : caterpillar ] .",
    "note that simulations under the 5-taxon caterpillar tree are also performed by liu and yu @xcite in order to assess the performance of their ` neighbor joining algorithm for species trees ' . for our choices of branch lengths and sample sizes",
    ", the performance of algorithm [ alg : improved ] seems to be roughly equal to the performance of ` neighbor joining for species trees ' ( liu and yu @xcite , figure 2 ) .    in a second series of simulations ,",
    "the underlying species tree was the tree inferred by algorithm [ alg : improved ] for the nine prokaryotes in section [ subsect : prokaryotes ] , see figure [ fig : all ] .",
    "again , for different internal branch lengths and different numbers of gene trees per trial , 1000 trials ( in the case of 5 , 10 , 20 and 50 gene trees per trial ) , and 500 resp .",
    "100 trials ( in the case of 100 resp .",
    "500 gene trees per trial ) were run , and the proportions of correctly inferred unrooted species tree topologies are reported in table [ tab : prokaryotes ] .",
    "two comments are in order : ( 1 ) in fact , for each choice of the parameter @xmath20 ( and fixed number of gene trees per trial ) two simulations were performed .",
    "for the first , the length of the branch leading to the cherry formed by mj and af was set to @xmath214 , while in a second simulation this branch length was set to @xmath215 .",
    "the differences in the proportions of successful trials are small in most cases ( between one and two percent ) , and , as expected , in most cases the proportion of successful trials was bigger in the first situation .",
    "\\(2 ) the number of gene trees ( or rather , the number of unrooted quartet gene trees for each 4-taxon subset ) used for the reconstruction of the prokaryote species tree in section [ subsect : prokaryotes ] where 21 and 28 , respectively . from table [",
    "tab : prokaryotes ] we see that such a species tree @xmath2 is likely to be inferred correctly by algorithm [ alg : improved ] if its internal branch lengths are around @xmath216 ( with a probability of more than 90 percent ) . for branch lengths around @xmath217",
    ", however , the probability for a correct inference of @xmath2 decreases to about 40 to 50 percent .",
    "( however , there might still be certain clades on @xmath2 which can be detected with high accuracy also for smaller branch lengths . ) clearly , in these considerations we ignore effects such as horizontal gene transfer , for whose existence there is evidence in the case of the nine prokaryotes considered in section [ subsect : prokaryotes ] for some non - ribosomal proteins ( see teichmann and mitchison @xcite ) .",
    ".simulation results for the 5-taxon caterpillar tree @xmath213 with all internal branch lengths set to @xmath20 ( in coalescent units ) .",
    "table entries are proportions of trials which yielded the correct unrooted species tree topology .",
    "columns are labelled by the number of simulated gene trees used in each trial . [ cols=\"^,^,^,^,^,^,^,^ \" , ]      elizabeth s. allman , james h. degnan , and john a. rhodes . _ identifying the rooted species tree from the distribution of unrooted gene trees under the coalescent .",
    "_ j. math .",
    "( 2011 ) , in press : doi:10.1007/s0028501003557 .",
    "y. yu , t. warnow , and l. nakhleh , _ algorithms for mdc - based multi - locus phylogeny inference .",
    "_ proceedings of the 15th annual international conference on research in computational molecular biology ( recomb ) , lnbi 6577 , 531 - 545 , 2011 ."
  ],
  "abstract_text": [
    "<S> in this article we propose a new method , which we name ` quartet neighbor joining ' , or ` quartet - nj ' , to infer an unrooted species tree on a given set of taxa @xmath0 from empirical distributions of unrooted quartet gene trees on all four - taxon subsets of @xmath0 . in particular , quartet - nj can be used to estimate a species tree on @xmath0 from distributions of gene trees on @xmath0 . </S>",
    "<S> the quartet - nj algorithm is conceptually very similar to classical neighbor joining , and its statistical consistency under the multispecies coalescent model is proven by a variant of the classical ` cherry picking'-theorem . in order to demonstrate the suitability of quartet - nj , coalescent processes on two different species trees ( on five resp .  </S>",
    "<S> nine taxa ) were simulated , and quartet - nj was applied to the simulated gene tree distributions . </S>",
    "<S> further , quartet - nj was applied to quartet distributions obtained from multiple sequence alignments of 28 proteins of nine prokaryotes . </S>"
  ]
}