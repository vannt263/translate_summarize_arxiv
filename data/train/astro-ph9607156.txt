{
  "article_text": [
    "ideally , a good cosmological @xmath1-body simulation should resolve in some detail the internal structure of individual galaxies ( on mass scales as low as @xmath2 to @xmath3 and on length scales of a few kiloparsecs or less ) while at the same time representing the growth of density perturbations on the scale of clusters and even superclusters of galaxies .",
    "galaxy morphologies are observed to correlate with their membership in clusters .",
    "the virgo cluster is estimated to be an appreciable , if not dominant , source of tides on the local group 15 to 20  mpc away . and",
    "when studying the nonlinear growth of galaxy - sized perturbations , one should not discount the possible coupling to modes with wavelengths as large as 50  mpc ( @xcite ) .    achieving",
    "the required dynamic range is a difficult task given the limitations of present - day computers .",
    "generally , numerical codes have been able to obtain a large dynamic range either in mass or in length , but not in both .",
    "particle - particle ( pp ) methods ( @xcite ) and tree codes ( appel 1981 , 1985 ; @xcite ; @xcite ) have essentially unlimited length resolution , bounded only by the need to soften two - body encounters when modeling a collisionless physical system , but their use for simulations with more than a few tens , respectively hundreds , of thousands of particles is currently restricted to special - purpose hardware ( such as grape chips ) or massively parallel computers ( @xcite ) .",
    "particle - mesh ( pm ) methods ( @xcite , hereafter he ; @xcite ) , by contrast , can integrate the orbits of millions of interacting particles even on a more modest single - processor mainframe or high - end workstation .",
    "the forces are computed by solving poisson s equation on a cartesian grid . barring complications such as a memory latency that increases with problem size , the computational cost per time step is linear in the number of particles and of order @xmath4 in the number of grid cells ( which is typically of the same order as the number of particles ) .",
    "the dynamic range in length , however , is limited by the maximum size of the grid , typically 256 or 512 cells on a side in three dimensions on a current single - processor computer .",
    "parallel processing can naturally push this limit towards higher values .    one can circumvent this obstacle by decomposing the inter - particle forces into a long - range part , calculated by the pm technique , and a small - range part which can be evaluated in a number of different ways . for some time",
    ", a popular approach has been to compute the short - range forces by direct summation over all sufficiently close pairs of particles .",
    "this technique , known as the particle - particle , particle - mesh ( p@xmath5 m ) method ( he  8) , was originally applied to plasma simulations where the electrostatic repulsion between charges of the same sign makes it difficult for large density contrasts to develop .",
    "its use with gravitating systems suffers from the tendency for ever more particles to condense into small volumes , causing the cost of the pp summation to become prohibitive as the system evolves .",
    "increasing the total number of particles and resolving smaller scales ( on which density perturbations become nonlinear at earlier times , at least in the presently favored `` bottom - up '' scenario ) both exacerbate the problem .",
    "we are unaware of any p@xmath5 m simulations using more than about @xmath6 particles",
    ". one may be able to raise this limit by using a tree method to compute the short - range forces , as in xu s ( 1995 ) tpm , but in principle the difficulty remains .",
    "most other attempts to enhance the spatial resolution of pm codes rely on the introduction of local grid refinements .",
    "this idea lies at the root of couchman s ( 1991 ) adaptive p@xmath5 m ( ap@xmath5 m ) ( which however still uses direct summation where the number of particles is small enough ) , of numerous hierarchical pm codes ( @xcite ; @xcite ; @xcite ; @xcite , hereafter anc ; @xcite ; @xcite , hereafter jdc ; @xcite ) and of various related approaches ( @xcite ; @xcite ) .    as pointed out by various authors , and most recently by suisalu and saar ( 1995b ) ,",
    "the choice between pm , p@xmath5 m , and tree codes is not only a question of the spatial and mass resolution that can be achieved , but also of the behavior of each method with respect to two - body gravitational collisions .",
    "these are to be avoided when the physical system being modeled is essentially collisionless , as is the case for example for cosmological dark matter .",
    "pm codes usually prove to be less collisional , although it should be emphasized that this is at least in part a consequence of their spatial resolution being weaker than their mass resolution , and need not carry over to hierarchical pm methods unless precautions are taken to ensure that the mass granularity remains adequate at all times .",
    "the purpose of this article is to document in some detail our implementation of a dynamically adaptive multiple - mesh code and the tests we performed to validate it .",
    "so far , only a brief report of an earlier stage of development ( @xcite ) and a description of the methodology but not of the tests ( @xcite ) have appeared .",
    "our code , like that of jdc , is able to track the formation and subsequent motion of density concentrations by dynamically adjusting the number , nesting depth and location of the subgrids . in our case ,",
    "the entire grid structure is chosen afresh on every step . since our first intended application was a cosmological problem  the formation of the local group  that requires the freedom to specify external tidal fields other than would be implied by periodic image charges , our code presents the relatively uncommon combination of an expanding system of coordinates with isolating ( more properly non - periodic ) boundary conditions .",
    "this introduces a number of complications not usually discussed in the literature on pm codes , and of which we shall give an account here .",
    "( our method is also applicable to non - cosmological problems , for which isolating boundary conditions are an asset and the aforementioned complications do not arise . )",
    "a future article ( @xcite ) will detail the results of our simulations of group formation .",
    "the general outline of this paper is as follows .",
    "section  [ s : method ] describes in detail the method used .",
    "the tests and their results are presented in section  [ s : tests ] .",
    "we conclude , in section  [ s : conclusions ] , with our assessment of the strengths and limitations of this code .",
    "our code integrates the equations of motion for a set of gravitating particles .",
    "these equations can be derived from the lagrangian @xmath7 here the indices @xmath8 and @xmath9 span the set of particles in the system , @xmath10 is the mass of particle @xmath8 , @xmath11 its position at time @xmath12 , and @xmath13 describes the law of pairwise interaction between particles",
    ". ideally @xmath14 ( we choose units such that @xmath15 ) but the numerical method forces us to use an approximation which , due to adaptive grid refinement , can depend explicitly on time and on the individual coordinates @xmath16 and @xmath17 , not just on their difference .",
    "we could have included the term proportional to @xmath18 ( where @xmath18 is an arbitrary constant ) within the external potential @xmath19 , but for cosmological applications it is useful to show it explicitly .",
    "it is often convenient to apply a time - dependent rescaling of the coordinate system , with new coordinates @xmath20 defined by @xmath21 .",
    "an equivalent lagrangian is then @xmath22 for notational convenience , we define @xmath23 note that in principle @xmath24 is arbitrary , reflecting our freedom to choose the coordinate system . for cosmological applications",
    "one normally chooses @xmath24 to be the solution of friedman s equation for some cosmological model , in which case @xmath25 is the background density and @xmath26 the hubble constant for that model . later in this paper",
    "we shall impose the additional restriction @xmath27 , which holds for cosmological models in the matter - dominated era",
    ".    the second term in the lagrangian  ( [ q : lag - x ] ) can be regarded as involving an effective potential @xmath28 which satisfies @xmath29 .",
    "similarly , in the continuum limit and for a coulomb interaction ( @xmath30 ) , the third term satisfies @xmath31 , where the proper density @xmath32 is given by @xmath33 and @xmath34 ( respectively @xmath35 ) denotes differentiation with respect to the first ( respectively the second ) of the two position vectors on which @xmath36 depends .    the usual derivation of the equations of motion from the lagrangian  ( [ q : lag - x ] ) yields : @xmath37 for later convenience",
    ", we define @xmath38 this allows the equation of motion  ( [ q : motion ] ) to be written more compactly as @xmath39 it is also useful to recast the equation in terms of a generalized time coordinate @xmath40 : @xmath41 with @xmath42 a common choice is the so - called conformal time , @xmath43 ; another ( @xcite ) is @xmath44 for some constant @xmath45 .",
    "naturally , any sufficiently differentiable monotonic function of  @xmath12 is acceptable , and one is free to construct such a function _ ad hoc _ for each individual simulation .",
    "we avail ourselves of this freedom .",
    "we lay down a rectangular grid of @xmath46 by @xmath47 by @xmath48 nodes with uniform spacings @xmath49 , @xmath50 and  @xmath51 .",
    "the values of @xmath46 , @xmath47 and @xmath48 must be acceptable to the fast fourier transform ( fft ) routines used .",
    "( all our tests were done with @xmath52 a power of 2 , and with @xmath53 , as this is the most common situation in practice and the only one we needed for our applications . ) at every step , a density is assigned to each grid point using the cloud - in - cell ( cic ) algorithm .",
    "ffts are then used to solve for the potential on the same grid , and an acceleration is obtained for each particle by differentiating the grid potential , then using cic interpolation .",
    "we use a two - point finite - difference formula to compute the derivatives of the potential at grid nodes .",
    "this choice means that truncation errors in the force law scale with the square of the grid spacing ( he ,  5 - 4 ) .",
    "the discrete green s function we use is obtained by sampling @xmath54 at grid points ( and fourier transforming the result ) .",
    "this differs from the more common approach in cosmological pm codes ( @xcite ) of basing the green s function on the seven - point finite difference approximation to the laplacian ; our choice has the merit of guaranteeing the truncation of the interaction law at large separations , as required for a correct implementation of isolated boundary conditions ( @xcite ) . unlike in the p@xmath5 m method , where the grid - based part of the force must possess a good degree of translational invariance to avoid introducing terms in the direct particle - particle contribution that depend explicitly on the position of each pair relative to the grid , we are not compelled to soften the interaction at small scales .",
    "to do so would cost us precious spatial resolution ; already with our choice of green s function the effective force turns out to be softened at separations @xmath55 grid cells .",
    "a consequence of our decision not to soften the force law any further is that the @xmath56-minimization procedure of he  8 - 3 - 3 , which requires the reference force to have no harmonics on scales smaller than the grid spacing , is not appropriate for us .",
    "the choice of the shape of the interaction law at small separations and of the charge assignment and force interpolation scheme is a matter of compromise between accuracy and computational cost .",
    "our choices could undoubtedly be improved upon , but we preferred to concentrate our efforts on the more innovative aspects of our method .",
    "isolated boundary conditions are implemented by conceptually doubling the size of the grid in each dimension , and padding the density array with an appropriate constant value ( normally zero ) outside the principal octant , which contains the particles ( he ,  6 - 5 - 4 ) .",
    "if the green s function is truncated so that the interaction falls to zero at separations larger than the system ( before doubling ) , this completely suppresses any interaction between the system and its periodic images .",
    "the computed potential , however , will only match that of an isolated system within the principal octant . since we need to apply a gradient operator to the potential in order to compute the forces",
    ", there is a layer ( one cell thick for our approximation to the gradient ) in which we would not be able to compute them .",
    "we therefore allow no particles in this outer layer .",
    "( we are free to increase the thickness of this layer .",
    "it has been convenient to do so in some of the tests discussed below , to achieve an integral ratio of cell counts in comparisons between different grid resolutions . )",
    "we do not use james ( 1977 ) method to impose isolated boundary conditions without doubling the grid by calculating appropriate screening charges on the surface , since strictly speaking the procedure is only justified when a finite - difference approximation to the laplacian is used in solving poisson s equation .",
    "the fft technique does not satisfy this condition , and would require screening charges throughout the volume of the box .    in cosmological applications ,",
    "the space surrounding the system is not to be thought of as empty , but rather as containing a background of uniform density @xmath57 .",
    "( departures from uniformity can be represented through an appropriate choice for the tidal potential @xmath19 . )",
    "we must therefore add this background , convolved with the same ( cic ) charge assignment function that is used for the particles .",
    "its contribution to the density at any node on the boundary of the region where particles are allowed is then proportional to the number of cells adjacent to this node that lie outside the particle region : @xmath58 for nodes on a face , @xmath59 on an edge , @xmath60 at a vertex .",
    "we implement the @xmath61 term of the equation of motion ( equation  [ q : motion ] ) by subtracting @xmath62 from the density at all points before solving for the potential .",
    "if @xmath62 coincides with the background cosmological density , the source function for the potential outside the principal octant is exactly zero .",
    "this is the most common case , and the one that presents the fewest conceptual and practical difficulties . with periodic boundary conditions it would also be the only possible case since the mean density outside the simulation box must always equal that inside it . with isolated conditions a mismatch is permissible , and",
    "could be used for example in applying an expanding or contracting grid to follow the evolution of an isolated system without a cosmological density background .",
    "the varying @xmath24 would then be adjusted to match the expansion or contraction of the simulated system , providing better resolution at lower cost during the collapse phase .",
    "a very significant difference between periodic and isolated boundary conditions is that the latter allow the exchange of mass , momentum , energy , angular momentum between the particles and the exterior . with periodic boundary conditions",
    ", there is effectively no exterior .",
    "particle flows are a significant concern in cosmological applications , where matter may both leave and enter the computational box during the simulation . in a typical cosmological model ,",
    "the mass variance is of order unity in a sphere of radius @xmath63  mpc .",
    "one expects particles at the edge of a sphere of radius @xmath64 to be displaced with respect to the center of mass of the sphere by about @xmath65 , a significant length when compared to the size of a group or cluster of galaxies .",
    "a simulation of characteristic size @xmath64 may reasonably be expected to exhibit a twofold increase or decrease in the total mass within the box during a run . on smaller scales",
    "the variance is even larger , at least for the currently fashionable `` bottom - up '' scenarios of structure formation .    exiting particles",
    "are easily handled by removing them from the simulation , but incoming particles have to be injected according to some prescription that fits the physical problem at hand . in the cosmological case , as long as the density perturbations grow linearly on the scale of the box , a reasonable prescription can be based on extrapolations from the linear theory . at late times , in the strongly non - linear regime , simply extrapolating from the linear solution causes large amounts of material to be injected which in reality would collapse into bound objects outside the box and remain outside . in other words , the zeldovich approximation is clearly inappropriate beyond the time at which caustics form .",
    "it would lead to a gross overestimate of the total mass flow into the box .",
    "an adequate model of the inflow in the nonlinear regime therefore requires an actual simulation of the mass flows in a larger region .",
    "this has become normal practice in simulations with tree codes , and hierarchical grid methods such as ours also lend themselves well to this approach .",
    "the main difficulty is that in order to keep the total number of particles manageable , one must essentially run a preliminary simulation simply to find out where the mass that flows into the region of interest originated and sample it with a finer granularity in the initial conditions .",
    "this may lead to problems of contamination by more massive `` background '' particles if the small - scale structure that is not resolved by the preliminary simulation turns out to have a significant impact on the dynamics .",
    "furthermore , the presence of particles of different masses in the system could lead to spurious mass segregation effects .",
    "for these reasons , we attempted to keep the overall size of the computational box as small as possible , handling the tidal fields on larger scales , as well as any mass flows ( as long as they remained moderate ) as externally imposed boundary conditions .",
    "this turned out not to be a particularly successful design choice , and we can not recommend it to others .",
    "injecting too many , or too few , particles can have a destabilizing effect .",
    "the first term on the right hand side of equation  [ q : motion ] has , in the usual case @xmath66 , the effect of accelerating particles towards the boundary of the box .",
    "this is balanced by the second term , which represents the attraction between the gravitating particles .",
    "if more particles leave the box than are injected , the first term will tend to dominate and cause even more particles to be ejected ; conversely , if too many particles are added the material will tend to collapse towards the center .",
    "this may be taken to represent a physical effect : a void is expected to expand faster than the universal average , an over - density more slowly .",
    "but unless the algorithm for replenishing the box with particles is well thought out , a runaway instability may occur .",
    "in practice we have found it expedient to couple the injection of particles to the outflow so as to maintain a constant mass within the system .",
    "we then monitor the cumulative mass of particles so recycled and compare it with the total mass in the box . if the ratio becomes too large ( greater than 10% or so ) , we take it as an indication that one needs to simulate a larger volume of space .",
    "as the volume that needs to be simulated grows larger , our original motivation for using isolated boundary conditions becomes weaker .",
    "it turns out that the method we described in this paragraph works much better if the system is located in a region of lower density than the cosmic mean , as the mass fraction that undergoes reinjection is smaller in that case .",
    "this allows us to simulate a number of interesting systems , but is not suitable for statistical studies involving a random selection of initial conditions .",
    "momentum , angular momentum , and energy can be carried by the particles that flow in and out of the system and by direct interaction with the external potential @xmath67 and the uniform density we impose in the space that surrounds the particle region .",
    "the latter unfortunately has the cubic symmetry of the computational box rather than the more convenient spherical symmetry that would be required for an exact cancellation of the induced tides .",
    "consequently , these tides are always present except in the pure non - cosmological case with @xmath68 a constant , where the background density vanishes . whether this is a serious drawback depends on the physical problem being studied .",
    "if necessary , one can enlarge the computational box ( this may be required in any case to keep mass flows under check ) , include a compensating term in @xmath19 , or both .",
    "the idea of adding subgrids in regions where better spatial resolution is required is not a new one .",
    "past approaches have differed on whether to add mass resolution at the same time by splitting the particles into a larger number of less massive ones , on how to minimize errors at the interface between the finer and the coarser grid , and on whether the solution on the coarser grid should be modified to take into account the results from the finer grid .      unlike villumsen ( 1989 ) and splinter ( 1996 )",
    ", we do not automatically introduce a new set of less massive particles on each subgrid .",
    "we take the view that our initial mass granularity already matches the resolution we wish to achieve , and simply increase the force resolution ( by adding subgrids ) when and where the particle density is high enough to make this permissible and worthwhile .",
    "this allows the decision of where to place subgrids to be made on a step by step basis , and spares us the need to perform a first simulation without subgrids to find out where particles of smaller mass should be placed in the initial conditions .",
    "an additional advantage of having a single set of particles of equal mass is that we need not worry about mass segregation effects .",
    "a drawback is that maintaining equivalent resolution within a larger computational volume requires more particles .",
    "of course our code does support multiple particle masses , and as will become clear below the criteria for subgrid placement can be tuned to favor tracking the lower - mass particles ; we may therefore decide to experiment with particles of different masses in future .    in our scheme",
    "the various grids are merely devices , introduced independently on each integration step , to compute inter - particle forces . in this respect",
    "we are closer in spirit to couchman s ap@xmath5 m than to most other multiple - grid approaches .",
    "ours is effectively ( in the terminology of anc ) a particle - multiple - mesh ( pm@xmath0 ) scheme .",
    "this distinction will have important consequences below . since there is only one set of particles that exist independently of any subgrids , the equivalent of a back - reaction from the subgrid solution to the parent grid",
    "is automatically included : it is mediated by the particles themselves .",
    "we typically decrease the grid spacing by a factor of two for each additional level of subgrids .",
    "each subgrid thus covers a substantial number of cells of its parent grid .",
    "other integral refinement factors are allowed by our formulation ( subject to the condition that the boundaries of any subgrid must coincide with cell boundaries of the parent grid ) but become increasingly inefficient in terms of volume coverage and we have not tried them in practice .",
    "they would also exacerbate any `` ringing '' at the interface between a subgrid and its parent grid ; since this is one of the most delicate aspects of any hierarchical grid scheme , it is probably not advisable to use refinement factors larger than two under any circumstances .",
    "a particle passing from a region of low resolution to one of higher resolution effectively undergoes a sudden change in its spatial extent .",
    "( in pm codes , particles are best thought of as extending over about one grid cell or more , depending on the shape of the interaction law and on the charge assignment scheme . ) in its current state , our code takes no particular precautions against any transients that may result .",
    "our comparison tests between runs that use adaptive subgridding and runs with uniform resolution show that such transients are not important enough to produce significant discrepancies in the results .",
    "this is fortunate , since otherwise we would have had to associate a time - dependent smoothing length with every particle , which would complicate the method . that the smoothing length would have to be associated with the particle rather than with the location relative to a subgrid follows both from our choice to treat the particles as primary and the grids as auxiliary objects and from the fact that new subgrids may be added , removed or relocated to follow the flow at every step .",
    "our strategy for computing the forces between subgrid particles differs slightly from that of villumsen .",
    "his approach was to recalculate the potential on the entire parent grid after having set the density in the volume occupied by the subgrid to a constant value equal to the mean density within the subgrid , and use this solution as the tidal field on the subgrid particles from the rest of the system .",
    "the forces between subgrid particles were then computed in the usual way by solving for the potential on the subgrid .",
    "instead , we first compute forces for all particles on the parent grid , then generate the density array on the subgrid ( whose nodes must be aligned with those of the parent grid ) as well as on a coarser grid that has the same spacing as the parent grid and nodes in the same locations but covers only the volume of the subgrid . since coordinates on the subgrid",
    "are affected by the same expansion factor @xmath24 as on the parent grid , we must subtract the same @xmath62 .",
    "we solve for the forces on all subgrid particles from both these density arrays , and add the difference to the forces we had previously calculated on the parent grid .",
    "this avoids double counting and means in effect that pairwise forces between particles that both lie in the subgrid are always evaluated at the higher of the two resolutions .",
    "the coarse fft on the subgrid involves far fewer grid points , so our approach is more efficient than villumsen s .",
    "it is also more flexible , in that we only need to store the accumulated force for every particle and the density potential for a single subgrid at a time , independently of the number and nesting depth of subgrids .",
    "the cost of actually storing a force vector for every particle may seem high when one knows that in a traditional pm code with leapfrog time stepping the particle accelerations can be interpolated when the velocities are updated and need not be kept afterwards ; but saving them allows us to use them to adjust the time step and to compute subgrid corrections to the energy conservation test . on the other hand , we could have supported independent time steps had we chosen to save the potential on each subgrid instead .",
    "this , however , would have caused the storage requirements to scale with the subgrid nesting depth .",
    "let @xmath69 be the set of particles in the subgrid , @xmath70 its complement .",
    "schematically , the acceleration on particle @xmath8 is computed as follows . for @xmath71 ,    @xmath72    for @xmath73 , @xmath74    where @xmath75 is the approximation to the coulomb potential on the parent grid , @xmath76 the approximation on the subgrid , and @xmath77 that on the subset of the parent grid that covers the subgrid .",
    "( in reality , the sums are evaluated by fft and include the @xmath62 term . )",
    "@xmath78 to a very good degree , provided only that the grid nodes are in the same locations .",
    "( this is an essential requirement : we have found that violating it has deleterious effects on the solution . )",
    "the two rightmost terms in the display of equation  ( [ q : acc - sgr-1 ] ) therefore cancel each other .",
    "note that we add together force contributions from the various grids rather than the potentials ; this allows the arbitrary additive constant in the potential to differ from grid to grid without affecting our solution .",
    "we impose isolated boundary conditions on the subgrid , with an external background density ( @xmath62 ) equal to that used on the parent grid .",
    "it may seem more appropriate to use the mean density within the subgrid , or ",
    "better yet  the mean density in the immediate vicinity of the subgrid ; but one should note that some ringing is to be expected no matter what the exact scheme adopted since the density at the boundary of the subgrid always has some short - wavelength component that is resolved on the subgrid but not on the parent grid . the usual approach in codes of this type is to try to limit the ringing by introducing around the subgrid a buffer region , in which particles contribute to the potential but are not affected by it , and/or a transition region in which the potentials of the parent grid and of the subgrid are blended linearly .",
    "the transition region implements the variable smoothing length we alluded to at the end of the previous subsection . as already noted",
    ", it is of limited usefulness in our case since it does nt guard against transients induced by the sudden activation of a new subgrid .",
    "the possible motivation for introducing a buffer region can be understood by considering the case of a particle @xmath79 located on the subgrid but near its edge , and subject to the forces of two nearby equidistant particles @xmath80 , also on the subgrid , and @xmath81 just outside it . in the exact solution , @xmath80 and @xmath81 exert forces of equal magnitude on @xmath79 . without a buffer region ,",
    "the calculated force from @xmath80 is stronger",
    ". this can create spurious small - wavelength perturbations as the pair @xmath82 tends to collapse on its own rather than as a triplet @xmath83 .",
    "the introduction of a buffer region would allow the balance to be preserved between the attractions of @xmath80 and @xmath81 .",
    "our implementation of the buffer region is as follows . extending the notation introduced in the previous subsection , we have split @xmath70 into the buffer region @xmath84 and a distant exterior @xmath85 .",
    "equation  [ q : acc - sgr-1 ] is modified in that the sum over @xmath86 becomes a sum over @xmath87 and the sums over @xmath88 become sums over @xmath89 .",
    "we normally set the thickness of this buffer region to be equivalent to three cells of the parent grid : the grid - based force does not differ significantly from the exact coulomb force at separations this large , so that @xmath90 .",
    "since the thickness of the buffer region is fixed in units of the spacing of the parent grid , large refinement factors result in the buffer region `` eating away '' most of the volume of the subgrid .",
    "this is one of the reasons why we only experimented with a refinement factor of 2 at each level .",
    "an essential feature of this buffer region is that it enables us to use multiple adjacent subgrids to cover extended structures that are worthy of higher resolution but do not fit within a single grid .",
    "this could occur either because of their size or because they are located too close to other high - density objects already covered by their own subgrids .",
    "( we do not allow arbitrary overlap of subgrids , for both simplicity and efficiency . ) a problem that might arise when the boundary between two adjacent subgrids cuts through the middle of a high density structure is that the force between two nearby particles separated by the boundary would be calculated with the ( poorer ) resolution of the parent grid .",
    "thanks to the buffer region around each subgrid , this difficulty is avoided : the force exerted by either particle on the other will be computed at subgrid resolution by virtue of each particle lying in the buffer region of the other s subgrid .    in the overlap region between adjacent subgrids",
    ", it matters little whether the border region is implemented as described above or in the following alternative way , by subjecting particles in @xmath84 to the subgrid forces without including them in the subgrid potential .",
    "this corresponds to applying equation  [ q : acc - pgr-1 ] to particles @xmath91 only , and equation  [ q : acc - sgr-1 ] to particles @xmath92 .",
    "our first implementation used the latter approach , and comparison tests show only minute differences between the results of both variants .",
    "a difficulty arises wherever the buffer region has finite width and does not overlap with an adjacent subgrid",
    ". then the balancing of the forces by @xmath80 and @xmath81 over @xmath79 comes at the cost of a violation of newton s second law : the force exerted by @xmath79 on @xmath81 , being computed on the parent grid , does not balance the force by @xmath81 on @xmath79 .",
    "the net result is that @xmath81 will be accelerated outwards , away from the subgrid .",
    "( if the alternative implementation of the buffer region is adopted , the net effect has opposite sign and tends to push the particles inwards . ) the consequences for the orbit of a bound clump can be spectacular , as the following worst - case example , illustrated by figure  [ f : tf4 g ] , shows .",
    "we launch a 4096-particle realization of a truncated isothermal sphere ( with a half - mass radius of 0.02 units , corresponding roughly to half the cell width on the top grid ) with a mean velocity of 0.1 units towards a region covered by a fixed subgrid ( the inner bounds of which are indicated by dotted lines in the figure ) with refinement factor of two and a buffer region of width 0 ( solid curve ) or 2 ( dashed curve ) parent grid cells . for this example we adopted the alternative implementation of the buffer region , which causes the particles to be accelerated inwards .",
    "the initial velocity is along the @xmath93 axis , perpendicular to the faces of the subgrid .",
    "the figure shows the @xmath93 coordinate of the center of mass of the sphere as a function of time @xmath12 . when the buffer region is suppressed ( width 0 , solid curve )",
    "the clump enters and exits the subgrid without changes to its bulk velocity .",
    "( the apparent turnaround occurs when the clump reaches the edge of the computational volume and some particles leave the box .",
    "the solid curve reflects the mean velocity of only those particles that remain in the box . )",
    "the presence of a finite buffer region , by contrast , causes the clump to accelerate as it enters the subgrid , and to bounce back as it tries to exit on the other side .",
    "the reason it does nt simply lose the momentum it gained when entering the subgrid is that the momentum change depends on the difference between the forces calculated on the subgrid and on the parent grid , and that the passage through the more highly resolved subgrid has allowed the clump core to relax to a more sharply peaked density profile , increasing the force mismatch .",
    "the main features of this behavior are quite generic : a more carefully constructed clump with a larger number of particles that was allowed to settle into a numerical equilibrium before being launched through the subgrid underwent similar , if slightly milder , accelerations and rebounds .",
    "clearly it is better for us to suppress the buffer region where there is no adjacent subgrid .",
    "the violation of momentum conservation that a finite border region implies can have a drastic influence on the orbit of a bound clump .",
    "this would not be much of a concern if we could guarantee that bound clumps are always entirely covered by subgrids at the same resolution ; the problem does not arise for smooth distributions of matter where short - range forces do nt predominate .",
    "( in section  [ s : gunn - gott - test ] we demonstrate this fact through a test of smooth infall onto a localized seed mass perturbation . ) in principle , an adaptive algorithm for subgrid placement based on the density should tend to ensure this .",
    "however , one may want to place additional restrictions on which regions are followed at higher resolution , in which case the guarantee does not hold and we must take the precaution of suppressing the buffer region in the absence of an adjacent subgrid . note that the problem is less severe when expanding coordinates are used , as in cosmological applications , since the peculiar velocity acquired while crossing a subgrid interface will be damped away .",
    "why has this same difficulty not been recognized by other authors , notably anc and splinter ( 1996 ) ?",
    "the reason may be traced to a fundamental difference in philosophy between our code and theirs .",
    "the very idea of a particle on a subgrid interacting symmetrically with a particle on the parent grid is a consequence of our decision to regard the particles , rather than the density field on the grids , as primary . in a scheme where every particle is associated with only one grid , and",
    "particularly when the dynamics of the parent grid particles are unaffected by the subgrid ( the so - called `` one - way interface '' schemes ) , momentum conservation should be examined separately on each grid : on the parent grid , no violation is expected , while on the subgrid the effects of the parent grid particles are treated as an external field and the buffer and transition regions are used to smoothly bring any particles exiting the subgrid under the control of the parent grid field alone , as test particles , rather than reflecting them back into the subgrid . thus , the apparent contradiction between these authors use of a buffer region two cells wide and our restriction of the buffer region to the sole case of adjacent subgrids does not signal an error either on our part or on theirs , but is merely a manifestation of our different view of the respective roles of particles and grids .",
    "a distinguishing feature of our code is that the activation of subgrids is entirely automated : the user need only set a few parameters ( maximum depth , and various optional thresholds ) , after which the code decides at every step where to place subgrids .",
    "tuning the criteria for subgrid placement is not an easy task ; our current choices can undoubtedly be improved upon .",
    "here we shall describe some of the criteria we have implemented .",
    "not all of them have proved very useful in practice .",
    "our subgrids have fixed shape and size , and may not overlap .",
    "consequently , we found it simplest to introduce a uniform tiling of subgrids covering the entire volume of the parent grid",
    ". each subgrid may be either active or inactive .",
    "a subgrid is activated whenever our requirements for subgridding are satisfied within its volume .",
    "we are free to choose the origin of the tiling independently for every parent grid at every step .",
    "we make use of this freedom to reduce the number of active subgrids .",
    "typically we try eight different possible origins , and adopt one that requires the activation of fewest subgrids .",
    "the first criterion for subgrid activation is that the particle number density be sufficiently high in at least part of the covered region : there is no point in the grid ever being much finer than the smallest distance between particles . to activate a subgrid",
    ", we require that among the corresponding cells of the parent grid either ( a ) at least one cell contains more than @xmath94 particles ; or ( b ) one cell contains at least @xmath95 particles and its 26 immediate neighbors together contain a further @xmath96 particles or more .",
    "@xmath94 , @xmath95 and @xmath97 are specified as input parameters to the code .",
    "the main reason for considering cubes of @xmath98 cells as well as single cells is that one needs to detect the collapse of a high - density region before it is too advanced : the additional resolution is already required during the later stages of collapse .",
    "we do nt try to detect larger , lower - contrast potentially collapsing structures on larger scales since for separations larger than about three cells the forces are computed accurately on the parent grid .    one way of choosing @xmath95 and @xmath97 is the following .",
    "let @xmath99 be a measure of the mean number of particles per cell in some larger region , such as the entire candidate subgrid .",
    "( this measure need not be unbiased ; in fact , if the mean particle number density is very low we found it necessary to artificially increase @xmath99 by setting it to the value 1 .",
    "otherwise our subgrid placement criterion would be satisfied far too easily in low - density regions . )",
    "if the particle counts were distributed according to poisson statistics , one would expect a group of @xmath100 cells to contain on average @xmath101 particles , with a standard deviation @xmath102 around that mean . by setting @xmath103 and @xmath104 , where @xmath105 is a tunable parameter",
    ", we try to ensure that only particularly significant deviations from homogeneity trigger subgrid activation .",
    "we have found that this approach works reasonably well during the early stages of nonlinear evolution , where it causes higher resolution to be applied to the regions we are most interested in .",
    "however , as the simulation progresses we have needed to increase @xmath105 in order to limit the proliferation of subgrids , as our goal was merely to achieve high resolution in a few large peaks near the center of the computational box . clearly the criteria can and",
    "should be tuned according to the needs of individual applications ; no single choice is optimal for all cases .",
    "we follow the usual practice in pm codes of advancing the positions and velocities of the particles in leapfrog fashion : @xmath106 an alternative formula applies on a starting step , when both the positions and the velocities are known at the same time @xmath107 : @xmath108 likewise , one can synchronize positions and velocities at the final step by advancing the velocities from @xmath109 to @xmath110 then updating the positions as @xmath111    in large simulations , it is particularly important to avoid taking more time steps than required to obtain accurate results .",
    "the time step should therefore be allowed to vary . in the standard leapfrog formulation ,",
    "the cancellation of second - order terms in equation  ( [ q : lf - v ] ) depends on @xmath112 being evaluated at the midpoint of the velocity step .",
    "the cancellation of the second - order term in the formula to update the positions is less important since the @xmath113 are known ; however , it contributes to lowering the operation count for the method .",
    "various approaches can be used to change the time step in the middle of a simulation .",
    "one is to use a different midpoint in equation  ( [ q : lf - v ] ) and calculate the corresponding @xmath114 . the other , which is the one we adopted , is to keep @xmath115 constant by an appropriate choice of the function @xmath40 .",
    "we construct this function and its first and second derivatives , which are needed to evaluate @xmath112 and @xmath84 according to equations ( [ q : a ] ) and  ( [ q : b ] ) , step by step as the simulation progresses .",
    "( in practice , we do not allow @xmath116 to vary too quickly , since that tends to spoil the results .",
    "we shrink @xmath117 by at most 25% on each step , and let it grow even more slowly .",
    "situations in which this forces a larger @xmath117 than desired have fortunately been very rare in our runs . )",
    "our preferred criterion for determining the time step is the courant condition : @xmath118 where the index @xmath9 spans the set of all particles , @xmath119 is the grid spacing of the finest grid used to compute the forces on particle @xmath9 , and @xmath120 is a constant coefficient . @xmath121 should be taken as being the mean velocity over the time step , and is a function of both the velocity before the step is taken and of the acceleration .",
    "the latter can be important if the initial velocity is uncharacteristically small , for example when all the particles are initially at rest .",
    "the equation for the maximum acceptable @xmath117 for each particle is actually a quartic .",
    "we do not solve it exactly , preferring to estimate a close lower bound on the solution for the particles with the tightest @xmath117 constraints .",
    "this way of taking the accelerations into account fulfills the same function as other authors use of the maximum density on a subgrid to estimate a local dynamical time .    in some cosmological simulations with a large number of particles , we found that adopting the smallest @xmath117 found in this fashion was leading to time steps much shorter than warranted by our physical understanding of the dynamical time scales involved ( based on the maximum density ) .",
    "this turned out to be due to a small number of high velocity particles : the tail of the velocity distribution produced by the violent relaxation of a newly collapsed object , which is naturally better sampled as the number of particles in the simulation increases . since these particles represent a small fraction of the mass in the typically high - density regions in which they are found , their motion has almost no impact on the mean gravitational field , which evolves on much longer time scales .",
    "this led us to modify the time step criterion for these simulations by pretending that the velocity of each particle before the time step is negligible and basing the choice of @xmath117 solely on the accelerations .",
    "this is not unreasonable for cosmological applications since in the linear regime the velocities and peculiar accelerations are related and in virialized clumps they are a better indication of the dynamical time scale than the velocity of the fastest particle ( which is not the same as the local velocity dispersion ) .",
    "moreover , expanding coordinates have the property that peculiar velocities are damped away and need to be continually regenerated by the forces . as a further precaution",
    ", we have analyzed the velocities of the particles at a late stage in a simulation run with this relaxed time step criterion and found , as intended , that the number of particles that violated the stricter courant condition was small .",
    "the relaxed criterion is known to fail , however , for highly ordered collapse ( such as that of a homogeneous sphere ) . in that case",
    "the largest acceleration does not provide a good estimate of the time scale over which the mean field evolves : based as it is on the more extended distribution at the beginning of the step , it systematically overestimates the maximum allowable time increment .",
    "accordingly , we only resort to the relaxed criterion , with some reluctance , for runs in expanding coordinates , with large numbers of particles , and where different mass shells collapse at different times .",
    "our tests on smaller cosmological runs have shown the results to be substantially identical , but with the relaxed condition requiring a much smaller number of steps .",
    "we use a single value of @xmath117 for all particles on all subgrids at any given step . a far better approach in principle , but much more complicated to implement , would be to adopt multiple time steps and to distinguish between the time steps used for advancing individual particles and those for updating the potentials on subgrids .",
    "independent time steps for the particles would require a way of estimating the accelerations at positions and times slightly different from those for which the potential has been calculated . for this , it may be necessary to calculate the time derivative of the subgrid potential as well as the potential itself .",
    "in addition to the constraints resulting from the rate of change of the subgrid density , the frequency with which the subgrid potential is recalculated can also be affected by particles flowing out of the region in which forces can be interpolated from the subgrid potential : in our scheme , such events change the mapping between particles and subgrids and require recalculation of all the subgrid potentials involved if the total momentum is to be conserved .",
    "these are our main reasons for adopting a single time step for all grids .",
    "the other main reason is that a single time step allows us to process subgrids one by one , accumulating the force contributions on each particle without needing to store the solutions for the potential on many nested subgrids simultaneously .",
    "almost any other time step scheme requires these subgrid potentials to be available simultaneously .",
    "the coefficients in the leapfrog formulae ( equations  [ q : lf - v ] and  [ q : lf - x ] ) can depend on time . for good accuracy , their variation in a time step",
    "must be small .",
    "this constraint is clearly unrelated to the grid spacing , and must be imposed separately .",
    "it is equivalent to the requirement that @xmath122 .",
    "conservation laws provide an important diagnostic of how accurately the equations of motion have been integrated in a given simulation .",
    "good conservation of physical invariants is not a sufficient condition for a good integration , but it is a necessary one .    in the absence of coordinate expansion , subgrids , and external fields , a pm code such as ours would be expected to conserve total momentum algebraically , energy a little less well , and angular momentum only in the limit where the interparticle separation is much larger than the grid spacing ( he  76 ) .",
    "cosmic expansion causes the usual equation of conservation of the total energy , @xmath123 ( where @xmath124 is the kinetic , @xmath125 the potential energy ) , to be replaced with the layzer - irvine ( @xcite ; @xcite ) equation , which can be derived from the well - known property of the hamiltonian @xmath126 : @xmath127 computing the canonical momentum from equation  [ q : lag - x ] , @xmath128 it follows in the usual way that @xmath129 we define the kinetic and potential energies as : @xmath130 then @xmath131 our exclusion of the external potential @xmath19 from the definition of  @xmath125 is somewhat arbitrary . in practice , one wants to separate the terms associated with the mutual interactions of particles , which do measure the accuracy of the integrator , from the correction terms that merely account for known , external sources and sinks of energy .    in applying equation  [ q : dham - dt - law ] ,",
    "one notes that in @xmath132 the last term does not vanish if @xmath133 depends explicitly on time ( as may occur in practice when a new subgrid is activated and the force resolution increases locally ) , or if @xmath134 is not constant . for simplicity , we shall assume @xmath135 from now on , since that is the only case of actual practical interest to us .",
    "straightforward algebra leads to the two equations : @xmath136 @xmath137 which although physically equivalent are evaluated numerically in slightly different ways when @xmath24 is not constant .",
    "the corresponding conserved quantities are : @xmath138 @xmath139    in proper - length coordinates ( @xmath140 ) , the first integral term ( @xmath141 or @xmath142 ) vanishes and both criteria reduce to the usual law of conservation of energy .",
    "the last two terms represent respectively the work done by external fields and time dependence in the interaction law .",
    "one may question the appropriateness of including the latter effect , since its origin lies in the numerical method used rather than in the underlying physics",
    ". should nt contributions from the @xmath143 term be counted as violations of energy conservation by the code ?",
    "in reply we point out that much of that term may result from fluctuations in the zero level of the gravitational potential on subgrids , which we did not attempt to suppress since they have no bearing on the computed forces . and in any case the @xmath143 contribution",
    "should be evaluated so that its magnitude relative to the other terms may be assessed .",
    "it is unrealistic to expect a pm code to conserve @xmath70 and @xmath144 arbitrarily well when gravitational instability causes the individual terms ( @xmath125 , @xmath145 ) to grow by orders of magnitude . like",
    "many other authors before us , we deem @xmath70 and @xmath144 adequately conserved if their variation is a small fraction ( typically 13% ) of the change in @xmath125 or @xmath146 , respectively .    in our definition of @xmath125 ( equation  [ q : w ] ) we excluded the self - energy terms @xmath147 .",
    "but the natural way of calculating the potential in a pm code effectively includes these terms ( the restriction @xmath148 can be ignored since the scheme avoids self - forces ) ; we subtract them explicitly as part of our energy conservation test .",
    "we adopted a momentum - conserving scheme for calculating the forces .",
    "the total momentum should therefore be unaffected by particle - particle interactions on any given grid , and ( given the precautions we have taken in our handling of the buffer region surrounding each subgrid ) be only weakly modified by interactions across the boundary between adjacent subgrids .",
    "however , it is still affected by all other interactions between particles and external fields , including the constant - density background outside the computational box .",
    "( this field gives rise to forces only when isolated boundary conditions are used , which is the reason why it is nt normally discussed in the literature . )    the canonical momentum @xmath149 of particle  @xmath8 satisfies @xmath150 summation over all particles and time integration yield a conserved quantity @xmath151 in the special case when ( i ) @xmath19 has no spatial dependence , ( ii ) @xmath152 or @xmath153 , and ( iii ) @xmath154 , the total momentum is constant . if one s aim is to measure the deviation of the results from those expected when @xmath154 ( such a deviation can occur in the presence of subgrids ) , one should naturally omit the corresponding term from equation  [ q : pc ] .",
    "likewise , the conservation of angular momentum @xmath155 amounts to the constancy of @xmath156 angular momentum is only conserved if ( i ) @xmath157 and ( ii ) @xmath19 is a function of @xmath158 and  @xmath12 alone .",
    "the exact coulomb force law satisfies the first condition , but grid - based approximations to it do nt . as in the analogous case for the momentum ,",
    "if the aim is to measure deviations from the ideal behavior where ( i ) is satisfied , then one should compare the magnitude of the corresponding term to @xmath159 itself , and to the magnitude of the external torque term when present .",
    "our first tests are meant to see how accurately the code calculates the accelerations of particles given a known mass configuration .",
    "the simplest case is that of the forces due to a single point mass , which can be compared to the value predicted by coulomb s law .",
    "figure  [ f : tf1b.dff ] illustrates this comparison .",
    "it shows the accelerations induced by a single particle at the center of a @xmath160 grid with isolated boundary conditions .",
    "a single @xmath160 subgrid , twice as fine as the top grid , was centered on the massive particle .",
    "two sets of points are readily distinguished , corresponding to test particles inside and outside the subgrid .",
    "as expected , the acceleration is systematically underestimated since the effective potential is softer than that of a point mass . also as expected , the subgrid extends the range over which the force is accurate to within a few percent ; the accuracy threshold ( a little over 3% in this test ) could be lowered by increasing the size of the subgrid , the spacing being equal .",
    "our second test checks that the accelerations computed on a set of adjacent subgrids agree with those one would obtain on a single , larger grid with the same spacing as the subgrids .",
    "we compare forces on individual particles randomly chosen to sample a uniform distribution .",
    "the long - range forces , which are adequately resolved on the parent grid , tend to cancel , so that the system is dominated by short - range interactions that will be most affected by the grid refinement .",
    "our reference forces are from a non - subgridded run with @xmath161 cells and @xmath161 particles .",
    "we compare these to those obtained from three different runs with only @xmath162 cells on the parent grid , in which all possible first - level subgrids are activated .",
    "the only difference between the three runs is in the width of the buffer region where adjacent subgrids overlap .",
    "the results are illustrated in figure  [ f : df ] .",
    "the magnitude of the force difference is plotted against that of the reference force for a randomly selected 1% of the particles ( to avoid overcrowding the plot ) .",
    "panels ( a ) , ( b ) , and ( c ) correspond respectively to a buffer width of 0 , 1 , and 2 parent grid cells .",
    "the solid diagonal line represents @xmath163 ; the last panel also contains a dotted line where @xmath164 .",
    "the results show that when the buffer is sufficiently wide ( at least two cells ; we like to use three cells in production runs with larger grids ) , the forces computed by the subgrid method are mostly within 1% of the forces from a single grid of equivalent resolution .",
    "whenever the buffer region is suppressed , an appreciable fraction of the particles exhibits force errors larger than 10% .",
    "here it is essential to understand what we mean by `` errors '' .",
    "figure  [ f : df ] only compares the forces computed using a set of abutting subgrids of equal resolution with those from a single , larger grid with the same spacing , and shows that some overlap is both required and sufficient to avoid loss of resolution at the boundary between such abutting subgrids .",
    "it does _ not _ compare forces computed at different grid spacings , and does not address the issue of convergence to a `` perfect '' solution in the limit of an infinitely fine grid .",
    "we know that at the interface between a subgrid and a coarser parent grid the accuracy of the forces within the outer two or three cell layers of the subgrid will be less than that of a uniform fine grid regardless of the thickness of the buffer region .",
    "( it will , however , be no worse than on the parent grid alone . )",
    "we compensate for this by making the subgrids cover a slightly larger volume than the region where the higher resolution is required .",
    "the collapse of a homogeneous self - gravitating pressure - less ellipsoid initially at rest can be described by a small set of coupled ordinary differential equations for the lengths of the principal axes , which can be integrated in a straightforward way ( @xcite ) .",
    "this solution provides a convenient test of our code .",
    "the test corresponds to that of collapse to a sheet or filament in a cosmological code with periodic boundary conditions , but is more appropriate to our use of isolated boundary conditions . in particular , the plane - wave test of efstathiou et al .",
    "( 1985 ) is only easy to interpret and compare with a semi - analytic solution when periodic boundary conditions are used , and these lie outside the scope of the present article .",
    "another test , in section  [ s : voidtest ] below , shows the behavior of our code when integrating the collapse of a moving sheetlike ridge in the presence of cosmological expansion .",
    "we followed the collapse of a homogeneous ellipsoid with a @xmath165 ratio between the lengths of the principal axes .",
    "the experiment was repeated for two different choices of the grid spacing in order to verify convergence towards the correct solution . for the higher resolution , we performed two runs , one using a single grid of @xmath166 cells and one with a top - level grid of only @xmath160 cells but up to two levels of subgrids .",
    "each subgrid also has only @xmath160 cells ; when necessary , multiple adjacent subgrids were automatically generated by the code to cover the entire ellipsoid .",
    "the number of particles is the same in all three runs , about @xmath167 .",
    "figure  [ f : ts7-overview ] shows the short axis @xmath168 of the ellipsoid as a function of time @xmath12 .",
    "the solid curve represents the analytic solution , the dot - dash curve the solution computed on the coarse grid , while the remaining two dashed curves show the results of the two high - resolution runs .",
    "the horizontal dotted line corresponds to the grid spacing in the high resolution runs ; that of the low resolution grid is four times larger .",
    "figure  [ f : ts7-blowup ] presents a blown - up view of the same results around the time of collapse of the ellipsoid to a spindle .",
    "one sees from these figures that increasing the resolution does indeed yield a better agreement between the @xmath1-body and analytic solutions .",
    "furthermore , the results with subgridding are nearly identical to those obtained with a single grid of equivalent resolution . in the high - resolution runs ,",
    "the minimum radius of the spindle is comparable to the grid spacing . at the lower resolution ,",
    "it is significantly less than the grid spacing .",
    "we did not investigate the reasons for this in detail , but it is likely that the convergence is also affected by the number of particles used to represent the ellipsoid . in these tests",
    "we have kept this number constant .",
    "the two runs without subgrids also used a small , constant value of the time step @xmath169 .",
    "collapse occurs after 1524 and 1644 steps respectively .",
    "the subgridded run , by contrast , used the courant condition to adjust the time step ; only 125 steps were required to reach the point of collapse .",
    "the good agreement between the high - resolution results obtained with both choices of time step confirms the validity of our implementation of adaptive time steps .",
    "we have also repeated the low - resolution run using our adaptive time step scheme ; on figure  [ f : ts7-blowup ] the results would be indistinguishable from those obtained with a fixed time step .",
    "an interesting test of the behavior of mass flows into a subgrid is the case of accretion from a uniform - density background onto a point mass ( or any other compact , spherically symmetric density profile )",
    ". a regular lattice of @xmath161 particles with zero initial peculiar velocity was laid down in a computational box of unit side to be evolved with isolated boundary conditions in an @xmath170 , @xmath171 cosmological model .",
    "we added at the center of the box a single particle of mass @xmath172 , where @xmath173 is the mean density of the other particles and of the external background , @xmath174 , and @xmath175 .",
    "we followed the collapse to a time @xmath176 , corresponding to an expansion factor @xmath177 .",
    "a scaling solution is available ( @xcite ; @xcite ; @xcite ; @xcite ) : @xmath178 .",
    "this simple law is expected to hold only for those shells that enclose a mass much larger than that of the initial seed and that have evolved for a few crossing times after their initial turnaround .",
    "the crossing time for a shell is of the same order as its turnaround time , and its proper radius is a factor @xmath179 times the turnaround radius . using a linear theory approximation ( in which the density perturbation grows in place ) until the turnaround at a mean enclosed overdensity @xmath180",
    ", we find that for a given initial enclosed overdensity @xmath181 the turnaround occurs at @xmath182 , the subsequent virialization at @xmath183 , and the final comoving radius of the shell is @xmath184 , where @xmath185 is the initial comoving radius . requiring @xmath186 , only shells with @xmath187 are expected to show self - similar behavior , and then only for @xmath188 .",
    "one can also evaluate bertschinger s ( 1985 ) equation  ( 2.7 ) with @xmath189 , @xmath190 , @xmath191 ( these values lead to @xmath192 ) and make direct use of his numerically determined similarity solution .",
    "a twist of our simulations is that shells with @xmath193 are prevented from falling in by the fact that they are not entirely included within the simulation volume .",
    "accordingly , the accretion will be starved for @xmath194 , and the last complete shell should virialize at @xmath195 .",
    "our main reason for performing this test was to compare the solutions obtained with various treatments of the border region around a subgrid .",
    "we performed four runs : one with a uniform @xmath196 grid , the other three with a @xmath160 grid and a nested @xmath160 subgrid with a linear refinement factor of 2 .",
    "( after subtracting edge cells as discussed in   [ s : bc ] , the computational box was covered respectively by @xmath161 and @xmath162 cells . ) in one run the border region was suppressed , as suggested by our tests with a bound clump crossing the boundary , while the other two both used a border width of two parent grid cells , once with the particles in the border region contributing to the subgrid potential without feeling its effects and once with the border particles being subjected to the subgrid potential without contributing to it . in the last two cases , the net effect of the force asymmetries on overdense regions results in an acceleration pointing respectively away from the subgrid and towards it .",
    "figure  [ f : tf6d - rho ] shows the logarithmic density profiles for the runs we just described .",
    "the differences between the results of all these runs are minute ; we find it difficult to ascribe any significance to such small deviations .",
    "this is reassuring : it suggests that the exact way in which subgrid borders are treated does not unduly affect the profiles of collapsed peaks .",
    "the dotted line connects open triangles that correspond to the values given by bertschinger ( 1985 ) in his table  4 . at small radii",
    ", his solution tends towards the expected @xmath197 , and ours is in good agreement with his .",
    "the first few caustics can easily be identified .",
    "peebles ( 1987 ; see also @xcite , hereafter pmhj ) has proposed and used the following test for cosmological pm codes : integrating the evolution of a spherically symmetric under - dense region surrounding by a compensating over - dense shell .",
    "the interior of such a void expands faster than the universe as a whole , and in so doing compresses the surrounding shell , making its profile higher and narrower .",
    "the evolution can be computed analytically until the time at which the first density cusp appears . for peebles profile , @xmath198 with @xmath199 , this occurs at @xmath200 in a flat @xmath170 universe .",
    "( here @xmath201 is the initial value of the expansion factor @xmath68 . )",
    "we integrated such a void , realized with @xmath196 particles , on a @xmath160 grid and compared our results to the analytic prediction at @xmath202 .",
    "figure  [ f : ts6aa ] can be directly compared to the corresponding figure  4 of  pmhj .",
    "a significant difference between our code and theirs lies in their use of a staggered grid for the force ( @xcite ) .",
    "the staggered grid increases the spatial resolution twofold ( which is why these authors used it ) at the cost of inducing self - forces on the particles ( for which reason we did not follow their example ) . because of this difference , our results obtained with @xmath196 particles on a @xmath196 grid correspond to their results with the same number of particles on a @xmath160 grid .",
    "a comparison reveals differences of detail , particularly in the structure of the outer parts of the shell , but our results match the analytic solution as closely as theirs .",
    "we take this occasion to illustrate the energy conservation properties of the code .",
    "figure  [ f : ts6aa - econs ] shows the evolution with time of the conserved quantities @xmath70 and  @xmath144 of equations  [ q : c ] and  [ q : cprime ] ( top ) , as well as that of the ratio @xmath203 of the changes in @xmath70 and in the total potential energy @xmath125 from the start of the run ( bottom ) .",
    "apart from an initial transient due to rounding in the print - out from which the plot was made , an examination of the ratio shows the energy to be conserved to about 12% accuracy throughout the run .",
    "we have developed a useful and versatile tool for the simulation of collisionless systems of gravitating particles .",
    "our code is particularly suited to situations that call for both fine - grained mass resolution everywhere and high spatial resolution in selected regions of high density the exact locations of which need not be known in advance .",
    "our method is a development of the well - known particle - mesh technique .",
    "tests indicate that in comparable conditions our code performs substantially like similar codes described in the published literature . when subgrids are introduced to increase the spatial resolution locally , the results in the regions covered by the subgrids are in very good agreement with those of a conventional pm code with a single , finer grid .",
    "if the number of subgridded regions is sufficiently small , our approach requires less computing time and less memory than the equivalent single - grid approach .",
    "furthermore , by not increasing the resolution in regions where the particle number density is low , we avoid making the behavior of the code collisional , which would be undesirable for applications to collisionless systems .",
    "a significant advantage of pm ( and its variants p@xmath5 m , ap@xmath5 m , etc . ) for cosmological applications is that comoving coordinates and periodic boundary conditions can be supported in a natural way .",
    "however , periodic boundary conditions are not always a physically appropriate approximation .",
    "in particular , if one s interest is in systems not much smaller than the size of the computational cube , periodic boundary conditions introduce a much stronger coupling between the external tidal field and the internal dynamics of the system than one would expect to occur in the aperiodic real universe .",
    "periodic boundary conditions are only appropriate when the individual structures of interest are much smaller than the computational volume , in which case the tides due to periodic images are small ; but then the relatively small dynamic range of conventional pm methods severely limits the resolution that can be achieved . by introducing hierarchical subgrids , we are able to extend that dynamic range ; however , it is also tempting to construct the simulation in such a way that the system of interest fills as much of the computational box as possible .",
    "this is what led us to implement isolated boundary conditions . in principle",
    ", the additional cost of imposing isolated boundary conditions ( which is relatively small when hierarchical grids are used since isolated conditions have to be imposed on the subgrids in any case ) is offset by the greater freedom one has to apply an arbitrary time - dependent external tidal field and to adopt a system of expanding coordinates that matches the evolution of the simulated object without necessarily coinciding with the expansion of the global cosmological model .",
    "of course our method can also be used in a more conventional way , with periodic boundary conditions on the top grid ; in fact , numerous simplifications occur when this is done .",
    "in addition , our code should be well - suited to non - cosmological dynamical simulations , _",
    "e.g. _ , of brief interactions between already formed galaxies , star clusters , and so on .",
    "our approach also has a few limitations .",
    "the most important is shared by all particle simulation methods : it is generally impossible to improve the spatial resolution without a corresponding refinement of the time resolution : more time steps need to be taken . other difficulties of note are the non - radial nature of forces at small separations ( which could be cured , at some cost in computing time , by softening the interaction law and increasing the depth of subgridding to compensate for this softening ) , the complexity and difficulty of tuning the subgrid placement algorithm , and the fact that subgrids of fixed shape will almost inevitably also cover some regions where the particle number density is low .",
    "the behavior of the code can become collisional in such regions ; this should not affect the computed structure of high - density condensations , but may well be a source of high - velocity particles that lead to shorter time steps according to the courant condition .",
    "an enhancement to our current code could be to refrain from applying the refined forces to such low - density cells .",
    "alternatively , it could prove useful to introduce individual time - varying softening lengths associated with individual particles , to represent the fact that particles in this method are to be thought of as possessing a finite extent that depends on the local number density .",
    "another desirable improvement is the adoption of different time steps at different levels of grid refinement ; the savings that can be achieved from this depend on the detailed structure of the tree of subgrids , and will be greatest for deep trees with most of their branches at the finer resolution levels .",
    "this work was partially supported by grants nsf - ast-86 - 57647 , nsf - ast-91 - 19475 , and nasa - nagw-2224 .",
    "some calculations were conducted using the resources of the cornell theory center , which receives major funding from the u.s . national science foundation and the state of new york , with additional support from the advanced research projects agency , the national center for research resources at the national institutes of health , ibm corporation , and other members of the center s corporate partnership program .",
    "we thank adrian melott , richard james , and the referee randall splinter for interesting and valuable remarks on an earlier version of this paper ."
  ],
  "abstract_text": [
    "<S> this article describes a new , fully adaptive particle - multiple - mesh ( pm@xmath0 ) numerical simulation code developed primarily for cosmological applications . </S>",
    "<S> the code integrates the equations of motion of a set of particles subject to their mutual gravitational interaction and to an optional , arbitrary external field . </S>",
    "<S> the interactions between particles are computed using a hierarchy of nested grids constructed anew at each integration step to enhance the spatial resolution in high - density regions of interest . as the code is aimed at simulations of relatively small volumes of space ( not much larger than a single group of galaxies ) with independent control over the external tidal fields , </S>",
    "<S> significant effort has gone into supporting isolated boundary conditions at the top grid level . </S>",
    "<S> this makes our method also applicable to non - cosmological problems , at the cost of some complications which we discuss . </S>",
    "<S> we point out the implications of some differences between our approach and those of other authors of similar codes , in particular with respect to the handling of the interface between regions of different spatial resolution . </S>",
    "<S> we present a selection of tests performed to verify the correctness and performance of our implementation . </S>",
    "<S> the conclusion suggests possible further improvements in the areas of independent time steps and particle softening lengths . </S>"
  ]
}