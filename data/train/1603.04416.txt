{
  "article_text": [
    "conformal prediction is a method of generating prediction sets that are guaranteed to have a prespecified coverage probability ; in this sense conformal predictors have guaranteed validity .",
    "different conformal predictors , however , widely differ in their efficiency , by which we mean the narrowness , in some sense , of their prediction sets . empirical investigation of the efficiency of various conformal predictors is becoming a popular area of research : see , e.g. , @xcite ( and the copa proceedings , 20122016 ) .",
    "this paper points out that the standard criteria of efficiency used in literature have a serious disadvantage , and we define a class of criteria of efficiency , called `` probabilistic '' , that do not share this disadvantage .",
    "in two recent papers two probabilistic criteria have been introduced , and in this paper we introduce two more and argue that probabilistic criteria should be used in place of more standard ones .",
    "we concentrate on the case of classification only ( the label space is finite ) .",
    "surprisingly few criteria of efficiency have been used in literature , and even fewer have been studied theoretically .",
    "we can speak of the efficiency of individual predictions or of the overall efficiency of predictions on a test sequence ; the latter is usually ( in particular , in this paper ) defined by averaging the efficiency over the individual test examples , and so in this introductory section we only discuss the former .",
    "this section assumes that the reader knows the basic definitions of the theory of conformal prediction , but they will be given in section  [ sec : criteria ] ( and section  [ sec : label - conditional ] for the label - conditional version ) , which can be consulted now .    the two criteria for efficiency of a prediction that have been used most often in literature ( in , e.g. , the references given above ) are :    * the confidence and credibility of the prediction ( see , e.g. , @xcite , p.  96 ; introduced in @xcite ) .",
    "this criterion does not depend on the choice of a significance level  @xmath0 .",
    "* whether the prediction is a singleton ( the ideal case ) , multiple ( an inefficient prediction ) , or empty ( a superefficient prediction ) at a given significance level  @xmath0 .",
    "this criterion was introduced in @xcite , section  7.2 , and used extensively in @xcite .",
    "the other two criteria that had been used before the publication of the conference version @xcite of this paper are the sum of the p - values for all potential labels ( this does not depend on the significance level ) and the size of the prediction set at a given significance level : see the papers and @xcite .    in this paper",
    "we introduce six other criteria of efficiency : see section  [ sec : criteria ] .",
    "we then discuss ( in sections  [ sec : optimal][sec : not - probabilistic ] ) the conformity measures that optimise each of the ten criteria when the data - generating distribution is known ; this sheds light on the kind of behaviour implicitly encouraged by the criteria even in the realistic case where the data - generating distribution is unknown . as we point out in section  [ sec : not - probabilistic ] , probabilistic criteria of efficiency are conceptually similar to `` proper scoring rules '' in probability forecasting @xcite , and this is our main motivation for their detailed study in this paper . in section  [ sec : proofs ]",
    "we prove the results of section  [ sec : not - probabilistic ] .",
    "after that we briefly illustrate the empirical behaviour of two of the criteria for standard conformal predictors and a benchmark data set ( section  [ sec : empirical ] ) .",
    "sections  [ sec : criteria][sec : empirical ] discuss the most standard unconditional conformal predictors . section  [ sec : label - conditional ] defines label - conditional conformal predictors and discusses the analogues of the results of the previous sections for label - conditional predictors .",
    "finally , section  [ sec : conclusion ] gives some directions of further research .",
    "a version ( with a different treatment of empty observations ) of one of the new non - probabilistic criteria of efficiency that we discuss in this paper ( the one that we call the e criterion ) has been introduced independently in @xcite .",
    "we only consider the case of randomised ( `` smoothed '' ) conformal predictors : the case of deterministic predictors may lead to combinatorial problems without an explicit [ p : combinatorial-1]solution ( this is the case , e.g. , for the n criterion defined below ) .",
    "the situation here is analogous to the neyman ",
    "pearson lemma : cf .",
    "@xcite , section  3.2 .",
    "let @xmath1 be a measurable space ( the _ object space _ ) and @xmath2 be a finite set equipped with the discrete @xmath3-algebra ( the _ label space _ ) ; the _ example space _ is defined to be @xmath4 .",
    "we will always assume that the label space @xmath2 is non - empty , and will usually assume that its size is at least  2 .",
    "conformity measure _ is a measurable function @xmath5 that assigns to every finite sequence @xmath6 of examples a same - length sequence @xmath7 of real numbers and that is equivariant with respect to permutations : for any @xmath8 and any permutation @xmath9 of @xmath10 , @xmath11 the _ conformal predictor _ determined by @xmath5 is defined by @xmath12 where @xmath13 is a training sequence , @xmath14 is a test object , @xmath15 is a given _ significance level _",
    ", for each @xmath16 the corresponding _ p - value _ @xmath17 is defined by @xmath18 @xmath19 is a random number distributed uniformly on the interval @xmath20 $ ] ( even conditionally on all the examples ) , and the corresponding sequence of _ conformity scores _ is defined by @xmath21 notice that the system of _ prediction sets _ output by a conformal predictor is decreasing in @xmath0 , or _",
    "nested_.    the _ conformal transducer _ determined by @xmath5 outputs the system of p - values @xmath22 defined by for each training sequence @xmath23 of examples and each test object @xmath14 .",
    "( this is just a different representation of the conformal predictor . )",
    "notice that the p - values ( and , therefore , the corresponding conformal predictors and transducers ) only depend on the _ conformity order _ corresponding to the given conformity measure : namely , on the way that the elements of a sequence @xmath24 are ordered by the values @xmath7 ( with @xmath25 defined to be @xmath26 ) .",
    "therefore , to define conformal predictors and transducers we may define their conformity orders rather than conformity measures .",
    "the standard property of validity for conformal transducers is that the p - values @xmath17 are distributed uniformly on @xmath20 $ ] when the examples @xmath27 are generated independently from the same probability distribution @xmath28 on @xmath29 and @xmath19 is generated independently from the uniform probability distribution on @xmath20 $ ] ( see , e.g. , @xcite , proposition  2.8 ) .",
    "this implies that the probability of error , @xmath30 , for conformal predictors is @xmath0 at any significance level  @xmath0 .",
    "suppose we are given a test sequence @xmath31 and would like to use it to measure the efficiency of the predictions derived from the training sequence @xmath23 .",
    "( informally , by the efficiency of conformal predictors we mean that the prediction sets they output tend to be small , and by the efficiency of conformal transducers we mean that the p - values they output tend to be small . ) for each test example @xmath32 , @xmath33 , we have a nested family @xmath34 of subsets of @xmath2 , where @xmath35 and a system of p - values @xmath36 , where @xmath37 in this paper we will discuss ten criteria of efficiency for such a family or a system , but some of them will depend , additionally , on the observed label @xmath38 of the test example .",
    "we start from the _ prior _ criteria , which do not depend on the observed test labels .",
    "we will discuss two kinds of criteria : those applicable to the prediction sets @xmath39 and so depending on the significance level @xmath0 and those applicable to systems of p - values @xmath40 and so independent of @xmath0 .",
    "the simplest criteria of efficiency are :    * the _ s criterion _",
    "( with `` s '' standing for `` sum '' ) measures efficiency by the average sum @xmath41 of the p - values ; small values are preferable for this criterion .",
    "it is @xmath0-free .",
    "* the _ n criterion _ uses the average size @xmath42 of the prediction sets ( `` n '' stands for `` number '' : the size of a prediction set is the number of labels in it ) .",
    "small values are preferable . under this criterion",
    "the efficiency is a function of the significance level @xmath0 .",
    "both these criteria are prior .",
    "the s criterion was introduced in and the n criterion was introduced independently in @xcite and , although the analogue of the n criterion for regression ( where the size of a prediction set is defined to be its lebesgue measure ) had been used earlier in @xcite ( whose arxiv version was published in 2012 ) .",
    "a disadvantage of the basic criteria is that they look too stringent .",
    "even for a very efficient conformal transducer , we can not expect all p - values @xmath17 to be small : the p - value corresponding to the true label will not be small with high probability ; and even for a very efficient conformal predictor we can not expect the size of its prediction set to be zero : with high probability it will contain the true label . the other prior criteria are less stringent .",
    "the ones that do not depend on the significance level are :    * the _ u criterion _",
    "( with `` u '' standing for `` unconfidence '' ) uses the average unconfidence @xmath43 over the test sequence , where the _ unconfidence _ for a test object @xmath44 is the second largest p - value @xmath45 ; small values of are preferable .",
    "the u criterion in this form was introduced in , but it is equivalent to using the average confidence ( one minus unconfidence ) , which is very common . if two conformal transducers have the same average unconfidence , the criterion compares the average credibilities @xmath46 where the _ credibility _ for a test object @xmath44 is the largest p - value @xmath47 ; smaller values of are preferable .",
    "( intuitively , a small credibility is a warning that the test object is unusual , and since such a warning presents useful information and the probability of a warning is guaranteed to be small , we want to be warned as often as possible . ) * the _ f criterion _ uses the average fuzziness @xmath48 where the _ fuzziness _ for a test object @xmath44 is defined as the sum of all p - values apart from a largest one , i.e. , as @xmath49 ; smaller values of are preferable . if two conformal transducers lead to the same average fuzziness , the criterion compares the average credibilities , with smaller values preferable .",
    "their counterparts depending on the significance level are :    * the _ m criterion _ uses the percentage of objects @xmath44 in the test sequence for which the prediction set @xmath39 at significance level @xmath0 is _ multiple _ , i.e. , contains more than one label .",
    "smaller values are preferable . as a formula , the criterion prefers smaller @xmath50 where @xmath51 denotes the indicator function of the event @xmath52 ( taking value 1 if @xmath52 happens and 0 if not ) .",
    "when the percentage of multiple predictions is the same for two conformal predictors ( which is a common situation : the percentage can well be zero when the data is clean and @xmath0 is not too demanding ) , the m criterion compares the percentages @xmath53 of empty predictions ( larger values are preferable ) .",
    "this is a widely used criterion ; in particular , it was used in @xcite and papers preceding it . *",
    "the _ e criterion _",
    "( where `` e '' stands for `` excess '' ) uses the average ( over the test sequence , as usual ) amount the size of the prediction set exceeds 1 . in other words ,",
    "the criterion gives the average number of excess labels in the prediction sets as compared with the ideal situation of one - element prediction sets .",
    "smaller values are preferable for this criterion . as a formula",
    ", the criterion prefers smaller @xmath54 where @xmath55 .",
    "when these averages coincide for two conformal predictors , we compare the percentages of empty predictions ; larger values are preferable .",
    "a criterion that is very similar to the m and e criteria is used by lei in @xcite ( section  2.2 ) ; that paper considers the binary case , in which the difference between the m and e criteria disappears .",
    "the difference of the criterion used in @xcite is that it prohibits empty predictions ( an intermediate approach would be to prefer smaller values for the number of empty predictions ) .",
    "lei s criterion is extended to the multi - class case in @xcite , which proposes a modification of the e criterion with a different treatment of empty predictions .",
    "the prior criteria discussed in the previous subsection treat the largest p - value , or prediction sets of size 1 , in a special way .",
    "the corresponding criteria of this subsection attempt to achieve the same goal by using the observed label .",
    "these are the observed counterparts of the non - basic prior @xmath0-free criteria :    * the _ ou _ ( `` observed unconfidence '' ) _ criterion _ uses the average observed unconfidence @xmath56 over the test sequence , where the _ observed unconfidence _ for a test example @xmath57 is the largest p - value @xmath58 for the _ false labels _ @xmath59 .",
    "smaller values are preferable for this test .",
    "* the _ of _ ( `` observed fuzziness '' ) _ criterion _ uses the average sum of the p - values for the false labels , i.e. , @xmath60 smaller values are preferable .",
    "the counterparts of the last group depending on the significance level @xmath0 are :    * the _ om criterion _ uses the percentage of observed multiple predictions @xmath61 in the test sequence , where an _ observed multiple _",
    "prediction is defined to be a prediction set including a false label .",
    "smaller values are preferable . *",
    "the _ oe criterion _",
    "( oe standing for `` observed excess '' ) uses the average number @xmath62 of false labels included in the prediction sets at significance level @xmath0 ; smaller values are preferable .",
    "the ten criteria used in this paper are given in table  [ tab : criteria ] .",
    "half of the criteria depend on the significance level @xmath0 , and the other half are the respective @xmath0-free versions .",
    ".the ten criteria studied in this paper : the two basic ones in the upper section ; the four other prior ones in the middle section ; and the four observed ones in the lower section [ cols=\"^,^\",options=\"header \" , ]     theorems  [ thm : sp][thm : msp ] show that the six criteria that are not set in italics in table  [ tab : criteria ] are not probabilistic ( however , we will see in corollary  [ cor : binary - probabilistic ] below that they are bw probabilistic ) .",
    "these are simple explicit examples ( inevitably involving label spaces @xmath2 with @xmath63 ) showing that they are not even weakly probabilistic :    * let @xmath64 , @xmath65 , and @xmath66 ( remember that , in this paper , @xmath67 always means @xmath68 . ) in this case , all refinements of the cp idealised conformity measure are equivalent .",
    "the u criterion is not probabilistic since the expression @xmath69 ( cf .  )",
    "is @xmath70 for the cp idealised conformity measure and is smaller , @xmath71 , for the sp idealised conformity measure .",
    "the m criterion is not probabilistic since at significance level @xmath72 the cp idealised conformity measure gives the predictor @xmath73 ( a.s . ) , and so @xmath74 ( cf .  ) .",
    "* let @xmath75 , @xmath65 , and , for a small @xmath76 , @xmath77 the cp idealised conformity measure again has only equivalent refinements .",
    "the f criterion is not probabilistic since the expression @xmath78 ( cf .  )",
    "is @xmath79 for the cp idealised conformity measure and is smaller ( provided @xmath80 is sufficiently small ) , @xmath81 , for the mcp idealised conformity measure ( which is unique ) .",
    "the e criterion is not probabilistic since at significance level @xmath82 the cp idealised conformity measure has a larger expected excess ( for small @xmath80 ) than the mcp idealised conformity measure ( whose expected excess is zero ) : @xmath83 ( cf .  ) .",
    "* let us again set @xmath64 and @xmath65 , and define @xmath28 by .",
    "the ou criterion is not probabilistic since the expression @xmath84 ( cf .  )",
    "is @xmath85 for the cp idealised conformity measure and is smaller , @xmath86 , for the msp idealised conformity measure .",
    "the om criterion is not probabilistic since at significance level @xmath72 the cp idealised conformity measure gives the predictor @xmath73 ( a.s . ) , and so @xmath87 ( cf .  ) .",
    "[ cor : binary - probabilistic ] all ten criteria of efficiency in table  [ tab : criteria ] are bw probabilistic .",
    "criteria s , n , of , and oe are bw probabilistic by theorem  [ thm : cp ]",
    ". criteria ou and om are identical to of and oe , respectively , in the binary case , and so are also bw probabilistic .",
    "criteria f and e are identical to u and m , respectively , in the binary case , and so our task reduces to proving that u and m are bw probabilistic . by theorem",
    "[ thm : sp ] , it suffices to check @xmath88 , which is obvious : sp is in both @xmath89 and @xmath90 when @xmath91 .",
    "criteria of efficiency that are not probabilistic are somewhat analogous to `` improper scoring rules '' in probability forecasting ( see , e.g. , @xcite and @xcite ) .",
    "the optimal idealised conformity measures for the criteria of efficiency given in this paper that are not probabilistic have clear disadvantages , such as :    * they depend on the arbitrary choice of a choice function . in many cases",
    "there is a unique choice function , but the possibility of non - uniqueness is still awkward . *",
    "they encourage `` strategic behaviour '' ( such as ignoring the differences , which may be very substantial , between potential labels other than @xmath92 for a test object @xmath14 when using the m criterion in the case @xmath63 ) .",
    "however , we do not use the terminology `` proper / improper '' in the case of criteria of efficiency for conformal prediction since it is conceivable that some non - probabilistic criteria of efficiency may still turn out to be useful .",
    "the proofs in this section will be slightly less formal than the proof of theorem  [ thm : cp ] ; in particular , all references to the neyman  pearson lemma will be implicit .",
    "we start from checking that @xmath93 ( essentially reproducing the argument given in the second parts of the proofs of propositions  3.3 and  3.4 in @xcite ) .",
    "we will analyze the requirements imposed by being m - optimal on the prediction set @xmath94 starting from small values of @xmath15 .",
    "( in this paper we only consider @xmath0 in the interval @xmath95 , even if this restriction is not mentioned explicitly . )",
    "let @xmath96 be the list of the predictabilities ( see ) of all objects @xmath97 , with all duplicates removed and the remaining predictabilities sorted in the decreasing order .",
    "it is clear that an m - optimal idealised conformity measure will assign the lowest conformity to the group of examples @xmath98 with @xmath99 and @xmath100 for some choice function @xmath101 ( see ) .",
    "the conformity of such examples can be different unless they contain the same object ( in which case it must be the same ) ; the conformity of any example in any other group must be higher than the conformity of the examples in this first group .",
    "if these conditions are satisfied for some idealised conformity measure @xmath5 , @xmath5 will satisfy or for any idealised conformity measure @xmath102 and any @xmath103.\\ ] ] the second least conforming group of examples consists of @xmath98 with @xmath104 and @xmath100 for some choice function @xmath101 .",
    "the conformity of examples in the second group can again be different unless they contain the same object .",
    "these and previous conditions ensure that @xmath5 will satisfy or for any @xmath105.\\ ] ] continuing in such a way , we will obtain a choice function @xmath101 and the conformity ordering for the examples whose label is not chosen by that choice function @xmath101 .",
    "all these examples are divided into @xmath8 groups , and each elements of the @xmath106th group is coming before each element of the @xmath107th group when @xmath108 ; in the end we will get @xmath109 groups satisfying this property .",
    "the first @xmath8 groups take care of @xmath110.\\ ] ] the next , @xmath111th , group of examples are @xmath112 with @xmath113 ; they can be ordered in any way between themselves .",
    "if the conditions listed so far are satisfied for an idealised conformity measure @xmath5 , @xmath5 will satisfy  for any idealised conformity measure @xmath102 and any @xmath114.\\ ] ] the following , @xmath115th , group consists of @xmath112 with @xmath116 . continuing in the same way until all examples are exhausted",
    ", we will obtain a refinement of the sp idealised conformity measure that belongs to @xmath90 .",
    "this proof of @xmath93 demonstrates the following property of m - optimal idealised conformity measures .    if @xmath117 , @xmath118 at each significance level @xmath0 .",
    "let us now check that @xmath119 .",
    "analogously to and , we have , for a given idealised conformity measure @xmath5 ( omitted from our notation ) , @xmath120 similarly , we have @xmath121    our argument will also use the following continuity property for idealised conformal predictors .",
    "( for now , we only need parts ( a ) and ( b ) . )",
    "[ cor : right - continuous ] the functions    1 .",
    "@xmath122 2 .",
    "@xmath123 3 .",
    "@xmath124 4 .",
    "@xmath125    are right - continuous in @xmath0 .",
    "all these statements can be deduced from part  ( a ) of lemma  [ lem : right - continuous ] in the same way as in the proof of part  ( b ) of that lemma .",
    "the right - continuity of the function @xmath126 implies the right - continuity of @xmath127 ( remember that @xmath128 takes only integer values ) .",
    "therefore , the right - continuity of @xmath122 follows by the lebesgue dominated convergence theorem .",
    "this proves ( a ) , and proofs of ( b)(d ) are analogous .",
    "first suppose that @xmath5 is m - optimal .",
    "let @xmath102 be any idealised conformity measure . from",
    ", it is clear that holds with @xmath129 replaced by @xmath130 .",
    "if , furthermore , we have : by corollary  [ cor : right - continuous ] we also have for all @xmath0 ; therefore , we also have for all @xmath0 ; in combination with , we obtain .",
    "therefore , @xmath5 is u - optimal .",
    "now suppose that @xmath5 is u - optimal .",
    "let @xmath102 be the sp idealised conformity measure , which we know to be not only m - optimal but also u - optimal ( as shown in the previous paragraph ) . by the definition (  ) of u - optimality , we have and with @xmath131 in place of @xmath130 .",
    "this implies that holds for all @xmath0 ( had the equality been violated for some @xmath15 , it would have been violated for a range of @xmath0 by corollary  [ cor : right - continuous ] , which would have contradicted ) . in the same way",
    ", it implies that holds ( even with @xmath131 in place of @xmath132 ) for all @xmath0 .",
    "therefore , @xmath5 is m - optimal .      our argument for @xmath133 will be similar to the argument for @xmath93 given in the previous subsection ; we will again analyze the requirements imposed by being e - optimal starting from small values of @xmath15 .",
    "let @xmath134 be the list of the conditional probabilities @xmath67 of all examples @xmath135 , with all duplicates removed and the remaining conditional probabilities sorted in the increasing order .",
    "all examples will be split into @xmath109 groups , with the examples in the @xmath106th and @xmath136th groups satisfying @xmath137 , @xmath138 .",
    "initially the @xmath106th group , @xmath138 , contains all examples satisfying @xmath137 , and the other groups are empty .",
    "( later some of the examples will be moved into the groups numbered @xmath139 , and as a result some of the first @xmath8 groups may become empty . )",
    "it will be true that each element of the @xmath106th group will be coming before each element of the @xmath107th group when @xmath140 .",
    "any f - optimal idealised conformity measure will assign the lowest conformity to the first group of examples , perhaps except for examples @xmath98 for which @xmath141 .",
    "if for some @xmath97 , the first group contains @xmath98 with @xmath141 , we choose one such @xmath98 for each such @xmath14 and move it to the @xmath111th group .",
    "the rest of the examples in the group can be ordered in their conformity in any way ( with ties allowed ) .",
    "the examples in the @xmath111th group can also be ordered arbitrarily .",
    "process the 2nd , 3rd , ",
    ", @xmath8th groups in the same way .",
    "it is clear that in the end we will obtain a refinement of an mcp idealised conformity measure .",
    "next we prove @xmath142 . defining a _ p - choice function _",
    "@xmath143 ( for a given idealised conformity measure ) by the requirement @xmath144 we have the following analogue of : @xmath145 this implies , similarly to , @xmath146    suppose that @xmath5 is e - optimal , and let @xmath102 be any idealised conformity measure . from",
    ", it is clear that holds with @xmath129 replaced by @xmath130 .",
    "if , furthermore , we have : by corollary  [ cor : right - continuous](c ) we also have for all @xmath0 ; therefore , we also have for all @xmath0 ; in combination with , we obtain .",
    "therefore , @xmath5 is f - optimal .",
    "now suppose that @xmath5 is f - optimal .",
    "let @xmath102 be any mcp idealised conformity measure , which we know to be both e - optimal and f - optimal . by the definition of f - optimality",
    ", we have and with @xmath131 in place of @xmath130 . as in the previous subsection",
    ", this implies that holds for all @xmath0 , and also implies that holds ( even with @xmath131 in place of @xmath132 ) for all @xmath0 . therefore , @xmath5 is e - optimal .",
    "the proof is similar to the proofs in the previous two subsections .",
    "first we check that @xmath147 , analyzing the requirement of om - optimality starting from small values of @xmath15 .",
    "let @xmath148 be the list of the predictabilities of all objects @xmath97 whose predictability exceeds @xmath86 , with all duplicates removed and the remaining predictabilities sorted in the decreasing order .",
    "all examples are split into @xmath149 groups ( perhaps some of them empty ) in such a way that each element of the @xmath106th group is coming before each element of the @xmath107th group when @xmath150 .",
    "the @xmath106th group , @xmath138 , contains all examples @xmath98 with predictability @xmath151 and @xmath152 , the @xmath111th group contains all examples with predictability @xmath86 or less , and the @xmath153th group , @xmath138 , contains all examples @xmath98 with @xmath154 ( there is , however , at most one such example ) ; it is possible that @xmath155 .    any om - optimal idealised conformity measure will assign the lowest conformity to the first group of examples ( assuming @xmath156 ) , and those examples can be ordered arbitrarily in their conformity , except that any examples sharing their objects should have the same conformity",
    "this group takes care of the values @xmath157.\\ ] ] proceed in the same way through groups @xmath158 .",
    "the @xmath111th group is most complicated ( when non - empty ) .",
    "it contains the following kinds of examples :    * examples whose predictability is less than @xmath86 .",
    "all such examples should have the same conformity if they share the same object .",
    "* examples @xmath98 whose predictability is exactly @xmath86 and which satisfy @xmath159 .",
    "all such examples should have the same conformity if they share the same object .",
    "* examples @xmath98 whose predictability is exactly @xmath86 and which satisfy @xmath160 .",
    "otherwise , the examples in the @xmath111th group can be ordered arbitrarily in their conformity .",
    "groups @xmath161 are singletons or empty and do not cause any problems .",
    "therefore , an idealised conformity measure is om - optimal if and only if it is in @xmath162 .",
    "next we check that @xmath163 . similarly",
    "to , we have , for a given idealised conformity measure , @xmath164    by , om - optimality immediately implies ou - optimality",
    ".    now suppose that @xmath5 is ou - optimal .",
    "let @xmath102 be the msp idealised conformity measure , which is both om - optimal and ou - optimal .",
    "if is violated for some @xmath0 , it is violated for a range of @xmath0 ( by corollary  [ cor : right - continuous](d ) ) , which , by , contradicts the ou - optimality of @xmath5 .",
    "therefore , @xmath5 is om - optimal .",
    "in this section we demonstrate differences between two of our @xmath0-free criteria , of ( probabilistic ) and u ( standard but not probabilistic ) on the usps data set of hand - written digits ( @xcite ; examples of such digits are given in figure  [ fig : images ] , which is a subset of figure  2 in @xcite ) .",
    "we use the original split of the data set into the training and test sets .",
    "our programs are written in r , and the results presented in the figures below are for the seed @xmath165 of the r random number generator ; however , we observe similar results in experiments with other seeds .",
    "the problem is to classify hand - written digits , the labels are elements of @xmath166 , and the objects are elements of @xmath167 , where the @xmath168 numbers represent the brightness of pixels in @xmath169 pictures .",
    "we normalise each object by applying the same affine transformation ( depending on the object ) to each of its pixels making the mean brightness of the pixels in the picture equal to @xmath165 and making its standard deviation equal to @xmath170 .",
    "the sizes of the training and test sets are @xmath171 and @xmath172 , respectively .",
    "+     we evaluate six conformal predictors using the two criteria of efficiency .",
    "fix a metric on the object space @xmath167 ; in our experiments we use tangent distance ( as implemented by daniel keysers ) and euclidean distance . given a sequence of examples",
    "@xmath24 , @xmath32 , we consider the following three ways of computing conformity scores : for @xmath138 ,    * @xmath173 , where @xmath174 are the distances , sorted in the increasing order , from @xmath44 to the objects in @xmath24 with labels different from @xmath38 ( so that @xmath175 is the smallest distance from @xmath44 to an object @xmath176 with @xmath177 ) , and @xmath178 are the distances , sorted in the increasing order , from @xmath44 to the objects in @xmath179 labelled as @xmath38 ( so that @xmath180 is the smallest distance from @xmath44 to an object @xmath176 with @xmath181 and @xmath182 ) .",
    "we refer to this conformity measure as the _ knn - ratio conformity measure _ ; it has one parameter , @xmath183 , whose range is @xmath184 in our experiments ( so that we always have @xmath185 ) . *",
    "@xmath186 , where @xmath187 is the number of objects labelled as @xmath38 among the @xmath183 nearest neighbours of @xmath44 ( when @xmath188 in the ordered list @xmath189 of the distances from @xmath44 to the other objects , we choose the nearest neighbours randomly among @xmath190 with @xmath182 and with @xmath176 at a distance of @xmath191 from @xmath44 ) .",
    "this conformity measure is a knn counterpart of the cp idealised conformity measure ( cf .  ) , and we will refer to it as the _ knn - cp conformity measure _ ; its parameter @xmath183 is in the range @xmath192 in our experiments . * finally , we define @xmath193 , where @xmath194 is the number of objects labelled as @xmath195 among the @xmath183 nearest neighbours of @xmath44 , @xmath196 ( chosen randomly from @xmath197 if @xmath198 ) , and @xmath199 this is the _ knn - sp conformity measure_.    the three kinds of conformity measures combined with the two metrics ( tangent and euclidean ) give six conformal predictors .",
    "figure  [ fig : usps ] gives the average unconfidence   ( top panel ) and the average observed fuzziness   ( bottom panel ) over the test sequence ( so that @xmath200 ) for a range of the values of the parameter @xmath183 .",
    "each of the six lines corresponds to one of the conformal predictors , as shown in the legends ; in black - and - white the lines of the same type ( dotted , solid , or dashed ) corresponding to euclidean and tangent distances can always be distinguished by their position : the former is above the latter .",
    "the best results are for the knn - ratio conformity measure combined with tangent distance for small values of the parameter @xmath183 .",
    "for the two other types of conformity measures their relative evaluation changes depending on the kind of a criterion used to measure efficiency : as expected , the knn - cp conformal predictors are better under the of criterion , whereas the knn - sp conformal predictors are better under the u criterion ( cf .",
    "theorems  [ thm : cp ] and  [ thm : sp ] ) , if we ignore small values of @xmath183 ( when the probability estimates @xmath201 are very unreliable ) .",
    "our conclusion is that whereas some conformal predictors ( such as the knn - ratio ones in our experiments ) can perform well under different criteria of efficiency , the performance of other conformal predictors depends very much on the criterion of efficiency used to evaluate it .",
    "conformal predictors , as defined in section  [ sec : criteria ] , only guarantee the overall coverage probability , averaged over all labels .",
    "sometimes we want to have a guarantee for the coverage probability for each label @xmath16 separately , and in this case one should use label - conditional conformal predictors , which are studied in this section .",
    "the _ label - conditional conformal predictor _ determined by a conformity measure @xmath5 is defined by where the _ label - conditional p - values _",
    "@xmath17 are defined by @xmath202 ( instead of  ) ; as before , @xmath19 is a random number distributed uniformly on the interval @xmath20 $ ] ( conditionally on all the examples ) , and the conformity scores are defined by  .",
    "the _ label - conditional conformal transducer _ determined by @xmath5 outputs the system of p - values @xmath22 defined by for each training sequence @xmath23 of examples and each test object @xmath14 .",
    "the property of validity for label - conditional conformal predictors and transducers is that the p - values @xmath17 are distributed uniformly on @xmath20 $ ] given @xmath195 when the examples @xmath27 are generated independently from the same probability distribution @xmath28 on @xmath29 ( see , e.g. , @xcite , proposition  4.10 ) .",
    "this implies that the conditional probability of error , @xmath30 , given @xmath195 is @xmath0 at any significance level  @xmath0 .",
    "the p - values , and the corresponding conformal predictors and transducers , only depend on the conformity order within each class : now we define @xmath203 to mean @xmath204 and @xmath26 ( with @xmath57 and @xmath205 such that @xmath206 being incomparable ) .",
    "the definitions of all ten criteria of efficiency introduced in section  [ sec : criteria ] and listed in table  [ tab : criteria ] carry over to the case of label - conditional conformal transducers and predictors .      as before",
    ", we assume that the object space @xmath1 is finite and @xmath207 for all @xmath97 .",
    "we also assume @xmath208 for all @xmath16 , where @xmath209 is the marginal distribution of @xmath28 on the label space @xmath2 .",
    "let @xmath5 be an idealised conformity measure .",
    "for each potential label @xmath16 for an object @xmath14 define the corresponding _ label - conditional p - value _ as @xmath210 analogously to , with the same random number @xmath211 $ ] used for all @xmath98 .",
    "the _ label - conditional idealised conformal predictor _ is defined by for the new definition of @xmath212 and the _ label - conditional idealised conformal transducer _ corresponding to the idealised conformity measure @xmath5 outputs for each object @xmath97 the system of p - values @xmath22 defined by .",
    "the idealised p - values , and the corresponding idealised conformal predictors and transducers , also depend only on the conformity order within each class : we can define @xmath213 to mean @xmath214 and @xmath215 .",
    "two idealised conformity measures are _ equivalent within classes _ if they lead to the same order @xmath216 ; in this section we will consider only this notion of equivalence ( without mentioning it explicitly ) .    the properties of validity now become conditional :    *",
    "if @xmath98 is generated from @xmath28 and @xmath19 is generated independently from the uniform probability distribution on @xmath20 $ ] , @xmath212 is distributed uniformly on @xmath20 $ ] even if we condition on @xmath195 .",
    "* therefore , at each significance level @xmath0 the idealised conformal predictor makes an error with conditional probability @xmath0 given @xmath195 .      _ label - conditionally s - optimal",
    "_ , _ n - optimal _ , _ of - optimal _ , and _ oe - optimal _ idealised conformity measures are defined exactly as s - optimal , n - optimal , of - optimal , and oe - optimal idealised conformity measures at the end of section  [ sec : optimal ] but with the label - conditional definitions of the p - values and prediction sets .",
    "let us say that an idealised conformity measure @xmath5 is a _ label - conditional refinement _ of an idealised conformity measure @xmath102 if @xmath217 for all @xmath218 and all @xmath16 .",
    "notice that the notion of label - conditional refinement is weaker than that of refinement ( as defined by",
    "): if @xmath5 is a refinement of @xmath102 , then @xmath5 is a label - conditional refinement of @xmath102 ( but not vice versa , in general ) .",
    "let @xmath219 be the set of all label - conditional refinements of the cp idealised conformity measure .",
    "if @xmath220 is a criterion of efficiency ( one of the ten criteria in table  [ tab : criteria ] ) , we let @xmath221 stand for the set of all label - conditionally @xmath220-optimal idealised conformity measures .",
    "we have the following simple corollary of theorem  [ thm : cp ] .",
    "[ thm : cp - lc ] @xmath222 .",
    "the proof is a modification of the proof of theorem  [ thm : cp ] . in the case of @xmath223 , for each label @xmath16 we have a separate optimization problem .",
    "now the constraint becomes @xmath224 ( in place of ) , and the objective becomes to maximise @xmath225 ( since maximising the sum over @xmath98 in can be achieved by maximizing the sum over @xmath14 for each @xmath195 separately ) .",
    "now an application of the neyman ",
    "pearson lemma , as in the proof of theorem  [ thm : cp ] , shows that @xmath226 .    the same argument as in the proof of theorem  [ thm : cp ] ( the last three paragraphs ) shows that @xmath227 , and so we have the formula in theorem  [ thm : cp - lc ] .",
    "we say that an efficiency criterion is _ label - conditionally probabilistic _ if the cp idealised conformity measure is label - conditionally optimal for it ; we add the qualifier _ weakly _ if this is true for some ( label - conditional ) refinement of cp and _ strongly _ if this is true for an arbitrary ( label - conditional ) refinement of cp .",
    "we can see that the four criteria that are set in italics in table  [ tab : criteria ] are still optimal in the label - conditional setting",
    ".      using the label - conditional definitions of the p - values and prediction sets , we define _ label - conditionally u - optimal _ , _ m - optimal _ , _ f - optimal _ , _ e - optimal _ , _ ou - optimal _ , and _ om - optimal _ idealised conformity measures in exactly the same way as their unconditional counterparts at the beginning of section  [ sec : not - probabilistic ] .",
    "the label - conditional u and m criteria are standard , and the label conditional e criterion ( with a different treatment of empty observations ) has been introduced and explored in @xcite .",
    "we do not give label - conditional analogues of theorems  [ thm : sp][thm : msp ] , since the label - conditionally u- , m- , f- , e- , ou- , and om - optimal idealised conformity measures are unlikely to have explicit [ p : combinatorial-2]expressions ( cf .  our remark about deterministic conformal predictors on p.  ) , unless @xmath91 .",
    "the following theorem says that all of these criteria are bw probabilistic ( and the examples that we will give after its proof will show that they are not probabilistic ) .    if @xmath91 , each of the sets @xmath228 contains a refinement of the cp idealised conformity measure .",
    "assume , without loss of generality , that @xmath229 . and",
    "let us assume , for simplicity , that the values @xmath230 are all different for different @xmath97 ( if this condition is not satisfied , the theorem still holds , but finding a suitable refinement becomes , in general , a difficult combinatorial problem ) . in this case",
    "it is easy to see that each of the sets in is the equivalence class of the cp idealised conformity measure : we can construct the optimal idealised conformity measure gradually starting from small values of @xmath0 , as in the proofs of theorems  [ thm : sp][thm : msp ] .",
    "the following examples show that none of the criteria considered in this subsection is probabilistic ( or even weakly probabilistic ) :    * let @xmath75 , @xmath231 , and @xmath232 ( @xmath67 meaning @xmath68 , as usual ) .",
    "all refinements of the cp idealised conformity measure are equivalent ( as for different labels @xmath195 the two conditional probabilities @xmath67 , @xmath233 , are different ) , and so all of them will lead to the same p - values .",
    "let @xmath5 be any idealised conformity measure that makes all observations containing object @xmath170 less conforming than all observations containing object @xmath234 .",
    "the u criterion is not probabilistic since the expression is @xmath235 for the cp idealised conformity measure and is smaller , @xmath85 , for the idealised conformity measure @xmath5 .",
    "the m criterion is not probabilistic since at significance level @xmath236 the cp idealised conformity measure gives the predictor @xmath237 and @xmath238 ( a.s . ) , and so @xmath239 ( cf .  ) .",
    "* let @xmath240 , @xmath65 , and , for a small @xmath76 , @xmath241 all refinements of the cp idealised conformity measure are equivalent , and so the choice of the refinement does not affect the p - values .",
    "let @xmath5 be an idealised conformity measure satisfying @xmath242 ( in other words , @xmath5 is the cp idealised conformity measure modified in such a way that that it assigns to @xmath243 the highest conformity score ) .",
    "the f criterion is not probabilistic since the expression is @xmath244 for the cp idealised conformity measure and is smaller ( for sufficiently small @xmath80 ) , @xmath81 , for @xmath5 .",
    "the e criterion is not probabilistic since at significance level @xmath82 the idealised conformity measure @xmath5 gives a predictor whose excess is always @xmath165 , whereas the cp idealised conformity measure will have expected excess @xmath245 .",
    "* let @xmath75 , @xmath231 , and @xmath28 be defined by .",
    "let @xmath5 be any idealised conformity measure that makes all observations containing object @xmath170 less conforming than all observations containing object @xmath234 .",
    "the ou criterion is not probabilistic since the expression is @xmath235 for the cp idealised conformity measure and is smaller , @xmath85 , for the idealised conformity measure @xmath5 .",
    "the om criterion is not probabilistic since at significance level @xmath236 the cp idealised conformity measure produces an observed multiple prediction a.s . , whereas the idealised conformity measure @xmath5 produces an observed multiple prediction with probability @xmath246 .",
    "this paper investigates properties of various criteria of efficiency of conformal prediction in the case of classification .",
    "it would be interesting to transfer , to the extent possible , this paper s results to the cases of :    * regression .",
    "the sum of p - values ( as used in the s criterion ) now becomes the integral of the p - value as function of the label @xmath195 of the test example , and the size of a prediction set becomes its lebesgue measure ( considered , as already mentioned , in @xcite in the non - idealised case ) . whereas the latter is typically finite , ensuring the convergence of the former is less straightforward . * anomaly detection . a first step in this direction",
    "is made in @xcite , which considers the average p - value as its criterion of efficiency . *",
    "infinite , including non - discrete , object spaces @xmath1 .",
    "* non - idealised conformal predictors . * significance levels @xmath247 that depend on the label @xmath16 in the label - conditional case .",
    "the main part of this paper merely mentions what we called `` combinatorial problems '' ( see pages and )",
    ". it would be interesting to explore them systematically .",
    "as an example , let us consider the n criterion of efficiency for deterministic idealised conformal predictors ( with @xmath19 set to @xmath170 rather than being random ) in the case @xmath248 ( which we did not allow in the main part of the paper ; in this case , there is no difference between unconditional and label - conditional idealised conformal predictors ) .",
    "the problem of finding an n - optimal idealised conformity measure then becomes the subset - sum problem , known to be np - hard : see , e.g. , @xcite , chapter  4 ( a special case of this problem , partition , was already one of karp s original 21 np - complete problems @xcite ) .",
    "there are , however , efficient polynomial approximation schemes for this problem .",
    "it would be interesting , in particular , to find such schemes for general deterministic idealised conformal predictors and transducers and for smoothed idealised conformal predictors and transducers for non - probabilistic criteria of efficiency in the label - conditional case .",
    "we are grateful to the reviewers of the conference version of this paper for their helpful comments .",
    "this work was partially supported by epsrc ( grant ep / k033344/1 ) , the air force office of scientific research ( grant `` semantic completions '' ) , and the eu horizon 2020 research and innovation programme ( grant 671555 ) .",
    "a.  philip dawid .",
    "probability forecasting . in samuel kotz , n.  balakrishnan , campbell  b. read , brani vidakovic , and norman  l. johnson , editors , _ encyclopedia of statistical sciences _ ,",
    "volume  10 , pages 64456452 .",
    "wiley , hoboken , nj , second edition , 2006 .    valentina fedorova , alex gammerman , ilia nouretdinov , and vladimir vovk .",
    "conformal prediction under hypergraphical models . in harris papadopoulos ,",
    "andreas  s. andreou , lazaros iliadis , and ilias maglogiannis , editors , _ artificial intelligence applications and innovations .",
    "second workshop on conformal prediction and its applications ( copa 2013 ) _ ,",
    "pages 371383 , heidelberg , 2013 .",
    "journal version : _ international journal on artificial intelligence tools _ * 24*(6 ) , 1560003 ( 2015 ) .",
    "ulf johansson , rikard knig , tuve lfstrm , and henrik bostrm . evolved decision trees as conformal predictors . in luis",
    "gerardo de la fraga , editor , _ proceedings of the 2013 ieee conference on evolutionary computation _ , volume  1 , pages 17941801 , cancun , mexico , 2013 .",
    "yann le  cun , bernhard  e. boser , john  s. denker , donnie henderson , r.  e. howard , wayne  e. hubbard , and lawrence  d. jackel .",
    "handwritten digit recognition with a back - propagation network . in david",
    "s. touretzky , editor , _ advances in neural information processing systems 2 _ , pages 396404 .",
    "morgan kaufmann , san francisco , ca , 1990 .",
    "thomas melluish , craig saunders , ilia nouretdinov , and vladimir vovk . comparing the bayes and typicalness frameworks . in luc de  raedt and peter  a. flach , editors , _ proceedings of the twelfth european conference on machine learning _",
    ", volume 2167 of _ lecture notes in computer science _ , pages 360371 , heidelberg , 2001 . springer .",
    "mauricio sadinle , jing lei , and larry wasserman .",
    "least ambiguous set - valued classifiers with bounded error levels .",
    "technical report  arxiv:1609.00451v1 [ stat.me ] , arxiv.org e - print archive , september 2016 .",
    "craig saunders , alex gammerman , and vladimir vovk .",
    "transduction with confidence and credibility . in thomas dean , editor , _ proceedings of the sixteenth international joint conference on artificial intelligence _ ,",
    "volume  2 , pages 722726 , san francisco , ca , 1999 .",
    "morgan kaufmann .",
    "james smith , ilia nouretdinov , rachel craddock , charles offer , and alexander gammerman .",
    "anomaly detection of trajectories with kernel density estimation by conformal prediction . in lazaros",
    "iliadis , ilias maglogiannis , harris papadopoulos , spyros sioutas , and christos makris , editors , _ aiai workshops , copa 2014 _ , volume 437 of _ ifip advances in information and communication technology _ , pages 271280 , 2014 .",
    "vladimir vovk , valentina fedorova , ilia nouretdinov , and alex gammerman .",
    "criteria of efficiency for conformal prediction . in alex gammerman , zhiyuan luo , jesus vega , and vladimir vovk , editors , _ proceedings of the fifth international symposium on conformal and probabilistic prediction with applications ( copa 2016 ) _ , volume 9653 of _ lecture notes in artificial intelligence _ , pages 2339 , switzerland , 2016 . springer ."
  ],
  "abstract_text": [
    "<S> we study optimal conformity measures for various criteria of efficiency of classification in an idealised setting . </S>",
    "<S> this leads to an important class of criteria of efficiency that we call probabilistic ; it turns out that the most standard criteria of efficiency used in literature on conformal prediction are not probabilistic unless the problem of classification is binary . </S>",
    "<S> we consider both unconditional and label - conditional conformal prediction .    </S>",
    "<S> the conference version of this paper has been published in the proceedings of copa 2016 . </S>"
  ]
}