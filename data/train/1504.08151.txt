{
  "article_text": [
    "the gist of quantum key distribution ( qkd ) @xcite is that it allows two remote parties , alice and bob , to establish common secret keys in the presence of an adversary , eve , who may have unlimited computing resources and technological advances . today , three decades after its introduction",
    ", qkd has made enormous progress in both theory and practice , and is arguably on the verge of global commercialisation .",
    "having said that , however , there are still some issues , both theoretical and experimental , that need to be resolved before we can reach that level . amongst those ,",
    "the most pressing one is the mismatch between device models used in security proofs and actual devices used in qkd systems . in particular",
    ", such implementation loopholes can lead to side - channel attacks that break the security of qkd .",
    "notably , it has been repeatedly demonstrated that the behaviour of single - photon detectors employed in qkd systems can be externally controlled , simply by exploiting their physics  @xcite . in this case , it is easy to verify that security can not be achieved , since the measured data are not representative of the quantum channel  @xcite . undoubtedly , such hacking demonstrations raise not only the importance of proper calibration of qkd systems , but also the importance in developing security proof techniques that can tackle modeling discrepancies .",
    "indeed , in the past few years , much attention has been devoted towards the development of such proof techniques and side - channel countermeasures , particularly in the areas of security of finite - length keys @xcite and detector side - channel attacks @xcite .    amongst these theoretical results ,",
    "only a few considered the issue of state preparation flaws  despite that it is a commonly faced experimental problem . more concretely ,",
    "typical light sources used in qkd systems are not true single - photon sources and practical optical modulators employed to encode the light pulses are inherently limited in precision .",
    "the former can be resolved by using the decoy - state method  @xcite , which allows qkd systems based on practical light sources to achieve the security performance of single - photon qkd .",
    "the latter , however , does not have an adequate solution . in particular , it has been firstly shown by gottesman _",
    "et al _  @xcite that such inaccuracies in encoding can lead to very pessimistic secret key rates in the presence of high quantum channel loss .",
    "also , other works show similar results  @xcite .",
    "this strong dependency on channel loss is primarily due to the fact that state preparation flaws can be seen as a form of basis information leakage , which gives eve some advantage in formulating basis - dependent attacks .",
    "crucially , as shown in @xcite , eve s advantage can be significantly enhanced by exploiting channel losses .",
    "consequently , this heavily penalizes the secret key rate whenever the channel loss is substantial .",
    "very recently , a loss - tolerant qkd protocol  @xcite has been proposed by tamaki _",
    "et al _ as a means to overcome typical encoding flaws in qkd systems .",
    "more specifically , as briefly mentioned earlier , here we are considering encoding flaws due to imprecise alignment of optical modulators .",
    "for example , if the quantum states are encoded into the polarisation degree - of - freedom of photons , an encoding flaw could be due to a misalignment in the wave - plate used to set the desired polarisation .",
    "the protocol is similar to the bennett - brassard 1984 ( bb84 ) qkd scheme  @xcite , but instead of considering all the four bb84 states , it uses only three of them .",
    "interestingly , by considering statistics beyond those of the bb84 protocol , the resulting secret key rate is the same as the one of bb84 s  @xcite .",
    "more importantly , the secret key rate has the very nice property in that it is almost independent of encoding flaws .",
    "these results imply that the usual stringent demand on precise state preparation can be considerably relaxed and one only needs to know the prepared states .",
    "additionally , it is useful to mention that most current bb84 qkd systems can easily switch to the loss - tolerant qkd protocol without much hardware modifications .    in anticipation",
    "that the loss - tolerant qkd protocol will be widely implemented in the near future , we extend the security analysis in ref .",
    "@xcite to the finite - key regime , _",
    "i.e. _ , we derive explicit bounds on the extractable secret key length ( in @xcite , the authors have implemented the loss - tolerant protocol experimentally with careful verification of the qubit assumption used in the protocol .",
    "this paper also includes some finite - key analysis of the protocol .",
    "unfortunately , however , its phase error rate estimation seems to be valid only against collective attacks ) .",
    "furthermore , our bounds can be applied to a wide range of imperfect light sources  including typical cases whereby the intensity of the laser is fluctuating between a certain range .",
    "also , the security bounds are obtained within the so - called universal - composable framework  @xcite , and thus secret keys generated using these bounds can be applied to other cryptographic tasks like the one - time - pad . in order to investigate the feasibility of our results",
    ", we consider a qkd system model that borrows parameters from recent fibre - based qkd experiments . with this realistic model ,",
    "our numerical simulations show that provably - secure keys can be distributed up to a fibre length of about 120 km , even when only @xmath0 signals are sent by alice to bob .",
    "this paper is organised as follows . in section",
    "ii , we describe some assumptions that we made in our security analysis and after that we introduce our protocol . in section iii , we give the security definition of the protocol and provide the formulation of the extractable secret key length . in section iv , we present the results of the parameter estimation using the decoy - state method for two different cases : an exact intensity control case and an intensity - fluctuation case .",
    "then , in section v , we simulate the key generation rate for both scenarios .",
    "finally , section vi concludes the paper with a summary .",
    "the paper includes as well some appendixes with additional calculations .",
    "after that , she applies a phase shift @xmath1 to the signal pulse . on reception , bob splits the received pulses into two beams and then applies a phase shift @xmath2 to one of them . also , he applies a one - pulse delay to one of the arms of the interferometer and then recombine the pulses at a 50:50 beamsplitter ( bs ) .",
    "a `` click '' in detector d0 ( d1 ) provides bob the key bit @xmath3 ( @xmath4).,width=321 ]      prior to stating the actual protocol , we first describe the assumptions on the user s devices .",
    "we consider that alice s transmitter contains a laser source , an amplitude modulator and a phase modulator .",
    "[ fig : actual ] .",
    "the laser is single - mode and emits signals with a poissonian photon number distribution .",
    "also , we assume that alice encodes the bit and the basis information in the relative phase @xmath5 between a signal and a reference pulse , whose joint phase is perfectly randomised .",
    "let us emphasise , however , that the security proof that we provide in this paper applies as well to other coding schemes like , for instance , the polarisation or the time - bin coding schemes .",
    "next we present the two types of imperfections that we consider for alice s device .",
    "intensity fluctuations . _",
    "the fluctuation of the intensity of the emitted coherent light is typically due to the laser source and imperfections in the amplitude modulator .",
    "here we shall consider that alice does not have a full description of the probability density function of the fluctuations , but she only knows their range .",
    "that is , she knows that the intensity @xmath6 of the emitted coherent light lies in an interval @xmath7 $ ] except with error probability @xmath8 , where @xmath9 is the upper  ( lower ) intensity . for simplicity",
    ", we shall assume that @xmath10 .",
    "if @xmath11 this error probability can be directly taken into account through the security parameter @xmath12 whose definition is referred to equation ( [ composability ] ) .",
    "the intensities of the signal and reference pulses are @xmath13 and @xmath14 respectively , with @xmath15 .    in section iv .",
    "a we study the case where @xmath16 , _ i.e. _ , there are no intensity fluctuations .",
    "after that , in section iv .",
    "b , we evaluate the typical scenario where @xmath17 .",
    "_ imperfect encoding of the bit and basis information . _ in our protocol , alice chooses the relative phase @xmath5 at random from @xmath18 to encode the bit and basis information .",
    "the phase @xmath19 corresponds to the @xmath20 basis states which are selected with equal probability , and @xmath21 denotes the @xmath22 basis state .",
    "alice assigns a bit value @xmath23 to @xmath24 and a bit value @xmath25 to @xmath26 .    due to the misalignment of the optical system , however , the actual relative phase prepared by alice may deviate from the desired angle @xmath5 by a factor @xmath27 .",
    "hence , we have that the actual state alice sends to bob can be typically described as @xmath28   { \\textrm d}\\delta\\theta_{\\u{a}}. \\label{astates}\\end{aligned}\\ ] ] here , we define @xmath29={| \\cdot \\rangle}{\\langle \\cdot |}$ ] , the parameter @xmath30 is a random phase , the state @xmath31 is the coherent state of the signal  ( reference ) pulse , and @xmath32 is the probability distribution of @xmath27 .",
    "alice does not need to know the origin of the encoding errors @xmath27 , but we assume that she knows @xmath32 . also , we assume that @xmath32 is independently and identically distributed for each run of the protocol .",
    "moreover , we consider that there are no side - channels in alice s device .",
    "+ we consider that the detection efficiency of bob s detectors is independent of his measurement basis choice .",
    "a phase value @xmath33 ( @xmath34 ) corresponds to a device parameter to choose the @xmath35 basis for the measurement .",
    "also , like in the case of alice , we consider that bob uses an imperfect phase modulator that shifts the phase of the incoming signals by @xmath36 , where @xmath37 is the modulation error .",
    "note , however , that this last assumption is not needed in the security proof ; we use it only for simulating the resulting secret rate .",
    "furthermore , we assume that there are no side - channels in bob s device .",
    "we study a three - state protocol that uses one signal and two decoy settings . also , we consider that the protocol employs an asymmetric coding , _",
    "i.e. _ , the @xmath20 and the @xmath22 basis are chosen with probabilities @xmath38 and @xmath39 , respectively .",
    "the secret key is extracted only from those events where both alice and bob select the @xmath20 basis and the signal setting . in addition , we assume that alice and bob do not implement a random sampling procedure to estimate the bit error rate , but they perform error correction for a pre - established fixed value of it .",
    "the error verification step of the protocol ( see step  5 below ) informs them about whether or not the actual residual bit error rate exceeds the    considered value . the protocol runs as follows .    _ * actual protocol * _ +   + first , alice and bob decide a security parameter @xmath12 whose definition is referred to equation ( [ composability ] ) .",
    "then , they repeat the first three steps of the protocol for @xmath40 until the conditions in the sifting step are met . +   + 1 . _ preparation _ + for each @xmath41 , alice randomly chooses the intensity @xmath42 with probability @xmath43 , @xmath44 and @xmath45 , respectively . the intervals @xmath46 $ ] where the different intensities lie have to satisfy @xmath47 and @xmath48 .",
    "then , alice randomly selects the basis @xmath49 with probabilities @xmath38 and @xmath50 , respectively .",
    "next , she chooses at random the signal phase @xmath51 when she selects the @xmath20 basis , and she chooses @xmath52 when she selects the @xmath22 basis . finally , she generates the signal and reference pulses following these specifications and sends them to bob via the quantum channel .",
    "_ measurement _ + bob measures the incoming signal and reference pulses using the measurement basis @xmath53 , which he randomly selects with probabilities @xmath38 and @xmath50 , respectively .",
    "the outcome is recorded in @xmath54 , where @xmath55 and @xmath56 represent the double click event and the no click event , respectively . if @xmath57 , bob assigns a random bit to it . as a result",
    ", he obtains @xmath58 .",
    "+   + 3 . _",
    "+ alice and bob announce their bases and intensity choices over an authenticated public channel and identify the following sets : @xmath59 , @xmath60 and @xmath61 with @xmath62 and @xmath63 .",
    "then , they check if the following conditions are met : @xmath64 , @xmath65 and @xmath66 for all @xmath62 , all @xmath63 , and for certain pre - established values @xmath67 , @xmath68 , @xmath69 and @xmath70 , where @xmath71 represents the length of the set @xmath72 .",
    "we denote by @xmath73 the number of pairs of coherent states ( _ i.e. _ , signal and reference pulses ) sent by alice until these conditions are fulfiled .",
    "we denote alice and bob s sifted keys as @xmath74 ; their size is @xmath75 .",
    "+   + 4 . _",
    "parameter estimation _",
    "+ they estimate the number of events @xmath76 where alice emitted the vacuum ( the single - photon ) state within the set @xmath77 .",
    "their expression is given by equations ( [ resultm0 ] ) and ( [ resultm1 ] ) for the scenario without intensity fluctuations , and by equations ( [ resultm0 in ] ) and ( [ resultm1 in ] ) for the case with intensity fluctuations . also , alice and bob estimate @xmath78 , _",
    "i.e. _ , the number of the so - called phase errors in the single - photon emissions within the set @xmath77 ( see equation ( [ nphase ] ) ) .",
    "they check if the phase error rate @xmath79 is lower than a predetermined threshold value @xmath80 , which corresponds to the phase error rate associated with a zero secret key rate ( see equation ( [ keyrate ] ) ) .",
    "if @xmath81 they abort the protocol ; otherwise they proceed to step 5 .",
    "+   + 5 . _",
    "+ alice and bob perform error correction over an authenticated public channel for @xmath74 .",
    "this step consumes at most @xmath82 bits .",
    "finally , they implement an error verification step and , after that , they perform privacy amplification using a hash function that extracts a secret key pair @xmath83 , where @xmath84 bits .",
    "the security of a qkd protocol is characterised by its _ correctness _ and _",
    "secrecy_. that is , following the universal composable security framework  @xcite , the protocol is called @xmath12-secure if it is both @xmath85-correct and @xmath86-secret , where @xmath87 . here",
    ", the correctness criterion is met whenever the output keys , @xmath88 and @xmath89 , are identical . more generally ,",
    "for some small error @xmath90 in the correctness , we say that the protocol is @xmath90-correct if @xmath91\\leq \\epsilon_\\u{c}$ ] is met . for the secrecy criterion",
    ", it is met whenever the joint classical - quantum state describing alice s output key and eve s quantum system is of the following form , @xmath92 , where @xmath93 is the uniform distribution over all bit strings , and @xmath94 is an arbitrary quantum state held by eve .",
    "likewise , for some small error @xmath95 , we say the protocol is @xmath95-secret if @xmath96 where @xmath97 is the joint state shared by alice and eve .",
    "note that @xmath98 is the trace norm defined as @xmath99 . using these security definitions , it can be shown ( see appendix a for details ) that a lower bound on the secret key length for the protocol described above    @xmath100-\\log_2\\frac{2}{\\epsilon^2_{\\u{s}}-\\eta } -\\lambda_{\\u{ec}}-\\log_2\\frac{2}{\\epsilon_{\\u{c}}}\\big\\rfloor , \\label{keyrate}\\end{aligned}\\ ] ]    where @xmath101 is the binary entropy function",
    ", @xmath102 is a lower bound on @xmath76 , @xmath103 is an upper bound on the phase error rate , and @xmath104 is the sum of the failure probabilities when estimating @xmath105 and @xmath106 .",
    "this last parameter is upper bounded by @xmath107 , where @xmath108 , @xmath109 and @xmath110 are the failure probabilities associated to the estimation of @xmath111 , @xmath112 and to the upper bound on the number of the phase errors @xmath113 , respectively .",
    "in this section , we briefly describe the estimation procedure to obtain @xmath111 and @xmath112 .",
    "also , we provide an expression for @xmath114 .",
    "the detailed calculations are included in appendix d.    as mentioned in section ii .",
    "b , we assume that the phase of each pulse generated by the laser is perfectly randomised .",
    "this means , in particular , that we can regard the signals sent by alice as a classical mixture of fock states , each of them representing the total number of photons contained both in the signal and in the reference pulse .",
    "that is , the probability that alice emits a pulse with @xmath115 photons conditioned on the fact that she selects the intensity setting @xmath116 is written as @xmath117 also , from the property of the decoy state method we have that the total number of detection events when both alice and bob use the @xmath20 basis is given by @xmath118 where @xmath119 represents the number of detection events when alice and bob used the @xmath20 basis and alice emitted an @xmath115-photon state .",
    "we consider first the scenario without intensity fluctuations in the source , _",
    "i.e. , _ when @xmath16 .",
    "owing to the use of decoy - states  @xcite , it can be shown that eve can not obtain any useful information about alice s intensity choice if she observes an @xmath115-photon state in the quantum channel .",
    "therefore , it can be demonstrated that the _ actual _ protocol , where alice chooses the intensity of each signal before she actually sends it to bob , is equivalent to a _ counterfactual _",
    "protocol described as follows .",
    "first , alice prepares and sends @xmath115-photon states to bob .",
    "then , bob measures all the signals received from alice .",
    "afterwards , alice decides the intensity setting for each signal . due to this equivalence between the actual and the counterfactual protocols",
    ", we have that the number of detection events @xmath120 for setting @xmath121 within @xmath122 has the form @xmath123 except with certain error probability that will be introduced later on , and where @xmath124 denotes the mean value of @xmath120 given by @xmath125 the parameter @xmath126 that appears in equation  ( [ eq : gain ] ) denotes the deviation between the experimentally obtained quantity @xmath120 and its expected value . the convergence of @xmath126 is discussed in appendix b.      at first , we calculate a lower bound on @xmath127 , the number of events in @xmath77 that originate from a vacuum state sent by alice .",
    "we define the mean value of @xmath127 as @xmath128 .",
    "now , by applying _",
    "lemma  1 _ from appendix b we obtain that @xmath129 except with certain error probability @xmath130 , where the deviation @xmath131 is given by @xmath132 with @xmath133 .",
    "so far , the lower bound on @xmath105 depends on the unknown mean value @xmath134 which can not be directly observed in the experiment .",
    "according to the definition of @xmath135 , however , this problem can be solved by estimating a lower bound on @xmath136 . for this",
    ", we use a result from @xcite .",
    "in particular , we have that @xmath137 where @xmath138 .",
    "to estimate the mean values @xmath139 and @xmath140 , we can employ either _ lemma 2 _ or _ lemma _ _ 3 _ introduced in appendix b , such that the fluctuation is minimised . in so doing , we obtain a lower bound on @xmath140 together with an upper bound on @xmath139 given by @xmath141 where @xmath142 and @xmath143 .",
    "the failure probability associated with the estimation of @xmath124 , with @xmath144 , is either given by @xmath145 or by @xmath146 , depending on which _ lemma _ ( _ 2 _ or _ 3 _ ) we use .",
    "as a result we find that @xmath147 which only depends on known parameters .",
    "note that in equation  ( [ sat ] ) we have used the fact that @xmath148 in combination with equation ( [ vacgain ] ) .",
    "we finally obtain , therefore , that @xmath149 except with error probability @xmath150 .      here",
    ", we calculate a lower bound on the number of single - photon pulses sent by alice that contribute to @xmath77 . for this",
    ", we use a similar technique to the one described in the previous section .",
    "in particular , let @xmath151 be the mean value of @xmath152 , which is given by @xmath153",
    ". then we have that @xmath154 except with error probability @xmath155 , where @xmath156 . from ref .",
    "@xcite , we have that @xmath157 \\nonumber\\\\ & = : s^{\\u{l}}_{z,1},\\end{aligned}\\ ] ] where @xmath158 . as",
    "before , by using _ lemmas _ 2 and 3 from appendix b we obtain a lower bound on @xmath139 , and an upper bound on @xmath140 and @xmath159 .",
    "they are given by @xmath160 where the second equality holds for @xmath161 .",
    "the failure probability associated with the estimation of @xmath124  ( with @xmath121 ) is either given by @xmath162 or by @xmath163 , depending again on which _ lemma _ ( _ 2 _ or _ 3 _ ) we apply . by employing the relation @xmath164",
    ", we obtain a lower bound on @xmath151 , which only depends on known parameters , @xmath165\\nonumber\\\\ & = : \\mu^l_{1}.\\end{aligned}\\ ] ] therefore , we have that @xmath166 except with error probability @xmath167 , where the parameters @xmath168 and @xmath169 come from the estimation of @xmath170 .",
    "we now evaluate the scenario where the laser suffers from intensity fluctuations .",
    "as introduced above , here we shall assume that alice only knows the range @xmath46 $ ] where the intensity value @xmath6 lies .",
    "below we introduce the final expressions for the different parameters ; the detailed derivations are referred to appendix c.      here , we present the result for the estimation of the lower bound on @xmath171 . here",
    ", @xmath171 is the sum of the conditional probability that bob detects a signal in the @xmath20 basis conditioned that alice chooses the signal intensity and sends a vacuum state in the @xmath20 basis ( see equation ( [ tz0 ] ) ) .",
    "it is given by @xmath172 to calculate the mean values @xmath173 and @xmath174 we employ azuma s inequality , which is described in _",
    "lemma  4 _ ( see appendix  b ) .",
    "importantly , note that this inequality holds without assuming independence of the trials . as a result",
    ", we obtain a lower bound on @xmath173 together with an upper bound on @xmath174 .",
    "they are given by @xmath175 where @xmath176 , and @xmath177 is the number of events where alice and bob use the @xmath20 basis within @xmath73 trials .    in so doing , we find a lower bound on @xmath135 that only depends on parameters that are directly observed in the experiment .",
    "it has the form @xmath178 where the @xmath179 is a lower bound on @xmath180 .",
    "finally , we obtain a lower bound on @xmath127 which is given by @xmath181 except with error probability @xmath182 .      here",
    ", we introduce a lower bound on @xmath183 . here , @xmath183 is the sum of the conditional probability that bob detects a signal in the @xmath20 basis conditioned that alice chooses the signal intensity and sends a single - photon state in the @xmath20 basis ( see equation ( [ tz1 ] ) ) .",
    "it is given by @xmath184\\nonumber\\\\ & = : t^{\\u{l}}_{z,1}.\\end{aligned}\\ ] ] again , to estimate the mean values @xmath185 and @xmath186 we employ _",
    "lemma  4_. this way we obtain a lower bound on @xmath173 and an upper bound on @xmath174 and @xmath186 as @xmath187 where the second equality holds for @xmath161 .",
    "hence , a lower bound on @xmath151 can be directly written as @xmath188\\nonumber\\\\ & = : \\mu^{\\u{l}}_{1},\\end{aligned}\\ ] ] where @xmath189 is a lower bound on @xmath190 .",
    "finally , we obtain @xmath191 as @xmath192 except with error probability @xmath193 .      in this section",
    "we present an upper bound on @xmath78 , which is the number of phase errors in the single - photon emissions within the set @xmath77 . as already mentioned in section  ii .",
    "b , the states sent by alice are given by equation  ( [ astates ] ) , and we assume that the distribution @xmath32 is known to alice .    we denote the single - photon part of equation ( [ astates ] ) as @xmath194 ; it is given by @xmath195 \\u{d}\\delta\\theta_{\\u{a}},\\end{aligned}\\ ] ] where the parameter @xmath196 .",
    "here we define the eigenvectors of the pauli operators @xmath197 and @xmath198 as : @xmath199 , @xmath200 and @xmath201 with @xmath202 .",
    "the state @xmath203 denotes an @xmath115-photon number state of the reference ( signal ) pulse .    with this notation ,",
    "the single - photon part of the three states sent by alice can be expressed as @xmath204 , @xmath205 and @xmath206 .",
    "let @xmath207 , where @xmath208 $ ] and the bloch vector @xmath209 $ ] is a real three - dimensional vector that satisfies @xmath210 with @xmath211 . from @xcite",
    "we have that if @xmath212 , the phase error rate of @xmath213 and @xmath214 is equivalent to that obtained after the application of the following filter operation , @xmath215 + 2v_y/(-1+v_y+\\sqrt{1-v_y^2}){p}[{| 1_{y } \\rangle } ] .",
    "\\end{aligned}\\ ] ] this means , in particular , that we can restrict ourselves to the estimation of the phase error rate of the states @xmath216 which lie in the @xmath198-@xmath217 plane , @xmath218}= \\frac{(\\sigma_i+r^s_x\\sigma_x+r^s_z{\\sigma}_z)}{2 } , \\label{filteredstate}\\end{aligned}\\ ] ] where the parameters @xmath219 and @xmath220 are given by @xmath221 and @xmath222 with @xmath223 .",
    "the states @xmath224 given by equation  ( [ filteredstate ] ) can also be decomposed as @xmath225+p^s_{1}p[{| \\phi^{s}_{1 } \\rangle } ] , \\label{tilderho}\\end{aligned}\\ ] ] where the probabilities @xmath226 have the form @xmath227 and the eigenvectors @xmath228 are given by @xmath229 for @xmath202 , and where @xmath230 is the normalisation factor of the state .",
    "after some lengthy calculations ( see appendix d for details ) , we obtain that @xmath78 is upper bounded by @xmath231+\\delta^{s\\oplus 1}_{\\u{a},s+1}\\nonumber\\\\ & = : n^{\\u{u}}_{\\u{ph } } , \\label{nphase}\\end{aligned}\\ ] ] except with error probability @xmath232 . here , the terms @xmath233 with @xmath234 are defined in equations ( [ azuma3])-([azuma5 ] ) ; the quantities @xmath235 and @xmath236 are given by equation ( [ prob ] ) ; the parameters @xmath237 have the form @xmath238 for @xmath239 ; the coefficients @xmath240 are the @xmath241 element of the following matrix @xmath242 where @xmath243 ; and the fluctuation term @xmath244 is given by equation ( [ three ] ) .",
    "and the total number of signals sent by alice is @xmath245 with @xmath246 and @xmath247 ( from left to right ) .",
    "the rightmost two lines correspond to the asymptotic secret key rate with two decoy settings .",
    "the solid lines denote the case @xmath248=0 ( _ i.e. _ , the perfect encoding scenario ) while the dashed lines show the case @xmath248=0.147 which is equivalent to a phase modulation error of 8.42@xmath249 ( this error parameter is measured in an updated version of a commercial plug&play system ( i d quantique clavis2 )  @xcite )",
    ". the experimental parameters are described in the main text .",
    ", width=264 ]     vs fibre length for a fixed total number of signals @xmath245 sent by alice with exact intensity control , with @xmath246 and @xmath247 ( from left to right ) .",
    "the solid lines correspond to the case @xmath248=0 and the dashed lines are for @xmath248=0.147.,width=264 ]    .",
    "the security parameter is @xmath250 and the total number of signals sent by alice is @xmath245 with @xmath251 ( from left to right ) .",
    "the rightmost two lines correspond to the asymptotic secret key rate with two decoy settings .",
    "the solid lines denote the case @xmath252 ( _ i.e. _ , the perfect encoding scenario ) while the dashed lines show the case @xmath253 ( which is equivalent to a phase modulation error of 8.42@xmath249 ) .",
    "the experimental parameters are described in the main text .",
    ", width=264 ]     vs fibre length for a fixed total number of signals @xmath245 sent by alice , with @xmath254 when the intensity fluctuation is 2%  ( from left to right ) .",
    "the solid lines correspond to the case @xmath248=0 and the dashed lines are for @xmath248=0.147 . , width=264 ]    .",
    "the security parameter is @xmath255 and the total number of signals sent by alice is @xmath245 with @xmath251 ( from left to right ) .",
    "the rightmost two lines correspond to the asymptotic secret key rate with two decoy settings .",
    "the solid lines denote the case @xmath252 ( _ i.e. _ , the perfect encoding scenario ) while the dashed lines show the case @xmath253 ( which is equivalent to a phase modulation error of 8.42@xmath249 ) .",
    "the experimental parameters are described in the main text .",
    ", width=264 ]     vs fibre length for a fixed total number of signals @xmath245 sent by alice , with @xmath254 when the intensity fluctuation is 5% ( from left to right ) .",
    "the solid lines correspond to the case @xmath248=0 and the dashed lines are for @xmath248=0.147 . , width=264 ]    in this section ,",
    "we show the simulation result for a fibre - based qkd system .",
    "alice chooses the intensity of the laser from the set @xmath256 , where we fix the intensity of the weakest decoy state to @xmath257 .",
    "this is so because , in practice , it is difficult to generate a vacuum state due to the imperfect extinction of the amplitude modulator . also , we assume that bob uses an active measurement setup with two single - photon detectors with detection efficiency @xmath258 and a dark count probability @xmath259 .",
    "the attenuation coefficient of the optical fibre is @xmath260 and its transmittance is @xmath261 with @xmath262 denoting the fibre length .",
    "the overall misalignment error of the optical system is fixed to be @xmath263 .",
    "in addition , we assume an error correction leakage @xmath264 , where @xmath265 is the bit error rate of the sifted key @xmath74 . moreover ,",
    "for simplicity , we consider that the error correction efficiency of the protocol is a constant number @xmath266=1.16 which does not depend on the size of @xmath77 . for simplicity , we model the imperfection of alice s ( bob s ) phase modulator as @xmath267 ( @xmath268 ) .",
    "also , we consider that the intensity fluctuation of the laser source lies in the interval @xmath269 $ ] with @xmath270 and @xmath271 for a fixed value @xmath272 .    in these conditions , we simulate the secret key generation rate @xmath273 for a fixed value of the correctness coefficient @xmath274 . for this",
    ", we perform a numerical optimisation of the resulting secure key rate over the free parameters @xmath275 and @xmath276 .      the resulting secret key rate for this scenario , _",
    "i.e. _ when @xmath277 , is shown in fig .",
    "[ fig : keyrate1 ] .",
    "the security parameter is    @xmath250 and the total number of signals sent by alice is @xmath245 with @xmath278 and @xmath247 .",
    "we consider two possible cases : @xmath252  ( _ i.e. _ , the perfect encoding case ) and @xmath253 , which is equivalent to a phase modulation error of @xmath279 .",
    "for comparison , fig .",
    "[ fig : keyrate1 ] also includes the asymptotic secret key rate ( _ i.e. , _ the key rate in the limit of infinitely large keys ) with two decoy settings .    as a result",
    ", we find that the effect of state preparation flaws on the key generation rate is almost negligible .",
    "also , we have that if the total number of signals sent by alice is about @xmath280 , alice and bob can exchange secret keys over 150 km both when @xmath252 and @xmath281 .    finally , fig .  [",
    "fig : block ] shows the postprocessing block size @xmath282 which is the length of the bit string to be processed in error correction and privacy amplification as a function of the distance when @xmath245 with @xmath278 and @xmath247 .      in this section",
    "we evaluate the resulting secret key rate when the laser source suffers from intensity fluctuations .",
    "we study two cases : @xmath283 and @xmath284 , where @xmath272 is the deviation rate from the expected value of the intensity .",
    "the results are shown in figs .",
    "[ fig : keyrate2 ] and  [ fig : keyrate3 ] . here",
    "we consider that @xmath285 , and the term @xmath248 takes again the values @xmath252 and @xmath253 .",
    "the security parameter is @xmath250 in fig .",
    "[ fig : keyrate2 ] and @xmath255 in fig .",
    "[ fig : keyrate3 ] .    for comparison",
    ", these two figures also show the asymptotic secret key rate when alice and bob use two decoy settings . in this asymptotic case",
    ", we find that the degradation on the achievable key rate , when compared to the scenario @xmath277 , is only about 10 km ( 20 km ) when @xmath283 ( @xmath284 ) .    in the finite - key regime , however",
    ", we obtain that the presence of intensity fluctuations seems to strongly limit the key generation rate if alice and bob do not know their probability distribution but only know the interval where the fluctuations lie in .",
    "for instance , when @xmath286 and @xmath277 ( see fig .",
    "[ fig : keyrate1 ] ) alice and bob can distribute a secret key over more than @xmath287 km .",
    "however , to achieve a similar secret key rate performance when the intensity fluctuation of the source is @xmath288 ( _ i.e. _ , the parameter @xmath283 ) they need to exchange about @xmath289 signals .",
    "the main technical reason for this behaviour seems to be the fact that azuma s inequality  @xcite has a relatively slow convergence speed when compared to the chernoff bound  @xcite and the multiplicative chernoff bound  @xcite .    as a side remark ,",
    "let us mention that when @xmath284 and @xmath290 we find that the achievable secret key rate is basically zero unless we increase the security parameter @xmath12 from @xmath250 to @xmath255 .",
    "this is illustrated in fig .",
    "[ fig : keyrate3 ] .",
    "finally , figs .",
    "[ fig : ppb1 ] and [ fig : ppb2 ] show the postprocessing block size @xmath282 as a function of the distance when @xmath245 with @xmath254 for the 2% intensity fluctuation case and for the 5% intensity fluctuation case , respectively .",
    "in summary , we have provided explicit security bounds for the loss - tolerant qkd protocol in the finite - key regime . on the application front",
    ", our results constitute an important step towards practical qkd with imperfect light sources , in that the resulting security performance is robust against encoding inaccuracies like , for instance , optical misalignments .",
    "furthermore , our results take into account intensity fluctuations in the light source , which is a common experimental fact .",
    "our results highlight the importance of the stable control of the intensity modulator as well as the need for a precise estimation of its intensity , which is not often sufficiently emphasised in the experiments . on a more general outlook",
    ", it would be of great practical interest to incorporate our results into measurement - device - independent qkd ( mdiqkd )  @xcite .",
    "we thank lo h - k , xu f , kato g , azuma k , ikuta r , nagamatsu y , takeuchi y and matsuki k for valuable discussions on the security analysis and parameter estimation procedure , and yoshino k , fujiwara m , sasaki m , and tomita a for fruitful discussions on practical qkd systems .",
    "am acknowledges support from the jsps grant - in - aid for scientific research(a ) 25247068 .",
    "mc thanks the galician regional government ( program `` ayudas para proyectos de investigacion desarrollados por investigadores emergentes '' , and consolidation of research units : atlanttic ) , and the spanish government ( project tec2014 - 54898-r ) for financial support .",
    "kt acknowledges support from the national institute of information and communications technology ( nict ) of japan ( project `` secure photonic network technology '' as part of project uqcc ) and the impact program .",
    "here we present the calculations for the security bound given by equation ( [ keyrate ] ) .",
    "the security analysis is based on the universal composable security framework  @xcite .",
    "recall that after privacy amplification , the joint state shared by alice , bob and eve is described by the following classical - quantum state @xmath291 where @xmath292 and @xmath293 are the classical bit strings for the keys , associated with orthonormal states @xmath294 and @xmath295 in a hilbert space . here",
    ", @xmath296 denotes the distribution of the keys and @xmath297 is the quantum state of eve s system conditioned on @xmath298 and @xmath299 . in the ideal scenario ,",
    "the joint state is described by @xmath300 where @xmath301 and @xmath302 is an arbitrary quantum state held by eve . using the security definition stated in the main text , a @xmath303-secure qkd protocol satisfies @xmath304 furthermore ,",
    "if the security parameter @xmath303 is appropriately chosen , it can be seen as the sum of errors in the correctness and secrecy , i.e. , @xmath305 . to see this ,",
    "let us introduce an intermediate state , @xmath306 which is just a trivial classical extension of alice s state .",
    "then , by using the triangle inequality property of the trace distance metric , we have @xmath307 fixing the first term on the r.h.s to @xmath90 gives @xmath308,\\ ] ] where the inequality is due to the fact that the trace distance metric is contractive under any trace - preserving operation ( in our case , the partial trace operation ) .",
    "similarly , by fixing the second term to @xmath95 we have @xmath309 therefore , fixing @xmath305 gives the desired decomposition .    from @xcite ,",
    "the lower bound on the secret key length of our protocol is written as @xmath310-\\lambda_{\\u{ec}}-\\log_2\\frac{2}{\\epsilon_{\\u{c}}}\\big\\rfloor,\\end{aligned}\\ ] ] where @xmath311 and @xmath191 are the lower bounds on the detection events of the vacuum and the single - photon emission , respectively , and @xmath312 is the number of rounds performing the random hashing to correct the phase error , which is equivalent to the number of bits sacrificed in the privacy amplification step of the protocol .",
    "the parameter @xmath82 denotes the number of bits consumed in bit error correction , and @xmath313 is the length of the hash that alice sends to bob for the error verification using the universal@xmath314 hash functions . from @xcite and @xcite , we have that @xmath86 can be bounded by @xmath315 .",
    "therefore , the secret key length is obtained as @xmath100-\\log_2\\frac{2}{\\epsilon^2_{\\u{s}}-\\eta } -\\lambda_{\\u{ec}}-\\log_2\\frac{2}{\\epsilon_{\\u{c}}}\\big\\rfloor,\\end{aligned}\\ ] ] where we consider @xmath104 as a fixed value in this paper .",
    "in this appendix we introduce four different concentration inequalities which are used throughout this paper .",
    "first , we introduce the stochastic model that is assumed in _",
    "lemmas 1 , 2 _ and _ 3_. + _ stochastic model in _ lemmas 1 , 2 _ and _ 3_. _ let @xmath316 be a set of independent bernoulli random variables that satisfy @xmath317 , and let @xmath318 .",
    "the expected value of @xmath22 is denoted as @xmath319=\\sum_{i=1}^np_i$ ] .",
    "an observed outcome of @xmath22 is represented as @xmath320 .",
    "_ chernoff bound _",
    "@xcite this bound requires the knowledge of @xmath321 .",
    "it relates @xmath320 with @xmath321 as @xmath322 except with error probability @xmath323 , where the fluctuation term @xmath324 lies in the interval @xmath325 $ ] with @xmath326 and @xmath327 , where @xmath328 and @xmath329 . here",
    "the parameter @xmath330 denotes the probability that @xmath331 .",
    "equation  ( [ cher ] ) holds if both @xmath332 and @xmath333 are met .",
    "+   + _ lemma  2 .",
    "_  _ hoeffding bound _  @xcite + this bound does not require the knowledge of @xmath321",
    ". it relates @xmath321 and @xmath320 as @xmath334 except with error probability @xmath335 , where the fluctuation term @xmath336 lies in the interval @xmath337 $ ] with @xmath338 and @xmath339 , and where @xmath143 .",
    "+   + _ lemma  3 .",
    "_  _ multiplicative chernoff bound _",
    "@xcite + this bound does not require the knowledge of @xmath321 . it combines _",
    "lemma  1 _ and _ 2 _ above .",
    "it uses _ lemma 2 _ to estimate a lower bound on @xmath321 that is then basically used in combination with _",
    "lemma 1_. in particular , let @xmath340 for certain @xmath341 .",
    "then , if the following two conditions are satisfied : @xmath342 and @xmath343 with @xmath344 , this lemma states that @xmath321 and @xmath320 can be related as @xmath345 except with error probability @xmath346 , where @xmath347 lies in the interval @xmath348 $ ] with @xmath349 and @xmath350 , and where @xmath351 .",
    "_ azuma s inequality _",
    "@xcite + this result plays a crucial role in our security analysis .",
    "it is applicable to any stochastic model as long as the martingale and the bounded difference conditions ( bdc ) are satisfied . in particular , a sequence of random variables @xmath352",
    "is called a martingale if and only if @xmath353=x^{(l)}$ ] for all non - negative integer @xmath354 , where @xmath355 $ ] represents the expectation value . on the other hand",
    ", @xmath352 is said to fulfil the bdc if there exists @xmath356 such that @xmath357 for all non - negative integer @xmath354 .",
    "let us consider @xmath73 trials of a random variable @xmath358 , where @xmath354 refers to the @xmath354th trial .",
    "if @xmath358 is a martingale and satisfies the bdc with @xmath359 then azuma s inequality guarantees that @xmath360\\leq{2e^{-\\frac{n\\delta^2}{2 } } } \\label{eq : azuma1}\\end{aligned}\\ ] ] for any @xmath361 .",
    "let us now define the following random variable for the @xmath354th trial , @xmath362 where @xmath363 represents the actual number of events of the form @xmath364 observed among the first @xmath354 trials , and @xmath365 is the conditional probability of having the event `` 1 '' in the @xmath366th trial conditioned on the first @xmath367 outcomes @xmath368 . in this scenario ,",
    "it is straightforward to show that the random variables given by equation ( [ eq : randomv ] ) are martingale and satisfy the bdc with @xmath359 .",
    "hence , by applying azuma s inequality we have that @xmath369\\leq{2e^{-\\frac{n\\delta^2}{2}}}. \\label{azumainequality}\\end{aligned}\\ ] ] this means , in particular , that @xmath370 except with error probability @xmath371 , where the parameter @xmath372 lies in the interval @xmath373 $ ] with @xmath374 and @xmath375 , and where @xmath376 .",
    "in this appendix we first present the detail of the decoy - state analysis for the intensity fluctuation case and then we summarise all the equations for the decoy - state analysis , including those for the exact intensity control case .",
    "more precisely , we describe the estimation procedure that we use in order to obtain a lower bound on the number of vacuum contributions @xmath171 , and both a lower and an upper bound on the number of single - photon contributions @xmath183 .      here",
    ", we generalise the decoy - state method to cover the case where the source suffers from intensity fluctuations . for this , as already mentioned previously , we shall consider that alice and bob only know the interval @xmath269 $ ] where the intensity @xmath6 lies .",
    "we begin by calculating the mean value @xmath377 .",
    "our starting point is the random variable @xmath378 for the @xmath41th trial when both alice and bob select the @xmath20 basis .",
    "this random variable takes the value @xmath379 if alice chooses the intensity @xmath6 and , moreover , the generated signal is detected by bob ; otherwise it is @xmath380 .",
    "the term @xmath381 reflects the fact that @xmath378 may depend on all the previous @xmath382 trials . with this notation , @xmath377",
    "can be expressed as @xmath383=\\sum^{n_z}_{i=1}p^{(i|\\overrightarrow{i-1})}(k\\wedge\\u{det}|z ) , \\label{zk}\\end{aligned}\\ ] ] where @xmath177 is the number of events where both alice and bob select the @xmath20 basis .",
    "the probability @xmath384 denotes the conditional probability that the event @xmath72 occurs in the @xmath41th trial conditioned on the results obtained in the previous @xmath382 trials , and the term @xmath385 represents the event where alice selects the intensity @xmath6 and bob detects the generated signal given that both of them have chosen the @xmath20 basis . by using bayes rule , we can rewrite equation ( [ zk ] ) as @xmath386 where @xmath387 is the probability that alice chooses the intensity @xmath6 ; @xmath115 denotes an @xmath115-photon signal ; @xmath388 represents the probability of selecting the @xmath20 basis ; and @xmath389 is the probability that the event @xmath72 occurs in the @xmath41th trial .",
    "for instance , @xmath390 is the conditional probability that alice emits an @xmath115-photon state in the @xmath41th trial given that she has chosen the intensity @xmath6 and both alice and bob have selected the @xmath20 basis in the @xmath41th trial .",
    "note that in the transformation from equation ( [ decoyproperty1 ] ) to equation ( [ decoyproperty2 ] ) we have used the property of the decoy - state method _ i.e. , _",
    "@xmath391 .    in so doing",
    ", we obtain that @xmath377 is upper bounded by @xmath392 similarly , we find that @xmath393 _ lower bound on the number of vacuum contributions _ to obtain this bound , we first rewrite equations ( [ up ] ) and ( [ low ] ) for the cases @xmath394 and @xmath395 , respectively .",
    "we obtain the following two inequalities , @xmath396 @xmath397 next , we multiply equation ( [ kd2 ] ) by @xmath398 and equation ( [ kd1 ] ) by @xmath399 , and we add both expressions . in so doing ,",
    "we find that @xmath400 where the second inequality holds because @xmath47 .    as a result",
    ", we find that @xmath171 is lower bounded by @xmath401 to estimate the expectation values @xmath173 and @xmath174 , we use azuma s inequality because each trial of the random variables @xmath402 and @xmath403 may depend on the previous ones . _",
    "lower bound on the number of single - photon contributions _ here , we first particularise equations ( [ up ] ) and ( [ low ] ) for the cases @xmath395 and @xmath394 , respectively .",
    "we have that @xmath404 @xmath405 next , we add both expressions and we obtain @xmath406 this last equation can be rewritten as @xmath407 next , we evaluate the third term on the r.h.s of equation ( [ main ] ) .",
    "this term is lower bounded by @xmath408 because when the conditions @xmath409 , @xmath410 and @xmath48 are satisfied we have that @xmath411(k^-_{\\u{s}})^{n-2}$ ] .",
    "if we now use equation ( [ low ] ) for @xmath412 , we have that @xmath413 the r.h.s of equation ( [ singlez ] ) can be lower bounded using the r.h.s of equation ( [ cies ] ) .",
    "this is so because @xmath414 and therefore the term @xmath415/(k^-_{\\u{s}})^2<0 $ ] in equation ( [ singlez ] ) .",
    "hence , we have that the third term on the r.h.s of equation ( [ main ] ) is lower bounded by @xmath416 . \\label{thirdlower}\\end{aligned}\\ ] ] that is , if we now combine equations ( [ main ] ) and ( [ thirdlower ] ) we find that @xmath417 which directly gives us a lower bound on @xmath183 , @xmath418 .",
    "\\label{tz1}\\end{aligned}\\ ] ]    _ upper bound on the number of single - photon contributions _ by adding equations ( [ kd2 ] ) and ( [ kd1 ] ) , we have that @xmath419 where the second inequality holds because @xmath47 .",
    "this means , in particular , that @xmath183 is upper bounded by @xmath420      here , we summarise all the equations needed in the decoy - state method , including those for the exact intensity control case . _",
    "lower bound on the number of vacuum contributions _",
    "+ let @xmath421 denote a lower bound on the number of events where alice generates a vacuum state using the signal intensity and the basis setting @xmath49 to encode a bit value @xmath422 , and bob observes the bit value @xmath423 when he measures the received signal using the basis @xmath424 .",
    "@xmath425 where the parameters @xmath426 and @xmath427 are defined in a similar way like equations ( [ decoykd2vac ] ) and ( [ decoykd1vac ] ) for the exact intensity control case and like equations ( [ azumanumber1 ] ) and ( [ azumanumber2 ] ) for the intensity - fluctuation case , respectively . the probability @xmath179 is a lower bound on @xmath428 which denotes the probability that alice selects the signal intensity setting and sends a vacuum state . _",
    "lower bound on the number of single - photon contributions _",
    "let @xmath429 denote a lower bound on the number of events where alice prepares a single - photon state using the signal intensity and the basis setting @xmath49 to encode a bit value @xmath422 , and bob observes the bit value @xmath423 when he measures the received signal using the basis @xmath424 .",
    "@xmath430 , \\label{eq : siglegain}\\end{aligned}\\ ] ] where the probability @xmath189 is a lower bound on @xmath431 which denotes the probability that alice selects the signal intensity setting and sends a single - photon state .",
    "_ upper bound on the number of single - photon contributions _",
    "let @xmath432 denote an upper bound on the number of events where alice prepares a single - photon state using the signal intensity and the basis setting @xmath49 to encode a bit value @xmath422 , and bob observes the bit value @xmath423 when he measures the received signal using the basis @xmath424 .",
    "@xmath433 where the probability @xmath434 is an upper bound on @xmath190 .",
    "in this appendix we explain how to derive equation ( [ nphase ] ) .",
    "that is , we obtain an upper bound on the number of phase errors associated to the single - photon pulses emitted by alice when she selects the signal intensity setting , both alice and bob use the @xmath20 basis , and bob obtains a successful detection event ( _ i.e. _ , @xmath435 ) .",
    "as we are interested in the phase error rate defined in the single - photon emission events and all the statistics associated with the single - photons can be estimated using the decoy state method , in the virtual protocol we only consider the cases where alice emits single photons .    for this ,",
    "in the security proof we consider a virtual protocol that based on the complementarity argument  @xcite is equivalent to the actual protocol . in the virtual scheme , alice prepares an ancilla qubit which is entangled with the pulse that she sends to bob .",
    "importantly , from eve s viewpoint both protocols are completely indistinguishable because they emit the same quantum states and announce the same classical information .",
    "let us start our analysis by introducing the following joint states , which we shall denote as @xmath436 .",
    "they are a purification of the signals @xmath437 with @xmath62 ( see equation ( [ tilderho ] ) ) , @xmath438 where the index @xmath439 represents the ancilla system and the index b is the system that alice sends to bob . in addition , we define the state : @xmath440 where the ancilla system @xmath441 stores the bit information . the aim of the virtual protocol is to quantify how accurately bob can estimate alice s measurement outcome if she would measure system @xmath441 in the complementarity basis ( _ i.e. _ , if she would use the povm @xmath442 , where @xmath443 ) .",
    "this way one can characterise the information that eve could have obtained about the raw key  @xcite . note that equation ( [ virstate1 ] ) can be rewritten as @xmath444 where the normalised virtual states @xmath445 , with @xmath62 , are defined as @xmath446}. \\label{ksem}\\end{aligned}\\ ] ]    let us now introduce some additional notation before we describe in detail the different steps of the virtual protocol .",
    "in particular , the states prepared by alice in the virtual protocol are given by @xmath447 where the shield system sh belongs to alice s laboratory , the states @xmath448 have the form @xmath449 and the probabilities @xmath450 are given by @xmath451 also , we define bob s povm for the @xmath20 and the @xmath22 basis measurement as @xmath452 and @xmath453 , respectively . here , the operator @xmath454 corresponds to the inconclusive outcome in the @xmath35 basis .",
    "importantly , in the security analysis we assume that this operator is the same for both basis , _",
    "i.e. , _ @xmath455 .",
    "this assumption allows us to conceptually delay bob s measurement basis choice until he is certain to obtain a conclusive result .",
    "that is , we can consider that bob first conducts a filter operation with kraus operators @xmath456 followed by the @xmath20 or @xmath22 basis measurement , which we redefine as @xmath457 and @xmath458 , respectively .",
    "next we present the steps of the virtual protocol in detail .    _ * virtual protocol * _ alice repeats the first step @xmath459 times , where @xmath459 is the number of single - photon emissions generated by alice in the actual protocol within the set @xmath282 .",
    "preparation _ alice prepares the state @xmath460 given by equation  ( [ mv ] ) .",
    "afterwards , she sends bob system b over a quantum channel and delays her measurement on system sh until step 3 .",
    "filter operation _",
    "bob performs on system b the filter operation @xmath262 and , if this operation succeeds , he stores this system in a quantum memory .",
    "we will denote the set of successful filter results as @xmath461 , and @xmath462@xmath461@xmath463 .",
    "3 .  _ collective measurement _ alice and bob perform on the states in the set @xmath461 a collective measurement characterised by the povm elements @xmath464 , with @xmath465 and @xmath466 ( see equation  ( [ cm1 ] ) ) on the states in the set @xmath461 .",
    "classical communication _",
    "alice announces the @xmath35 basis choice over an authenticated public channel when the result of her measurement in step 3 is @xmath467 .",
    "then , bob announces the @xmath35 basis choice , also over an authenticated public channel , when the measurement outcome in step 3 is @xmath468 to ensure that the classical information declared in both the actual and the virtual protocols coincide ( see the main text below for further details ) . in addition , bob declares the value of @xmath469 when @xmath470 .",
    "_ estimation of the number of phase errors _ alice and bob calculate an upper bound on the number of phase errors .",
    "this upper bound is given by @xmath471 where @xmath472 denotes the number of outcomes associated to the operator @xmath464 after @xmath473 trials , and @xmath474 is an upper bound on @xmath472 .",
    "the size of the set @xmath461 ( see step 2 of the virtual protocol ) is upper bounded by @xmath475 is defined in appendix c. also , the povm elements @xmath464 of alice and bob s collective measurement are given by @xmath476\\otimes{}{m}_{x\\u{s } } \\quad \\quad \\textrm{when $ \\omega\\in\\{1,2,3,4\\}$,}\\nonumber \\\\",
    "{ f}_{5,s}&={p}[{| 5 \\rangle}_{\\u{sh}}]\\otimes{}p_x{m}_{xs},\\nonumber \\\\ { f}_{6,s}&={p}[{| 5 \\rangle}_{\\u{sh}}]\\otimes{}p_z{m}_{zs}. \\label{cm1}\\end{aligned}\\ ] ] these povm elements satisfy @xmath477 .    it is easy to demonstrate that from eve s viewpoint the virtual protocol described above is completely equivalent to the actual protocol .",
    "indeed , the quantum states that alice sends to bob are exactly the same in both protocols . also , both schemes declare precisely the same classical information . to see this last point , let us further clarify the fourth step of the virtual protocol .",
    "in particular , note that when @xmath478 the state that alice sends to bob in the virtual protocol is @xmath479 $ ] and bob uses the @xmath22 basis . however , in this case , alice and bob announce the @xmath20 basis . in so doing ,",
    "the actual and virtual protocols are indistinguishable .",
    "this is so because in the actual protocol the events @xmath480 or @xmath481 are used to generate a secret key , @xmath482 in these events both alice and bob select , and therefore also declare , the @xmath20 basis .",
    "then , the virtual protocol has to do the same declaration , otherwise it could be distinguished from the actual protocol .",
    "that is , with our definition of the virtual protocol we guarantee that it produces precisely the same classical information as the actual protocol .",
    "next , we present the estimation method that we use in order to upper bound the quantities @xmath483 and @xmath484 using experimentally observed values . for this",
    ", we consider the sequence of random variables @xmath485 , with @xmath486 , given by @xmath487 where @xmath488 is the conditional probability of obtaining the values @xmath489 and @xmath469 in the collective measurement performed in the @xmath366th trial of the third step of the virtual protocol , conditioned on the first @xmath367 measurement outcomes from the collective measurements @xmath490 . to obtain this conditional probability",
    "we use the following joint state in @xmath473 trials , @xmath491 where @xmath492 , @xmath493 , and @xmath494 represent , respectively , alice s prepared states in the first @xmath367 trials , in the @xmath366th trial , and in the rest of trials .",
    "let @xmath495 denote eve s unitary transformation on bob s system b and on her system e. we have that @xmath496 where @xmath497 denotes the kraus operator which acts on system b depending on eve s measurement outcome of her ancilla .",
    "now we consider alice and bob s collective measurement .",
    "in particular , let @xmath498 represent the kraus operator associated with the @xmath499th @xmath500 measurement outcome of alice s system sh and bob s system",
    ". also , let @xmath501 denote alice and bob s joint measurement operator up to @xmath367 trials .",
    "it can be written as @xmath502 we shall denote the measurement outcomes of the first @xmath367 trials as @xmath503 . then , after eve s intervention and conditioned on the fact of obtaining the measurement results @xmath503 , we have that the normalised @xmath366th state of alice s system sh and bob s system b , which we shall represent as @xmath504 , is given by @xmath505 where the state @xmath506 has the form @xmath507\\big ) .",
    "\\label{eq : sigma}\\end{aligned}\\ ] ] here , @xmath508 is the trace over all systems except for the @xmath366th systems sh and b. equation  ( [ eq : sigma ] ) can be rewritten as follows : @xmath509\\big)\\nonumber\\\\ & = \\sum_t\\sum_{\\overrightarrow{u-1},\\overrightarrow{n_1-u}}\\u{tr}^{(u)}_{\\u{a_1}}\\big(p [ a^{\\overrightarrow{u-1},\\overrightarrow{n_1-u}}_{t,\\u{b}|o_{u-1}}{| \\phi_u \\rangle}_{\\u{sh , a_1,b}}]\\big),\\end{aligned}\\ ] ] where @xmath510 represents the trace over the @xmath366th @xmath439 system , the states @xmath511 and @xmath512 denote an orthogonal basis for the first @xmath367 systems and the last @xmath513 systems , respectively , and @xmath514 is the kraus operator acting on the @xmath366th system conditioned on the measurement outcomes @xmath503 .",
    "therefore , we obtain that the conditional probability defined in equation ( [ eq : randomvariable ] ) for @xmath515 is given by @xmath516}\\right\\}\\nonumber\\\\ & = \\frac{q(\\omega)}{\\u{tr}\\left[\\mathcal{e}({\\rho}^{\\u{sh , b}}_{u|\\overrightarrow{u-1}})\\right]\\u{tr}({\\sigma}^{\\u{sh , b}}_{u|o_{u-1}})}\\u{tr } \\left[\\mathcal{m}^{(u|\\overrightarrow{u-1})}_{xs}\\u{tr}_{\\u{a_1}}p[{| \\phi^{(\\omega ) } \\rangle}_{\\u{a_1,b}}]\\right]\\nonumber\\\\ & = : q(\\omega)\\u{t}^{(u|\\overrightarrow{u-1})}_{m_{xs}}\\big[\\u{tr}_{\\u{a_1}}{p}[{| \\phi^{(\\omega ) } \\rangle}_{\\u{a_1,b}}]\\big ] , \\label{def : p}\\end{aligned}\\ ] ] where @xmath517 , the probability @xmath518 for @xmath519 , @xmath520 and @xmath521 , the operator @xmath522 , the states @xmath523 are defined in equation  ( [ phiomega ] ) , and @xmath524\\big]$ ] is the @xmath366th conditional probability that bob s measurement outcome in the @xmath22 basis is @xmath466 given that alice sends him the state @xmath525 $ ] and the filter operation succeeds conditioned on the first @xmath367 measurement results . for convenience , we shall refer to @xmath526 $ ] as the transmission rate of @xmath527 .",
    "if we now apply azuma s inequality ( see _ lemma 4 _ in appendix b ) , we obtain @xmath528 except with error probability @xmath529 , where @xmath530 .    by combining this result with that from equation ( [ def : p ] )",
    ", we have that @xmath531\\big ] \\leq\\frac{\\lambda^{(n_1)}_{{\\omega , s}}+\\delta^s_{\\u{a},\\omega}}{q(\\omega)}. \\label{three}\\end{aligned}\\ ] ] note that the parameters @xmath532 , with @xmath533 , can be upper and lower bounded using the decoy - state method .",
    "we shall denote the failure probability of this estimation as @xmath534 , @xmath535 and @xmath536 , respectively .    as a result",
    ", we obtain bounds on @xmath537\\big]$ ] that maximise the number of phase errors @xmath78 in the single - photon emissions within the set @xmath282 .",
    "they are denoted as @xmath538 and have the form @xmath539 @xmath540 @xmath541    when @xmath542 , the quantity @xmath543 $ ] , with @xmath466 , represents the transmission rate of the virtual states @xmath544)$ ] , with @xmath545 given by equation  ( [ ksem ] ) .",
    "this quantity can be decomposed into the transmission rate of the pauli operators @xmath546 and @xmath547 .",
    "however , for later convenience , we will decompose it as a function of @xmath548 and @xmath549 , together with @xmath546 and @xmath217 . here , the states @xmath548 and @xmath549 are defined in equation ( [ filteredstate ] ) . in particular , from equation ( [ ksem ] ) we find that @xmath550 & = \\frac{1}{2\\big[1+(-1)^s\\langle{\\tilde{\\psi}_{0_z}}|\\tilde{\\psi}_{1_z}\\rangle_{\\u{a_1,b}}\\big ] } \\biggl\\ { \\u{t}^{(u|\\overrightarrow{u-1})}_{m_{xs\\oplus{1}}}[\\tilde{\\rho}_{0z}]+\\u{t}^{(u|\\overrightarrow{u-1})}_{m_{xs\\oplus{1}}}[\\tilde{\\rho}_{1z } ] + ( -1)^s\\big(\\u{t}^{(u|\\overrightarrow{u-1})}_{m_{xs\\oplus{1}}}\\big[\\u{tr_b}(p[{| \\tilde{\\psi}_{0_z } \\rangle}{\\langle \\tilde{\\psi}_{1_z } |}_{\\u{a_1,b}}])\\big ] \\nonumber\\\\ & + \\u{t}^{(u|\\overrightarrow{u-1})}_{m_{xs\\oplus{1}}}\\big[\\u{tr_b}(p[{| \\tilde{\\psi}_{1_z } \\rangle}{\\langle \\tilde{\\psi}_{0_z } |}_{\\u{a_1,b}}])\\big]\\big)\\biggr\\ } \\nonumber\\\\ & = \\frac{1}{2\\{1+(-1)^s(\\sqrt{p^{0z}_{0}p^{1z}_{0}}{\\left\\langle \\phi^{0z}_0|\\phi^{1z}_0 \\right\\rangle}+ \\sqrt{p^{0z}_{1}p^{1z}_{1}}{\\left\\langle \\phi^{0z}_1|\\phi^{1z}_1 \\right\\rangle})\\}}\\big [ \\u{t}^{(u|\\overrightarrow{u-1})}_{m_{xs\\oplus{1}}}[\\tilde{\\rho}_{0z } ] + \\u{t}^{(u|\\overrightarrow{u-1})}_{m_{xs\\oplus{1}}}[\\tilde{\\rho}_{1z}]\\nonumber\\\\ & + ( -1)^s\\sum^1_{t=0}\\sqrt{p^{0z}_{t}p^{1z}_{t}}\\big\\{(a^{0z}_ta^{1z}_t+b^{0z}_tb^{1z}_t ) \\u{t}^{(u|\\overrightarrow{u-1})}_{m_{xs\\oplus{1}}}[\\sigma_i]+ ( a^{0z}_tb^{1z}_t+a^{0z}_tb^{1z}_t)\\u{t}^{(u|\\overrightarrow{u-1})}_{m_{xs\\oplus{1}}}[\\sigma_{x}]\\nonumber\\\\ & + ( a^{0z}_ta^{1z}_t - b^{0z}_tb^{1z}_t)\\u{t}^{(u|\\overrightarrow{u-1})}_{m_{xs\\oplus{1}}}[\\sigma_{z } ] \\big ] , \\label{virtualdecomposition}\\end{aligned}\\ ] ] where we have used equation ( [ purestate ] ) in the second equality and see equation ( [ eigenvec ] ) for the definition of @xmath551 and @xmath552 .",
    "in addition , we have that the transmission rate of @xmath553 and @xmath554 can be decomposed using the pauli operators as follows @xmath555 \\\\",
    "\\u{t}^{(u|\\overrightarrow{u-1})}_{m_{xs{\\oplus{1}}}}[\\tilde{\\rho}_{1z}]\\\\   \\u{t}^{(u|\\overrightarrow{u-1})}_{m_{xs{\\oplus{1 } } } } [ \\tilde{\\rho}_{0x } ] \\\\ \\end{array } \\right )   = \\left(\\begin{array}{ccc } 1/2 & r^{0z}_{x}/2 & r^{0z}_{z}/2   \\\\ 1/2 & r^{1z}_{x}/2 & r^{1z}_{z}/2\\\\ 1/2 & r^{0x}_{x}/2 & r^{0x}_{z}/2\\\\\\end{array } \\right )   \\left ( \\begin{array}{ccc } \\u{t}^{(u|\\overrightarrow{u-1})}_{m_{xs{\\oplus{1}}}}[\\sigma_i]\\\\   \\u{t}^{(u|\\overrightarrow{u-1})}_{m_{xs{\\oplus{1 } } } } [ \\sigma_x]\\\\\\u{t}^{(u|\\overrightarrow{u-1})}_{m_{xs{\\oplus{1}}}}[\\sigma_z]\\\\   \\end{array } \\right)=:a\\left ( \\begin{array}{ccc } \\u{t}^{(u|\\overrightarrow{u-1})}_{m_{xs{\\oplus{1}}}}[\\sigma_i]\\\\   \\u{t}^{(u|\\overrightarrow{u-1})}_{m_{xs{\\oplus{1}}}}[\\sigma_{x}]\\\\\\u{t}^{(u|\\overrightarrow{u-1})}_{m_{xs{\\oplus{1}}}}[\\sigma_{z}]\\\\   \\end{array } \\right).\\end{aligned}\\ ] ] hence , the transmission rate of the pauli operators can be described as @xmath556\\\\   \\u{t}^{(u|\\overrightarrow{u-1})}_{m_{xs{\\oplus{1}}}}[\\sigma_x]\\\\\\u{t}^{(u|\\overrightarrow{u-1})}_{m_{xs{\\oplus{1}}}}[\\sigma_z]\\\\   \\end{array } \\right ) = a^{-1}\\left ( \\begin{array}{ccc } \\u{t}^{(u|\\overrightarrow{u-1})}_{m_{xs{\\oplus{1}}}}[\\tilde{\\rho}_{0z } ] \\\\",
    "\\u{t}^{(u|\\overrightarrow{u-1})}_{m_{xs{\\oplus{1}}}}[\\tilde{\\rho}_{1z}]\\\\   \\u{t}^{(u|\\overrightarrow{u-1})}_{m_{xs{\\oplus{1 } } } } [ \\tilde{\\rho}_{0x } ] \\\\",
    "\\end{array } \\right ) , \\label{matrixrelation}\\end{aligned}\\ ] ] where the inverse matrix @xmath557 is given in equation ( [ matrixa ] ) .",
    "now , if we combine equations ( [ virtualdecomposition ] ) , ( [ matrixrelation ] ) and ( [ three ] ) , we obtain that @xmath78 is upper bounded by @xmath558+\\delta^{s\\oplus{1}}_{\\u{a},s+1}\\nonumber\\\\ & = \\sum^1_{s=0 } \\frac{p(s+{1})}{2\\{1+(-1)^s(\\sqrt{p^{0z}_{0}p^{1z}_{0}}{\\left\\langle \\phi^{0z}_0|\\phi^{1z}_0 \\right\\rangle}+",
    "\\sqrt{p^{0z}_{1}p^{1z}_{1}}{\\left\\langle \\phi^{0z}_1|\\phi^{1z}_1 \\right\\rangle})\\}}\\bigg [ \\sum^{n_1}_{u=1}\\u{t}^{(u|\\overrightarrow{u-1})}_{m_{xs\\oplus{1}}}[\\tilde{\\rho}_{0z } ] + \\sum^{n_1}_{u=1}\\u{t}^{(u|\\overrightarrow{u-1})}_{m_{xs\\oplus{1}}}[\\tilde{\\rho}_{1z}]\\nonumber\\\\ & + ( -1)^s\\sum^1_{t=0}\\sqrt{p^{0z}_{t}p^{1z}_{t}}\\big\\{c_{t,0 } \\sum^{n_1}_{u=1}\\u{t}^{(u|\\overrightarrow{u-1})}_{m_{xs\\oplus{1}}}[\\tilde{\\rho}_{0z}]+ c_{t,1}\\sum^{n_1}_{u=1}\\u{t}^{(u|\\overrightarrow{u-1})}_{m_{xs\\oplus{1}}}[\\tilde{\\rho}_{1z } ] + c_{t,2}\\sum^{n_1}_{u=1}\\u{t}^{(u|\\overrightarrow{u-1})}_{m_{xs\\oplus{1}}}[\\tilde{\\rho}_{0x}]\\big\\}\\bigg]+\\delta^{s\\oplus 1}_{\\u{a},s+1}. \\label{n_ph}\\end{aligned}\\ ] ]    finally , by using the results given by equations ( [ azuma3])-([azuma5 ] ) , we find that @xmath559+\\delta^{s\\oplus 1}_{\\u{a},s+1}\\\\ & = : n^{\\u{u}}_{\\u{ph}},\\end{aligned}\\ ] ] except with error probability @xmath560 where @xmath529 is the failure probability that equation ( [ azumaineq ] ) does not hold for @xmath561 and @xmath466 . also , @xmath562 and @xmath536 are the failure probabilities of the decoy state method _ i.e. , _ the failure probabilities of the estimation of @xmath563 and @xmath564 , respectively .",
    "in this appendix we present the calculations used to obtain figs .",
    "[ fig : keyrate1 ] , [ fig : keyrate2 ] and [ fig : keyrate3 ] in the main text .",
    "in particular , we consider that alice sends bob pairs of coherent states of the form @xmath565 , and we set alice s ( bob s ) phase modulation error to @xmath267 ( @xmath566 ) .",
    "also , we assume a gaussian distribution for the intensity fluctuations of the laser within an interval @xmath46 $ ] .",
    "that is , we consider that the probability density function of the fluctuations is given by @xmath567 $ ] , where @xmath321 is the desired value ( _ e.g. _ , @xmath568 , and @xmath569 ) , the dispersion @xmath570 has the form @xmath571 , and the normalisation factor @xmath527 is such that @xmath572 . _ calculation of the parameters @xmath573 and @xmath574 _ for this , we need to obtain @xmath120 for all @xmath121 .",
    "afterwards , we simply apply the procedure described in section  iv.a ( for the exact intensity control case ) and in section  iv.b ( for the intensity fluctuation case ) .",
    "we consider that the total number of pulses sent by alice using the intensity setting @xmath6 is given by @xmath575 , where @xmath73 denotes the total number of transmissions until the conditions in the sifting step of the protocol are met .",
    "the total system loss @xmath576 includes the channel loss and the detection efficiency of bob s detectors .",
    "the conditional probability @xmath577 that bob obtains the bit @xmath62 using the @xmath20 basis given that alice sends him a bit @xmath41 encoded with the intensity @xmath6 and also in the @xmath20 basis can be written as @xmath578\\u{d}k,\\\\ & p^{(k)}(z1|z0)=p_{\\u{d}},\\\\ & p^{(k)}(zj|z1)=\\int^{k^+}_{k^- } p_{\\u{g}}(k)\\big[1-(1-p_{\\u{d } } ) \\exp\\big(-\\frac{\\eta_{\\u{sy}}k(1-(-1)^j\\cos{\\xi})}{2}\\big)\\big]\\u{d}k.\\end{aligned}\\ ] ] the conditional probability @xmath579 that bob interprets the bit value @xmath580 ( after a random assignment of double click events to single clicks events ) when he uses the @xmath20 basis given that alice sends him a pulse with the intensity @xmath6 , prepared in the @xmath20 basis , and encoding the bit value @xmath41 is written as @xmath581 to simulate the misalignment in the optical system we transform this probability as @xmath582 in so doing , we obtain latexmath:[\\ ] ] in this scenario the probability @xmath599 has the form @xmath600 and therefore the quantity @xmath596 can be written as @xmath601rst m , nauerth s and weinfurter h 2011 _ new j. phys . _ * 13 * 073024 + jouguet p , kunz - jacques s , and diamanti e 2013 _ phys .",
    "a _ * 87 * 062313 + bugge a n , sauge s , ghazali a m m , skaar j , lydersen l , and makarov v 2014 _ phys .",
    "lett . _ * 112 * 070503                lo h - k , curty m and qi b 2012 _ phys .",
    "rev . lett_.",
    "* 108 * 130503 ma x , fung c - h f , and razavi m 2012 _ phys .",
    "rev . a _ * 86 * 052305 + wang",
    "x - b , 2013 _ phys .",
    "a_. * 87 * 012320 + xu f , curty m , qi b , and lo h - k 2013 _ new j. phys_. * 15 * 113007 + mizutani a , tamaki k , ikuta r , yamamoto t and imoto n 2014 _ sci .",
    "_ * 4 * 5236 + azuma k , tamaki k and munro w - j 2014 arxiv:1408.2884 curty m , xu f , cui w , lim c c w , tamki k and lo h - k 2014 _ nature commun . _ * 5 * 3732 da silva f t , vitoreti d , xavier g b , do amaral g c , tempor@xmath602o g p and von der weid j p 2013 _ phys .",
    "rev . a _ * 88 * 052303 + rubenok a , slater j a , chan p , lucio - martinez i and tittel w 2013 _ phys . rev . lett . _",
    "* 111 * 130501 + liu y _ et al _ 2013 _ phys .",
    "lett . _ * 111 * 130502 + xu f , qi b , liao z and lo h - k 2013 _ appl .",
    "phys . lett_. * 103 * 061101 + tang z , liao z , xu f , qi b , qian l and lo h - k 2014 _ phys .",
    "lett . _ * 112 * 190503 hwang w y 2003 _ phys . rev . lett_. * 91 * 057901 lo h - k , ma x and chen k 2005 _ phys .",
    "* 94 * 230504 wang x b 2005 _ phys .",
    "lett . _ * 94 * 230503 gottesman d , lo h - k , l@xmath603tkenhaus n and preskill j 2004 _ quantum inf . comput . _ * 4 * 325 lo h - k and preskill j 2007 _ quant . inf .",
    "* 8 * 431 - 458 + tamaki k , lo h - k , fung c - h f , qi b 2012 _ phys .",
    "a _ * 85 * 042307 tamaki k , curty m , kato g , lo h - k and azuma k 2014 _ phys .",
    "a _ * 90 * 052314      mayers d 1996 _ advances in cryptology - proceedings of crypto96 ( berlin : springer ) _ p 343 lo h - k and chau h f 1999 _ science _ * 283 * 2050 shor p w and preskill j 2000 _ phys .",
    "lett . _ * 85 * 441 koashi m 2009 _ new j. phys . _",
    "* 11 * 045018 kraus b , gisin n and renner r 2005 _ phys . rev . lett . _ * 95 * 080501 xu f , sajeed s , kaiser s , tang z , qian l , makarov v and lo h - k 2014 arxiv:1408.3667 ben - or m , horodecki m , leung d w , mayers d , oppenheim j 2005 theory of cryptography : second theory of cryptography conference , tcc 2005 , j.kilian ( ed . ) springer verlag 2005 , vol .",
    "3378 of lecture notes in computer science , pp .",
    "386 - 406 m@xmath603ller - quade j and renner r 2009 _ new j. phys . _",
    "* 11 * 085006 cao z , zhang z , lo h - k and ma x 2014 arxiv : 1410.3217            azuma k 1967 _ tohoku math . j. _ * 19 * 357 boileau j c , tamaki k , batuwantudawe j , laflamme r and renes j m 2005 _ phys",
    "* 94 * 040503 + tamaki k , l@xmath603tkenhaus n , koashi m and batuwantudawe j 2009 _ phys .",
    "a _ * 80 * 032302"
  ],
  "abstract_text": [
    "<S> in recent years , the gap between theory and practice in quantum key distribution ( qkd ) has been significantly narrowed , particularly for qkd systems with arbitrarily flawed optical receivers . </S>",
    "<S> the status for qkd systems with imperfect light sources is however less satisfactory , in the sense that the resulting secure key rates are often overly - dependent on the quality of state preparation . </S>",
    "<S> this is especially the case when the channel loss is high . </S>",
    "<S> very recently , to overcome this limitation , tamaki _ et al _ proposed a qkd protocol based on the so - called `` rejected data analysis '' , and showed that its security  in the limit of infinitely long keys  </S>",
    "<S> is almost independent of any encoding flaw in the qubit space , being this protocol compatible with the decoy state method . here , as a step towards practical qkd , </S>",
    "<S> we show that a similar conclusion is reached in the finite - key regime , even when the intensity of the light source is unstable . </S>",
    "<S> more concretely , we derive security bounds for a wide class of realistic light sources and show that the bounds are also efficient in the presence of high channel loss . </S>",
    "<S> our results strongly suggest the feasibility of long distance provably - secure communication with imperfect light sources . </S>"
  ]
}