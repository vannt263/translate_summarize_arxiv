{
  "article_text": [
    "the large synoptic survey telescope ( lsst ; * ? ? ? * ) will take about 15 tb of image data per night and after ten years of operations will have 15petabytes of catalog data for the final data release and 0.5exabytes of image data . as part of the lsst data management system @xcite , we are writing a suite of software packages to enable these data products to be created with sufficient quality and performance to meet the established science goals @xcite .",
    "development of the lsst pipeline software began in 2004 @xcite , when python was at version 2.3 , and has continued through the research and development phase @xcite into the construction phase @xcite . during these 12 years",
    "the code base has migrated through different versions of python 2 but had not been made compatible with python 3 until this year . in 2004 the expected first light for lsst was 2012 @xcite , and the release of the first `` usable '' version of python 3 ( 3.2 ) was not made until 2011 , so during the early years of project development there was no need to worry about future python developments .",
    "now the astronomy computing environment is beginning to change and python 3 is becoming more familiar to the community",
    ". there were some key motivators for lsst to support python 3 : ( a ) the official statement from the python developers is that python 2.7 support will be dropped in 2020 .",
    "this is before the official start of the lsst survey and we do not want to commission software where the key executable under - pinning the entire system will soon lose support . ( b ) lsst has external users of our software that provide early beta testing services and we do not want to actively impede those users from migrating to a more modern python .",
    "( c ) astropy recently declared that it would do bugfix - only maintenance releases supporting python 2 after 2017 , and that subsequent major releases would be python 3 only @xcite , joining ipython , pandas , sunpy and matplotlib .",
    "this declaration will motivate the community , and furthermore , lsst dm recently decided to integrate astropy into our pipelines code @xcite .",
    "a key requirement for this initial port was that our pipeline code that is used by external users must support both python 2.7 and python 3 .",
    "the python community has developed a number of schemes for handling this and we looked at both ` six ` ( used by astropy ) and ` future ` .",
    "we decided on ` future ` because the resulting code looks almost exactly like python 3 code , in many cases the code can run on python 3 without ` future ` being installed , and the ` futurize ` command provides an easy migration path .",
    "before modernizing the code , we took the opportunity to tidy it using the ` autopep8 ` tool to fix simple whitespace inconsistencies .",
    "this includes replacing tabs with spaces as python 3 no longer allows a mix of tab and space indents .",
    "the eventual aim is to run the ` flake8 ` tool on all code submissions to allow code reviewers to focus on architectural and algorithmic issues rather than being distracted by coding standard violations .",
    "the next step was to run the ` futurize ` stage 1 command in order to modernize the codebase to use python 2.7 features .",
    "this step adds no additional dependencies but is an important modernization required before supporting python 3 . in our code",
    "the main modernizations were enabling print as a function and absolute import from ` _ _ future _ _ ` , using the ` in ` operator rather than ` has_key ( ) ` and also modernizing exception handling to use the `` ` except exception as e ` '' syntax rather than the older `` ` except exception , e ` '' form .",
    "the final automated phase is to run the stage 2 ` futurize ` command .",
    "this command is used to make an initial pass on python 3 compatibility by scanning each file to determine which compatibility imports are need .",
    "the ` 2to3 ` tool is used internally , but with the addition of new shim imports that are no - ops on python 3 but which change the behavior of builtins on python 2 to match those in python 3 . additionally , we had a number of places that used the ` map(filter(lambda ... ) ) ` construct and these are automatically replaced with list comprehensions .",
    "[ [ lists - versus - iterators ] ] lists versus iterators + + + + + + + + + + + + + + + + + + + + + +    the ` futurize ` command is very defensive .",
    "if it sees a construct that resulted in a ` list ` in python 2 but which now returns a view or iterator , the command will wrap it with a ` list ` . in some cases",
    "this is correct , but in many cases it is suboptimal , therefore some amount of inspection is required to decide on each case . a common example is where a loop is written as `` ` for i in a.keys ( ) : ` '' .",
    "this is converted to `` ` for i in list(a.keys ( ) ) ` : '' rather than the more idiomatic `` ` for i in a : ` '' .    [",
    "[ bytes - versus - characters ] ] bytes versus characters + + + + + + + + + + + + + + + + + + + + + + +    the main difficulty in supporting python 2 and 3 is that python 2 has a very relaxed attitude to bytes , characters and unicode .",
    "python 3 has very well - defined semantics distinguishing bytes from characters and any code that deals with the output from external commands ( ` subprocess.check_output ` for example ) or that needs to distinguish binary files from text files ( in our case ` pickle ` files ) must properly decode the bytes to characters . in some cases",
    "the function is really working with bytes and does not want characters at all .",
    "one complication we had revolved around our swig @xcite interface . by default in python 2 swig treats bytes as ` std::string ` and does not map ` unicode ` strings .",
    "we enabled the setting to allow ` unicode ` to also map to ` std::string ` but in some cases our c++ apis were expecting bytes and had to have explicit swig interfaces created to prevent them being treated as valid unicode byte representations .",
    "sometimes this assumption triggered a segmentation fault .",
    "[ [ str ] ] ` str ` + + + + +    a python 3 ` str ` is a unicode string , similar to a python 2 ` unicode ` . the ` future ` package provides a ` str ` that can be used on python 2 that emulates that found on python 3 , and for our initial migrations we accepted these changes from the ` futurize ` command . as we convert more code",
    ", we are realizing that since we are not using any unicode features , switching to a python 3-compatible ` str ` is not important .",
    "furthermore , it is actively breaking code .",
    "for example , unless ` unicode_literals ` is enabled , literal strings in python 2 are standard python 2 ` str ` objects but the strings created with ` str ` are not . if some of the code is using native ` str ` but the rest is using ` future ` ` str ` any use of ` isinstance(var , str ) ` can return ` false ` even if the supplied variable looks like a string to the developer . to overcome some of these confusions on python 2",
    "` basestring ` is required in ` isinstance ` calls and this must be imported from ` past.builtins ` to allow the code to work on python 3 .",
    "we may have to reassess our usage of the ` future ` ` str ` .",
    "[ [ long ] ] ` long ` + + + + + +    much of our code was explicitly using the ` long ` integer type , both as a constructor ( ` long ( ) ` ) and for literals ( e.g.  ` 0l ` ) .",
    "python 3 does not support the ` l ` syntax and these must be removed and be replaced with ` long ( ) ` . in some cases we decided to use the ` future ` package ` past.builtins ` to import a ` long ( ) ` constructor in python 3 ( an alias of the normal ` int ( ) ` ) whilst retaining the standard python 2 semantics . in reality , this was not required since our code was using ` long ( ) ` to indicate a 64-bit integer , and on 64-bit systems , python 2 uses 64-bit integers ( our code base used to run on 32-bit but that is no longer supported ) .",
    "it took us a while to realize this , and we have started removing the explicit use of ` long ( ) ` .",
    "this has led to us also clarifying some of our python / c++ interfaces to remove the assumption that a python ` int ` type maps to a 32-bit c++ integer and a python ` long ` maps to a 64-bit c++ integer .",
    "[ [ version - dependent - code ] ] version - dependent code + + + + + + + + + + + + + + + + + + + + + +    the success of the ` future ` abstraction can be seen in how few places there are in the code that require specific python version tests .",
    "currently , there is one place where the ` encoding ` argument is needed in ` pickle.load ` to load a python 2 ` pickle ` file .",
    "there is one test that is disabled on python 2 because python 2 can not indicate to the c++ interface that there is any difference between bytes and characters .",
    "there is one place that needs to know whether a function is associated with a builtin ( ` _ _ builtins _ _ ` on 2 and ` builtins ` on 3 ) .",
    "the most complex problem we encountered was handling classes that use multiple inheritance of two classes which themselves define their own metaclasses ( in our case these were ` collections.userdict ` and ` yaml.yamlobject ` .",
    "this is not allowed in python 3 without defining a new metaclass that derives from both the relevant types .",
    "the syntax differences meant that the class definitions had to occur in versioned code branches .",
    "the imports from ` past.builtins ` will be removed when support for python 2 is dropped ( replacing ` basestring ` with ` str ` and ` long ` with ` int ` ) .",
    "as of october 2016 , approximately 45 lsst science pipelines packages have been converted to support both python 2 and python 3 , with about 10 packages still remaining .",
    "we have jenkins continuous integration jobs running daily on multiple operating systems and multiple python versions to ensure that python 2-specific code does not slip back into the codebase .",
    "more detailed instructions on our process can be found in @xcite .",
    "we hope to complete this work before the end of the year .",
    "other data management code , including qserv @xcite and the data access libraries , will be migrated over the coming winter .",
    "we may decide to drop python 2 support for these as it is mostly server code and the migration to python 3 is made significantly easier if support for 2 is not required .",
    "i thank russell owen and fred moolekamp for comments on the draft .",
    "the lsst software stack is the result of the efforts of the many people who are part of the data management team at lsst , as well as outside contributors .",
    "this material is based upon work supported in part by the national science foundation through cooperative agreement 1258333 managed by the association of universities for research in astronomy ( aura ) , and the department of energy under contract no .",
    "de - ac02 - 76sf00515 with the slac national accelerator laboratory .",
    "additional lsst funding comes from private donations , grants to universities , and in - kind support from lsstc institutional members ."
  ],
  "abstract_text": [
    "<S> the lsst data management science pipelines software consists of more than 100,000 lines of python 2 code . </S>",
    "<S> lsst operations will begin after support for python 2 has been dropped by the python community in 2020 , and we must therefore plan to migrate the codebase to python 3 . during the transition period </S>",
    "<S> we must also support our community of active python 2 users and this complicates the porting significantly . </S>",
    "<S> we have decided to use the python ` future ` package as the basis for our port to enable support for python 2 and python 3 simultaneously , whilst developing with a mindset more suited to python 3 . in this paper </S>",
    "<S> we report on the current status of the port and the difficulties that have been encountered . </S>"
  ]
}