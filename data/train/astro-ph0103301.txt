{
  "article_text": [
    "advances in computational algorithms combined with the steady advance of computer technology have made it possible to simulate regions of the universe with unprecedented dynamic range @xcite .",
    "realistic simulations of galaxy formation require spatial resolution better than 1 kpc and mass resolution better than @xmath0 in volumes at least 100 mpc across containing more than @xmath1 .",
    "cosmologists have made significant progress towards these requirements . in simulations of dark matter halos , @xcite and @xcite",
    "have achieved more than 4 orders of magnitude in spatial resolution while the virgo consortium has performed simulations with @xmath2 particles @xcite .",
    "recently , @xcite have performed a simulation of the formation of the first subgalactic molecular clouds using adaptive mesh refinement with a spatial dynamic range of 262,144 and a mass dynamic range more than @xmath3 .",
    "the possibility to resolve numerically such vast dynamic ranges of length and mass begs the question of what are the appropriate initial conditions for such simulations .",
    "hierarchical structure formation models like the cold dark matter ( cdm ) family of models have increasing amounts of power at smaller scales .",
    "this power should be present in the initial conditions . for simulations of",
    "spatially constant resolution , this is straightforward to achieve using existing community codes @xcite .",
    "however , workers increasingly are using multiscale methods in which the best resolution is concentrated in only a small fraction of the simulation volume .",
    "how should multiscale simulations be initialized ?",
    "many workers currently initialize multiscale models following the approach of @xcite .",
    "first , a gaussian random field of density fluctuations ( and the corresponding irrotational velocity field ) is sampled on a cartesian lattice of fixed spacing @xmath4 .",
    "then , @xmath4 is decreased by an integer factor @xmath5 and a new gaussian random field is sampled with @xmath6 times as many points , such that the low - frequency fourier components ( up to the nyquist frequency @xmath7 in each dimension ) agree exactly with those sampled on the lower - resolution grid .",
    "this method has two drawbacks .",
    "first , it is limited by the size of the largest fast fourier transform ( fft ) that can be performed , since the gaussian noise is sampled on a uniform lattice in fourier space .",
    "this represents a severe limitation for adaptive mesh refinement codes which are able to achieve much higher dynamic range .",
    "second , the uniform high - frequency sampling on the fine grid is inconsistent with the actual sampling of the mass used in the evolutionary calculations .",
    "multiscale simulations have grid cells , hence particle masses , of more than one size .",
    "the gravitational field produced by a distribution of unequal particle masses differs from that produced with constant resolution . in the linear regime ,",
    "the velocity and displacement should be proportional to the gravitational field . with the method of @xcite ,",
    "they are not .",
    "we are challenged to develop a method for sampling multiscale gaussian random fields consistent with the multiresolution sampling of mass .",
    "a satisfactory method should satisfy several requirements in addition to correctly accounting for variable mass resolution .",
    "first , each refined field should preserve exactly the discretized long - wavelength amplitude and phase so as to truly refine the lower - resolution sample .",
    "second , high - frequency power should be added in such a way that the multiscale fields are an exact sample from the power spectrum over the whole range of wavelengths sampled . because multiscale fields are not sampled on a uniform lattice ,",
    "it is not the power spectrum but rather than spatial two - point correlation function that should be exactly sampled .",
    "finally , a practical method should have a memory requirement and computational cost independent of refinement so that it is not limited by the size of the largest fft that can be performed .",
    "this paper presents the analytic theory and practical implementation of multiscale gaussian random field sampling methods that meet these requirements .",
    "our algorithms are the equivalent of adaptive mesh refinement applied to gaussian random fields .",
    "the mathematical properties of such fields are simple enough so that an exact algorithm may be developed .",
    "practical implementation requires certain approximations to be made but they can be evaluated and the errors controlled .",
    "the essential idea enabling this development is that gaussian random fields can be sampled in real space rather than fourier space ( hereafter @xmath8-space ) .",
    "adaptive mesh refinement can then be performed in real space conceptually just as it is done in the nonlinear evolution code used by @xcite .",
    "how can the long - range correlations of gaussian random fields be properly accounted for in real space ? in an elegant paper , @xcite pointed out that any gaussian random field ( perhaps subject to regularity conditions such as having a continuous power spectrum ) sampled on a lattice can be written as the convolution of white noise with a function that we will call the transfer function .",
    "salmon recognized the advantages of multiresolution initial conditions and developed a tree algorithm to perform the convolutions .",
    "tree algorithms have the advantage that they work for any mesh ",
    "regular , hierarchical , or unstructured .",
    "next , @xcite pointed out that ffts may be used to perform the convolutions in such a way that the two - point correlations of the sampled fields are exact , in contrast with the usual @xmath8-space methods which produce exact power spectra but not two - point correlations .",
    "the key is that the transfer functions may be evaluated in real space accurately at large separation free from distortions caused by the discretization of @xmath8-space .",
    "pen also pointed out that this method allows the mean density in the box to differ from the cosmic average , and that the method could be extended to hierarchical grids .",
    "this paper builds upon the work of @xcite and @xcite as well as the author s earlier cosmics package @xcite , which included a module called grafic ( gaussian random field initial conditions ) .",
    "grafic implemented the standard @xmath8-space sampling method for generating gaussian random fields on periodic rectangular lattices .",
    "this paper presents the theory and computational methods for a new package for generating multiscale gaussian random fields for cosmological initial conditions called grafic2 .",
    "this paper contains the fine print for the owner s manual to grafic2 , as it were .",
    "this paper is organized as follows . ",
    "[ sec : method ] reviews the mathematical method for generating gaussian random fields through convolution of white noise including adaptive mesh refinement . ",
    "[ sec : transf ] presents methods for the all - important computation of transfer functions . ",
    "[ sec : implem ] presents important details of implementation .",
    "exact sampling requires careful consideration of both the short - wavelength components added when a field is refined (  [ sec : short ] ) as well as the long - wavelength components interpolated from the lower - resolution grid (  [ sec : long ] ) .",
    "as we show , the long - wavelength components must be convolved with the appropriate anti - aliasing filter .",
    "truncation of this filter to a subvolume ( a step required to avoid intractably large convolutions ) introduces errors that we analyze and reduce to the few percent level in  [ sec : fixv ] .",
    "the method is extended to hierarchical grids in  [ sec : multiple ] . ",
    "[ sec : tricks ] presents additional tricks with gaussian random fields made possible by the white noise convolution method . ",
    "[ sec : end ] summarizes results and describes the public distribution of the computer codes developed herein for multiscale gaussian random fields .",
    "the starting point is the continuous fourier representation of the density fluctuation field : @xmath9 where @xmath10 is gaussian white noise with power spectrum @xmath11 here @xmath12 is the dirac delta function and we are assuming that space is euclidean .",
    "the function @xmath13 is the transfer function relative to white noise , and it is related simply to the power spectrum of @xmath14 : @xmath15^{1/2}\\ .\\ ] ] note that @xmath16 and @xmath13 both have units of @xmath17^ { 3/2}$ ] and that @xmath13 is an ordinary function while @xmath16 is a stochastic field ( a distribution ) .",
    "the next step is to recognize that equation ( [ delft ] ) can be written as a convolution @xcite : @xmath18 where @xmath19 and @xmath20 the spatial two - point correlation function of @xmath14 is simply @xmath21 .",
    "thus , we may construct an arbitrary gaussian random field by the convolution of white noise with a convolution kernel determined by the power spectrum .",
    "the white noise process is formally divergent ; from equation ( [ wiener2 ] ) , @xmath10 is drawn from a gaussian distribution with infinite variance .",
    "this strange behavior arises because we are including contributions from all scales and @xmath10 is ultraviolet - divergent",
    ". physically this divergence may be cut off by the power spectrum , although the standard cold dark matter spectrum still leads to a logarithmic divergence of the dark matter density fluctuations at small scales . in practice",
    "the integral is cut off at high wavenumber by discretizing space with a finite cell size .",
    "the standard method for generating gaussian random fields relies on discretizing equation ( [ delft ] ) with a cartesian mesh in a finite parallelpiped with periodic boundary conditions .",
    "the spatial dynamic range is then limited by the size of the largest fft that can be performed .",
    "the fourier domain is used because the random variables at different points are statistically independent aside from the condition @xmath22 required to enforce reality of @xmath14 . in the spatial domain , @xmath14 has long - range correlations that are difficult to sample unless one first goes to fourier space .",
    "the velocity field ( or displacement field , in the case of dark matter particles ) obeys similar equations ; only the transfer function @xmath13 is modified .",
    "the convolution method described in this paper evaluates the density and velocity fields using equation ( [ delcon ] ) instead of equation ( [ delft ] ) .",
    "it relies on the fact that white noise is uncorrelated in the spatial domain as well as the fourier domain , hence there is no difficulty in sampling @xmath10 .",
    "once we have such a sample , it is unnecessary to use a single enormous fft to evaluate the convolution equation ( [ delcon ] ) . tree algorithms may be used @xcite or multiple ffts with appropriate boundary conditions @xcite .",
    "the algorithm we develop extends the ideas of pen .",
    "the heart of our method lies in the discretization of equations ( [ delft])-([wiener2 ] ) and their application to density fields with spatially variable resolution .",
    "the density field is represented on a hierarchy of nested cartesian grids so that fft methods can be used to perform the convolutions .    before describing convolution with spatially variable resolution",
    ", we first describe the discrete convolution method for a single grid of @xmath23 points per dimension . for simplicity of presentation",
    "we assume here a cube of length @xmath24 with periodic boundary conditions , although the code that implements the convolution is generalized to allow any parallelpiped .",
    "the grid positions are @xmath25 where @xmath26 is an integer triplet with components @xmath27 .",
    "equation ( [ delft ] ) becomes @xmath28 where @xmath29 is the dimensionless wavenumber ; it is an integer or half - integer triplet with components @xmath30 .",
    "the dimensionless transfer function and spectral noise appearing in equation ( [ delfft ] ) are given by @xmath31^{1/2 } , \\ \\",
    "\\xi(\\vec k\\,)=m^{-3}\\sum_{\\vec m}\\exp\\left(-{i2\\pi\\over m}\\vec\\kappa      \\cdot\\vec m\\,\\right)\\,\\xi(\\vec m\\,)\\ , \\ ] ] where @xmath32 is white noise with variance @xmath33 : @xmath34 the subscript k denotes the kronecker delta .    the discrete convolution algorithm proceeds through the following steps .    1",
    ".   sample @xmath32 by generating independent , zero - mean normal deviates with variance @xmath33 at each spatial grid point .",
    "2 .   use the fft algorithm to evaluate the second of equations ( [ discpow ] ) .",
    "3 .   multiply @xmath16 by the discrete transfer function @xmath13 .",
    "4 .   use the fft algorithm to evaluate equation ( [ delfft ] ) .",
    "the result is a discrete approximation to equation ( [ delft ] ) .",
    "so far , this method is identical to the usual one for generating gaussian random fields @xcite except that an extra fft is introduced by sampling @xmath32 in real space instead of fourier space .",
    "this requires more computation but is crucial when we extend the method to a multiscale hierarchy , which we do next .",
    "= 0.1 in    ( 32,32 ) ( 0,0)(4,0)9 ( 0,4)(4,0)9 ( 0,8)(4,0)9 ( 0,12)(4,0)9 ( 0,16)(4,0)9 ( 0,20)(4,0)9 ( 0,24)(4,0)9 ( 0,28)(4,0)9 ( 0,32)(4,0)9 ( 9.89,10.07)(1,0)12@xmath35 ( 9.89,11.07)(1,0)12@xmath35 ( 9.89,12.07)(1,0)12@xmath35 ( 9.89,13.07)(1,0)12@xmath35 ( 9.89,14.07)(1,0)12@xmath35 ( 9.89,15.07)(1,0)12@xmath35 ( 9.89,16.07)(1,0)12@xmath35 ( 9.89,17.07)(1,0)12@xmath35 ( 9.89,18.07)(1,0)12@xmath35 ( 9.89,19.07)(1,0)12@xmath35 ( 9.89,20.07)(1,0)12@xmath35 ( 9.89,21.07)(1,0)12@xmath35    suppose that we have two - level grid hierarchy as shown in figure [ fig : amr ] .",
    "now the spatial grid point positions in the refined volume are given by two integer triplets , @xmath26 for the coarse grid and @xmath36 for the subgrid : @xmath37 the subgrid is refined by an integer factor @xmath5 , with @xmath38 .",
    "an offset @xmath39 is applied to center the refinement . as a result of mesh refinement ,",
    "each coarse grid cell is split up into @xmath6 subcells .",
    "suppose that we already have a sample of white noise on the coarse grid , @xmath40 .",
    "convolution by the appropriate transfer function using equations ( [ delfft ] ) and ( [ discpow ] ) then gives the density field @xmath41 . to refine the sampling ,",
    "we generate a mesh - refined white - noise sample @xmath42 and convolve it with a higher - resolution transfer function .",
    "the refined white - noise sample @xmath42 should retain the same low - frequency structure as the coarse - grid sample @xmath43 .",
    "we ensure this by choosing @xmath42 to be a sample of gaussian white noise subject to the linear constraint @xmath44 the constraint is easy to apply using the hoffman - ribak algorithm @xcite .",
    "one simply generates an unconstrained white noise sample @xmath45 with variance @xmath46 and then applies a linear correction to enforce equation ( [ xicon ] ) : @xmath47 the sample so generated is gaussian white noise satisfying the constraint equation ( [ xicon ] ) and having the desired covariance @xmath48    equation ( [ xisamp ] ) has a simple interpretation .",
    "mesh refinement takes place by splitting each coarse cell ( labelled by @xmath49 ) into @xmath6 subcells .",
    "the coarse - grid white noise value @xmath50 is first spread to each of the subcells , then a high - frequency correction @xmath51 is added .",
    "our method requires performing several convolutions over the subgrid . in this subsection",
    "we describe the method for a generic high - resolution convolution , which is first expressed in fourier space as follows : @xmath52\\,t(k)\\xi(\\vec k\\,)\\ .\\ ] ] the sum is taken over the extended fourier space of size ( @xmath53 .",
    "this fourier space extends to wavenumbers @xmath54 times greater than that of equation ( [ delfft ] ) .",
    "we can write the wavevector using two integer ( or half - integer ) triplets , @xmath55 and @xmath56 : @xmath57 where @xmath58 and @xmath59 $ ] .",
    "the set of all @xmath55 for a given @xmath56 is called a brillouin zone .",
    "the coarse grid corresponds to the fundamental brillouin zone , @xmath60 .",
    "mesh refinement extends the coverage of wavenumber space by increasing the number of brillouin zones to @xmath6 where @xmath54 is the refinement factor .",
    "the major technical challenge of our algorithm is to perform the convolution of equation ( [ congen1 ] ) without storing or summing over the entire fourier space .",
    "this is possible when @xmath61 is required over only a subgrid in the spatial domain .",
    "the first step is to note that equation ( [ congen1 ] ) is equivalent to @xmath62 where @xmath63      \\,\\xi(\\vec k\\,)\\ , \\quad    t(\\vec m,\\vec n\\,)=(rm)^{-3}\\sum_{\\vec k}\\exp[i\\vec k\\cdot\\vec x(\\vec m ,      \\vec n\\,)]\\,t(k)\\ .\\ ] ]    now , mesh refinement is performed only over the subgrid of size @xmath64 where @xmath65 , so it is not necessary to evaluate @xmath42 and @xmath66 for all @xmath46 high - resolution grid points .",
    "we set @xmath67 outside of the subgrid volume .",
    "consequently , @xmath66 needs to be evaluated only to distances of @xmath68 grid points in each dimension in order that all contributions to @xmath69 be included .",
    "we will describe how the transfer functions @xmath66 are computed in the next subsection .",
    "the function @xmath42 must also be evaluated on the subgrid . because this is a sample of white noise",
    ", we simply draw independent real gaussian random numbers with zero mean and variance @xmath46 at each grid point . subtracting a mean over coarse grid cells ( eq . [ xisamp ] ) or imposing any other desired linear constraints ( using the hoffman - ribak method )",
    "is easily accomplished .",
    "once we have @xmath42 and @xmath66 on the subgrid , the next step is to fourier transform them . for simplicity in presentation ,",
    "let us suppose that the subgrid is cubic with @xmath70 where @xmath71 is the number of coarse grid points that are refined in each dimension .",
    "the result is @xmath72 where the sums are taken over the fine grid points in the subvolume , which has been doubled to the accommodate periodic boundary conditions required by fourier convolution .",
    "primes are placed on the wavevectors and on the transformed quantities to distinguish them from the original quantities @xmath16 and @xmath13 .",
    "note that the sampling of @xmath8-space is different in equations ( [ congen3 ] ) and ( [ congen4 ] ) because the length of the spatial grid has changed from @xmath24 to @xmath73 . also , @xmath74 is in general not spherically symmetric even if @xmath75 is spherical .",
    "the final step is to perform the convolution by multiplication in the subgrid @xmath8-space followed by fourier transformation back to real space : @xmath76 the reader may verify that equations ( [ congen4 ] ) and ( [ congen5 ] ) give results identical to equations ( [ congen1 ] ) and ( [ congen2 ] ) , when @xmath10 is zero outside of the subvolume .",
    "thus , we have achieved the equivalent of convolution on a grid of size @xmath46 by using a ( typically smaller ) grid of size @xmath77 .",
    "note well that @xmath78 is not the same as @xmath79 , because it is based on spatially truncating @xmath66 and making it periodic on a grid of size @xmath73 instead of @xmath24 .",
    "so far the method looks straightforward .",
    "however , some practical complications arise which will discuss later , in the computation of the transfer functions in real space (  [ sec : transf ] ) and in the split of our random fields into long- and short - wavelength parts on the coarse and fine grids , respectively (  [ sec : long ] ) .",
    "finally , we note that we will perform the convolution of equation ( [ congen1 ] ) using a grid of size @xmath80 in each dimension in the standard way using ffts without requiring periodic boundary conditions for the subgrid of size @xmath81 .",
    "we calculate the transfer functions in the first octant of size @xmath82 and then reflect them periodically to the other octants using reflection symmetry ( odd along the direction of the displacement , otherwise even ) . in order to achieve isolated boundary conditions ,",
    "the white noise field is filled in one octant and set to zero in the other octants .",
    "if we desire to have periodic boundary conditions ( e.g. for testing ) , we can set @xmath83 and fill the full refinement grid of size @xmath77 with white noise .",
    "the convolution method requires calculating the transfer functions @xmath84 for density , velocity , etc .",
    ", on a high resolution grid @xmath85 of extent @xmath86 grid points in each dimension . the transfer function is given in the continuous case by equations ( [ transferk ] ) and ( [ transferx ] ) and in the discrete case by the first of equations ( [ discpow ] ) and the second of equations ( [ congen3 ] ) .",
    "our challenge is to compute the transfer functions on the subgrid without performing an fft of size @xmath46 , under the assumption that the problem is too large to fit in the available computer memory .",
    "also , we wish to avoid a naive summation of the second of equations ( [ congen3 ] ) , which would require @xmath87 operations . in practice , @xmath54 will be a modest - size integer ( from 2 to 8 , say ) while @xmath71 will be much larger , of order @xmath88 .",
    "we present three solutions to this challenge .",
    "the first two are based , respectively , on three - dimensional discrete fourier transforms while the third is based on a spherical transform .      the first method is equivalent to the second of equations ( [ congen3 ] ) and is therefore exact in the sense of yielding the same transfer functions as if we had used full resolution on a grid of size @xmath46 . note that @xcite would call this method approximate because , after the fft to the spatial domain , the results differ from the exact spatial transfer function of equation ( [ transferx ] ) .",
    "we will say more about this in  [ sec : spherical ] , but note simply that the discretization of @xmath8-space required for the fft makes it impossible for the transfer function to be exact in both real space and @xmath8-space .",
    "the transfer function of this subsection is exact in @xmath8-space and is equivalent to the usual @xmath8-space sampling method .",
    "we rewrite the second of equations ( [ congen3 ] ) as @xmath89 where @xmath90      \\,t(\\vec k\\,)\\ .\\ ] ] the fourier space is split into brillouin zones according to equation ( [ kgrid ] ) .",
    "beware that the symbol @xmath79 has three different uses here which are distinguished by its arguments : it is either the transfer function in real space @xmath66 , the transfer function in fourier space @xmath75 , or else the mixed fourier / real case @xmath91 .",
    "equation ( [ transkx1 ] ) is a simple fft of size @xmath33 .",
    "this is the same size as is used for generating the coarse grid initial conditions , so it is tractable .",
    "however , we save the results only at those coarse grid points @xmath26 that lie in the refinement subvolume , discarding the rest . by performing some unnecessary computation",
    ", the fft reduces the number of operations required to compute this sum for all @xmath36 from @xmath92 to @xmath93 , a substantial savings .",
    "equation ( [ transkx2 ] ) is also a fft , in this case of size @xmath6 .",
    "however , we can not evaluate both equations ( [ transkx1 ] ) and ( [ transkx2 ] ) using ffts without storing @xmath94 for all @xmath46 points . in order to reduce the storage to a tractable amount ( no more than the larger of @xmath33 and @xmath95 )",
    ", we must perform an outer loop over @xmath36 to evaluate @xmath96 . for each @xmath36 , we must compute @xmath94 for all @xmath55 , requiring direct summation in equation ( [ transkx2 ] ) . the operations",
    "count for all @xmath36 is then @xmath97 , which dominates over the @xmath93 for equation ( [ transkx1 ] ) .",
    "the operations count for equation ( [ transkx2 ] ) can be reduced by a factor of up to 6 by using symmetries when @xmath75 is spherically or azimuthally symmetric .",
    "nonetheless , if we use this method , computation of the transfer functions is generally the most costly part of the whole method .",
    "if the transfer function falls off rapidly with distance in real space , there is another way to evaluate @xmath66 that is much faster .",
    "it is based on noting that the fourier sum is an approximation to the fourier integral , and another approximation is given by simply changing the discretization in @xmath8-space .",
    "in equation ( [ congen3 ] ) , the step size in @xmath8-space is @xmath98 where @xmath24 is the full size of the simulation volume .",
    "if we increase this step size to @xmath99 , the transfer function @xmath75 will be evaluated with exactly the sampling needed for @xmath74 in equation ( [ congen5 ] ) . in this case",
    "we do nt even need to transform @xmath75 to the spatial domain , truncate and periodize on the subgrid to give @xmath66 , and then transform back to get @xmath74 .",
    "we simply replace @xmath78 with @xmath79 in fourier space .",
    "this is exactly equivalent to decreasing the @xmath8-space resolution in equation ( [ congen3 ] ) to the minimum needed to sample @xmath66 on the subgrid .",
    "this method is extremely fast but its speed comes with a cost .",
    "low wavenumbers are sampled poorly compared with equations ( [ transkx1 ] ) and ( [ transkx2 ] ) , and the transfer functions are truncated in a cube of size @xmath73 instead of @xmath24 . the decreased @xmath8-space sampling leads to significant real - space errors for distances comparable to the size of the box .",
    "this may be tolerable for the density but is unacceptable for the velocity transfer function . in  [ sec : long ] we will introduce anti - aliasing filters for the coarse grid for which the minimal @xmath8-space sampling method is well - suited . in  [ sec : multiple ] we will revisit the use of the minimally sampled transfer function for the density field .",
    "another fast method can be used when @xmath75 is spherically symmetric , as it is for the density and the radial component of displacement . in this case",
    "we approximate the second of equations ( [ congen3 ] ) as a continuous fourier integral , @xmath100 aside from units , this is essentially the same as equation ( [ transferx ] ) .",
    "the last integral in equation ( [ transkx3 ] ) can be performed by truncating the fourier integral at the nyquist frequency of the subgrid , @xmath101 and then using a one - dimensional fft .",
    "the method is much faster than equations ( [ transkx1 ] ) and ( [ transkx2 ] ) .",
    "the fourier integral of equation ( [ transkx3 ] ) can be evaluated accurately , yielding an essentially exact transfer function in real space .",
    "this approach was advocated by @xcite .",
    "however , this is not necessarily the best approach for cosmological simulations with periodic boundary conditions . in order to achieve periodic boundary conditions , such simulations",
    "compute the gravitational fields with @xmath8-space discretized at low frequencies as in the second of equations ( [ congen3 ] ) . in this case",
    "it would be inconsistent to use equation ( [ transkx3 ] ) on the top - level grid with periodic boundary conditions  the displacement field would not be proportional , in the linear regime , to the gravity field computed by the poisson solver of the evolution code .",
    "however , the spherical method is satisfactory for refinements without periodic boundary conditions .      in order to use equation ( [ transkx3 ] ) ,",
    "the transfer function must be spherically symmetric .",
    "this seems natural for the density field given that the power spectrum @xmath102 is isotropic .",
    "however , the standard fft - based method for computing samples of the density field violates spherical symmetry through the cartesian discretization of @xmath8-space . as we noted above , periodic boundary conditions",
    "are inconsistent with spherical symmetry on the largest scales .",
    "moreover , the displacement transfer function is multiplied by a factor @xmath103 which breaks spherical symmetry for each cartesian component .     has been used with an unfiltered power spectrum .",
    "the cosmological model is flat @xmath104cdm and the box is 64 mpc across .",
    "false colors are scaled to the logarithm of the transfer function , which shows 6 orders of magnitude .",
    "anisotropy of the discrete fourier transform leads to anisotropic features that are barely visible along horizontal and vertical axes through the center . ]    to examine the first concern , namely the non - isotropic discretization in fourier space , we examine the transfer function computed using the exact method of  [ sec : exact ] .",
    "figure [ fig : transd3 ] shows the result for the flat @xmath104cdm model ( @xmath105 , @xmath106 , @xmath107 ) with a @xmath108 refinement of a @xmath109 subgrid of a @xmath110 grid .",
    "the coarse grid spacing is 1 mpc . in effect , the transfer function has been computed at @xmath111 resolution on a grid of spacing 0.25 mpc , but is shown only within a central region 64 mpc across ( @xmath112 ) .    there is a slight banding visible along the @xmath113- and @xmath114-axes in figure [ fig : transd3 ] .",
    "the amplitude of this banding ranges from a relative size of about 20% at small @xmath54 to more than a factor of two at the edges ( where the transfer function is very small ) ; however , it is much smaller away from the coordinate axes .",
    "this anisotropic structure arises because , although @xmath13 is spherically symmetric , the fourier integration is not carried out over all @xmath115 but rather only within a cube of size @xmath116 .",
    "the fourier space is periodic ( because the real space is discrete ) , which breaks the spherical symmetry of @xmath84 . in this case",
    "it is the anisotropy at large @xmath8 that produces the anisotropy in real space .",
    "this anisotropy is present in the initial conditions generated with the with the cosmics package @xcite .",
    "the author s rational for allowing it was that it is preferable to retain all the power present in the initial density fluctuation field . including all power in the fourier cube",
    "gives the best possible resolution at small scales while producing a modest anisotropy along the coordinate axes .",
    "however , the effects of the anisotropy are unclear and should be more carefully evaluated . in  [ sec : short ] , we will show how the density transfer function can be made isotropic by filtering . to determine whether the anisotropy of unfiltered initial conditions causes any significant errors ,",
    "full nonlinear numerical simulations should be performed with and without filtering .",
    "that test is beyond the scope of this paper .",
    "additional considerations arise when calculating the transfer function for the linear velocity or displacement fields .",
    "( the linear velocity and displacement are proportional to each other . )",
    "the displacement field @xmath117 is related to the density fluctuation field by @xmath118 in real space or @xmath119 in @xmath8-space .",
    "each component of the displacement field is anisotropic .",
    "this presents no difficulty for the discrete methods of   [ sec : exact][sec : minimal ] .",
    "there is one subtlety of implementation , however : in fourier space , the displacement field must vanish on the brillouin zone boundaries .",
    "that is , the component of @xmath120 along @xmath121 must vanish on the surfaces @xmath122 and similarly for the other components .",
    "this is required because each component of @xmath120 is both odd and periodic .",
    "if the density transfer function is filtered so as to be spherical in real space , then the displacement field is radial in real space and we can obtain the radial component simply by applying gauss s law : @xmath123 the radial integral can be performed from a tabulation of the spherical density transfer function in real space , @xmath124 , by integrating a cubic spline or other interpolating function .",
    "the cartesian components of displacement follow simply from @xmath125 .    in summary",
    ", we will use the spherical method in the case of spherical transfer functions , otherwise we will use one of the discrete methods . if the transfer function is sufficiently localized in real space so",
    "that the fourier space may be coarsely sampled , the minimal @xmath8-space sampling method may be used . in all cases",
    "we will compare against the exact method to test the accuracy of our approximations .",
    "in this section we present our implementation of the two - level adaptive mesh refinement method described in  [ sec : method ] and we discuss the split of our fields into long- and short - wavelength parts on the coarse and fine grids , respectively .    the high - resolution density field is the superposition of two parts : @xmath126 where @xmath127*t\\ .\\ ] ] the convolution operator @xmath128 is defined by equation ( [ congen2 ] ) , with the transfer function @xmath66 defined on a high - resolution grid .",
    "the net density field is the superposition arising from the coarse - grid white noise sample @xmath40 and its high - frequency correction @xmath129 as in equation ( [ xisamp ] ) .",
    "basically , we split the density field ( and similarly the displacement and velocity fields ) into long - wavelength and short - wavelength parts . in this section",
    "we first describe the computation of the short - wavelength part @xmath130 , followed by the long - wavelength part @xmath131 .       except that a spherical hanning filter ( cosine in fourier space ) has been applied to reduce the anisotropy that was seen in figure [ fig : transd3 ] .",
    "false colors show the logarithm of the transfer function , with 6 orders of magnitude shown for the density and 3 orders of magnitude for the displacement .",
    "( the absolute value of the displacement is shown ; it is negative in the right half of the image . )",
    "when convolved with white noise , these transfer functions give the density fluctuation and @xmath113-displacement fields in linear theory at redshift @xmath132.,title=\"fig : \" ]   except that a spherical hanning filter ( cosine in fourier space ) has been applied to reduce the anisotropy that was seen in figure [ fig : transd3 ] .",
    "false colors show the logarithm of the transfer function , with 6 orders of magnitude shown for the density and 3 orders of magnitude for the displacement .",
    "( the absolute value of the displacement is shown ; it is negative in the right half of the image . )",
    "when convolved with white noise , these transfer functions give the density fluctuation and @xmath113-displacement fields in linear theory at redshift @xmath132.,title=\"fig : \" ]    the high - frequency part of the density field , @xmath133 , is straightforward to calculate using the methods of   [ sec : subgrid ] and [ sec : transf ] .",
    "let us first consider the transfer functions for the density and displacement fields , which we show in figure [ fig : transf ] .",
    "in order to eliminate the anisotropy appearing in figure [ fig : transd3 ] , we have applied a spherical hanning filter , multiplying @xmath13 by @xmath134 for @xmath135 and zeroing it for @xmath136 where @xmath101 .",
    "this filter has removed the anisotropic structure and has also smoothed the density field near @xmath137 .",
    "we have used the spherical method of  [ sec : spherical ] .",
    "the exact method gives results that are visually almost indistinguishable , with maximum differences of order one percent because the hanning filter does completely eliminate the anisotropy of the discrete fourier transform .",
    "each cartesian component of the displacement transfer function displays a characteristic dipole pattern because of the projection from radial motion : @xmath138 .",
    "a density enhancement at the origin is accompanied by radial infall ( with @xmath139 changing sign across the origin ) .",
    "note that the displacement transfer function falls off much less rapidly with distance than the density transfer function , illustrating the well - known fact that the linear velocity field has much more large - scale coherence than the density field .",
    "the linear displacement , velocity , and gravity fields are all proportional to each other , so one may also interpret @xmath120 as the transfer function for the gravitational field .    .",
    "right : zero - padding is used for isolated boundary conditions , and the means have been subtracted over cells of size 1 mpc so that we show @xmath140 .",
    "false colors are scaled to linear values ranging from @xmath141 standard deviations of @xmath142 .",
    "the zero level is light green . because of the predominance of high - frequency power , the filtering applied to the right - hand image is not apparent , but the two samples differ in the upper left quadrant.,title=\"fig : \" ] .",
    "right : zero - padding is used for isolated boundary conditions , and the means have been subtracted over cells of size 1 mpc so that we show @xmath140 .",
    "false colors are scaled to linear values ranging from @xmath141 standard deviations of @xmath142 .",
    "the zero level is light green . because of the predominance of high - frequency power , the filtering applied to the right - hand image is not apparent , but the two samples differ in the upper left quadrant.,title=\"fig : \" ]    the next step in computing the subgrid contribution to the initial conditions is to generate an appropriate sample of gaussian noise .",
    "figure [ fig : wnsamp ] shows two samples of white noise for the high - resolution subgrid .",
    "the left sample is pure white noise @xmath143 , which is the correct noise sample if we wish to generate a gaussian random field with periodic boundary conditions on a grid of size 64 mpc ( the full width that is shown ) .",
    "the right sample is nonzero only in a region 32 mpc across , as is appropriate for isolated boundary conditions in a subgrid , and the means over coarse grid cells have been subtracted , i.e. we plot @xmath144 .",
    "this is the appropriate noise sample for computing the short - wavelength density field @xmath130 .    ) with the @xmath104cdm density transfer function ( left panel of figure [ fig : transf ] ) .",
    "false colors are scaled to linear values ranging from @xmath141 standard deviations for the left panel .",
    "the left and right panels correspond to the same panels of figure [ fig : wnsamp ] .",
    "the two density fields are strikingly different because long wavelengths have been suppressed in the right image by subtraction of coarse - cell means in figure [ fig : wnsamp ] .",
    "the long wavelength components will be restored to the right image by addition of the coarse grid sample.,title=\"fig : \" ] ) with the @xmath104cdm density transfer function ( left panel of figure [ fig : transf ] ) .",
    "false colors are scaled to linear values ranging from @xmath141 standard deviations for the left panel .",
    "the left and right panels correspond to the same panels of figure [ fig : wnsamp ] .",
    "the two density fields are strikingly different because long wavelengths have been suppressed in the right image by subtraction of coarse - cell means in figure [ fig : wnsamp ] .",
    "the long wavelength components will be restored to the right image by addition of the coarse grid sample.,title=\"fig : \" ]    figure [ fig : delsub ] shows the result of convolving the two noise samples of figure [ fig : wnsamp ] with the density transfer function of figure [ fig : transf ] .",
    "the left - hand panel gives @xmath145 while the right - hand panel gives the desired short - wavelength field @xmath146 .",
    "the two fields differ in the upper left quadrant because of the subtraction of coarse - cell means from the white noise field used to generate the left image .",
    "although the effect of this subtraction is barely evident in figure [ fig : wnsamp ] , it dominates the comparison of the two panels in figure [ fig : delsub ] because convolution by the transfer function acts as a low - pass filter .",
    "the left panel of figure [ fig : delsub ] gives a complete sample of @xmath14 on a periodic grid of size 64 mpc , while the right panel shows only the short - wavelength components coming from mesh refinement .",
    "careful examination of the right panel of figure [ fig : delsub ] shows that the finite width of the transfer function has caused a little smearing at the boundaries , which are matched periodically to the opposite side of the box by the fourier convolution .",
    "( a few pixels along the right and bottom edges of the left panel differ from green . )",
    "however , these edge effects do not represent errors in the short - wavelength density field .",
    "instead , they illustrate the fact that _ outside _ of the refined region , the gravity field should include tidal contributions from the short - wavelength fluctuations inside the refinement volume . for the purpose of computing @xmath146 within the subvolume , we simply discard everything outside the upper left quadrant .    as a test of our transfer function methods , we calculated @xmath147 using the exact transfer function instead of the spherical one .",
    "the rms difference between the fields so computed was 0.0014 standard deviations , a negligible difference .",
    "as a test of the whole procedure , we computed the power spectrum of the left panel of figure [ fig : delsub ] and checked that it agrees within cosmic variance with the input @xmath104cdm power spectrum .",
    "we also compared the displacement field computed using the exact transfer with that computed using the spherical one .",
    "the rms difference was 0.0062 standard deviations , still negligible .",
    "then we compared the divergence of the displacement field ( computed in fourier space as @xmath148 ) with the density field , expecting them to agree perfectly .",
    "interestingly , this is not the case for the exact ( or spherical ) transfer functions .",
    "when the transfer functions are truncated in real space and made periodic on a grid of size @xmath73 , @xmath149 despite the fact that on the full refined grid @xmath150 .",
    "the prime on the transfer functions indicates a _ different _ fourier space , as discussed after equation ( [ congen4 ] ) .",
    "the only way to test @xmath151 for the exact transfer function is to perform an fft on the full refined grid of @xmath152 grid points . in  [ sec : test ] we will perform an equivalent test with an end - to - end test of the entire method using a @xmath111 grid .",
    "now we consider @xmath153 , the contribution to the density field from the coarse grid .",
    "as we see from equation ( [ del12a ] ) , in principle we can compute @xmath131 by spreading the original coarse - grid white noise sample @xmath40 to the @xmath6 subgrid points for each coarse grid point ( i.e. , all @xmath154 points ) and then convolving with the high - resolution transfer function as in equation ( [ congen2 ] ) : @xmath155 however , this method is impractical , because the contributions to @xmath131 coming from large distances are not negligible because of the long range of the transfer functions ( especially for the velocity transfer function ) . for the short wavelength field @xmath147",
    "this causes no problems because the noise field @xmath142 is nonzero only within the subvolume . here , however , the noise field @xmath40 is nonzero over the entire simulation volume .",
    "including all relevant contributions in the convolution as written would require working with the transfer function on the full grid of size @xmath46 , which is exactly what we are trying to avoid .",
    "a practical solution is to rewrite equation ( [ tildel1 ] ) as a convolution of the coarse - grid density field with a short - ranged filter : @xmath156 one can easily check that this is exactly equivalent to equation ( [ tildel1 ] ) provided that @xmath157\\,{t(k)\\over t(k_0)}\\ ] ] where @xmath158 is the projection of @xmath115 into the fundamental brillouin zone ( eq .",
    "[ kgrid ] ) .",
    "an exact evaluation of equation ( [ tildel2 ] ) still requires using a full @xmath46 grid .",
    "however , we will see that @xmath159 falls off sufficiently rapidly with distance that contributions to @xmath160 coming from large distances are negligible .",
    "( this will not be true for the velocity field , but we will develop a variation to handle that case later . )",
    "thus , we may truncate @xmath159 at the boundary of the refinement region and perform the convolution of equation ( [ tildel2 ] ) using a @xmath77 grid just as we did for the short - wavelength field .",
    "the errors of this procedure will be quantified below .",
    "equation ( [ tildel2 ] ) has a simple interpretation .",
    "the coarse - grid density field @xmath161 is spread to the fine grid by replicating the coarse - grid values to each of the @xmath6 grid points within a single coarse grid cell .",
    "the result is an artifact called aliasing . in real space",
    "this artifact is manifested by having constant values within pixels larger than the spatial resolution . in @xmath8-space",
    "the effect is to replicate low - frequency power in the fundamental brillouin zone to higher frequencies .",
    "thus , the wrong transfer function is used if one simply sets @xmath153 to @xmath162 . equation ( [ filtad ] )",
    "defines an anti - aliasing filter which corrects the transfer function from the coarse grid ( with wavevectors @xmath163 in the fundamental brillouin zone ) to the full @xmath8-space .",
    "it smooths the sharp edges that arise from spreading @xmath161 to the fine grid .",
    "the anti - aliasing filter removes the artifacts caused by replication of the fundamental brillouin zone .",
    "the anti - aliasing filter is manifestly nonspherical , so we can not use the spherical transform method of  [ sec : spherical ] to evaluate it .",
    "however , @xmath164 is sharply peaked .",
    "this is obvious from the fact that its fourier transform is constant over the fundamental brillouin zone ; the fourier transform of a constant is a delta function .",
    "thus , we expect @xmath164 to be peaked on the scale of a few coarse grid spacings . as a result , the minimal @xmath8-space sampling method of  [ sec : minimal ] should suffice ( with a variation for the velocity field ) .",
    "the division by @xmath165 in equation ( [ filtad ] ) requires that we compute the coarse - grid density field @xmath161 without a hanning filter ; otherwise @xmath165 would be zero in the corners of each brillouin zone .",
    "simply put , if we want to correctly sample the density field at high resolution , we should not cut out long - wavelength power by filtering .",
    "however , we will apply a spherical hanning filter at the shortest wavelength to remove the anisotropic structure that was apparent in figure [ fig : transd3 ] .    at the corners of each brillouin zone @xmath166 but @xmath167 ( aside from the fundamental mode for the whole box ) . at these wavevectors",
    ", @xmath168 has no power and so no error is made by setting @xmath169 . in the case of the displacement field , each component of @xmath170 vanishes along an entire face of the brillouin zone , as explained in the paragraph before equation ( [ gauss ] ) .",
    "we also set to zero these contributions to the fourier series in equation ( [ filtad ] ) .",
    "for the density .",
    "the left panel shows the filter computed using the exact method of  [ sec : exact ] while the right panel uses the minimal @xmath8-space sampling method of  [ sec : minimal ] .",
    "false colors are scaled to the logarithm of absolute value of the filter , which shows six orders of magnitude .",
    "the banded appearance is caused by low - amplitude oscillations .",
    "the oscillations act to smooth the sharp edges of the coarse grid fields when they are refined to the subgrid .",
    "the difference between the two filters is negligible away from the edges.,title=\"fig : \" ]   for the density .",
    "the left panel shows the filter computed using the exact method of  [ sec : exact ] while the right panel uses the minimal @xmath8-space sampling method of  [ sec : minimal ] .",
    "false colors are scaled to the logarithm of absolute value of the filter , which shows six orders of magnitude .",
    "the banded appearance is caused by low - amplitude oscillations .",
    "the oscillations act to smooth the sharp edges of the coarse grid fields when they are refined to the subgrid .",
    "the difference between the two filters is negligible away from the edges.,title=\"fig : \" ]    figure [ fig : filtd ] shows the density anti - aliasing filter computed with a spherical hanning filter for @xmath13 .",
    "the minimal @xmath8-space method gives good agreement with the much slower exact calculation .",
    "along the axes at the edges of the volume the errors are up to a factor of two , but @xmath171 is very small and oscillates , making these errors unimportant .",
    "the banding is due to the sign oscillations of @xmath171 .",
    "they have a characteristic scale equal to the coarse grid spacing and they arise because of the discontinuity of @xmath172 at brillouin zone boundaries in equation ( [ filtad ] ) .",
    "such oscillations are characteristic of anti - aliasing filters .",
    "the filter falls off sufficiently rapidly with distance from the center that we can expect accurate results by truncating it outside the region shown .",
    "-component of displacement ( or velocity or gravity ) , computed with the exact ( left ) and minimal @xmath8-space sampling ( right ) methods .",
    "false colors are scaled to the logarithm of absolute value of the filter spanning four orders of magnitude . because the displacement is sensitive to longer wavelengths than the density , the differences between the two computational methods here is more pronounced than for the density filter of figure [ fig : filtd].,title=\"fig : \" ] -component of displacement ( or velocity or gravity ) ,",
    "computed with the exact ( left ) and minimal @xmath8-space sampling ( right ) methods .",
    "false colors are scaled to the logarithm of absolute value of the filter spanning four orders of magnitude .",
    "because the displacement is sensitive to longer wavelengths than the density , the differences between the two computational methods here is more pronounced than for the density filter of figure [ fig : filtd].,title=\"fig : \" ]    figure [ fig : filtx ] shows the corresponding result for the displacement ( or velocity or gravity ) field filter .",
    "( recall that the displacement , velocity , and gravity are proportional to one another in linear theory . )",
    "now the errors of the minimal @xmath8-space sampling method are significant .",
    "they arise because the minimal sampling method forces @xmath164 to be periodic on the scale of the box shown in the figure ( twice the subgrid size ) while with the exact method the scale of periodicity is larger by a factor @xmath173 ( or 4 in this case ) . in other words , the filter does not fall off very rapidly with distance , so truncating it and making it periodic in the box of size @xmath80 introduces noticeable errors . however , because the filter is still sharply peaked and oscillatory with small amplitude , it is possible that these errors are negligible .",
    "we will quantify the errors in  [ sec : test ] .",
    "the procedure is now similar to that of  [ sec : short ] .",
    "once we have the anti - aliasing filters , the next step is to obtain samples of the coarse - grid fields @xmath161 and @xmath174 that we wish to refine .",
    "we do this using the convolution method of  [ sec : disconv ] . for testing purposes",
    ", we construct a coarse - grid sample of white noise , @xmath40 , which exactly equals the long - wavelength parts of the noise shown in the left panel of figure [ fig : wnsamp ] .",
    "this was achieved by modifying grafic @xcite to sample a white noise field @xmath32 in the spatial domain .",
    "fourier transformation to @xmath16 then allows the calculation of density ( and similarly displacement ) by equation ( [ delfft ] ) . as a result",
    ", we have chosen our coarse grid sample so that @xmath175 within the refinement subgrid .",
    "this choice is made so that later we can see directly how long- and short - wavelength components of the noise contribute to the final density field .",
    "for the coarse grid . left : full cube of size 256 mpc .",
    "right : magnification of the upper left corner by a factor of 4 to show the region that will be refined . aliasing ( sharp pixel boundaries ) is now evident .",
    "false colors are scaled to linear values ranging from @xmath141 standard deviations.,title=\"fig : \" ]   for the coarse grid .",
    "left : full cube of size 256 mpc .",
    "right : magnification of the upper left corner by a factor of 4 to show the region that will be refined . aliasing ( sharp pixel boundaries ) is now evident .",
    "false colors are scaled to linear values ranging from @xmath141 standard deviations.,title=\"fig : \" ]    figure [ fig : cnsamp ] shows the white noise sample adopted for the coarse grid .",
    "the right panel is obtained by averaging the left panel of figure [ fig : wnsamp ] over @xmath176 subgrid mesh points ( 1 mpc@xmath177 volume ) .",
    "figure [ fig : wnsamp ] shows only a single thin slice of width 0.25 mpc while figure [ fig : cnsamp ] shows coarse cells of thickness 1 mpc , so one should not expect the two figures to appear similar .",
    "the left panel of figure [ fig : cnsamp ] shows a full slice of size 256 mpc , obtained by filling out the rest of the volume with white noise .",
    "resulting from convolution of figure [ fig : cnsamp ] with the density transfer function sampled on the coarse grid .",
    "left : full cube of size 256 mpc , with periodic boundary conditions .",
    "right : magnification of the upper left corner by a factor of 4 to show a square of size 64 mpc .",
    "this panel shows the 32 mpc region that we wish to refine to include the correct small - scale power .",
    "the magnified pixels represents an aliasing artifact .",
    "false colors are scaled as in figure [ fig : delsub ] .",
    "random numbers were chosen so that the right panel corresponds to the coarsely sampled long wavelength components of the left panel of figure [ fig : delsub].,title=\"fig : \" ]   resulting from convolution of figure [ fig : cnsamp ] with the density transfer function sampled on the coarse grid .",
    "left : full cube of size 256 mpc , with periodic boundary conditions .",
    "right : magnification of the upper left corner by a factor of 4 to show a square of size 64 mpc .",
    "this panel shows the 32 mpc region that we wish to refine to include the correct small - scale power .",
    "the magnified pixels represents an aliasing artifact .",
    "false colors are scaled as in figure [ fig : delsub ] .",
    "random numbers were chosen so that the right panel corresponds to the coarsely sampled long wavelength components of the left panel of figure [ fig : delsub].,title=\"fig : \" ]    this white noise sample on the coarse grid was convolved with the transfer function using grafic to give the coarse density field @xmath162 that we wish to refine .",
    "the results are shown in figure [ fig : deltop ] .",
    "the right panel shows a 64 mpc subvolume including the 32 mpc refinement region .",
    "the obvious pixelization is the result of mesh refinement : the coarse grid density field has been spread to the fine grid .",
    "this pixelization causes power from wavelengths longer than the coarse grid spacing to be aliased to higher frequencies . if uncorrected , this aliasing would introduce spurious features into the power spectrum",
    "thus , the coarse grid sample must be convolved with an anti - aliasing filter as described above .    .",
    "the bottom and right quartiles are filled with values from the top and left of the subvolume which were then wrapped periodically .",
    "this is clearer for the velocity field because of its larger coherence length .",
    "the buffer regions and periodic boundary conditions are needed because of the fft - based method for convolution with anti - aliasing filters.,title=\"fig : \" ] .",
    "the bottom and right quartiles are filled with values from the top and left of the subvolume which were then wrapped periodically .",
    "this is clearer for the velocity field because of its larger coherence length .",
    "the buffer regions and periodic boundary conditions are needed because of the fft - based method for convolution with anti - aliasing filters.,title=\"fig : \" ]    special care is needed with the boundary conditions for the anti - aliasing convolution of equation ( [ tildel2 ] ) .",
    "the top grid density field @xmath161 fills the subgrid shown in the right panel of figure [ fig : deltop ] without periodic boundary conditions . the anti - aliasing filter ( fig .",
    "[ fig : filtd ] ) has finite extent ; therefore fft - based convolution of the two will lead to spurious contributions to @xmath178 at the subvolume edges coming from @xmath179 on the opposite side of the box . to avoid this , we surround the subvolume ( which occupies one octant of the convolution volume ) with a buffer region of width one - half of the subvolume in each dimension . the correct density values from the top grid are placed in this buffer . because our subvolume is not centered but rather is placed in the corner of the cube of size @xmath80 , we wrap half of the buffer to the other side of this cube . the results are shown in figure [ fig : delvlong ] .     by the appropriate anti - aliasing filter ( fig .",
    "[ fig : filtd ] for the density , fig .",
    "[ fig : filtx ] for the velocity ) .",
    "the anti - aliasing filters have eliminated the pixelization artifacts present in figure [ fig : delvlong ] .",
    "convolution across the discontinuity at the boundary of the buffer region causes some errors but these are small within the desired refinement region ( the upper left quadrant in these images).,title=\"fig : \" ]   by the appropriate anti - aliasing filter ( fig .",
    "[ fig : filtd ] for the density , fig .",
    "[ fig : filtx ] for the velocity ) .",
    "the anti - aliasing filters have eliminated the pixelization artifacts present in figure [ fig : delvlong ] .",
    "convolution across the discontinuity at the boundary of the buffer region causes some errors but these are small within the desired refinement region ( the upper left quadrant in these images).,title=\"fig : \" ]    figure [ fig : condel1 ] shows the density field @xmath180 and the corresponding velocity field after convolution with the anti - aliasing filter @xmath171 .",
    "the minimal @xmath8-space filter has been used here ; there would be almost no discernible difference if the exact filter was used instead .",
    "the pixelated images of figure [ fig : delvlong ] have now been smoothed appropriately for the transfer function .",
    "smoothing over pixelization artifacts is the purpose behind anti - aliasing filters , whether they be applied in image processing or cosmology .",
    "the convolution method used here is not exact . quantifying its errors requires evaluating equation ( [ tildel1 ] ) or ( [ tildel2 ] ) using a full convolution of size @xmath46 .",
    "we do this in the next subsection , where we test all stages of the mesh refinement method .      having computed separately the short- and long - wavelength contributions to the density and velocity ( or displacement ) fields , we combine them in figure [ fig : multi2 ] using equation ( [ del12 ] ) to give the complete multiscale fields .",
    "the four - fold increase in resolution can be seen by comparing the subvolume with the rest of the field .",
    "the effects of higher resolution are much more pronounced for the density than they are for the velocity because of the density field s steeper dependence on wavenumber .",
    "-component ) fields in a region 64 mpc across extracted from the 256 mpc realization .",
    "false colors are scaled to linear values ranging from @xmath141 standard deviations of the high - resolution fields .",
    "the refinement subgrid is the upper left quadrant in each case . outside of this region",
    "the coarse ( top ) grid values are shown to illustrate how mesh refinement increases the resolution .",
    "the density figure may be compared directly with the right - hand panel of figure [ fig : deltop].,title=\"fig : \" ] -component ) fields in a region 64 mpc across extracted from the 256 mpc realization .",
    "false colors are scaled to linear values ranging from @xmath141 standard deviations of the high - resolution fields .",
    "the refinement subgrid is the upper left quadrant in each case . outside of this region",
    "the coarse ( top ) grid values are shown to illustrate how mesh refinement increases the resolution .",
    "the density figure may be compared directly with the right - hand panel of figure [ fig : deltop].,title=\"fig : \" ]    a test of the entire mesh refinement procedure can be made by generating the density and velocity fields at full @xmath111 resolution over the whole 256 mpc box .",
    "this was done by modifying the author s grafic code @xcite to replace its random numbers in @xmath8-space with an input white noise field in real space .",
    "the noise field was constructed to match the upper left quadrant of the left panel of figure [ fig : wnsamp ] in a high - resolution region 32 mpc across and to match the left panel of figure [ fig : cnsamp ] everywhere else , with noise values made uniform in 1 mpc cells ( @xmath176 grid cells of the @xmath111 grid ) .",
    "thus , the white noise field was sampled as in figure [ fig : amr ] . in order to have sufficient computer memory ,",
    "grafic was run on the origin 2000 supercomputer at the national computational science alliance .",
    "grid with random numbers chosen to match the multiscale calculation .",
    "this figure gives the exact results against which to compare figure [ fig : multi2].,title=\"fig : \" ]   grid with random numbers chosen to match the multiscale calculation .",
    "this figure gives the exact results against which to compare figure [ fig : multi2].,title=\"fig : \" ]    the results of this full - resolution calculation are shown in figure [ fig : grafic1024 ] .",
    "the high - resolution fields are smooth outside of the refinement volume simply because they have been convolved with a high - resolution transfer function ; by contrast , figure [ fig : multi2 ] shows only the sampling of a low - resolution mesh outside of the subvolume .",
    "these resolution differences are not important here .",
    "rather , it is the comparison in the high - resolution subvolume that is important .",
    "evidently the density field is accurately reproduced by the multiscale algorithm while there are some visible errors in the velocity field .     and [ fig : grafic1024 ] .",
    "false colors are scaled to @xmath181 standard deviations for the density errors and @xmath182 standard deviations for the velocity errors .",
    "each map is a mosaic of 4 panels showing the errors resulting from the two major approximations used in the multiscale computation .",
    "the right columns , labelled `` approx .",
    "t(x ) , '' show the effect of the spherical transform method for computing the transfer functions . the lower rows , labelled `` approx .",
    "w(x ) , '' show the effect of the minimal @xmath8-space sampling method for computing the anti - aliasing filters .",
    "the upper - left quadrants show the errors when exact ( and computationally expensive ) transfer and anti - aliasing filters are used while the lower - right quadrants show the errors in figure [ fig : multi2 ] .",
    "there are residual errors even with exact @xmath84 and @xmath159 because of the spatial truncation of @xmath171.,title=\"fig : \" ]   and [ fig : grafic1024 ] .",
    "false colors are scaled to @xmath181 standard deviations for the density errors and @xmath182 standard deviations for the velocity errors .",
    "each map is a mosaic of 4 panels showing the errors resulting from the two major approximations used in the multiscale computation .",
    "the right columns , labelled `` approx .",
    "t(x ) , '' show the effect of the spherical transform method for computing the transfer functions . the lower rows , labelled `` approx .",
    "w(x ) , '' show the effect of the minimal @xmath8-space sampling method for computing the anti - aliasing filters .",
    "the upper - left quadrants show the errors when exact ( and computationally expensive ) transfer and anti - aliasing filters are used while the lower - right quadrants show the errors in figure [ fig : multi2 ] .",
    "there are residual errors even with exact @xmath84 and @xmath159 because of the spatial truncation of @xmath171.,title=\"fig : \" ]    to quantify these errors , in figure [ fig : errmosaic ] we show residuals obtained by subtracting the exact maps from the multiscale maps for the 32 mpc refinement subvolume . a priori we expect three main sources of error :    1 .",
    "the use of the spherical method for fast computation of the short - wavelength transfer functions ; 2 .   the use of the minimal @xmath8-space sampling method for fast computation of the long - wavelength anti - aliasing filters ; and 3 .",
    "truncation of the anti - aliasing filter to perform the convolution over a subvolume instead of the entire top grid .",
    "all three effects are visible in figure [ fig : errmosaic ] . the rows and columns that are not labeled use the exact filters but are still subject to the third error , truncation of @xmath159",
    ".    scaled to the standard deviation of the high - resolution density field , the rms errors of density in the subvolume shown in figure [ fig : errmosaic ] are 0.04% ( upper left ) , 0.09% ( upper right ) , 0.06% ( lower left ) , and 0.10% ( lower right ) .",
    "thus , the major source of error for adaptive refinement of the density field is the use of a spherical transfer function for the short - wavelength components .",
    "the magnitude of the error is insignificant for the accuracy of cosmological simulations . for the velocity field ,",
    "on the other hand , the corresponding rms errors are 3.2% ( top row ) and 7.0% ( bottom row ) .",
    "clearly the anti - aliasing filter step is causing problems for the long - wavelength velocity field .",
    "the long - range coherence of the velocity ( or gravity ) field has been seen to cause difficulties for the evaluation of the long - wavelength components by anti - aliasing the coarse - grid sample .",
    "this subsection presents a solution .",
    "several attempts were made to reduce the anti - aliasing errors while continuing to use a minimal @xmath8-space sampling algorithm .",
    "none of the attempts succeeded until we split the long - wavelength velocity field from the top grid into parts due separately to the mass inside and outside the refinement subvolume .",
    "the motivation for this was the idea that the latter part ( the tidal field within the subvolume caused by mass outside it ) might be smooth enough to require minimal interpolation to the subgrid . for convenience ,",
    "tidal split was done by setting @xmath183 outside or inside the subvolume instead of setting @xmath184 ; the coherence length of the density field is so small that very little difference is made either way .",
    "linearity of the velocity field ensures that when we add together the two parts either way we get the complete long - range velocity field .    .",
    "this decomposition is the key to reducing the anti - aliasing velocity field errors , as described in the text.,title=\"fig : \" ] .",
    "this decomposition is the key to reducing the anti - aliasing velocity field errors , as described in the text.,title=\"fig : \" ]    figure [ fig : tides ] shows the decomposition of the velocity field into the `` outer '' and `` inner '' parts .",
    "they were computed by zeroing the white noise field in the appropriate regions and re - running grafic .",
    "the same boundary conditions are used as in figure [ fig : delvlong ] .",
    "the character of the two parts is strikingly different within the refinement subvolume ( the upper left quadrant ) .",
    "the outer part is smooth , as expected .",
    "the inner part has a smaller coherence length and it is well - localized over the upper left quadrant .",
    "this spatial localization and coherence suggest that the truncated minimal @xmath8-space filter will be much more accurate for the inner part than for the complete velocity field . for the outer part , on the other hand , we know that the discontinuities at the boundary of the buffer regions will cause appreciable errors if convolved with the same filter .",
    "the smoothness of the tidal field inside the subvolume suggests that we use a much simpler and more localized filter .    .",
    "the false colors are scaled to @xmath185 where @xmath186 is the standard deviation .",
    "the upper left ( exact / exact ) and lower middle ( minimal / minimal ) maps are the same as the two rightmost maps in figure [ fig : errmosaic ] , where they were imaged with a color stretch only half as large ( @xmath187 .",
    "rms errors for each map ( as a percentage of the rms one - dimensional velocity ) are 3.2 , 6.8 , 2.7 ( top row , left to right ) and 3.6 , 7.0 , 3.2 ( bottom row ) .",
    "the bottom right map gives the errors for the best fast method .",
    "as in figure [ fig : errmosaic ] , there are errors even in the `` exact '' case because of the truncation of the anti - aliasing filter . ]",
    "several different filters were tried for the outer ( tidal ) part of the velocity field .",
    "the results for three are shown in figure [ fig : vxerr3 ] .",
    "the best simple filter was found to be sharp @xmath8-space filtering , which sets @xmath188 everywhere except the fundamental brillouin zone , where @xmath189 ( before the hanning filter applied at the fine mesh scale ) .",
    "this filter completely eliminates the aliasing error by eliminating the replication of the fundamental brillouin zone in @xmath8-space .",
    "it is also much more localized than the exact filter , so that spurious effects from the buffer truncation in the left panel of figure [ fig : tides ] are not convolved into the subvolume .",
    "the price one pays is that it has the wrong shape at small distances compared with the exact filter , leading to a new source of errors in the rightmost columns of figure [ fig : vxerr3 ] .",
    "however , these errors are smaller than the error made with the exact filter due to the buffer truncation ( top left panel ) .",
    "a comparison of the top and bottom rows of figure [ fig : vxerr3 ] shows that the filtering of the inner part of the velocity field is a minor source of error .",
    "it is the tidal field ( the outer part ) that requires delicate handling . using a sharp @xmath8-space filter for the outer part and minimal @xmath8-space filter for the inner part , our final errors are 3.2% rms , the same as if we had used the computationally expensive exact filter throughout .",
    "these errors are probably small enough to be unimportant in cosmological simulations .",
    "they could be further reduced , at the expense of an increase in computer time and memory , by increasing the size of the buffer region for the top grid .",
    "the ability to refine an existing mesh opens the possibility of recursive refinement to multiple levels , offering a kind of telescopic zoom into cosmic structures . before this digital zoom lens can work , however , there are some implementation issues to face . the issues addressed in  [ sec : test ] must be considered anew in light of recursive refinement .    to see the issues arising in recursive refinement , consider a three - level refinement with refinement factors @xmath190 and @xmath191 . by analogy with equations ( [ xgrid ] ) and ( [ xisamp ] )",
    ", we write the grid coordinates and noise fields as @xmath192 @xmath193 where @xmath194 is obtained by averaging @xmath194 over @xmath195 . at each level of the hierarchy",
    "there is a different grid ( labeled by @xmath26 , @xmath36 , and @xmath195 , respectively ) .",
    "the variances of the white noise samples are related by @xmath196 .",
    "the main idea of recursive refinement is that , once we have refined to level @xmath197 ( where @xmath198 is the periodic top grid before any refinement ) , the fields computed at that level serve as top - grid fields to be refined to level @xmath199",
    ". equations ( [ del12 ] ) , ( [ del12a ] ) , and ( [ tildel2 ] ) showed how that refinement works for @xmath198 by applying an anti - aliasing filter to the level-0 fields .",
    "for @xmath200 we get @xmath201*t\\ .\\ ] ] the procedure for refinement to an arbitrary level is now clear .",
    "first we sample the fields at the preceding level and spread them to the new fine grid .",
    "then we convolve with the appropriate anti - aliasing filter .",
    "next we sample short - wavelength noise on the new fine grid and subtract the coarse - cell means so that so that the noise is zero at every higher level of the hierarchy .",
    "this noise is then convolved with the transfer function and added to the long wavelength field to give the high - resolution field .",
    "this procedure is the same for all levels of the hierarchy .",
    "however , there are some issues to consider involving the transfer functions and anti - aliasing filters .",
    "we discuss these next .",
    "as was the case for two - level refinement , exact sampling requires that we compute the upper - level sample without any filtering .",
    "that is , we should eliminate the hanning filter from both the anti - aliasing filter @xmath171 and the transfer function @xmath79 before computing all refinements except the last one at the highest degree of refinement .",
    "otherwise we would lose power present in the intermediate refinement levels .",
    "eliminating the hanning filter is straightforward for the anti - aliasing filters used in  [ sec : implem ] .",
    "the minimal @xmath8-space and sharp @xmath8-space filters are equally easy to compute with or without a hanning filter",
    ". however , the transfer functions are an altogether different matter . in  [ sec : short ] we used spherical transfer functions after concluding in  [ sec : minimal ] that the coarse @xmath8-space sampling of the minimal method would give significant errors for the short - wavelength fields .",
    "unfortunately , the unfiltered density transfer function is anisotropic , as was shown in figure [ fig : transd3 ]",
    ". it also has a higher peak value than the filtered transfer function in figure [ fig : transf ] .",
    "computing the exact transfer function is unacceptably costly , with the operations count scaling as the sixth power of the total refinement factor ( i.e. the product of the individual refinement factors for each level ) .",
    "thus , we are forced to reconsider the spherical and minimal sampling methods for the transfer functions .",
    "the unfiltered density is nonspherical because @xmath8-space is sampled in a cube instead of a sphere . besides creating anisotropy",
    ", this sampling increases the small - scale power . as an alternative",
    ", we might use the spherical method of equation ( [ transkx3 ] ) with a hanning filter but with a maximum spatial frequency ( i.e. the cutoff for the hanning filter ) larger than the nyquist frequency @xmath7 for grid spacing @xmath4 .",
    "this is easily done by increasing the nyquist frequency by a factor @xmath202 to include the high - frequency waves in the brillouin zone corners with @xmath203 . for @xmath204 and the power spectrum parameters used before",
    ", this method reproduces the correct peak value of the density transfer function .",
    "however , the spherical method can not reproduce the anisotropy evident in figure [ fig : transd3 ] , which is important on small scales .",
    "( for multilevel refinement , exact sampling requires that we use the anisotropic transfer functions at all but the finest refinement .",
    "the refinement process itself magnifies cubical pixels .",
    "this anisotropy is cancelled by summing over the contributions from different levels of the hierarchy only if we use anisotropic filters . ) on the other hand , the velocity transfer function is an integral over the density transfer function and therefore is much smoother .",
    "errors at small @xmath54 due to the neglect of anisotropy are much less important for the velocity field .",
    "thus , we might approximate the correct , anisotropic transfer function for the radial velocity by the spherical one .",
    "-space filters as described in the text .",
    "the density errors have been scaled to @xmath205 and the velocity errors to @xmath185 .",
    "the minimal method is accurate at small spatial scales ( density ) while the spherical method is accurate at large scales ( velocity ) . ]",
    "based on these considerations , we reconsider both the spherical and minimal @xmath8-space sampling methods for approximating the unfiltered transfer functions .",
    "figure [ fig : dvnohan ] shows the residuals from the exact , anisotropic transfer functions .",
    "comparison with figure [ fig : errmosaic ] shows that removal of the hanning filter adds no significant errors provided that the minimal method is used for the density and the spherical method is used for the velocity .",
    "the spherical method works poorly for the density field because it neglects the small - scale anisotropy .",
    "the minimal method works poorly for the velocity field because it assumes periodicity on a scale twice the subgrid extent .",
    "the minimal sampling method works better than expected for the density transfer function .",
    "the reason for its success is that for cdm - like power spectra the transfer function is dominated by large spatial frequencies for which the coarse sampling of fourier space introduces little error in the discrete fourier transform .",
    "for the velocity transfer function , long - wavelength contributions dominate and the small - scale errors of the spherical method cause little harm .      the next issue to consider is the treatment of tidal fields from coarser levels of the grid hierarchy during the anti - aliasing step . as we found in  [",
    "sec : fixv ] , contributions from fluctuations inside the subvolume can be filtered using the minimal @xmath8-space sampling method , but contributions from tides generated outside the subvolume must be convolved with a sharp @xmath8-space filter .",
    "this requires a clear separation of `` inner '' and `` outer . ''",
    "care is needed in the case of a multilevel hierarchy .",
    "consider , for example , refinement of the 256 mpc top grid shown in figure [ fig : deltop ] in two stages to produce the four - fold refinement of the 32 mpc level-2 subvolume in figure [ fig : multi2 ] .",
    "the level-1 subvolume may have any size between 64 and 128 mpc .",
    "( each refinement must be over a subvolume no more than half the size of the upper - level volume in order to accomodate the buffer region used in the anti - aliasing step . ) when computing the long - wavelength velocity contributions for the level-2 grid , the level-1 fields must be computed with a tidal volume of 32 mpc and not the size of the level-1 subvolume .",
    "moreover , the same is true of the level-0 fields .",
    "correct treatment of the tidal fields requires that _ all _ upper levels be sampled with @xmath206 inside ( or outside ) the final high - resolution subvolume .",
    "this requirement implies that a chain of refinements must be performed for every level of the hierarchy . computing a level-1 refinement requires only one application of convolution plus small - scale noise .",
    "computing a level-2 refinement requires two applications : one to get the level-1 samples with the correct tidal volume and a second to get the level-2 results .",
    "thus , computing all three levels ( 0 , 1 , and 2 ) requires three runs of the periodic grid routine in a box of size 256 mpc ( with no tides , with tides for the level-1 subvolume , and with tides for the level-2 subvolume ) plus three runs of the refinement algorithm .",
    "the process of successive refinement is illustrated in figure [ fig : tide2 ] for the computation of the level-2 velocity field .",
    "the top row is the same as figure [ fig : tides ] except that the buffer has been unwrapped to surround the volume .",
    "however , instead of being prepared for a @xmath108 refinement , these top - level fields are prepared here for a @xmath207 refinement .",
    "they are convolved with the appropriate anti - aliasing filters and short wavelength noise is added to give level 1 , shown in the lower row .",
    "the level-1 tidal fields are resolved better and do not suffer from aliasing at the resolution shown ( 0.5 mpc grid spacing ) .",
    "these fields provide the input to a final @xmath207 refinement to produce the level-2 fields .    comparing the resulting level-2 fields with figure [ fig : grafic1024 ] , we find that the magnitude of the errors depends on the size of the level-1 grid .",
    "for the case shown in figure [ fig : tide2 ] , with a 64 mpc grid , the rms density and velocity errors are 0.02% and 3.9% , respectively .",
    "when the level-1 grid size is increased to its maximum value of 128 mpc , these errors drop to 0.0094% and 3.3% , respectively .",
    "these compare with the errors for a single @xmath108 refinement , 0.10% and 3.2% , respectively .",
    "the density errors have decreased with two @xmath207 refinements compared with one @xmath108 refinement mainly because the minimal @xmath8-space sampling of the anti - aliasing filter is coarser ( hence less accurate ) for @xmath108 .",
    "for the velocity field the errors are dominated not by the coarse sampling errors in @xmath159 but rather in the errors due to its truncation .",
    "in other words , it is the discontinuities at the edge of the buffer region ( shown in figure [ fig : tides ] ) that cause problems .",
    "however , when the top grid is refined by @xmath207 in a subvolume of half its size , the doubling used for the convolution has a fortunate side effect : the buffer region fills out the volume so that the entire top grid is included . in this special case , which applies to our 128 mpc level-1 grid , there are no errors from periodic boundary conditions and the minimal @xmath8-space filter is exact .",
    "the errors arise almost exclusively from the second level of refinement .",
    "thus , the two - level refinement in this case has the same velocity field errors as a single @xmath108 refinement .",
    "the convolution method presented in this paper lends itself to a variety of tricks that can be done with sampling of gaussian random noise .",
    "these need not always involve adaptive mesh refinement and convolution with isolated boundary conditions .",
    "for example , in figure [ fig : grafic1024 ] we achieved multiscale initial conditions using a single high - resolution grid but with the white noise sampled more finely within a subvolume .",
    "this procedure has the advantage of allowing multiscale fields to be computed free from aliasing errors .",
    "although it is limited by computer memory constraints , this method is the preferred choice for producing multiscale fields when computer memory is not a limitation .    our white noise sampling and convolution methods offer another way to change the dynamic range of a simulation while retaining the sampling of a fixed set of cosmic structures .",
    "instead of refining to small scales , one may change the large scale structure in the simulation by expanding or shrinking the top grid size .",
    "this offers a simple and useful way , for example , to add or subtract long waves in order to examine their effect on small scale structure .",
    "this brief section presents the method for expanding or shrinking a simulation .",
    "one way to implement this idea , which we will not explore further , is to take an existing small - scale simulation to provide the high - resolution field @xmath146 as in equation ( [ del12 ] ) . the small volume , originally with periodic boundary conditions , is then embedded with isolated boundary conditions in a new top grid field @xmath161 .",
    "the white noise sample used to generate the existing small - scale simulation is taken to be @xmath143 and a new sample is created for the top grid .",
    "this procedure is the same as that described in ",
    "[ sec : implem ] except that there the top grid sample was given and the subgrid sample was added . here",
    "it is the other way around .",
    "the implementation proceeds as in  [ sec : implem ] .",
    "it is straightforward and need not be elaborated .",
    "an alternative method is to change the size of an existing grid while retaining a fixed grid spacing without refinement .",
    "this method is easy to implement because no aliasing occurs if the grid is not refined .",
    "moreover , periodic boundary conditions are used for all convolutions .",
    "we simply change the scale of periodicity .",
    "this can be achieved using a modified version of the grafic code @xcite called grafic1 which is being distributed along with the mesh - refinement version grafic2 .",
    "the procedure is as follows .",
    "first , identify a volume ( perhaps a subvolume of an existing simulation ) whose size is to be changed .",
    "grafic1 should be run so as to output the white noise field @xmath32 used in constructing the initial conditions .",
    "note that the spatial mean noise level @xmath208 vanishes so that the mean density matches that of the background cosmological model .",
    "this is a consequence of periodic boundary conditions .",
    "the white noise field is now expanded with the addition of new white noise if one wishes to expand the box .",
    "if one wishes to shrink the box instead , then some of the noise field is excised .",
    "the amplitude of the white noise must be changed according to equation ( [ wiener3 ] ) .",
    "for example , if the grid size is doubled in each dimension , the existing sample must be multiplied by @xmath209 and the added noise must have the same variance .",
    "these manipulations are easy to perform in real space .",
    "the absence of any correlations for the white noise makes the treatment of boundary conditions very simple .",
    "note that @xmath208 must vanish on the final grid because of periodic boundary conditions .",
    "however , if the volume has been expanded by a factor @xmath202 , the mean value within the original volume can be changed by adding a constant , e.g. a normal deviate with variance @xmath210 .",
    "finally , the new white noise field is now given as input to a second run of grafic1 , which calculates the density and velocity fields using exact transfer functions .",
    "mpc has been extracted to create a new volume with periodic boundary conditions and with the same structures as the sample on the left.,title=\"fig : \" ]   mpc has been extracted to create a new volume with periodic boundary conditions and with the same structures as the sample on the left.,title=\"fig : \" ]    this procedure is illustrated in figure [ fig : shrinktop ] .",
    "one sees that the structures in the left original volume are reproduced in the new sample but that they are modified at the edges by the requirement of periodic boundary conditions .",
    "this affects the structure to within a distance of a few coherence lengths .",
    "the hot dark matter model ( with @xmath211 and @xmath212 ) was chosen for this test so that the coherence length would be interestingly large .",
    "one also sees that the initial conditions codes do not require the volume to be a cube nor the axis lengths to be powers of 2 .",
    "grafic1 and grafic2 allow for arbitrary parallelpipeds as long as there is at least one factor of two in each axis length .",
    "we have presented an algorithm for adaptive mesh refinement of gaussian random fields .",
    "the algorithm provides appropriate initial conditions for multiscale cosmological simulations . aside from small numerical errors ,",
    "the density and velocity fields at each refinement level are exact samples of gaussian random fields with the correct correlation functions including all contributions from tides generated at lower - resolution refinement levels .",
    "an arbitrary number of refinement levels is allowed in principle , enabling cosmological simulations to be performed which have the correct sampling of fluctuations over arbitrarily large dynamic ranges of length and mass .",
    "two convolutions are performed per refinement level for each field component .",
    "these convolutions are performed using ffts with the grid doubled in each dimension .",
    "thus , the computer memory and time requirements for adaptive mesh refinement are significantly greater than for sampling of gaussian random fields with a single grid .",
    "one advantage of the refinement algorithm is that the dynamic range in mass is not limited by the size of the largest fft that can fit into memory .",
    "also , it automatically provides the correct initial conditions for multiscale simulations such as that of @xcite .    adaptive mesh refinement of gaussian random fields is more complicated than refinement of , for instance , the fluid variables in a hydrodynamics solver .",
    "the reason for this is that gaussian random fields have long - range correlations .",
    "correct refinement within a subvolume can not be done independently of the lower resolution fields outside that subvolume . when the resolution is increased by decreasing the pixel size , a given sample suffers from aliasing .",
    "correct sampling requires convolution by an anti - aliasing filter .",
    "short - wavelength contributions are then provided by convolution of white noise with the appropriate transfer function .",
    "due mainly to imperfect anti - aliasing , numerical errors prevent one from achieving perfect sampling of multiscale initial conditions .",
    "however , with careful analysis of the source of errors  primarily from tides generated outside the subvolume  we have reduced these errors to an acceptable level . in testing with a realistic cosmological model ,",
    "the rms errors for a four - fold refinement were 0.1% or smaller for the density and 3% for the velocity .",
    "we showed that the most accurate results are achieved by refinement factors of two , with each successive subvolume occupying one - eighth the volume ( half the linear extent ) of the parent mesh . for a single refinement level ,",
    "the anti - aliasing errors vanish in this case .",
    "further testing is advised before the code is run to more than 4 refinement levels or a total refinement greater than 16 .",
    "also , some of the same numerical issues ( e.g. refinement of tidal fields ) identified here may arise in the gravity solvers used by nonlinear evolution codes .",
    "careful testing of both the initial conditions and the nonlinear simulations codes is advised before workers apply them to dynamic ranges in mass exceeding @xmath213 .",
    "unfortunately , it is very difficult to provide exact standards for comparison with grid hierarchies of such large dynamic range .",
    "the algorithm described in this paper has been implemented in fortran-77 and released in a publically available code package that can be downloaded from http://arcturus.mit.edu / grafic/. the package has three main codes :    1 .",
    "lingers is an accurate linear general relativity solver that calculates transfer functions at a range of redshifts .",
    "2 .   grafic1 computes single - grid gaussian random field samples with periodic boundary conditions .",
    "3 .   grafic2 refines gaussian random fields starting with those produced by grafic1 .",
    "it may be run repeatedly to recursively refine gaussian random fields to arbitrary refinement levels .",
    "lingers is a modification of the linger_syn code from the cosmics package @xcite .",
    "it produces output at a range of times enabling accurate interpolation to the starting redshift of the nonlinear cosmological simulation .",
    "cmbfast @xcite could be used instead , although the treatments of normalization and units are different for the two codes .",
    "grafic1 is a modification of the grafic code from cosmics that incorporates exact transfer functions for both cdm and baryons at arbitrary redshift from lingers and uses white noise sampled in real space as the starting point for gaussian random fields . as demonstrated in ",
    "[ sec : tricks ] , sampling of white noise enables one to change the size of the computational volume , or to embed a given realization into a larger volume with different resolution , simply by modifying the noise file . grafic1 and grafic2 also have optional half - mesh cell offsets for the cdm or baryon grids .",
    "grafic2 is the multiscale adaptive mesh refinement code .",
    "it requires substantial computing requirements for large grids , mainly because of the need to double the extent of each dimension . thus , suppose that one has a @xmath214 top grid and wishes to double the resolution in one - eighth of the volume . computing the @xmath214 sample with grafic1 requires 64 mb of memory . refining it with grafic2",
    "requires 1.02 gb of memory and 3.5 gb of scratch disk .",
    "the cpu time is also much larger , but is still far less than the time required for the nonlinear evolution .",
    "fortunately , these computing resources are now available on desktop machines .",
    "much larger grids are possible with parallel supercomputers .",
    "i thank my colleagues in the grand challenge cosmology consortium  j. p. ostriker , m. l. norman , and l. hernquist  for encouragement in this work .",
    "special thanks are given to l. hernquist and the harvard - smithsonian center for astrophysics for hosting my sabbatical during this work .",
    "supercomputer time was provided by the national computational science alliance at the university of illinois at urbana - champaign .",
    "financial support was provided by nsf grants aci-9619019 and ast-9803137 .",
    "99 abel , t. , bryan , g. l. , & norman , m. l. 2000 , , 540 , 39 bertschinger , e. 1995 , cosmics software release ( astro - ph/9506070 ) bertschinger , e. 1998 , , 36 , 599 colberg , j. m. et al .",
    ", , 319 , 209 fukushige , t. & makino , j. 1997 , , 477 , l9 ghigna , s. , moore , b. , governato , f. , lake , g. , quinn , t. , & stadel , j. 2000 , , 544 , 616 hoffman , y. & ribak , e. 1991 , , 380 , l5 katz , n. , quinn , t. , bertschinger , e. , & gelb , j. 1994 , , 270 , l1 ma , c .- p . & bertschinger , e. 1995 , , 455 , 7 pen , u .- l .",
    "1997 , , 490 , l127 salmon , j. 1996 , , 460 , 59 seljak , u. & zaldarriaga , m. 1996 , , 469 , 437"
  ],
  "abstract_text": [
    "<S> this paper describes the generation of initial conditions for numerical simulations in cosmology with multiple levels of resolution , or multiscale simulations . </S>",
    "<S> we present the theory of adaptive mesh refinement of gaussian random fields followed by the implementation and testing of a computer code package performing this refinement called grafic2 . </S>",
    "<S> this package is available to the computational cosmology community at http://arcturus.mit.edu/grafic/ or by email from the author . </S>"
  ]
}