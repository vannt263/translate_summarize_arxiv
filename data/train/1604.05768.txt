{
  "article_text": [
    "efficient numerical methods for simulating the propagation of acoustic , elastic , or anelastic waves in the time domain are widely available , for instance based on finite - difference methods  ( see e.g. , * ? ? ?",
    "* for a review ) , spectral - element methods  ( e.g. , * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "* ) , or standard finite - element methods  ( e.g. , * ? ? ?",
    "nowadays , these techniques are heavily used for imaging based on full waveform inversion ( fwi ) or adjoint tomography  ( e.g. , * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "fwi involves fitting band - pass filtered versions of observed seismograms by minimizing least - squared differences between observed and synthetic seismograms .",
    "adjoint tomography generalizes fwi by considering arbitrary measures of misfit , e.g. , cross - correlation traveltimes , multi - taper phase and amplitude anomalies , or instantaneous phase measurements .    in the context of imaging ,",
    "it is useful to resort to the concept of sensitivity kernels  ( e.g. , * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "let  @xmath12 denote the forward displacement wavefield and  @xmath13 the adjoint wavefield .",
    "in an isotropic earth model , the kernels  @xmath14 and  @xmath15 represent frchet derivatives with respect to relative bulk and shear moduli perturbations , respectively .",
    "these kernels are given by  ( e.g. , * ? ? ?",
    "* ) @xmath16[{\\mbox{\\boldmath $ \\nabla$}}\\cdot { \\mbox{${\\bf s}$}}({\\mbox{${\\bf x}$}},t)]{\\ , \\mathrm{d}}t \\ , , \\label{definition_of_kkappa}\\ ] ] @xmath17 where @xmath18 - \\frac{1}{3 } ( { \\mbox{\\boldmath $ \\nabla$}}\\cdot { \\mbox{${\\bf s}$}})\\,{\\mbox{${\\bf i}$}}\\ ] ] and @xmath19 - \\frac{1}{3 } ( { \\mbox{\\boldmath",
    "$ \\nabla$}}\\cdot { \\mbox{${\\bf s}$}}^\\dagger)\\,{\\mbox{${\\bf i}$}}\\ ] ] denote the traceless strain deviator and its adjoint , respectively ,  @xmath20 is the position vector , and  @xmath21 and  @xmath22 are the bulk and shear moduli , respectively .",
    "their expression remains valid for elastic perturbations superimposed on an anelastic earth model @xcite if the regular and adjoint wavefields are computed in that anelastic reference model . in practical applications",
    ", it is often useful to define compressional and shear wavespeed sensitivity kernels , namely @xcite @xmath23 and @xmath24 in order to perform the convolution involved in the calculation of the kernels  ( [ definition_of_kkappa ] ) and  ( [ definition_of_kmu ] ) , simultaneous access to the forward wavefield  @xmath12 at time  @xmath25 and the adjoint wavefield  @xmath13 at time  @xmath26 is required ( or conversely , since  @xmath27 when convolving two functions  @xmath28 and  @xmath29 ) .",
    "carrying out forward and adjoint simulations simultaneously is insufficient , because in that case both wavefields are only available at a given time  @xmath25 .",
    "in addition , to calculate the adjoint wavefield one must prescribe the adjoint source , and that source is computed based on measurements between observed and simulated seismograms , i.e. , it can only be constructed after the completion of a forward simulation .",
    "a straightforward solution to this dilemma is to store the entire forward simulation to disk and then read it back in reverse order during the adjoint simulation . for 1d or 2d models",
    "this is feasible  ( e.g. , * ? ? ?",
    "* ) , but in 3d at short periods without lossy compression or significant spatial or temporal sub - sampling  @xcite the required amount of disk storage is currently prohibitive .",
    "it is worth mentioning that this situation will likely change in the future , but not any time soon .",
    "in addition , heavy i / o involved in reading back the forward wavefield can significantly slow down the simulation  @xcite .",
    "for nondissipative acoustic or elastic media , a standard solution for large 3d problems is to perform three simulations per source  @xcite .",
    "one performs the forward calculation twice : once to compute the adjoint sources and once again in reverse time simultaneously with the adjoint simulation performed in forward time to correlate the two fields and sum their interaction on the fly over all time steps .",
    "thus , one only needs a small amount of disk storage to store the last time step of the forward run , which is then used as an initial condition to recalculate the forward wavefield backwards in time with a negative time step . based on this strategy , one has simultaneous access to the adjoint wavefield at time  @xmath25 and the forward wavefield at time  @xmath26 , which is what is required to perform the convolution involved in the construction of the kernels  ( [ definition_of_kkappa ] ) and  ( [ definition_of_kmu ] ) . in the anelastic case , as shown by @xcite , the wave equation is no longer self adjoint , leading to exponential growth of energy in the adjoint equation ( i.e. , ` anti attenuation ' ) .",
    "however , in the calculation of sensitivity kernels this does not matter , because this process involves the _ time - reversed _",
    "adjoint wave equation rather than the adjoint wave equation . in this respect",
    ", it is worth mentioning that @xcite have a time - reversed definition of the adjoint state compared to the classical one of e.g. @xcite and @xcite , i.e. they use the time - reversed equation  ( 35 ) of @xcite instead of his equation  ( 32 ) .",
    "thus ` anti attenuation ' in forward time becomes attenuation in reverse time , and the time - reversed adjoint wave equation is identical to the classical forward wave equation  @xcite .",
    "consequently , both the forward and the adjoint wavefields are attenuated during the calculation of the kernel .",
    "this makes physical sense , because as the distance between two seismic stations increases , one expects the sensitivity kernel to become weaker and weaker as a result of dissipation .",
    "unfortunately , in the presence of attenuation the process of reconstructing the forward wavefield backwards in time based on the final snapshot and a negative time step is numerically highly unstable  ( e.g. , * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "this results in numerical instabilities during the calculation of anelastic sensitivity kernels , not because of the adjoint run , but because of the forward run that needs to be performed backwards in time .",
    "an approximate solution to this conundrum involves modifying the wave equation to introduce filtering or other stabilizing terms , or incorporating only certain aspects of anelasticity .",
    "@xcite introduced a promising regularized time - reversal imaging technique which corrects attenuation effects to first order .",
    "however , their approach involves significant filtering , thereby affecting the quality of the resulting signals , in particular at high frequencies , and it is currently limited to simple models of weak attenuation in homogeneous media .",
    "in particular , the approach can not handle models comprised of standard linear solids . @xcite and",
    "@xcite introduce partial support for attenuation in reverse - time migration by separating amplitude attenuation and phase dispersion operators  @xcite .",
    "they construct attenuation- and dispersion - compensated operators by reversing the sign of the attenuation operator and leaving the sign of the dispersion operator unchanged ; they then design a low - pass filter for these operators to stabilize the numerical procedure and avoid amplifying high - frequency noise that would trigger instabilities .",
    "changing the sign of one of the terms in the backward integrations to stabilize the calculations is also classically done in so - called back - and - forth nudging algorithms  @xcite .",
    "an alternative solution consists of resorting to so - called ` partial checkpointing ' or ` optimal checkpointing ' , i.e. , using partial storage to disk , but , realizing that storage size limitations or slowdown related to disk storage are important issues  @xcite , defining an optimized sequence in which the forward and adjoint time steps are performed , essentially trading storage requirements for longer computation times .",
    "this elegant idea was introduced by  @xcite and  @xcite .",
    "@xcite used a recursive strategy to compute the optimized order in which the simulation steps need to be performed and showed that when the schedule is optimized the storage and computational times grow at most logarithmically , and  @xcite defined an algorithm called ` revolve ' that is provably optimal to reduce storage requirements .",
    "@xcite used it for the meteorological model ` meso - nh ' and proposed several variants depending on user preference between cpu time and memory optimization .",
    "@xcite ,  @xcite , and  @xcite resorted to it for fwi as well as reverse - time migration .",
    "@xcite applied it to the instationary navier - stokes equations , and more recently  @xcite included it in a jet - engine noise reduction simulation code .",
    "a limitation of the original ` revolve ' algorithm of  @xcite is that it requires _ a priori _ knowledge of the total number of time steps to be performed , making it incompatible with adaptive time stepping .",
    "@xcite have addressed that issue by introducing a dynamic checkpointing algorithm that is applicable even when the total number of time steps is _ a priori _ unknown .",
    "another more precise , but also more expensive approximate solution is to accommodate the effects of physical dispersion induced by attenuation , but not the effects of dissipation . to appreciate this ,",
    "consider the frequency - dependent shear modulus in a constant - q absorption - band solid , namely  ( e.g. , * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "* ) @xmath30 here  @xmath31 denotes the angular frequency of interest , @xmath32 a chosen reference frequency , and  @xmath33 a frequency - independent shear quality factor .",
    "the effects of physical dispersion are captured by the logarithmic term , @xmath34 , and the effects of dissipation by the complex part of the modulus , @xmath35 .",
    "based on these observations , partial support for attenuation is accommodated by performing a total of four simulations per source  ( e.g. , * ? ? ?",
    "* ; * ? ? ?",
    "* ) , instead of three in the nondissipative case  @xcite .",
    "in a first stage , one runs a forward simulation twice in the forward direction , once with full attenuation and once with physical dispersion only .",
    "the second calculation is therefore a purely elastic calculation , but for a wavespeed model that is shifted to the dominant frequency of the source , @xmath36 , based on the correction @xmath37 \\ , ,   \\label{eq : pd}\\ ] ] as illustrated in figure  [ taking_into_account_average_physical_dispersion ] .",
    "the first forward run with full attenuation is used to make the measurements needed in the construction of the adjoint sources for the third run , and the second forward run with physical dispersion only is used to compute and store the final time step to be able to time - reverse that calculation in the fourth run .",
    "the third and fourth runs are carried out simultaneously to calculate the kernel , and both these runs are purely elastic and use a wavespeed model that is shifted to the dominant frequency of the source .",
    "the fourth run is thus stable , because it involves time reversal of an elastic simulation .",
    "note , however , that the measurements that are assimilated in the third run are based on synthetics computed with full attenuation .",
    "it is important to recognize that the significance of anelastic effects on sensitivity kernels very much depends on the type of measurement one chooses to make .",
    "for example , as demonstrated by  @xcite , the sensitivity kernel for a cross - correlation traveltime measurement is identical to the so - called ` banana - donut ' kernel first introduced by  @xcite .",
    "such kernels may be calculated based on ray theory , and the related expressions are largely unaffected by attenuation .",
    "physically , this reflects the fact that traveltimes are affected by wavespeed , and only very marginally by dissipation .",
    "more generally , as long as one focuses on measuring phase , e.g. , frequency - dependent traveltime or instantaneous phase , the corresponding kernels are largely unaffected by attenuation  @xcite .",
    "however , for inversions involving amplitude measurements , including fwi , attenuation plays a critical role .",
    "more generally , attenuation is important on a global scale  ( e.g. , * ? ? ?",
    "* ; * ? ? ?",
    "* ) , in exploration geophysics  ( e.g. , * ? ? ?",
    "* ; * ? ? ?",
    "* ) , and in near - surface geophysics or for site effects in poorly consolidated sediments  ( e.g. , * ? ? ?",
    "* ; * ? ? ?",
    "we demonstrate in this paper that global simulations of surface waves at periods less than 4060  s must accommodate the full effects of attenuation .    to some extent",
    ", the accuracy of the gradient is not that critical in the early stages of an inversion , because as part of the iterative inversions scheme , e.g. , a non - linear conjugate gradient method or a l - bfgs quasi - newton method , the raw gradient is generally smoothed and preconditioned  ( e.g. , * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    ". nevertheless , as the inversion proceeds and the frequency content of the seismograms is increased , details in the gradient matter , and its accurate calculation becomes highly relevant .",
    "in view of eqns .",
    "( [ definition_of_kkappa ] ) and  ( [ definition_of_kmu ] ) , for simulations in the time domain consisting of  @xmath38 time steps numbered from  1 to  @xmath38 , the contribution to adjoint - based sensitivity kernels at time step  @xmath39 is obtained by combining information coming from time step  @xmath39 of the adjoint run simultaneously with information coming from time step  @xmath40 of the forward run .",
    "two classical approaches can be used to facilitate this , namely , at low to moderate frequencies and/or small to moderate model sizes one can consider storing the entire forward run to disk ( process  a ; see figure  [ how_we_can_undo_attenuation]a ) , and reading it back from disk in reverse order during the adjoint run .",
    "lossless or lossy compression  @xcite or spatial or temporal sub - sampling  @xcite can be helpful in this context .",
    "however , the required amount of storage is currently unaffordable and will remain so for many years to come , and , in addition , heavy i / o will significantly slow down the simulation code  @xcite .",
    "another classical approach  ( e.g. , * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "* ) is to first perform the forward run and store its final time step to disk , and in a second stage perform the adjoint run in the forward direction while simultaneously redoing the forward run backwards , reversing time and starting from the final time step ( process  b ; see figure  [ how_we_can_undo_attenuation]b ) . in the acoustic or elastic case , i.e. , when total energy is conserved , this process is numerically stable and its only two drawbacks are that the compute time increases by a factor of 3/2 because the forward run needs to be performed twice , and that the required memory size increases by a factor of two because during the second stage two runs need to be performed simultaneously in memory .",
    "let us note that the first drawback is not that serious compared to process  a ( figure  [ how_we_can_undo_attenuation]a ) , because heavy i / o slows the latter down down considerably .",
    "unfortunately , as mentioned above , process  b can not be used without heavy filtering and resulting significant loss of accuracy  ( e.g. , * ? ? ?",
    "* )  in the anelastic case or in the presence of any kind of energy loss , because time - reversing energy decay is unstable from a numerical point of view  ( e.g. , * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "* and references therein ) .",
    "the reason is that while amplifying the fields to restore energy when going backwards , numerical schemes will also amplify numerical noise and thus very quickly become unstable .",
    "even if full attenuation can not be taken into account in process  b , it can be partially accommodated by performing two runs instead of one during stage  1 , as we will see in more details in section  [ sectionimportance ] : one with full attenuation to make measurements to be used in the calculation of the adjoint sources for stage  2 , and another one with physical dispersion only in order to compute and store the final time step and be able to time - reverse that calculation in stage  2 . in the literature",
    "it is often mentioned  ( e.g. , * ? ? ?",
    "* ; * ? ? ?",
    "* ) that during stage  2 one needs to reverse time and perform the forward run backwards , but , more precisely , the only requirement is to have access to time step  @xmath40 of the forward run , regardless of whether it is computed backward or forward in time .",
    "thus , on computers that have a significant amount of memory which is always the case on modern compute clusters a third process can be designed , which is stable even in the presence of energy loss ( process  c ; see figure  [ how_we_can_undo_attenuation]c ) . in this approach , during the first stage one saves a small number of evenly - spaced checkpointing / restart files of the three components of the displacement field to disk , typically one every few hundred or thousand time steps ; during the second stage one still performs two simulations simultaneously , one adjoint run and one forward run , but instead of performing the forward run _ backward _ from the stored final time step one performs it in chunks , in reverse order , but in the _ forward _ direction inside each chunk . in each instance one",
    "starts from the previous restart file of displacement read back from disk , storing only that sub - part of the run in memory .",
    "since the run is conducted forward rather than backward in time , this process is always stable , even in the presence of attenuation .",
    "it is also exact , since no filtering is involved .",
    "process  c is computationally meaningful compared to process  a only if the number of time steps between two checkpoints is sufficiently large , say a few hundred to a few thousand , i.e. , if the total memory available as a storage buffer is large enough .",
    "fortunately , in practice that is almost always the case on modern compute clusters .    compared to the more involved ` revolve ' algorithm of  @xcite discussed in the introduction , which is provably optimal in terms of minimizing the number of time steps to store in memory  ( see also , e.g. , * ? ? ?",
    "* ) , our choice is different and rather makes optimal use of the entire computer memory , i.e. , it maximizes memory usage instead of trying to minimize it .",
    "the rationale for this is that monitoring of typical large wave propagation simulations , for instance in seismology or in the oil industry , shows that considering the large compute clusters or supercomputers which are nowadays readily available users use only a small portion of the memory available per compute node , typically between 5% and 30% , because they generally harness a relatively large number of processor cores to keep the calculation relatively fast .",
    "thus , leaving 5% for the operating system of the machine , between 65% and 90% of the total memory is available and can be used as a memory buffer .",
    "this enables one to store at least hundreds of time steps of the displacement vector , sometimes even a few thousand .",
    "the number of time steps that can be stored is readily computed in an exact fashion once and for all before the time loop by dividing the size of the available free computer memory by the ( constant ) size of the array that contains the three components of the displacement vector at a given time step .",
    "note that sensitivity kernel calculations often require the strain  ( e.g. , * ? ? ?",
    "* ; * ? ? ?",
    "* as well as eqns .",
    "[ definition_of_kkappa ] and  [ definition_of_kmu ] ) , but to reduce storage to disk , which is both disk - space consuming and slow , we usually recompute the strain from the stored displacement instead of storing it .    in terms of implementation",
    ", adding this approach to an existing code is easy because it consists mainly of restructuring the time loop and implementing a simple memory buffer system .",
    "note that the cost does not increase compared to process  b , because we perform the same total number of operations , simply in a different order .",
    "if attenuation is partially taken into account in process  b , four runs are needed instead of three , as mentioned above , and in such a case process  c is cheaper by a factor  4/3 .",
    "the writing of checkpointing files to disk during stage  1 of the algorithm may be non - blocking ( if technically feasible on the file system ) , thereby allowing for overlapping of disk writes with calculations , because these restart files are reused much later in the algorithm , during stage  2 .",
    "the reason why a memory buffer is needed during stage  2 is that in order to gain access to time step  @xmath40 of the forward run , this buffer will be filled in forward order from the previous restart file , but will then be accessed backward , i.e. , in reverse order from its end , a policy often called ` last in , first out ' ( lifo ) .    interestingly , even in the case of purely acoustic or elastic sensitivity kernels , i.e. , in the absence of attenuation , process  c is a little more accurate than process  b in terms of numerical errors , because in  c one computes the exact same forward run twice , the second time from intermediate restart files , thus resetting numerical errors and getting cumulated numerical dispersion for a total of  @xmath38 time steps only , while in  b one performs the forward simulation and then a second forward simulation backwards from the saved snapshot of the final time step , thus getting cumulated numerical dispersion for a total of  @xmath41 time steps .",
    "in this section we validate our approach to compute anelastic sensitivity kernels ( process  c shown in figure  [ how_we_can_undo_attenuation]c ) by comparing its results to those obtained with the exact approach ( process  a shown in figure  [ how_we_can_undo_attenuation]a ) . in order to illustrate the effects of full attenuation on sensitivity kernels , we also compare our kernels to an approximate kernel in which only physical dispersion is taken into account , i.e. , process  b shown in figure  [ how_we_can_undo_attenuation]b , but with a total of four runs performed instead of three , as discussed in section  [ introduction ] .",
    "we calculate kernels for a cross - correlation traveltime measurement , i.e. , we use time - reversed particle velocity as the adjoint source , as explained in  @xcite .    in order to perform the benchmark",
    ", we resort to the spectral - element method  ( e.g. , * ? ? ?",
    "* ; * ? ? ?",
    "the mesh of hexahedra used in the 3d simulations is designed to honor all first - order discontinuities in the preliminary reference earth model ( prem )  @xcite , which are the moho at a depth of 24.4  km , the upper mantle discontinuities at depths of 220  km , 400  km , and 670  km , the core - mantle boundary , and the inner - core boundary ; it also honors second - order discontinuities at 600  km , 771  km , and at the top of the d  layer .",
    "the mesh is doubled in size once below the moho , a second time below the 670  km discontinuity , and a third time in the middle of the outer core  @xcite .",
    "each of the six chunks that comprise the so - called ` cubed sphere ' that the spectral - element technique uses to mesh the earth has 256  @xmath42  256 elements along the free surface and , as a result of the three doublings , 32  @xmath42  32 elements along the inner - core boundary , leading to a total of 4,352,000 spectral elements to mesh the entire globe .",
    "the radial density and velocity profiles of the model are determined by prem .",
    "the 3-km thick water layer of prem has been replaced with the prem upper crust .",
    "prem has a transversely isotropic asthenosphere between 24.4  km and 220  km , which is also incorporated in our simulations . based on the size of the mesh cells , the simulations presented in this section are accurate for periods greater than about 17  s. to ensure stability and accuracy of the calculations we use a time step  @xmath43 = 0.19  s. we simulate a total duration of 5,400  s , i.e. , 28,600 time steps .",
    "we resort to parallel computing using a total of 384 processor cores .",
    "a source with a source time function with a half duration of 11.2  s , strike of @xmath44 , dip of  @xmath45 , and rake of  @xmath46 is located at latitude @xmath47 and longitude  @xmath48 , at a depth of 15  km ( corresponding to event 112699 g in the global cmt catalog ) .",
    "a receiver is located on the surface of the earth at latitude  @xmath49 and longitude  @xmath50 , at an epicentral distance of  @xmath51 , and records the three components of the displacement vector .",
    "figure  [ attenuation - comparison ] shows the  @xmath0 sensitivity kernel defined by equation  ( [ definition_of_kalpha ] ) in the 100200  s period range obtained based on processes  a , b , and c. the difference between processes  a and c is shown in figure  [ attenuation - comparison]e and confirms that our technique works well and is exact .",
    "when using physical dispersion in process  b , the difference in the resulting kernel is on average  30% of the exact result , as shown in figure  [ attenuation - comparison]d .",
    "the non - negligible differences that appear when only physical dispersion is taken into account rather than full attenuation highlight the importance of including full attenuation in the calculation of sensitivity kernels , as discussed further in the next section .",
    "note that the convention for traveltime kernels throughout this paper is such that @xmath52 , where @xmath53 and @xmath54 are the travel times of observed and synthetic data ( e.g. , * ? ? ?",
    "* ; * ? ? ?",
    "we have chosen to represent the  @xmath0 kernel because , as shown in equation  ( [ definition_of_kalpha ] ) , it requires saving a single scalar to disk during stage  1 of process  a , namely the trace of the strain tensor , @xmath55 , as a function of time and space .",
    "saving that scalar required 16  tb of disk space , thus illustrating that process  a is currently inconvenient and can not be routinely used when conducting seismic imaging at relatively high frequencies . in comparison ,",
    "computing the exact  @xmath56 kernel given by equation  ( [ definition_of_kbeta ] ) via process  a would require 50  tb of additional disk storage .",
    "in this section we compare sensitivity kernels calculated based on physical dispersion only ( process  b ) with exact kernels calculated based on our new parsimonious storage technique ( process  c ) . as discussed in detail by  @xcite , for body - wave traveltime measurements attenuation can be safely ignored , as long as the kernels are calculated in models with the appropriate wavespeed , that is , taking into account the effects of physical dispersion defined in equation  ( [ eq : pd ] ) and illustrated in figure  [ taking_into_account_average_physical_dispersion ] .",
    "@xcite also show that for intermediate - period surface waves at regional distances the physical - dispersion - only approach is perfectly valid .",
    "thus the use of process  b to accommodate the effects of attenuation in regional - scale studies ( e.g. , * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "* ) is well justified .",
    "process  b may be summarized as follows :    1 .",
    "compute two sets of synthetic seismograms , 1 ) using full attenuation , and 2 ) using physical dispersion only",
    "make measurements between observed and synthetic seismograms with full attenuation .",
    "3 .   calculate sensitivity kernels for this measurement using physical - dispersion - only forward and adjoint wavefields .",
    "4 .   compute the gradient by weighting the kernels obtained in step  ( iii ) with the measurements from step  ( ii ) .",
    "note that process  b is suitable for cross - correlation or frequency - dependent ( e.g. , multi - taper ) traveltime and amplitude anomaly measurements , but nor for fwi .",
    "in contrast , the new approach based on process  c , taking into account full attenuation , may be summarized as follows :    1 .",
    "compute synthetic seismograms using full attenuation .",
    "2 .   make measurements between observed and synthetic seismograms with full attenuation .",
    "3 .   calculate sensitivity kernels for this measurement using forward and adjoint wavefields with full attenuation based on process  c. 4 .",
    "compute the gradient by weighting the kernels obtained in step  ( iii ) with the measurements from step  ( ii ) .",
    "the number of simulations required for process  c is reduced by a factor  4/3 compared to process  b , although the extra cost is partially offset by relatively cheaper physical dispersion - only simulations in process  b.    in figure  [ fig : rayleigh ] , we present horizontal cross - sections of multi - taper traveltime shear - wavespeed sensitivity kernels defined by equation  ( [ definition_of_kbeta ] ) at depths of 30  km and 125  km for 4060  s vertical - component rayleigh waves using physical - dispersion - only and full attenuation , respectively .",
    "we used 3d mantle model s40rts @xcite together with 3d crustal model crust2.0 @xcite as a background model during forward and adjoint simulations . confirming observations by  @xcite , the two sets of kernels are in good agreement .",
    "the corresponding r1 and r2 seismograms together with their adjoint sources computed based on cross - correlation and multi - taper measurements are shown in figure  [ fig : waveforms_rayleigh ] .",
    "the difference between physical - dispersion - only and full - attenuation kernels is mainly in amplitude , although the former exhibit slight differences in shape compared to the latter .",
    "the success of physical - dispersion - only kernels strongly depends on the choice of measurement and the bandpass . as long as the physical - dispersion - only and full attenuation waveforms are similar in shape",
    ", the resulting kernels will also be similar , as is clearly shown for 40  s rayleigh waves .    in figure",
    "[ fig : love ] , we present horizontal cross - sections of love - wave multi - taper traveltime shear wavespeed sensitivity kernels defined by equation  ( [ definition_of_kbeta ] ) at 30  km and 125  km depths . shown",
    "are 4060  s transverse - component love - wave kernels using physical - dispersion - only and full attenuation , respectively .",
    "again , s40rts @xcite together with crust2.0 @xcite is used during the numerical simulations . the corresponding g1 and g2 seismograms together with their adjoint sources computed based on cross - correlation and multi - taper measurements",
    "are shown in figure  [ fig : waveforms_love ] .",
    "for these shorter period love waves we see that the physical dispersion - only sensitivity kernels are beginning to break down , especially along the major arc , mainly due to their stronger sensitivity to the 3d crustal heterogeneity .",
    "we have introduced a method of computing exact anelastic sensitivity kernels in the time domain using parsimonious disk storage and a simple reordering of the time loop , combined with the use of a ` last in , first out ' memory buffer .",
    "the total number of time steps required is unaffected compared to usual approaches for the acoustic or elastic ( nondissipative ) cases .",
    "we reduced the computational cost by a factor  4/3 compared to a commonly used approach in which only the effects of physical dispersion associated with anelasticity are taken into account .",
    "we performed a benchmark in which we compared the compressional wavespeed sensitivity kernel obtained based on our approach to the exact kernel obtained by saving the entire forward calculation to disk ; the difference was zero , confirming that our approach is also exact . for shorter - period surface waves we discovered non - negligible kernel differences , thus illustrating the importance of including full attenuation in sensitivity kernel calculations for dispersive waves .",
    "the technique applies without modification to problems in reverse - time migration , which may be viewed as a particular case of a sensitivity kernel calculation ( e.g. , * ? ? ?",
    "* ; * ? ? ?",
    "* ) , time - reversal seismological source studies  ( e.g. , * ? ? ?",
    "* ) , and time reversal as used in medical imaging or non - destructive testing  ( e.g. , * ? ? ?",
    "* ; * ? ? ?",
    "it would work for maxwell s equations as well , since they can be written as a hyperbolic system and are also self - adjoint in the absence of dissipation .",
    "the technique works particularly well on gpu - accelerated machines  ( e.g. , * ? ? ?",
    "* ; * ? ? ?",
    "* ) , because the entire memory of the cpu is largely unused and thus available as a huge memory buffer .",
    "our specfem open source spectral - element software package is freely available via the computational infrastructure for geodynamics ( cig ; ` geodynamics.org ` ) , including the new developments presented in this article .",
    "we thank mark asch , didier auroux , cdric bellis , lie bretin , andreas fichtner , josselin garnier , thomas guillet , ioannis g.  kevrekidis , bruno lombard , vadim monteiller , and william w. symes for fruitful discussion , and the computational infrastructure for geodynamics ( cig ) and marie cournille for support .",
    "we thank heiner igel and an anonymous reviewer for useful comments that improved the manuscript .",
    "part of this work was funded by the simone and cino del duca / institut de france / french academy of sciences foundation under grant # 095164 , by the european union horizon 2020 marie curie action # 641943 project ` waves ' of call h2020-msca - itn-2014 , by u.s .",
    "nsf grant 1112906 and by china nsfc grant  51378479 .",
    "thanks the china scholarship council for financial support during his stay at lma cnrs , and the continuous support from prof .",
    "liao zhenpeng .",
    "e.s .  and q.l .  were supported by the nserc g8 research councils initiative on multilateral research grant no .",
    "490919 and discovery grant no .",
    "this work was granted access to the european partnership for advanced computing in europe ( prace ) under allocation tgcc curie # ra2410 , to the french hpc resources of tgcc under allocation # 2015-gen7165 made by genci and of the aix - marseille supercomputing mesocenter under allocations # 14b013 and # 15b034 , to the oak ridge leadership computing facility at oak ridge national laboratory , usa , which is supported by the office of science of the u.s .",
    "department of energy under contract no .",
    "de - ac05 - 00or22725 , and to the sandybridge cluster at the scinet hpc consortium funded by the canada foundation for innovation , the ontario research fund , and the university of toronto startup fund .",
    "part of this work was presented at the gpu2014 conference in roma , italy , in september 2014 .",
    "akelik , v. , bielak , j. , biros , g. , epanomeritakis , i. , fernandez , a. , ghattas , o. , kim , e.  j. , lopez , j. , ohallaron , d. , tu , t. , & urbanic , j. , 2003 .",
    "high - resolution forward and inverse earthquake modeling on terascale computers , in _ proceedings of the sc03 acm / ieee conference on supercomputing _ , pp .",
    "5272 , phoenix , arizona , usa .",
    "assimaki , d. , kallivokas , l.  f. , kang , j.  w. , li , w. , & kucukcoban , s. , 2012 .",
    "time - domain forward and inverse modeling of lossy soils with frequency - independent @xmath57 for near - surface applications , _ soil dynamics and earthquake engineering _ , * 43 * , 139159 .",
    "auroux , d. , bansart , p. , & blum , j. , 2013 .",
    "an evolution of the back and forth nudging for geophysical data assimilation : application to burgers equation and comparisons , _ inverse problems in science and engineering _ , * 21*(3 ) , 399419 .",
    "blanc , e. , komatitsch , d. , chaljub , e. , lombard , b. , & xie , z. , 2016 .",
    "highly accurate stability - preserving optimization of the zener viscoelastic model , with application to wave propagation in the presence of strong attenuation , _ geophys .",
    "_ , * 205*(1 ) , 427439 .",
    "chen , m. , niu , f. , liu , q. , tromp , j. , & zheng , x. , 2015 .",
    "multi parameter adjoint tomography of the crust and upper mantle beneath east asia : 1 .",
    "model construction and comparisons , _ j. geophys .",
    "_ , * 120 * , 17621786 .",
    "felgenhauer , u. , 1992 .",
    "quasi - newton descent methods with inexact gradients , in _",
    "operations research 91 _ , pp .",
    "8386 , eds gritzmann , p. , hettich , r. , horst , r. , & sachs , e. , physica - verlag , heidelberg , germany .",
    "fichtner , a. , kennett , b. l.  n. , igel , h. , & bunge , h.  p. , 2009 . full seismic waveform tomography for upper - mantle structure in the australasian region using adjoint methods , _ geophys",
    "_ , * 179*(3 ) , 17031725 .",
    "griewank , a. & walther , a. , 2000 .",
    "algorithm 799 : revolve , an implementation of checkpointing for the reverse or adjoint mode of computational differentiation , _ acm transactions on mathematical software _ , * 26*(1 ) , 1945 .",
    "hinze , m. , walther , a. , & sternberg , j. , 2006 .",
    "an optimal memory - reduced procedure for calculating adjoints of the instationary navier - stokes equations , _ optimal control applications and methods _ , * 27*(1 ) , 1940 .",
    "kallivokas , l.  f. , fathi , a. , kucukcoban , s. , stokoe ii , k.  h. , bielak , j. , & ghattas , o. , 2013 .",
    "site characterization using full waveform inversion , _ soil dynamics and earthquake engineering _ , * 47 * , 6282 .",
    "kowar , r. & scherzer , o. , 2011 .",
    "photoacoustic imaging taking into account attenuation , in _ mathematical modeling in biomedical imaging ii , lecture notes in mathematics _ ,",
    "2035 , pp . 85130 , springer - verlag , berlin , germany .",
    "larmat , c. , montagner , j .-",
    ", fink , m. , capdeville , y. , tourin , a. , & clvd , e. , 2006 .",
    "time - reversal imaging of seismic sources and application to the great sumatra earthquake , _ geophys .",
    "_ , * 33*(19 ) , l19312 .",
    "monteiller , v. , chevrot , s. , komatitsch , d. , & wang , y. , 2015 .",
    "three - dimensional full waveform inversion of short - period teleseismic wavefields based upon the sem - dsm hybrid method , _ geophys .",
    "_ , * 202*(2 ) , 811827 .",
    "pakravan , a. , kang , j.  w. , & newtson , c.  m. , 2016 . a gauss - newton full - waveform inversion for material profile reconstruction in viscoelastic semi - infinite solid media , _ inverse problems in science and engineering _ , * 24*(3 ) , 393421 .",
    "peter , d. , komatitsch , d. , luo , y. , martin , r. , le goff , n. , casarotti , e. , le loher , p. , magnoni , f. , liu , q. , blitz , c. , nissen - meyer , t. , basini , p. , & tromp , j. , 2011 .",
    "forward and adjoint simulations of seismic wave propagation on fully unstructured hexahedral meshes , _ geophys .",
    "_ , * 186*(2 ) , 721739 .",
    "ritsema , j. , deuss , a. , van heijst , h.  j. , & woodhouse , j.  h. , 2011 . : a degree-40 shear - velocity model for the mantle from new rayleigh wave dispersion , teleseismic traveltime and normal - mode splitting function measurements , _ geophys .",
    "_ , * 184*(3 ) , 12231236 .",
    "rubio  dalmau , f. , hanzich , m. , de  la puente , j. , & gutirrez , n. , 2014 .",
    "lossy data compression with dct transforms , in _ proceedings of the eage workshop on high performance computing for upstream _ , p. hpc30 , chania , crete , greece .",
    "spears , z. , corrigan , a.  t. , & kailasanath , k. , 2014 . checkpointing methods for adjoint - based supersonic jet noise reduction , in _ proceedings of the 20th aiaa / ceas aeroacoustics conference _ , vol .  1 , pp",
    ". 694699 , american institute of aeronautics and astronautics , atlanta , georgia , usa , aiaa paper 2014 - 2472 .",
    "vai , r. , castillo - covarrubias , j.  m. , snchez - sesma , f.  j. , komatitsch , d. , & vilotte , j.  p. , 1999 .",
    "elastic wave propagation in an irregularly layered medium , _ soil dynamics and earthquake engineering _ , * 18*(1 ) , 1118 .",
    "yuan , s. , wen , s. , li , h. , zhang , x. , & liu , q. , 2014 . an optimization framework for adjoint - based climate simulations : a case study of the zebiak - cane model , _ international journal of high performance computing applications _ , * 28*(2 ) , 174182 .              ) .",
    "the logarithmic phase speed in a strictly constant-@xmath57 absorption - band model is represented by the dotted line . in practice , in time - domain simulations a constant-@xmath57 model is approximated by a small number of standard linear solids ( usually zener solids ) in parallel  ( e.g. , * ? ? ?",
    "* ; * ? ? ?",
    "* ) , which approximate a constant  @xmath57 inside an absorption band of interest ( solid line ) .",
    "]     sensitivity kernel defined by equation  ( [ definition_of_kalpha ] ) in the 100200  s period range at an epicentral distance of 120@xmath58 obtained by saving the entire forward simulation to disk .",
    "( process  a in figure  [ how_we_can_undo_attenuation]a . )",
    "the source is indicated by the red star and the receiver by the green triangle .",
    "( b )  approximate anelastic  @xmath0 sensitivity kernel obtained by taking into account physical dispersion only , as explained in section  [ introduction ] .",
    "( process  a in figure  [ how_we_can_undo_attenuation]a . )",
    "this kernel matches the exact result in terms of its pattern , but differs on average by  30% in magnitude .",
    "( c )  anelastic sensitivity kernel computed with our new method .",
    "( process  c in figure  [ how_we_can_undo_attenuation]c . ) this kernel matches the exact result in both pattern and magnitude , with differences of less than  0.01% . ( d )  the difference between processes  b and a. ( e )  the difference between processes  c and a , enhanced by a factor of  @xmath59 .",
    "( f - h )  vertical component synthetic seismograms filtered in the 100200  s passband .",
    "the red rectangle indicates the surface wave signal used to create the adjoint source .",
    "the seismograms obtained by the exact and new methods are identical since the forward simulation is the same in both cases .",
    "the seismogram obtained using physical dispersion only shows the surface - wave arriving 30  s early on average , with double the peak amplitude . ]     for 4060  s vertical - component r1 & r2 waves at depths of a ) 30 km and b ) 125 km .",
    "the minor - arc epicentral distance is  @xmath60 .",
    "traveltime measurements are set to -1 in the computations ( i.e. , @xmath61 ) .",
    "the locations of the source and receiver are indicated by the red star and green triangle , respectively .",
    "the white star and triangle denote the source and receiver antipodes , respectively .",
    "s40rts with crust2.0 is used as the 3d model to compute forward and adjoint simulations .",
    "associated seismograms and adjoint sources are as shown in figure  [ fig : waveforms_rayleigh ] . ]    ) are set to -1 ( _ bottom row _ ) .",
    "cc and mt denote cross - correlation traveltime and multi - taper measurements , respectively .",
    "the multi - taper adjoint sources are used to compute the  @xmath62 kernels presented in figure  [ fig : rayleigh ] .",
    "the epicentral distance is  @xmath60 , and seismograms were filtered between 4060  s. s40rts with crust2.0 is used as the 3d model to compute the seismograms .",
    "notice that , due to the relatively narrow - band signals , the physical - dispersion - only and full - attenuation waveforms are similar .",
    "note also that , due to the nondispersive behavior of the wavetrains , the cc and mt adjoint sources are very similar.,scaledwidth=88.0% ]     for 4060  s transverse - component g1 & g2 waves at depths of a ) 30 km and b ) 125 km .",
    "the minor - arc epicentral distance is  @xmath60 .",
    "traveltime measurements are set to -1 in the computations ( i.e. , @xmath61 ) .",
    "the locations of the source and receiver are shown by the red star and the green triangle , respectively .",
    "the white star and triangle denote the source and receiver antipodes , respectively .",
    "s40rts with crust2.0 is used as the 3d model to compute forward and adjoint simulations .",
    "associated seismograms and adjoint sources are as shown in figure  [ fig : waveforms_love ] . ]    ) are set to -1 ( _ bottom row _ ) .",
    "cc and mt denote cross - correlation traveltime and multi - taper measurements , respectively .",
    "the multi - taper adjoint sources are used to compute the  @xmath63 kernels presented in figure  [ fig : love ] .",
    "the epicentral distance is  @xmath60 , and seismograms were filtered between 4060  s. s40rts with crust2.0 is used as the 3d model to compute the seismograms .",
    "notice that we start observing the effect of full attenuation more for love waves due to their higher sensitivity to crustal variations.,scaledwidth=88.0% ]"
  ],
  "abstract_text": [
    "<S> we introduce a technique to compute exact anelastic sensitivity kernels in the time domain using parsimonious disk storage . </S>",
    "<S> the method is based on a reordering of the time loop of time - domain forward / adjoint wave propagation solvers combined with the use of a memory buffer . </S>",
    "<S> it avoids instabilities that occur when time - reversing dissipative wave propagation simulations . </S>",
    "<S> the total number of required time steps is unchanged compared to usual acoustic or elastic approaches . </S>",
    "<S> the cost is reduced by a factor of 4/3 compared to the case in which anelasticity is partially accounted for by accommodating the effects of physical dispersion . </S>",
    "<S> we validate our technique by performing a test in which we compare the @xmath0 sensitivity kernel to the exact kernel obtained by saving the entire forward calculation . </S>",
    "<S> this benchmark confirms that our approach is also exact . </S>",
    "<S> we illustrate the importance of including full attenuation in the calculation of sensitivity kernels by showing significant differences with physical - dispersion - only kernels .    * anelastic sensitivity kernels with parsimonious storage for adjoint tomography and full waveform inversion * +    dimitri komatitsch@xmath1 , zhinan xie@xmath2 , ebru bozda@xmath3 , elliott sales de andrade@xmath4 , daniel peter@xmath5 , qinya liu@xmath4 , and jeroen tromp@xmath6 +    @xmath1lma , cnrs upr 7051 , aix - marseille university , centrale marseille , 13453 marseille cedex 13 , france + e - mail : komatitsch@lma.cnrs-mrs.fr +  @xmath7institute of engineering mechanics , china earthquake administration , harbin 150080 , china +  @xmath8goazur , university of nice sophia antipolis , valbonne , france +  @xmath9department of physics and department of earth sciences , university of toronto , + toronto , ontario , canada +  @xmath10extreme computing research center , king abdullah university of science and technology ( kaust ) , + thuwal </S>",
    "<S> , saudi arabia +  @xmath11department of geosciences and program in applied & computational mathematics , + princeton university , new jersey , usa .    * * * * this manuscript is now published as a paper in the geophysical journal international , 2016 . * * * * </S>"
  ]
}