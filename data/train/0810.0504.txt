{
  "article_text": [
    "there are many methods to analyse dark matter haloes structures .",
    "a standard approach involves investigating spherically averaged density profiles , such as the hernquist profile @xcite , the nfw profile @xcite , the moore profile @xcite and the stoehr profile @xcite .",
    "more sophisticated methods developed recently involve different elliptical density profiles @xcite .",
    "an other alternative consists of analysing velocity profiles , e.g. , romano - diaz & van de weygaert ( 2007 ) , for a review .",
    "other investigations look in more details at halo detection as well as their internal substructures , the subhaloes .",
    "they usually use a two steps procedure : they first find haloes and substructures in position space , then use velocity information to apply binding criteria .",
    "many such schemes are found in the literature , the simplest being the friend - of - friend ( fof ) algorithm @xcite .",
    "more advanced methods rely for instance on the skid algorithm @xcite or on subfind @xcite .",
    "however , thanks to increased computational power , it now becomes possible to perform more detailed analyses that combine simultaneously velocity and position information .",
    "indeed , modern simulations now reach enough resolution to identify structures and substructures in the full , six dimensional phase - space .",
    "recent investigations in this topic studied phase - space dark matter profiles @xcite , phase - space density estimation by using six dimensional delaunay tessellation ( sheshdel ) @xcite , or by using binary tree methods with smoothing ( fiestas ) @xcite , and a variety of different binary tree and six dimensional sph methods with local adaptive metric in the enbid package @xcite .",
    "two noticeable results were derived within these investigations : the measurement of a universal logarithmic slope for the phase - space density @xmath6 as a function of radius @xmath7 , @xmath8 , with @xmath9 @xcite , and the observation of a universal profile for the phase - space volume occupation function , @xmath10 @xcite .",
    "these results depend on the quality of the phase - space density estimators , a topic to which we devote this paper .",
    "we carefully analyse and cross compare the sheshdel , fiestas and enbid estimators .    this paper is organised as follows .",
    "section  [ sec : est ] describes the various generic phase - space estimators and the corresponding concepts .",
    "we pay particular attention to the issue of the unknown scaling , @xmath0 , which relates position coordinates and velocity coordinates prior to the phase - space distribution function measurement . in section  [ sec : numexp ] we test the phase - space estimators in three realisations of a halo profile : ( i ) a pure hernquist isotropic halo , ( ii ) a composite hernquist halo ( a main hernquist component with hernquist subhaloes ) and ( iii ) a halo extracted from a standard cold dark matter ( cdm ) cosmological simulation . to have a better understanding of the results , more thorough analyses are performed in section  [ sec : additiona ] focusing on ( i ) the local number of neighbours built by the delaunay tessellation and on ( ii ) the local scaling between positions and velocities given by the adaptive metric of enbid .",
    "section  [ sec : secq ] shows the advantages of full phase - space analysis , with respect to more classical approaches such as the proxy @xmath2 .",
    "finally , section  [ sec : conc ] wraps up .",
    "there are a few common approaches to measure six dimensional phase - space density , @xmath11 , for unrelaxed systems .",
    "a straightforward method involves dividing phase - space into a cartesian grid and approximating phase - space density by counting particles in each bin .",
    "while this clearly works quite well in three - dimensional space , it starts to be problematic in six dimensions .",
    "even if we choose a poor quality resolution , e.g. @xmath12 bins along each axis , we get in the end a very large number of cells , e.g. @xmath13 , and , for modern simulations with e.g. @xmath14 particles , almost all the cells will be empty .",
    "this basic example shows that for improved phase - space estimation , one needs to go well beyond the naive binning algorithm .",
    "notice as well that to achieve a level of detail in phase - space comparable to what is usually obtained in position space , one needs a simulation with an extremely large number of particles .",
    "a more sophisticated , frequently used method for density estimation in position space , uses smoothing with @xmath15 nearest neighbours found with standard tree techniques ; it can be easily generalised to the six dimensional case .",
    "assuming for the sake of simplicity that all particles have the same mass @xmath16 , if , for each particle , @xmath15 neighbours are enclosed in a six dimensional ball of volume @xmath17 , then the local phase - space density can for instance be measured with the simple following estimator , @xmath18 , which corresponds to a top hat kernel . in practice ,",
    "more sophisticated kernels are used , i.e. each neighbour contributes to the measured density with a weight defined by a smooth function , usually a smooth particle hydrodynamics ( sph ) kernel .",
    "this kind of algorithm was proposed for phase - space density estimation by sharma and steinmetz ( 2006 ) ( hereafter s06 ) .",
    "it however requires the proper set up of a metric in six - dimensional space ( velocity / position scaling ) .    in this paper",
    "we investigate more accurate algorithms developed recently in the literature , including improvements of the above sph technique .    the first method , discussed in ",
    "[ sec : dtfe ] , relies on six dimensional delaunay tessellation ( arad et al . , 2004 ;",
    "hereafter arad04 ) .",
    "the big advantage of this method is that it is parameter free , fully adaptive , while each particle has a natural neighbourhood . in practice , however , the delaunay tessellation needs some additional smoothing .",
    "it is also very time and memory consuming @xcite .",
    "it requires , similarly as the straightforward sph method just mentioned above , a proper set up of a metric in six - dimensional space .",
    "the second group of algorithms was proposed by ascasibar & binney ( 2004 , hereafter a04 ) and improved by s06 .",
    "the first step of their method , detailed in   [ sec : treepart ] , is simple and robust .",
    "space is divided with the help of a binary tree into disjoint hyperboxes with one particle in each leaf node . since",
    "each particle is in one hyperbox with volume @xmath19 , its local phase - space density could be directly estimated from the equation @xmath20 . yet the phase - space density derived from this estimator is quite noisy : it is almost impossible to use it for practical purposes .",
    "hence additional steps were proposed to make it useful .",
    "first , the binary tree may be improved with the help of a shannon entropy criterion combined with boundary particles correction ( s06 ) .",
    "secondly , some additional smoothing should be performed .",
    "there are few options to do so , as proposed by a04 and s06 and described in ",
    "[ sec : mysmoothing ] , ranging from ( a ) a hyperbox smoothing following the philosophy of the sph method , ( b ) a sph method with a local adaptive metric , to ( c ) anisotropic sph methods . the main advantage of this type of algorithm compared to the tessellation methods is time and memory consumption .    in the next sections",
    ", we describe each of these methods in turn and follow with a detailed discussion on the issue of position / velocity scaling (   [ sec : posvelcor ] ) .",
    "the reader may refer to table  [ table : algorithms ] and to the summary in ",
    "[ sec : conc ] , if needed .    [ cols=\"<,<\",options=\"header \" , ]      the idea of using a delaunay tessellation was primarily implemented to estimate density and velocity fields in cosmological simulations @xcite .",
    "the corresponding algorithm , called the delaunay tessellation field estimator ( dtfe ) , was also used to demonstrate the advantages of the tessellation over sph methods @xcite . in particular",
    ", the dtfe method better captures the abrupt transitions between regions of different densities and provides a better estimate for high densities .",
    "the main parts of the dtfe algorithm were used by arad04 to develop their six dimensional phase - space density estimator called sheshdel . beside the position - velocity scaling problem that is addressed in   [ sec : posvelcor ] and in   [ sec : posvelcor2 ] , the method itself is parameter free and presents well behaved statistical properties .",
    "its main disadvantage is that it is computationally costly , although it scales like @xmath21 ( arad , in preparation ) , where @xmath22 is the number of particles : the construction of a delaunay tessellation of approximately @xmath23 particles requires almost three days of calculation on a modern computer and the full output of @xmath24 delaunay cells amount to @xmath25 gb of data in the end .    from a 6d delaunay tessellation , it is easy to estimate the phase - space density , @xmath11 .",
    "space is indeed partitioned into joint but non overlapping 6-dimensional polyhedrons - delaunay cells , each one defined by 7 vertices .",
    "there is an unique 6 dimensional sphere passing through these 7 vertices , which by definition of the tessellation , does not encompass any other particle from the sample .",
    "let @xmath26 be the @xmath27 delaunay cells around particle @xmath28 .",
    "we can define a macro _ voronoi _ cell @xmath29 by joining all delaunay cells containing particle @xmath28 : @xmath30 then it is straightforward to define an estimate of the phase - space density for each particle @xmath28 of mass @xmath16 as : @xmath31 where @xmath32 is the volume of the macro cell and the factor @xmath33 accounts for the fact that each delaunay cell contributes to the density of 7 particles . in practice , as mentioned earlier , the corresponding estimated phase - space density is very noisy , and one must introduce some additional smoothing . let @xmath34 be the average phase - space density defined for delaunay cell @xmath35 .",
    "one can then define a smoother phase - space density estimator as : @xmath36 where @xmath37 indexes all delaunay cells around particle @xmath28 and @xmath38 represents the volume of each delaunay cell .        for simulations without e.g. periodic boundaries",
    ", the phase - space density of particles near the edge of the computing domain can be underestimated .",
    "this is for instance the case when the sample has been cut from a bigger cosmological volume . to cope with this edge effect problem",
    ", one can introduce another definition for the smooth phase - space density estimator .",
    "consider particle @xmath28 , surrounded by its delaunay cells @xmath39 , and let @xmath40 be the distance between this particle and its closest neighbour ( figure  [ minicell_fig ] ) .",
    "then , the mini - cell around particle @xmath28 is defined as the collection of delaunay cells @xmath41 , which are similar to @xmath39 but are scaled in such a way that each edge in @xmath41 containing particle @xmath28 is exactly of length @xmath40 .",
    "the volume of @xmath41 reads @xmath42 where @xmath43 is the length of the segment joining particle @xmath28 and @xmath37 in delaunay cell @xmath35 . as a result",
    ", a natural phase - space density estimator reads @xmath44 however , it might be better to use linear interpolation to estimate the phase - space density in each mini - cell , to perform additional local noise filtering : @xmath45 in the end we can thus define a phase - space density estimator with interpolated density as follow : @xmath46 the mini - cells are more regular and spherical , so both phase - space density estimators @xmath47 and @xmath48 are expected to be less sensitive to local fluctuations and local anisotropies due to noise and edge effects .",
    "note that all of the above smoothing methods are based on natural neighbour interpolation techniques @xcite . in what shall follow ,",
    "although we studied all the estimators , @xmath49 , @xmath50 , @xmath51 and @xmath52 , we shall present explicit results only on @xmath51 ( equation  [ eq : dtfesph ] ) and on @xmath49 ( equation  [ eq : dtfesimple ] ) .      as discussed in the introduction of   [ sec : est ] , the main point of the algorithm fiestas   proposed by a04 and later improved by s04 in the enbid   implementation , is the division of space into a binary tree . in fiestas , the splitting axis is chosen alternatively between position space and velocity space , then in each of these respective subspaces , the axis with highest elongation , @xmath53 , is split .",
    "this splitting criterion helps the cells to preserve a shape as cubic as possible .",
    "however , a visual inspection of position and velocity diagrams of typical simulations ( figure  [ figure2bb ] ) shows that position space contains more structures , and thus more information than velocity space . as a result",
    ", one can argue that for optimal accuracy , the splitting should occur more often in position space than in velocity space .",
    "this observation was used in the enbid algorithm to define a better splitting criterion .",
    "before splitting occurs , one has to find the subspace ( velocity or position ) in which it should be performed .",
    "to do that , the shannon entropy , @xmath54 , is calculated after dividing each subspace into @xmath22 equal size bins : to be equal to the number of particles contained in the subspace . ]",
    "@xmath55 where @xmath56 is the number of particles in each bin .",
    "the subspace which has to be splitted is the one with smallest entropy . finally , the direction of splitting is chosen again using the highest elongation criterion , to preserve a close to cubic shape .    as for delaunay tessellation ,",
    "correction for edge effects is crucial in the binary tree partition algorithm .",
    "to illustrate that point , it was shown in s06 that for @xmath57 particles uniformly distributed in a 6d spherical region , about @xmath58 of them lie near the border , compared to @xmath59 in the 3d case .",
    "this reflects the so called curse of dimensions .",
    "the natural shape of local border in the binary tree partition algorithm is an hypercube .",
    "when the data do not preserve locally this shape , the volume occupied by the boundary particles tends to be overestimated , hence their phase - space density tends to be underestimated .",
    "this bias is moreover expected to worsen and to propagate further away from the edges if additional smoothing is performed .",
    "both fiestas and enbid redefine borders to correct for edge effects . while fiestas does it only for the tree leaves , enbid applies the correction to all the nodes of the tree , in order to insure proper entropy calculation and to better estimate the phase - space density of small structures found in the halo .          from these tree methods , one could estimate naively the phase - space density by exploiting directly the information stored in the tree structure , as argued in the end of the introduction of   [ sec : est ] , but measurements performed that way would be rather noisy : additional interpolation , should be applied to the data in order to achieve a good measurement of phase - space density . a04",
    "and s06 investigated a few smoothing procedures , that we discuss now .",
    "let us first describe the smoothing method proposed by a04 ( called later fiestas smoothing ) .",
    "the main idea comes from sph techniques , but the smoothing kernel is a hyperbox rather than a hypersphere .",
    "this treatment avoids the need for a definition of a local metric .",
    "first , the mass of each particle is distributed uniformly over its leaf volume .",
    "then , a hyperbox of volume @xmath60 , centred on this leaf and with the same axis ratio , is found , such that it contains a mass @xmath61 , which basically defines the kernel size .",
    "local phase - space density is then calculated from the equation @xmath62 .",
    "in our investigations , we shall use mainly the @xmath63 value proposed by s06 ( while a04 suggest @xmath64 ) .",
    "the other approach uses a classic sph technique . for our investigations , we shall use the epanechikov kernel @xmath65 with an additional bias correction . as mentioned in s06",
    ", this estimator seems to give the best results for sph phase - space estimation .",
    "one of the disadvantages of the sph method is the way it handles strong transitions between regions of very different densities , as illustrated by fig  [ sph_fig]a .",
    "the key point is that the sph method is not able to capture correctly strong variations of the density local curvature .",
    "because of the spherical shape of the kernel and the fixed number of neighbours used to perform the calculations , the density will be underestimated near the edge of the regions with higher density ( particle a ) , or more generally in regions with significant negative local curvature . on the other hand",
    "the density will be overestimated near the edge of the low density regions ( particle b ) , or in regions with significant positive local curvature .",
    "one way of resolving this issue , and of better capturing filamentary structures such as in fig  [ sph_fig]a , is to use an anisotropic sph kernel , which adapts locally to the shape of structures and is thus more appropriate to capture to local curvature variations .",
    "first , the @xmath66 nearest neighbours are found for each particle , which allows one to compute a deformation tensor @xmath67 , that is used to define a local ellipsoid with @xmath68 nearest neighbours ( usually @xmath69 ) .",
    "each particle contained in this ellipsoid contributes to the phase - space density with the weights given by the sph kernel , scaled properly to take into account the ellipsoid shape ( fig  [ sph_fig]b ) .",
    "note that , in addition to the issues described in figure  [ sph_fig ] , the density calculated with sph methods presents some non trivial biases due to local poisson shot noise which can in part be corrected for ( see s06 for details ) .          there is a last one important problem that arises when one aims to estimate phase - space density . in order to perform some local phase - space density estimation",
    ", one needs to find a way to join position space and velocity space , or in other words to define a proper _ metric _ that allows one to estimate local distances and local volumes in phase - space .",
    "this generic problem does not have an obvious solution .",
    "let us first discuss that issue and then detail the implementations to resolve it for the phase - space estimators used in this paper .",
    "the dynamics of dark - matter is usually modeled by a self - gravitational collisionless fluid which follows the so called vlasov - poisson equations : @xmath70 @xmath71 because it is very difficult to solve these equations directly , the continuous fluid formulation is usually approximated by collisionless particles which follow the classical gravitational newtonian equations , hence producing monte carlo realisations of this set , with additional softening to maintain the forces bounded .",
    "the most important question here is how this approximation affects the phase - space density properties .",
    "liouville theorem states that the phase - space distribution function remains constant along trajectories of the system @xmath72 this is true for the smooth , _ fine - grained _ phase - space density @xmath6 . in @xmath22-body simulations",
    ", it is in practice possible to probe only the _ coarse - grained _ phase - space density , @xmath73 , which is the average of @xmath6 over a small but finite volume @xcite .",
    "this quantity does not follow the liouville theorem anymore because of mixing processes occurring at small scales @xcite .",
    "furthermore , the measurement of @xmath74 depends highly on the way the coarse graining volume is defined , hence in particular on the local scaling to be applied to velocities versus positions . to have a proper measurement of @xmath74 that approaches as much as possible the fine grained distribution function from the dynamical point of view , or some sensible local average of it , one would need the knowledge of the whole dynamical history of the system .",
    "one way to overcome this problem is to solve numerically vlasov s equations using a more sophisticated approach than the simple @xmath22-body method , where the phase - space distribution function is modeled by small elements of metric , such as ellipsoid `` clouds '' , that sum up to a dynamically meaningful coarse grained version of the distribution function .",
    "this method is discussed in detail and applied in 1 + 1 d in alard & colombi ( 2005 ) .",
    "of course the generalisation of such a method to 6d is quite costly .",
    "however , a simple alternative , in the spirit of this method , would be to attach to each particle of a @xmath22-body simulation the information corresponding to the local phase - space volume ( or the local metric ) , that would be followed during the evolution of the system @xcite .",
    "note that we then follow a sparse sampling of the _ fine grained _ distribution function as long as the dynamical effects due to the discrete particle representation are negligible .",
    "then the appropriate shape for the phase - space element used to measure the coarse - grained distribution function would be given by a local average on a number of neighbouring particles in phase - space , as is achieved by the adaptive sph method .    finally",
    ", if such an information is not available , and without supplementary prior on the dynamical state of the system , one can just try to find the best coordinate transform that preserves local isotropy within the coarse grained volume .",
    "this method basically assumes that the systems evolved from a smooth distribution function . in that sense , for cold dark matter haloes",
    ", it only traces correctly the coarse distribution after relaxation to a quasi - steady state ( i.e. a few dynamical times after collapse ) . note that a simple application of this idea to find a global scaling between position and velocities basically produces the system of coordinates where the velocity scatter is of the same order of the positions scatter .    to illustrate this discussion , figure",
    "[ sph_fig1].1 shows one of the outputs of a 2d phase - space simulation of alard & colombi ( 2005 ) , using the cloudy method ( briefly sketched above ) .",
    "the system was evolved during approximately 40 dynamical times from an initial top - hat distribution function slightly apodized at the edges .",
    "figure [ sph_fig1].2 shows the same realisation , but the position coordinate is scaled in such a way that both velocities and positions show the same spread : this is the natural system of coordinate for a global definition of the scaling to be used between positions and velocities prior to the definition of a small round coarse graining volume .    in the cold dark matter scenario ,",
    "initial conditions can by approximated by a three dimensional sheet ( small dispersion in velocity space ) immersed in six dimensional phase - space , that subsequently evolves in time and gains a complex shape ( without loosing its connectivity or volume as stated by the liouville theorem ) .",
    "the equivalent of such a sheet in our 2d phase - space representation would be e.g. the curve ( f ) , accurately followed by many cloud elements .",
    "as mentioned above , vlasov - poisson equations are usually numerically resolved relying on a particle representation .",
    "after many time steps , because of variations of the local force field , particles initially close by depart from each other ( g ) .",
    "mixing processes occur at small scales , and the phase - space sheet , poorly modeled by the particles , loses its fine structures . the way the coarse - grained phase - space density @xmath73 is calculated is shown on e.g. ( 2d ) .",
    "the use of a finite local volume for computing @xmath73 results in the averaging of the phase - space density over many curves  or sheets in six dimensions . from now on , unless otherwise stated , we shall skip the bar and use the @xmath6 symbol for the coarse - grained phase - space density .      inspired by the discussion in previous paragraph ,",
    "we now propose two ways of fixing the position - velocity scaling :    * a _ global _ scaling factor between positions and velocities , that will be applied to the standard sph and delaunay tessellation algorithms .",
    "this global factor tries to make the phase - space distribution function globally isotropic , i.e. with the same spread in velocities and in positions .",
    "* a _ local _ scaling factor that depends on phase - space coordinate @xmath75 , and that tries to make the phase - space distribution function locally isotropic . this local scaling factor is implemented by construction in fiestas and its improvement , enbid , as detailed below .",
    "it will be used as well when additional smoothing is performed with sph or asph techniques . in that case",
    "we shall denote the methods by sph - am and asph - am , respectively .    _",
    "( i ) global scaling : _ 0.2 cm    for the global scaling method depending on one parameter , @xmath0 , the metric transform can be written in the form : @xmath76 we test here two different ways of setting @xmath0 , that apply to single dynamical systems , such as the cold dark matter haloes analysed in this paper .",
    "such a global scaling finds a transformation that changes for instance fig .",
    "[ sph_fig1].1 in fig .",
    "[ sph_fig1].2 .",
    "the first scaling uses simple dynamical arguments that lead to a comparable scatter in velocity and position space of the phase - space distribution function , or in other worlds to a `` more round '' shape of the cloud representing @xmath77 .",
    "it relies on the fact that dark matter haloes are known to be well fitted by the nfw profile @xcite .",
    "in particular , within that model , we use the relation @xmath78 where @xmath79 and @xmath80 are the viral radius and the viral velocity of the halo , respectively , and @xmath81 is the hubble constant in units of @xmath82 @xcite .",
    "for the haloes analysed in this paper , @xmath83 and @xmath84 . in that case , the natural set of coordinates , that fixes properly the global scaling between positions and velocities , simply uses distances expressed in units of kpc  @xmath85 and velocities in km  s@xmath86 . in this case",
    "the global scaling is set to @xmath87 .",
    "the second method , more sophisticated , should reach approximately the same scaling .",
    "it involves attempting to enforce global isotropy of the distribution of particles in phase - space . to achieve that ,",
    "the distances of each particle to its closest neighbour in position subspace and in velocity subspace , are computed , which allows us to estimate the probability distribution functions of these distances , @xmath88 and @xmath89 .",
    "the global scaling @xmath90 between the two subspaces is the one where the maximum of @xmath88 and the maximum of @xmath89 coincide .",
    "( ii ) local scaling : _ 0.2 cm    obviously , although it presents the advantage of being simple to implement and robust , the global scaling is not optimal . however , it is possible to enforce , to some extent , local isotropy of the phase - space distribution function by examining the local neighbourhood of each particle , as is implemented in the fiestas and enbid algorithms .    in fiestas",
    "the natural local scaling @xmath1 between velocity subspace and position subspace is simply determined from the axis ratio of the tree leaf containing the particle ( which is equivalent to pass from figure  [ sph_fig1].1d to figure  [ sph_fig1].2d ) . by construction of the tessellating tree , the local isotropy between both subspaces should be preserved in the first approximation , as the calculation of the final smoothing hyperbox preserves this axis ratio . for the modification of fiestas proposed by the enbid algorithm ,",
    "the splitting of the binary tree is improved by the calculation of shannon entropy , which in principle warrants a better local assignment of the metric frame .",
    "may have some significant impact on the local metric . ]",
    "finally one can perform additional sph or anisotropic sph interpolation in the local metric frame determined by enbid , that lead to our sph adaptive metric algorithms ( sph - am and asph - am ) . prior to sph or asph interpolation ,",
    "the phase - space coordinates are scaled in such a way that the local hyperbox corresponding to the leaf containing the particle becomes hypercubical ( figure  [ sph_fig1].1d to figure  [ sph_fig1].2d , to obtain figure  [ sph_fig1].2b and figure  [ sph_fig1].2c ) .",
    "of course the biases expected in sph and asph interpolations mentioned in the end of   [ sec : mysmoothing ] are still present , even with this local metric approach .    to summarise , we see that fiestas method with enbid improvement corresponds to hyperbox smoothing with adaptive metric .",
    "the only thing that changes between sph - am or asph - am is the shape of the kernel used to perform the smoothing .",
    "between the measured phase - space distribution function , @xmath6 , and the analytical value , @xmath91 , as a function of @xmath91 , derived for an isotropic hernquist profile and different smoothing methods as indicated on the top of each panel . _ from left to right and top to bottom _ , ( a ) sph with local adaptive metric and 10 neighbours , ( b ) sph with local adaptive metric and 40 neighbours , ( c ) sph with local adaptive metric and 200 neighbours , ( d ) anisotropic sph with local adaptive metric and 40 neighbours ,",
    "( e ) fiestas algorithm with enbid improvement and @xmath92 , ( f ) sph with 10 neighbours , ( g ) dtfe method and ( h ) dtfe with spherical sphere smoothing .",
    "these two dimensional histograms are calculated using 400x400 logarithmic bins .",
    "the central curve corresponds to the median value of @xmath93 calculated over 200 logarithmic bins along the @xmath94 axis , taking into account only bins containing 2 particles or more .",
    "the two additional curves on each side show @xmath95 sigma errors estimated from the dispersion above and below the median curve .",
    "the two dashed vertical lines mark the range for which the median departs by more than a factor 5 from @xmath91 .",
    "the mean log - ratio @xmath96 and its dispersion , @xmath97 , are indicated on each panel and were computed using all the data.,width=311,height=604 ]     ( _ left _ ) and its logarithmic slope ( _ right _ ) with different phase - space estimators .",
    "the dashed line corresponds to the analytical solution .",
    "the vertical dashed line marks the value @xmath98 , corresponding to the cut - off of the halo at @xmath99 virial radii.,width=321,height=160 ]    in order to test the various above described methods , we first examine control  phase mixed \" samples for which there are analytical solutions .",
    "hence , we follow a04 and s06 and generate a hernquist isotropic profile @xcite . in that case , the projected density distribution is given by @xmath100 where @xmath101 is the halo total mass and @xmath102 is a scale length .",
    "we follow exactly the prescriptions of a04 and s06 to create a random set of positions and random velocities obeying the appropriate distribution , relying on the fact that in this model , the phase - space density distribution function , @xmath6 , depends only on energy @xmath103 , @xmath104 where @xmath7 and @xmath105 correspond to position and velocity , respectively . at equilibrium",
    ", the distribution function reads @xmath106 with @xmath107 in order to have a halo with realistic properties , we would like it to follow equation  ( [ eq10 ] ) , i.e. @xmath108 ( in our case @xmath109 ) , with @xmath87 .",
    "the circular velocity of the hernquist profile reads @xmath110 combining this equation taken at the virial radius with equation  ( [ eq10 ] ) gives the total halo mass @xmath111 in practice , the profile is also cut - off at a radius @xmath112 , i.e. all the particles verify @xmath113 . in",
    "what follows , a concentration parameter @xmath114 is defined such that @xmath115 , where @xmath116 is the virial radius . for our test sample ,",
    "we take @xmath117 particles , @xmath118 kpc , @xmath119 , @xmath120 and @xmath121 . for both the hernquist profile and the hernquist composite profile ( next subsection )",
    ", we measure @xmath6 in units of @xmath122 .",
    "this choice of parameters was meant to compare directly our measurements with s06 .",
    "note however that our value of @xmath112 is much smaller than that of s06 , to make dtfe method tractable . without such",
    "a cut - off , we would indeed have too many neighbours for the particles near the edge .",
    "this abrupt cut - off might a priori introduce some contamination for @xmath123 , where @xmath124 is the value of the phase - space distribution function at @xmath125 and @xmath126 ( @xmath98 in our units ) . yet",
    ", we have checked , by taking very large values of @xmath112 that our implementation of the enbid estimator is quite consistent with that of s06 .",
    "figure [ hern1_fig ] shows the ratio @xmath127 between the estimated phase - space density @xmath6 and the analytical result , @xmath91 given by equation  ( [ eq : ftheoric ] ) , as a function of @xmath91 , for various smoothing methods , as indicated on the top of each panel .",
    "for sph - am with @xmath128 neighbours , we get a good approximation of @xmath91 over about @xmath129 decades delimited by the two vertical dashed lines .",
    "these lines correspond to a five fold relative error on the determination of the phase - space density compared to the exact solution . with @xmath25 neighbours , the spread drops down by almost a factor of @xmath130 , but at the cost of a narrower available dynamic range , because of the bias introduced by the softening of the sharp transitions between overdense and underdense regions and nearby local extrema ( see also the discussion in   [ sec : mysmoothing ] ) .",
    "this effect is therefore even more prominent for sph - am @xmath131 .",
    "the fiestas algorithm with enbid improvement and @xmath92 gives a spread comparable to sph - am with around @xmath132 particles , but the range of accurate phase - space estimation is smaller as there is a noticeable bias in the high density region . for anisotropic sph - am , @xmath133 particles are used to find the best fitting local ellipsoid while softening is performed over @xmath25 particles . in this case , the plot looks almost the same as for sph - am with a small overall systematic overestimation of the true phase - space density , which remains despite the kernel bias correction .        for dtfe and standard sph methods , we have to set the global position - velocity scaling factor @xmath0 , where @xmath134 .",
    "we use the two methods described in part ( i ) of   [ sec : solsca ] .",
    "the first one gives @xmath135 while the second one , relying on peak matching of the distance distribution , gives @xmath136 .",
    "for both standard sph and dtfe , we find that @xmath90 leads to a small but noticeable improvement of a few percent for the phase - space density estimate compared to @xmath137 .",
    "as shown on figure  [ hern1_fig ] , the sph method with the @xmath90 scaling and 10 neighbours performs less well without the adaptive metric correction , although it recovers correctly the middle range of @xmath6 values .",
    "note that , contrary to the sph - am case , no edge effect correction is performed for the pure sph case , which explains the small depression seen at @xmath138 , due to the cut - off at @xmath112 .",
    "turning to the dtfe method , a simple estimation given by equation  ( [ eq : dtfesimple ] ) is closest to sph with 10 neighbours , in terms of scatter .",
    "however , within our ( generous ) allowed factor of 5 margin for the phase - space density , we observe that the dtfe method probes the low-@xmath6 range nearly one order of magnitude further , while it seems to do worse in the high density regime .",
    "note the bump at @xmath139 seen in the lower left panel of figure  [ hern1_fig ] in addition to the neighbouring depression already noticed for sph , here at @xmath140 .",
    "it is a consequence of the brutal cut - off at @xmath112 , combined with the strong effects of anisotropy in phase - space near the edges : indeed , for @xmath141 , the number of neighbours defined by the delaunay cells starts to increase dramatically ( see figure  [ con ] in   [ sec : smoothneig ] ) .",
    "we checked alternate smoother dtfe interpolators discussed in ",
    "[ sec : dtfe ] , and found that the best one is the `` spherical '' smoothing implementation given by equation  ( [ eq : dtfesph ] ) .",
    "this solution , shown on figure  [ hern1_fig ] presents less scatter than the simple dtfe and a slightly better behaviour with respect to edge effects , at the cost of a significant reduction of the available dynamic range , which covers only about 7 decades .",
    "another way to test our estimators , following arad04 , involves measuring the probability distribution function of @xmath6 , which is , within a normalisation factor , the differential volume @xmath142 where @xmath143 is the volume in phase - space occupied by the excursion @xmath144 : @xmath145 for an isotropic hernquist profile , the function @xmath146 can again be computed analytically ( see   3.1 of s06 for details ) .",
    "the measurement of @xmath146 is straightforward when one considers the simplest implementation of dtfe as @xmath143 is given exactly in that case by @xmath147 for other methods , equation ( [ eq : voff ] ) is only approximate .",
    "the logarithmic derivative of function @xmath19 is then obtained by simple finite difference in @xmath148 space using @xmath12 bins , using 3 points interpolation .",
    "following arad04 , let us also estimate the logarithmic slope , @xmath149 , of the function @xmath146 , @xmath150}{{\\rm d } f},\\ ] ] since it represents a more discriminant measure of the phase - space density than @xmath146 itself .",
    "this is illustrated by figure  [ hern3_fig ] , which compares to the analytical solution the measured @xmath146 and its logarithmic slope .",
    "note that , because of our cut - off at @xmath151 , @xmath146 ( and therefore its logarithmic derivative ) are not expected to fit the analytical prediction for @xmath152 , since a fraction of the sample volume @xmath153 , is missing in that regime .",
    "all the methods reproduce quite well @xmath146 and @xmath154 above that value and in the mid - density regime . in the high density regime ,",
    "the best results seem to be obtained by sph - am with 10 particles , but the measurements are too noisy to be definite : one can see that sph - am with 40 particles and fiestas with enbid correction do as well at least for @xmath155 . on the other hand",
    ", the dtfe method behaves quite poorly in the high density regime , while its smoother counterpart is even worse , which confirms the results of figure  [ hern1_fig ] .",
    "however , we shall see that this is a consequence of a suboptimal choice of the scaling between position and velocities , as discussed in next section .",
    "actually , with the proper choice of @xmath0 , dtfe should give the best results in high density regions , as , by construction , it provides a full tessellation of space with optimal calculation of neighbours : the combination of these last two properties is critical to measure accurately an eulerian quantity such as @xmath146 .",
    "our single isotropic hernquist profile allowed us to separate well the different density regimes .",
    "however it is not realistic , since real dark matter haloes exhibit non trivial substructures .",
    "we therefore now create a synthetic halo with a main component and smaller subhaloes .",
    "we still use the hernquist profile as a guideline to be able to perform analytical predictions .    for the main halo we use the same realisation as before with around @xmath156 particles .",
    "then we add @xmath157 smaller haloes which correspond to a scaled - down version of the main halo .",
    "their mass follow the following probability distribution function , @xmath158 , where @xmath101 varies between @xmath159 and @xmath160 .",
    "the largest subhalo has around @xmath161 particles and the smallest one , around @xmath162 . in total , the system involves , as before , @xmath163 particles , and around @xmath164 of them belong to substructures .",
    "this fraction is larger than what is found in cosmological simulations , but we prefer this ratio given its higher level of anisotropy .",
    "each subhalo phase - space coordinates centre is set randomly following the same hernquist distribution as for the main halo .",
    "figure [ figure1a ] presents the halo in various projections .",
    "as illustrated by the top panels , we can see clearly that the structures are more concentrated in position space than in velocity space , a feature also observed in @xmath22-body haloes ( see for instance figure  [ figure2bb ] ) . the bottom panels correspond to phase - space diagrams , in radius / radial velocity subspace ( lower - left panel ) and in radial velocity / tangential velocity subspace ( lower - right panel ) . to draw them ,",
    "we compute for each particle the distance @xmath7 from the centre of the main halo and the relative radial velocity as follows : @xmath165 where @xmath166 corresponds to the coordinate , while @xmath167 and @xmath168 are the position and velocity of the centre of the main halo , respectively . the tangential velocity is then given by @xmath169 .",
    "note the elongated vertical features in lower - left panel , which illustrate again the smaller spread of substructures in position space than in velocity space .        , but the ratio between measured and analytic phase - space distribution function is now shown for our composite hernquist profile for various smoothing methods as indicated on the top of each panel .",
    ", width=321,height=642 ]         and its logarithmic derivative , following figure  [ hern3_fig ] , but for the composite hernquist profile .",
    "the blue and red dashed curves correspond to the analytical prediction for the main component and the full halo , respectively .",
    "note that , as discussed in   [ sec : hernquist ] , there is a minimum value of @xmath6 for which we can measure accurately @xmath146 , regardless of the method used , due to the cut - off imposed at radius @xmath112 ( dashed vertical line ) .",
    "this is now further complicated by the fact that here , the cut - off is also imposed on the subhaloes , which explains why the measurements tend to slightly overestimate the red dashed curve for @xmath170.,width=321,height=321 ]    figure [ figure1ens ] shows the phase - space density estimated by sph - am with 40 particles , for the main component , the subhaloes and the full halo .",
    "while the theoretical density is a simple sum of all the components contributing locally , it is not exactly the case for the estimated density . by comparing all the plots",
    ", one can see that the low-@xmath6 regime and the high-@xmath6 regime are dominated by the main component and the subhaloes , respectively . for each component",
    ", @xmath6 presents a large spread in the low density region , @xmath171 , because of the high level of shot noise due to the small number of particles in the edges of substructures , and is underestimated in the high density one . the range of accurate values of @xmath6 increases with the number of particles in each subhalo .",
    "when summing up the subhaloes , as shown in middle panel , this adds up to a significant spread of the scatter plot , obviously much larger than for the main component .",
    "in fact , such a spread dominates for the total halo ( right panel ) and is larger than for a single hernquist profile with same number of particles ( see figure  [ hern1_fig ] ) . because the high phase - space density regime is dominated by subhaloes , the range of recovered values of @xmath6 is tremendously reduced in that region , and we lose about one order of magnitude for the available high density range compared to the single hernquist profile .",
    "this issue has to be kept in mind when performing the measurements in real @xmath22-body haloes .",
    "figure [ figure2 ] , following figure  [ hern1_fig ] , now compares the various estimators of the phase - space density , and confirms most of our previous findings : the best estimator is sph - am with 10 neighbours .",
    "it does better than sph - am 40 in the high - density regions , because of the lower - level of smoothing , at the cost of a larger spread .",
    "the effect is even stronger when performing the comparison with sph - am 200 , as expected .",
    "again , asph - am with 40 neighbours seems to bring some global estimation bias .",
    "enbid - fiestas with @xmath172 does not perform any better than sph - am since it seems to underestimate @xmath6 earlier in the high density regime .    regarding the global scaling ,",
    "the findings of figure  [ hern1_fig ] are confirmed : we obtain the best results by matching the nearest neighbour distance distributions and we measure again ( but this coincidence is not generic ) @xmath173 ) .",
    "the suboptimal nature of the global scaling induces an increase of the amplitude of the scatter below the median , for instance when one compares sph - am 10 with sph 10 on figure  [ figure2 ] . turning to dtfe in its basic implementation , which stills perform best for low values of @xmath6 ( except for the irregularity",
    "already observed in figure  [ hern1_fig ] ) , this spread becomes dramatic and strongly asymmetric but can be reduced by using the smoother and more isotropic `` spherical '' interpolator @xmath47 .",
    "note that , given our factor of five tolerance between measured and exact phase - space density distribution function , dtfe and its smoother version do better than in figure  [ hern1_fig ] .",
    "in fact they now seem to perform slightly better than sph - am 10 in the very high - density regime .",
    "indeed , the fraction of overdense particles intervening in the calculation of @xmath90 is much larger : the calculation of @xmath90 , corresponding to a compromise between all the particles , is now more adapted to the overdense part of the phase - space distribution function . for the single hernquist profile , the fraction of particles belonging to the high @xmath6 part was indeed much smaller .",
    "hence , provided that the proper global scaling between velocities and positions has been set up , dtfe chooses by construction the proper adaptive smoothing range ( or the right number of neighbours ) .",
    "however note that the overall shape of the median curve of figure  [ figure2 ] is not as flat as for sph - am , and this is a consequence of the fact that the global scaling is only a compromise that is not locally optimal .",
    "in fact , in addition to the small-@xmath6 irregularity already observed in figure  [ hern1_fig ] , the high-@xmath6 plateau in lower - left panel of figure  [ figure2 ] is somewhat below the thick horizontal line .",
    "this follows from the presence of substructures , as discussed above , which does not only induces a strong asymmetry of the spread around the median value : it also biases it to lower values .",
    "this is because dtfe uses many neighbours in that regime to perform the interpolation , ( about 200 as will be discussed in next section , see figure  [ con ] ) , which makes it very sensitive to the local anisotropies in the phase - space distribution function .",
    "the bias on the high-@xmath6 plateau is at least partly corrected for by the `` spherical '' version of dtfe , which is indeed expected to less sensitive to such anisotropies , as illustrated by lower - right panel of figure  [ figure2 ] .    to illustrate in more detail the influence of the choice of the global scaling parameter , @xmath0 , between velocity space and position space , figure [ figure3 ] shows , for our composite profile , how the quality of the measurement of @xmath6 changes with @xmath0 for the sph method with 40 neighbours ( similar trends",
    "would be seen for the dtfe method , while adaptive metric methods , e.g. sph - am with 40 particles , are by definition totally insensitive to the choice of @xmath0 ) .",
    "the domain of valid estimates for @xmath6 considerably depends on the choice of @xmath0 , as a change by a factor 4 in @xmath0 induces a loss by an order of magnitude in the high density range .",
    "note in particular that the shape of the scatter , below the median curve , changes with the actual value of @xmath0 .",
    "for instance , this scatter is reduced in the intermediate range of values for @xmath6 in the middle panel of figure  [ figure3 ] .",
    "this is again a consequence of the fact that the optimal value of @xmath0 depends on location in phase - space , in particular on the local distribution of velocities versus positions in the core of substructures , i.e. in the neighbourhood of local density peaks in phase - space .    following   [ sec : hernquist ] , let us finally turn to the measurement of @xmath146 and its logarithmic derivative , @xmath154 , as illustrated by figure  [ figure5 ] .",
    "the analytic calculation of @xmath146 is similar to   [ sec : hernquist ] except that we now consider each component separately and then combine them straightforwardly . the measurement @xmath146 itself",
    "is performed exactly as explained in ",
    "[ sec : hernquist ] .",
    "the results of figure  [ figure2 ] are partly confirmed by figure  [ figure5 ] : the best adaptive metric method is again sph - am with 10 neighbours .",
    "however the best measurements are by far now given by the basic dtfe method ( without additional smoothing ) .",
    "recall that this is due , in part , by the fact that the calculation of @xmath146 is better behaved for the dtfe method than for other methods : indeed the concept of eulerian volume is well defined for dtfe , while it remains only approximate with the sph methods .",
    "these methods are optimal when one sits on particles , but get more and more inaccurate when one goes away from the particles . in that sense ,",
    "figure  [ figure2 ] , which uses a pure lagrangian point of view , greatly favours the sph methods , while the measurement of @xmath146 , which is intrinsically an eulerian quantity , favours more dtfe .",
    "globally , the measurements in this section suggest that the dtfe method performs rather well , provided that the correct position / velocity scaling is set up .",
    "however , the very calculation of the correct value of the scaling factor , @xmath0 , is not straightforward : in   [ sec : hernquist ] , the dtfe method was performing poorly .",
    "even if it is well estimated , this global scaling provides only a compromise , that is not locally optimal .",
    "finally , let us mention some additional issues about the dtfe method .",
    "while exploring various values of @xmath0 , we found that with larger @xmath0 , this method starts to generate very large number of delaunay cells which becomes rapidly impossible to handle computationally .",
    "the same happens when we increase the cut - off radius @xmath112 : in that case , particles near the border of the catalogue present tremendously large number of delaunay cells , as they are connected to almost all the other particles .",
    "indeed , it is expected that a high level of local anisotropy increases the number of dtfe neighbours",
    ". could involve minimising the total number of delaunay cells .",
    "] for all these reasons , we favour the sph - am method relative to the dtfe method , even if they seem to perform less well for the measurement of eulerian quantities such as @xmath146 .",
    "still , if one put aside the problem of position / velocity scaling , the dtfe method provides a local estimate of the optimal number of neighbours , which can help to find the best number of neighbours for the sph - am method , as we shall discuss in   [ sec : smoothneig ] .",
    "finally , while potentially better than the sph - am method , the asph - am methods tend to yield a slight overestimation bias for the mid - range of values of @xmath6 , and we did not find a straightforward way to correct for it .          we now consider the realistic case of a halo extracted from a cold dark matter ( cdm ) @xmath22-body simulation . to do that , we performed a standard cdm simulation with gagdet2 @xcite involving @xmath174 particles in a periodic cubic box of size @xmath175 mpc .",
    "the choice of the cosmological parameters is matter density @xmath176 and cosmological constant @xmath177 .",
    "the linear variance of the density fluctuations in a sphere of radius @xmath178 mpc is @xmath179 and the hubble constant fixes @xmath120 .",
    "this is slightly different from recent constrains e.g. provided by wmap @xcite but should be close enough for our purpose . for reference ,",
    "these cosmological parameters fix the mass of a particle to be @xmath180 .",
    "haloes were extracted at present time from this simulation using standard fof algorithm with linking parameter @xmath181 . to make the calculations tractable for dtfe , we selected the third most massive halo , which contains about @xmath182 particles . only the linked particles are considered . in the subsequent analyses ,",
    "calculations are performed in comoving phase - space coordinates instead of physical ones . however , when it comes to phase - space density calculation , the main change when passing from one system of coordinates to the other comes from the effect of the hubble flow , which has rather insignificant impact on the final results .",
    "figure [ figure2bb ] displays various projections of the halo , following figure  [ figure1a ] . here",
    ", only one additional complication arises in order to calculate correctly phase - space diagrams : the centre of the halo has to be defined accurately in phase - space .",
    "we find this centre through an iterative process , applied to each subspace separately .",
    "the first step involves considering the centre as the mean position ( velocity ) of all the particles .",
    "then , the distance of each particle from this centre is computed and half of the particles are removed by choosing the most distant ones .",
    "a new centre is computed from the remaining particles .",
    "the process is repeated again as long as there are more than 100 particles left .    as noted earlier , the velocity subspace ( upper panels of fig .",
    "[ figure2bb ] ) is relatively featureless .",
    "figure [ figure2bb ] is in fact very similar to figure  [ figure1a ] , except for the lower - left panel which displays more complex structures . in particular ,",
    "in addition to the vertical `` fingers '' , one can notice some elongated structures that correspond to non trivial filamentation of phase - space built up by the dynamics , e.g. tidal tails ( see for instance peirani & pacheco 2007 ) .",
    "-body halo with @xmath183 million particles .",
    "the left and right columns correspond to the sph - am method with 10 and 40 neighbours , respectively , for the theoretical phase - space density , @xmath91 . from top to bottom , the smoothing method considered is ( a ) the sph - am method with 40 neighbours on the left panel and sph - am with 10 neighbours on the right panel , ( b ) the asph - am with 40 neighbours on the left and asph - am with 10 neighbours on the right panel , ( d ) the basic dtfe method and ( e ) dtfe method with spherical smoothing . , width=321,height=642 ]    in this more realistic framework , we can not rely on an analytic expression of the reference @xmath91 to perform plots similar to figures  [ hern1_fig ] and [ figure2 ] .",
    "however since the sph - am methods have our preference , we shall now use them as references .",
    "this is illustrated by figure  [ figure10 ] , which shows the ratio @xmath184 as a function of @xmath91 for various smoothing methods ; @xmath91 is given this time by the sph - am methods with 10 and 40 neighbours , for respectively the left and right columns .",
    "note that @xmath6 and @xmath91 are measured for each particle individually to perform these scatter plots . to fix the global scaling position / velocity parameter for the dtfe implementations , we use a coincidence scaling of the peak distance distribution given by @xmath185 .",
    "figure [ figure10 ] confirms qualitatively the results found for the single and the composite hernquist profiles . in particular , the sph - am methods with 40 neighbours underestimates high phase - space densities compared to the sph - am 10 method . in the upper left panel of figure  [ figure10 ] , there is also a tail below the median curve , which arises because the measured @xmath6 is significantly biased toward lower values nearby local phase - space density peaks corresponding to each substructure , as explained in previous section ; this local bias is more prominent for the sph - am 40 than sph - am 10 method , and consequently the median curve of the upper left panel is slightly below unity , except for low-@xmath6 .",
    "this bias can be reduced with adaptive smoothing , as shown in the second row of figure  [ figure10 ] with the asph - am 40 method . but recall that this is achieved at a price of a slight uncontrollable positive bias , here in underdense phase - space regions .",
    "the dtfe method seems to behave well overall , with a positive bias in underdense phase - space regions when implementing its smoother version .",
    "however , our appreciation is again skewed by the somewhat loose factor of five tolerance .",
    "in fact , dtfe in its simpler implementation seems to globally underestimate the phase - space density distribution function , except in the very - low and in the very - high density regimes .",
    "again , this is due to the contribution from substructures , which is now more significant given the larger effective number of neighbours used by dtfe and its high sensitivity to the choice of the local scaling , @xmath1 .",
    "the effect of the tail below the median value is therefore now more significant than for the upper left panel , and it is reduced , as well as the bias of the median curve in intermediate values of @xmath6 , by the spherical implementation ( lowest panels of figure  [ figure10 ] ) . hence figure [ figure10 ] globally confirms the findings of figure  [ figure2 ] . note that we do not observe any irregularity in the low-@xmath6 regime as in figure  [ figure2 ] , because the cut - off of the halo is performed in a much smoother way .",
    "although the delaunay tessellation can not easily address the problem of the position / velocity scaling , because of it self adaptive nature , it still provides some insight about the local neighbourhood , in particular about the optimal number of neighbours that should be used in sph methods . in   [ sec : smoothneig ] , we analyse in details the neighbour distribution provided by the delaunay tessellation .",
    "this will help us to better understand the results found in the previous sections and to further justify our preference for the sph - am estimator with a number of neighbours ranging from 10 to 40 .",
    "the analyses of   [ sec : numexp ] show that the entropy method implemented in enbid provides a very good approximation of the local scaling to apply between positions and velocities . in   [ sec : posvelcor2 ] , we investigate how this scaling depends on the environment , and in particular on the value of @xmath6 .",
    "this will allow us to better understand to choice of the global scaling .",
    "found by the delaunay tessellation for the three profiles considered in this paper .",
    "_ top left panel : _ the probability distribution function , @xmath186 , for a particle of having @xmath22 neighbours .",
    "_ top right panel : _",
    "@xmath22 is shown as a function of the theoretical phase - space density , @xmath91 , for our single hernquist profile .",
    "the horizontal line corresponds to the mean value of @xmath22 , while the smooth black curve gives the median as a function of @xmath91 .",
    "_ bottom left panel : _",
    "@xmath22 is shown as a function of the theoretical phase - space density , for our composite hernquist profile .",
    "_ bottom right panel : _",
    "@xmath22 is shown as a function of the phase - space density measured in our dark matter simulated halo.,width=321,height=321 ]    in figure  [ con ] , we study the distribution of the number of neighbours built by the delaunay structure as a function of phase - space density , for the single hernquist profile of   [ sec : hernquist ] ( upper right panel ) , the composite hernquist profile of   [ sec : hernquist_composite ] ( lower left panel ) and the @xmath22-body halo of   [ sec : nbodyhalo ] ( lower right panel ) .",
    "the upper left panel shows , for each instance , the overall distribution function of the number of neighbours .",
    "as expected , the average number of neighbours is approximately the same in the three cases : @xmath187 , 165 and 167 , for the hernquist profile , the composite hernquist profile and the @xmath22-body halo , respectively .",
    "the presence of substructures widens the overall distribution of values of @xmath22 , as shown by the green and the red curves in upper left panel of figure  [ con ] , as compared to the black one . in the three cases considered ,",
    "the typical number of neighbours decreases with increasing phase - space density , following three regimes :    1 .",
    "_ particles near the edges : _ at the edges of the catalogue , where @xmath6 is very small , @xmath22 is very large , of the order of 1000 for the hernquist cases up to nearly 10000 for the @xmath22-body halo .",
    "it then decreases rapidly , while particles are getting away from the edges to reach the next regime , ( ii ) .",
    "note that @xmath22 being large is not a consequence of @xmath6 being small , but follows from the fact that the phase - space distribution function presents an overall positive curvature and is highly anisotropic because of the edges .",
    "2 .   _ the plateau at intermediate values of @xmath6 , far from the edges and from the main distribution of local maxima : _ in this quiescent regime , we have @xmath188 , where @xmath189 is the typical number of expected delaunay neighbours just as quoted above .",
    "note that there is a slight difference between the hernquist profiles and the @xmath22-body halo , in particular a lower bump at @xmath190 in upper right and lower left panels , that corresponds to the transition between regime ( i ) and regime ( ii ) , and which does not appear for the @xmath22-body halo .",
    "this is probably due to the brutal cut - off imposed at radius @xmath112 as mentioned in ",
    "[ sec : hernquist ] , which can affect the neighbour distribution in a non trivial manner up to @xmath191 for the single hernquist profile and the main component of the composite hernquist profile .",
    "3 .   _ the high density regime , dominated by the regions nearby local maxima : _ the number of neighbours decreases again rapidly because @xmath6 now presents an increasingly overall negative curvature when one reaches the densest regions , which makes @xmath22 smaller ; we measure it to be as small as 30 in the presence of substructures ( which dominate large values of @xmath6 , as noticed in   [ sec : hernquist_composite ] ) , while it remains close to 100 in the single hernquist profile .",
    "intuitively these numbers suggest that , when turning to sph methods , the number of neighbours used to perform the interpolation should depend on the environment .",
    "in particular , in the `` quiescent '' regime , i.e. far from the edges and from the peaks , we should take around 200 neighbours to perform the measurements .",
    "however , such a large number of neighbours is not optimal near the peaks : the dtfe algorithm suggests a value of @xmath22 of the order of a few tens for sampling best the core of substructures , which is fully confirmed by the analyses of our previous sections .",
    "furthermore we noticed that these values of @xmath192 and @xmath193 are still appropriate in the quiescent regime : only the signal to noise ratio the spread due to local poisson noise around the local average value is changed .",
    "taking a value of @xmath22 as large as 200 provides too much smoothing and biases the results in overdense regions .",
    "moreover it also induces non trivial diffusing mixing effects . the larger the number of neighbours , the more sensitive the determination of @xmath6 to local anisotropies .",
    "such local anisotropies ( and local curvature properties ) can be captured better at least partly by anisotropic sph smoothing ( see the discussion in   [ sec : mysmoothing ] and figure  [ sph_fig ] ) , but at a risk of some potential slight positive biases , as argued previously .",
    "since sph methods in their usual implementation are not self adaptive in terms of their number of neighbours , we think that the best choice for @xmath22 is a value ranging from 10 to 40 , because such a choice offers a good compromise for all the dynamic range .",
    "note that this also confirms the findings of s06 .",
    "there is still the problem of what happens near the edges , but these can sometimes be extended sufficiently far away to avoid contamination of the measurements in the region of interest .",
    "what really influences the results are abrupt changes of local curvature : while the dtfe method captures them optimally , sph method does it only approximately , and of course , does it best when the number of neighbours remains small , at the expense of a slightly worse local signal to noise ratio .",
    "note , however , that this discussion is again biased by the fact that sph uses a lagrangian point of view , i.e. it sits on the centre of each particle to measure locally the phase - space distribution function .",
    "an eulerian point of view , that would require to measure @xmath6 in an arbitrary point of space ( see , e.g. , colombi , chodorowski & teyssier 2007 ) , would probably impose a slightly larger number of neighbours for sph methods to give sensible results .",
    "note finally that the findings of figure  [ con ] are of course sensitive to the choice of the velocity / position scaling @xmath0 which is taken here to be equal to @xmath90 as discussed in previous sections .",
    "indeed , the value of @xmath0 influences the properties of the local curvature of the distribution function ( or the matrix of its second derivatives ) , so we expect the low-@xmath6 and particularly the high-@xmath6 regimes to be affected by the chosen @xmath0 ( fig .  [ figure3 ] ) .       and the simulated halo of   [ sec : nbodyhalo ] , respectively . _ from top to bottom _ , the position subspace scaling , @xmath194 , the velocity subspace scaling , @xmath195 , and the ratio @xmath196 .",
    "_ in the left panels _ , the phase - space density is the theoretical one .",
    "_ in the right panels _ , it is measured in the sample using sph - am with 40 neighbours.,width=321,height=481 ]    in the enbid algorithm , one gets for each particle a hyperbox of size @xmath197 in position subspace and of size @xmath198 in velocity subspace .",
    "figure  [ figure2met ] shows the measured value of @xmath194 , @xmath195 and @xmath196 as functions of @xmath6 , for our composite hernquist profile ( left columns ) and our @xmath22-body halo ( right columns ) .",
    "the global behaviour of the quantities @xmath199 and @xmath200 as decreasing functions of @xmath6 ( the median curves in the four upper panels of figure  [ figure2met ] ) is expected , as increasing phase - space density corresponds to a smaller size for the local hypercube .",
    "due to the more concentrated extension of substructures in position rather than in velocity space , the corresponding decrease is more significant for @xmath199 by an order of magnitude than for @xmath200 by about a factor 2 . as a result ,",
    "the ratio @xmath196 changes from about @xmath201 in the low-@xmath6 regime to @xmath202 in the high-@xmath6 regime ( see the median curve in two lower panels of figure  [ figure2met ] ) .    when examining in more details the scatter plots on the right panels of figure  [ figure2met ] , we note a bimodal structure : the cloud of points splits into two fingers at high @xmath6 .",
    "the shorter and denser finger corresponds to the main part of the halo , while the other corresponds to the contribution of substructures , which are more concentrated in phase - space than the central part of the halo .",
    "this last statement can be easily checked by looking at the upper right panel of figure  [ figure4str ] .",
    "the main part of the halo is globally relaxed so its concentration in velocity space does not depend significantly on the value of @xmath6 ( the upper horizontal finger in the middle right panel of figure  [ figure2met ] ) , while its position density behaves approximately like a power - law ( lower roughly straight and diagonal finger in the upper right panel of figure  [ figure2met ] ) . on the other hand ,",
    "substructures are tidally disrupted and lose particles while they spiral into the halo : they represent a population of objects at various dynamical states , different from the dynamical state of the main part of the halo .",
    "this explains the bimodality observed in right panels of figure  [ figure2met ] .",
    "it would however go beyond the scope of this paper to fully explain the details of this bimodality .",
    "it is indeed difficult to disentangle the effect of the local change of substructure phase - space / velocity subspace / position subspace profile due to tidal deformation , in particular to a mass loss , from the statistical averaging carried over the population of all the substructures .",
    "note that , even though the prescription used to create the hernquist composite profile is dynamically unrealistic , there still should be a bimodal effect in this experiment , because the substructures present a population of objects at various `` dynamical states '' , different from the main component , owing to the fact that they are less massive .",
    "however , in addition to having unrealistic individual profiles , the contribution of substructures was purposely exaggerated : they are more massive than those of the simulated halo .",
    "consequently , the bimodality is much less obvious on the left panels of figure  [ figure2met ] than on the right panels .",
    "of course , this difference only partly accounts for this finding , as tidal stripping changes the individual profiles of subhaloes @xcite and also produces tidal tails that contribute in a non trivial way to filamentation of phase - space .",
    "the bimodal nature of the distribution of the ratio @xmath203 has a dramatic impact on methods which rely on a global scaling between positions and velocities prior to the measurement of the distribution function . furthermore , apart from that problem and the large scatter of this ratio ( of about one order of magnitude ) , its median value changes with @xmath6 , as mentioned earlier .",
    "note however the plateau reached at high values of @xmath6 , a regime dominated by substructures , where @xmath204 .",
    "the global average of the ratio is equal to 0.7 and 0.5 for the hernquist composite profile and the simulated halo , respectively , while @xmath205 and 0.38 .",
    "it is important to notice that the values of @xmath90 are thus close to the high-@xmath6 plateau , showing that high values of @xmath6 are expected to be calculated with nearly optimal scaling parameter using our peak matching of the distance distribution .",
    "in our hernquist composite profile . the ratio @xmath184 is shown as a function of @xmath91 , where @xmath6 and @xmath91 are the measured and the exact phase - space densities , respectively . to generate the _ left panel _ , we used sph - am with 40 neighbours . to measure the function @xmath206 _ on the right panel _ , we use a standard sph interpolation in position space with 32 neighbours to estimate locally @xmath207 and measure the velocity dispersion @xmath208 with the same position space kernel.,width=321,height=160 ]                prior to the existence of 6d phase - space density estimators , an approximation of the phase - space density was proposed , which involves only the measurement of quantities in position space rather than in full 6d phase - space ( see for instance , taylor & navarro , 2001 ) : @xmath209^{5/2}}{\\left [ \\int{v^2 { f({\\mathbf{x}},{\\mathbf{v}})}{\\rm d}^3v } \\right]^{3/2 } } , \\label{eq : qtof}\\end{aligned}\\ ] ] where @xmath207 is the local projected density and @xmath210 is the local one dimensional velocity dispersion defined as @xmath211 .",
    "the function @xmath206 has been widely used in the literature as a proxy of the true `` phase - space '' distribution function @xcite .",
    "it is often defined in a spherically average way , @xmath212 .",
    "for instance , taylor & navarro ( 2001 ) found that @xmath213 with @xmath214 , in good agreement with the secondary infall model @xcite .    to relate @xmath215 to the true phase - space density in a more intuitive way than equation  ( [ eq : qtof ] )",
    ", we can assume that @xmath11 factorises as follows : @xmath216 ^ 2}{2    \\sigma^2({\\bf x } ) } \\right\\ } ,   \\label{eq : fap}\\ ] ] where proper normalisations were set up directly .",
    "hence , @xmath217",
    "^ 2}{2   \\sigma^2({\\bf x } ) } \\right\\}.\\ ] ] in particular , @xmath218(2\\pi)^{3/2}$ ] .",
    "we see that , within a normalisation factor , function @xmath206 is representative of the true phase - space distribution function where it matters , i.e. in the neighbourhood of local maxima in velocity space .",
    "of course , this argument is valid only if at fixed @xmath219 , the function @xmath220 presents only one local maximum in @xmath221 space .",
    "if this condition is verified , we could expect the function @xmath206 to represent a fair estimate of the true phase - space distribution function near the local maxima in phase - space , which correspond to substructures .",
    "however this is not strictly true since substructures a embedded in the background of the main component of the halo : @xmath222 is not the local velocity dispersion of the substructure but rather the local velocity dispersion of the diffuse component , which is much larger .",
    "we therefore expect @xmath206 to _ underestimate _ the true distribution function in substructures , corresponding to the high @xmath6 regime , which is dominated by these clumps . on the other hand , when considering the main component of the halo , which dominates the low @xmath6 regime , we expect @xmath206 to _ overestimate _ the true distribution function , as , @xmath223 for @xmath224 in equation  ( [ eq : fap ] ) .",
    "these arguments rely on the very simple modeling given by equation  ( [ eq : fap ] ) , but they are confirmed by figure  [ figureq ] , which compares the measured function @xmath206 to the exact solution for the hernquist composite profile studied in ",
    "[ sec : hernquist_composite ] .",
    "similar trends are observed for the simulated halo , not shown here .",
    "clearly , the function @xmath5 corresponds to a serious shortcoming when compared to the realistic phase - space estimators studied in this paper .",
    "however it seems to capture the main features of the distribution function , as illustrated by figures  [ figure6str ] and [ figure6strbis ] .",
    "these figures compare , in various subspaces , the structures obtained when colour is coded by projected density @xmath207 , using the parameter @xmath206 , and by phase - space density .",
    "they are supplemented with figure  [ figure4str ] , which shows @xmath3 , @xmath5 and",
    "@xmath6 as functions of distance @xmath7 from the halo centre . note interestingly that , both for the 6d estimator and its proxy @xmath5 , the maximum value of phase - space density in substructures seems to be approximately the same for all the substructures ( and larger than at the centre of the halo ) .",
    "this property is quite useful as it makes substructure detection quite easy with simple friend - of - friend algorithm , as proposed by diemand et al .",
    "these authors do not use the true phase - space distribution function but the function @xmath5 to carry the detection .",
    "while pure projected density codes provide much less information than phase - space density ones , the @xmath206 function seems to capture the most important features of phase - space , and in particular subhaloes .",
    "however , the true phase - space density provides additional crucial information , in particular subtle phase - space structures such as the fine filaments observed in the @xmath225 diagram , some of which being at the origin of caustics , others corresponding to tidal tails . in a forthcoming work",
    ", we shall discuss the detection and analysis of substructures in phase - space .",
    "we shall see that analysis of substructures in phase - space can be used to infer powerful properties on the dynamical history of dark matter haloes .",
    "we devoted this paper to the study of six - dimensional phase - space density estimators in @xmath22-body samples .",
    "we considered several methods used in the literature to estimate phase - space density that differ from each other ( i ) in the way the tessellation of space is performed , and ( ii ) in the way local interpolation is performed .",
    "concerning point ( i ) , we consider two kind of tessellations : the delaunay tessellation ( dtfe ) proposed by arad et al .",
    "( 2004 ) through the sheshdel algorithm and the hierarchical decomposition of phase - space using binary tree technique as proposed by ascasibar & binney ( 2004 ) through the fiestas algorithm , later improved by sharma & steinmetz ( 2006 ) with the enbid implementation . in the ( ii ) class , we consider two ways of estimating the phase - space density for the dtfe method , one based on the direct estimation of the local delaunay cells volumes , and a more isotropic , smoother version of it .",
    "for the binary tree method , we consider the hypercubical cell smoothing proposed in fiestas and the standard sph smoothing ( but in 6d instead of 3d ) using an epanechikov kernel as advocated by s06 .",
    "we also test an anisotropic sph method ( asph ) .    in all these methods ,",
    "a crucial problem is to set properly the local metric frame to relate position and velocities , which basically sets a scaling factor between the position and the velocity subspace .",
    "while the binary tree methods can be optimised locally both through their refinement and through the definition of such a system of coordinates  using a shannon entropy criterion , as advocated by s06 and implemented through the enbid algorithm , a global metric must also be defined for the dtfe method , prior to the construction of the tessellation network .    in order to automatically specify a global metric , we presented two methods which yield similar results .",
    "the first one involves simple dynamical arguments based on the properties of nfw profiles .",
    "the second method involves measuring the nearest neighbour distance distributions in position and in velocity subspace and finding the scaling factor between position and velocities for which the positions of the peak of these two distributions match each other .",
    "to summarise , we tested the following implementations :    1 .   the dtfe algorithm and a smoother , more isotropic version of it .",
    "both of them require the definition of a global metric ; 2 .   the fiestas binary tree method with enbid improvement ; 3 .   sph methods ( a ) with enbid improvement and ( b ) without it .",
    "we denote case ( a ) by sph - am , i.e. sph with adaptive metric , in opposition to case ( b ) that we simply denote by sph ; which requires a global metric setting ; 4 .",
    "adaptive sph methods with adaptive metric ( asph - am ) .    to test the various algorithm in details",
    ", we used three halo models :    ( a ) : :    a hernquist isotropic profile with @xmath226    particles . in that case ,",
    "analytical estimates are available for the    phase - space distribution function .",
    "( b ) : :    a composite hernquist halo , built from a main component with    @xmath227 particles , and a set of substructures    amounting to @xmath227 particles . in that more    realistic case",
    ", there is also an exact expression for the phase - space    distribution function .",
    "( c ) : :    a @xmath22-body halo with 1.8 millions particles extracted from    a standard cdm simulation .",
    "the main results of our analyses are the following :    * because they are local and adaptive , the sph - am methods provide the best estimators for the phase - space density , when using a moderate number of neighbours , ranging from 10 to 40 in order to perform the interpolation . *",
    "while dtfe estimators are in principle better than sph estimators when one measures eulerian quantities ( not centred on the particle positions ) , they generally perform poorly in phase - space because they rely on a global metric setup .",
    "a dynamically consistent measurement of the phase - space distribution function requires that the scaling between positions and velocity be locally adaptive .",
    "the best compromise , without supplementary assumption on the dynamical history of the system , is achieved by enforcing local isotropy in phase - space : this is achieved in practice by the shannon entropy criterion used in enbid .",
    "note finally a last weakness of dtfe methods : they are extremely costly from a computational point of view compared to sph - am , both in terms of computer time and memory .",
    "* while the optimal number of neighbours should typically be around 200 as suggested by dtfe , we find , using also dtfe , that it should be around a few tens near high density peaks , which justifies the low value we suggest to use for the sph - am method : such a number increases noise to signal ratio , but allows us to probe better high phase - space density peaks . * by analysing the properties of the local metric proposed by enbid , we find that the distance distribution matching method provides a global scaling between positions and velocities which probes well the high density regions of phase - space , which are dominated by substructures",
    ". we also find that the actual `` optimal '' local scaling presents a bimodal distribution , made from the contribution of the main component of the halo , roughly in equilibrium , and the contribution of the substructures , which are tidally disrupted while they spiral in within the halo .",
    "this bimodality and the corresponding large scatter of about one order of magnitude on the local scaling parameter between positions and velocities has a dramatic impact on the performance on methods relying on global metric setting , such as dtfe . *",
    "the asph - am methods do not bring much improvement over the sph - am implementation .",
    "they can potentially improve phase - space estimation in high density regions , but at the cost of a slight systematic overestimation bias in the moderate density regime .",
    "note that most of our estimators are lagrangian in nature,_i.e .",
    "_ they estimate phase - space density at particles positions : in that sense they favour the sph approach relatively to the dtfe approach .",
    "one has to keep in mind that dtfe tessellates accurately all space , while the sph smoothing becomes increasingly suboptimal while departing from the particles .",
    "in particular , we found that an eulerian quantity such as @xmath146 was still best measured by dtfe , despite the problem of the suboptimal position / velocity scaling .",
    "alternative routes to phase - space density estimation could involve using the angle - action canonical variables which match the closest spherical fit to a given halo . indeed , the topology of the underlying tori would provide a natural setting in which to coarse grain the distribution .",
    "we thank i. arad for parts of the used code and many important comments .",
    "we thank s. white and v. springel for useful discussions .",
    "part of this work was completed during a visit of m.m . and s.c .",
    "at mpa / garching .",
    "this work was completed within the framework of the horizon project ( www.projet-horizon.fr ) .",
    "m. maciejewski was funded by the european program @xmath228 mest - ct-2004 - 504604 .",
    "50 alard c. , colombi s. , 2005 , mnras , 359 , 123 arad i. , dekel a. , klypin a. , 2004 , mnras , 353 , 15 ascasibar y. , binney j. 2005 , mnras , 356 , 872 austin c. , williams l. , barnes e. , babul a. , dalcanton j. , 2005 , apj , 634 , 756 bernardeau f. , van de weygaert r. , 1996 , mnras , 279 , 693 bertschinger e. , 1985 , apjs , 58 , 39 binney j. , tremaine s. , 2008 , galactic dynamics , princeton univ . press , princeton , nj colombi s. , chodorowski m. , teyssier r. , mnras , 375 , 348 diemand j. , kuhlen m. , madau p. , 2006 ,",
    "apj , 649 , 1 hayashi e. , navarro j. f. , springel , v. , 2007 , mnras , 377 , 50 huchra j.p . , geller m.j . , 1982 , apj 257 , 423 hernquist l. , 1990 , apj 356 , 359 jing y. p. , suto y. , 2002 , apj , 574 , 538 moore b. , governato f. , quinn t. , stadel j. , lake g. , 1998 , apj , 499 , l5 moore b. , ghigna s. , governato f. , lake g. , quinn t. , stadel j. , tozzi p. , 1999 , apj , 524 , l19 navarro j.f .",
    ", frenk c.s . , white s. d. m. , 1997 , apj , 490 , 493 peirani , s. , de freitas pacheco , j. a. , 2007 , astro - ph/0701292 pelupessy f. i. , schaap w. e. , van de weygaert r. , 2003 , a&a 403 , 389 rasia e. , tormen g. , moscardini l. , 2004 , mnras , 351 , 237 romano - diaz e. , van de weygaert r. , 2007 , mnras , 382 , 2 schaap w.  e. , van de weygaert r.  2003 , statistical challenges in astronomy , 483 schneider p. , 2006",
    ", extragalactic astronomy and cosmology : an introduction , springer sharma s. , steinmetz m. , 2006 , mnras 373 , 1293 spergel d.n . , verde l. , peiris h.v . , et al . , 2003 .",
    "apjs 148 , 175 springel v. , 2005 , mnras , 364 , 1105 springel v. , white s. d. m. , tormen g. , kauffmann g. , 2001 , mnras , 328 , 726 stadel j.g . , phd thesis , university of washington , 2001 stoehr f. , 2006 , mnras , 365 , 147 taylor j. e. , navarro j. f. , 2001 , apj , 563 , 483 tremaine s. , henon m. , lynden - bell d. , 1986 , mnras , 219 , 285 vogelsberger m. , white s.d.m . , helmi a. , springel v. , 2008 , mnras , 385 , 236 van de weygaert r. , schaap w. , 2007 , astro - ph/0708.1441v1"
  ],
  "abstract_text": [
    "<S> in the framework of particle - based vlasov systems , this paper reviews and analyses different methods recently proposed in the literature to identify neighbours in six dimensional space ( 6d ) and estimate the corresponding phase - space density . </S>",
    "<S> specifically , it compares smooth particle hydrodynamics ( sph ) methods based on tree partitioning to 6d delaunay tessellation . </S>",
    "<S> this comparison is carried out on statical and dynamical realisations of single halo profiles , paying particular attention to the unknown scaling , @xmath0 , used to relate the spatial dimensions to the velocity dimensions .    </S>",
    "<S> it is found that , in practice , the methods with local adaptive metric provide the best phase - space estimators . </S>",
    "<S> they make use of a shannon entropy criterion combined with a binary tree partitioning and with subsequent sph interpolation using 10 to 40 nearest neighbours . </S>",
    "<S> we note that the local scaling @xmath1 implemented by such methods , which enforces local isotropy of the distribution function , can vary by about one order of magnitude in different regions within the system . </S>",
    "<S> it presents a bimodal distribution , in which one component is dominated by the main part of the halo and the other one is dominated by the substructures of the halo .    while potentially better than sph techniques , since it yields an optimal estimate of the local softening volume ( and therefore the local number of neighbours required to perform the interpolation ) , the delaunay tessellation in fact generally poorly estimates the phase - space distribution function . </S>",
    "<S> indeed , it requires , prior to its implementation , the choice of a global scaling @xmath0 . </S>",
    "<S> we propose two simple but efficient methods to estimate @xmath0 that yield a good global compromise . </S>",
    "<S> however , the delaunay interpolation still remains quite sensitive to local anisotropies in the distribution .    </S>",
    "<S> to emphasise the advantages of 6d analysis versus traditional 3d analysis , we also compare realistic six dimensional phase - space density estimation with the proxy proposed earlier in the literature , @xmath2 , where @xmath3 is the local three dimensional ( projected ) density and @xmath4 is the local three dimensional velocity dispersion . </S>",
    "<S> we show that @xmath5 only corresponds to a rough approximation of the true phase - space density , and is not able to capture all the details of the distribution in phase - space , ignoring , in particular , filamentation and tidal streams .    </S>",
    "<S> methods : data analysis , methods : numerical , galaxies : haloes , galaxies : structure , cosmology : dark matter </S>"
  ]
}