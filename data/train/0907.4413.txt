{
  "article_text": [
    "velocity space dynamics are often important in the weakly collisional plasmas prevalent in astrophysics and fusion applications , leading to the necessity of a kinetic treatment .",
    "since the kinetic description requires a six - dimensional phase space , simulating weakly collisional plasma processes can be computationally challenging .",
    "employing the gyrokinetic ordering  @xcite reduces the dimensionality by eliminating gyrophase dependence , but we are still left with a high - dimensional system .",
    "consequently , one would like to know how many grid points are necessary along each dimension , particularly in velocity space , in order to resolve a given simulation .    in the absence of collisions or some other form of dissipation",
    ", the distribution of particles in velocity space can develop arbitrarily small - scale structures  @xcite .",
    "this presents a problem for gyrokinetic simulations , as an arbitrarily large number of grid points would be necessary to resolve such a system . of course",
    ", all physical systems possess a finite collisionality , which sets a lower bound on the size of velocity space structures and , therefore , an upper bound on the number of grid points required for resolution .",
    "we would like to know how sensitive the plasma dynamics are to the magnitude and form of the velocity space dissipation .",
    "in particular , we would like answers to the following set of questions : given a fixed number of grid points , how much dissipation is necessary to ensure a resolved simulation ?",
    "alternatively , given a fixed amount of dissipation , how many grid points are necessary to ensure a resolved simulation ?",
    "furthermore , what measurable effect , if any , does the addition of dissipation have on collisionless plasma dynamics ?    these questions have been addressed for very few plasma processes  @xcite , in large part due to the computational expense involved with such a study . in this paper , we propose computationally efficient diagnostics for monitoring velocity space resolution , and we apply these diagnostics to a range of weakly - collisional plasma processes using the continuum gyrokinetic code ` gs2 `  @xcite . with the aid of these diagnostics , we have implemented an adaptive collision frequency that allows us to resolve velocity space dynamics with the approximate minimal necessary physical dissipation .",
    "we find that the velocity space dynamics for growing modes are well resolved with few velocity space grid points , even in the collisionless limit . including a small amount of collisions ( @xmath0 ) is necessary and often sufficient to adequately resolve nonlinear dynamics and the long - time behavior of linearly damped modes .",
    "the paper is organized as follows . in sec .",
    "ii we discuss velocity space dynamics in gyrokinetics and provide examples illustrating the development of small - scale structure in collisionless plasmas .",
    "iii contains a brief overview of the ` gs2 ` velocity space grid and its dissipation mechanisms .",
    "we describe diagnostics for monitoring velocity space resolution in sec .  iv and apply them to a number of plasma processes . in sec .",
    "v , we introduce an adaptive collision frequency and present numerical results .",
    "we discuss our findings in sec .",
    "` gs2 ` solves the coupled system consisting of the low - frequency maxwell s equations and the nonlinear , electromagnetic gyrokinetic equation with a model fokker - planck collision operator : @xmath1 { \\right>}_{{\\mathbf{r } } } + \\underbrace{\\frac{q f_{0}}{t}{\\frac{\\partial { \\left<}\\chi { \\right>}_{{\\mathbf{r}}}}{\\partial t } }   - { \\mathbf{v_{\\chi } } } \\cdot \\nabla f_{0}}_{\\mathcal{s } } , \\label{eqn : gke}\\ ] ] where @xmath2 is the non - boltzmann part of the perturbed distribution function , @xmath3\\ ] ] is the sum of the curvature and @xmath4 drift velocities , @xmath5 is the generalized @xmath6 velocity ( including both the @xmath6 drift and the drift due to the motion of the perturbed magnetic field ) , @xmath7 is the generalized electromagnetic potential , @xmath8 denotes a gyro - average at fixed guiding center position @xmath9 , and @xmath10 is the lowest order expansion of a maxwell - boltzmann distribution .",
    "the exact form of the collision operator , @xmath11 $ ] , used in ` gs2 ` is discussed briefly in sec .",
    "iii and described in detail in refs .   and  .",
    "we can group the various terms in the gyrokinetic equation ( [ eqn : gke ] ) into three distinct categories : source terms , labeled by @xmath12 , which typically drive large - scale structures in velocity space ; convection terms , labeled by @xmath13 , which lead to phase - mixing and the development of small - scale structures in velocity space ; and dissipation , given by the collision operator , which smoothes the distribution function towards a shifted maxwellian velocity distribution .",
    "in general , the structure that develops from the balancing of these terms can be quite complicated .",
    "however , we can gain insight into how small - scale velocity structures develop by considering simplified collisionless systems .    in the absence of collisions",
    ", arbitrarily small scales can develop in velocity space .",
    "this is a result of phase - mixing , arising due to convection in real space  @xcite . as a simple example of this phenomenon",
    ", we include in appendix a a calculation of the perturbed distribution function for the collisionless ion acoustic wave in a slab .",
    "the result , quoted here , illustrates the tendency of collisionless plasma processes to drive small - scale velocity space structures : @xmath14 where the overbar on @xmath15 indicates an average over perpendicular velocities .",
    "the quantities @xmath16 and @xmath17 are explicitly derived in appendix a. here , it is sufficient to note that both @xmath16 and @xmath17 are smooth functions of the parallel velocity .",
    "the presence of the oscillatory factor @xmath18 in the first term ( often called the ballistic term ) leads to the development of a characteristic wavelength in velocity space that decreases inversely with time .",
    "the amplitude of this ballistic term remains comparable to the second term in eqn .",
    "( [ eqn : iawf ] ) for all time , leading to the development of large amplitude oscillations of the distribution function at arbitrarily small - scales in velocity space . a snapshot of this behavior at @xmath19 is shown in fig .",
    "[ fig : iaw ] .     at @xmath20 .",
    "the parallel velocity on the horizontal axis is normalized by @xmath21 , and @xmath22 was initially a maxwellian.,height=480 ]    the same calculation carried out for the collisionless itg mode in a slab yields a distribution function with a similar ballistic term component .",
    "however , since this mode is linearly unstable , there is also a term describing large - scale structure in velocity space whose amplitude grows in time to dominate the distribution function . as a result",
    ", no significant small - scale structure develops .",
    "this is a typical feature of linearly growing modes in the collisionless limit .",
    "of course , all physical systems have a finite collisionality .",
    "the dissipation arising from this collisionality is critically important : it is a necessary requirement for the existence of a statistically steady state  @xcite , and it sets a lower bound on the scale - size of structures in velocity space  @xcite . a simple estimate for the scale - size of velocity space structures can be obtained by assuming a steady state and balancing the collisional term with the other terms in the gyrokinetic equation . noting that @xmath23 ( see e.g. refs .   or  ) , we find @xmath24 where @xmath25 is the collision frequency , @xmath26 is the dynamic frequency of interest",
    ", @xmath27 is the thermal velocity , and @xmath28 is the scale - size of fluctuations in velocity space .",
    "this estimate predicts that velocity space structures much smaller than the thermal velocity develop in the weakly collisional limit , @xmath0 , as we would expect from our consideration of simplified collisionless systems .",
    "in order to fully understand the velocity space resolution diagnostics described in later sections , it is necessary for the reader to have a basic knowledge of the way in which velocity space dynamics are treated in ` gs2 ` . to that purpose , we now give a brief explanation of the velocity space coordinates and dissipation mechanisms employed in ` gs2 ` .",
    "only two velocity space coordinates are necessary in gyrokinetics because gyroaveraging has eliminated any gyrophase dependence . fundamentally , ` gs2 ` uses energy , @xmath29 , and a quantity related to magnetic moment , @xmath30 , as its velocity space coordinates .",
    "this choice eliminates all velocity space derivatives from the collisionless gyrokinetic equation and simplifies the discretization of derivatives in the model collision operator .",
    "consequently , the spacing of the velocity space grid points is chosen to provide accurate velocity space integrals while satisfying the necessary boundary condition at particle bounce points .",
    "the volume element in velocity space can be written @xmath31 where @xmath32 is the gyroangle and @xmath33 denotes the sign of @xmath34 . until recently , the energy grid in ` gs2 ` followed the treatment of ref .  , which places energy integrals in a convenient form by a change of variables to @xmath35,\\ ] ] where @xmath36 .",
    "this transforms the range of integration from @xmath37 to @xmath38 : @xmath39 the integration domain is split into the subintervals @xmath40 and @xmath41 , with the perturbed distribution function assumed to be approximately maxwellian on @xmath41 .",
    "gauss - legendre quadrature rules  @xcite are then used to determine the location of the grid points in the interval @xmath40 .",
    "this energy grid provides spectrally accurate energy integrals ( i.e. error @xmath42 , where @xmath43 is the number of energy grid points ) , provided the integrand is analytic in @xmath44 over the integration domain ( see e.g. ref  ) .",
    "unfortunately , this is seldom the case . to understand why",
    ", we consider the functional form of @xmath45 .",
    "taylor expanding @xmath44 about @xmath46 , we find @xmath47 , or equivalently , @xmath48 .",
    "this indicates a branch cut in @xmath49 originating from @xmath50 , so that most functions of @xmath49 are non - analytic at @xmath50 .",
    "furthermore , one can show that @xmath51 like @xmath52 as @xmath53 , making @xmath49 non - analytic at both ends of the domain in @xmath44 .",
    "this can be seen in fig .",
    "[ fig : xx ] , where we examine @xmath45 .",
    "the fact that @xmath49 possesses singularities at the endpoints of the domain in @xmath44 means that the integration scheme is not spectrally accurate for most integrands of interest ( especially since the bessel functions @xmath54 and @xmath55 , which are non - analytic at @xmath50 and @xmath56 , appear in all integrals of the distribution function at fixed particle position @xmath57 ) .",
    "this is demonstrated in fig .",
    "[ fig : j0newvold ] , where we examine the accuracy of the numerical integral of @xmath58 ( at fixed @xmath57 ) as we vary the number of velocity space grid points .     over the entire @xmath44 domain .",
    "the function @xmath45 has singularities at the boundaries of the domain due to a branch cut originating at @xmath50 and due to @xmath49 going to @xmath59 at @xmath56.,height=480 ]     as the number of energy grid points is varied .",
    "the error due to the integration scheme of ref .",
    "( solid line ) obeys a power law in the number of grid points , with an exponent of approximately @xmath60 . the new integration scheme detailed here ( dashed line ) has error approximately proportional to @xmath61 , where @xmath43 is the number of energy grid points .",
    "note that the minimum error in our integration scheme approaches @xmath62 , which is a limitation imposed by double precision evaluation of the bessel function.,height=480 ]    in order to achieve spectral accuracy , we have implemented a new energy grid .",
    "we begin by splitting the velocity integration into two separate integrals : @xmath63 where @xmath64 is a free parameter and @xmath65 is the function we wish to integrate . on the first interval , ( @xmath66 ) , we use gauss - legendre quadrature rules in @xmath49 to obtain grid locations .",
    "note that use of @xmath49 as our integration variable ensures that the integrand @xmath67 will be analytic as long as @xmath68 is analytic in @xmath49 over the interval .    for the interval @xmath69",
    "we make the change of variable @xmath70 to transform the integral to @xmath71.\\ ] ] we then use gauss - laguerre quadrature rules in @xmath72 to obtain grid locations .",
    "note that the volume element is analytic within the domain of integration , as is @xmath73 , so that the integrand will be analytic as long as @xmath68 is an analytic function of @xmath49 .",
    "our use of spectral integration techniques ( i.e. gaussian quadrature ) , coupled with the analyticity of our integrand for well - behaved functions @xmath65 , ensures the spectral accuracy of our integration scheme .",
    "while an exponential order of convergence is assured , the rate of convergence depends on the exact nature of the integrand and our choice of the parameter @xmath64 . in general",
    "we choose @xmath74 so that the branch cut at @xmath75 is sufficiently far from the domain of integration in @xmath72 to minimally impact the rate of convergence .",
    "we demonstrate the spectral accuracy of the scheme and determine the rate of convergence in fig .",
    "[ fig : j0newvold ] .",
    "it is worthwhile to note that for few grid points ( @xmath76 in fig .",
    "[ fig : j0newvold ] ) the grid given in ref .   may be more accurate .",
    "this is because the energy variable @xmath44 eliminates velocity - dependence of the volume element ( when solving for the normalized distribution function @xmath77 ) , while the new v - space integrals described here have the velocity - dependent volume element @xmath78 that must be integrated regardless of the form of @xmath79 .      for systems with curved magnetic field lines ,",
    "special care is also required when dealing with @xmath80  @xcite .",
    "there are two reasons for this : the grid points provided by gaussian quadrature rules are concentrated near the endpoints of the domain , whereas one would like them to be concentrated at the trapped - passing boundary ; and one must ensure that the proper boundary condition ( i.e. @xmath81 ) is satisfied at each of the bounce points . consequently , the @xmath80-grid is divided into two regions corresponding to trapped and untrapped particles , respectively .    for values of @xmath80 such that @xmath82 , the corresponding particles are untrapped by the magnetic potential well . in this region of velocity space , the integration variable @xmath83 is chosen .",
    "it is similar to pitch - angle , but it has no spatial dependence . similarly to the energy , gauss - legendre quadrature rules are used to obtain the location of grid points in @xmath84 .",
    "this naturally provides a concentration of gridpoints near the trapped - passing boundary .    for values of @xmath80 such that @xmath85 , the corresponding particles are trapped by the magnetic potential well . in the trapped region , grid points are chosen to fall on bounce points in order to allow for the enforcement of boundary conditions .",
    "mathematically , this means that for each value of @xmath86 , there must be a corresponding @xmath80 such that @xmath87 where @xmath86 gives the position along the unperturbed magnetic field line and @xmath88 is the pitch - angle .",
    "this choice of @xmath80 values also leads to a concentration of grid points near the trapped - passing boundary .",
    "a typical ` gs2 ` grid layout for a system with trapped particles is shown in fig .",
    "[ fig : gs2v ] .",
    "it should be noted that the @xmath80 integrals , like the energy integrals , are spectrally accurate , provided the distribution function is analytic in @xmath88 .    ) and at lower energy values where the maxwellian weighting dominates .",
    "red ( blue ) grid points are sample @xmath80 ( energy ) grid points that are dropped when calculating integral approximation with lower degree of precision.,height=480 ]      some form of dissipation is often necessary to prevent the formation of arbitrarily small - scale structures in velocity space .",
    "this can be achieved either through artificial numerical dissipation or through implementation of a model collision operator .",
    "both options are available in ` gs2 ` .      `",
    "gs2 ` uses a model fokker - planck collision operator that includes the effects of pitch - angle scattering and energy diffusion while satsifying boltzmann s h - theorem and conserving particle number , momentum , and energy  @xcite : @xmath89 = \\mathcal{l}[h ] + \\mathcal{d}[h ] + \\mathcal{m}[h ] , \\label{eqn : collop}\\ ] ] where @xmath90 = \\frac{\\nu_{d}}{2}\\left({\\frac{\\partial } { \\partial \\xi}}\\left(1-\\xi^{2}\\right){\\frac{\\partial h}{\\partial \\xi } } + \\frac{1}{1-\\xi^{2}}{\\frac{\\partial ^{2}h}{\\partial \\vartheta^{2}}}\\right)\\ ] ] is the lorentz collision operator , @xmath91 = \\frac{1}{4x^{2 } } { \\frac{\\partial } { \\partial x}}\\left(\\nu_{s}x^{2}f_{0 } { \\frac{\\partial } { \\partial x}}\\frac{h}{f_{0}}\\right)\\ ] ] is the energy diffusion operator , and @xmath92 $ ] contains momentum- and energy - conserving corrections .",
    "the velocity - dependent collision frequencies @xmath93 and @xmath94 are given by @xmath95 - \\frac{2xe^{-x^{2}}}{\\sqrt{\\pi}}\\right)\\ ] ] and @xmath96}{x } - \\frac{\\nu_{s}}{4}\\right).\\ ] ] with @xmath97 the frequency of collisions of particles of species @xmath98 with particles of species @xmath99 .",
    "a detailed description of the collision operator is given in ref .  .",
    "here we simply present the gyroaveraged collision operator in spectral form : @xmath100 \\right>_{k } & = \\frac{\\nu_{d}}{2}{\\frac{\\partial } { \\partial \\xi}}\\left(1-\\xi^{2}\\right){\\frac{\\partial h_{k}}{\\partial \\xi } } + \\frac{v_{th}^{2}}{4v^{2}}{\\frac{\\partial } { \\partial v}}\\left(\\nu_{s}v^{2}f_{0}{\\frac{\\partial } { \\partial v}}\\frac{h_{k}}{f_{0}}\\right ) \\\\ & - \\frac{k_{\\perp}^{2}\\rho^{2}}{8\\omega_{0}^{2}}\\left(\\frac{2v^{2}}{v_{th}^{2}}\\nu_{d}\\left(1+\\xi^{2}\\right)+\\nu_{s}\\left(1-\\xi^{2}\\right)\\right)h_{k}+\\nu_{e } v^{2 } j_{0}(a ) f_{0 } \\frac{\\int d^{3}v \\ \\nu_{e } v^{2 } j_{0}(a ) h_{k}}{\\int d^{3}v \\ \\nu_{e } v^{4 } f_{0}}\\\\ & + \\nu_{d}f_{0}\\big(j_{0}(a)v_{{\\parallel } } \\frac{\\int d^{3}v \\",
    "\\nu_{d}v_{{\\parallel}}j_{0}(a)h_{{\\mathbf{k}}}}{\\int d^{3}v \\ \\nu_{d}v_{{\\parallel}}^{2}f_{0 } }   + j_{1}(a)v_{\\perp}\\frac{\\int d^{3}v \\",
    "\\nu_{d}v_{\\perp}j_{1}(a)h_{{\\mathbf{k}}}}{\\int d^{3}v \\ \\nu_{d}v_{{\\parallel}}^{2}f_{0}}\\big)\\\\ & -\\delta \\nu f_{0}\\big(j_{0}(a)v_{{\\parallel } } \\frac{\\int d^{3}v \\",
    "\\delta \\nu v_{{\\parallel}}j_{0}(a)h_{{\\mathbf{k}}}}{\\int d^{3}v \\",
    "\\delta \\nu v_{{\\parallel}}^{2}f_{0 } }   + j_{1}(a)v_{\\perp}\\frac{\\int d^{3}v \\",
    "\\delta \\nu v_{\\perp}j_{1}(a)h_{{\\mathbf{k}}}}{\\int d^{3}v \\",
    "\\delta \\nu v_{{\\parallel}}^{2}f_{0}}\\big ) \\end{split } \\label{gyroc}\\ ] ] where @xmath101 is the perpendicular wavenumber , @xmath102 , @xmath103 , and @xmath104 - \\frac{4xe^{-x^{2}}}{\\sqrt{\\pi}}\\right).\\ ] ] details on numerical implementation of the collision operator ( [ gyroc ] ) can be found in ref .  .",
    "numerical dissipation enters in ` gs2 ` through two mechanisms .",
    "the first is the optional decentering of spatial and temporal finite differences , as described in ref .  .",
    "the lowest order contribution to dissipation due to decentering in time and space is @xmath105 -{\\frac{\\partial ^{2}{\\left<}\\chi{\\right>}_{{\\mathbf{r}}}}{\\partial t \\partial \\theta}}\\left[\\delta \\theta \\left(\\delta - \\frac{1}{2}\\right)\\frac{qf_{0}}{t}\\right],\\end{aligned}\\ ] ] where @xmath106 is the grid spacing along the field line , @xmath107 is the time step size , @xmath108 is a parameter that allows for spatial upwinding ( when @xmath109 ) , and @xmath99 is a parameter that allows for the variation of the time discretization between fully explicit ( @xmath110 ) and fully implicit ( @xmath111 )  , but we choose to use @xmath99 here for simplicity . ] .    in order to see how this term leads to dissipation",
    ", we consider the simplified system governed by the equation @xmath112 finite differencing this equation using the scheme given in ref .  , we find that numerically we are solving the equation @xmath113.\\ ] ] assuming @xmath114 , we obtain the solution @xmath115 , \\label{eqn : numdiss}\\ ] ] which is damped unless @xmath116 , as show in fig .  [",
    "fig : numdiss ] .",
    "while decentering of finite differences can sometimes improve numerical stability , care must be taken to ensure such artificial dissipation does not lead to unphysical behavior .",
    "this is typically done by monitoring the ratio of artificial to physical dissipation , which , ideally , should be small .",
    "( [ eqn : numdiss ] ) ] as a result of decentered finite differences in space and time . here",
    ", we are considering @xmath117 , and @xmath118 ( fully implicit , upwind).,height=480 ]    the second source of numerical dissipation arises in systems with sheared magentic fields due to the necessity of a twist - and - shift parallel boundary condition  @xcite .",
    "this non - periodic boundary condition couples modes at opposite ends of the simulation domain along the field line . since",
    "only a finite number of modes can be kept in a simulation , some modes will eventually couple to modes that are not present , and this information is lost .",
    "the information that is lost is replaced by a smoothed distribution function , which should be associated with an increase in the entropy of the system .",
    "this entropy generation should be diagnosed in order to verify that it is small compared to the entropy generated by collisions .",
    "there are numerous ways in which one could try to determine whether or not a particular simulation is well - resolved in velocity space .",
    "ideally , one would perform a grid convergence study for each simulation ; if quantities of interest are unchanged by doubling the number of grid points , one can feel relatively confident in the simulation results . however , this process is computationally expensive , as it involves running a simulation multiple times with an excessive number of grid points .",
    "consequently , it is not desirable to perform a grid convergence study for every simulation . in practice , one tests convergence for a problem thought to be resolution intensive and posits that other simulations , which likely require fewer grid points , are therefore resolved .",
    "unfortunately , one seldom knows in advance how fine the structure in velocity space will become , so one ca nt be fully confident that every simulation is resolved .",
    "an alternative approach that has recently gained popularity in the computational plasma physics community involves monitoring entropy balance in the system  @xcite .",
    "the entropy balance relation arises from multiplying the gyrokinetic equation ( [ eqn : gke ] ) by @xmath119 and integrating over all phase space.since the gyrokinetic equation itself is automatically satisfied by a gyrokinetic solver , the only possible sources of inbalance in this relation come from numerical dissipation and errors in the numerical approximations to phase space integrals .",
    "if the change in entropy due to numerical dissipation is also diagnosed and included in the entropy balance , as is often the case , then we are left with errors due only to phase space integration .",
    "since the errors in these particular integrals are not directly related to errors in the calculation of the distribution function at the newest timestep , they do not necessarily correlate with the simulation resolution .",
    "in particular , one could easily define a poorly - resolved system for which this diagnostic predicts perfect entropy balance .",
    "one such example is the linear , collisionless ion acoustic wave in a slab ( treated in detail in appendix a ) . for this case , we numerically find entropy balance despite the fact that the numerical damping rate goes bad due to poor resolution in velocity space .    of course , one could simply produce plots or movies of the distribution function in velocity space over the course of the simulation to see if structure develops at the gridscale .",
    "this is undoubtedly useful and possibly sufficient in some cases .",
    "however , what exactly one sees depends on how the data is visualized ; for data on irregularly spaced grids , the interpolation scheme used to generate the images often introduces erroneous or misleading structure .",
    "furthermore , for simulations involving non - trivial spatial structure , one would have to examine movies of the distribution function at each point in physical space .",
    "this is a memory- and time - intensive approach that is rarely feasible .",
    "we would like to have computationally cheap diagnostics that provide real - time information on velocity space resolution that is easy to analyze and interpret . in the following subsections , we present two such diagnostics developed for implementation in ` gs2 ` that could easily be adapted for use in other continuum kinetic simulations .",
    "upon consideration of the collisionless gyrokinetic - maxwell s system of equations , one finds that the only nontrivial operation in velocity space is integration , which enters in the calculation of the electromagnetic fields .",
    "consequently , resolution in velocity space is limited only by the accuracy with which the velocity space integrals are calculated . by calculating the error in our numerical integration , we are thus able to monitor velocity space resolution .",
    "in particular , when we discretize the gyrokinetic equation , we obtain an equation of the form @xmath120 , \\label{eqn : gnew}\\ ] ] where @xmath121 is the perturbed , guiding center distribution function evolved by ` gs2 ` , @xmath122 is the electrostatic potential , @xmath123 is the generalized electromagnetic potential defined in eqn .",
    "( [ eqn : chi ] ) , @xmath68 is a function that depends on the details of the numerical scheme , and the subscript denotes the timestep .",
    "we assume that the time - converged solution for @xmath124 is independent of the initial condition .",
    "since using the calculated @xmath125 and @xmath126 is equivalent to specifying a new initial condition , we find that the time - converged solution is independent of errors in @xmath124 and @xmath122 at earlier timesteps .",
    "this is convenient because it means we can monitor resolution merely by calculating the error made in the latest timesteps of a time - converged simulation .",
    "ideally , we would accomplish this by calculating estimates for the error in @xmath127 and @xmath128 and plugging these into eqn .",
    "( [ eqn : gnew ] ) to obtain an error estimate for @xmath129 .",
    "this might be feasible for linear systems , but the presence of nonlinear terms makes this approach computationally prohibitive .",
    "consequently , we must define an alternative quantity whose error estimate is cheaper to compute , but that can still be used as a means of monitoring velocity space resolution .",
    "there are numerous possible candidates ; we choose to compute two quantities , @xmath130 and @xmath131 , related to @xmath132 and @xmath133 : @xmath134 where @xmath135 and @xmath136 are the wavenumbers corresponding to the coordinates @xmath137 and @xmath138  @xcite . here , @xmath139 is the poloidal flux , @xmath98 is the field line label , @xmath140 is the background magnetic field at the magnetic axis , @xmath141 is the distance from the magnetic axis to the center of the simulation domain , and @xmath142 is the safety factor on the field line of interest , labeled by @xmath143 .",
    "the quantities in eqn .",
    "( [ eqn : errquant ] ) were chosen because , with the exceptions of the parallel convection term and one source term , @xmath122 and @xmath144 always enter the gyrokinetic equation for @xmath124 multiplied by either @xmath135 or @xmath136 .",
    "therefore , it is reasonable that this @xmath101-weighted quantity is most likely to be responsible for errors in @xmath129 . although not considered here , the expression ( [ eqn : errquant ] ) could potentially be improved by including @xmath145 in the max operator .",
    "this would take into account the effect of the parallel convection term .",
    "however , recent theoretical  @xcite and numerical  @xcite work suggests that velocity space structure may be generated primarily by nonlinear perpendicular phase mixing ( instead of linear , parallel phase mixing ) .",
    "having chosen appropriate indicators of velocity space resolution , we must devise a method for estimating the error in these quantities .",
    "this error depends on the particular numerical integration scheme used . for the energy and",
    "untrapped @xmath80 integrals , which use gaussian quadrature , the error , @xmath146 , is given by @xmath147 where @xmath148 is the integrand , @xmath149 is the number of grid points , and @xmath150 is some unknown point in the interval of integration . the quantity @xmath151 is @xmath152^{3 } } \\label{eqn : gaussleg}\\ ] ] for the untrapped @xmath80 and finite domain energy integrals that use gauss - legendre quadrature and @xmath153 for the semi - infinite domain energy integral that uses gauss - laguerre quadrature .",
    "the error , @xmath154 , for the trapped @xmath80 integrals , which use a newly upgraded integration scheme based on lagrange interpolating polynomials ( see e.g. ref .  ) , is given by @xmath155 where @xmath156 with @xmath157 the @xmath158 grid point .",
    "it should be noted that @xmath150 in eqn ( [ eqn : lagrange ] ) is an unknown function of @xmath159 whose domain is some subset of the interval of integration .    from eqns ( [ eqn : gauss ] ) and",
    "( [ eqn : lagrange ] ) , we see that gaussian quadrature gives exact results for polynomials of degree less than @xmath160 , while the lagrangian method gives exact results only for polynomials of degree less than @xmath149 .",
    "we say that the two schemes have degrees of precision @xmath161 and @xmath162 , respectively .",
    "this difference arises because the grid points in the lagrangian method are fixed by boundary conditions , whereas the grid points in gaussian quadrature are free parameters optimally chosen to improve the scheme s degree of precision .",
    "unfortunately , the formal error expressions ( @xmath163 ) and ( [ eqn : lagrange ] ) are not very useful in practice : they require information about high - order derivatives of the distribution function , which is unavailable . as an alternative estimate for the error ,",
    "we choose to compare multiple integral approximations computed with different degrees of precision , a common technique in numerical analysis  @xcite .      given the value of a function @xmath164 at @xmath43 fixed points on the interval @xmath165 $ ] , we would like to find two different approximations to the integral @xmath166 . in our earlier discussion",
    ", we stated that an approximation with degree of precision @xmath167 can be found using a technique based on lagrange interpolation ; we call this approximation @xmath168 .",
    "if we instead choose to use only @xmath169 of the given functional values ( @xmath170 ) , we can use the same technique to find another integral approximation , @xmath171 , with degree of precision @xmath172 .",
    "an estimate for the absolute error @xmath173 in the less accurate of these two approximations is obtained by taking the difference between the two : @xmath174 making the reasonable assumption that the approximation with higher degree of precision is more accurate , @xmath173 represents the error in @xmath171 .",
    "however , it can also be used as a more conservative error estimate for @xmath168 .",
    "if the @xmath43 points are chosen according to gaussian quadrature rules , then one can find an integral approximation with degree of precision @xmath175 .",
    "as before , a second approximation can be obtained by using only @xmath169 of the @xmath43 grid points .",
    "however , due to the uniqueness of the grid points used for gaussian quadrature , the @xmath169-point grid no longer satisfies gaussian quadrature rules .",
    "as a result , this second approximation once again has degree of precision @xmath172 .",
    "since the degrees of precision of the two approximations differ by greater than a factor of two , the resulting error estimate is likely to be very conservative when applied to @xmath168 .",
    "the factor of approximately two difference in degree of precision makes this error estimate similar to that obtained by comparing results from runs with @xmath43 and @xmath176 grid points , respectively ( for which the degrees of precision would be @xmath175 and @xmath167 ) .",
    "the conservative nature of the error estimate for @xmath168 depends upon our assumption that a higher degree of precision results in a more accurate integral approximation . for gaussian quadrature , it can be shown that the error in the integral approximation can be made arbitrarily small by choosing the degree of precision large enough  @xcite .",
    "the same result does not necessarily hold for the lagrangian method with arbitrary grid spacing because the weights in this case are not all guaranteed to be positive .",
    "however , the error @xmath177 in an @xmath169-point integral approximation satisfies @xmath178 where @xmath179 can be chosen arbitrarily small for large enough @xmath169 , and @xmath180 is the weight corresponding to the @xmath158 grid point out of @xmath169 . from this result",
    ", we see that as long as @xmath181 is bounded when @xmath182 , then @xmath183 as @xmath184 .",
    "this can not be verified in advance , but one can gain confidence by checking a posteriori . in practice , we calculate @xmath181 for the chosen @xmath169 and subdivide the integration domain into subintervals with fewer points if @xmath181 is larger than some reasonable value .      in ` gs2 `",
    ", we must compute two - dimensional integrals over energy and @xmath80 . as stated in sec .",
    "iii , each of these integrals is effectively separated into two by splitting the @xmath80 integration into trapped and untrapped regions .",
    "since the number of grid points in energy and both @xmath80 regions can be varied independently of each other , we wish to monitor resolution in each of these three variables individually .",
    "this entails computing three separate integral error estimates : one for energy integrals , one for untrapped @xmath80 integrals , and one for trapped @xmath80 integrals .",
    "these integral error estimates are calculated using the technique described in the previous subsection . for energy and",
    "untrapped @xmath80 integrals , gaussian quadrature is used to obtain the two - dimensional integral approximation @xmath168 .",
    "this approximation has degree of precision @xmath185 for the energy integration and @xmath186 for the untrapped @xmath80 integration , where @xmath187 and @xmath188 are the number of energy and untrapped @xmath80 grid points , respectively . to obtain the second approximation , @xmath171 , we fix the grid and weights for one variable and",
    "drop one grid point for the other variable , recomputing the weights .",
    "as an example , we choose to drop an untrapped @xmath80 grid point .",
    "the degree of precision for @xmath171 is then @xmath185 for the energy integration and @xmath189 for the untrapped @xmath80 integration .",
    "since there is nothing special about the particular grid point we drop , we repeat the process a total of @xmath188 times , each time dropping a different point and computing a different set of weights . the final error estimate is an average of these error estimates .    for the trapped @xmath80 integrals ,",
    "lagrangian quadrature is used to obtain @xmath168 , which has degree of precision @xmath190 .",
    "we obtain the approximation @xmath171 by dropping two points symmetrically about @xmath191 , as shown in fig .",
    "[ fig : gs2v ] .",
    "we drop an additional point here because it provides a slightly more conservative error estimate and because maintaining the symmetry of the grid points provides better stability for the weights associated with the lagrange interpolation scheme .",
    "as before , we repeat this process for each possible grid point pair and take the average of the individual error estimates to get the final error estimate .",
    "all modified grids and weights necessary for the integral error estimates are computed once at initialization and need not be computed again .",
    "the additional integrations necessary to obtain our error estimates are computationally cheap when compared to the expense of solving for the distribution function and fields at each time step .",
    "furthermore , we do not need an error estimate at each time step , so the diagnostic can be used sparingly . consequently ,",
    "our error estimate comes at essentially no extra cost .",
    "an alternative method for testing v - space resolution is to expand the velocity space distribution function in an appropriate basis set and monitor the amplitude of the basis function coefficients .",
    "whenever the highest mode number coefficients that can be accurately calculated in the simulation acquire appreciable amplitudes , we can no longer feel confident that the simulation is resolved . since we choose our grid points according to gauss - legendre quadrature , it is convenient ( and most accurate ) to choose the legendre polynomials as our basis functions .",
    "the coefficient of the @xmath192 legendre polynomial in the expansion of @xmath193 is given by @xmath194 where @xmath195 is the @xmath192 legendre polynomial , and @xmath196 are the weights associated with gauss - legendre quadrature .",
    "the integral approximation in eqn .",
    "( [ eqn : cm ] ) has degree of precision @xmath175 .",
    "assuming @xmath193 has a degree of at least @xmath149 ( otherwise @xmath197 ) , our approximation for @xmath198 is only exact for @xmath199 .",
    "there are various ways in which one could use these @xmath200 to estimate the error in velocity space resolution .",
    "we assume locality of interaction between the various modes so that we only have to monitor the amplitudes of the few highest modes . at each ( @xmath86 , @xmath135 , @xmath136)-point",
    ", we find the maximum amplitude of the three highest mode number spectral coefficients , @xmath201 , and the maximum amplitude of all the spectral coefficients , @xmath202 .",
    "we then use the following normalized sum as a relative estimate for the error : @xmath203 when the normalized amplitude @xmath204 grows too large , we can no longer be confident that the simulation is resolved .",
    "of course , how large @xmath204 can get before resolution suffers varies from problem to problem . as before with the integral method , we determine a scaled estimate of the error based on empirical evidence from a wide range of simulation data .",
    "we have applied both the integral and spectral error diagnostics to a diverse set of simulations , including : linearly growing modes such as the electron drift wave and the itg mode ; linearly damped modes such as the ion acoustic wave and kinetic alfven wave ; neoclassical transport ; and nonlinear dynamics of slab etg and toroidal itg modes . from these simulations , we have determined empirical scaling factors for our conservative error estimates . here , we present typical results from a cross - section of the above simulations .     ( right ) .",
    "the actual wave frequency , @xmath26 , is determined from a higher resolution run with 64 grid points in energy and both trapped and untrapped @xmath80 .",
    "the actual relative error , @xmath179 , is then defined to be @xmath205 , where @xmath206 is the approximation to @xmath26 obtained from a run with @xmath207 grid points.,title=\"fig:\",height=288 ]   ( right ) . the actual wave frequency , @xmath26 ,",
    "is determined from a higher resolution run with 64 grid points in energy and both trapped and untrapped @xmath80 .",
    "the actual relative error , @xmath179 , is then defined to be @xmath205 , where @xmath206 is the approximation to @xmath26 obtained from a run with @xmath207 grid points.,title=\"fig:\",height=288 ]    fig .",
    "[ fig : lincycerr ] compares the unscaled error estimates in energy and @xmath80 with the actual errors in growth rate as we vary the number of grid points in a linear simulation of the collisionless toroidal itg mode ( using cyclone base case parameters  @xcite ) .",
    "the simulation remains well - resolved down to very few grid points , and the error estimates agree well with the actual error .",
    "the error due to resolution in untrapped @xmath80 is still small for as little as four grid points due to our choice of velocity variables , as illustrated by the snapshot of the distribution function shown in fig .",
    "[ fig : lincycdist ] .    , for the linear , toroidal itg mode with cyclone base - case parameters .",
    "the use of a polar grid in velocity space , as well as the fine mesh near the trapped - passing boundary , minimizes the number of grid points necessary for resolution.,height=480 ]    figs .",
    "[ fig : kawdamp ] and  [ fig : kawerr ] show the damping of @xmath144 and the corresponding scaled error estimates for the simulation of a collisionless kinetic alfven wave with 16 energy grid points and 32 pitch angles for each sign of the parallel velocity . the collisionless damping rate in fig .",
    "[ fig : kawdamp ] agrees with theory until sub - gridscale structure develops in velocity space , at which point damping ceases .",
    "the onset of sub - gridscale structure corresponds to the peak in scaled error in fig .",
    "[ fig : kawerr ] .",
    "the addition of a small collisionality prevents sub - gridscale structure , as shown in fig .  [ fig : kawdamp ] , where the damping rate of @xmath144 agrees well with theory indefinitely .",
    "this is accurately predicted by the error estimates of fig .",
    "[ fig : kawerrcoll ] , which never reach appreciable magnitude .    .",
    "in the absence of collisions ( left ) , sub - grid scale structures develop in velocity space , and the damping is artificially terminated . a small collisionality ( @xmath208 )",
    "prevents the development of sub - grid scale structures in velocity space , and the damping rate remains correct indefinitely ( right).,title=\"fig:\",height=288 ] . in the absence of collisions ( left ) ,",
    "sub - grid scale structures develop in velocity space , and the damping is artificially terminated . a small collisionality ( @xmath208 )",
    "prevents the development of sub - grid scale structures in velocity space , and the damping rate remains correct indefinitely ( right).,title=\"fig:\",height=288 ]",
    "as stated earlier , we would like to know what combination of dissipation and grid spacing is necessary for a resolved simulation .",
    "one way to approach this problem is to fix the dissipation and vary the number of grid points to find how many are required to get an accurate result .",
    "this is the general idea behind the error estimation diagnostics described in the previous section .",
    "however , if we wanted to use this approach to ensure that the simulation remained resolved , we would have to implement an adaptive grid , which is difficult to do on massive , multi - processor machines .",
    "instead , we choose an alternative approach : we fix the number of grid points and vary the dissipation until we have a well - resolved result .",
    "in particular , we have implemented an adaptive collision frequency in ` gs2 ` that allows for the independent variation of the collisionality associated with pitch - angle scattering and energy diffusion .",
    "given an acceptable error tolerance for velocity space calculations , a scaled version of the integral error estimate described in the previous section is used to determine whether or not the simulation is well - resolved .",
    "the collision frequency is then adjusted using a feedback process until the scaled estimate of the error converges to within some pre - specified window of the desired error tolerance . in this way ,",
    "the approximate minimum possible dissipation is used to achieve an acceptable degree of resolution in velocity space .",
    "of course , the amount of dissipation necessary to resolve a simulation at a fixed number of grid points may be quite large if a coarse grid is used .",
    "consequently , the collisionless dynamics may be modified . as a result",
    ", it is necessary to compare the converged collision frequency with dynamic frequencies of interest in the problem .    as an example we consider a nonlinear simulation of electron temperature gradient ( etg ) turbulence in slab geometry ( i.e. straight background magnetic field ) . in the nonlinear phase",
    ", small scales are expected to develop in velocity space , potentially challenging numerical resolution . in fig .",
    "[ fig : adaptetg ] , we see that this is indeed the case .",
    "our velocity space resolution diagnostics indicate that the errors in velocity space begin to increase sharply during the transition from linear instability to turbulence .",
    "however , our use of an adaptive collision frequency prevents the estimated error from exceeding the user - defined relative error tolerance ( in this case , @xmath209 ) .",
    "we see that the error remains on the threshold of the error tolerance , while the collision frequency for energy diffusion increases to a steady - state value of @xmath210 , which is well below the dynamic frequency in the system",
    ". consequently , the collisionless dynamics are unaltered .",
    "resolution increase during nonlinear saturation , but are kept within the specified relative error tolerance of @xmath209 with the use of an adaptive collision frequency .",
    "( right ) : collision frequency ( normalized by @xmath211 ) vs. time.,title=\"fig:\",height=288 ]   resolution increase during nonlinear saturation , but are kept within the specified relative error tolerance of @xmath209 with the use of an adaptive collision frequency .",
    "( right ) : collision frequency ( normalized by @xmath211 ) vs. time.,title=\"fig:\",height=288 ]",
    "in this paper , we discussed the development of small - scale structure in velocity space , presented a set of velocity space resolution diagnostics for use in gyrokinetic simulations , and introduced an adaptive collisionality that allows us to resolve simulations with an approximate minimal necessary dissipation for a fixed number of grid points in velocity space . in sec .",
    "[ sec : gkv ] we demonstrated the tendency of collisionless plasmas to develop increasingly fine scales in the distribution of particle velocities and discussed the phase mixing processes that lead to such behavior .    in sec .",
    "[ sec : gs2v ] we described the treatment of velocity space in the gyrokinetic code ` gs2 ` .",
    "we gave details on the choice of velocity space variables ( energy and pitch - angle ) and discretization scheme , which is chosen to minimize the error of the numerical integrals necessary to obtain the electromagnetic fields .",
    "this included presentation of a newly implemented energy grid , which provides spectrally accurate integrals over particle energies .",
    "additionally , we gave a brief discussion of both the physical and numerical dissipation mechanisms available for use in ` gs2 ` .",
    "we discussed common approaches to monitoring velocity space resolution in sec .",
    "[ sec : vresdiag ] and the difficulties associated with each .",
    "we then proposed two new measures of velocity space resolution and detailed implementation in ` gs2 ` .",
    "one of the proposed resolution diagnostics involves obtaining estimates for the error in field integrals by comparing numerical integrals obtained using integration schemes with differing degrees of precision .",
    "the other resolution diagnostic involves decomposing the perturbed distribution function into spectral components in velocity space and monitoring the amplitude of the spectral coefficients .",
    "both diagnostics should be quite conservative .",
    "we then applied our resolution diagnostics to a number of example problems , including landau damping of the ion acoustic wave , barnes damping of the kinetic alfven wave , and linear instability of the toroidal itg mode .",
    "we found that both diagnostics do well in qualitatively estimating errors due to limited velocity space resolution .",
    "due to their conservative nature , an empirical scaling factor was necessary to obtain correct quantitative predictions .    in sec .",
    "[ sec : adaptc ] we coupled the error estimates from our resolution diagnostics with a model physical collision operator to develop an adaptive collision frequency .",
    "this adaptive collision frequency allowed us to resolve velocity space while using an approximate minimal necessary amount of dissipation . when using the adaptive collision frequency",
    ", one must monitor the ratio of the collision frequency to the dynamic frequency to ensure that one is still within the weakly collisional regime .    in conclusion",
    ", we found that dissipation was not necessary to resolve linear instabilities , but it was necessary to resolve nonlinear dynamics and linearly damped waves .",
    "for the nonlinear cases considered here ( slab etg and toroidal itg ) , the required collisionality for resolution obtained with the adaptive collision frequency was found to be no larger than the physical collisionality used in modern fusion experiments .",
    "we consider the collisionless ion acoustic wave in slab geometry with adiabatic electrons .",
    "the gyrokinetic equation for this system has the particularly simple form @xmath212 changing variables from @xmath193 to @xmath121 and assuming solutions of the form @xmath213 we obtain @xmath214 where we are using @xmath215 and @xmath216 for convenience .",
    "neglecting flr effects and assuming quasineutrality gives @xmath217 defining @xmath218 and integrating over the perpendicular velocities in the gyrokinetic equation yields @xmath219 where @xmath220 following the analysis of refs .   and  , we see that this equation has solutions of the form @xmath221 , \\label{g}\\end{aligned}\\ ] ] with @xmath222 , provided that @xmath223 is chosen to satisfy the condition @xmath224 a general solution is given in the form @xmath225 where @xmath226 is determined by the initial condtion @xmath227      we now have two equations , ( [ lamcon ] ) and ( [ ccon ] ) , for two unknowns ( @xmath223 and @xmath232 ) . in order to solve this linear system , it is convenient to define some new notation .",
    "any square integrable function @xmath233 can be written @xmath234 we define the positive and negative frequency parts of @xmath233 as @xmath235 so that @xmath236 .",
    "further we define the function @xmath237 .",
    "it can be shown that @xmath238 has the alternate form @xmath239 with these definitions in hand , we rewrite eqns ( [ lamcon ] ) and ( [ ccon ] ) as @xmath240 eliminating @xmath223 gives an expression involving @xmath241 and @xmath242 : @xmath243 the transform @xmath244 can also be broken down into negative and positive frequency parts to give two separate equations .",
    "@xmath245 these can then be used to construct @xmath226 : @xmath246    substituting the expressions @xmath247 and @xmath248 for @xmath230 and @xmath232 into the equation ( [ gensol ] ) for @xmath249 gives @xmath250f(v)\\\\ & \\times \\left[\\mathcal{p}\\frac{1}{u - v } + \\lambda(k , u)\\delta(u - v)\\right]e^{ik\\left(z - ut\\right)}dk \\ du .",
    "\\label{f1 } \\end{split}\\ ] ] we can use the identity @xmath251 to rewrite eqn ( [ f1 ] ) in the more convenient form @xmath252\\frac{\\overline{f}(z',v',0)}{2\\pi}f(v)\\\\ & \\times\\left[\\mathcal{p}\\frac{1}{u - v } + \\lambda(k , u)\\delta(u - v)\\right]e^{ik\\left(z - z'-ut\\right)}dz ' dv ' dk \\ du .",
    "\\end{split}\\ ] ] now we pick an initial condition of the form @xmath253 which gives @xmath254"
  ],
  "abstract_text": [
    "<S> many plasmas of interest to the astrophysical and fusion communities are weakly collisional . in such plasmas </S>",
    "<S> , small scales can develop in the distribution of particle velocities , potentially affecting observable quantities such as turbulent fluxes . </S>",
    "<S> consequently , it is necessary to monitor velocity space resolution in gyrokinetic simulations . in this paper </S>",
    "<S> , we present a set of computationally efficient diagnostics for measuring velocity space resolution in gyrokinetic simulations and apply them to a range of plasma physics phenomena using the continuum gyrokinetic code ` gs2 ` . for the cases considered here </S>",
    "<S> , it is found that the use of a collisionality at or below experimental values allows for the resolution of plasma dynamics with relatively few velocity space grid points . </S>",
    "<S> additionally , we describe implementation of an adaptive collision frequency which can be used to improve velocity space resolution in the collisionless regime , where results are expected to be independent of collision frequency . </S>"
  ]
}