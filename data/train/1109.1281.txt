{
  "article_text": [
    "current theories of galaxy formation are based on the view that the dominant mass contribution to the universe is in the form of cold dark matter ( dm ) , which clusters under gravity and builds up the backbone of all cosmic structure . together with the discovery of a large dark energy ( de ) component @xcite , this led to the emergence of the concordance @xmath0 cold dark matter ( @xmath0cdm ) cosmogony .",
    "the third component to the energy density in this scenario , the baryons , condense via radiative cooling at the centres of a population of hierarchically merging dm haloes , forming galaxies @xcite .",
    "although the precise physical nature of dm and de is not yet known ( but see * ? ? ?",
    "* for a review of possible dm candidates ) , large - scale predictions of this @xmath0cdm theory show good agreement with a wide range of observations , among them cosmic microwave background ( cmb ) fluctuations @xcite , large - scale clustering of galaxies in the low - redshift universe @xcite , and the redshift @xmath1 power spectrum probed by the lyman-@xmath2 forest @xcite .",
    "it is however crucial to further constrain and test the @xmath0cdm paradigm , especially on the smaller scales of galaxies , which remains a theoretical and observational frontier .",
    "structure formation is a highly non - linear process and only the early stages can be described analytically using linear theory . however , some statistical properties of the evolved dm field , in particular the halo mass function , can also be predicted analytically by combining linear theory and spherical collapse models , through the press - schechter formalism @xcite and subsequent extensions ( e.g. * ? ? ?",
    "these predictions ultimately rely on calibration through more accurate calculations , which typically can only be done numerically .",
    "indeed , while press - schechter theory has been quite successful in describing the abundances of haloes , once computer models reached high precision it became clear that the original analytic treatment was not sufficiently accurate for the quantitative work required in today s era of precision cosmology ( e.g. * ? ? ? * ) .",
    "over the last two decades , numerical simulations have played a key role in guiding our knowledge of structure and galaxy formation .",
    "this is especially evident for the cdm component , where the relevant calculations have reached a high level of sophistication ( e.g. * ? ? ?",
    "* ; * ? ? ?",
    "? * ; * ? ? ?",
    "* ; * ? ? ?",
    "many important insights have been gained from purely collisionless simulations , for example the nearly universal density profiles of dm haloes @xcite , assembly bias @xcite , and the internal structure of haloes on small scales @xcite .",
    "an important reason for today s reliability of cdm predictions is that the initial conditions are unambiguously specified in the @xmath0cdm model , with parameters that are tightly constrained by cmb observations @xcite .",
    "moreover , the computational problem is well - posed and comparatively simple , with equations of motion that for dm involve only gravity .",
    "efficient new algorithms and the rapid growth of computing power over the few last decades have allowed ever more detailed theoretical predictions for the dm distribution .",
    "it is worthwhile , however , to recall that initially such collisionless dm simulations suffered from numerical artifacts , leading to issues like the infamous `` over - merging problem '' , which resulted in featureless and smooth dm haloes primarily due to insufficient mass- , force- and time - resolution @xcite .    to understand properties of the observable universe one needs to relate the dark matter distribution to that of the baryonic material",
    "this can be done in a number of different ways : ( i ) using so - called semi - analytical modelling of galaxy formation ( e.g. * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "* ) or the closely related approach of halo occupation distributions @xcite , or ( ii ) using direct hydrodynamical simulations ( e.g * ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "* ) . approach ( i ) allows a fast exploration of a large parameter space of the underlying coarse description of galaxy formation physics , whereas ( ii ) makes possible the calculation of a self - consistent model that requires far fewer assumptions about the gas dynamics .",
    "nevertheless , both methods share the common problem that complicated physics on very small scales , like star formation and associated feedback processes , need to be accounted for in a rather crude way .",
    "this propagates into uncertainties in the interpretation of simulation results for the hydrodynamic sector .",
    "one possible strategy to get better control over this problem is to calibrate sub - resolution treatments in semi - analytic models and hydrodynamical simulations observationally ( e.g. * ? ? ?",
    "* ; * ? ? ?",
    "in addition , numerical artifacts in hydrodynamical simulation techniques need to be better understood , hopefully allowing one to reduce or completely eliminate them .",
    "state - of - the - art cosmological hydrodynamical simulations include a prescription for star formation ( e.g. * ? ? ?",
    "* ) , radiative cooling @xcite , chemical enrichment ( e.g. * ? ? ?",
    "* ) and various feedback processes relevant for low- and high - mass systems ( e.g. * ? ? ?",
    "* ; * ? ? ?",
    "furthermore , some simulation codes can also include magnetic fields @xcite , radiative transfer @xcite , cosmic ray physics , thermal conduction @xcite , or black hole physics @xcite .",
    "hydrodynamical simulations have been successfully used to study the lyman-@xmath2-forest ( e.g. * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "* ) and the detailed physics of the intracluster medium , where cluster scaling relations were obtained that agreed with x - ray observations @xcite .",
    "there have also been numerous studies that focused on the formation of a representative galaxy population ( e.g. * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "while some successes have been achieved here as well , a general finding of these simulations is that it appears to be difficult to reproduce the observed shallow slope of the faint - end of the galaxy luminosity function and the observed morphological mix of galaxies , with its high abundance of disk - like galaxies .",
    "although there has been some considerable progress over the last few years on the latter issue ( e.g. * ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "* ) , one of the outstanding problems is to produce a statistical sample of galaxies that agrees reasonably well with observations and reproduces the hubble sequence .",
    "but modifications in the detailed feedback and star formation prescriptions proved to be important and successful in forming more realistic late type spiral galaxies .",
    "we note that cosmological hydrodynamic simulations have also made it clear that a proper inclusion of the baryonic physics can lead to interesting back reactions on the dm distribution @xcite , potentially eliminating or reducing the central dark matter cusp @xcite , or forming a dark disk @xcite .",
    "it is hence clear that it is ultimately not sufficient to work with dark - matter only simulations .",
    "most hydrodynamical simulations of galaxy formation carried out thus far have used the smoothed particle hydrodynamics ( sph ) technique , where the gas is discretised into a set of particles for which appropriate equations of motion can be derived .",
    "the sph method is well - suited for cosmological applications owing to its pseudo - lagrangian character , which automatically brings resolution elements to regions where they are needed most , i.e.  collapsing objects like clusters and galaxies .",
    "also , the conservation properties of sph in terms of simultaneous conservation of energy , momentum , mass , entropy and angular momentum are excellent .",
    "a further convenient feature is that a particle - based gravity solver ( needed for the dm component anyway ) can be readily applied to sph .",
    "these properties have made the method also popular for applications other than cosmic structure growth , for example for isolated merger simulations .    however",
    ", different methods for solving the equations of hydrodynamics in a cosmological context have been employed as well , most of which are descendants of classic eulerian methods @xcite on regular meshes .",
    "the fixed cartesian grids originally available in the corresponding codes are insufficient to capture the large dynamic ranges encountered in galaxy formation , but finite volume schemes incorporated in modern adaptive mesh refinement ( amr ) codes can alleviate this problem .",
    "interestingly , these mesh - based methods have led in some cases to significantly different results compared with sph .",
    "a prominent example of these discrepancies is highlighted in the santa barbara cluster comparison project @xcite , where it was found that the entropy profiles of clusters are significantly and systematically different between amr and sph codes , the former yielding a large entropy core which is absent in the sph calculations .",
    "only recently has some progress been made in identifying the cause for this difference @xcite , but the issue is still not fully understood ; hence we return to it in one of our companion papers @xcite .",
    "it thus appears that there are at least two important challenges in the field of cosmological hydrodynamics simulations .",
    "one lies in an adequate treatment of all relevant physics of galaxy formation , in particular with respect to the reliability of the parameterisations of sub - resolution physics , and the other having to do with the accuracy and efficiency of the underlying hydrodynamics solver .",
    "it is of course crucial to strive for a more faithful treatment of the physics in the simulations , but it should also be evident that a proper modelling of the physics relies on a correct solution of the basic hydrodynamical equations in the first place .",
    "it is therefore problematic to tune the sub - resolution physics without first verifying in detail the quality of the hydro solver , because this risks incorrectly absorbing deficiencies of a numerical technique into distorted physics models . here",
    ", in this initial study we shall primarily be concerned with an assessment of the extent to which uncertainties in numerical methodology are reflected in the predicted galaxy properties , for a fixed physics model . in future works",
    ", we will explore the consequences of various treatments of feedback effects , which are known to be crucial for the galaxy formation problem @xcite .",
    "we remark that it is not obvious whether sph or amr is more accurate in all simulation regimes , as both methods are known to have shortcomings .",
    "for example , sph suffers from relatively poor shock resolution , noise on the scale of the smoothing kernel , and low - order accuracy for the treatment of contact discontinuities .",
    "furthermore , some hydrodynamic instabilities like the kelvin - helmholtz instability can be suppressed in sph @xcite .",
    "recently , @xcite also showed that conventional implementations of sph do not properly properly subsonic turbulence , which is generically present in cosmological haloes .",
    "astrophysical eulerian methods on the other hand ( usually realised as amr finite - volume schemes ) may suffer from over - mixing due to advection errors in the presence of bulk flows .",
    "one of the principal differences between sph and amr lies in their handling of mixing at the level of individual fluid elements .",
    "this is absent in sph by construction ( unless added in crudely by hand somehow ) , while in amr it occurs implicitly through the averaging of the evolved riemann solutions over the scale of the grid - cells at the end of each timestep .",
    "it is not always clear which scheme yields a more accurate result @xcite .",
    "another issue with classical amr codes is that their handling of the discrete equations of motion can lead to errors with the fluid is moving rapidly across the mesh ( * ? ? ?",
    "* hereafter s10 ) .",
    "because the truncation error of eulerian codes depends on the fluid velocity relative to the grid , the results can thus be sensitive to the presence of bulk velocities ( see also * ? ? ?",
    "* ; * ? ? ?",
    "finally , a further challenge for amr schemes in cosmic structure formation arises from the need to accurately follow the gravitational growth of even very small structures .",
    "the mesh - based poisson solvers typically employed by amr codes have been shown to lack sufficient small - scale force accuracy and to produce too few low mass haloes potentially corrupting the solution on even well - resolved scales .",
    "while this can be addressed with more aggressive refinement strategies , the discontinuous changes in gravity resolution brought about by such refinements introduce non - hamiltonian perturbations into the dark matter dynamics which are in principle undesirable .",
    "recently , s10 introduced a new moving - mesh approach as embodied in the arepo code .",
    "the principal goal is similar to the earlier implementations of @xcite and @xcite , but these moving - mesh algorithms suffered from grid distortions which limited their applicability .",
    "arepo does not use coordinate transformations like previous moving mesh codes in cosmology , but instead employs an unstructured voronoi tessellation of the computational domain .",
    "the mesh - generating points of this tessellation are allowed to move freely , offering significant flexibility for representing the geometry of the flow . as discussed in detail in s10",
    ", this technique avoids several of the weaknesses of sph and amr schemes while it retains their most important advantages .",
    "for example , if the mesh motion is tied to the gas flow , the results are galilean - invariant ( like in sph ) , while at the same time a high accuracy for shocks and contact discontinuities is achieved ( like in eulerian schemes ) .",
    "the aim of this paper is to compare the novel cosmological hydrodynamics code arepo with the widely used sph code gadget @xcite . in this first paper of a series",
    "we give an overview of the numerical techniques used for our galaxy formation simulations , introduce our simulation set , present an analysis of the global baryon characteristics , and evaluate the performance and efficiency of the new simulation scheme . in one companion paper (",
    "* hereafter paper ii ) , we discuss the properties and statistics of individual galaxies and haloes in the simulations . a further companion paper ( * ? ?",
    "* hereafter paper iii ) analyses idealised test problems to highlight various differences of the two simulation schemes and to elucidate how they affect galaxy formation .",
    "the outline of this paper is as follows . in section  2",
    ", we provide a discussion of the initial conditions and numerical details which are particularly important for the goal of our comparison project .",
    "there we also discuss some modifications of the arepo code that were adopted during the course of this work .",
    "section  3 presents first results and discusses the large - scale structure and global statistics of the baryon content in the simulations at different resolutions .",
    "we turn to an analysis of the origin of the cooling difference we find between the codes in section  4 . in section  5",
    "we discuss some generic issues and problems of sph .",
    "finally , we give a summary of our results and our conclusions in section  6 . in an appendix",
    ", we provide data on the mesh geometry , analyse the performance of the codes in different parts of the calculations and present scaling tests .",
    "our gadget and arepo simulations follow the same physics , consisting of a collisionless dark matter fluid and an ideal baryonic gas .",
    "both components act as sources of gravity and are evolved in a newtonian approximation on top of an expanding friedman - lemaitre background model .",
    "we describe the gas dynamics with the ordinary inviscid euler equations , augmented with additional terms that account for `` extra physics '' related to radiative processes and star formation .",
    "in particular , we account for optically thin radiative cooling of a primordial mixture of helium and hydrogen , with a hydrogen mass fraction of @xmath3 .",
    "we also assume a spatially uniform , time - dependent ionising uv background with an amplitude and time evolution according to @xcite .    as a result of cooling",
    ", gas can collapse to high density and turn into stars .",
    "both simulation codes describe this process with the simple star formation and supernova feedback model introduced in @xcite , which has been used in many sph simulations in recent years . in this approach ,",
    "every sufficiently dense gas particle / cell is treated as a representative region of the interstellar medium ( ism ) and is assumed to exhibit a multiphase structure consisting of cold and hot gas in pressure equilibrium .",
    "stars form out of the cold gas and return energy back into the medium though supernova explosions .",
    "this energy feedback pressurises the multiphase medium , the effect of which is described in terms of an effective equation of state that is imposed onto the gas once it has overcome the density threshold for star formation .",
    "the value of the density threshold we use in this work is @xmath4 , set such that isolated disk galaxies at @xmath5 are characterised with a relation between disk surface gas density and star formation density that agrees with the observed kennicutt law @xcite . to reach these densities gas needs to fall into dark matter haloes and dissipate energy via radiative cooling to eventually form galaxies @xcite .",
    "once the gas density is higher than the threshold value , particles / cells are eligible to form stars and can be converted into collisionless stellar particles .",
    "we treat this conversion as a stochastic process that generates one generation of stellar particles per hydrodynamic resolution element ( sph particle or voronoi cell , respectively ) at an average rate equal to the star formation rate predicted by the subresolution multi - phase model .",
    "we stress again that for the purposes of our study it is crucial to have an identical implementation of this extra physics in both codes in order to allow a straightforward comparison of the two hydrodynamical schemes .",
    "fortunately , the quasi - lagrangian nature of arepo typically allows an easy adoption of methods originally developed for particle - based schemes like sph .",
    "we could hence adopt most of the `` extra physics '' implemented in gadget in a largely unmodified form in arepo , helping to ensure that possible implementation differences for this physics do not affect our conclusions .",
    "we also emphasise that in our present context it is preferable to employ a relatively simple subresolution model like that of @xcite in order to facilitate a clear assessment of the differences between hydro solvers . in particular , for now we have not included the effects of strong feedback capable of inducing galactic winds and outflows .",
    "we are thus not attempting to solve the galaxy formation problem at this stage , but are instead concerned with identifying and understanding issues related to the treatment of the hydrodynamics .      in the following two subsections we highlight the most relevant features and parameter settings of the codes we used , as well as any particular changes we made for this project .",
    "we note that full details are presented in substantial depth in the corresponding code papers , so in the interest of brevity we here restrict ourselves only to those aspects directly pertinent to our study .",
    "we are also aided by the fact that the arepo and gadget codes share the same gravity solver , something that was not the case in previous comparison studies of sph and amr ( e.g. * ? ? ?",
    "consequently , the evolution of the collisionless dm component is identical in both codes in the limit of vanishing hydrodynamical forces .",
    "this similar handling of self - gravity is important for isolating differences caused primarily by the hydro solvers .",
    "gadget is a widely used and well - tested sph - code which employs a formulation of sph that simultaneously conserves energy and entropy despite the use of fully adaptive smoothing lengths @xcite .",
    "the gravity calculation is split into short- and long - range components , where short - range forces are calculated with an hierarchical oct - tree algorithm @xcite and the long - range forces are evaluated with a particle mesh ( pm ) method ( e.g. * ? ? ?",
    "our gadget runs are based on a default setting of the numerical sph parameters , using 32 neighbours in smoothed estimates and an artificial viscosity parameter of @xmath6 , combined with balsara s switch @xcite to reduce the viscosity in the presence of strong shear .",
    "arepo is a second - order accurate finite volume method that solves the euler equations using piece - wise linear reconstruction and a calculation of hydrodynamical fluxes at each cell interface with an exact riemann solver .",
    "the basic solution strategy of the code is that of the well - known muscl - hancock scheme .",
    "what makes arepo unusual is that it employs an unstructured mesh based on a voronoi tessellation using a set of mesh - generating points .",
    "furthermore , the mesh is allowed to move freely as a function of time . in our runs",
    ", we tie the motion of the mesh - generating points to the hydrodynamical flow , which gives the scheme a quasi - lagrangian character and makes the mesh automatically adaptive . as s10 demonstrated , such an approach offers a number of advantages compared with ordinary eulerian or lagrangian codes , including a reduction of numerical diffusivity and advection errors and an improved handling of contact discontinuities . in the following ,",
    "we discuss some details and modifications of arepo relevant for our study .    *",
    "( i ) mesh regularisation : * it is desirable to have a voronoi mesh geometry where the geometric centre of each voronoi cell lies reasonably close to the mesh - generating point of that cell .",
    "this reduces the size of errors in the linear reconstruction step of the muscl - hancock scheme and also limits the rate at which mesh faces turn their orientation during the mesh motion .",
    "arepo therefore incorporates a method to regularise the mesh , as described in s10 .",
    "this scheme uses a modified lloyd algorithm to drift the mesh a bit towards its centroidal configuration at each time step . to this",
    "end the motion of the mesh - generating points contains an additional velocity component for certain cells , designed to move a mesh - generating point closer towards the geometric centre of its cell .",
    "the default setup of arepo uses the spatial offset between the actual location of a vertex and its cell s geometric centre in units of the cell s size to decide whether or not this corrective motion should be added to the cell s vertex velocity .",
    "however , a number of test simulations revealed that this regularisation scheme can introduce some unwanted side effects .",
    "specifically , systematic differences in the average mass of gaseous cells can develop between the star - forming gas and the lower density material in the surrounding halo , with the former tending to become systematically more massive than the latter .",
    "that such a tendency exists in principle is to be expected because the lloyd algorithm would ultimately converge to a homogeneous voronoi mesh with cells of equal volume if it applied to every cell centre with full intensity all the time .",
    "the mesh regularisation motions in the default scheme have hence the tendency to move the mesh away from the densest regions ( but leaving the gas there  in arepo , the gas motion and the mesh motion are independent ) , such that the mass per cell will tend to increase in the densest regions .",
    "this is somewhat undesirable because ideally we want to have the highest mass resolution in the central parts of galaxies and not in the surrounding low density gas .",
    "there are at least two solutions to this problem ( besides disabling the regularisation scheme altogether ) .",
    "one is to simply make the settings of the standard regularisation less aggressive , thereby reducing the systematic effects described above .",
    "another possibility is to change the criterion that decides when such a mesh correction motion should be applied .",
    "we have found that the simple criterion originally implemented in arepo , based on the displacement of a mesh - generating point from the geometric centre of its cell , is prone to invoke mesh regularisation drifts even when they are not needed .",
    "this happens especially in regions with strong density gradients , where such displacements naturally occur even if the mesh geometry is acceptable .",
    "as an alternative criterion we have therefore considered the maximum opening angle under which a cell face is seen from the mesh - generating point .",
    "this identifies problematic cell geometries more directly , which are in fact those where a point lies close to a wall , or equivalently , where this opening angle is large .",
    "we find that this opening angle criterion is more tolerant to rapid changes in spatial resolution , and is hence less prone to triggering unwanted mesh - correction motions in the presence of large density gradients .",
    "because of this it virtually eliminates the mass segregation effect mentioned above .    for definiteness , in the simulations presented here , we invoke mesh - regularisation motions if the maximum face angle of a voronoi cell ( defined as the maximum of @xmath7 , where @xmath8 is the area of a face and @xmath9 its distance to the vertex ) is larger than @xmath10 . in this case",
    "we add a velocity component up to half the sound speed of the corresponding cell to the vertex velocity , which moves the mesh - generating point closer towards the geometric centre of the voronoi cell .",
    "ideally , this scheme should then guarantee reasonably regular cells where the bulk of all cells will have a maximum face angle less than @xmath10 .",
    "our tests confirm that this is the case , while at the same time the mass bias between star forming high density cells and the lower density cells in the surrounding halo is significantly reduced .",
    "the face angle scheme applies the mesh - correction motions more rarely than the original approach but still frequently enough to maintain a regular mesh . in the appendix",
    ", we discuss some measurements of the mesh statistics , which also show that this new regularisation scheme still ensures that the offsets between mesh - generating points and the geometric centres of the corresponding cells remain small , as is desired to minimise errors in the linear reconstruction step .    *",
    "( ii ) refinement and de - refinement : * arepo is quasi - lagrangian in the sense that the vertices of the voronoi mesh follow the flow of the fluid such that an approximately constant mass resolution is automatically achieved .",
    "the code is not purely lagrangian , however , because mass can be exchanged between cells in a manner consistent with the equations of motion , in order to prevent the mesh from becoming highly distorted .",
    "moreover , the code can also make use of re- and derefinement of individual cells in order to improve the local resolution beyond that offered by the dynamical motion of the mesh or to improve efficiency when high resolution is no longer required in certain regions .",
    "the method employed by arepo is more general than that used by standard amr methods , which typically employ subgrids to refine a certain section of the parent grid , thereby creating a hierarchy of overlapping grid patches . in arepo , we are not required to use subgrids , but can split or merge individual cells , such that a single global mesh with a smooth transition from low- to high - resolution parts results .",
    "the criteria for when a change of the local resolution should be introduced are very flexible , just as in the amr technique . indeed , because the initial distribution of mesh generating points and the manner in which they are updated in time are arbitrary , arepo offers the capability of running in an amr mode .    in our cosmological galaxy formation simulations",
    "it is desirable to maintain a roughly constant mass resolution .",
    "this is because in runs with star formation whole gas cells can turn into collisionless stellar particles , and it is best to create them with approximately the same mass to avoid potential two - body heating effects among these star particles . a relatively homogeneous mass resolution in the gas phase is also warranted to guarantee a more proper comparison to the sph runs , where a fixed mass resolution is present by construction .",
    "( we note , however , that this fixed mass resolution in sph is a consequence of this method s inability to correctly represent the flow on small scales , as we discuss in section  5.3 . )",
    "we have therefore introduced a new re-/derefinement scheme in arepo that ensures that the mass resolution in the gas and the spawned star particles never deviates too much from the value of the sph particle mass in the corresponding gadget simulation .",
    "specifically , we `` force '' cells to have a mass in the range @xmath11 , where we set the target gas mass @xmath12 equal to the mean cell mass assuming a homogeneous gas distribution in the simulation volume with equal volume cells .",
    "this corresponds then exactly to the mass of an individual sph particle in the gadget calculation at the same particle / cell number .",
    "we allow only quite `` roundish '' cells to be refined , specifically we only refine a cell if the maximum face angle is smaller than @xmath13 .",
    "this protects against introducing large local errors by splitting very irregular cells ( which are usually cells that have just been split in the previous timestep ) . as a result of this constraint",
    "our simulations may contain at any given time a few cells which are more massive than @xmath14 .",
    "we have also done runs where only cells with a sufficiently shallow temperature gradient across them were allowed to be derefined , but this did not make any significant difference to our results .",
    "we also slightly modified the star formation implementation to take this re-/derefinement scheme into account .",
    "specifically , if a star particle is formed in a cell with mass less than @xmath15 , it inherits the full mass and the cell is removed .",
    "otherwise , a star particle is created with a mass equal to @xmath16 , leaving the rest of the mass in the ( surviving ) cell .",
    "cells that do not contain at least @xmath17 do not produce stellar particles , which prevents very low mass collisionless particles from being formed . we note that such low mass cells are exceedingly rare , because cells with less than @xmath18 are normally all removed during the derefinement process .",
    "however , since two neighbouring cells will never be dissolved in the same timestep ( see the discussion in s10 ) , a cell can in rare cases briefly scatter below @xmath19 and potentially also attempt to spawn a stellar particle during this time .",
    "this modification of the star formation implementation guarantees that star particle masses are bounded by the interval @xmath20 .",
    "our gadget and arepo simulations both use only one generation of stellar particles , which implies that the total number of baryonic resolution elements in the gadget simulations is strictly conserved , while in arepo it can fluctuate slightly around the initial value .    *",
    "( iii ) dual entropy formalism : * as discussed in s10 , finite volume hydro solvers can suffer from spurious heating in highly supersonic , cold parts of the flow , where the kinetic energy dominates over the thermal energy . especially at high redshifts in cosmological simulations",
    ", this can lead to an incorrect temperature evolution in low - density gas as a result of discretisation errors in the advection of the kinetic energy .",
    "owing to its quasi - lagrangian character arepo is somewhat less prone to this effect than fixed mesh techniques , but it can still be present at some level . to circumvent this problem , arepo can optionally force the entropy to be conserved instead of the energy during a timestep . in this case , no spurious heating will be introduced .",
    "however , entropy is conserved only outside of shocks in adiabatic parts of the flow , so a criterion is required to decide on a cell - by - cell basis whether energy or entropy conservation should be given precedence for a cell s evolution over the current timestep .",
    "as s10 showed , this dual entropy formalism is especially useful for non - radiative simulations , because here a spurious heating can not be compensated by radiative cooling .",
    "since our simulations include radiative cooling due to a primordial gas mixture we expect this to be less problematic for our applications .",
    "indeed , extensive test simulations showed that our results are not sensitive to whether or not the dual entropy formalism is used .",
    "we have therefore decided to exclusively use strict energy conservation in all our production calculations , without employing the dual entropy formalism .    *",
    "( iv ) gravitational softening length : * gadget uses a global gravitational softening length for collisional and collisionless particles , i.e.  for gas and stellar / dark matter particles .",
    "arepo also uses a global gravitational softening length for collisionless particles ( which we set equal to that used in our gadget simulations ) .",
    "however , as the code is a finite volume method which uses gas cells of variable size to represent the fluid , we have used individual plummer - equivalent gravitational softening lengths according to @xmath21 for each gaseous cell , where @xmath22 is the cell s fiducial radius assuming the cell volume is spread over a sphere , and @xmath23 is an overall scaling factor . in addition , we imposed a lower floor on the gravitational softening lengths equal to that of the sph particles in the corresponding gadget simulation .",
    "this was done in order to safeguard against a potentially higher gravitational resolution in arepo in the densest gas , which may have distorted our comparison .",
    "however we note that we do not expect any significant difference due to the slightly different treatment of the gravitational softening length of the gas even if such a floor was not used .",
    "indeed , as described in appendix  b , we have repeated lower resolution arepo simulations with a fixed softening length for all gas cells and obtained nearly identical results . also , we have repeated simulations with adaptive gravitational softening without a lower floor and again obtained equivalent results .",
    "we note that the presence of an effective equation of state for highly dense gas is ultimately responsible for this insensitivity . without it",
    ", we would get fragmentation of very dense gas where the adaptive softening could make a difference @xcite .    [",
    "cols=\"^,^,^,^,^,^,^,^\",options=\"header \" , ]      in any comparison between codes as different as gadget and arepo , a number of different benchmarks can be used to gauge their relative performance , and various criteria can be defined to align runs that are deemed comparable with each other . in our study , we have chosen to compare gadget and arepo at matching mass resolution , using the same initial number of baryonic and dark matter resolution elements .",
    "this provides a well - defined comparison strategy and is advantageous for a number of reasons :    \\(1 ) first , we can use the same initial conditions for the simulations with both codes .",
    "this would not be possible if we performed the runs with different initial mass resolutions .",
    "( 2 ) second , our choice makes it straightforward to relate the same objects between the different runs ( and they are resolved in dark matter in the same way ) .",
    "( 3 ) third , as we discuss below , for the same initial mass resolution , the cpu time requirements for gadget and arepo are similar , at least for cosmological simulations , with the moving mesh runs being only some @xmath24 more costly . in many cases ,",
    "the limiting factor for the simulation size that can be achieved is the amount of computing time required , so our choice effectively enables a comparison for fixed computational resources .    of course , in principle one may also attempt a comparison at equivalent spatial resolution in the gas between gadget and arepo , or at the same accuracy in the solution obtained .",
    "we have not attempted this for the following reasons .",
    "first , while the spatial resolution that can be achieved for a given number of resolution elements is expected to be worse in sph compared to arepo , the degree to which this matters is likely very problem - dependent .",
    "for example , for our treatment of star formation , the mass resolution is much more important than a precise treatment of fluid discontinuities . aligning the spatial resolutions such that discontinuities are broadened over the same scale in both codes would lead to drastically different mass resolutions in the star - forming phases and hence likely to large systematic resolution effects in the smallest galaxies .",
    "second , and even more important in our view , is that the convergence properties of sph are not well understood , making a comparison at fixed accuracy a highly problematic undertaking from the start . as we discuss at length in section  5 , formal convergence in sph",
    "ultimately requires that the number of neighbouring particles used in smoothed estimates around a particular location be increased as the total number of particles is made larger .",
    "this has typically not been done in cosmological applications , and is also in practice not readily possible due to clumping instabilities ( e.g. * ? ? ?",
    "moreover , while sph is often described as being `` lagrangian , '' this is not formally correct because individual fluid elements , as represented by sph particles , are not allowed to deform arbitrarily in response to e.g.  shearing motions , as we illustrate in section  5 .",
    "sph should , therefore , properly be referred to as `` pseudo - lagrangian . ''",
    "the errors that this feature of sph entails depend on the detailed properties of the flow , in addition to the local spatial resolution , and consequently can not be assessed in general . in its most basic formulation ,",
    "sph may simply lack a formal convergence condition , making it unclear how a comparison at fixed accuracy should be defined .",
    "finally , in our study , we have chosen a particular implementation of `` standard sph '' , as implemented by the gadget code . moreover , by choosing gadget for our sph simulations , we are able to use the same gravity solver and the same physics in our comparisons between sph and arepo , which might not be possible otherwise .",
    "this enables us to isolate differences in runs that owe primarily to the differences in the hydro solvers between gadget and arepo .",
    "as we discuss in section  5 , various modifications have been proposed to the basic structure of sph in order to improve its reliability under some circumstances .",
    "it is , of course , possible that we would have obtained somewhat different results had we employed such formulations of sph .",
    "however , we believe that many limitations of sph are generic and are not specific to gadget . indeed , as we discuss in section  5 , it is difficult to see how sph could be modified to entirely eliminate , for example , the sources of error that owe to its pseudo - lagrangian nature without radical modifications to the underlying algorithm .",
    "we also stress again that the primary goal of our comparison is not to arrive at the best fit to observational data , or to achieve the highest possible resolution for single galaxy models . while we acknowledge that important strides have been made recently in studying disk formation numerically using zoom - in procedures in cosmological sph simulations ( e.g. * ? ? ?",
    "* ; * ? ? ?",
    "* ) , we do not think these successes provide much evidence for the numerical reliability of sph , although this misconception appears widespread .",
    "our ultimate aim is not merely to model single objects , but entire populations of galaxies so that we can statistically constrain uncertain processes associated with star formation and feedback by using , e.g. , observations of the distribution of galaxies with respect to their hubble type .",
    "this requires the identification of accurate and computationally efficient techniques that are best suitable for the task .",
    "in particular , our strategy is designed to detect systematic inaccuracies in current simulation techniques that may easily be concealed by the adjustment of heuristic feedback parameters to match a certain observation , as it is commonly done , while at the same time these effects may have serious consequences in other places .      for our simulation",
    "set we adopt the cosmological parameters @xmath25 , @xmath26 , @xmath27 , @xmath28 , @xmath29 and @xmath30 ( @xmath31 ) .",
    "these parameters are consistent with the most recent wmap-7 measurements @xcite as well as with a host of other cosmological constraints .",
    "we create a realisation of this cosmology in a periodic box with a sidelength @xmath32 , at three different mass resolutions corresponding to @xmath33 , @xmath34 and @xmath35 particles / cells .",
    "a comoving gravitational softening length of @xmath36 , @xmath37 or @xmath38 , respectively , is used for the dark matter , and for the gas particles in the gadget runs . for arepo , we start initially with the same number of cells as there are particles in the corresponding sph run , but we use an adaptive gravitational softening with a floor as described earlier . note that due to re- and derefinement the number of baryonic resolution elements ( cells plus star particles ) is not strictly conserved during the course of a simulation but can fluctuate slightly around the initial number .",
    "initial conditions were generated at @xmath39 based on the power spectrum fit of @xcite , with gas particles / cells added to the initial conditions by splitting each original particle into a dark matter and gas particle / cell pair , displacing them with respect to each other such that two interleaved grids are formed , keeping the centre - of - mass of each pair fixed .",
    "all our simulations have been evolved until redshift @xmath5 even though the fundamental mode of our small box becomes mildly non - linear at low redshift . however , our primary goal here is not to obtain quantitatively accurate large - scale statistics , but rather to compare the properties of galaxies formed by two different hydrodynamical schemes .",
    "as we start all simulations with the same phases , this relative comparison is unaffected by box - size effects down to @xmath5 . to easily refer to the different runs in our simulation suite we use the following naming convention .",
    "a_l20nx denotes arepo runs ( indicated by the leading ` a ' ) , where @xmath40 , @xmath41 , or @xmath42 encodes the numerical resolution and the tag ` l20 ' stands for the box size of @xmath43 .",
    "likewise , g_l20nx refers to our gadget runs ( indicated by the ` g ' ) . in table",
    "[ table : simulations ] , we provide an overview of our simulation suite and list its most important parameters .",
    "to obtain a first impression of the simulations , it is instructive to examine maps of the density and temperature fields . in fig .  [",
    "fig : projections ] , we show projections of the gas density and temperature distributions for our highest resolution simulations a_l20n512 and g_l20n512 at @xmath44 . the left panel gives the arepo results and the right panel those obtained with gadget . in both cases , the image on top depicts a large part of the full box , while the zoom images below show two successive zooms onto a disk galaxy ( as indicated by the white squares ) . in these enlarged images , the left half depicts the temperature field while the right half gives the density field .",
    "all slices have a thickness of @xmath45 and their extent in the image plane is specified by the scale - bars included in the images .",
    "note that we did not centre the two image sequences individually onto the galaxies , so the zoom sequence also illustrates the typical magnitude of coordinate offsets that can develop between the different simulations .    inspection of the maps in fig .",
    "[ fig : projections ] demonstrates that both codes produce essentially identical results on large scales .",
    "this is reasonable since we do not expect large - scale changes induced by a different hydrodynamical scheme .",
    "however , already at the intermediate zoom level one can identify some significant differences .",
    "the distribution of hot gas is clearly quite different , with gadget showing a more extended hot atmosphere compared to arepo . on still smaller scales ,",
    "the differences between the two hydrodynamical codes become even more pronounced : whereas arepo produces an extended disk , gadget forms a significantly smaller and clumpier disk .",
    "the difference can be best appreciated in the temperature map , where the cold gas disk stands out clearly as a large blue region in the moving mesh calculation .",
    "arepo forms a spiral disk with a central bar , which is visible in the density map . for a more detailed analysis of the structural properties of this galaxy we refer the reader to paper ii of this series .",
    "we note that although some spiral features are visible in the disk , these are partly seeded by poisson noise in the potential due to the limited number of dm particles in the halo ( see * ? ? ?",
    "* for details of this process ) , and have hence only limited physical significance .        in order to demonstrate that differences like those seen in fig .",
    "[ fig : projections ] do not appear only in unusual cases , we show in fig .",
    "[ fig : collage_gas_z2 ] gas density projections of the central galaxies of the 24 most massive haloes at @xmath44 of a_l20n512 ( top panels ) , and g_l20n512 ( bottom panels ) , along random projection directions .",
    "we did not impose any constraint on the galaxy selection other than halo mass ; as a result , we can also have galaxies in our sample that are disturbed or undergo a merger , such as the system labelled ` galaxy - id  5 ' .",
    "the object ` galaxy - id  8 ' of fig .",
    "[ fig : collage_gas_z2 ] corresponds to the galaxy shown in fig .",
    "[ fig : projections ] , but happens to be oriented edge - on here .",
    "the random orientations of the galaxy set give an impression of how a population of galaxies would look like in these simulations . clearly , the gas distributions of most of the galaxies in fig .",
    "[ fig : collage_gas_z2 ] are more extended and more reminiscent of spiral galaxies in arepo than in gadget .",
    "inspection of animated sequences from the arepo simulations reveals a population of interacting and merging systems .",
    "many of them show thin bridges and tails , as expected if the galaxies are rotationally supported disks ( e.g. * ? ? ?",
    "* ; * ? ? ?",
    "* ) and @xmath44 ) and high - resolution images are available for download at the website http://www.cfa.harvard.edu/itc/research/movingmeshcosmology . ] .",
    "the differences in the gas properties are also reflected in the corresponding stellar distributions of these galaxies , which we show in fig .",
    "[ fig : collage_stars_z2 ] .",
    "although the stellar distributions are more similar between the two numerical schemes , in most cases one still notices that arepo s disks are slightly larger and appear typically more disky , an impression that is also supported by the quantitative analysis of galaxy properties that we present in paper ii",
    ". furthermore , the stellar populations of the arepo galaxies are bluer , i.e. younger , than those found in the gadget run .    in fig .",
    "[ fig : collage_gas_z0 ] and fig .",
    "[ fig : collage_stars_z0 ] we show face - on projections of 32 other galaxies at @xmath5 with milky way - like dm halo masses in the mass range from @xmath46 to @xmath47 .",
    "the gas disk structure shown in fig .",
    "[ fig : collage_gas_z0 ] follows the trend already seen at @xmath44 , and demonstrates that arepo produces significantly larger disks at all times and at all halo masses compared to the gadget simulations .",
    "[ fig : collage_stars_z0 ] demonstrates that the stellar disks are also slightly larger , but not as significant as the gas disks .",
    "but similar to the @xmath44 result , the arepo stellar disk populations are typically younger than those found in gadget .    a self - evident conclusion from these visual comparisons of figs .  [ fig : collage_gas_z2 ] , [ fig : collage_stars_z2 ] and figs .",
    "[ fig : collage_gas_z0 ] , [ fig : collage_stars_z0 ] is that the morphology of forming galaxies in cosmological hydrodynamics simulations can be strongly affected by the underlying hydrodynamics solver .",
    "sph has significantly more problems producing disk - like galaxies than the moving mesh approach for a similar computational cost .",
    "note however that we do not expect our simulations to produce a completely realistic @xmath44 galaxy population , because we here refrained from including strong feedback capable of producing galactic winds and outflows .",
    "however , since both simulations followed exactly the same physics , we expect this qualitative difference to be present in simulations with stronger feedback as well .",
    "as we emphasised earlier , arepo and gadget use the same gravity solver based on a high - resolution tree - pm scheme . because the gravitational field is largely dominated by the collisionless dm component",
    ", we expect that the dm distribution in both simulations should hence be similar , at least on scales where baryonic effects do not change the structure of dm haloes .",
    "we explicitly verify this expectation in the left column of fig .",
    "[ fig : fof_mf ] , where we compare the dm halo mass function of friends - of - friends ( fof ) groups with a linking length of @xmath48 of the mean particle separation down to a particle number limit of 32 particles at @xmath5 and @xmath44 .",
    "the codes show excellent agreement in the dm halo mass functions at both redshifts . also , the convergence for the different resolutions is in both cases very good .",
    "we note that previous comparisons of hydrodynamical mesh codes and high resolution tree codes have shown a deficit of low - mass haloes in the mesh - based hydrodynamical codes , an effect that has its origin in their amr - based gravity solver , which typically does not refine small dm haloes sufficiently early .",
    "as evidenced here , arepo does not have this problem .",
    "the other panels of fig .",
    "[ fig : fof_mf ] count haloes in terms of their baryonic content , separately for gas and stars . in order to relate baryons to dark matter haloes ,",
    "we determine for each stellar and gaseous cell / particle the closest dark matter particle , and then associate the baryonic mass element with the fof group this dm particle resides in ( see * ? ? ?",
    "* for more details ) . the middle column of fig .",
    "[ fig : fof_mf ] shows the cumulative halo gas mass functions at redshifts @xmath44 and @xmath5 .",
    "while both codes converge equally well for the gas mass functions as a function of resolution , they do not agree on the result . at @xmath44",
    ", arepo has more objects of a given gas mass than gadget over nearly the full range of halo masses .",
    "this behaviour changes towards lower redshifts , where fewer very gas - rich objects are found in arepo",
    ". we will show below that this has to do with more efficient cooling and a higher star formation rate in the mesh code in massive haloes at late times .    the right column in fig .",
    "[ fig : fof_mf ] gives the mass functions for the stellar component of haloes , and here the situation is slightly different . at @xmath44 , we find fewer objects with low stellar mass in arepo compared to gadget , but the situation reverses at the high mass end where we find arepo has more haloes at a given stellar mass",
    ". this behaviour changes somewhat towards @xmath5 , where the low mass end agrees now very well between the two codes .",
    "however , there are still more stellar systems of high mass in arepo , and this difference becomes more pronounced and extends over a larger range of masses .",
    "again , this can be attributed to the more efficient star formation at late times in massive systems in arepo that we analyse in detail below .",
    "since the baryonic mass contributes only a small amount to the total mass of the entire box , these differences in the baryonic mass functions are neither imprinted in the dm halo mass functions nor visible in the large - scale structure shown in fig .",
    "[ fig : projections ] .",
    "because we use two completely different hydro solvers , we may expect some deviations in the breakdown of various gas phases .",
    "a first simple way to obtain an overview of the global state of the gas in the simulation volume is the construction of density  temperature phase - space diagrams .",
    "we show in fig .",
    "[ fig : rho_t ] mass - weighted @xmath49-@xmath50 phase - space diagrams of the simulations at the highest resolution for @xmath44 ( top row ) and @xmath5 ( bottom row ) .",
    "the left and right columns show results for arepo and gadget , respectively .",
    "we can readily identify a number of well - known features in the gas phase - space @xcite , which show up in both runs .",
    "the narrow ridge of gas with an upward slope and @xmath51 and @xmath52 consists of low density , highly photo - ionised gas in the intergalactic medium ( igm ) .",
    "the tight relation between temperature and density in this regime is maintained by the competition between adiabatic expansion cooling and photo - ionisation heating .",
    "the plume of gas with @xmath53 and @xmath54 is comprised on the other hand of shock - heated gas in virialised haloes and , at the lower density end , in and around filaments .",
    "the narrow , downward sloping locus of gas at @xmath55 and @xmath56 represents radiatively cooled , dense gas in galaxies .",
    "the cooling times at these densities are short , so that gas remains close to its equilibrium temperature where photo - ionisation heating balances radiative cooling .",
    "this temperature is a slowly decreasing function of density and lies close to @xmath57 .",
    "finally , once the gas becomes very dense and reaches the star formation threshold , we describe the gas by an effective equation of state representing the mean thermal energy density of a two - phase medium of hot and cold gas .",
    "this effective equation of state results in the upward sloping high density line of gas , which represents the ism in galaxies .",
    "the pressurisation by supernova feedback in our subresolution model prevents this gas from fragmenting under self - gravity .        as fig .",
    "[ fig : rho_t ] demonstrates , arepo and gadget lead to a qualitatively very similar @xmath58 phase - space diagram .",
    "this demonstrates that the properties of the gas distributions are overall quite comparable in both codes .",
    "however , although there is general broad agreement between the simulations , there are also some striking differences .",
    "first of all , the distribution of hot gas extends to higher densities in the arepo runs compared to the gadget simulations ; i.e.  there is more hot gas at higher densities in the arepo simulations .",
    "we note however that in terms of total mass this is not very significant .",
    "more important , gadget appears to have more hot gas in general , which can be inferred from the slightly more extended yellow region in the phase diagrams .",
    "this is consistent with the temperature structure in the surroundings of the galaxy shown in fig .",
    "[ fig : projections ] .",
    "the arepo runs also exhibit a more pronounced cooling feature around @xmath59 , which corresponds to a local minimum of the cooling curve between the two line peaks of hydrogen and helium .",
    "although this feature is readily visible in the phase - space diagrams of the arepo runs , the actual gas mass populating that feature is very small .",
    "the faint stripe - like features seen in the top - left and bottom - left panels of fig .",
    "7 below the effective equation of state arise from numerical inaccuracies in the temperature evolution of some cells around star - formation sites . here",
    "the temperature can sometimes scatter to very low values , which is one incarnation of the accuracy problems associated with supersonic cold fluid motions . in our multi - phase model , the temperature of these cells",
    "is then relaxed back to the effective equation of state temperature @xmath60 on a timescale @xmath61 given by equation 12 of of @xcite .",
    "the simulation timestep @xmath62 of these cells is small against @xmath61 , such that the temperature of the cell at the end of a relaxation step is @xmath63 . because @xmath64 ( see * ? ? ? * ) and due to the power - of - two hierarchy of possible values for @xmath62 , a set of parallel stripes of cells spaced by a factor of 2 results .",
    "the mass in these cells is however negligibly small , so that this effect has no influence on the dynamics .    to quantify the gas mass content in the different regions of the @xmath49@xmath50 phase - space diagrams in fig .",
    "[ fig : rho_t ] , we introduce the following cuts in the @xmath49-@xmath50 plane : ( 1 ) diffuse cool gas with @xmath65 and @xmath66 , ( 2 ) diffuse warm gas with @xmath65 and @xmath67 , ( 3 ) diffuse hot gas with @xmath65 and @xmath68 , and finally , ( 4 ) dense gas with @xmath55 . in fig .",
    "[ fig : gas_phases_mass ] , we first show the different gas mass fractions of each of these four phases .",
    "all runs show the behaviour we anticipated earlier ; i.e.  there is the general trend that the cold gas fraction decreases and the warm / hot gas fraction increases with time . the hot gas fraction ( lower left panel ) increases due to shock heating in haloes .",
    "interestingly the details vary quite strongly between the different numerical schemes .",
    "the gadget runs typically show more hot and warm gas , and accordingly produce less dense gas .",
    "especially the mass fractions in the hot phase are very different between the two schemes : for most of the time the mass difference here is larger than one order of magnitude .",
    "we will show below that these two findings are also consistent with the results for the star formation histories of the different runs .",
    "we note that the same trends are also found for the lower resolution simulations , but the quantitative numbers differ slightly .",
    "although not fully converged , there is more very dense gas ( lower right panel ) in arepo than in gadget at all resolutions , and also the amount of cold gas ( upper left panel ) is larger in arepo .",
    "these results confirm the visual impression obtained from fig .  [",
    "fig : projections ] , where we also saw that the hot atmosphere is smaller in arepo , but the cold gas disk is larger .",
    "next , we consider in fig .",
    "[ fig : gas_phases_volume ] the corresponding volume fractions of these gas phases .",
    "the volume fractions of the gadget runs are based on the specific volume of individual sph particles : @xmath69 .",
    "however , sph is not volume - conserving in the sense that the sum of the specific volumes of all sph particles will not sum up to the total simulation volume .",
    "in finite - volume methods like the one used by arepo , this does not occur ; all the cell volumes add up to the correct simulation volume .",
    "for the comparisons of the volume fractions we therefore do not calculate volume fractions with respect to the total simulation box volume , but with respect to the sum of all individual particle / cell volumes .",
    "this does not influence the volume fractions of arepo , but changes the sph volume fractions of gadget , which would otherwise not add up to unity .",
    "the general trends we find for the volume fractions in fig .",
    "[ fig : gas_phases_volume ] are similar to those for the mass fractions in fig .  [",
    "fig : gas_phases_mass ] .",
    "however , we can now clearly see that the hot atmospheres are not only strongly reduced in mass in arepo , but also that their volume fraction is significantly smaller compared to gadget .",
    "this is in agreement with the qualitative results shown in fig .",
    "[ fig : projections ] and fig .",
    "[ fig : collage_gas_z2 ] . the same is true for the volume fraction of the cold gas , which is however not as well - converged .             to focus more on the density structure ,",
    "we marginalise fig .  [",
    "fig : rho_t ] over temperature and express the densities as physical hydrogen number densities .",
    "we hence derive the hydrogen number density probability distribution functions for the full simulation volume , which are shown in fig .",
    "[ fig : density_pdf ] . the left panel accounts for all gas particles / cells , whereas the right panel shows only those with active star formation . in our star formation model ,",
    "the density threshold for the onset of star formation is set to @xmath4 , and therefore the right hand panel occupies only this high density region .",
    "interestingly , gadget shows at all resolutions a significantly reduced gas fraction slightly below the star formation density threshold .",
    "we checked that the reduction of the gas mass in this region is caused by the more extended disks in arepo ; i.e. the additional gas found in arepo at these densities stems from disk material .",
    "presumably , the ` gap ' phenomenon found in sph across strong contact discontinuities @xcite , such as the one we have here , also contributes to the different breakdown in that density range .",
    "the other parts of the density distributions look rather similar for the two simulation methods , however .",
    "we verified that the gas slightly below the threshold is predominantly responsible for the more extended disks in arepo .",
    "this gas effectively fills the gap which is present in sph .",
    "the galaxies in gadget typically lead to a peak in the density pdf above the star formation threshold instead of a more plateau - like feature due to the extended gas disks in arepo .",
    "therefore , the difference in the density pdf is a reflection of significantly different galaxy radii for the different hydro - schemes ( see also paper ii ) .    , @xmath44 and @xmath70 as indicated . at higher",
    "redshift ( @xmath70 ) the two curves agree reasonably well in shape .",
    "but at @xmath44 there is already a trend visible , because the arepo distribution is biased towards slightly younger stars .",
    "this effect becomes even more pronounced towards lower redshift and is clearly visible in the distribution at @xmath5 . at that time",
    "the arepo result is significantly different from gadget and shows a substantially larger fraction of young stars .",
    "the reason for this is the larger overall star formation rate at late times , as shown in fig .",
    "[ fig : sfr_hist ] .",
    "the different stellar age distributions are also responsible for the bluer appearance of the stellar populations of the arepo galaxies shown in fig .",
    "[ fig : collage_stars_z2 ] and fig .",
    "[ fig : collage_stars_z0 ] .",
    "[ fig : stellar_age],scaledwidth=47.5% ]      an important prediction of our simulations is the global star formation history ( sfh ) , which encodes key information about the overall efficiency of the galaxy formation process .",
    "the sfhs of our different simulation runs are presented in fig .",
    "[ fig : sfr_hist ] .",
    "the top left panel shows the sfh as a function of lookback time , whereas the lower left panel plots it on a logarithmic scale as a function of redshift .",
    "the corresponding integrated star formation histories are shown in the right panels .",
    "the most obvious trend with increasing resolution is that more high-@xmath71 star formation in small haloes is resolved @xcite .",
    "this is simply due to the better mass and spatial resolution for smaller haloes , which are in part not even seen in the coarser simulations .",
    "this trend with resolution also shifts the peak in the star formation rate density to higher redshift with increasing resolution .",
    "note however that there is little cosmic time at these high redshifts , so that the mass of stars formed there is small compared to the present stellar density .",
    "once the simulations resolve all haloes with virial temperature of @xmath72 and above ( necessitating a dark matter particle resolution of about @xmath73 ) , we expect however that the trend with resolution will stop and all ordinary star formation will be resolved ( apart from additional pop - iii star formation , which is not included in our models ) .    after the high - redshift peak of star formation , the star formation rates decline and converge particularly well at lower redshifts for the sph - based gadget simulations . in this regime , most of the star formation is contributed by higher mass haloes @xcite , for which our subresolution model produces converged results already at moderate resolution",
    ". this excellent convergence does not quite carry over to the moving mesh calculations with arepo , where all resolutions slightly vary in their late time star formation rates ( for further explanation see section 4.3 and paper iii ) . however , the mesh - based results are still very close to one other , and more importantly , they lie significantly higher than the sph simulations , which is clearly visible from the inset in the upper left panel of fig .  [ fig : sfr_hist ] showing the ratio of the individual sfhs to the mean .",
    "we emphasise once more that this systematic difference is a result only of the different hydrodynamical schemes , since both codes use the same star formation model and calculate identical star formation rates for a given gas density .",
    "there is a minor technical difference in how stellar particles are created , but this does not affect the outcomes , as we have explicitly checked in numerous test calculations of isolated haloes and galaxies ( see paper iii ) .",
    "the latter do show very good agreement in the star formation rates between gadget and arepo , so the difference we find in fig .",
    "[ fig : sfr_hist ] must have a cosmological origin .    to understand better whether this increased star formation rate affects all halo masses or whether it is dominated by a certain halo population , we plot in fig .",
    "[ fig : sfr_fof ] the star formation rates as a function of fof group mass for our highest resolution simulations .",
    "solid lines in fig .",
    "[ fig : sfr_fof ] represent the median values and shaded regions show the @xmath74 range of the distribution .",
    "the insets show the specific star formation rates . in both cases , and for all redshifts shown , the scatter around the median relation is rather small . at high redshift ( @xmath75 ) , the differences between the sph and moving - mesh calculations mainly occur at the intermediate and low mass end , where gadget produces more stars than arepo .",
    "this is in agreement with the general trend found for the global sfh , where gadget shows a slightly higher star formation rate at high redshift .",
    "we note that the higher specific star formation rates in arepo at late times are due to a significantly more efficient cooling .",
    "we point out that one reason why gadget shows at high-@xmath71 a larger star formation rate ( sfr ) at a given resolution than arepo is related to the fact that already at this early time the disks in arepo are slightly more extended and hence have a lower gas surface density ( as demonstrated in paper ii ) .",
    "therefore , the star formation rate is lower compared to the denser , more blob - like galaxies formed in the sph calculations .",
    "we note that this discrepancy between gadget and arepo decreases once the resolution in sph becomes high enough , but it still induces a noticeable delay in arepo s sfr - peak compared to gadget , although the peak amplitudes agree quite well .    ) of the gas for the different simulations , where @xmath76 and @xmath77 are the cooling and heating rates per unit mass .",
    "we set the net cooling to zero for particles / cells that are subject to net heating .",
    "the rates of all arepo runs are higher than those of the gadget simulations at late times .",
    "this is directly related to the higher sfrs of all arepo runs compared to gadget , as seen at late times in fig .",
    "[ fig : sfr_hist ] . at high redshift ,",
    "the cooling rates of arepo are lower than those of gadget for the intermediate and the lowest resolution .",
    "this is a consequence of the more compact disks in gadget at these high redshifts .",
    "this cooling rate difference decreases once we reach the highest resolution . in that case",
    "the cooling rates of gadget and arepo agree better at high redshifts , but still show quite large differences at low redshifts , which also produces the different sfr history .",
    "[ fig : cooling_rates],scaledwidth=48.0% ]    towards lower redshifts , a gradual trend of a different nature appears : while arepo and gadget start to agree better at low masses , the schemes deviate more and more strongly towards the high mass end . at @xmath5 ,",
    "there is a nearly perfect overlap of the star formation rates below @xmath78 , but fof groups above this mass form significantly more stars in the arepo simulations compared to gadget runs .",
    "interestingly , this difference in large haloes first starts to show up at around @xmath70 ( upper right panel ) , which roughly coincides with the time when the global star formation rates start to deviate , as can be seen from the lower left panel of fig .",
    "[ fig : sfr_hist ] .",
    "this implies that the massive end of the halo population is mainly responsible for the higher star formation rate in the moving mesh calculations at late times .",
    "these massive systems form at late times and systematically create more stars in arepo than the corresponding gadget calculations , driving the global sfh to a different behaviour in the two codes .",
    "the only way such a difference in the sfh can occur is a more efficient cooling behaviour in arepo in haloes above @xmath79 , allowing more gas to accumulate at the bottom of halo potentials and above the density threshold for star formation .",
    "this interpretation also agrees with our findings for the mass fractions and volume fractions in the different gas phases , where gadget shows at all resolutions significantly more hot gas than arepo .",
    "furthermore it agrees with the gas density pdfs in fig .",
    "[ fig : density_pdf ] , which show that arepo has a larger fraction of dense gas slightly below the star formation density threshold .",
    "as we will discuss in the next section , the culprit of the reduced cooling in gadget lies in different hydrodynamical dissipation rates in the outer parts of haloes compared with arepo . in paper iii of this series ,",
    "we furthermore show that arepo s more accurate treatment of hydrodynamical fluid instabilities strongly affects the stripping of gas out of gas clumps that fall into haloes .",
    "this in turn leads to significant differences in how the thermodynamic structure of haloes is affected by the hierarchical merging process , contributing to the cooling differences .",
    "we note that the different star formation histories also result in a different distribution of stellar ages in individual galaxies .",
    "this can already be seen in fig .",
    "[ fig : collage_stars_z2 ] and fig .  [ fig : collage_stars_z0 ] , where not only the morphology of the stellar distribution is different , but also the average age as can be inferred from the colour scale .",
    "the gadget galaxies look clearly redder overall than the arepo galaxies , which are on average bluer . to quantify this in more detail ,",
    "we show in fig .",
    "[ fig : stellar_age ] distribution functions of the formation redshifts of the stellar populations at @xmath5 , @xmath44 and @xmath70 , for our two highest resolution simulations .",
    "this figure demonstrates that at high redshift ( @xmath70 ) the distributions agree reasonably well in shape .",
    "but at @xmath44 , a clear trend is already visible , because the arepo distribution becomes biased towards slightly younger stars .",
    "this has to do with the slight shift of the peak of the sfh and the different late time behaviour of the sfh found in fig .",
    "[ fig : sfr_hist ] .",
    "the difference in the distributions becomes even more pronounced towards lower redshift and is clearly evident at @xmath5 . at that time",
    "the arepo distribution is quite distinct from gadget and shows a significantly larger fraction of young stars .",
    "the reason for this lies in the larger star formation rate at late times , as discussed above .",
    "the differences between arepo and gadget discussed so far point towards a different cooling behaviour between the two codes . to demonstrate this more clearly , fig .",
    "[ fig : cooling_rates ] shows the total net cooling rate ( @xmath80 ) , where @xmath76 and @xmath77 are the cooling and heating rates per unit mass as a function of redshift , accounting for all gas in our simulations . in the case of net heating",
    "we set this rate to zero .",
    "the figure demonstrates that at late times , the cooling rates of all arepo runs are higher than those of corresponding gadget runs .",
    "we note that this is true for all three resolutions , yielding a clear separation between the set of blue curves ( representing the sph simulations ) and the red curves ( representing the moving mesh calculations ) .",
    "interestingly , the difference partially reverses at high redshift , where the cooling rates of arepo at the intermediate and the low resolution are lower than those of gadget .",
    "this is a consequence of the more compact galaxies in gadget at these high redshifts , which result in larger densities and therefore more cooling radiation .",
    "this high-@xmath71 cooling rate difference decreases and nearly disappears once we reach the highest mass resolution . in that case",
    "the cooling rates of gadget and arepo agree reasonably well at high redshifts , as shown in fig .",
    "[ fig : cooling_rates ] .",
    "in contrast , the quite large and systematic difference at low redshifts persists independent of resolution .",
    "further insight into the origin of the cooling difference is provided by fig .",
    "[ fig : density_vs_coolingrate ] , which shows the mean mass - weighted net cooling rates ( @xmath81 ) at redshifts @xmath44 ( left panel ) and @xmath5 ( right panel ) as a function of hydrogen number density .",
    "if the temperature structure of the gas at fixed density would agree between all simulations , then the mean mass - weighted cooling rates should also agree for a given hydrogen number density .",
    "but as fig .",
    "[ fig : density_vs_coolingrate ] shows , this is not the case and some systematic differences between gadget and arepo are present .",
    "interestingly , the curves in fig .",
    "[ fig : density_vs_coolingrate ] differ however only over a limited density range corresponding to the diffuse gas in haloes , beginning at the star formation density threshold ( marked by the vertical green line ) and extending to lower densities . in that density range",
    ", arepo shows a significantly larger mean cooling rate at all resolutions , which must be due to a slightly lower gas temperature in the mean at these densities .",
    "we note that the magnitude of the difference is however redshift dependent and becomes smaller as we go to higher redshifts , as seen by comparing the @xmath5 and @xmath44 panels in fig .",
    "[ fig : density_vs_coolingrate ] .    at other hydrogen densities , including the range not shown in fig .",
    "[ fig : density_vs_coolingrate ] , the sph and moving - mesh cooling rates agree well for all our runs . above the threshold for star formation",
    "this is however not surprising , because here the effective equation of state produces a tight correlation between density and temperature ( as seen in fig .",
    "[ fig : rho_t ] ) .",
    "this leads to a nearly one - to - one mapping of density to temperature in this regime , and explains the two - peak structure of the curves in fig .",
    "[ fig : density_vs_coolingrate ] at high densities , which simply reflects the primordial cooling curve with its characteristic hydrogen and helium peaks .        further evidence for a different temperature structure in the two simulation runs is provided by fig .",
    "[ fig : mean_temp ] , which plots the mean mass - weighted temperature in the whole simulation volume as a function of time . in the inset",
    "we divide each curve by the mean of all the curves to emphasise deviations .",
    "we find that the mean temperature of gadget simulations is @xmath82 higher than that of the arepo runs .",
    "the higher temperature can explain the reduction in cooling emission of the sph simulations relative to our moving - mesh calculations , and it is consistent with our above findings for the sfr evolution and the cooling emission .",
    "it thus appears that the origin of the low redshift discrepancy must lie in a different efficiency of non - adiabatic heating processes in the gas , as this is required to explain differences in the temperature distribution at a given density .",
    "+      +      it is widely appreciated that the intracluster medium of galaxy clusters is partially supported by subsonic turbulence @xcite , which is created by curved accretion shocks around the haloes , and more importantly , by the hierarchical infall of structures .",
    "indeed , a number of numerical studies have analysed turbulence in the intracluster medium @xcite",
    ". a similar level of turbulence can also be expected in smaller haloes that are large enough to support quasi - hydrostatic atmospheres .",
    "it has further been shown that shock heating is not only important in strong shocks at the outer accretion radius , but is also significant in weaker flow shocks that occur in large parts of the halo volume @xcite .",
    "physically , the dissipation associated with shocks and with the decay of turbulence occurs through microphysics on very small scales . in our numerical approach ,",
    "we neglect the physical viscosity ( which is assumed to be effectively zero on all resolved scales ; this is why we employ the euler and not the navier - stokes equations ; see e.g. @xcite for a navier - stokes implementation of arepo ) and account for the necessary dissipation through numerical viscosity . in sph",
    "this is provided explicitly in terms of an artificial viscosity , whereas in arepo it is introduced implicitly through the solutions of the riemann solver and cell - averaging .",
    "the good conservation properties of sph allow it to capture one - dimensional shock waves quite well , even though the post - shock velocity field typically shows substantial noise .",
    "this already hints that sph may not be particularly accurate for subsonic flow phenomena , such as the turbulence we expect in the virialised gas of newly formed haloes .",
    "indeed , @xcite have systematically compared driven isothermal subsonic turbulence for gadget and arepo , using the same versions of the codes we employ here .",
    "they find that sph fails quite badly to account for a turbulent cascade in the subsonic case , whereas a kolmogorov scaling is obtained for the moving - mesh code .",
    "this happens despite identical driving fields in both cases , and is ultimately caused by inaccurate gradient estimates in sph and different dissipation as a function of scale .",
    "the sph simulations dissipate most of the energy already close to the driving scale in the subsonic case , whereas in arepo efficient dissipation happens only on much smaller scales , so that a self - similar turbulent cascade can develop over some inertial range .",
    "in addition , @xcite find that sph exhibits a second maximum in the dissipation on very small scales of order the mean interparticle separation . here the subsonic noise of sph is dissipated by the artificial viscosity .",
    "interestingly , the total amount of dissipation on these scales is quite independent of the artificial viscosity value itself .",
    "while a higher viscosity reduces the amplitude of the small - scale sph noise , the dissipation rate on these scales still remains roughly the same , suggesting that the cause of the small - scale noise , which originates in errors in the pressure gradient estimates , can not be reduced effectively with a different viscosity setting .",
    "there are good reasons to expect that these differences in the dissipation properties of the hydrodynamical schemes may also induce important effects for the thermodynamic structure of cosmological haloes , which in turn can easily give rise to variations of the amount of gas that cools out of these haloes . to examine this further ,",
    "we have carried out two auxiliary non - radiative simulations at resolutions of @xmath83 and @xmath84 particles / cells .",
    "these simulations use the same box - size and parameters as our galaxy formation runs , except that cooling and star formation were not included .",
    "the use of non - radiative simulations allows us to cleanly employ the method of @xcite for measuring the instantaneous dissipation rate of particles and cells , respectively . in the case of sph , this can simply be done by measuring the work per unit time done by the artificial viscosity forces , which represents the sole source of entropy generation in this method . for the moving - mesh code",
    ", we instead also advect the thermodynamic entropy between the cells , and then measure the rate of entropy generation by comparing the state of a cell at the end of a timestep computed adopting energy conservation with the state expected if the entropy would have remained constant .",
    "the inferred rate of entropy production can then also be converted into a fiducial heating rate .",
    "haloes contained in different mass ranges , from more massive ( top ) to less massive ( bottom ) , as labelled .",
    "note that the bottom panel is identical to the last panel in fig .",
    "[ fig : dissipationrate1 ] , which is here repeated for ease of comparison .",
    "the solid lines show results for the @xmath84 non - radiative simulations , while the dashed lines give the equivalent @xmath83 results .",
    "[ fig : dissipationrate2],title=\"fig:\",scaledwidth=39.0% ] +   haloes contained in different mass ranges , from more massive ( top ) to less massive ( bottom ) , as labelled . note that the bottom panel is identical to the last panel in fig .",
    "[ fig : dissipationrate1 ] , which is here repeated for ease of comparison .",
    "the solid lines show results for the @xmath84 non - radiative simulations , while the dashed lines give the equivalent @xmath83 results .",
    "[ fig : dissipationrate2],title=\"fig:\",scaledwidth=39.0% ] +   haloes contained in different mass ranges , from more massive ( top ) to less massive ( bottom ) , as labelled . note that the bottom panel is identical to the last panel in fig .",
    "[ fig : dissipationrate1 ] , which is here repeated for ease of comparison .",
    "the solid lines show results for the @xmath84 non - radiative simulations , while the dashed lines give the equivalent @xmath83 results .",
    "[ fig : dissipationrate2],title=\"fig:\",scaledwidth=39.0% ] +    in fig .",
    "[ fig : dissipationrate1 ] , we compare stacked profiles of the spherically averaged dissipative heating rate of haloes obtained in this way . for the plots , we have selected all haloes in the virial mass range @xmath85 , where @xmath86 refers to the mass inside a radius @xmath87 that encloses 200 times the critical density .",
    "we have then placed 20 logarithmic bins onto the radial range @xmath88 to @xmath89 , and produced mass - weighted averages of the dissipation rate per unit mass , @xmath90 , that we measured for each particle / cell . in order to allow a calculation of an average profile by stacking the haloes",
    ", we express the dissipation rate in dimensionless units by multiplying it with the hubble time at the given redshift , and by normalising it to @xmath91 of the particular halo , where @xmath92 is the circular velocity at the virial radius . in the individual panels of fig .",
    "[ fig : dissipationrate1 ] , we show results for different redshifts , ranging from @xmath75 to @xmath5 , and we compare arepo with gadget at the two resolutions considered here .    we see that there is a clear systematic difference in the dissipative heating rates as a function of halo - centric distance .",
    "arepo produces more heating in the infall region directly outside the virial radius whereas gadget shows more heating in the outer parts of virialised haloes , where most of the gas mass is located .",
    "this systematic difference is present at all redshifts in large haloes .",
    "we also note that the nature of the difference is robustly preserved at different resolutions , even though there seem to be small residual trends with spatial resolution .",
    "interestingly , at fixed halo mass , the relative level of dissipation in the innermost parts of haloes increases in the mesh - code with time , which may be related to the build - up of a turbulent entropy core in these haloes . in fig .",
    "[ fig : dissipationrate2 ] , we consider dissipation profiles as a function of halo mass at @xmath5 , which however does not reveal any clear trend with halo mass .",
    "our interpretation of the systematic difference revealed by figs .",
    "[ fig : dissipationrate1 ] and [ fig : dissipationrate2 ] is that : ( 1 ) shocks are captured more efficiently by arepo in the accretion regime of haloes , and ( 2 ) arepo strips gas out of infalling objects more efficiently there ; both effects contribute to a stronger dissipation in this region .",
    "in contrast , sph stops infalling gas less efficiently , leading to more dissipation at smaller radii . a further contributor to",
    "the heating there lies in the dissipation of the subsonic noise in sph , which is constantly recreated in this region by tapping free energy from the disturbances that impinge on the haloes from the outside . as a net result of this dissipation of subsonic noise in the outer parts of haloes , the sph simulations end up hotter",
    "overall ( see also fig .",
    "[ fig : mean_temp ] ) .",
    "furthermore , this difference in the heating occurs in a region where one expects the cooling radius of many haloes in cosmological radiative simulations , thereby directly affecting the amount of cold gas produced in the quasi - hydrostatic cooling flows in large haloes .",
    "we note that the measurement of the dissipation rate is difficult due to its high time variability .",
    "we use above stacked profiles of small sets of halos to mitigate this problem , but even then the inner logarithmic bins average over much smaller gas mass than the outer parts .",
    "this implies that the profiles in the inner @xmath93 of the virial radius are relatively noisy .",
    "but this inner part is largely irrelevant as the impact on the cooling rates comes from larger radii as we discussed above .",
    "another reason why differences in the global star formation rate occur between arepo and gadget lies in the different accuracy with which hydrodynamical fluid instabilities are treated . in particular",
    ", we expect that for the moving - mesh code cold gas can be stripped more efficiently from galaxies as they fall into larger haloes , and this gas is then mixed with the halo s diffuse gas , which also lowers its temperature .    to demonstrate this difference",
    "more explicitly in our cosmological runs , we performed special test simulations of a @xmath94 box with @xmath95 sph particles / cells . in fig .",
    "[ fig : gas_balance ] , we show the sum of the total amount of star - forming gas mass and stellar mass in this box as a function of redshift .",
    "we note that an sph particle / cell is star - forming if its density is higher than the threshold of the subresolution star formation model .",
    "the solid lines show the result of calculations with our standard star formation prescription , i.e.  these simulations are equivalent to the main runs presented in the paper . however , for the dashed lines we turned off the creation of stellar particles , keeping everything else the same . in this case , the cold gas accumulates in the galaxies and is supported by the effective equation of state expected for gas at these densities , except that the gas is not depleted and does not turn into stars at the normal rate . for these runs ,",
    "the mass in the figure therefore refers to the total amount of star - forming gas in these simulations ( no stars are present ) .",
    "interestingly , the solid and dashed curves overlap well for gadget ( blue ) in fig .  [",
    "fig : gas_balance ] , showing that once gas has overcome the density threshold it will never return to lower density . stripping of gas out of galaxies does not appear to happen in any significant way , otherwise we would expect that the run without star formation should end up with a smaller amount of collapsed baryons .",
    "instead , the sph result is consistent with no stripping at all , i.e.  once a gas particle has cooled , it never returns to lower density even though the galaxy may be subject to substantial shear flows upon halo infall .",
    "this behaviour has also been found by he  & springel ( 2011 , submitted ) in a comparison of galaxy - wind interactions in sph and the vph technique @xcite .",
    "for arepo the situation is very different . as fig .",
    "[ fig : gas_balance ] shows , the sum of stellar mass and star - forming gas mass is larger than the amount of star - forming gas in the run without star particle creation . here",
    "the relevant fluid instabilities for stripping ( like the kelvin - helmholtz instability ) are significantly better resolved and facilitate a substantial mass loss of infalling overdense blobs / subhaloes . because of this , the sum of the mass of stars and of star - forming gas is higher in arepo for the run with star particle creation than for the fiducial run where this is suppressed . in the latter simulation ,",
    "there is simply more gas around that can be stripped again , while in the run with star particle creation , baryons that have been converted to stars do of course not suffer from fluid instabilities anymore .",
    "apart from affecting the cooling in haloes , this difference in the stripping and mixing efficiency also modifies the dynamical friction timescale of infalling gas clumps , as we examine in more detail in paper iii of this series .",
    "various modifications have been proposed to the conventional implementation of sph as in gadget to improve its reliability in certain cases .",
    "for example , changes to the computation of smoothed pressure gradients @xcite or the addition of an artificial thermal conductivity to the equations of motion ( e.g. * ? ? ?",
    "* ) enable sph to better handle shearing interfaces and the onset of kelvin - helmholtz instabilities . also , a number of studies focused on the development of improved artificial viscosity parameterisations in sph codes @xcite , with the goal of reducing the numerical viscosity away from shocks .",
    "given the results presented in this paper , it is tempting to argue that one or several of these modifications of `` standard sph '' may lead to much better agreement with the moving - mesh results or even resolve the discrepancies . while we can not exclude this possibility , we note the above refinements are ad hoc in the sense that they are designed to mitigate against particular problems in some circumstances , and may have unwanted side - effects in other situations . while these side - effects may often be benign ,",
    "the proposed modifications of sph do not address other , more generic problems with this technique . in this section , we summarise these issues in order to put our findings into context with the recent literature on sph techniques .",
    "one issue that has rarely been discussed in the cosmological community concerns the convergence properties of sph .",
    "this is manifested in at least two ways , the first having to do with local smoothed estimates in sph , and the second is related to the fact that sph is not formally lagrangian .",
    "below , we first address the question of under what conditions convergence is expected in sph and how this influences the relation between spatial resolution and the total particle number .",
    "then , we discuss the pseudo - lagrangian character of sph and its implications for defining convergence with this method .",
    "finally , we briefly suggest ways in which these issues might be dealt with . incidentally",
    ", they all would have the effect of making sph resemble a moving - mesh scheme like arepo .",
    "box with @xmath95 sph particles / cells .",
    "the @xmath96-axis shows the total amount of star - forming gas and stellar mass in the simulation volume .",
    "solid lines show the result of a calculation with our standard star formation prescription . for the dashed lines we turned off the creation of stellar particles ;",
    "i.e. there are no stars formed but the gas still cools and is supported by the multiphase equation of state .",
    "the solid and dashed curves overlap well for gadget , which shows that once gas overcomes the density threshold it either forms stars or stays above the threshold .",
    "there is no loss of star - forming gas mass . for arepo , the amount of stellar mass and star - forming gas mass is larger than the amount of star - forming gas if stellar particle creation is turned off",
    "this is because arepo resolves fluid instabilities better and therefore allows significant gas mass loss from infalling satellites . here",
    "gas that once has been above the threshold for star formation may well be mixed with halo gas and reach much lower densities again . on the other hand ,",
    "once stellar particles are created from dense gas , the total amount of baryonic material that can be lost from subhaloes is reduced , which explains the difference seen in the two moving - mesh calculations.,scaledwidth=47.5% ]      for a real fluid , we define the density , @xmath97 , to be a continuous function of space , determined by averaging over many molecules locally around @xmath98 . in order to formulate a discrete sph counterpart to this ( and this applies to all fluid variables , as well as the equations of motion ) a two - step procedure is applied .    first , we introduce a smoothed version of the original density field , @xmath99 , by convolving @xmath97 with a smoothing kernel @xmath100 according to @xmath101 where the integral is over all space and @xmath102 is the smoothing length .",
    "second , the continuous smoothed field @xmath103 is replaced by a discrete quantity , @xmath104 , so that it can be represented computationally .",
    "this is done by regarding @xmath105 as a mass element @xmath106 and partitioning the fluid into a set of @xmath107 discrete mass elements so that the above integral can be approximated by a discrete sum : @xmath108 where @xmath109 is the mass of fluid element @xmath110",
    ", @xmath111 is its spatial location , and the expression allows different fluid locations / elements to have different smoothing lengths . in principle , the sum extends over all @xmath107 fluid elements .",
    "however , in order that the smoothed density @xmath112 approaches the continuum limit represented by @xmath97 , it is necessary that @xmath100 is spatially localised .",
    "so in practice a localised kernel with compact support is adopted , implying that the discrete sum extends not over all @xmath107 fluid elements but over a subset @xmath113 of those neighbouring a certain point in space .",
    "now , we can ask about the conditions that must be satisfied for the smoothed , discrete version of the density field to asymptote to the actual continuum limit .",
    "that is , under what circumstances is the following true ?",
    "@xmath114 consider the second of these requirements first . in order for @xmath115",
    "we must have @xmath116 as @xmath117 , as implied by the definition of @xmath112 in the above integral .",
    "this also requires that @xmath118 , otherwise there exist not enough particles around a given spatial location to form smoothed averages .",
    "turning to the first requirement above , @xmath119 will be satisfied only if at the same time we enforce the condition @xmath120 .",
    "this has not been emphasised in the cosmological literature , but from the defining relation above for @xmath121 it is clear that the discrete approximation will not asymptote to the smoothed density field unless this limit is taken . or , to put it another way ,",
    "if the number of neighbours is held fixed as @xmath122 , there will be a constant source of error present on the most well - resolved scales that will not vanish as the resolution and number of particles is increased indefinitely ( see also * ? ? ?",
    "* ; * ? ? ?",
    "( for a discussion of this requirement in the context of elasticity , see e.g. @xcite . )",
    "to the best of our knowledge , the optimal way to enforce this requirement has not been established . however , there is little doubt that this must be addressed in order that sph provides properly convergent solutions , as argued recently by @xcite : `` when performing a convergence study using sph , it is important to vary both the number of particles ... as well as the ratio of smoothing length to particle spacing [ to increase the number of neighbours ] .",
    "[ otherwise ] the error due to the summation interpolant [ remains ] constant [ as the total particle number is increased ] . ''",
    "we emphasise that this requirement is not fundamentally an issue with sph , but simply reflects the fact that a numerical approximation to an integral in the form of a discrete sum will not converge to the true answer unless the number of points where the integrand is sampled is made larger .",
    "an increase in the number of neighbours is also warranted to reduce the gradient errors in sph , which give in fact rise to a sizable `` zero - th order error '' @xcite .",
    "these gradient errors seriously degrade the accuracy of sph in subsonic flow problems and are a primary cause for problems in the representation of subsonic turbulence @xcite . however , in practice , simply increasing the number of neighbours is met by a serious obstacle , because it invokes the so - called clumping instability in which particles located in the inner parts of the kernel are pushed together by the pressure forces of the surrounding particles , forming little clumps that frustrate attempts to reduce the error of the kernel sums in this way . partially circumventing this problem and allowing a higher neighbour number requires different kernel shapes than are commonly employed @xcite , but such kernels merely have different stability bands that still impose severe restrictions on the number of neighbours that may be used .",
    "in essence , due to the clumping instability , establishing formally convergent sph solutions is an unsolved problem because the path of increasing the neighbour number is blocked in practice .",
    "the requirement that the number of neighbours should increase to reduce errors as the total number of particles is made larger has also serious implications for the efficiency of sph . as an example , consider a uniform fluid in a cube of side - length @xmath123 represented by @xmath107 sph particles .",
    "( for more general circumstances the argument generalises if we think about small scales on which the fluid properties are nearly uniform . )",
    "the mean separation between the particles , @xmath124 , is @xmath125 if we take @xmath126 , as has been done conventionally in sph codes used in cosmology , then the smoothing length will shrink in proportion to @xmath124 and , so , the number of neighbours will be nearly constant . in a sense , this maximises the spatial resolution , but leaves a fixed source of error in the discrete sums @xcite , so this path is in principle not appropriate for achieving proper convergence with sph .",
    "if , instead , we set @xmath127 then the fundamental relation between @xmath107 and @xmath102 becomes @xmath128 .",
    "what are the conditions on @xmath129 so that we can meaningfully construct a procedure that converges numerically ? clearly , @xmath130",
    ", otherwise @xmath102 will not decrease more slowly than @xmath124 as @xmath107 increases . also , we must have @xmath131 , as the choice @xmath132 would mean that the spatial resolution is constant , independent of @xmath107 .",
    "the optimal value for @xmath129 is undetermined .",
    "one physically appealing choice would be @xmath133 , because then @xmath102 would be the geometric mean between the mean interparticle separation , @xmath124 , and the size of the system , @xmath123 . in that case",
    ", the relation between @xmath107 and @xmath102 becomes @xmath134 , implying a steeply rising computational cost with resolution .",
    "it is possible that a slightly larger value of @xmath129 could be preferred in terms of cpu costs , but it is clear , however , that in order to extend the dynamic range in spatial scales resolved by sph in a way that guarantees eventual convergence , it is absolutely necessary to increase the number of particles more aggressively than has been advocated previously .",
    "the dilemma , of course , is that the clumping instability makes this highly problematic .    ignoring the clumping issue for the moment , the implications for the convergence rate of sph are in any case important . when the common practice in the field is followed and the number of neighbours is held constant , reported a global l1 error for a vortex flow ( the gresho test ) that scales as @xmath135 with resolution , as opposed to @xmath136 for arepo .",
    "we can then ask how the ratio of the cpu - time cost of simulations with the two schemes varies with the size of the error . for simulations in 3d , the computational cost scales for both codes as @xmath137 , where three powers of @xmath102 come from the spatial dimensions , and one additional power enters due to the reduction of timesteps for better resolution .",
    "this then implies that the cost ratio scales as @xmath138 with the error of the calculation .",
    "reducing the error by a factor of 10 requires therefore about a @xmath139 times higher effort in sph than in arepo .",
    "this conclusion is problem dependent and can also be affected by specific details of the sph algorithm , like the kernel shape . however , the question of computational efficiency of different numerical schemes is best phrased in terms of such convergence rate comparisons . here",
    "the monte carlo character in the approximation of the sph kernel sum invariably introduces a serious disadvantage for sph compared with the moving mesh approach , as outlined above .",
    "a related conclusion , but focusing on the efficiency impact of the artificial viscosity parameterisation in sph , was reached by @xcite .",
    "if the goal is a representation of subsonic turbulence with a certain reynolds number @xmath140 , they showed that the computational cost of sph scales at least as @xmath141 .",
    "in contrast , in the mesh - based treatment of arepo , the dissipation scale is tied to the mesh resolution , implying a computational cost for reaching a certain reynolds number that scales as @xmath142 .",
    "given that our cosmological simulations with arepo are only about @xmath143 slower than gadget for simulations involving self - gravity , for the same number of resolution elements , this means that at a given computational cost , arepo resolves much larger reynolds numbers than sph .",
    "in fact , to reach the same reynolds numbers as in our present moving - mesh simulations , it appears plausible that a factor @xmath144 more sph particles than arepo cells would be required .      .",
    "the middle panels show the true gas distribution of the disk a short amount of time later . for solid body rotation",
    ", the initial blue region retains its shape .",
    "this is different for the differentially rotating disk , where the blue gas patch experiences the shear in the disk and gets distorted .",
    "the panels on the right - hand side show the corresponding sph representations of the disk at this later time .",
    "clearly , the distortion in the differentially rotating case is not captured correctly by sph since the smoothing region does not change in shape .",
    "sph is therefore only pseudo - lagrangian , as opposed to arepo , which implements a quasi - lagrangian scheme that allows for mass exchange between cells in a manner consistent with the hydrodynamic equations of motion .",
    "the dashed circle in the bottom middle panel illustrates a re - partitioning of the gas into sph particles at the updated time and demonstrates why mixing is suppressed in sph at the resolution scale ( see text).,title=\"fig:\",scaledwidth=47.5% ] 0.25 cm .",
    "the middle panels show the true gas distribution of the disk a short amount of time later . for solid body rotation",
    ", the initial blue region retains its shape .",
    "this is different for the differentially rotating disk , where the blue gas patch experiences the shear in the disk and gets distorted .",
    "the panels on the right - hand side show the corresponding sph representations of the disk at this later time .",
    "clearly , the distortion in the differentially rotating case is not captured correctly by sph since the smoothing region does not change in shape .",
    "sph is therefore only pseudo - lagrangian , as opposed to arepo , which implements a quasi - lagrangian scheme that allows for mass exchange between cells in a manner consistent with the hydrodynamic equations of motion .",
    "the dashed circle in the bottom middle panel illustrates a re - partitioning of the gas into sph particles at the updated time and demonstrates why mixing is suppressed in sph at the resolution scale ( see text).,title=\"fig:\",scaledwidth=47.5% ]    sph is often referred to as a lagrangian algorithm , but this is not formally correct and we suggest it is perhaps better to characterise it as a `` pseudo - lagrangian '' technique . to appreciate the reasons for this ,",
    "consider the following example , which also highlights that this distinction is intimately related to issues of ( suppressed ) mixing in sph .",
    "suppose gas is revolving in a thin disk on circular orbits , and imagine that the gas is partitioned at some instant into regions that are then represented by sph particles , with the smoothing done over a circular area .",
    "each sph particle will comprise gas from an area around its centre , extending outwards in radius of order the local smoothing length , as shown for one such sph particle in the left panels of fig .",
    "[ fig : sph_scheme ] at time zero .",
    "consider now how the system will look like a short time later , @xmath145 , after the disk has rotated by a small angle .",
    "if the disk is in solid body rotation , as in the upper panels of fig .",
    "[ fig : sph_scheme ] , the fluid initially contributing to the sph particle will occupy an area identical to the smoothing region of the sph particle at time @xmath145 , as indicated by comparing the `` true '' situation in the upper middle panel with the sph version in the upper right panel . in this case , the sph representation is faithful to the actual equations of motion because the fluid contributing to the sph particle at time zero is the same as that at @xmath62 , and the region bounded initially by the sph smoothing volume has not changed its shape .    however , suppose instead that the disk is rotating differentially , turning around more rapidly in the inner parts than in the outer ones ( lower panels of fig .",
    "[ fig : sph_scheme ] ) .",
    "the `` true '' situation shown in the middle panel tells us that the gas contributing to the area bounded by the sph smoothing volume at time zero will be stretched out owing to shear .",
    "however , in the sph formulation , shown in the lower right panel , the material initially in the sph smoothing volume is forced to remain tied to this area and is not allowed to shear , inconsistent with the equations of motion of the real fluid .",
    "a true lagrangian picture would allow fluid elements to be deformed in the presence of shear , but this is inhibited by the sph approach on scales smaller than those set by the smoothing procedure .",
    "hence , while sph retains some characteristics of a lagrangian method , it does not evolve the fluid entirely in a manner consistent with the equations of motion and should , in this sense , be termed `` pseudo - lagrangian . ''",
    "unfortunately , the error incurred by the approximations inherent to the sph formalism is highly problem dependent and can not be estimated based solely on the discretisation procedure .",
    "for example , there is no error made in the case of a disk in solid body rotation , or for a uniform disk rotating differentially , or for gas motions that are limited to expansion or contraction in three - dimensions .",
    "however , this is not true for shearing flows involving fluids with distinct internal properties ; here the implicit `` remapping '' involved in enforcing a spherical shape for the sph smoothing volume , which would change the local composition of the internal properties , is ignored .",
    "this limitation is ultimately the reason why sph does not handle mixing accurately , as we illustrate in the bottom , middle panel of fig .",
    "[ fig : sph_scheme ] .",
    "suppose at the updated time we were to re - partition the gas into new sph particles , as indicated by the dashed circle in this frame .",
    "the gas associated with this particle should include gas from the original particle , but also gas from the surrounding flow .",
    "this would allow mixing to occur between the gas in the original particle and nearby parts of the flow , but is not allowed to occur in sph , by construction .",
    "we note that arepo does not suffer from this defect . in this code",
    ", cells are not allowed to become arbitrarily distorted , in the interests of efficiency and accuracy , and so arepo is also not formally lagrangian .",
    "however , it still evolves fluids correctly when deviations from strict lagrangian behaviour occur by allowing for mass exchange between cells , in a manner consistent with the equations of motion .",
    "therefore , this method should be termed `` quasi - lagrangian . ''",
    "a related issue arises in the context of n - body simulations of collisionless systems .",
    "there , a six - dimensional phase fluid is partitioned into particles of fixed size that move through space in a manner determined by the equations of motion . because the phase fluid initially associated with a particular particle is always tied to that particle",
    ", the small - scale dynamics of the system will not be represented properly .",
    "however , in this case , unlike for the example discussed above , forces are strictly long - range and are less prone to inaccuracies in the small - scale distribution of the material than pressure gradients or viscosity . in that sense ,",
    "the local distortions in the phase space fluid have fewer dynamical consequences than for a hydrodynamical fluid in three dimensions .",
    "nevertheless , if an accurate description of the small - scale structure of collisionless systems is essential , these effects must be accounted for at some level ( e.g. * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "we should emphasise that whether the limitations inherent to sph lead to significant inaccuracies in the solution depend in detail on the circumstances .",
    "sph can be expected to provide reliable results for flows that are kinetically dominated , or if the motions are controlled mainly by long - range forces . in these situations , errors in the local quantities",
    "are sub - dominant .",
    "for example , @xcite show that while sph does not accurately describe subsonic turbulence , in the supersonic regime , when the flow energy is mainly kinetic , gadget and arepo give similar answers . also , comparisons between sph and amr codes have yielded compatible results for the structure of the intergalactic medium , as reflected in the properties of the lyman - alpha forest ( e.g. * ? ? ? * ) . at these low densities",
    ", gravity dominates over internal energy and , moreover , the fluid is not subject to strong shear , so the above considerations are not critical . even in some cases where shear is present",
    ", the approximations underlying sph will not be significant , provided that gravitational forces are more important than local ones and the relevant evolution in flow properties occurs rapidly .",
    "hayward et al .",
    "( 2012 , in preparation ) have demonstrate this explicitly by simulating galaxy mergers using both gadget and arepo .",
    "they find that when the gas is treated using an effective equation of state , star formation rates during the course of a merger are nearly identical between these two codes .",
    "thus , conclusions drawn from studies of galaxy collisions with sph , such as the stellar profiles of merger remnants and their evolution ( e.g. * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "* ) or the survivability of disks during mergers @xcite , are likely robust to variations in the hydro solver .",
    "unfortunately , this good level of agreement does not extend to the more complex flows associated with halos in cosmological environments , as we highlight in this paper .",
    "there , various phases of gas will be present in close proximity , often shearing relative to one another , leading to errors in simulations done with sph like those we have identified here .",
    "also , in the hydrostatic atmospheres of halos the hydrodynamic forces are comparable to gravity forces , and the subsonic turbulence present in these regions is affected by gradient errors in sph . without a formal convergence criterion ,",
    "the consequences of these errors are difficult to assess , because even if a solution may plateau as the number of sph particles is increased , this by no means guarantees that the correct answer is being obtained . in particular , the solution may exhibit `` false convergence , '' appearing to reach a converged solution , while fixed sources of error from e.g. summation interpolant are still present @xcite . a case in point",
    "is the long - standing discrepancy identified for the central cluster entropy predicted by non - radiative sph and mesh - based simulations , first identified in the santa barbara cluster comparison project @xcite .",
    "the above considerations motivate thinking about ways to cure the defects inherent to sph so that it can provide solutions of comparable accuracy and resolution to those obtained with a moving mesh approach like arepo .",
    "for example , the artificial viscosity typically used in sph codes to handle shocks could , in principle , be eliminated by incorporating a riemann solver into sph .",
    "pioneering efforts along these lines have been made by @xcite and @xcite .",
    "however , these implementations solve the riemann problem for each particle - neighbour pair , and this approach will become prohibitively expensive as long as the smoothing procedure requires averaging over an increasingly large number of neighbours to achieve convergence as the total particle number is increased .",
    "we note that alternatively a grid could be introduced into sph just for the purposes of solving the riemann problem around each particle .",
    "this grid would necessarily have to be adaptive , and hence resemble the voronoi tessellation used in arepo .    in order to eliminate the pseudo - lagrangian character of sph and",
    "allow for fluid elements to become distorted on scales small compared to a few smoothing lengths , as should occur in e.g.  shearing flows , it is necessary to allow for mass exchange between particles in a manner consistent with the equations of motion .",
    "this would have the added benefit of eliminating the mixing problem in sph .",
    "first suggestions in this direction have recently been made @xcite , but the best way to formulate such mixing terms is not clear .",
    "one possibility to unambiguously calculate the required mass flux between particles would be to utilise some kind of grid .",
    "again , this grid would need to be adaptive , like the unstructured mesh in arepo , reinforcing the notion that our new moving - mesh approach quite naturally addresses several of the generic issues with sph .",
    "in this study , we have presented the first cosmological hydrodynamical simulations of structure formation carried out with the novel arepo moving - mesh code . compared to the widely employed sph technique",
    ", this method promises an important gain in accuracy in the numerical treatment of gas dynamics for similar computational costs . in order to understand the implications of these differences for galaxy formation simulations , we have evolved the same initial conditions both with arepo and the well - established sph code gadget .",
    "both codes share the same high - resolution gravity solver , and incorporate an identical radiative cooling and star formation model .",
    "differences in the outcome are hence tied to systematics of the hydrodynamical solvers that are used .",
    "it is the primary goal of our paper to identify the main differences and their magnitude , as well as providing evidence for the primary sources of potential discrepancies .",
    "galaxies at @xmath5 in the halo mass range @xmath146 to @xmath147 . clearly , the gas disks forming in the arepo simulations are typically significantly larger than those in the corresponding sph runs . , scaledwidth=47.5% ]    to achieve this goal , we have considered a primary set of simulations in boxes of @xmath32 that include a basic treatment of galaxy formation physics , at various resolutions ranging from @xmath83 to @xmath148 particles / cells . in addition , we have carried out a few auxiliary simulations either in smaller boxes , or of non - radiative type , in order to more clearly measure particular numerical effects . for reasons discussed in section  2.3",
    ", we have chosen to perform the comparisons between the codes at the same initial mass resolution , because then the computational costs are similar .",
    "our principle findings may be summarised as follows :    * the overall distribution of gas in density and temperature is broadly in agreement between sph and arepo , but there are some subtle and important differences .",
    "in particular , the mean mass - weighted temperature in arepo is slightly smaller than in gadget .",
    "also , the hot gas extends to somewhat lower density in gadget and hence occupies a larger volume fraction . * the cosmic star formation rate density peaks at similar values , but at slightly lower redshifts in arepo . at high redshift and at high resolution , the sfrs between the two codes are in good agreement , but towards lower redshift there are significantly stronger cooling flows in arepo , causing a correspondingly larger star formation rate .",
    "this difference occurs primarily in haloes with mass larger than  @xmath149 .",
    "* we find that the two codes differ significantly in the dissipative heating rates within haloes , with arepo producing more dissipation in the halo infall regions , whereas sph produces higher dissipative heating throughout most of the outer regions of virialised haloes .",
    "this difference is mainly responsible for the higher temperatures found in the sph simulations , and the correspondingly weaker cooling .",
    "we argue that this dissipation in sph is likely to be of spurious nature , and is a combination of viscous damping of sph s inherent noise and the unphysical damping of subsonic turbulence injected into haloes in the infall regions . *",
    "visual comparison of simulated galaxies shows considerably larger stellar disks and more extended and disky stellar distributions in arepo compared with gadget . also , the halo gas surrounding the galaxies looks smoother and less clumpy in arepo .",
    "[ fig : scale_radii ] shows gas surface density disk scale length radii obtained from exponential surface density fits of more than @xmath150 galaxies at @xmath5 in the halo mass range @xmath146 to @xmath151 .",
    "this clearly demonstrates that the gas disks forming in the arepo simulations are typically significantly larger than those in the corresponding sph runs .",
    "we further note that the gas surface density of disk galaxies in the arepo simulations follow very closely exponential profiles , which is typically not the case for the sph runs .",
    "a more detailed analysis is presented in @xcite .",
    "we note that the large disks in the arepo simulations result even without strong feedback in the form of galactic winds or modifications of the star formation prescription .",
    "this is also demonstrated in simplified test simulations in paper iii .",
    "the larger extent of disk galaxies is also demonstrated in paper ii , where we do not assume exponential profiles , but rather use a cut in surface density to determine a characteristic size .",
    "we also independently calculated half - mass radii , which show the same trends .",
    "all these results confirm the findings reported in fig .",
    "[ fig : scale_radii ] , i.e.  that arepo produces in general larger disks than gagdet .",
    "the above findings clearly suggest that there are significant quantitative differences caused in galaxy formation simulations by the choice of hydrodynamical technique .",
    "it appears that the limited accuracy of sph for subsonic flow phenomena such as kelvin - helmholtz instabilities or subsonic turbulence induces important differences in the predicted properties of galaxies at low redshift , affecting both their morphology and stellar mass . because of the accuracy problems of sph for certain subsonic test problems it appears that sph can not be expected to reach highly accurate results in all regimes relevant for cosmic structure formation . at the same time",
    ", arepo performs significantly better on these same problems , and yields generally a smaller error norm and higher convergence rate when scrutinised against problems with known analytic solutions .",
    "we are hence confident that the arepo results presented in this paper entail a more faithful treatment of cosmological hydrodynamics , especially in view of the discussion in section  5.3 .",
    "it is also reassuring that the arepo runs improve the predicted morphologies of simulated galaxies , as our preliminary analysis suggests . in paper",
    "ii of this series we will back up this finding with a detailed analysis of the galaxy properties .",
    "finally , in paper iii we provide a more detailed analysis of the relevant numerical effects responsible for the differences in mixing and cooling .",
    "the body of these results makes it clear that arepo simulations provide a significant opportunity for the development of next generation models of galaxy formation that promise to achieve a so - far unknown combination of accuracy , dynamic range , and faithfulness to the relevant physics .",
    "the simulations in this paper were run on the odyssey cluster supported by the fas science division research computing group at harvard university .",
    "scaling tests were done on the ranger cluster at the texas advanced computing center ( tacc ) .",
    "we thank paul torrey for allowing us to show fig .  [",
    "fig : scale_radii ] and elena donghia , patrik jonsson , andrew macfadyen , diego j. munoz for useful discussions .",
    "we also thank the anonymous referee for helpful comments .",
    "ds acknowledges nasa hubble fellowship through grant hst - hf-51282.01-a .",
    "dk acknowledges support from nasa through hubble fellowship grant hsthf-51276.01-a .",
    "t. , 2011 , , 413 , 271    t. , hahn o. , kaehler r. , 2011 , arxiv e - prints    o. , moore b. , stadel j. , potter d. , miniati f. , read j. , mayer l. , gawryszczak a. , kravtsov a. , nordlund  . , pearce f. , quilis v. , rudd d. , springel v. , stone j. , tasker e. , teyssier r. , wadsley j. , walder r. , 2007 , , 380 , 963    o. , teyssier r. , moore b. , 2011 , , 410 , 1391    d.  s. , 1995 , journal of computational physics , 121 , 357    j. , hut p. , 1986",
    ", , 324 , 446    j.  e. , hernquist l. , 1992 , , 30 , 705    j.  e. , hernquist l. , 1996 , , 471 , 115    j.  e. , hernquist l.  e. , 1991 , , 370 , l65",
    "m.  r. , burkert a. , 1997 , , 288 , 1060    a. , springel v. , 2011 , arxiv e - prints    c.  m. , 2006 , reports on progress in physics , 69 , 3101    t. , krongauz y. , dolbow j. , gerlach c. , 1998 , international journal for numerical methods in engineering , 43 , 785    a.  j. , 2010a , arxiv e - prints , 1008.1786    a.  j. , 2010b , , 495 , 33    a.  j. , cole s. , frenk c.  s. , baugh c.  m. , lacey c.  g. , 2000 , , 311 , 793    m.  j. , colella p. , 1989",
    ", journal of computational physics , 82 , 64    g. , hooper d. , silk j. , 2005 , , 405 , 279    g.  r. , faber s.  m. , primack j.  r. , rees m.  j. , 1984 , , 311 , 517    j.  r. , cole s. , efstathiou g. , kaiser n. , 1991 , , 379 , 440    m. , springel v. , white s.  d.  m. , jenkins a. , 2010 , , 406 , 896    g.  l. , norman m.  l. , 1998 , , 495 , 80    s. , porciani c. , 2011 , , 411 , 1678    d.  c. , xu h. , norman m.  l. , li h. , li s. , 2010 , , 186 , 308    t.  j. , dutta s.  n. , di matteo t. , hernquist l. , hopkins p.  f. , robertson b. , springel v. , 2006 , , 650 , 791    r.  a. , theuns t. , dalla vecchia c. , eke v.  r. , frenk c.  s. , jenkins a. , kay s.  t. , peacock j.  a. , pearce f.  r. , schaye j. , springel v. , thomas p.  a. , white s.  d.  m. , wiersma r.  p.  c. , 2009 , , 399 , 1773    d.  j. , springel v. , white s.  d.  m. , de lucia g. , frenk c.  s. , gao l. , jenkins a. , kauffmann g. , navarro j.  f. , yoshida n. , 2006 , , 365 , 11    l. , dehnen w. , 2010 , , 408 , 669    r. , cen r. , ostriker j.  p. , bryan g.  l. , hernquist l. , katz n. , weinberg d.  h. , norman m.  l. , oshea b. , 2001 , , 552 , 473    r. , hernquist l. , katz n. , weinberg d.  h. , 1999 , , 511 , 521    t. , colberg j. , springel v. , hernquist l. , sijacki d. , 2008 , , 676 , 33    t. , springel v. , hernquist l. , 2005 , , 433 , 604    j. , kuhlen m. , madau p. , zemp m. , moore b. , potter d. , stadel j. , 2008 , , 454 , 735    k. , borgani s. , murante g. , springel v. , 2009 , , 399 , 497    k. , grasso d. , springel v. , tkachev i. , 2005 , , 1 , 9    k. , jubelgas m. , springel v. , borgani s. , rasia e. , 2004 , , 606 , l97",
    "k. , vazza f. , brunetti g. , tormen g. , 2005 , , 364 , 753    e. , springel v. , hernquist l. , keres d. , 2010 , , 709 , 1138    e. , vogelsberger m. , faucher - giguere c .- a .",
    ", hernquist l. , 2010 , , 725 , 353    e. , vogelsberger m. , hernquist l. , 2011 , in prep    a.  r. , schaye j. , kay s.  t. , dalla vecchia c. , battye r.  a. , booth c.  m. , 2010 , , 405 , 2161    j. , komatsu e. , nolta m.  r. , spergel d.  n. , larson d. , hinshaw g. , page l. , bennett c.  l. , gold b. , jarosik n. , weiland j.  l. , halpern m. , hill r.  s. , kogut a. , limon m. , meyer s.  s. , tucker g.  s. , wollack e. , wright e.  l. , 2009 , , 180 , 306    d.  j. , hu w. , 1999 , , 511 , 5    c. , lidz a. , zaldarriaga m. , hernquist l. , 2009 , , 703 , 1416    c.  s. , white s.  d.  m. , bode p. , bond j.  r. , bryan g.  l. , cen r. , couchman h.  m.  p. , evrard a.  e. , gnedin n. , jenkins a. , khokhlov a.  m. , klypin a. , navarro j.  f. , norman m.  l. , et  al . , 1999 , , 525 , 554    l. , springel v. , white s.  d.  m. , 2005 , , 363 , l66    r.  a. , monaghan j.  j. , 1977 , , 181 , 375    n.  y. , 1995 , , 97 , 231    f. , brook c. , mayer l. , brooks a. , rhee g. , wadsley j. , jonsson p. , willman b. , stinson g. , quinn t. , madau p. , 2010",
    ", , 463 , 203    f. , willman b. , mayer l. , brooks a. , stinson g. , valenzuela o. , wadsley j. , quinn t. , 2007 , , 374 , 1479    j. , callegari s. , madau p. , mayer l. , 2011 , arxiv e - prints    q. , white s. , boylan - kolchin m. , de lucia g. , kauffmann g. , lemson g. , li c. , springel v. , weinmann s. , 2011 , , p.  164",
    "k. , luki z. , fasel p. , habib s. , warren m.  s. , white m. , ahrens j. , ankeny l. , armstrong r. , oshea b. , ricker p.  m. , springel v. , stadel j. , trac h. , 2008 , computational science and discovery , 1 , 015003    l. , 1987 , , 64 , 715    l. , katz n. , 1989 , , 70 , 419    l. , katz n. , weinberg d.  h. , miralda - escud j. , 1996 , , 457 , l51    s. , springel v. , 2010 , , 406 , 2289    r.  w. , eastwood j.  w. , 1981 , computer simulation using particles .",
    "mcgraw - hill    hopkins p.  f. , cox t.  j. , dutta s.  n. , hernquist l. , kormendy j. , lauer t.  r. , 2009 , , 181 , 135    hopkins p.  f. , hernquist l. , cox t.  j. , dutta s.  n. , rothberg b. , 2008 , , 679 , 156    hopkins p.  f. , hernquist l. , cox t.  j. , keres d. , wuyts s. , 2009 , , 691 , 1424    hopkins p.  f. , lauer t.  r. , cox t.  j. , hernquist l. , kormendy j. , 2009 , , 181 , 486    l. , schmidt w. , niemeyer j.  c. , merklein j. , 2011 , , 414 , 2297    s .- i .",
    ", 2002 , journal of computational physics , 179 , 238    a. , frenk c.  s. , white s.  d.  m. , colberg j.  m. , cole s. , evrard a.  e. , couchman h.  m.  p. , yoshida n. , 2001 , , 321 , 372    m. , springel v. , dolag k. , 2004 , , 351 , 423    m. , springel v. , enlin t. , pfrommer c. , 2008 , , 481 , 33    n. , hernquist l. , weinberg d.  h. , 1992 , , 399 , l109    n. , weinberg d.  h. , hernquist l. , 1996 , , 105 , 19    n. , weinberg d.  h. , hernquist l. , miralda - escude j. , 1996 , , 457 , l57",
    "g. , white s.  d.  m. , guiderdoni b. , 1993 , , 264 , 201    jr .",
    "r.  c. , 1998 , , 498 , 541    d. , vogelsberger m. , sijacki d. , springel v. , hernquist l. , 2011 , arxiv e - prints    a. , trujillo - gomez s. , primack j. , 2010 , arxiv e - prints    e. , et  al . , 2011 , , 192 , 18    l.  b. , 1977 , , 82 , 1013    j.  c. , hernquist l. , 1994 , , 437 , 611    j.  c. , hernquist l. , 1996 , , 464 , 641    n.  l. , mccarthy i.  g. , bower r.  g. , theuns t. , crain r.  a. , 2009a , , 395 , 180    n.  l. , mccarthy i.  g. , bower r.  g. , theuns t. , crain r.  a. , 2009b , , 395 , 180    j.  j. , 1992 , , 30 , 543    j.  j. , 2005 , reports on progress in physics , 68 , 1703    b. , ghigna s. , governato f. , lake g. , quinn t. , stadel j. , tozzi p. , 1999",
    ", , 524 , l19    b. , governato f. , quinn t. , stadel j. , lake g. , 1998 , , 499 , l5    j. , 1997 , journal of computational physics , 136 , 41    d. , springel v. , marcus r. , vogelsberger m. , hernquist l. , 2012 , arxiv e - prints    c. , katz n. , hernquist l. , weinberg d.  h. , dav r. , 2002 , , 571 , 1    g. , borgani s. , brunino r. , cha s .- h .",
    ", 2011 , , 417 , 136    t. , burkert a. , 2003 , , 597 , 893    k. , cen r. , hernquist l. , ostriker j.  p. , springel v. , 2005 , , 627 , 608    j.  f. , frenk c.  s. , white s.  d.  m. , 1996 , , 462 , 563    j.  f. , frenk c.  s. , white s.  d.  m. , 1997 , , 490 , 493    j.  f. , ludlow a. , springel v. , wang j. , vogelsberger m. , white s.  d.  m. , jenkins a. , frenk c.  s. , helmi a. , 2010 , , 402 , 21    b.  w. , bryan g. , bordner j. , norman m.  l. , abel t. , harkness r. , kritsuk a. , 2004 , arxiv astrophysics",
    "e - prints    b.  w. , nagamine k. , springel v. , hernquist l. , norman m.  l. , 2005 , , 160 , 1    f.  r. , jenkins a. , frenk c.  s. , colberg j.  m. , white s.  d.  m. , thomas p.  a. , couchman h.  m.  p. , peacock j.  a. , efstathiou g. , the virgo consortium 1999 , , 521 , l99",
    "u. , 1998 , , 115 , 19    w.  j. , et  al .",
    ", 2010 , , 401 , 2148    s. , et  al . , 1999 , , 517 , 565    m. , springel v. , 2010 , , p.  1851    c. , springel v. , enlin t.  a. , jubelgas m. , 2006 , , 367 , 113    w.  h. , schechter p. , 1974",
    ", , 187 , 425    d.  j. , 2008 , journal of computational physics , 227 , 10040    d.  j. , 2012 , journal of computational physics , 231 , 759    e. , sijacki d. , springel v. , 2008 , , 687 , l53    f.  a. , 2000 , progress of theoretical physics supplement , 138 , 609    j.  i. , hayfield t. , 2011 , arxiv e - prints    j.  i. , hayfield t. , agertz o. , 2010 , , 405 , 1513    j.  i. , lake g. , agertz o. , debattista v.  p. , 2008",
    ", , 389 , 1041    m.  j. , ostriker j.  p. , 1977",
    ", , 179 , 541    j.  a. , haehnelt m.  g. , viel m. , 2007 , , 374 , 196    a.  g. , filippenko a.  v. , li w. , treffers r.  r. , schmidt b.  p. , qiu y. , hu j. , armstrong m. , faranda c. , thouvenot e. , buil c. , 1999 , , 118 , 2675    b. , yoshida n. , springel v. , hernquist l. , 2004 , , 606 , 32    m. , monaghan j.  j. , 2011 , arxiv e - prints    c. , et  al . ,",
    "2011 , arxiv e - prints    c. , tissera p.  b. , white s.  d.  m. , springel v. , 2008 , , 389 , 1137    j. , dalla vecchia c. , booth c.  m. , wiersma r.  p.  c. , theuns t. , haas m.  r. , bertone s. , duffy a.  r. , mccarthy i.  g. , van de voort f. , 2010 , , 402 , 1536    p. , finoguenov a. , miniati f. , bhringer h. , briel u.  g. , 2004 , , 426 , 387    i. , schmitt d. , 1981 , , 97 , 373    d. , springel v. , di matteo t. , hernquist l. , 2007 , , 380 , 877    d. , vogelsberger m. , keres d. , springel v. , hernquist l. , 2011 , arxiv e - prints    j. , 1977 , , 211 , 638    b. , sigurdsson s. , abel t. , 2008 , , 385 , 1443    v. , 2005 , , 364 , 1105    v. , 2010a , , 401 , 791    v. , 2010b , , 48 , 391    v. , di matteo t. , hernquist l. , 2005 , , 361 , 776    v. , hernquist l. , 2002 , , 333 , 649    v. , hernquist l. , 2003a , , 339 , 289    v. , hernquist l. , 2003b , , 339 , 312    v. , hernquist l. , 2005 , , 622 , l9    v. , wang j. , vogelsberger m. , ludlow a. , jenkins a. , helmi a. , navarro j.  f. , frenk c.  s. , white s.  d.  m. , 2008 , , 391 , 1685    v. , white s.  d.  m. , jenkins a. , frenk c.  s. , yoshida n. , gao l. , navarro j. , thacker r. , croton d. , helly j. , peacock j.  a. , cole s. , thomas p. , couchman h. , evrard a. , colberg j. , pearce f. , 2005 , , 435 , 629    j.  m. , norman m.  l. , 1992 , , 80 , 753    e.  j. , brunino r. , mitchell n.  l. , michielsen d. , hopton s. , pearce f.  r. , bryan g.  l. , theuns t. , 2008 , , 390 , 1267    r. , 2002 , , 385 , 337    a. , toomre j. , 1972 , , 178 , 623    p. , vogelsberger m. , sijacki d. , springel v. , hernquist l. , 2011 , arxiv e - prints    h. , sills a. , pen u. , 2007 , , 377 , 997    r. , 2011 , , 526 , a158    f. , brunetti g. , kritsuk a. , wagner r. , gheller c. , norman m. , 2009 , , 504 , 33    m. , bolton j.  s. , haehnelt m.  g. , 2009 , , 399 , l39    m. , lesgourgues j. , haehnelt m.  g. , matarrese s. , riotto a. , 2005 , , 71 , 063534    m. , helmi a. , springel v. , white s.  d.  m. , wang j. , frenk c.  s. , jenkins a. , ludlow a. , navarro j.  f. , 2009 , , 395 , 797    m. , white s.  d.  m. , 2011a , , p.  168",
    "m. , white s.  d.  m. , 2011b , , 413 , 1419    m. , white s.  d.  m. , helmi a. , springel v. , 2008 , , 385 , 236    j.  w. , veeravalli g. , couchman h.  m.  p. , 2008",
    ", , 387 , 427    d.  h. , dav r. , katz n. , hernquist l. , 2004 , , 601 , 1    s.  d.  m. , frenk c.  s. , 1991 , , 379 , 52    s.  d.  m. , rees m.  j. , 1978 , , 183 , 341    r.  p.  c. , schaye j. , theuns t. , dalla vecchia c. , tornatore l. , 2009 , , 399 , 574    y.  b. , 1970 , , 5 , 84",
    "for the different arepo runs . the black line shows the characteristics for a mesh where @xmath95 vertex points are randomly distributed .",
    "our implemented regularisation scheme tries to keep the maximum face angle small to avoid very distorted voronoi cells .",
    "this can clearly be seen in the upper left panel , where the random distribution deviates significantly from the regularised simulation distributions .",
    "the regularisation also affects the offset between geometrical centre of the cell and the vertex location shown in the bottom left panel .",
    "it is important to avoid too large offsets here since they introduce inaccuracies in the linear reconstruction step of the muscl - hancock scheme .",
    "the `` roundness '' of the cells is measured by @xmath152 , which is closer to @xmath153 ( the value of a sphere ) for the regularised simulations .",
    "again , this is a measure of the regularity of the voronoi mesh . for each face of a voronoi cell",
    ", arepo needs to solve a riemann problem .",
    "since each face is only solved once , the average number of riemann problems per cell is given by half the average number of its faces .",
    "the distribution of voronoi faces per cell is shown in the top right panel.,scaledwidth=48.0% ]    .",
    "our re-/derefinement scheme guarantees that the mass of a voronoi cell never deviates by more than approximately a factor of 2 from the target gas mass , which is in our case chosen to be the mean baryon mass of a cell for a uniform distribution assuming all cells have equal volume .",
    "bottom panel : distribution of masses of the stellar particles divided by the imposed target gas mass for the voronoi cells .",
    "our constraints for the mass of cells and our scheme for creating star particles result in a quite narrow mass distribution of stellar particles , where each stellar particle deviates at most a factor of @xmath154 from the desired target gas mass , except for a tiny number of lighter star particles , whose mass is however always larger than a quarter of the target gas mass . ,",
    "title=\"fig:\",scaledwidth=45.0% ] .",
    "our re-/derefinement scheme guarantees that the mass of a voronoi cell never deviates by more than approximately a factor of 2 from the target gas mass , which is in our case chosen to be the mean baryon mass of a cell for a uniform distribution assuming all cells have equal volume .",
    "bottom panel : distribution of masses of the stellar particles divided by the imposed target gas mass for the voronoi cells .",
    "our constraints for the mass of cells and our scheme for creating star particles result in a quite narrow mass distribution of stellar particles , where each stellar particle deviates at most a factor of @xmath154 from the desired target gas mass , except for a tiny number of lighter star particles , whose mass is however always larger than a quarter of the target gas mass .",
    ", title=\"fig:\",scaledwidth=45.0% ]    here we present some basic geometric properties of the voronoi mesh in our cosmological simulations . as discussed in section  2 , it is beneficial for the accuracy of arepo for the voronoi mesh to remain as regular as possible throughout the simulation . to this end ,",
    "the motion of the mesh vertices is slightly modified for highly distorted cells in order to obtain a mesh that has more `` roundish '' cells and is closer to a centroidal voronoi tessellation where geometrical the centres of the cells coincide with the vertex points of the individual voronoi cells .",
    "we can quantify the quality of a mesh in a similar way as was done in s10 .",
    "there , mesh quality indicators were calculated for a non - radiative simulation of a massive cluster ( the  santa barbara cluster  , * ? ? ?",
    "* ) , and it was demonstrated that the mesh indeed preserved its desired properties of reasonably round cells during the simulation .",
    "however , in this paper we have used a modified regularisation scheme based on the maximum face - angle , and we include cooling , star formation , and feedback , which drastically increases the dynamic range the simulations need to address .",
    "it is therefore important to verify whether our regularisation scheme performs sufficiently well in these more demanding simulations .    in fig .",
    "[ fig : cell_shape_statistics ] , we first show in the top left panel the maximum face angle distribution at @xmath5 for all arepo simulations .",
    "our new regularisation scheme should guarantee that these angles do not get too large .",
    "we have set up the regularisation such that the mesh is steered towards face angles smaller than @xmath10 . as the upper left panel of fig .",
    "[ fig : cell_shape_statistics ] demonstrates , the mesh indeed avoids very large face angles with a maximum in the distribution around the desired value , i.e.  the regularisation works as expected .",
    "the remaining three panels of fig .",
    "[ fig : cell_shape_statistics ] show distribution functions for the number of faces of the voronoi cells , for the distance @xmath155 of mesh - generating points to the geometric centres of their cell in units of the fiducial cell radius @xmath156 of each cell , and finally , for the @xmath157 parameter which measures how `` roundish '' each cell is ( here @xmath158 is the total surface area of a cell ) .",
    "the corresponding distributions for a random poisson sample of @xmath95 vertex points are shown as black lines in all panels , for comparison .",
    "note that we do not explicitly control the offset @xmath155 in our regularisation scheme , but the face angle criterion is of course correlated with this quantity .",
    "this allows us to obtain also quite small values for the distance of the geometric centre of the cell from the location of the mesh generating points .",
    "this is important for the numerical accuracy of the linear reconstruction .",
    "overall , our voronoi mesh is significantly `` rounder '' and much closer to a centroidal voronoi tessellation than the mesh of a random point distribution .",
    "the goal of our re- and derefinement strategy is to keep all cell masses close to a predefined target cell mass , which we have chosen to be the total baryonic mass in the box divided by the total number of cells at the initial time . in this way , a narrow mass spectrum for the formed stellar particles is obtained , and a straightforward and even - handed comparison to the sph calculations done with gadget becomes possible . as we have described in section  2 , we guarantee the approximately constant mass resolution by splitting cells that reach a mass larger than @xmath14 into two cells , while cells dropping in mass below @xmath159 are dissolved .",
    "we note that thanks to the lagrangian mesh motion in arepo , these re-/derefinement operations are invoked only rarely . in the top panel of fig .",
    "[ fig : cell_mass_statistics ] we demonstrate that the re- and derefinement scheme successfully keeps the cell masses in the desired mass range , yielding approximately a @xmath160-normal distribution around the target mass within the desired bounds .",
    "the mass distribution of stellar particles at @xmath5 is shown in the bottom panel of fig .",
    "[ fig : cell_mass_statistics ] .",
    "since our star formation implementation does not allow star particles to be formed with a mass larger than @xmath161 , the stellar particle mass distribution is cut off at that value . on the other hand ,",
    "the derefinement operations are constrained by the requirement that neighbouring cells can not both be derefined in the same time step . as a result , it is possible that some cells can temporarily have masses below @xmath19 for a few time steps , and hence also some star particles with masses smaller than this value may form in principle . to protect against the formation of unreasonably low mass star particles ,",
    "which may be prone to two - body effects , we however do not allow cells with mass less than @xmath17 to form any star particles , imposing a lower limit in the star particle mass distribution . as the bottom panel of fig .",
    "[ fig : cell_mass_statistics ] shows , star particles with masses between @xmath17 and @xmath19 make up only a tiny fraction , as desired , such that the suppression of the formation of extremely small star particles does not lead to any appreciable error . note that star - forming cells with a mass above @xmath162 will form stars with exactly @xmath12 , keeping the rest of the gas mass in the cell",
    "this explains the small spike in the distribution at that mass value .",
    "our analysis thus confirms that star particles with a narrow range of masses are formed , which helps to limit two - body relaxation effects and is well matched to the fixed gravitational softening we use for collisionless particles .",
    "the arepo simulations presented in this paper use an adaptive gravitational softening length with a lower floor for the gas , whereas the sph simulations done with gadget employ a fixed comoving softening length equal to the lower floor .",
    "we checked that this does not bias our results in any way . to demonstrate this point we show in fig .",
    "[ fig : sfr_hist_appendix ] the star formation history of the standard a_l20n128 simulation together with a run where we held the gravitational softening of the cells fixed at the same value as in the sph calculations .",
    "clearly this leads only to very minor differences in the star formation history .",
    "we also checked that disk half mass radii are not affected by this .",
    "as stated above this is due to the fact that star forming gas is pressurised by an effective eos of the ism and therefore gravitational softening effects do not play an important role in that regime .",
    "the mesh regularisation in arepo can be done in different ways and we have used a scheme that is based on the maximum face angle as described above .",
    "we have also done simulations with the original regularisation scheme presented in @xcite , which is based on the displacement of the geometric centre of the cell .",
    "the resulting star formation history for the a_l20n128 is also shown in fig .  [",
    "fig : sfr_hist_appendix ] .",
    "again this leads only to minor changes .",
    "we note that this difference becomes smaller with resolution and essentially vanishes .",
    "regularisation scheme differences are only relevant for very low resolution simulations .",
    "disk sizes are also not significantly affected by the details of the regularisation scheme . in fig .",
    "[ fig : gas_map_regul ] , we show gas density maps of a matched object in a_l20n128 and the a_l20n128 run , which features an alternative regularisation scheme .",
    "we stress again that l20n128 is our lowest resolution setup , and therefore most sensitive to details of how exactly the mesh is treated .",
    "but even in this regime the differences in the gas density maps are very small , and the size and overall extent of the gas disk do not change . note that due to the low resolution of l20n128 , individual voronoi cells are clearly visible in the map , highlighting the changes in mesh geometry and cell shapes induced by different regularisation schemes .",
    "the total runtime of our arepo simulations is in the worst case only about @xmath143 longer than the corresponding gadget run at the same nominal resolution .",
    "[ fig : runtime_stats ] shows in which code parts most of this cpu time is spent .",
    "obviously , the rather complex mesh construction and mesh update in arepo takes up a significant amount of time .",
    "however , in both codes the tree - pm based gravity calculation consumes a large amount of time , too , alleviating speed differences in the hydrodynamical solvers . in any case , we argue that arepo is actually surprisingly fast given the extremely complex mesh management operations that are required . given the small difference in raw speed , one can rightly describe the overall performance of both codes as similar .",
    "however , accounting for the fact that we here find that sph leads to a systematic and significant offset in the cooling rates of haloes at late times , as well as in galaxy sizes , the discussion of cpu time requirements at the same nominal resolution is a bit moot .",
    "ideally one would like to select the fastest method for a given desired accuracy , and as it appears , this can be reached with arepo more efficiently , whereas standard sph s systematic bias may be difficult or even impossible to overcome .",
    "the white parts in fig .  [ fig : runtime_stats ] account for the time spent in the time integration , star formation , cooling , and other minor contributions .",
    "we note that the i / o contribution is a bit larger than typical , because we wrote out snapshots at a very high frequency .",
    "and @xmath42 cores . in all runs an identical simulation size of @xmath84 in a @xmath163 box was used , with a @xmath164 fft for the long - range gravity calculation .",
    "the black solid line shows the total wall - clock time for a full step as a function of the number of cores used , averaged over three steps at high redshift .",
    "the code was run with all physics enabled , and all code overhead was included in these averages .",
    "the other measurements included in the figure give the times for the most important individual parts of the code , which are the voronoi mesh construction , the short - range and long - range gravity calculations , the hydrodynamical flux calculation , the domain decomposition and the tree construction .",
    "the black dashed line indicates the ideal strong scaling .",
    ", scaledwidth=48.0% ]     in these tests .",
    "we show in black the total times averaged for three full steps , and with different colours the most important code parts , as labelled .",
    "the top panel refers to a series with `` fully loaded '' nodes , where we use a load that is close to the maximum we can fit into the memory available per ranger core . in the bottom panel , we have reduced the load by a factor of 2 , allowing us to extend the tests to a core count of 6912 ( for such large mpi partition sizes , less application memory remains available on the specific machine ) . here",
    ", however , the communication costs in three parts of our code become quite substantial and lead to a noticeable negative impact of the scalability .",
    "the particle load of the top panel goes from @xmath165 to @xmath166 , whereas for the bottom panel it goes from @xmath167 to @xmath166 .",
    "the black dashed line indicates the ideal weak scaling .",
    ", scaledwidth=48.0% ]    in fig .",
    "[ fig : strongscaling ] , we show a strong scaling test of arepo , from @xmath168 to @xmath42 cores , carried out on ranger at the texas advanced computing center ( tacc ) . here , the simulation size has been kept constant at @xmath84 , and only the number of compute cores has been increased .",
    "the reported times have been averaged for three full time - steps at high redshift . in this regime ,",
    "gravity accounts for @xmath169 of the computational time , mesh - construction and mesh bookkeeping consumes @xmath170 of the time , while the calculation of the hydrodynamical fluxes amounts to @xmath171 of the time .",
    "the remainder is needed for miscellaneous items such as domain decomposition , radiative cooling and star formation . in order to clearly show the scalability of the most important different parts of our code",
    ", we have included separate measurements in fig .",
    "[ fig : strongscaling ] for long - range gravity ( by means of ffts ) , short - range gravity ( done through a tree - walk ) , the necessary tree construction , the mesh construction and management , the hydrodynamic flux calculations , and the domain decomposition .",
    "we see that the code shows quite good strong scaling , despite the tightly coupled nature of the system .",
    "some losses are in particular apparent for the mesh construction .",
    "these arise because the more cores are used , the larger the number of spatial domains in which the simulation volume is cut .",
    "this enlarges the surface area of domain boundaries , and as a result the cumulative `` ghost '' region volume in which the mesh has to be constructed twice on two neighbouring processes to ensure seamless consistency across the domain boundary .    for large - scale cosmological applications it is more important that the code parallelisation shows good weak scaling behaviour .",
    "gadget has been used for many large - scale simulations and we will demonstrate here that arepo performs also well in weak scaling tests . for these tests the computational load per core is kept constant , and the simulation volume and particle / cell number is scaled accordingly . in fig .  [",
    "fig : weakscaling ] , we show two different weak scaling series carried out on ranger at the tacc . they differ in their particle and cell load per core . in the results shown in the top panel , this load was `",
    "maximal ' , corresponding to @xmath172 million cells and particles per core , where the current version of arepo requires up to 1600 mb memory consumption per core in the peak .",
    "because some memory is needed for the operating system and the mpi communication library , not all of the physical memory is available for the application code on the ranger platform .",
    "unfortunately , the amount of memory consumed by the mpi subsystem increases with increasing size of the mpi partition .",
    "this in fact prevents us from running the `` full load '' configuration for partitions larger than 4096 cores .",
    "this also prompted us to create a second weak scaling series shown in the bottom panel of fig .",
    "[ fig : weakscaling ] , where we reduced the load by almost a factor of 2 .",
    "this allows us to scale arepo up to @xmath173 cores with @xmath173 mpi tasks .",
    "it is apparent that the short - range gravitational tree calculation , the voronoi mesh construction , and the hydrodynamical flux calculation show excellent weak scaling ( which runs horizontally in the plots of fig .",
    "[ fig : weakscaling ] ) . however , there are deviations from perfect scalability for the fft - based long - range gravitational force calculation , the domain decomposition , and the tree construction .",
    "this is primarily because all three of these parts involve substantial all - to - all communication . for larger processor counts , especially for @xmath173 cores ,",
    "these communication costs start to affect the weak scalability of our code and lead to losses in efficiency .",
    "one reason for the sub - optimal scaling in this regime lies in the fft part of the code .",
    "the slab - based parallelisation of the ffts we use for the long - range gravity calculation does not scale to core numbers larger than the size of the fft , a regime we enter once more than 4096 cores are used ( because the fft - size reaches @xmath174 at this point and can not be grown further due to memory constraints ) .",
    "we note that this can easily be optimised by either using a block - structured fft decomposition or by using a mixed approach for the parallelisation with either threads or openmp .",
    "overall we find that arepo shows good weak scaling behaviour and can readily be applied to large - scale cosmological hydrodynamics simulations ."
  ],
  "abstract_text": [
    "<S> we present the first hydrodynamical simulations of structure formation using the new moving mesh code arepo and compare the results with gadget simulations based on a traditional smoothed particle hydrodynamics ( sph ) technique . </S>",
    "<S> the two codes share the same tree - pm gravity solver and include identical sub - resolution physics for the treatment of star formation , but employ different methods to solve the equations of hydrodynamics . </S>",
    "<S> this allows us to assess the impact of hydro - solver uncertainties on the results of cosmological studies of galaxy formation . in this paper </S>",
    "<S> , we focus on predictions for global baryon statistics , such as the cosmic star formation rate density , after we introduce our simulation suite and numerical methods </S>",
    "<S> . properties of individual galaxies and haloes are examined by @xcite , while a third paper by @xcite uses idealised simulations to analyse in more detail the differences between the hydrodynamical schemes . </S>",
    "<S> we find that the global baryon statistics differ significantly between the two simulation approaches . </S>",
    "<S> arepo shows systematically higher star formation rates at late times , lower mean temperatures averaged over the simulation volume , and different gas mass fractions in characteristic phases of the intergalactic medium , in particular a reduced amount of hot gas . </S>",
    "<S> although both hydrodynamical codes use the same implementation of cooling and yield an identical dark matter halo mass function , more gas cools out of haloes in arepo compared with gadget towards low redshifts , which results in corresponding differences in the late - time star formation rates of galaxies . </S>",
    "<S> we show that this difference is caused by a higher heating rate with sph in the outer parts of haloes , owing to viscous dissipation of sph s inherent sonic velocity noise and sph s efficient damping of subsonic turbulence injected in the halo infall region , and because of a higher efficiency of gas stripping in arepo . as a result of such differences </S>",
    "<S> , arepo leads also to more disk - like morphologies in the moving mesh calculation compared to gadget . </S>",
    "<S> our results hence indicate that inaccuracies in hydrodynamic solvers can lead to comparatively large systematic differences even at the level of predictions for the global state of baryons in the universe .    </S>",
    "<S> [ firstpage ]    cosmology : galaxy formation  cosmology : dark matter  methods : numerical </S>"
  ]
}