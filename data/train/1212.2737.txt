{
  "article_text": [
    "during the past decade , large scale numerical models and inverse problem applications became powerful tools for diagnosing and understanding spectroscopic and spectropolarimetric observations .",
    "massive applications like 3d hydrodynamic ( hd ) simulations , magnetic doppler imaging and data inversion of solar surface layers stimulated interest in developing fast and robust formal solvers for the radiative transfer equation ( rte ) .",
    "these computationally demanding problems pose special requirements for the rte solver : a large number of integrations needed to compute synthetic profiles per single iterations ( time step or model adjustment ) .",
    "fast convergence become particularly important as it allows achieving acceptable accuracy for the radiation field using the same geometrical grid as used for hydrodynamics or inversion .",
    "the properties of rte solver become even more critical for non - equilibrium modeling .",
    "the assumption of local thermodynamic equilibrium ( lte ) makes level population densities defined by the local temperature of the model and decoupled from the radiation field . only one integration of the rte is needed to compute the emerging intensity at each wavelength .",
    "however , in the non - lte case ( nlte ) , evaluation of population densities is calculated using a self - consistent iterative method , normally requiring two integrations of the rte per iteration @xcite .",
    "inaccuracies in the integration of the rte on a coarser grid can lead to a slower convergence of the nlte problem in the spectral synthesis and generally to a slower convergence of the inversion ( in lte and nlte ) .",
    "the situation is worse when the magnetic field becomes important .",
    "the monochromatic radiative transfer equation for polarized light can be expressed as : @xmath2 where @xmath3 is the stokes parameter vector , @xmath4  is the total emission vector , and @xmath5  is the total absorption matrix .",
    "this matrix has seven independent terms : @xmath6 is the total absorption of radiation ; @xmath7 , @xmath8 and @xmath9 describe the coupling of the intensity @xmath10 with @xmath11 , @xmath12 and @xmath13 ; and @xmath14 , @xmath15 and @xmath16 are cross - talk terms between @xmath11 , @xmath12 and @xmath13 due to magneto - optical effects ( see * ? ? ? * ) : @xmath17        \\eta_q & \\eta_i & \\rho_v & -\\rho_u \\\\[0.3em ]        \\eta_u & -\\rho_v & \\eta_i & \\rho_q \\\\[0.3em ]        \\eta_v & \\rho_u & -\\rho_q & \\eta_i \\\\[0.3em ]        \\end{pmatrix}.\\ ] ]    a number of advanced integration schemes , suitable for hd simulations and nlte inversions have been implemented for the unpolarized light @xcite , however , for polarized light it is common to use a short characteristics schemes assuming linear @xcite or parabolic dependence @xcite of the source function with optical path .",
    "@xcite proposed an efficient third - order method ( lbr hereafter ) that provides accurate results on coarse grids of depth - points for polarized light .",
    "this method has been used extensively to compute lte inversions @xcite and nlte inversions @xcite .    in this paper",
    ", we propose a new method to accurately integrate the polarized rte , using bezier interpolants .",
    "the paper is arranged as follows : an introduction to the delo method and bezier splines are provided in ",
    "[ sec : delo ] and [ sec : bez ] respectively . for completeness , we introduce the solution to the unpolarized rte , using bezier interpolants , in ",
    "[ sec : bezscal ] .",
    "the quadratic and cubic bezier solutions to the polarized rte are presented , for the first time , in ",
    "[ sec : bezpol ] .",
    "our proposed solutions are tested against other methods commonly used in radiative transfer studies in   [ sec : numcalc ] .",
    "finally , our conclusions are summarized in ",
    "[ sec : discussion ] .",
    "@xcite rewrite the polarized rte using the _ modified source vector _ ( @xmath18 ) , dividing all terms in equation  ( [ eq : rt ] ) by the absorption coefficient @xmath6 .",
    "this simple change leaves the @xmath5  matrix with all the diagonal elements normalized to one so the method got a name diagonal element lambda operator ( delo ) .    defining , @xmath19 where @xmath20 is the @xmath21 identity matrix .",
    "the radiative transfer equation becomes : @xmath22 with the optical path defined as @xmath23 and @xmath24 .    in our discrete grid of @xmath25 depth points @xmath26 ,",
    "the solution to equation  ( [ eq : delo ] ) on the interval @xmath27 is : @xmath28 where @xmath29 .",
    "to integrate analytically equation  ( [ eq : delosol ] ) , @xcite assume that the equivalent source vector @xmath30 is linear with optical depth ( conventionally referred to as delo - linear ) .",
    "a quadratic dependence of @xmath30 with optical depth would ideally allow to improve the convergence , however , it becomes unstable in the presence of non - linear gradients @xcite .",
    "@xcite provides a thorough summary of advanced interpolants that could be used to integrate the ( implicitly assumed ) unpolarized radiative transfer equation .      defining normalized abscissa units in the interval @xmath31 , @xmath32",
    "the quadratic bezier interpolant can be expressed as : @xmath33 where @xmath34 and @xmath35 represent the node values of the function that is being interpolated and @xmath36 is the bezier control point .",
    "the latter can be expressed using the derivative at @xmath37 or @xmath38 , @xmath39 with @xmath40 . if both @xmath41 and @xmath42 can be computed , it is desirable to take the mean : @xmath43 resulting in a more `` symmetric '' spline .    defining ,",
    "@xmath44 accurate numerical derivatives are calculated at the node points @xmath45 with a scheme that suppresses overshooting beyond the node function values @xcite .",
    "the bezier derivative is given by : @xmath46 if @xmath47 and it is set to 0 otherwise .",
    "alternatively , the cubic bezier interpolant can be expressed as : @xmath48 where @xmath49 and @xmath50 are control points , similar to those defined in equations  ( [ eq : con0 ] ) and ( [ eq : con1 ] ) , but each of them is placed in a different location : @xmath51    fig .",
    "[ fig : splines ] illustrates the behavior of three interpolation schemes , when the function has fast changing gradient . here",
    ", we compare a parabolic polynomial , the quadratic bezier splines ( bezier 2 ) and the cubic bezier splines ( bezier 3 ) described in this section .",
    "the behavior of the parabolic fit is erratic in the vicinity of intervals with large change of gradient , showing dramatic overshooting peaks .",
    "the bezier splines considered here stays between the pair of boundary data values in each interval .",
    "if fact , @xcite already suggested that the bezier splines ( and the hermitian interpolant ) are particularly suitable for solving the radiative transfer equation in form ( [ eq : delosol ] ) as they do not produce spurious maxima and minima .    from @xmath52 to @xmath53 the curve increases smoothly , and the three interpolation schemes considered here produce very similar values .",
    "in this section , we derive the formal solution of the radiative transfer equation for unpolarized light @xmath54 . in this case equation  ( [ eq : delo ] )",
    "becomes a scalar equation : @xmath55 where @xmath10 is the intensity and @xmath56 is the unpolarized source function .",
    "equation  ( [ eq : delosol ] ) is easily integrated by approximating @xmath56 with any of the bezier interpolants described in sec .",
    "[ sec : bez ] .      if the quadratic bezier interpolant is used to approximate the source function , the solution to equation  ( [ eq : delosol ] ) is @xmath57 where @xmath58 , @xmath59 and @xmath60 are coefficients from the integral that only depend on @xmath61 : @xmath62    to calculate @xmath63 , the opacity can be integrated analytically by using bezier splines to approximate @xmath6 as a function of depth .",
    "further details can be found in appendix  [ sec : apen1 ] .",
    "note , that for small @xmath63 it is wise to use taylor expansion for the exponents in the right - hand - side to avoid division of vanishingly small quantities ( see appendix  [ sec : apen2 ] ) .",
    "equation  ( [ eq : deloscalsol ] ) has the form @xmath64 . in the case of a stellar atmosphere",
    "we can sequentially evaluate outgoing intensity at any depth point starting from the boundary condition @xmath65 at the bottom .",
    "the control point @xmath66 is computed using equation  ( [ eq : tcon ] ) for all inner points of the integration domain . for the top point",
    "only one approximation for the control point ( @xmath42 ) is available .      if the cubic bezier interpolant is used to approximate the source function , the solution to equation  ( [ eq : delosol ] ) is @xmath67    @xmath68 , @xmath69 , @xmath70 , @xmath71 are coefficients from the integral that only depend on @xmath63 : @xmath72 the same recommendations apply here for small @xmath63 .",
    "for the polarized case @xmath73 , the solution to equation  ( [ eq : delosol ] ) can formally be presented in the form similar to equation  ( [ eq : deloscalsol ] ) : @xmath74    in sec .",
    "[ sec : bezscal ] , equation  ( [ eq : deriv ] ) we show how to compute the derivatives of @xmath56 needed for evaluating the control point @xmath36 . in the polarized case , however , derivatives of @xmath75 , @xmath76 and @xmath77 must be computed .",
    "the presence of @xmath78 in the denominators of both @xmath41 and @xmath42 ( through equation  ( [ eq : deriv ] ) ) introduces non - linearity that kills a simple recurrence relation available in the scalar case : @xmath79 .    an elegant solution to this problem",
    "is actually provided by the radiative transfer equation : @xmath80 using these expressions , the control points can be re - written as : @xmath81}_{\\bar{\\mathbf{c}}_k^0 } \\mathbi{i}_k=\\\\    = & \\ \\mathbi{c}_k^0+\\mathbf{\\bar{c}}_k^0\\mathbi{i}_k , \\end{split}\\ ] ] and : @xmath82\\mathbi{i}_{k+1}. \\end{split}\\ ] ] note that @xmath83 and @xmath84 are vectors , whereas @xmath85 is a matrix .",
    "the derivatives of the modified opacity matrix @xmath86 and the source vector @xmath87 must be computed according to the recipe for monotonicity given by equations  ( [ eq : weight])-([eq : deriv ] ) to prevent the overshooting .",
    "this convenient splitting of @xmath88 permits re - writing equation  ( [ eq : delolam ] ) for unknown stokes vector in point @xmath89 as a system of four linear equations @xmath90 : @xmath91 with , @xmath92    note , that the matrix and the right - hand - side in equation  [ eq : polsol ] , include only known quantities of absorption matrix , source and stokes vectors .",
    "note also , that solving the system of linear equations ( [ eq : polsol ] ) directly instead of trying to invert * a * is both faster and more robust .",
    "similarly to the quadratic bezier integration , the solution to equation  ( [ eq : delosol ] ) is formally similar to equation  ( [ eq : cdeloscalsol ] ) : @xmath93    given the formal similarity of this equation with the quadratic case , where also two control points are used , the algebra needed to write the problem as a linear system of equations ( equation  ( [ eq : polsol ] ) ) is almost identical .",
    "@xmath94}_{\\bar{\\mathbf{e}}_k } \\mathbi{i}_k=\\\\    = & \\ \\mathbi{e}_k+\\mathbf{\\bar{e}}_k\\mathbi{i}_k , \\end{split}\\ ] ] and : @xmath95\\mathbi{i}_{k+1}. \\end{split}\\ ] ]    equation  ( [ eq : delocvec ] ) can be re - arranged to group all the terms containing @xmath96 on the left - hand side of the equation .",
    "@xmath97    again we advise to solve the linear system of equations in equation  ( [ eq : cpolsol ] ) , instead of inverting the @xmath98 matrix .",
    "we use a modified version of the radiative transfer code nicole ( socas - navarro et al . in prep ) , to test the numerical accuracy of the delo - bezier methods for polarized light . a snapshot from a 3d mhd numerical simulation is used to carry - out the calculation of synthetic full - stokes profiles .",
    "it covers a physical range of @xmath99 mm , extending from the upper convection zone to the lower corona ( from 1.5 mm below to 14 mm above average optical depth unity at 5000   ) .",
    "the simulation has an average magnetic field strength of 150  g in the photosphere .",
    "this particular snapshot has been used by @xcite so further details on simulations can be found there .      as described in @xcite , the nicole code solves the nlte problem for unpolarized light @xcite and , once the atom population densities are known , a polarized formal solution is calculated ( the polarization - free approximation , see * ? ? ?",
    "the atom model used in this work consists of five bound levels plus a continuum .",
    "additionally , the _ velocity - free _ approximation , previously used to compute the data inversions in @xcite , is not used in this study",
    ". therefore the population densities are fully consistent with the strong velocity gradients present in our models .    for consistency",
    ", we have implemented an accelerated local lambda operator based in the unpolarized solution described in sec .  [",
    "sec : bezscal ] .",
    "the process of constructing the approximate lambda operator at any given point @xmath89 , can be idealized by setting the source function to unity in that point , and zero otherwise .",
    "the operator is constructed using the terms from equation  ( [ eq : deloscalsol ] ) that remain after this operation @xcite .    according to equation  ( [ eq : tcon ] )",
    ", the average control point @xmath36 has an explicit dependency on @xmath100 and @xmath101 . using the average of the two @xmath36 s improves stability and accuracy of the bezier interpolant ,",
    "although the lambda operator becomes intrinsically _",
    "non local_.    a simple recipe for reducing the number of iterations for the nlte problem is to make the approximate lambda operator strictly local by setting @xmath102 .",
    "rare cases of minor overshooting are suppressed by forcing the control point @xmath103 .",
    "similar strategies are found in @xcite and @xcite .",
    "we used the approximate lambda operator for solving the nlte problem in the form :    @xmath104    where @xmath105 is the ratio between the line opacity and the total opacity ( see * ? ? ? * for further details ) .",
    "[ fig:2 ] illustrates the full - stokes images at the surface of a @xmath106  mm patch computed at @xmath107  m  from the core of the  @xmath108 line .",
    "columns of panels ( from left to right ) show the monochromatic images obtained using delo - parabolic , delo - linear , quadratic delo - bezier and cubic delo - bezier , respectively .",
    "we used identical nlte level populations to compute the polarized formal solution with each algorithm .",
    "thus , the differences between panels in different columns reflect the numerical properties ( convergence and stability ) of the methods compared",
    ".    the delo - parabolic method seems to work in most of the pixels , but it fails notoriously to produce an accurate solution at certain areas which have been indicated on the panels using red markers .",
    "the artifacts here can be quite large , and some pixels show even negative values in stokes  @xmath10 .    the maximum difference in stokes @xmath10 between delo - linear and delo - beziers at this wavelength is less than @xmath109 of the continuum intensity .",
    "this is an expected result , given that the vertical grid spacing of 3d snapshots is so fine that even a linear scheme produces an accurate solution .",
    "this example only shows the stability of the higher - order bezier methods , but it hardly shows any advantage over a linear scheme .    in sec .",
    "[ sec : numac ] we test the converges and stability of these methods using 1d models where strong gradients in the magnetic - field and line - of - sight ( l.o.s ) velocity are introduced .      to assess the accuracy of the formal solvers , we have created four atmospheric models using a fine grid of depth - points with 198 points - per - decade , equidistantly placed from @xmath110 to @xmath111 .",
    "the four atmospheric models share the same temperature , electron pressure , and micro - turbulence from the valc - iii model @xcite .",
    "we have created a complicated ad - hoc magnetic field vector and l.o.s velocity component , which are illustrated in fig .",
    "[ fig:3 ] , along with the valc - iii temperature . to create a demanding topology ,",
    "the horizontal component of the magnetic - field follows a spiral centered on the line - of - sight .    considering the quantities described above",
    ", our set of four models is summarized as follows :    1 .   the first case is a model with constant l.o.s velocity ( @xmath112  km s@xmath113 ) and constant magnetic - field @xmath114  g for all depth - points . 2 .",
    "in the second case , the constant line - of - sight velocity is replaced with our ad - hoc profile .",
    "the third case has constant velocity but the complicated magnetic - field vector described in fig .",
    "[ fig:3 ] .",
    "complex velocity and magnetic - field profiles are used simultaneously in the fourth case .    for each of these four cases ,",
    "we have computed the absorption matrix and the source function in the original grid of depth - points for the  @xmath108 and the  @xmath115 lines .",
    "these two lines have been extensively used as atmospheric diagnostics in solar applications .",
    "the former is sensitive to a vast range of height including photospheric and chromospheric response , although it has an relatively low land factor ( @xmath116 ) .",
    "the latter is formed in the solar photosphere , but it has a much higher sensitivity to the magnetic - field ( @xmath117 ) .",
    "our test consists of computing the formal solution to the polarized rte using a pre - computed absorption matrix and source function . to study the converge properties of the integrators we simply drop intermediate depth - points from the original grid .",
    "thus we separate the level population calculations from the rte solution .",
    "we also noticed that our level population calculations for start deviating noticeably from the correct solution when the number of depth - points is below 10 points - per - decade .    as a reference here we use the emerging stokes vector computed on the original grid of 198 points - per - decade , using an adaptive fourth - order runge - kutta solver",
    "( see * ? ? ?",
    "* ) , which ensures that the precision of @xmath118 as achieved at every step .",
    "[ fig:4 ] shows a set of stokes  @xmath10 , @xmath11 , @xmath12 and @xmath13 profiles computed for the complex of our ad - hoc models ( model 4 ) using a 2 points - per - decade grid .",
    "the reference grey profile has been computed using the runge - kutta method and the original dense grid of depth - points .",
    "the main discrepancies occur at the chromospheric nlte core of the  @xmath108 line . at those wavelengths ,",
    "the monochromatic depth - scale presents large irregular jumps in optical - depth .",
    "for example , in stokes  @xmath10 the lbr and delo - linear solutions present an excessively strong line core , whereas the delo - parabolic method produces a line core in emission .",
    "the delo - bezier profiles tightly trace the reference profile at all wavelengths , and only a noticeable small deviation is present at the very inner core of the line .",
    "the results of our calculations are summarized in fig .",
    "[ fig:5 ] and fig .",
    "[ fig:6 ] , for the  @xmath108 line and the  @xmath115 line respectively .",
    "the line profiles are compared with the reference case , and the largest discrepancy over the entire profile ( in absolute value ) is plotted for each integration method as a function of the number of depth - points per decade .",
    "this error measurement is sensitive to outliers at a single wavelength .",
    "therefore , the curves in fig .",
    "[ fig:5 ] and fig .  [ fig:6 ] may not be monotonous functions of the number of grid points .",
    "still , we prefer this metric as it gives a robust estimate of accuracy , convergence speed and stability for our solvers .",
    "ideally , we would expect that any discrepancies shown by all the methods considered here , would disappear when the density of depth - points is large enough ( all methods should converge to the same accurate solution ) .",
    "the errors are expected to be large when the density of depth - points is low , especially for the highest order methods , but these should achieve a more accurate solution than the lower order methods when the density of depth - points is relatively high .    in fig .",
    "[ fig:5 ] , our results show that at the absolute minimum of 1 points - per - decade , it is hard to beat the delo - linear solution , which keep the errors under control despite the strong gradients and poorly - sampled stellar atmosphere . however , the delo - bezier solutions provide almost as accurate results except in stokes  @xmath11 where the error is half an order of magnitude higher .",
    "the situation changes drastically , as a few more depth - points are included in the calculations .",
    "between five and thirty points - per - decade , the delo - bezier solutions clearly out - perform all the other solutions for the four scenarios that we have prepared .",
    "most radiative transfer computations are carried out within this range of grid densities .",
    "this also matches hydrodynamic grid density typically used for environments where radiation carries important fraction of energy .",
    "the delo - parabolic needs a large number of depth - points to match the performance of all the other methods , as was expected .",
    "the calculations for the  @xmath115 line , show a smoother behavior than in the previous case and all cases seem to reach a stable level of accuracy at approximately 30 points - per - decade .",
    "the inclusion of more points above this value , seems to increase the accuracy marginally and very inefficiently .",
    "the delo - bezier demonstrated fastest convergence reaching below 10%   for the least dense grids in stokes  @xmath10 .",
    "this conclusion is true for all our models .",
    "the accuracy of all methods is comparable as they all reach the same level of precision above 30 points - per - decade .    for both spectral lines ,",
    "the performance of the lbr method is close to both the delo - linear and delo - parabolic methods , and it only seems to be slightly less accurate when strong gradients in the line - of - sight velocity are present .    the accuracy achieved by the delo - bezier methods is almost identical .",
    "the quadratic solution marginally outperforms the cubic one when the number of depth - points per decade is 1 or 2 , whereas the cubic version is slightly better at the  @xmath108 line , within the range @xmath119 points - per - decade .",
    "computationally , the lbr and delo - bezier solutions are similarly demanding given that accurate derivatives of the source function and of the absorption matrix are required . in comparison ,",
    "the delo - linear and delo - parabolic solutions are almost two times faster , because no derivatives are required .",
    "note also that , in the first and last intervals of the grid , only one control - point can be computed .",
    "therefore , especial care must be taken when the cubic method is used .",
    "the simplest solution is to use the quadratic method in those two intervals , given that only one control point is strictly necessary .",
    "in this work we present a new scheme to integrate the polarized radiative transfer equation using bezier splines .",
    "the solvers are a generalization of the advanced strategy proposed by @xcite for the unpolarized case .",
    "our second - order and third - order integration methods preserve the stability of the delo - linear solution with the benefits of faster convergence and higher order accuracy .",
    "the advantages of the new integration scheme are illustrated by comparison with other methods commonly used to solve the polarized rte .",
    "we show that the new delo - bezier schemes outperform all other algorithms when the density of depth - points is low and the structure of the medium includes steep gradients .",
    "the new methods will be beneficial for various application from reconstructing atmospheric structure(s ) using observational data ( data inversion in solar physics , magnetic doppler imaging of stars ) to radiative magneto - hydrodynamics .",
    "e.g. , in case of solar data inversion the new solvers will allow using less denser depth grid improving the stability of inversion , which is particularly important for strong lines , like the h , k and the ir triplet .",
    "given the vast formation range of these lines ( larger than @xmath120  km ) , it is hard to find an optimal grid of depth points at all frequencies in the line .",
    "the institute of theoretical astrophysics ( university of oslo ) is gratefully acknowledged for providing a snapshot from a 3d mhd chromospheric simulation .",
    "jdlcr gratefully acknowledges valuable scientific discussion with andrs asensio - ramos during the implementation of the approximate lambda operator .",
    "the authors of this work are grateful to an anonymous referee , whose suggestions and comments helped to improve the text .",
    "in many radiative transfer applications , a conversion of the depth - scale is desirable ( i.e , from @xmath121 to @xmath122 ) . to carry out this conversion ,",
    "the opacity ( @xmath123 ) is integrated along the depth - scale . when the grid of depth - points is sufficiently dense",
    ", a trapezoidal integration would suffice .",
    "this wide - spread method becomes inaccurate for coarse depth - scale grids .",
    "we advice to approximate the opacity with a quadratic bezier spline ( eq .  [ eq : bezier ] ) , and integrate analytically this function .",
    "once again , the integral can be expressed as a set of coefficients that multiply the values of the opacity that define the integration interval : @xmath124 du = \\\\    = &    \\frac{x_{k+1}-x_{k}}{3 } \\left ( \\eta_{k}(\\nu )",
    "+ \\eta_{k+1}(\\nu ) + c \\right ) . \\end{split}\\ ] ]",
    "in   [ sec : bezscal ] we advise to use a taylor expansion of the exponential term in equation  ( [ eq : delosol ] ) , when @xmath63 is small : @xmath125"
  ],
  "abstract_text": [
    "<S> we present two new accurate and efficient method to compute the formal solution of the polarized radiative transfer equation . in this work , </S>",
    "<S> the source function and the absorption matrix are approximated using quadratic and cubic bezier spline interpolants . </S>",
    "<S> these schemes provide 2@xmath0 and 3@xmath1 order approximation respectively and do nt suffer from erratic behavior of the polynomial approximation ( overshooting ) . </S>",
    "<S> the accuracy and the convergence of the new method are studied along with other popular solutions of the radiative transfer equation , using stellar atmospheres with strong gradients in the line - of - sight velocity and in the magnetic - field vector .    </S>",
    "<S> # 1*_#1 _ * </S>"
  ]
}