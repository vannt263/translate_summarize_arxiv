{
  "article_text": [
    "during the last decade , observational and theoretical studies constraining the nature of the intergalactic medium ( igm ) have shown that metals are a pervasive component of the baryonic budget of our universe and that they are associated with a wide range of hydrogen column density ( @xmath0 ) systems typically identified in quasars ( qso ) absorption spectra at different redshift ( @xcite ; also see @xcite for a review ) .",
    "high h@xmath1 column density absorbers , with @xmath2 , are easily identified in these spectra for the presence of strong damping wings , and are classified as damped ly@xmath3 systems ( dlas ) .",
    "column densities in the range @xmath4 are instead associated with lyman limit systems ( llss ) and spectroscopically identified by their strongly saturated ly@xmath3 lines .",
    "both systems show c@xmath5 lines as well as many ions in lower ionisation states ( mn@xmath6 , si@xmath6 , fe@xmath6 ) , and are typically associated with metallicities of @xmath7 ( llss ; e.g. @xcite ) and @xmath8 ( dlas ; e.g. @xcite ) .    the presence of metals in llss and dlas can be interpreted as a natural product of the stellar nucleosynthesis acting therein .",
    "llss are in fact identified as clouds in the galactic halos , while high redshift ( @xmath9 ) dlas are believed to be the progenitors of the present - day galaxies .",
    "advances in high resolution spectroscopy revealed weak metal absorption lines in the ly@xmath3 forest ( @xmath10  @xmath11 ) , with c@xmath5 detected in most of the systems with @xmath12 and in more than half of the systems with @xmath13 ( @xcite ) .",
    "the typical metallicities of the ly@xmath3 forest are estimated in the range @xmath14 ( @xcite ) .",
    "the subsequent discovery of a metallic component in less dense regions ( @xcite ) has been interpreted as the evidence of efficient spreading mechanisms which are able to transport the metals far away from their production sites and pollute low density regions .",
    "the redshift evolution of the gas metallicity has been extensively investigated . in the redshift range",
    "@xmath15 , c@xmath5 and si@xmath5 doublets are the main tracers of the igm metallicity , because their rest frame wavelength is larger than the @xmath16 and the lines can not be confused with those of the forest . in this range",
    "the column density distribution of c@xmath5 seems to remain constant ( @xcite ) .",
    "although a consensus has not been reached yet , a decline in the abundance of c@xmath5 above @xmath17 is reported by different groups ( @xcite ) .",
    "the si@xmath5 doublet @xmath18   has been investigated in qso line surveys in the redshift range 1.5 < z < 5.5 .",
    "@xcite measured @xmath19 , the si@xmath5 mass density relative to the critical density , in the redshift range @xmath20 , finding a roughly constant value in the range @xmath21 for absorbers with column densities @xmath22 , while @xmath19 may have increased by an order of magnitude in @xmath23 .",
    "these abundance trends have been confirmed by subsequent studies ( @xcite ) .    at higher redshifts , a critical diagnostic role could be played instead by ions with lower ionisation states like c@xmath6 , si@xmath6 and o@xmath6 , probing colder gas ( @xcite ) .",
    "below @xmath24 a larger sample of data is available also for the oxygen component which is the major tracer of the igm metallicity .",
    "the interested reader can find more information in the recent study of @xcite , and references therein .    beyond this general consensus ,",
    "many observational data remain controversial , as well as their interpretation which is of primary importance , e.g. in constraining different enrichment scenarios .",
    "the metal abundance , the number of ionisation states and the distribution in space and time are still subjects of intense debate ( see @xcite ) .",
    "the theoretical interpretation of the data is of particular relevance because observations of metals in dense regions , where stellar nucleosynthesis is active , provide a record of the star formation history , while observations in the igm can be a good indicator of the galactic winds efficiency , the velocity structure of the igm and more in general of the enrichment mechanism ( @xcite ) .",
    "in fact , different scenarios have been considered in the literature , as an early enrichment by the first generation of stars @xcite , a continuous enrichment ( @xcite ) , or a late enrichment coinciding with the star formation peak at @xmath25 @xcite .",
    "in addition , the determination of metal abundances could also constrain the efficiency of the gas cooling function @xcite and the formation of massive galaxies @xcite .    for these reasons ,",
    "several theoretical schemes for metal production and spreading have been developed , based on both semi - analytic models ( e.g. @xcite ) and numerical simulations ( @xcite ) .",
    "in the most advanced approaches the ionisation state of the metals is calculated assuming the presence of a uniform uv background , which is then used as energetic input for photo - ionisation codes computing the metal ionisation states at the equilibrium ( @xcite ) .",
    "the results of this approach are affected by the uncertainties associated to the assumptions on the shape and intensity of the radiation field , which is not calculated self - consistently from the radiative transfer across the inhomogeneous gas distribution .",
    "many studies suggest in fact that shadowing , filtering and self - shielding induce deviations in the shape and intensity of the background with respect to models in which the effects of the radiative transfer are neglected ( @xcite and references therein ) .",
    "fluctuations in the photo - ionisation rates as well as spatial deviations in the igm temperature due to the inhomogeneity of the cosmic web support this view at least on scales of few co - moving mpc ( see @xcite and references therein ) . on larger scales",
    "( @xmath26 mpc co - moving ) the source spatial distribution and their spectral variability could be an additional cause of variations in the uvb ( @xcite ) .",
    "the fluctuations induced by radiative transfer effects could also be efficiently recorded in the ionisation state of the metals , because their rich electronic structure and atomic spectrum are more sensitive , compared to h and he , to the radiation field fluctuations ( @xcite ) .",
    "numerical schemes which solve the cosmological radiative transfer equation by applying different approximations are now quite mature and well tested ( @xcite and references therein for an overview of the available codes ) and are able to simulate complex scenarios involving large cosmological boxes and number of sources ( e.g. @xcite ) . typically , these codes are restricted to the hydrogen chemistry , with only a few of them including a self - consistent treatment of the helium component , which is particularly relevant for a correct determination of the gas temperature ( see e.g. @xcite ) . none of them though includes the treatment of metal species .    in the interstellar medium ( ism ) community , on the other hand , several photo - ionisation codes , as ` cloudy ` @xcite , `",
    "mappingsiii ` @xcite and ` mocassin ` @xcite are able to simulate the complex physics of galactic hii regions largely polluted by heavy elements .",
    "the aim of the present work is to describe a novel extension of the radiative transfer code ` crash ` @xcite , which has been integrated with ` cloudy ` , allowing the prediction of metal ionisation states self - consistently with the radiation field as calculated by the radiative transfer through the igm density field .",
    "the paper is structured as follows . in section 2 and 3",
    "we briefly introduce the radiative transfer code ` crash ` and the photo - ionisation code ` cloudy ` . in section 4 we illustrate the details of the integration of the two codes into a self - consistent pipeline .",
    "the tests of the new ` crash ` variant called ` crash3 ` are reported in section 5 .",
    "section 6 summarizes the conclusions .",
    "` crash ` is a 3d radiative transfer ( rt ) code designed to follow the propagation of hydrogen ionising photons ( i.e. with energy @xmath27  ev ) through a gas composed by h and he .",
    "the code adopts a combination of ray tracing and monte carlo ( mc ) sampling techniques to propagate photon packets through an arbitrary gas distribution mapped on a cartesian grid , and to follow in each grid cell the evolution of gas ionisation and temperature .",
    "this treatment guarantees a reliable description of such evolution in a large variety of configurations , as shown by the cosmological radiative transfer comparison project tests @xcite and its various applications to the study of the h and he reionisation ( @xcite ) , the imprints of the fluctuating background on the @xmath16 forest @xcite , the quasar proximity effects @xcite and the impact of reionisation on the visibility of @xmath16 emitters ( @xcite ) .",
    "the mc algorithm adopted allows to easily add new physical processes . in its first version @xcite",
    "the code describes h photo - ionisation due to point sources , and includes the effect of re - emission following gas recombination .",
    "the subsequent versions brought about significant improvements .",
    "first the physics of he and the thermal evolution of the gas have been introduced , together with the treatment of an ionising background field @xcite . in the latest release ( crash2 ;",
    "@xcite , hereafter mck09 ) we introduced multi - frequency photon packets obtaining significant improvements in terms of accuracy of the ionisation and temperature profiles , as well as computational speed . hereafter the code name ` crash ` will refer to the version ` crash2 ` .    in parallel with the reference code ,",
    "variants and extensions have been developed such as : mcly@xmath3 @xcite , which has adapted the reference algorithm to treat the resonant propagation of @xmath16 photons ; ` crash`@xmath3 ( @xcite ) , which follows the self - consistent propagation of both @xmath16 photons and ionising continuum radiation ; @xcite have instead developed an mpi parallel implementation of the base ` crash ` algorithm .",
    "the new release described in this paper ( hereafter ` crash3 ` ) extends the standard ` crash ` photo - ionisation algorithm to the treatment of the most cosmologically relevant metals in atomic form : c , o and si .",
    "the current numerical scheme is based on a new pipeline which combines the excellent capabilities of ` crash ` in tracing the radiation field with the sophisticated features of the photo - ionisation software ` cloudy ` @xcite .",
    "the inclusion of a considerably large set of data imposed by the numerous metal ionisation states has required a substantial source code re - engineering that introduces a new memory management and a re - modelling of the photon packet - to - cell interaction . `",
    "crash3 ` is consequently more modular , optimized and easily integrable with other codes . in the following ,",
    "we briefly review the basic ingredients of the ` crash ` algorithm that are required to understand the implementation of the new version , and we refer the reader to the original papers for more specific details .",
    "a ` crash ` simulation is defined by assigning the initial conditions ( ics ) on a regular three - dimensional cartesian grid of a given dimension ( @xmath28 cells ) and a physical box linear size of @xmath29 , specifying :    * the number density of h ( @xmath30 ) and he ( @xmath31 ) , the gas temperature ( @xmath32 ) and the ionisation fractions ( @xmath33 , @xmath34 and @xmath35 ) at the initial time @xmath36 ; * the number of ionising point sources ( @xmath37 ) , their position in cartesian coordinates , luminosity ( @xmath38 in @xmath39 ) and spectral energy distribution ( sed , @xmath40 in erg  s@xmath41  hz@xmath41 ) assigned as an array whose element provide the relative intensity of the radiation in the correspondent frequency bin ( see mck09 for more details ) ; * the simulation duration @xmath42 and a given set of intermediate times @xmath43 to store the values of the relevant physical quantities ; * the intensity and spectral energy distribution of a background radiation , if present .",
    "the simulation run consists in emitting photon packets from the ionising sources and following their propagation through the domain .",
    "each photon packet keeps traveling and depositing ionising photons in the crossed cells , as far as its content in photons is completely extinguished or it escapes from the simulated box ( although periodic boundary conditions in the packets propagation are possible ) .    at each cell crossing , ` crash ` simulates the radiation - to - gas interaction by evaluating the absorption probability for a single photon packet as : @xmath44 where @xmath45 is the total gas optical depth of the cell given by the sum of the contributions from the different species , i.e. @xmath46 .",
    "the number of photons absorbed in the cell can then be estimated as : @xmath47 where @xmath48 indicates the photon content of a packet entering the cell .    the number of the deposited photons for each spectral frequency is then used to compute the contribution of photo - ionisation and photo - heating to the evolution of @xmath49 , @xmath50 , @xmath51 and @xmath32 .",
    "the set of equations solved in the code is described in detail in @xcite and in mck09 .    for the sake of the following discussion",
    ", we remind here that the evolution of the thermal state of the gas in each cell is regulated by the formula : @xmath52 , \\label{eq : enbalancecell}\\ ] ] where @xmath53 is the number of free particles per unit volume , @xmath54 and @xmath55 are respectively the heating and the cooling functions and the subscript @xmath56 refers to all the ion species composing the gas .",
    "@xmath57 is the boltzmann constant .",
    "the heating function is determined by computing the photo - heating resulting from the photon - to - gas interaction discussed above , while @xmath55 is calculated by adding up the contribution of various radiative processes : collisional ionisation and excitation , recombinations , bremsstrahlung and compton cooling .",
    "differently from photo - heating , these processes are treated as continuous processes , described by their respective rates ( see @xcite for details ) .",
    "` cloudy ` @xcite is a code designed to simulate the physics of the photo - ionised regions produced by a wide class of sources ranging from the high temperature blue stars to the strong x - ray emitting active galactic nuclei .",
    "the main goal of ` cloudy ` is the prediction of the physical state of photo - ionised clouds including all the observably accessible spectral lines .",
    "the latest stable release of ` cloudy ` ( at the time of writing v. 10.0 ) simulates a gas which includes all the heavy elements of the typical solar composition and the contribution of dust grains and molecules present in the ism .    in this section",
    "we will focus on the description of the ` cloudy ` features that have been primarily used to implement ` crash3 ` .",
    "the reader interested in the details of the code implementation or in reviewing the many physical processes included can find more appropriate references in @xcite and @xcite .",
    "unlike ` crash ` , ` cloudy ` is a 1d code assuming as preferred geometrical configuration a symmetrical gas distribution around a single emitting source , with photons propagating along the radial direction . `",
    "cloudy ` can also simulate the diffuse continuum re - emitted by recombining gas as nearly isotropic component under the assumption that the diffuse field contribution is generally small and can be treated by lower order approximations .",
    "additional isotropic background fields can also be handled , as long as their shape and intensity are specified by the user . some popular background models ( like the haardt and madau cosmic uv spectrum described in @xcite ) are already distributed with the code .",
    "the contribution of the cosmic microwave background ( cmb ) radiation can also be accounted for because it is an important source of compton cooling for low density gas configurations typical of the igm .",
    "the micro - physics implemented in ` cloudy ` is very accurate : it includes all the metals present in the typical solar composition @xcite described as multi - level systems and treated self - consistently with the ions of the lightest 30 elements .",
    "photo - ionisation from valence , inner shells and many excited states , as well as collisional ionisation by both thermal and supra - thermal electrons and charge transfer , are included as ionisation mechanisms .",
    "the gas recombination physics is simulated including the charge exchange , radiative recombination , and dielectronic recombination processes . `",
    "cloudy ` simulates all these processes adopting an approximation method for the radiation field evaluation known as escape probabilities method @xcite , instead of evaluating the full radiative transfer as done by ` crash ` .",
    "this choice implies the loss of many details pertaining the line properties description , e.g. line pumping by the incident continuum , photon destruction by collisional deactivation and line overlap . in the standard release of `",
    "crash ` the details of the lines are not accounted for and the above limitations are thus negligible .",
    "once the characteristics of the source and the species involved in the calculation are set up , ` cloudy ` estimates the radial distribution of the ionisation and temperature fields by simultaneously solving the equations of ionisation and thermal equilibrium ( @xcite ) . a static solution describing the physical state of the gas is then found by dividing the domain in smaller regions and iterating until convergence is reached .",
    "the usual assumption of such calculations is that atomic processes occur on timescales much shorter than the temporal scales of the macro - physical system . `",
    "cloudy ` does not a priori assume that the gas is in equilibrium and the solution provided is a general non - equilibrium ionisation configuration for a static medium that does not retain any information of the temporal evolution of the system towards the converging state .",
    "a large set of information about the relevance of the physical processes that establish the final convergence , and the details of the line emission processes are also provided with a great level of detail .",
    "this micro - physic treatment can not be directly handled in ` crash ` with the same level of accuracy .    `",
    "cloudy ` describes the thermal equilibrium of the photo - ionised gas providing the local thermal balance obtained in each simulated sub - region . in the absence of non - thermal electrons produced by high - energy photons ,",
    "this thermodynamic equilibrium is generally specified by the electron temperature @xmath58 , because the electron velocity distribution of the gas is predominantly maxwellian . despite crash",
    "does not distinguish between the contribution of the different species to the gas temperature as calculated in eq .",
    "[ eq : enbalancecell ] , in practice @xmath59 to a good approximation , and thus it is consistent with the output from cloudy .",
    "it should be clarified though that cloudy provides a gradient of temperatures within the simulated region . because the crash resolution is a single cell , whenever we use a temperature provided by cloudy",
    "this should be intended as the volume average over a cell . in the following",
    "we will always refer to the temperature as @xmath32 .",
    "implementing crash3 we have minimised the differences between the two codes , e.g. by disabling in cloudy all the physical processes non explicitly treated in crash such as molecule and dust grain physics , charge transfer effects and radiation pressure , among others .",
    "in addition , while ` crash ` simulates the propagation of hydrogen ionising photons , ` cloudy ` requires that any spectral information is provided in the energy range @xmath60  ev@xmath61  mev .",
    "for this reason , the spectrum used as input for ` cloudy ` is the one provided by crash in the frequency range 13.6  ev@xmath62 ( see following section ) , while it is set to zero for @xmath60  ev@xmath6313.6  ev and @xmath64100  mev , where @xmath65 is the energy corresponding to the higher frequency sampled in the ` crash ` simulation ( see mck09 for more details ) .",
    "the deeply different set - up of the simulations in ` crash ` and ` cloudy ` , both in geometrical configuration and in the gas micro - physics , has made the building of the common pipeline a non trivial task .",
    "this will be detailed in the following sections .",
    "the extension of the ` crash ` algorithm with the full micro - physics of metals is hardly viable because of the extreme complexity of the metal electronic structure which would increase the computational costs of a rt simulation to unacceptably high levels ( see @xcite and references therein for a modern introduction to the physics of the metals in ionised regions ) .",
    "for this reason , we have adopted a hybrid approach in which ` crash ` performs the rt only through h and he , while the metal ionisation states are implemented self - consistently , but they are calculated with ` cloudy ` . the two algorithms interact within a single pipeline called ` crash3 ` , which is sketched in figure  [ fig : crash - pipeline ] .",
    "it should be noted that , if the radiative transfer is performed in a cosmological context , the pipeline applies to each single redshift , @xmath66 . in this case , in addition to the ics of the rt simulations , other physical quantities might depend on @xmath66 , e.g. the cooling off the cmb radiation .",
    "more specifically , ` crash3 ` recognises the metal enriched sub - domain by applying a masking technique to it and by labelling the enriched cells , which are indicated here with the subscript @xmath67 . after masking the @xmath67-cells containing metals",
    ", it derives the spectral energy distribution and luminosity of the ionising radiation present in each of the @xmath67-cells ( @xmath68)@xmath69 , which are then used to query a dynamic database ( db ) of configurations pre - computed with cloudy to identify the corresponding ionisation states of the metals and the temperature of the gas .",
    "this procedure is repeated for a set of times @xmath70 and the physical state the enriched cells is then evaluated as a sequence of @xmath71 equilibrium configurations at @xmath72 . to ensure that the ionisation level of the metals is consistent with the energy configuration , the pipeline checks that the ionisation fractions of h and he evaluated by ` cloudy ` and ` crash ` are in agreement .",
    "an example of this internal convergence test can be found in section  [ sub : metalcrash - vs - crash2 ] .",
    "it should be noted that this approach neglects the contribution of metals to the optical depth , as well as to the diffuse radiation emitted by recombining gas .",
    "this approximation is justified as long as the metal abundances are very small compared to those of h and he . in fact , when the number density of heavy elements @xmath73 , the total photo - ionisation cross section starts to be dominated by the metal component ( see @xcite , chapter thirteen for a complete discussion ) . because the metallicity observed in the igm",
    "is typically below this value ( see the introduction ) , the above assumption is justified in the cases of our interest .    as detailed in section  3 , ` cloudy ` can deal with either a single source configuration or a background radiation .",
    "if only a single source is present in the computational domain of ` crash ` or when each cell is illuminated from a preferential direction , then the ` cloudy ` point source configuration should be used to estimate the ionisation and temperature state of the cell . when instead a cell is illuminated more or less uniformly from all directions , then the background radiation set - up should be adopted .    in the current implementation of ` crash3",
    "` we have included the species c , o and si , which are the most abundant metals observed in the igm ( see the introduction ) . however , the inclusion of other species , which may be relevant for a more accurate estimate of the gas cooling function , is a straightforward extension of the present scheme ( see sec .",
    "5.1.5 ) .",
    "despite the conceptual simplicity of the approach described above , the coupling of ` crash ` and ` cloudy ` in a single numerical scheme presents several technical challenges . in the following",
    "we will describe in more detail the strategy adopted for such integration and some aspects of the pipeline .    , @xmath74 , @xmath75 and @xmath32 are the sed , luminosity , ionisation fractions ( per species @xmath56 ) and gas temperature . the subscripts @xmath76 and @xmath67 refer to all the cells in the computational domain and the metal enriched cells only , while the superscripts @xmath77 and @xmath78 refer respectively to the quantities provided by the radiative transfer simulation in step 2 and by the database ( db ) , i.e. as a product of the full crash3 pipeline .",
    "see text for more details . ]",
    "the starting point of the pipeline is the set - up of the ` crash3 ` ics , which are the same of ` crash ` as specified in section  2 , with the addition of the spatial distribution and abundance of all the metal species present in the computational domain .",
    "these can be artificially created by hand or can be obtained as a result of e.g. hydrodynamic simulations that include physical prescriptions for metal production and spreading .",
    "a preliminary analysis of the spatial distribution of metals allows to identify the @xmath67-cells that need to track the radiation field ( step 2 ) and then query the pre - computed db ( step 3 ) . to identify these cells a boolean mask",
    "is built isolating the enriched portion of the simulation volume .",
    "the building of the mask can be performed before the beginning of the simulation and passed as additional ic or can be created in memory during the simulation initialization . if the mask contains @xmath67-true values , a shadow map of @xmath67 cell spectra , @xmath79 , and luminosities , @xmath80 , is allocated to store the shapes and luminosities of the incoming packets : each time a packet enters a cell , the mask is used to check whether the cell is an enriched one and consequently @xmath79 and @xmath80 should be updated ( see step 2 ) .",
    "the masking has been designed to optimise the performances of the code , but in principle the sed and luminosity can be calculated in each cell of the computational domain , if required .",
    "the next step ( step 2 in fig .  [ fig : crash - pipeline ] ) consists in performing a rt simulation which , in addition to the evaluation of ( @xmath81)@xmath82 in all the cells of the domain , tracks also the sed and luminosity of the ionising radiation in each of the @xmath67 metal enriched cells ( @xmath68)@xmath83 .",
    "all the above physical quantities are stored at times @xmath72 , as already mentioned above .",
    "the values of ( @xmath68)@xmath83 at @xmath72 are determined adding up the contribution of all the incoming photon packets up to that time . in practice",
    ", the code tracks all the multi - frequency packets entering the cell and calculates @xmath84 as the sum of the luminosities of all the packets , while @xmath85 as the average sed in each frequency bin .",
    "finally , a search engine looks for the ` cloudy ` precomputed configuration that best matches the values of h , he , metal number densities and @xmath86 .",
    "the best fitting configuration then provides the ionisation fractions of the metal ions and the temperatures @xmath87 of the gas in the metal enriched sub - domain ( step 3 in fig .",
    "[ fig : crash - pipeline ] ) .",
    "if the matching criteria are not satisfied ( see below and appendix b for more details ) , the database is extended with additional on - the - fly ` cloudy ` runs .",
    "it is important to point out that step 3 does not severely affect the basic algorithm performances because it is confined only to the @xmath67 enriched cells and a large number of cloudy calculations are pre - computed and stored in the db .",
    "the interested reader can find more details about the lookup strategy in appendix b.    a correct computation of the temperature is not trivial , because also in the absence of metals the temperatures predicted by ` crash ` and ` cloudy ` are not in perfect agreement in the vicinity of the point sources ( mck09 ) .",
    "more generally , it has been shown that different approaches to the radiative transfer do not always predict consistent temperatures in such regions ( @xcite ) .",
    "this means that every time a discrepancy between @xmath88 and @xmath89 occurs it is important to understand if this is due to the presence of metals or just to the differences in the two codes . for these reasons",
    "we allow some flexibility in the matching criteria for the temperature and we define a temperature deviation @xmath90 as :    @xmath91    where @xmath92 refers to the deviation calculated for a gas contaminated by metals , while @xmath93 refers to a pristine gas .",
    "the difference @xmath94 is @xmath95 by design and it is due only to the effect of metals . in the enriched cells in which @xmath96 is greater than some threshold value for the maximum tolerated deviation , @xmath97 is replaced by @xmath87 .",
    "we apply this correction ( accounting for the metals feedback on the temperatures ) when the @xmath96 is higher than @xmath9810% @xmath87 without metals .",
    "however the value adopted for the threshold depends on the physical problem being study and for this reason the criteria for the threshold can be defined at the beginning of each simulation .",
    "note that the temperature correction has some weak feedback on the physical state of the gas also via its recombination coefficients , especially for the helium component .    in realistic applications ,",
    "the temperature provided by the hydrodynamics ( @xmath99 ) could be significantly higher than the temperature established by the rt .",
    "this generally happens in gas shocked regions where the metal ions are determined mainly by collisional ionisation rather than photo - ionisation .",
    "collisional ionisation is correctly handled by the pipeline at step 2 for h and he , because ` crash ` selects @xmath100 during its simulation initialisation process , maintaining the right temperature .",
    "note that these regions are known as ics , and a masking technique can be used to isolate them from the standard pipeline work - flow .",
    "the ionisation status of the metal component eventually present in these cells can be determined from ` cloudy ` pre - computed tables , and by interpolating the gas number density , metallicity , temperature , as well as the ionisation fractions of hydrogen and helium . for more details on this technique",
    "see @xcite and references therein .",
    "in this section we present three tests designed to establish the reliability of the new code .",
    "the first test ( section  [ sub : stroemgrentest1 ] ) concentrates on the standard strmgren sphere case , albeit of a metal enriched gas .",
    "the second test ( section@xmath101[sub : test-2 ] ) investigates the sensitivity of ` crash3 ` to fluctuations of the radiation field induced by different source types and tracked by the many metal ionisation states .",
    "finally , the third test ( section  [ sub : test3 ] ) describes a more realistic physical configuration by using as ics those from a snapshot of a hydrodynamic simulation .",
    "hereafter the gas metallicity ( or equivalently the metal mass fraction ) is defined as @xmath102 , where @xmath103 is the total mass of the elements with atomic number higher than 2 and @xmath104 is the total mass of the gas ; the metal mass fraction in the sun is set to @xmath105 , according to the metal abundances relative to hydrogen as reported in the ` cloudy ` hazy guide i and references therein , and taking into account the 10 most abundant elements : h , he , c , n , o , ne , si , mg , s and fe .    unless otherwise stated , the metal feedback on the calculation of the gas temperature is neglected and we use @xmath106 .",
    "we consider a configuration similar to the one in test 2 of the cosmological radiative transfer comparison project @xcite , but for the presence of metals .",
    "the simulation box has a co - moving side length of 6.6  kpc and it is mapped onto a regular grid of @xmath107 cells .",
    "the gas is assumed to be uniform and neutral at the initial temperature @xmath108  k , with a number density @xmath109 @xmath110 and a hydrogen ( helium ) number fraction of 0.9 ( 0.1 ) .",
    "only one point source is considered with coordinates ( 1,1,1 ) , a black - body spectrum at temperature @xmath111  k and ionisation rate of @xmath112 ( i.e. a luminosity @xmath113 ) . to ensure a good convergence of the mc scheme",
    ", the source radiation field has been sampled by @xmath114 photon packets .",
    "the redshift of the simulation is set at @xmath115 and the simulation duration at @xmath116 , i.e. several times the recombination time characteristic of the simulated gas configuration .",
    "this choice assures that convergence is reached at the end of the simulation .",
    "we uniformly contaminate the gas with carbon ( @xmath117  @xmath110 ) , oxygen ( @xmath118  @xmath110 ) and silicon ( @xmath119  @xmath110 ) , corresponding to @xmath120 .",
    "these numbers are obtained maintaining the metal abundances relative to hydrogen mentioned above .",
    "finally , the source spectrum is sampled by 91 frequencies and it extends to an energy @xmath121 kev , in order to include the photo - ionisation edge of the ion o@xmath122 .",
    "although we contaminate the entire box with metals , it is possible to significantly reduce the number of db queries taking advantage of the spherical geometry of the problem and assuming that each radial direction is equivalent .",
    "this is justified as long as the number of photon packets used is large enough that the fluctuations induced by the monte carlo sampling are negligible .",
    "we then apply a spherical average of all the relevant physical quantities at each distance @xmath123 ( expressed in cell unit ) from the ionising source , and we use these averaged values to search for the better - matching configuration in the db . all the quantities discussed and displayed in this test should be intended as explained above , i.e. as spherically averaged values .      before proceeding further with the analysis of the results , we discuss the internal convergence of the pipeline .",
    "more specifically , we need to assure that the ionisation fractions @xmath124 , @xmath125 and @xmath126 calculated in step 2 and step 3 of the pipeline are in agreement with some user - defined threshold .",
    "the same needs to be true for the temperature @xmath32 if the effect of metals is negligible .",
    "this would ensure that the physical configuration and energetic balance evaluated in steps 2 and 3 are fully consistent . to this aim",
    "we run test  1 in the absence of heavy elements .    in figure",
    "[ fig : convergence - cras2-crash3 ] we show the profile of @xmath127 , @xmath128 ( top panel ) , @xmath129 , @xmath130 and @xmath131 ( middle panel ) as evaluated by step 2 ( dashed lines and variables with superscript @xmath132 ) and step 3 ( solid lines and variables with superscript @xmath78 ) at the time @xmath116 .",
    "the values of @xmath133 and @xmath49 result in agreement within @xmath134 for @xmath135 cells ( @xmath136 kpc ) and within @xmath137 up to the ionisation front ( i - front ) , identified as the location where the ionised fraction drops below @xmath138 .",
    "the agreement degrades to @xmath139 % ( with respect to the maximum absolute difference between ionisation fractions ) in the two cells in which the curves of * @xmath127 * and * @xmath128 * cross , and then it restores up to @xmath140 .",
    "both codes predict the crossing in the same cell .",
    "a similar behaviour is shown in the middle panel for helium .",
    "a discrepancy of @xmath141 % in the @xmath125 curves is seen at a distance @xmath142 cells , when the abundance of he@xmath143 starts to increase .",
    "he@xmath144 results in an even better agreement , up to @xmath134 .",
    "reasonable accuracy ( less than @xmath145 % ) is also reached in the fronts of he@xmath143 and he@xmath146 where both algorithms predict a similar shape . because at the end of the hii region the intensity of the radiation has dropped substantially ( see following section ) , sometimes cloudy",
    "does not find a convergent solution in few iterations , and this results in a poorer agreement between step 2 and 3 .",
    "the above differences are more evident in the bottom panel of the figure , where we show the absolute difference @xmath147 for @xmath56=h@xmath6 , he@xmath6 and he@xmath148 .    despite the satisfying agreement in the ` crash3 ` implementation , some small discrepancies remain due to the differences between the ` crash ` and ` cloudy ` geometries and the numerical implementation of the ionisation and energy equations ( see sec .  3 ) .",
    "we found that a critical ingredient to reach an acceptable convergence is to sample the source spectrum with a large number of frequency bins ( see details in the test section ) .",
    "this is necessary because the helium component is very sensitive to this sampling , in particular in the vicinity of the ionisation potential of he@xmath143 .",
    "the temperature radial profiles estimated in the two steps are shown in figure [ fig : temperature - convergence - for ] ( top panel ) .",
    "the curves present large discrepancies in the cells near the source , with a relative variation @xmath149 as high as 60 percent .",
    "the difference drops below 30 percent for @xmath150 cells .",
    "this is not reflected in the h and he profiles shown in figure  [ fig : convergence - cras2-crash3 ] because of the weak temperature dependence in the gas recombination coefficients . such a difference has been already noticed and discussed in the ` crash ` vs ` cloudy ` comparison test in mck09 and can be ascribed just to the different implementation of the temperature estimate in the two codes .    because ` crash ` updates the temperature ( compared to its initial value ) only in those cells reached by ionising photons , outside the hii region @xmath32 drops to the initial value of 100 k. on the other hand ,",
    "the temperature calculated by step 3 is provided by ` cloudy ` and , as already mentioned above , all the regions where the intensity of the radiation is too faint do not provide a convergent solution . in the few cells in which ` cloudy ` can not provide a reliable estimate because of the too weak radiation field , the ` crash ` temperature @xmath151 is retained as better estimate of the physical temperature at the front .",
    "these convergence tests have been repeated using different ics for the gas number density and the source luminosity .",
    "more specifically , we have run simulations on a grid of cases with values @xmath152 and @xmath153 .",
    "it is found that , as the gas density decreases , the agreement improves for the h species , while small discrepancies still remaining in the he species . such discrepancies are , on the other hand , always below @xmath145 % and remain limited to the small number of cells encompassing the ionisation fronts .",
    "a similar improvement is observed also for the gas temperature convergence .",
    "hereafter all the variables will refer to values calculated at step 3 and the superscript @xmath78 will be omitted to simplify the notation .",
    ".[tab : ionization - potentials]ionisation potentials for h , he , c , o and si up to the ionisation level vi as used in cloudy . [ cols=\"^,^,^,^,^,^\",options=\"header \" , ]     in figure [ fig : spectravar1 ]",
    "we show how the spectral shape of the ionising radiation field described in terms of its spherical average ( obtained as described at the beginning of sec .",
    "5 ) changes with the distance @xmath123 as a result of geometrical dilution and filtering .",
    "each line refers to the simulation time @xmath154 .",
    "the spectra shown are truncated at @xmath155  ev to have a better visualisation of the most relevant line potentials .",
    "the upper curve corresponds to a distance of @xmath156 cells , while the lower to @xmath157 cells ; at larger distances the intensity of the radiation becomes too faint to solve the ionisation equilibrium in every configuration at step 3 of the ` crash3 ` pipeline .",
    "because the medium is fully transparent in h and he up to a distance @xmath156 cells , we have normalized the spectra in the figure to the maximum value of the spectrum at @xmath156 cells .",
    "this choice allows a better visualisation of the shaping effects by the partially ionised regions .",
    "the ionisation potentials of the metals enriching the box ( see table  [ tab : ionization - potentials ] ) are also shown as reference even if , by design , metals do not contribute to the filtering of the ionising radiation .",
    "the absorption due to h@xmath146 , he@xmath146 and he@xmath143 is clearly visible in correspondence of the respective ionisation potential , i.e. 13.6  ev , 24.6  ev and 54.4  ev .",
    "figure [ fig : spectravar2 ] shows the total photo - ionising luminosity , @xmath158 , available for ionisation of some reference species as a function of @xmath123 at a time @xmath159  yrs .",
    "@xmath158 is defined as : @xmath160 where @xmath161 is the ionisation potential of the species considered ( see table [ tab : ionization - potentials ] for reference ) and @xmath162 is the planck constant .    because the spectrum includes only photons with @xmath163",
    ", @xmath158 is an underestimate for those elements with an ionisation potential below @xmath164 , i.e. carbon and silicon .",
    "note that @xmath165 , @xmath166 and @xmath167 overlap respectively with @xmath168 ( black line ) , @xmath169 ( blue ) and @xmath170 ( violet ) because of the very similar ionisation potential .",
    "if we increased the frequency resolution of the spectrum the curves would show some small difference .",
    "this would be at the expense of the computational time without significant advantages in the accuracy of the metal ionisation state .",
    "for this reason we do not further increase the frequency resolution .",
    "notice that all the luminosities decrease smoothly with @xmath123 ; this is consistent with the behaviour expected in an hii region , as already reported and extensively commented in @xcite and mck09 for the hydrogen and helium components .",
    "we now analyse the behaviour of the metal ionisation states , plotted in figure [ fig : cosiions ] . before discussing the details of the figure , it is necessary to point out that the balance among the different ions is primarily established by the relative values of their ionisation potentials and of their recombination coefficients ( see @xcite ) .",
    "it also depends on the spectral distribution of the radiation field and its variations with the distance from the source , as induced by the radiative transfer effects .",
    "the complex interplay between these numerous processes makes the interpretation of the results non trivial ; despite this , some trends have a straightforward explanation .",
    "because of the small amount of metals included in this test , we expect their impact on the evolution of h and he to be negligible .",
    "this is confirmed by a comparison of the curves in the top panel of the figure to the corresponding curves in figure [ fig : convergence - cras2-crash3 ] , which are obtained without metals .",
    "the maximum difference is @xmath141 % across the i - front of h@xmath6 .",
    "additional effects on the ionisation fractions induced by an increase in the gas metallicity will be investigated in section [ sub : test1metalfeedback ] .",
    "we now turn to analyse the behaviour of carbon ( second panel from the top ) . for @xmath171 cells ,",
    "c is in the form of c@xmath148 , c@xmath5 and c@xmath172 , with a predominance of the latter close to the source .",
    "this high ionisation level is obtained from a combination of collisional ionisation and photo - ionisation .",
    "the evolution of c@xmath148 is very similar to that of he@xmath6 because of the similar ionisation potentials ( see fig .",
    "[ fig : spectravar1 ] ) .",
    "the abundance of c@xmath5 is dictated by the evolution of c@xmath148 and c@xmath172 , and their relative recombination coefficients .",
    "c@xmath5 is present throughout the entire hii region , with @xmath173 being always below 30 percent . for @xmath174 cells @xmath175 goes to zero because only few c@xmath5 ionising photons are available ( see fig .  [ fig : spectravar2 ] as a reference ) .",
    "the ionisation potential of c@xmath172 is outside our frequency range ( see table [ tab : ionization - potentials ] ) and thus higher ionisation states are not present . because of the paucity of photons with @xmath176 , at @xmath150 cells only c@xmath148 is present in large quantities with @xmath177 . at @xmath178 cells , similarly to what happens to h@xmath6 and he@xmath6 , also c@xmath148 declines and c@xmath6 dominates . finally , outside the hii region , only c@xmath1 is present .    in the third panel from the top",
    "the ions of the oxygen are shown .",
    "the ionisation potential for o@xmath122 is the highest photo - ionising energy available in the adopted spectrum .",
    "a very small fraction of o@xmath179 is in fact present in few cells around the source .",
    "it should be noticed that collisional ionisation contributes to this fraction for @xmath98 10 % at @xmath180  k , which is present when @xmath181 cells .",
    "the presence of o@xmath122 , is more evident but it is consistently limited to the inner region of the ionised sphere and decreases rapidly with the distance from the source in favour of lower ionisation levels . for @xmath174 cells o@xmath148 dominates the ionisation balance until it drops in favour of o@xmath6 , roughly at the end of the hii region . as for the other species , outside the hii region",
    "only o@xmath1 is present .    in the bottom panel the behaviour of silicon",
    "is reported .",
    "si@xmath172 completely dominates the inner region of the strmgren sphere , with a long tail extending to @xmath182 cells , where it is in equilibrium with lower ionisation states . in the central region",
    "many ions are in equilibrium with a low ionisation fraction .",
    "si@xmath148 reaches a maximum fraction of @xmath183 at the center of the hii region .",
    "si@xmath6 dominates at @xmath184 cells .",
    "the abundance of si@xmath1 in the outskirts of the hii region is much lower than the one of e.g. c@xmath1 because of the lower number density of si and the much larger cross section of si@xmath1 at the resonance ( see fig .",
    "13.2 of @xcite ) .    in general",
    ", it is possible to say that in the vicinity of the source the most abundant species are those with the higher ionisation state compatible with the maximum potential in the spectrum , i.e. h@xmath143 , he@xmath144 , c@xmath185 , o@xmath185 and si@xmath185 . despite @xmath186 , @xmath187 and @xmath188",
    "being covered by the spectrum , the abundance of photons at these energies is so low that @xmath189 , @xmath190 and @xmath191 are negligible . as the distance increases , the luminosity available for ionisation decreases , in particular for ions with high ionisation potentials ( see fig .",
    "[ fig : spectravar2 ] ) .",
    "this is reflected by the decrease of the abundance of these highly ionisation states and the predominance of lower ionisation states ( e.g. he@xmath143 , c@xmath144 , o@xmath144 and si@xmath144 ) .",
    "species like si@xmath192 and c@xmath192 are always present , although they are not dominant , because the spectrum of the ionising radiation maintains energies higher than @xmath193 and @xmath194 throughout the hii region ( see fig .",
    "[ fig : spectravar2 ] ) . at even larger distances ( @xmath195 cells )",
    "the dominant species are typically singly ionised metals and the neutral components , due to the absence of ionizing radiation .",
    "while the discussion above refers to the final gas configuration , in figure [ fig : tevolution ] we show some reference species at different simulation times , i.e. @xmath196 , @xmath197 and @xmath198  yrs .",
    "it should be kept in mind that in this case no metal feedback is included in the calculation ( see sec .",
    "[ sub : test1metalfeedback ] ) and thus the profiles of the metal species at each time are independent from each other . while the shape of each species changes substantially between @xmath199 and @xmath197  yrs , for @xmath200  yrs they have almost converged .",
    "this is especially true for the metal ionisation potentials larger than the third and for he@xmath144 .",
    "overall , the comments made for figure  [ fig : cosiions ] at @xmath201  yrs apply also at earlier times .      in this section",
    "we discuss the impact of photons with @xmath202  ev in the evaluation of metal ionisation states .",
    "because the ionisation potential of c@xmath1 and si@xmath1 is below @xmath203 , i.e. in a range which is not covered by ` crash ` and where the spectrum is set by default to zero , this means that photo - ionisation by photons with @xmath202  ev is neglected , resulting in a systematic underestimate of @xmath204 and @xmath205 as visible in the outer region of the strmgren sphere .    to investigate this limitation of our pipeline ,",
    "we have extended the spectrum to a lower energy of @xmath206  ev .",
    "it should be kept in mind , though , that in the range @xmath207-@xmath208 the luminosity of the spectrum is overestimated because the absorption by metals ( the only species contributing to the optical depth in this energy range ) is not accounted for .",
    "this means that the change in the spectrum at these frequencies is due only to geometrical dilution .",
    "the approximation is more severe beyond the he@xmath6 front ( see figure [ fig : cosiions ] ) , where the only surviving radiation has energy below @xmath203 and the optical depth of the medium is dominated by the metals .    in figure",
    "[ fig : irext ] we summarise the results of this run by showing the evolution of different c , o and si ions . lines with crosses refer to the case in which the source spectrum extends below 13.6  ev . in the inner part of the hii region",
    "the agreement between the curves with and without the inclusion of the low energy tail is excellent for the neutral fractions and the first ionisation state , while it gets worse for higher ionisation states .",
    "the reason is that , when the spectrum is extended below 13.6  ev additional physical processes become relevant , in particular line emission from collisional excitation . the most prominent case is the collisional excitation of the o@xmath5 line . while the behaviour of @xmath209 is the same in both cases ( and for this reason it is not reported here ) , in the presence of non h@xmath1-ionising radiation o@xmath5 recombines more quickly to o@xmath148 , inducing the discrepancies observed between @xmath98 20 - 35 cells .",
    "something similar happens to c@xmath172 and c@xmath148 , while c@xmath5 is not affected because it is not a dominant species at these distances , as shown in figure  [ fig : cosiions ] . for the si the differences are smaller .",
    "the picture in the outskirts of the hii region instead changes completely : not only do @xmath204 , @xmath210 and @xmath205 extend outside the hii region , while the corresponding neutral components disappear , but also the higher ionisation states are affected .",
    "this results from a combination of the photo - ionisation due to the photons with energies below 13.6  ev and the additional physical processes mentioned above . at these distances",
    "the former effect has a larger impact than in the vicinity of the source , where ionisation is dominated by photons with energies above 13.6  ev .",
    "it should be noted that outside the hii regions , or , more correctly , when the absorption of photons is not dominated any more by h and he , our assumption of neglecting the metal contribution to the optical depth fails and the metal ionisation states are not calculated correctly any more , have been deactivated in cloudy by disabling the charge transfer .",
    "more references on the subject can be found in @xcite . ] .      in this section",
    "we investigate the effect of metals on the evaluation of the gas temperature . in the appendix",
    "a the convergence of this feedback with respect to the choice of @xmath71 is investigated .",
    "this is done by calculating @xmath32 at the time @xmath201  yrs in the standard configuration of test  1 and then changing the metallicity of the gas .",
    "test 1 has been repeated changing the gas metallicity @xmath211 , while maintaining the relative abundance of c , o and si . in the upper panel of figure  [ fig : tcorrectionmetallicity ]",
    "we show the results in terms of : @xmath212 where @xmath213 is the value of the temperature relative to a configuration with @xmath214 .",
    "the reference case ( @xmath215 , dashed line ) does not show any significant metal cooling , with the exception of the region near to the source ( @xmath216 cells ) where recombination and re - emission of high ionisation states of c , o and si is more significant , inducing an average @xmath217 .",
    "temperature deviations at the he@xmath6 i - front ( @xmath218 cells ) , where the ionising radiation is very faint , are also present , with @xmath219 . increasing the metallicity to one percent solar ( solid line ) does not change the results . only at @xmath220 ( dashed - dotted line )",
    "some cooling is visible at each distance . in few cells near",
    "the source @xmath221 is as high as 40@xmath222 , while it remains below 10 percent at @xmath223 cells .",
    "the effect of metal cooling starts to be very significant for @xmath224 ( dashed - spaced line ) , with a @xmath225 in the inner part of the hii region and @xmath226 also in its outer part .    even if it is not shown in figure  [ fig : tcorrectionmetallicity ] , we have computed the solar and super - solar cases ( @xmath227 ) , finding a deviation of @xmath228 in the inner region , and values exceeding 40 percent up to @xmath229 cells .",
    "these results confirm the dominant role played by the metal cooling in this metallicity range .",
    "these cases though should be considered only as indicative because in this metallicity regime the metal contribution to the absorption can not be neglected and the assumptions of our method fail .    as a second step",
    "we have investigated the dependence of our results on the gas composition ; this is shown in the bottom panel of figure [ fig : tcorrectionmetallicity ] . more specifically ,",
    "while the black lines are the equivalent of the ones in the upper panel , the red lines have been obtained including the 10 most abundant elements in the solar composition .",
    "note that the red and black lines are not distinguishable in the reference metallicity case . in both cases",
    "the number densities of metals are such that their abundance relative to h is the same as those in the solar composition .",
    "it is clear that , at a fixed metallicity , the contribution of c , o and si to the cooling is dominant compared to other elements , such as n , ne , mg , s and fe .",
    "we have thus neglected such elements in all further tests .",
    "it should be noted that just adding the contribution of n , ne , mg , s and fe to the gas metallicity ( without keeping it constant ) would bring @xmath230 from e.g. @xmath231 to @xmath232 , and @xmath233 to @xmath234 .    in figure",
    "[ fig : metalcompositionfeedbackonions ] we finally report the effect of a varying metallicity and chemical composition on the ionisation fraction of c@xmath5 .",
    "it is clear that it is safe to neglect metals other than c , o and si as their impact on the global ionisation equilibrium is limited at a maximum of few percent for @xmath235 , while it is close to zero for lower metallicity .",
    "a similar effect is observed for all the other relevant ions . on the other hand ,",
    "the dependence on the gas metallicity @xmath230 is higher and it changes for the various species . in some cases , like the one shown in the figure ( as well as e.g. o@xmath148 and si@xmath5 ) ,",
    "the ionisation fraction of the species increases with increasing metallicity , while in others ( as e.g. c@xmath148 , o@xmath172 and si@xmath5 ) the trend is reversed .",
    "it is beyond the scope of this paper though to discuss this issue in more details .",
    "here we study the behaviour of metals in the hii region overlap produced by two point sources located in cells @xmath236 and @xmath237 .",
    "this geometrical set - up is sketched in figure [ fig : test2sketch ] and it is designed to investigate the sensitivity of our method to small changes in the source characteristics .",
    "this is done by varying the source ionising rates , @xmath238 and @xmath239 , and their associated black - body spectral temperatures , @xmath240 and @xmath241 .",
    "all the other numbers are the same as those in test  1 , with the exception of the gas number density which is @xmath242  @xmath110 , to obtain a sharper overlap profile . because in this test we are interested in studying the behaviour of metals only in the overlap region , we concentrate on the plane corresponding to @xmath243 ( blue circle in fig .  [ fig : test2sketch ] ) .",
    "we first describe the set - up used as reference case , with two identical sources with @xmath244  phot  s@xmath41 and @xmath245  k. similarly to test  1 , here we show the results by averaging the input physical quantities on all the cells of the plane at the same distance @xmath246 from cell ( 30,64,64 ) ( see fig .",
    "[ fig : test2sketch ] ) .",
    "the results refer to the final time @xmath201  yrs .",
    "figure [ fig : behaviour - lvartfix ] shows the profiles of the ionization fraction of some selected ions .    the profile of the h and he species is very similar to that of a single strmgren sphere ( see test 1 ) , with the exception of @xmath51 , which is always confined in regions very close to the sources and thus is not shown .    in the middle panel c@xmath6 ,",
    "c@xmath148 , si@xmath6 , si@xmath148 , o@xmath6 and o@xmath148 are shown together because they trace the external regions of the two overlapping strmgren spheres ( see fig .",
    "[ fig : cosiions ] ) .",
    "c@xmath148 , o@xmath148 and si@xmath148 are present for @xmath247 cells with different ionisation fractions ( @xmath248 , @xmath249 and @xmath250 ) , indicating that these ions have a different sensitivity to the ionising field ; this is also in qualitative agreement with the relative trends noticed in test 1 ( see fig .  [",
    "fig : cosiions ] ) .    in the lower panel @xmath251 ,",
    "@xmath252 and @xmath253 are shown . similarly to the species analysed in the previous panel , they present an almost constant value throughout the fully ionised region , with the exception of @xmath253 , which starts declining earlier , in favour of lower ionisation states .",
    "the absence of o@xmath5 , o@xmath172 and c@xmath172 ( which reach an ionisation fraction of only a few percent ) is consistent with the absence of he@xmath148 .",
    "compared to the corresponding species in test  1 , here the ionisation fractions are higher due to the larger ionisation rate .      in this section",
    "we discuss the variations in the results induced by changes in the ionisation rates .",
    "these are shown in figure [ fig : behaviour - l1varl2fixtfix ] for some reference species .",
    "first we have decreased the ionisation rates of the two sources simultaneously , maintaining the symmetry of the problem , i.e. using @xmath254  phot  s@xmath41 and @xmath255  phot  s@xmath41 , the latter being the minimum ionising rate allowing for an overlap of the two hii regions .",
    "we have then decreased the ionisation rate of only one source , while maintaining @xmath256  phot  s@xmath41 .",
    "as expected , the extent of the fully ionised region ( upper panel ) decreases with decreasing total ionisation rate .",
    "a similar trend is observed also in the profile of the other species , which changes smoothly with decreasing ionisation rate .",
    "compared to the behaviour of @xmath124 though , these differ in that also the amount of ionisation decreases .",
    "remarkably , @xmath257 seems to be insensitive to small variations of the ionisation rates , at least in the inner parts of the hii region .",
    "this suggests that other species would be more suitable to give indications on the characteristics of the sources .    by comparing qualitatively the results with those in figure  [ fig : cosiions ]",
    "we can conclude that ` crash3 ` produces the predictable behaviour for the ions also when more than one source is present and that it is sensitive to small changes in the source ionisation rates .",
    "this is very important for realistic applications of the code .      in this section",
    "we study the variations induced by changes in the temperatures @xmath240 and @xmath241 of the black - body spectra .",
    "the source ionisation rates are set to the reference value @xmath258 .",
    "the results in terms of distribution of some reference ionisation fractions are shown in figure  [ fig : behaviour - l1fix - l2fixtvar ] .    in the top panel",
    "the h@xmath6 i - front is identical in the cases @xmath259  k and @xmath260  k , while it recedes significantly for @xmath261  k. this is because by increasing the temperature from @xmath262  k to @xmath263  k , most of the photons still have @xmath264 and get preferentially absorbed by hydrogen because of its higher abundance .",
    "for these two cases @xmath125 ( which is not plotted here ) has a profile very similar to that of @xmath124 , with the only difference that it slightly increases with increasing temperature because more photons have @xmath265 . on the other hand ,",
    "when the temperature of the black - body spectra is increased to @xmath266  k , most of the photons have an energy in the vicinity of @xmath267 , causing a drop in @xmath124 and @xmath125 and the appearance of @xmath126 ( which is not plotted here ) , which was missing in the other cases , being relegated only in the immediate surroundings of the sources .    while for @xmath259  k there is hardly any c@xmath5 available because of the lack of enough photons with @xmath268 , as the spectrum temperature increases",
    "so does @xmath173 .",
    "increasing the black - body temperature further , and thus shifting the peak of the black - body spectrum to higher frequencies , brings a drop in @xmath173 , which is balanced by an equal increment of @xmath175 ( which is not shown in this plot ) .    unlike in the previous tests , in this case",
    "both si@xmath148 and si@xmath5 show remarkable changes by varying the spectrum temperature . while @xmath269 keeps decreasing as the temperature increases and higher ionisation states are favoured , @xmath252 increases from @xmath259  k to @xmath260  k , while it decreases when @xmath261  k , similarly to @xmath251 .",
    "also in this case we can conclude that crash3 is very sensitive to changes in the spectrum of the ionising sources .",
    "we have verified that a similar conclusion applies when only one of the two source temperature is changed or when we have adopted a power - law rather than a black - body spectrum .      $ ] in test  3 .",
    ", scaledwidth=50.0% ]    in this section we present an extension of the test  4 proposed in the cosmological radiative transfer comparison project @xcite . the original test",
    "set - up has been adopted , but we have extended the ics to include he , c , o and si . for reference ,",
    "the box size is @xmath270 co - moving , @xmath271 , @xmath272 , the simulation duration is set to @xmath273  yrs , starting at redshift @xmath274 .",
    "the cosmological evolution of the box is disabled and the simulation starts with a neutral gas at initial temperature @xmath108  k.    the h and he fractions are the same as in test 1 .",
    "16 point sources are present in the box with a black - body spectrum at @xmath111  k. the sampling of the spectrum is done with 91 frequencies , to reach the accuracy established in our test 1 .",
    "finally , we have used @xmath275 packets to ensure a good convergence as done in mck09 .",
    "it is important to note that the aim of this test is to show how the ` crash3 ` pipeline is applied to a realistic density configuration and the rich set of information provided by it , and it is not meant to quantitatively reproduce observational results .    differently from the previous tests in which we populated the full computational volume with metals , here we assign a metallicity of @xmath276 to those cells with an overdensity @xmath277 .",
    "this results in about 5 percent of metal enriched cells .",
    "the number density of c , o and si relative to the hydrogen are the same ones introduced at the beginning of the test section .    in figure [ fig :- test3citmaps1 ]",
    "the distribution of the c@xmath146 number density is shown in a slice of the simulation box containing the brightest source , located within the densest region in the computational volume .",
    "the distribution of si@xmath146 and o@xmath146 is the same , with @xmath278 and @xmath279 . by construction , most of the metals",
    "are concentrated in the vicinity of the sources and in general in the highest density regions .",
    "as shown in figure [ fig : tcorrectionmetallicity ] of test 1 , gas with metallicity @xmath280 starts to cool with different efficiency depending on the distance from the illuminating source ( see comments in the section ) , while for @xmath281 the cooling is relevant at every distance from the source . in the box of this test ,",
    "cells with @xmath282 , are only 0.012 percent of the total number , while cells with @xmath283 are about 4 percent .",
    "we then expect the effect of metal cooling to be negligible on the global ionisation status of the medium and we ignore it in discussing the results . in realistic 3d simulations",
    "the metal cooling should be carefully accounted for in all the cells with @xmath280 , because it acts differently depending on the gas metallicity and the rt effects shaping the field .",
    "the statistical effects of the metal cooling will be analysed with care in future applications in the context of physically motivated enrichment patterns .     in the same slice of figure  [ fig :- test3citmaps1 ] at the time @xmath284  yrs in test  3.,scaledwidth=50.0% ]        to better understand the distribution of the metal ionisation species discussed in the following , in figure [ fig :- test3citmaps2 ] we show the distribution of gas temperature in the same slice as above at a time @xmath284  yrs .",
    "black regions ( @xmath285  k ) correspond to areas not reached by the radiation field , the green color clearly traces the he@xmath6 ionisation fronts at a typical temperature @xmath286  k , while the red / orange is associated to regions at @xmath287  k , dominated by h@xmath6 and he@xmath6 .",
    "finally , warmer , yellow regions correspond to areas where there is also substantial he@xmath148 .",
    "the distribution of some reference metal species is shown in figure  [ fig : ion_metals ] across the same slice . while in the vicinity of the brightest source c@xmath172 is present in large quantities , with @xmath288 as high as 1 , only small traces are visible further away .",
    "on the other hand , these regions are typically rich in c@xmath148 , showing a qualitative behaviour similar to the one discussed in test  1 , where c@xmath172 and c@xmath148 are complementary species . consistently with the same test  1 , c@xmath5 is present everywhere along the filaments with relatively low abundances .",
    "regions with fractions close to zero are those which have not been reached by ionising radiation ( see fig .",
    "[ fig :- test3citmaps2 ] ) .",
    "a similar behaviour is observed for o , with o@xmath172 present in very small traces only in the vicinity of the brightest source , o@xmath5 extending a bit further away along the filaments and o@xmath148 being present in substantial amounts elsewhere . finally , while there are only traces of si@xmath5 , @xmath253 is as high as 1 in the vicinity of the source and si@xmath148 is present in modest quantities everywhere .    while it is not possible to make a quantitative comparison with test  1 , the qualitative results in terms of ionisation fractions at a given distance from the brightest source are in good agreement , with the highest ionisation levels present only in the close proximity of the source and the lower ionisation levels present everywhere along the filaments hit by the ionising radiation .",
    "similarly to what done in section  [ sec : lowerenergy ] , we have investigated the impact on the evaluation of metal ionisation states of photons with @xmath202  ev by extending the spectrum to to energies lower that @xmath289  ev down to @xmath290 . in figure",
    "[ fig : ion_metals_difference ] the differences in ionisation fractions ( @xmath291 ) computed in the two set - ups are reported for the same ions of figure  [ fig : ion_metals ] . as for test  1",
    ", we find that where @xmath292 the agreement between the case with and without the inclusion of the low energy tail is excellent in most of the metal enriched domain . @xmath293 and @xmath294 present an average discrepancy of about 13% , with a maximum of @xmath98 40% confined in few cells where the ionisation fractions are relatively low ( i.e. below @xmath98 30% ) . for higher @xmath295",
    "the agreement is excellent , reflecting the results in section  [ sec : lowerenergy ] , where the largest discrepancies were observed in correspondence of those cells in which the abundance of the different species was raising or declining . on the other hand",
    "@xmath209 always shows a good agreement between the two cases .",
    "the si and c ionisation fractions present a maximum discrepancy below 10% for their higher ( i.e. @xmath5 and @xmath172 ) ionisation species , while it raises to @xmath9840% for @xmath296 and @xmath269 .",
    "also for these species only few cells have such large discrepancies .",
    "in general we can conclude that , similarly to what seen in test  1 , the extension of the spectrum to energies lower than 13.6  ev results in some discrepancies in the evaluation of the metal ionisation fractions .",
    "such discrepancies are limited to some of the metal ions ( especially the lowest ionisation states ) and are largely due to a number of physical processes which are neglected ( see footnote of test 1 and the discussion in section  [ sec : lowerenergy ] ) . in the selected slice",
    ", they are also confined to a small number of cells typically located far from the ionising sources . as a reference , the percentage of metal enriched cells which present a discrepancy larger than 5% , 10% , 25% and 50% in the visualised species is 19.3% , 9.6% , 4.2% and 0.6% , respectively .",
    "in this paper we presented ` crash3 ` , the latest release of the 3d radiative transfer code ` crash ` . in its current implementation ` crash3 ` integrates into the reference algorithm the code ` cloudy ` to evaluate the ionisation states of metals , self - consistently with the radiative transfer through the most abundant species , i.e. h and he .",
    "the feedback of the heavy elements on the calculation of the gas temperature is also taken into account , making of crash3 the first 3d code for cosmological applications which treats self - consistently the radiative transfer through an inhomogeneous distribution of metal enriched gas with an arbitrary number of point sources and/or a background radiation .",
    "it should be noted that the algorithm is based on the assumption that metals do not contribute to the gas optical depth , which is valid in typical configurations of cosmological interest , as e.g. in the igm . on the other hand ,",
    "the code is not suitable for applications in which metallicities @xmath297 are involved .",
    "the pipeline has been tested in idealized configurations , such as the classic strmgren sphere , albeit enriched with heavy elements , as well as in a more realistic case of multiple sources embedded in a polluted cosmic web , which shows the rich set of information provided by the metal ionisation states . through these validation tests",
    "the new method has been proved to be numerically stable and convergent with respect to a number of parameters .",
    "the dependence of the results on e.g. the source characteristics ( spectral range and shape , intensity ) , the metal composition , the gas number density and metallicity has been investigated . despite the difficulty in testing quantitatively the results , we find that the qualitative behaviour is consistent with our expectations .    in conclusion",
    ", crash3 is an excellent code to simulate the evolution of various species in a low metallicity gas illuminated by an ionising radiation , which can be modelled both as a background radiation and point sources .",
    "crash3 will then be an invaluable tool to investigate the interpretation of e.g. metal absorption lines in quasars spectra or fluctuations in the uvb , in more detail , with a better modelling of the relevant physical processes and with a higher accuracy than done before .",
    "these applications are topics for further investigations .",
    "the authors would like to thank the referee , alexey razoumov , for his very constructive comments .",
    "the authors are also grateful to j. bolton , r. dav , a. ferrara and j. ostriker for enlightening discussions . am acknowledges the support of the dfg priority program 1177 .",
    "lg acknowledges the support of the dfg priority program 1573 .",
    "references    adelberger k.l . ,",
    "shapley a.e . ,",
    "steidel c.c .",
    ", pettini m. , erb d. k. , reddy n.a . , 2005 .",
    "apj , 629 , 636    allen m. g. , groves b. a. , dopita m. a. , sutherland r. s. , kewley l. j. , 1998 , apjs , 178 , 20a    aracil , b. , petitjean , p. , pichon , c. , & bergeron , j. 2004 , a&a , 419 , 811    baek s. , semelin b. , di matteo p. , revaz y. & combes f. , 2010 , a&a , 523a , 4b    becker g.d . , rauch m. , sargent w.l.w . , 2009 ,",
    "apj , 698 , 1010    becker g.d . ,",
    "sargent w.l.w . , rauch m. , calverley , a. , 2011 , apj , 735 , 93b    bolton , j.s . ,",
    "& viel , m. 2011 , mnras , 414 , 241    boksenberg a. , sargent w.l.w . , rauch m. , 2003 , arxiv : astro - ph/0307557    cen r. , bryan g. , 2001 , apj , 546 , 81    ciardi b. , ferrara a. , marri s. , raimondo g. , 2001 , mnras , 324 , 381    ciardi b , stoehr f. , white s.d.m .",
    ", 2003a , mnras , 343 , 1101    ciardi b. , ferrara a. , white s.d.m . , 2003b , mnras , 344 , l7    ciardi b. , bolton j. , maselli a. , graziani l. , 2011 , mnras , 423 , 558    cooksey k.l . , prochaska j.x . , thom c. , chen h .- w .",
    ", 2011 , apj 729,87 .",
    "cowie , l.l . ,",
    "songaila , a. 1998 , nature 394,44    dayal , p. , maselli a. , ferrara a. , mnras , 2011 , 430,380    dopita m.a . ,",
    "sutherland r.s . , 2003 , astrophysics of the diffuse universe , berlin , new york : springer , 2003 .",
    "astronomy and astrophysics library isbn 3540433627    draine b.t . , 2011 , physics of the interstellar and intergalactic medium , princeton university press    dubois y. , teyssier r. , 2007 , eas publications series , 24 , 95    ellison , s.l . ,",
    "songaila , a. , schaye , j. , & pettini , m. 2000 , aj , 120 , 1175    ercolano b. , barlow m. j. , storey p. j. & liu x .- w . , 2003 , mnras , 340 , 1136    ferland g.j . ,",
    "korista k.t . ,",
    "verner d.a .",
    ", ferguson j.w . ,",
    "kingdon j.b . ,",
    "verner , & e.m .",
    "1998 , pasp , 110 , 761    ferland g.j . , 2003 ,",
    ", 41 , 517    ferrara a. , pettini m. & shchekinov y. , 2000 , mnras , 319 , 519    furlanetto s. r. , loeb a. , 2003 , apj , 588 , 18    furlanetto s.r . , 2009 , apj , 703 , 702    gnedin , n.y . , ostriker j.p . , 1997 , apj 486 ,",
    "581    grevesse n. , sauval a. j. , 1998 , space science reviews , v. 85 , issue 1/2 , 161 - 174    hellsten u. , dav r. , hernquist l. , weinberg d.h .",
    ", katz n. , 1997 , apj , 487 , 482    hubeny i. , 2001 , aspc , 247 , 197    iliev i.t .",
    ", ciardi b. , alvarez m.a .",
    ", maselli a. , ferrara a. , gnedin n.y . , mellema g. , nakamoto t. , norman m.l . , razoumov a.o . ,",
    "rijkhorst e. , ritzerveld j. , shapiro p.r . , susa h. , umemura m. , whalen d.j . , 2006a , mnras , 371 , 1057    iliev i.t . , mellema g. , pen u.l . , merz h. , shapiro p.r . , alvarez m.a . ,",
    "2006b , mnras , 369 , 1625i    iliev i.t .",
    ", whalen d.j . , mellema g. , ahn k. , baek s. , gnedin n.y .",
    ", kravtsov a.v .",
    ", norman m.l . , raicevic m. , reynolds d.r . , sato d. , shapiro p.r . , semelin b. , smidt j. , susa h. , theuns t. , umemura m. , 2009 , mnras , 400 , 1283    jeeson - daniel a. , ciardi b. , maio u. , pierleoni m. , dijkstra m. , maselli a. , 2012 , arxiv:1204.2554    lu l. , 1991 , apj , 379 , 99    kulkarni v.p . ,",
    "fall s;m . , lauroesch j.t . , et al . , 2005 , apj , 618,68    madau p. , ferrara a. , rees m.j . , 2001 ,",
    "apj , 555 , 92    madau p. , haardt f. , 2009 , apjl , 693 , l100    maio u. , dolag k. , ciardi b. , tornatore l. , 2007 , mnras , 379 , 963 m    maio u. , ciardi b. , dolag k. , tornatore l. , khochfar s. , 2010 , mnras , 407 , 1003 m    maio u. , khochfar s. , johnson j. l. , ciardi b. , 2011 , mnras , 414 , 1145 m    maselli a. , ferrara a. , ciardi b. , 2003 , mnras , 345 , 379    maselli a. , ferrara a. , 2005 , mnras , 364 , 1429    maselli , a. , gallerani , s. , ferrara , a. , choudhury , t. r. , 2007 , mnras , 376 , l34-l38    maselli a. , ciardi b. , kanekar a. , 2009 , mnras , 393 , 171 ( mck09 )    maselli a. , ferrara a. , gallerani s. , 2009 , mnras , 395 , 1925    mcquinn m. , lidz a. , zaldarriaga m. , hernquist l. , hopkins , p.f . , dutta s. , faucher - gigure c. , 2009 , apj , 694 , 842    meiksin a.a . , white m. , 2003 , mnras , 342 , 1205    meiksin a.a . , 2009 , rev .",
    ", 81 , 1405    meyer , d.m . , & york , d.g .",
    "1987 , apj , 315 , 5    mosconi , m.b . ,",
    "tissera , p.b . ,",
    "lambas , d.g .",
    "& cora , s.a .",
    "2001 , mnras , 325 , 34 m    oh p.s . , 2002 , mnras , 336 , 1021    oppenheimer b.d .",
    ", dav r. , 2006 , mnras , 373 , 1265    oppenheimer , b.d .",
    ", dav r. , finlator k. , 2009 , mnras , 396 , 729    oppenheimer , b.d .",
    ", dav r. , katz n. , kollmeier j.a . , weinberg d.  h. , 2012 , mnras , 420 , 829    osterbrock d.e . & ferland g.j .",
    ", 2006 , astrophysics of gaseous nebulae and active galactic nuclei , second edition ( sausalito , california : university science books ) .",
    "partl a. m. , maselli a. , ciardi b. , ferrara a. , mller v. , 2011 , mnras , 414,428    petitjean p. , 2001",
    ", apss , 227s : 517 - 525    petitjean p. , in v. hill , fran  ois , f. , & primas f. , 2005 iau symposium 228    pettini m. , ellison s.l .",
    ", steidel c.c . ,",
    "bowen d.v . , 1999 ,",
    "apj , 510 , 576 .",
    "pieri , m.m .",
    "& haenhelt , m. g. 2004 , mnras , 347 , 985    pierleoni m. , maselli a. , ciardi b. , 2009 , mnras , 393 , 872p    rauch , m. , haehnelt m.g . , steinmetz m. , 1997 , apj , 481 , 601    ryan - weber e. v. , pettini m. , madau p. , zych b. j. , 2009 , mnras , 395 , 1476    scannapieco e. , ferrara a. , & madau p. , 2002 ,",
    "apj , 574 , 590    scannapieco c. , tissera p.b . ,",
    "white s.d.m .",
    ", & springel v. 2005 , mnras , 364 , 552s    scannapieco , e. , pichon ; c. , aracil , b. , petitjean , p. , thacker , r.j . ,",
    "pogosyan , d. , bergeron , j. , & couchman , h.m.p . , 2006 , mnras , 365 , 615    schaye , j. , rauch , m. , sargent , w.l.w . , & ki , t. 2000 , apj , 541l,1s    schaye , j. , aguirre , a. , kim , t. , rauch , m. , & sargent , w.l.w . 2003 , apj , 596 , 768    schaye j. , dalla vecchia c. , booth c. m. , et al . , 2010 , mnras , 402 , 1536    shen s. , wadsley j. , stinson g. , 2010 , mnras , 407 , 1581    simcoe r.a .",
    ", sargent w.l.w , rauch m. , 2004 , apj , 606 , 92    simcoe r.a .",
    ", cooksey k.l . , matejek m. , burgasser a.j . , bochanski j. , lovegrove e. , bernstein r.a .",
    ", pipher j.l .",
    ", forrest w.j . , mcmurtry c. , fan x. , omeara j. , 2011 , apj , 743 , 21s    smith b. , sigurdsson s. , abel t. , 2008 , mnras , 385 , 1443s    songaila a. , cowie , l.l .",
    "1996 , aj 112 , 335 .",
    "songaila , a. , 2001 , apj , 561 , l153    songaila a. , 2005 , aj , 130 , 1996    steidel c.c .",
    ", 1990 , apjs , 74 , 37 .",
    "sutherland r.s . ,",
    "dopita m.a .",
    ", 1993 , apjs , 88 , 253    thacker r.j .",
    ", scannapieco e. , davis m. , 2002 , apj , 202 , 581    tytler d. , fan x.m . , burles , s. , cottrell , l. , davis , c. , kirkman , d. , zuo , l. , 1995 , in meylon g. , ed . , proc .",
    "eso workshop , qso absorption lines , springer , berlin , 289 .",
    "tornatore l. , borgani s. , viel m. , springel v. , 2010 , mnras , 402 , 1911    trac h. , cen r. , 2007 , apj , 671 , 1 t    verhamme a. , schaerer d. , maselli a. , 2006 , a&a , 460,397    wiersma r. p. c. , schaye j. , smith b. d. , 2009a , mnras , 393 , 99w    wiersma r. p. c. , schaye j. , theuns t. , dalla vecchia c. , tornatore , l. , 2009b , mnras , 399 , 574w    wiersma r. p. c. , schaye j. , dalla vecchia c. , booth c. m. , theuns t. , aguirre a. , 2010 , mnras , 409 , 132w    wiersma r. p. c. , schaye j. , theuns t. , 2011 , mnras , 415 , 353w    zuo l. , 1992a , mnras , 258 , 36    zuo l. , 1992b , mnras , 258 , 45",
    "when the temperature feedback is introduced in the crash3 pipeline ( see description of step 3 ) @xmath71 times , the rt process is altered .",
    "while the gas recombination depends weakly on the temperature and we can expect negligible effects , the numerical convergence of the metal ionisation fractions needs be verified for different values of @xmath71 . here",
    "we show the results of some tests run to check the convergence of our results with respect to @xmath71 when the metal feedback is enabled .    in figure",
    "[ fig : feedbackconvergence ] we show the profile of the variation of a reference ionisation fraction ( @xmath298 ) and temperature for test  1 run with the metal feedback switched on .",
    "the lines refer to the final time @xmath201  yrs and to values of @xmath299 , 50 , 100 and 500 .",
    "the convergence of the results within the ionised sphere ( @xmath300 cells ) is excellent : even for small values of @xmath71 the relative discrepancies remain within few percent both in the ionisation fraction ( top panel ) and in the temperature ( bottom panel ) .",
    "numerical oscillations of a few percent ( or smaller ) in @xmath301 are present in a handful of isolated cells , but they disappear for @xmath302 .",
    "closer to the i - front ( @xmath303 ) , where @xmath298 is very small ( i.e. @xmath304 ) , the convergence is worse , in particular in the 2 - 3 cells encompassing the i - front .",
    "this behaviour was expected because , as already discussed in test 1 , the accuracy of our scheme is diminished in the outer regions of the ionised bubble , where the ` cloudy ` computation is not always convergent .",
    "it should be noticed , however , that @xmath298 presents one of the worse behaviours and higher ionisation states are more numerically stable .",
    "we have checked that the convergence is similar also at earlier times , when the ionised sphere has not reached an equilibrium configuration .",
    "other species show a similar dependence on @xmath71 .",
    "for example , @xmath251 presents an excellent convergence ( of the order of a percent ) within the ionised region already with @xmath299 , while in the proximity of the i - front , where @xmath305 , it degrades to tens of percent .",
    "the temperature shows an even better behaviour , with a relative convergence of a few percent even in the vicinity of the i - front .",
    "also at earlier times the convergence is never worse than 10% .",
    "the oscillations in the curves have the same origin of those in the upper panel .",
    "we should notice that the value of @xmath71 needed to reach a good convergence is likely dependent on the problem at hand .",
    "in general , though , we can conclude that we expect a value of @xmath306 to be sufficient for most applications which require the feedback of metals on the determination of the gas temperature .",
    "here we provide more details on the implementation of the relational database introduced in section  4 and the lookup strategy we use to query its data .",
    "the introduction of a relational database storing precomputed data is motivated by the huge number of ` cloudy ` computations ( @xmath307 ) needed by our pipeline in specific metal configurations .",
    "consider a general reionisation simulation involving @xmath308 density snapshots in which the metals are computed @xmath42 times on a sub - domain of @xmath309 cells ; the total number of computations ( @xmath307 ) is :      note that @xmath307 depends indirectly on the adopted grid resolution @xmath311 and the metal filling factor , therefore the size of the metal map @xmath312 can rapidly reach a high value .",
    "for instance , a simulation with @xmath313 , @xmath314 ( i.e. cell filling factor of 5% ) and @xmath315 requires @xmath316 computations in a single snapshot . as the direct evaluation of @xmath307 ` cloudy ` runs during the rt simulation is feasible just in few cases , we use a db of precomputed configurations to alleviate the total computational cost .",
    "the db stores a large number of ` cloudy ` runs abstracted as object - data associating initial conditions ( run_ics ) with the resulting ionisation fraction and temperature ( run_results ) ; this association is uniquely identified by an indexing key ( run_id ) .",
    "the set of run_ics is composed by the number densities of all the species @xmath317 polluting the metal contaminated sub - domain , the luminosity @xmath318 and the spectral shape @xmath319 , specified on a fixed number of frequency bins ( see section 4 ) .",
    "as detailed in the test section , 91 bins are generally required to obtain the accuracy of the tests in matching the hii fronts .",
    "as prescribed by the relation database theory , all the variables are organised in columns of the database tables and related by the run_id .",
    "the database solution is practically implemented by combining two relational databases : a reduced `` in - memory db '' ( called production db ) used during the rt ( see step 3 of the pipeline in section 4.3 ) , and an `` archiving db '' ( a standard tcp / ip accessible db ) collecting the results of many runs and increasing in time . before running a simulation the content of the smaller db is extracted from the archiving db and customised on the problem at hand as explained below .",
    "the content of the production db can be tuned on the specific problem under investigation because the ` crash3 ` pipeline is applied in post - processing and part of the run_ics can be partially pre - constrained .",
    "first , the @xmath317 values are exactly known from the hydro - simulation at fixed redshift , while the values of @xmath318 and @xmath319 can be only predicted because they are affected by the metal feedback .",
    "second , in the regime of applicability of our pipeline we tested that the metal cooling feedback is weak on the rt field and by running a rt simulation just through h and he ( the only absorbers , see section 4 ) we can have a reasonable estimate of the statistics of the produced spectral shapes .",
    "note also that in absence of feedback from metals @xmath318 and @xmath319 are provided exactly from step 2 at every time but @xmath307 can be huge and still require some pre - computed configurations to successfully finish the run .",
    "the db is then populated by spanning a subset of compatible ics providing a non - redundant set of final ionisation fractions and temperatures ; this is realised by testing the sensitivity of the photo - ionisation software to small variations ( @xmath322 , @xmath323 , @xmath324 ) of their values .",
    "an example of these tests is reported in section 5.1 when we studied the effects of the metal feedback on the resulting temperature and ionisation fractions ( see figures 9 and 10 ) .    during a crash3 simulation ,",
    "the pipeline is responsible for lookup the db at step 3 as explained in section 4.3 . to recognise a compatible pre - computed configuration in each @xmath67-cell of the metal polluted sub - domain ,",
    "step 3 performs a cascade of sql - select queries by comparing the run_ics of the interested cell with the run_ics records stored in the db tables , as explained below .",
    "the first query ( q_1 ) selects a resultset ( r_1 ) by querying for the compatible number densities : @xmath325 .",
    "the number of records ( i.e. table rows ) in r_1 is defined as @xmath326 .",
    "this is realised by a series of ` sql - between ` conditions on @xmath327 , concatenated by ` .and . `",
    "clauses ; in sql meta - code :                    finally , a q_3 query finds compatible spectral shapes @xmath319 in the resulset r_2 by simultaneously comparing the shape in every spectral bin within the tuned oscillation @xmath324 .",
    "q_3 provides a resultset r_3 with @xmath330 .",
    "this last query involves all the spectral bins and drastically reduces the number @xmath331 of final candidate configurations . on the other hand",
    "it is necessary to strictly compare the spectral shapes in every bin to guarantee that the spectral fluctuations due to rt effects are correctly accounted for and the full compatibility between results coming from the db queries and the ionisation fractions produced by the complementary on - the - fly runs .",
    "the set r_3 of candidate pre - computations is further reduced to @xmath332 final candidates by minimising the difference of their h and he ionisation fractions with the values found at step 2 ( see section 4.3 ) .",
    "we generally allow a maximum difference below 20 % for h and 10 % for both he fractions , but these values can be adapted to the problem at hand , increasing the precision of the matching criterion .",
    "the final result is then found as mid - point of the linear interpolation of their h , he and metal fractions if they are either sides of the step 2 results , otherwise just the configuration with the closer value is considered , first checking for @xmath50 and @xmath51 , and finally for @xmath49 . as an example of the accuracy obtained in the resulting configuration consider the convergence test in section 5.1.1 for a hii region .",
    "also notice that in all the cells with @xmath333 ( e.g. the first 8 cells of figure 2 ) , the configurations in the set r_3 can not be disentangled . in this case",
    "either the metal ionisation fractions differ within a threshold value ( normally @xmath140 ) and one of them is accepted , or the entire r_3 set is rejected and a on - the - fly run is performed .    as final comment",
    "we point out that the db solution has the only purpose of reducing the computational complexity of the problem by reusing previous computations and can not provide any general solution of the rt through metals , but must be targeted on the specific problem at hand .",
    "also note that for a maximum accuracy in the metal ion predictions , and when the value of @xmath307 implies a reasonable computational time , the db matching thresholds can be reduced or the db lookup can be excluded from the pipeline allowing just on - the - fly computations .",
    "this is the case of most single snapshot computations with medium resolution and low metal filling factor ."
  ],
  "abstract_text": [
    "<S> here we introduce ` crash3 ` , the latest release of the 3d radiative transfer code ` crash ` . in its current implementation ` crash3 ` integrates into the reference algorithm the code ` cloudy ` to evaluate the ionisation states of metals , self - consistently with the radiative transfer through h and he . </S>",
    "<S> the feedback of the heavy elements on the calculation of the gas temperature is also taken into account , making of crash3 the first 3d code for cosmological applications which treats self - consistently the radiative transfer through an inhomogeneous distribution of metal enriched gas with an arbitrary number of point sources and/or a background radiation . </S>",
    "<S> the code has been tested in idealized configurations , as well as in a more realistic case of multiple sources embedded in a polluted cosmic web . through these validation tests </S>",
    "<S> the new method has been proven to be numerically stable and convergent . </S>",
    "<S> we have studied the dependence of the results on a number of physical quantities such as the source characteristics ( spectral range and shape , intensity ) , the metal composition , the gas number density and metallicity .    [ dat : firstpage ]    cosmology : theory - radiative transfer - igm </S>"
  ]
}