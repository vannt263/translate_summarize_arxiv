{
  "article_text": [
    "for more than 100 years , optical astronomers have employed long - slit spectrographs to study the internal physics of heavenly objects .",
    "such data contain the target s spectrum dispersed at every location along a single position angle on the sky ( unless the target is an unresolved source ) .",
    "unfortunately , at every location along the slit , one also collects photons from the night - sky emission .",
    "this background must be removed from the data in order to reveal the spectrum of the intended target . with the expansion of spectroscopy to wide fields - of - view",
    ", one can employ multi - slit aperture plates to collect spectra for many objects simultaneously , or observe with a very long slit . over the past several years , important advances",
    "have been made in the art of background subtraction , though largely in the area of small - aperture spectroscopy , either with fibers or `` micro - slits '' ( e.g. , * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "* ) . however , or typical long- and multi - slit spectroscopy , the most common reduction procedures do not make optimal use of the data , and the resultant spectra with which one must perform one s science suffer in quality compared to what is achievable with more modern techniques and modest computing power .",
    "this paper outlines a new technique which makes optimal use of the data to accurately perform the subtraction of the unwanted background spectrum from two - dimensional spectra _ before _ any rebinning of the data is performed . in the procedure",
    "one makes full use of the spectrograph distortions to improve the sampling of the sky background spectrum .",
    "the quality of the background subtraction is completely insensitive to the magnitude of the distortions imposed by the spectrograph s camera , to the severity of the curvature of the spectral lines that is caused by the dispersive element , or even to any tilting of individual slitlets in an aperture mask .",
    "furthermore , by explicitly employing maps of the y - distortion and line curvature in a two - dimensional spectrum , the model two - dimensional background spectrum not only follows the same line curvature and y - distortion as the data , but the spectral features are sampled ( pixelated ) in exactly the same way as the features are sampled in the raw observations . as a result , when one subtracts the model from the data , there are absolutely no sharp residuals at the edges of night - sky emission lines",
    ". with more traditional methods , two - dimensional spectra must be rectified before one can perform the subtraction of the background ; such rectification procedures introduce artifacts into the data , particularly when the sampling is poor .",
    "these artifacts can manifest themselves as sharp residuals at the edges of features with strong gradients , e.g. , the night sky lines .",
    "furthermore , in traditional methods , observers are required to identify ( and remove ) cosmic rays and other bad pixels before rebinning the data . with the method discussed in this paper ,",
    "the sky subtraction is performed before the data have been rebinned , and , as a result , cosmic rays can be `` cleaned '' after the task of removing the sky background .    in the following sections , the method for fitting the two - dimensional night - sky background is described .",
    "subsequently , this powerful new technique is applied to data riddled with cosmic rays and bright night - sky emission lines .",
    "the examples include data from three spectrographs , in which the data span a range of sampling from marginal ( lris ) , to slightly under - sampled ( nirspec ) , to grossly under - sampled ( mike ) . and finally the the advantages of this method over traditional methods will be summarized .",
    "two - dimensional spectra , when ultimately imaged onto a detector , suffer from two problems that must be dealt with before or during the process of background subtraction : ( 1 ) the fact that the two - dimensional spectra are not aligned exactly along the rows ( or columns ) of the detector and are often curved with respect to the natural coordinate system of the detector ( the y - distortion ) ; and ( 2 ) the general tendency for dispersers to impose a wavelength - dependent line curvature onto the two - dimensional spectra ( which may have already been tilted or curved if the slit has been so cut into the aperture plate ) . furthermore , the coarse pixel sizes of modern detectors impose a third problem which normally limits the accuracy with which one could previously deal with the first two .    in order to discuss these issues and their resolution",
    ", we first define the image of two - dimensional spectroscopic data as @xmath0 , where @xmath1 are pixel coordinates in the system of the original image ( e.g. , a ccd frame ) . because of distortions imposed by the optics ,",
    "the spatial coordinate on the sky , @xmath2 , for a given pixel @xmath1 is a non - linear function , @xmath3 .",
    "furthermore , the wavelength of light , @xmath4 , incident onto a pixel @xmath1 is also a non - linear function of image position . for the purposes of modeling the two - dimensional background spectrum , we are less concerned with the actual wavelength , @xmath4 , of incident light than we are with the fact that there exists a coordinate system , @xmath5 , in which @xmath6 is a wavelength - dependent coordinate that is orthogonal to the spatial coordinate @xmath2 .",
    "the transformation to this system is @xmath7 such that the wavelength of light incident on a pixel can be written @xmath8 , where @xmath9 .",
    "thus there exists a convenient coordinate system @xmath5 for which @xmath10 .",
    "the transformations @xmath11 and @xmath12 can be measured with great precision from comparison lamp spectra or from the night - sky features themselves ( see , e.g. , * ? ? ? * for a description of a robust algorithm using ffts and cross - correlations in order to make full use of the available data to map these distortions ) .    with knowledge of @xmath11 and @xmath12 ,",
    "the traditional method of sky - subtraction required one to interpolate @xmath0 onto a regular grid in @xmath5 before fitting the two - dimensional sky spectrum at every individual interval of @xmath4 in the rebinned image .",
    "unfortunately , the process of rebinning the data ( 1 ) introduces correlated noise ; ( 2 ) smears cosmic rays and other bad pixels which might not have been flagged / cleaned beforehand ; and ( 3 ) produces artifacts at the edges of sharp features .",
    "this last problem sometimes leads users to invoke high spatial orders in the fitting of the sky background in order to subtract such artifacts at the edges of sky lines .",
    "furthermore , the rebinning of the data forces every sky spectrum used in the fit to have a common pixelation .",
    "this process limits one s ability to accurately model the two - dimensional sky spectrum where gradients ( e.g. , @xmath13 ) can be large .    instead of rebinning the data before performing the modeling of the two - dimensional sky spectrum",
    ", we propose that one should perform a least - squares fit to the sky spectrum using the original data - frame , in which the distortions and line curvature have not been removed .",
    "using @xmath14 and @xmath15 one should model the background spectrum in @xmath0 as a function of the rectified coordinates @xmath5 .",
    "each pixel in the original image represents an integral of the flux within a box the size of 1 pixel , but in the analysis each observed pixel s location is assumed to be @xmath5 , rather than @xmath1 . in this way , each pixel samples the sky spectrum at a _ known _ sub - pixel position .",
    "figure [ fig:5577 ] , in which a small section of an lris @xcite spectrum is shown , demonstrates the utility of this change in coordinate systems .",
    "the left - hand panel shows a region around 5577  in a short two - dimensional spectrum obtained using the 600 g / mm grating ( @xmath16 / pixel ) . the resolution is @xmath17 pixels ( fwhm ) .",
    "note in the image how pixelated the edges of the sky line are .",
    "rebinning such data would lead to spatially periodic artifacts along the edge of the line . in the right - hand panel ,",
    "the thick line shows the spectrum from one row , indicating how pixelated and poorly sampled the gradients in the line profile are in a given ccd row .",
    "the thin line shows the pixel values in the image @xmath0 as a function of @xmath18 , revealing how well the ccd frame samples the sky spectrum .",
    "such over - sampling is lost when one rebins the data .    in figure",
    "[ fig : section ] , a larger section of the same lris frame is shown in the top panel .",
    "the middle panel shows @xmath0 plotted as a function of @xmath12 .",
    "note that many spikes in the data are visible .",
    "these discrepant points correspond to cosmic rays and other bad pixels .",
    "fortunately , the sky spectrum is actually quite over - sampled in the rectified coordinate system , with many redundant measurements of the sky at nearly the same sub - pixel location .    because of the redundancy in the sampling of the background spectrum",
    ", it becomes straightforward to identify the cosmic rays and bad pixels , even when they appear where gradients in the background spectrum are large . in the bottom panel ,",
    "the thick line shows the spectrum sampled by a single row .",
    "the smooth line , shifted towards positive values , is a smoothed version of the data in the middle panel .",
    "the smoothing that was adopted was a running 30th - percentile within a window 30 data elements wide in @xmath6 .",
    "in the bottom panel , we also show the running @xmath19 scatter ( robustly determined ) within the same sliding window . by comparing @xmath0 with the smoothed spectrum in the middle panel",
    ", one can employ a simple @xmath20-clipping algorithm to reject the cosmic rays and bad pixels , even where there are strong gradients in @xmath0 .",
    "normally , the rejection / identification of cosmic rays or bad pixels involves the comparison of a pixel in an image with its nearest neighbors .",
    "however , because of the poor sampling of strong gradients in the background spectrum , one should compare a given pixel to those nearest only in @xmath21 , i.e. sampled at the same sub - pixel interval .",
    "thus , the smoothing is done on a copy of the array @xmath0 that has been sorted in order of increasing @xmath6 . because the line curvature ( plus the additional tilt of the slitlet ) has improved the sampling of the night - sky spectrum , cosmic rays that fall where there are strong gradients in the sky spectrum can still be robustly identified , as other ccd rows have sampled the sky spectrum with similar sub - pixel sampling as at the location of a given cosmic ray .",
    "while cosmic rays and other bad pixel values tend to be isolated sharp features , objects are generally extended in @xmath5 .",
    "the top panel of figure [ fig : object ] shows a subsection of data for a slitlet containing a bright object .",
    "the middle panel shows every pixel @xmath0 plotted , again , as a function of @xmath12 .",
    "most of the pixels in the data only contain flux from the night - sky background , and these data points follow a locus in the figure with very small scatter . as in figure",
    "[ fig : section ] , the cosmic rays are clearly visible above the well - defined background spectrum . also visible , however , is a collection of points in the data which peak above the sky spectrum at regular intervals of @xmath12 .",
    "if we take the residuals of @xmath0 from the robustly - smoothed version of the sky spectrum in the middle panel , and plot the statistical significance of those residuals against the spatial coordinate @xmath22 , as in the bottom panel of the figure , the object pixels are clearly visible as a significant positive deviation from zero . by employing the @xmath20-clipping described above for flagging cosmic rays , one also singles out those pixels that are significantly contaminated by flux from the object . in general a choice of clipping at 3 or @xmath19 is very effective at rejecting cosmic rays from the fit to the sky background , and it also rejects objects which could seriously affect the fit to the sky .",
    "faint objects , which do not peak above the adopted threshold tend not to affect the modeling of the sky and most such objects tend to cover too small a spatial area to adversely affect the fit anyway .",
    "while a clipping method works sufficiently well for most applications , one can straightforwardly implement an input set of sky apertures , outside of which pixels are simply ignored .",
    "sky apertures may be specifically useful in very short slitlets , where the the sky covers @xmath23 of the spatial extent of the slit .",
    "once the discrepant pixels are rejected , a bivariate b - spline ( e.g. , * ? ? ?",
    "* ) is constructed as an approximation to the remaining remaining data points as a function of their positions .",
    "however , the pixel values are not considered to represent a bivariate function of @xmath1 ( the original ccd coordinates ) but the data are treated as a bivariate function of @xmath24 . in the author",
    "s implementation of the method , the dierckx surface- and curve - fitting library available from netlib was used .",
    "this library allows one to weight each pixel during the fit for the b - spline coefficients , and these weights were set equal to the inverse of the expected noise .",
    "when fitting for the b - spline representation of a bivariate dataset , the smoothness of the model is set by the density of knots in the two cardinal directions . in the simplest construction of the two - dimensional sky background , the knot locations , @xmath25 and @xmath26 ,",
    "are chosen with a high density in @xmath6 such that @xmath27 with intervals of @xmath28 .",
    "the knots in @xmath2 are chosen to be @xmath29 , where the minima and maxima in @xmath6 and @xmath2 are derived for the slit being analyzed . in this way , the b - spline is non - parametric function in @xmath6 and a polynomial of order @xmath30 in @xmath2 .",
    "the choice of @xmath31 sets the order of the spatial variation in the sky spectrum at a fixed @xmath6 ( e.g. , fixed @xmath4 ) .    with the default choice of knots in @xmath6 described in the previous paragraph , the fit to the data very nearly approximates an interpolating spline along the wavelength - dependent coordinate .",
    "however , the b - spline was generated using data with finer sampling than that available in a single ccd row . as a result ,",
    "the spline is a smooth representation of the sky spectrum at those locations @xmath5 in the original data frame .",
    "one can reduce the number of knots in @xmath25 to impose greater smoothness on the model sky spectrum in those ranges of @xmath6 with little structure , while leaving a higher density of knots near bright night - sky emission lines in order to better match the gradients there . while such optimization of the knots in @xmath25 can improve the background modeling with particularly noisy data , the selection of @xmath25 described above is generally sufficient .",
    "one can also insert more knots in @xmath26 to model more complicated spatial variation in the sky ( at fixed @xmath4 ) . with clever placement of knots in the spatial direction ,",
    "the model can better map high - frequency spatial variations such as in data containing residual fringes in the very red portions of a spectrum .",
    "if the spatial variation in the sky spectrum is expected to be negligible , such as in very short slits , a one - dimensional b - spline can be fit to the values of @xmath0 as a univariate function of @xmath6 . in the bivariate method",
    "includes first finding the optimal univariate b - spline representation of the sky spectrum , with the resulting optimal knot locations subsequently used in the bivariate fit to the data . ]",
    "regardless of the complexity of the knot placement , the b - spline representation of the data is well - behaved because every pixel location in the original image , @xmath1 has a correspondingly unique , rectified coordinate @xmath5 . as a result",
    "the bivariate fit is well - defined and computationally inexpensive to construct .",
    "once the b - spline representation has been computed , it can be quickly evaluated at every @xmath5 location in the spectrum being analyzed . in this way",
    ", the two - dimensional background spectrum is only evaluated at the locations where the original pixels exist .",
    "therefore no interpolation at sub - pixel locations ( in @xmath32 ) occurs in the original data frame . as a result , there are no artifacts at strong gradients .    some examples of the application of this method of optimal background subtraction are shown in the next section .",
    "the examples shown below used the simplest knot selection in the above discussion .",
    "no optimization of knot location was implemented .",
    "finally , the examples were generated using @xmath33 and @xmath34 .",
    "the top panel of figure [ fig : subtract ] shows a section of two - dimensional spectrum from one strongly tilted slitlet .",
    "the wavelength range covers from blueward of na i to approximately 6300 .",
    "the second panel shows the model sky spectrum , derived using the new method .",
    "the third panel shows the difference between the two ( i.e. , the background - subtracted spectrum ) .",
    "note how well the night - sky emission lines are subtracted , with no residual systematic structure .",
    "the bottom panel shows an @xmath35-smoothed version of the background - subtracted image , normalized by the expected noise .",
    "this representation of the data illustrates that there is no additional noise at the locations of the sharp sky lines .",
    "figure [ fig : subtract2 ] follows a similar format as figure [ fig : subtract ] but for a different slitlet , and for a wavelength range 7000  @xmath36 7700 . as in the previous figure , the background subtraction is free of any residual systematic structure , and the noise in the background - subtracted image is as expected .",
    "figure [ fig : subtract3 ] shows a section of data with a wavelength range 7200  @xmath36 7600 .",
    "this section has a very strong cosmic ray at @xmath37 that sits along a large portion of a sky line .",
    "note how clean the sky - subtracted image is , again , with no systematic residuals at the locations of bright lines .",
    "figure [ fig : subtract4 ] shows a section of data with a wavelength range 5500  @xmath36 6500 .",
    "these data were taken from a slitlet at the edge of the lris field , at which the @xmath38-distortion , @xmath11 , has a very strong derivative with respect to @xmath39 . note how cleanly the bright sky lines 5577 , 5890 , 5896 , 6300 , etc . , are modeled and subtracted . as in the previous examples , there are no systematic residuals at the locations of bright night - sky features .      figure [ fig : nirspec1 ] shows a two - dimensional @xmath40-band spectrum obtained with nirspec @xcite .",
    "the dispersion is approximately 2.8 / pixel .",
    "the distortions in the data are large , and the sampling is poor .",
    "small sections of these data are also shown in figures [ fig : nirspec2 ] and [ fig : nirspec3 ] . in this example , the knots in the dispersion direction were located at half - pixel intervals .",
    "this choice was motivated by the strong distortions and length of the slit .",
    "together these allow for higher resolution in the reconstructed background spectrum .    even in coarsely sampled near - ir spectra",
    ", the method provides a two - dimensional model of the background with identical sampling as in the original data .",
    "thus , the sky background subtracts cleanly , with no systematic residuals at the locations of the night sky emission lines .",
    "when the sampling is this coarse , the observer should avoid interpolating sharp features , and observers now can choose whether to rebin the sharp features in the raw data or to rebin the sky - subtracted frame .",
    "figures [ fig : nirspec4 ] and [ fig : nirspec5 ] employ these nirspec data to directly compare this new methodology for sky - subtraction with traditional procedures . in the figures ,",
    "we show the nirspec data in two states : ( 1 ) sky - subtracted first and rectified second ; and ( 2 ) rectified first and sky - subtracted second . in the latter form ,",
    "strong , periodic artifacts are plainly visible at the locations of the night sky emission lines , where the under - sampled edges were rebinned . in the former , where the task of sky - subtraction was performed first , no sharp gradients remain in the data to introduce artifacts into the rectified frame . while this example shows a comparison of rectified two - dimensional sky - subtracted data , some readers may choose not to rebin their two - dimensional spectra at all , and opt for extracting one - dimensional spectra directly from the unrectified background - subtracted frames ( using knowledge of the two - dimensional wavelength solution ) .",
    "figures [ fig : mikered ]  [ fig : mike2 ] show data from a one hour integration with the red side of the mike echelle spectrograph on the clay 6.5 m telescope at magellan . because the optical path in mike @xcite involves using one prism as the primary disperser and the cross - disperser , the orders have large curvature and",
    "the spectra themselves show large line curvature .",
    "this exposure covers order # 62 ( bottom , central wavelength @xmath41 ) through order # 33 ( top , central wavelength @xmath42 ) .",
    "the data had been binned @xmath43 while reading the ccd to avoid being read - noise dominated , even with the one hour integration .",
    "the binning increases the fraction of the image contaminated by cosmic rays by a factor of four , and reduces the spatial extent of the slit to about 20 pixels .",
    "many users also use @xmath44 and even @xmath45 binning with mike , and as a result , most data obtained with mike will be severely under - sampled , and the binning leads to higher contamination rates with cosmic rays .    in figure",
    "[ fig : mike2 ] we show a direct comparison of a portion of the rectified sky - subtracted mike data ( similar to the comparison for nirspec data in figure [ fig : nirspec4 ] ) .",
    "while at such high resolution the night sky lines do not affect much of the data , one may still wish to recover accurate estimates of the object flux at the locations of the sky lines .",
    "in the right - hand panel of figure [ fig : mike2 ] there are clear artifacts at the locations of the sky - lines and such artifacts render the science data useless at those wavelengths . in the left - hand panel ,",
    "the object spectrum is not contaminated by the artifacts introduced by the rebinning of night sky lines .",
    "the examples shown in this section illustrate a range of results from the modeling procedure outlined in this paper . in all cases ,",
    "when the distortions and line curvature are accurately known , the sky background shows very little spatial variation when fit in the rectified coordinate system ( see  [ sec : proc ] ) . the need for a high spatial order",
    "is only required when using traditional methods , and artifacts at the edges of sky lines are not well modeled with low - order polynomials .",
    "because of this , observers can also apply this method to short slitlets using one - sided sky , restricting the b - spline to one dimension ( wavelength ) or perhaps only limiting the spatial order to @xmath34 .",
    "in such cases , the only factor limiting the accuracy of the sky subtraction would be flat - fielding and other techniques may prove more valuable ( e.g. , * ? ? ?",
    "this paper describes a new method for modeling the background in two - dimensional slit spectroscopy.kelson .",
    "though no documentation currently exists , readers may download at their discretion . ]",
    "this method makes full use of the data in its `` raw '' state  before the data have been rectified ( rebinned ) .",
    "the distortions inherent in the data provide the means by which the background spectrum can be accurately modeled at repeated sub - pixel locations . because of the improved sampling of the background spectrum in the original data compared to a rectified image",
    ", one can also robustly reject pixels contaminated with cosmic rays and bright objects . because of these advantages over traditional background - subtraction techniques ,",
    "the task of subtracting the two - dimensional background spectrum should now be performed as one of the first steps in any pipeline of spectroscopic reduction , even before cosmic rays and other bad pixels have been `` cleaned '' .",
    "the subtraction of the background can now be performed on raw spectra , riddled with cosmic rays . as a result",
    ", the procedure can be adopted as one of the first steps in a pipeline for spectral reduction , and not as one of the last .",
    "the task is computationally inexpensive and can allow observers to quickly analyze incoming data at the telescope , assuming the distortion maps have been characterized from calibration data during the previous afternoon , or are known _ a priori _ from an optical model of the instrument .",
    "after the background has been subtracted the cosmic rays can be flagged trivially , without the need for complicated cosmic ray identification procedures .    because the algorithm is utilizing the full sampling of the background spectrum produced by the distortions in the raw data , the method is making optimal use of the available data .",
    "while this procedure has been presented in the context of taking full advantage of the optical distortions and spectral line curvature to recover better sampling of areas with strong gradients in the data , the method works just as well on data for which the line curvature is negligible .",
    "this recovery of the two - dimensional background spectrum leaves no systematic residuals at the locations of strong gradients simply because the model is never interpolated at locations where the data do not exist .",
    "the model is always sampled where the original data exist . as a result",
    ", the sharp gradients , such as those at the edges of bright sky emission lines , are never rebinned and ringing does not occur .    for spectrograph / detector combinations that over - sample the data ( e.g. , deimos and the imacs long camera ) , traditional methods may be deemed satisfactory by many observers",
    "however , in near - ir or high - resolution echelle spectroscopy , the data may be binned and/or under - sampled in order to reduce the importance of read noise .",
    "regardless of the source of one s spectroscopic data , observers now can choose whether to rebin their data _ with _ or _ without _ the sharp night - sky features present .",
    "observers may now choose the latter , as the rebinning of coarsely sampled features produces unwanted artifacts that prevent the accurate modeling of the background , and prevent the accurate recovery of an object s flux at every observed wavelength .    nevertheless , for observers who wish to proceed from the telescope to extracted spectra in the fewest number of steps possible , without the additional correlated noise introduced by rebinning ones data , and without any artifacts caused by rebinning any strong gradients , computational machinery",
    "has now caught up to your demands .",
    "the author would like to thank the staff at the carnegie observatories for their support , and in particular p. martini and m. rauch for the use of their nirspec and mike data .",
    "furthermore , the anonymous referee is acknowledged for ensuring that this work is received by a broader audience ."
  ],
  "abstract_text": [
    "<S> in two - dimensional spectrographs , the optical distortions in the spatial and dispersion directions produce variations in the sub - pixel sampling of the background spectrum . using knowledge of the camera distortions and the curvature of the spectral features </S>",
    "<S> , one can recover information regarding the background spectrum on wavelength scales much smaller than a pixel . as a result </S>",
    "<S> , one can propagate this better - sampled background spectrum through inverses of the distortion and rectification transformations , and accurately model the background spectrum in two - dimensional spectra for which the distortions have not been removed ( i.e. the data have not been rebinned / rectified ) . </S>",
    "<S> the procedure , as outlined in this paper , is extremely insensitive to cosmic rays , hot pixels , etc . because of this insensitivity to discrepant pixels , sky modeling and subtraction </S>",
    "<S> need not be performed as one of the later steps in a reduction pipeline . </S>",
    "<S> sky - subtraction can now be performed as one of the earliest tasks , perhaps just after dividing by a flat - field . because subtraction of the background can be performed without having to `` clean '' cosmic rays , such bad pixel values can be trivially identified after removal of the two - dimensional sky background . </S>"
  ]
}