{
  "article_text": [
    "free energy is a central concept in thermodynamics and in modern works on biochemical and physical systems .",
    "typical examples studied by computer simulations include the solvation free energies ( which is the free energy difference between a molecule _ in vacuo _ and its counterpart surrounded by solvent molecules ) and the binding free energy of two molecules ( which determines whether a new drug can have an efficient action on a given protein ) . in many applications , it is actually the free energy difference profile between the initial and the final state which is a quantity of paramount importance .",
    "it is observed by practitioners that free energy barriers are a very important element to describe transition kinetics from one state to the other .",
    "for instance , the chemical kinetics of reactions happening in solvent ( such as in the cells of our bodies ) are limited by free energy barriers , and can take place only when the free energy difference between the initial and the final state is negative , or at least less than the typical thermal energy .",
    "it is therefore very important to accurately compute free energy differences in order to assess the likelihood of a certain physical event to happen .    beside these physical motivations to compute free energy differences ,",
    "a more abstract motivation is to overcome sampling barriers encountered when computing canonical averages ( see the discussion in  ( * ? ? ?",
    "* section  1.3.3 ) ) .",
    "indeed , it is often the case in practice that the trajectories generated by the numerical methods at hand remain stuck for a long time in some region of the phase space , and hop only occasionally to another region , where they also remain stuck  a behavior known as metastability .",
    "chemical and physical intuitions may guide the practitioners of the field towards the choice of some slowly evolving degree of freedom , called _ reaction coordinate _ in the following , responsible for the metastable behavior of the system . in this case",
    ", free energy techniques can be used to accelerate the sampling .",
    "this viewpoint allows to consider applications which are not motivated by physical or biological problems , such as curing sampling issues in bayesian statistics  @xcite .    in this introductory section ,",
    "we present the main results and give the outline of the paper , highlighting the three main contributions of this work .",
    "we only briefly define the concepts we need in this general introduction , and refer the reader to the following sections ( in particular section  [ sec : notation ] ) for further precisions on the mathematical objects at hand .",
    "we consider mechanical systems with constraints .",
    "the configuration of a classical @xmath0-body system is denoted by @xmath1 .",
    "the results of the paper can be generalized _ mutatis mutandis _ to periodic boundary conditions ( @xmath2 , where @xmath3 denotes the one dimensional torus ) , or to systems with positions confined in a domain @xmath4 .",
    "the mass matrix of the system is assumed to be a constant strictly positive symmetric matrix @xmath5 .",
    "one could typically think of a diagonal matrix @xmath6 .",
    "the interaction potential is a smooth function @xmath7 .",
    "the hamiltonian of the system is assumed to be separable : @xmath8 in the present paper , the focus is on the canonical ensemble , which is the equilibrium probability distribution of microscopic states of a system at fixed temperature ( fixed average energy ) . for systems without constraints",
    ", this ensemble is characterized by the probability distribution @xmath9 where @xmath10 is the normalizing constant is assumed to be such that @xmath11 . ] ensuring that @xmath12 is indeed a probability distribution , and @xmath13 is proportional to the inverse temperature .",
    "one dynamics which admits the canonical measure   as an invariant measure is the langevin dynamics ( see for instance  ( * ? ? ?",
    "* section  2.2.3 ) and references therein ) : @xmath14 where @xmath15 is a standard @xmath16-dimensional brownian motion , and @xmath17 are @xmath18 position dependent real matrices which are assumed to satisfy the fluctuation - dissipation identity @xmath19 the langevin dynamics can be seen as some modification of the hamiltonian dynamics with two added components : a damping term @xmath20 and a random forcing term @xmath21 . the energy dissipation due to the damping is compensated by the random forcing in such a way that the temperature of the system is  @xmath22 ( with @xmath23 boltzmann s constant ) .",
    "we will consider positions subject to a @xmath24-dimensional mechanical constraint denoted by @xmath25 as will become clear below , constrained systems appear in computational statistical physics in two kinds of contexts ( see _ e.g. _ ( * ? ? ?",
    "* chapter  10 ) , and  @xcite for applications to the computation of free energy differences , and @xcite for mathematical textbooks dealing with constrained hamiltonian dynamics ) :    a.   for free energy computations , where @xmath26 is a given reaction coordinate parameterizing a transition between  states  of interest ; b.   when the system is subject to molecular constraints such as rigid covalent bonds , or rigid bond angles in molecular systems .    in the sequel , @xmath26 may be thought of at first reading as a reaction coordinate ( case ( i ) ) .",
    "section  [ ti - sec : mc ] explains how to handle additional molecular constraints ( case ( ii ) ) within the same formalism . in any case",
    ", the position of the system is constrained onto the submanifold of co - dimension  @xmath24 : @xmath27 and the associated phase space is the cotangent bundle denoted by @xmath28 for a given @xmath29 , the set of cotangent momenta is denoted by @xmath30 the orthogonal projection on @xmath31 with respect to the scalar product induced by @xmath32 is denoted @xmath33 where @xmath34 is the gram matrix associated with the constraints @xmath35 throughout the paper , we assume that @xmath36 is invertible everywhere on @xmath37 ( for all  @xmath38 ) .",
    "it is easily checked that @xmath39 satisfies the projector property @xmath40 , and the orthogonality property @xmath41      for constrained systems , the associated canonical distribution is defined by @xmath42 where @xmath43 is the phase space liouville measure of @xmath44 , and @xmath45 the normalizing constant ( @xmath38 refers to the position constraint , and @xmath46 to the velocity or momentum constraint , see   below ) .",
    "see section  [ sec : measures ] for precise definitions .    a dynamics admitting the constrained canonical measure   as an invariant equilibrium measure is the following langevin process ( `` cl '' stands for `` constrained langevin '' ) : for a given initial condition @xmath47 , @xmath48     \\dps   d p_{t } = -\\nabla v(q_{t } ) \\ , dt -\\gamma(q_t ) m^{-1}p_t \\ , dt       + \\sigma(q_t ) \\ , d w_t + \\nabla \\xi(q_{t } ) \\ , d \\lambda_t , & \\\\[6pt ]      \\dps \\xi(q_{t } ) = z , & ( c_q )    \\end{cases}$}\\ ] ] where the @xmath49-valued adapted process @xmath50 is the lagrange multiplier associated with the ( vectorial ) constraint @xmath51 , and @xmath17 are again assumed to satisfy  .",
    "note that @xmath52 for all @xmath53 .",
    "then , averages of an observable @xmath54 with respect to the distribution   can be obtained as longtime averages along any trajectory of the dynamics  @xmath55 ( when @xmath56 is symmetric positive on  @xmath37 ) : @xmath57 this is made precise in section  [ sec : sampling ] .",
    "several recent studies ( _ e.g. _ @xcite ) have analyzed dynamics similar to  @xmath55 and some appropriate discretization of the process in order to approximate the left - hand side of  .    of our work",
    "is to propose a simple discretization of the dynamics  @xmath55 and to highlight its remarkable properties .",
    "the numerical scheme is based on a splitting strategy between the hamiltonian and the thermostat part , see equations  -- below ( in the spirit of the scheme proposed in  @xcite in the unconstrained case ) .",
    "the hamiltonian part is discretized using a verlet scheme with position and momentum constraints ( the so - called rattle scheme , see  @xcite ) .",
    "we show that this discretization enjoys the following properties : ( i ) for some choice of the parameters , an euler discretization of the _ overdamped _ langevin dynamics ( also called brownian dynamics ) with a projection step associated with the constraints is obtained ( see equation   and proposition  [ p : langtooverd ] ) ; ( ii ) it can be completed by a metropolis - hastings correction to obtain a generalized hybrid monte carlo ( ghmc ) method sampling _ exactly _ ( _ i.e. _ without any bias due to time - discretization ) the constrained canonical distribution   ( see algorithm  [ a : ghmcconst ] below ) .",
    "the so - obtained numerical scheme is close to the ones proposed in  @xcite .",
    "see also  @xcite for historic references on hybrid monte carlo methods , and  @xcite for ghmc .",
    "one output of this part is thus a new metropolization procedure for overdamped langevin dynamics to sample , without bias , measures with support a submanifold .",
    "the free energy @xmath58 associated with the reaction coordinates @xmath59 is defined as @xmath60 times the log - density of the marginal probability distribution of the reaction coordinates @xmath26 under the canonical distribution  .",
    "explicitly , it is defined through the following relation : for any test function @xmath61 , @xmath62 in words , @xmath63 is the image of the measure @xmath12 by @xmath26 , and @xmath64 can be seen as an `` effective potential energy '' associated to @xmath26 .    computing the free energy profile @xmath65 (",
    "up to an additive constant independent of  @xmath38 ) , or free energy differences between two states @xmath66 is a way to compare the relative probabilities of different  states",
    " parameterized by @xmath26 .",
    "this is a very important calculation for practical applications , see  @xcite .",
    "a state should be understood here as the collection of all possible microscopic configurations @xmath67 , distributed according to the canonical measure  , and satisfying the macroscopic constraint @xmath68 .",
    "since we only focus on computing free energy differences , @xmath64 is defined up to an additive constant ( independent of @xmath38 , denoted by  @xmath69 below , and whose value may vary from line to line ) and can be rewritten as : @xmath70 where @xmath71 denotes the conditional measure on @xmath37 verifying the following identity of measures in  @xmath72 : @xmath73 ( see section  [ sec : measures ] for more precisions on this relation ) .",
    "however , when using constrained simulations in phase space , the momentum variable of the dynamical system is also constrained , and a modified free energy ( called `` rigid free energy '' in the sequel , see remark   below for a justification of the term `` rigid '' ) is more naturally computed , see section  [ sec : sampling ] . the latter is defined as @xmath74 the superscript @xmath5 indicates that this free energy depends on the considered mass matrix , even though this is not clear at this stage ( see   below ) .",
    "the above two definitions of free energy are related through the identity : @xmath75 where @xmath76 is the equilibrium distribution with constraints  .",
    "the relation  , already proposed in  @xcite ( see also  @xcite for related formulas ) , is proved at the beginning of section  [ sec : langti ] .",
    "for any value of the reaction coordinate , the difference @xmath77 can then be easily computed with any method sampling the probability distribution @xmath76 , such as  @xmath55 .",
    "several methods have been suggested in the literature to compute either @xmath64 or @xmath78 from the lagrange multipliers of a constrained process similar to  @xmath55 .",
    "we refer for instance to  @xcite ( and references therein ) for the hamiltonian case , and to  @xcite ( and references therein ) for the overdamped case . of this paper",
    "is twofold : ( i ) we rigorously prove that the longtime average of the lagrange multipliers in  @xmath55 converges to the gradient of the rigid free energy   ( the so - called _ mean force _ ) ; and ( ii ) we then show that the latter mean - force can be computed with second order accuracy ( _ i.e. _ up to @xmath79 error terms , where @xmath80 is the time - step ) using the lagrange multipliers involved in the hamiltonian part of the splitting scheme .",
    "more precisely , the first point ( i ) amounts to showing that @xmath81 as compared to @xcite , where a formal proof for the hamiltonian case is proposed , we use an explicit calculation that does not require the use of the lagrangian structure of the problem , or a change of coordinates . once @xmath82 is obtained , @xmath83 can be computed ( up to an additive constant ) by integration .",
    "this procedure is known as _ thermodynamic integration_. note that using   and thermodynamic integration , together with , allows to obtain @xmath84 without computing second order derivatives of  @xmath26 .",
    "this is a desirable property since computing such high derivatives may be cumbersome for some reaction coordinates used in practice .",
    "straightforward computations of the mean force using analytical expressions ( see for instance  - ) usually involve such high order derivatives .    the second point ( ii )",
    "is then based on a discretization of a variant of  , obtained by subtracting the martingale part of the lagrange multipliers .",
    "this amounts to averaging the two lagrange multipliers involved in the rattle part of the scheme , see  ) .",
    "we also discuss how these techniques can be generalized to compute the free energy for systems with molecular constraints , see section  [ ti - sec : mc ] .",
    "the last part of this article is devoted to nonequilibrium methods for free energy computations , based on a hamiltonian or langevin dynamics with constraints subject to a predetermined time evolution .",
    "such methods rely on a nonequilibrium fluctuation equality , the so - called jarzynski - crooks relation .",
    "see  @xcite for a pioneering work , as well as  @xcite for an extension .",
    "they are termed `` nonequilibrium '' since the transition from one value of the reaction coordinate @xmath26 to another one is imposed _ a priori _ , in a finite time@xmath85 , and with a given smooth deterministic schedule @xmath86",
    "\\mapsto z(t ) \\in \\mathbb{r}^\\nc$ ] .",
    "in particular , it may be arbitrarily fast",
    ". therefore , even if the system starts at equilibrium , it does not remain at equilibrium .",
    "the out - of - equilibrium langevin process we consider to this end is given by the following equations of motion ( `` scl '' stands for `` switched constrained langevin '' ) : @xmath87      d p_t & = -\\nabla v ( q_t )   \\,dt -\\gamma_p(q_t ) m^{-1 } p_t \\ , dt+ \\sigma_p(q_t )   \\,d w_t   + \\nabla",
    "\\xi(q_t ) \\ , d \\lambda_t , \\\\[6pt ]      \\xi(q_t ) & = z(t ) , \\hspace{5 cm } ( c_q(t ) )    \\end{aligned } \\right.$}\\ ] ] where @xmath88 is an adapted process enforcing the constraints @xmath89 ( the lagrange multipliers ) .",
    "initial conditions are sampled from the phase - space canonical distribution defined by the constraints @xmath90 and @xmath91 ( see  ) .",
    "we restrict ourselves to projected fluctuation - dissipation matrices of the specific form @xmath92 where @xmath93 satisfy the fluctuation - dissipation identity  .",
    "note that @xmath94 also verify  .",
    "our analysis also applies to deterministic hamiltonian dynamics upon choosing @xmath95 .",
    "the dynamics  @xmath96 is a natural extension of the constrained langevin dynamics  @xmath55 .",
    "it is different from the dynamics proposed in  @xcite , which is a langevin dynamics associated with a modified hamiltonian with projected momenta , driven by a forcing term along @xmath97 which acts directly on the position variable . as explained below ( see   and the discussion following this equation ) , the specific choice   ( rather than considering unprojected matrices @xmath93 ) leads to a simpler analysis and more natural numerical schemes , based again on a splitting procedure .    as explained in section  [ sec : jarz_lang_cons ] , it is possible to define the work associated with the constraints exerted on the system between time @xmath46 and @xmath98 as the displacement multiplied by the constraining force : @xmath99 of the present paper is twofold : ( i ) we derive a new general crooks - jarzynski relation ( see theorem  [ th : crookslangcons ] below ) based on the nonequilibrium constrained dynamics  @xmath96 and the associated work defined in  ; and ( ii ) an original numerical scheme is proposed , which allows to compute free energy differences _ without time discretization error _ ( see theorem  [ eq : jarz_disc ] below ) .",
    "more precisely , concerning the first point , the main corollary is given by the following result .",
    "consider the corrector @xmath100 where @xmath101 is the so - called fixman term due to the geometry of the position constraints ( see   and remark  [ rem : highosclang ] ) , and @xmath102 is the kinetic energy term due to the velocity of the switching .",
    "then , the free energy profile can be computed through the following fluctuation identity ( see  ):",
    "@xmath103   } \\right)}{\\e\\left(\\rme^{-\\beta c(0,q_0 )    } \\right ) } \\right),\\ ] ] where the expectation is with respect to canonical ( equilibrium ) initial conditions and for all realizations of the dynamics  @xmath96 .    the numerical scheme mentioned in the second point ( ii ) above",
    "is based on a modification of the splitting scheme used to discretize the constrained langevin dynamics  @xmath55 .",
    "this modification allows to take into account the evolving constraints . using the symplecticity of the modified rattle scheme",
    ", we are able to prove a discrete - in - time version of the crooks relation , and of the associated jarzynski free energy estimator  . moreover",
    ", for some choice of the parameters , the latter scheme yields a jarzynski - crooks relation for an euler discretization of the overdamped langevin ( brownian ) dynamics with a projection step associated with the evolving constraints , without time discretization error .",
    "this can be seen as an extension of the scheme formerly proposed in  @xcite ( see equation   and proposition  [ p : langtooverd_jarz ] ) .",
    "we also check the consistency of the various free energy estimators we introduce .",
    "we start with an introduction to the mathematical concepts required for mechanically constrained systems in section  [ sec : notation ] .",
    "section  [ sec : sampling ] is devoted to the properties and the discretization of mechanically constrained langevin processes defined by  @xmath55 , and the problem of sampling the canonical distribution  .",
    "thermodynamic integration with constrained langevin processes is presented in section  [ sec : langti ] .",
    "section  [ sec : lang_jarz ] discusses nonequilibrium constrained langevin processes  @xmath96 and the associated jarzynski - crooks fluctuation identity  .",
    "finally , some technical lemmas are gathered in section  [ sec : appendix ] .",
    "after making precise our notation for matrices and matrix valued functions in section  [ sec : matrix_notation ] , we introduce some additional concepts required to describe constrained systems in section  [ sec : const_notation ] , and define the phase space measures with constraints in section  [ sec : measures ] .      throughout the paper ,",
    "the following notation is used :    * vectors and vector fields are by convention of column type .",
    "when vectors are written as a line , they should be understood as the corresponding column version .",
    "for instance , @xmath104 should be understood as @xmath105 , where @xmath106 are both column vectors .",
    "* gradients in @xmath72 ( or @xmath107 ) of @xmath24-dimensional vector fields are by convention @xmath108-matrices , for instance : @xmath109 where @xmath110 is a column vector for any @xmath111 .",
    "gradients in the space of constraints parameters @xmath112 or @xmath113 are denoted with the associated subscripts , namely @xmath114 and @xmath115 . * second order derivatives in @xmath72 of @xmath24-dimensional vector fields are characterized through the hessian bilinear form : @xmath116 where @xmath117 are test vectors . *",
    "the canonical symplectic matrix is denoted by : @xmath118 for any smooth test functions @xmath119 and @xmath120 , the poisson bracket is the @xmath121 matrix @xmath122 * for two matrices @xmath123 , @xmath124 .",
    "contrarily to what is often done in the literature , we avoid global changes of variables and the use of generalized coordinates .",
    "we observe that global changes of variables are not required for the proofs of the theoretical results we present , and they are definitely to be avoided in practical numerical computations whenever possible",
    ".    two useful concepts to study constrained hamiltonian systems ( in particular , to use the co - area formula in phase space , as well as the poisson bracket formulation of the liouville equation ) are the effective velocity @xmath125 and the effective momentum @xmath126 associated with the constrained degrees of freedom @xmath26 : @xmath127 and @xmath128 the expression of the effective velocity is obtained by deriving the constraint @xmath26 along an unconstrained trajectory of the hamiltonian dynamics @xmath129",
    "\\dps   \\frac{d \\tilde p_t}{dt } = -\\nabla v(\\tilde q_t ) , \\end{cases}\\ ] ] since @xmath130 the term @xmath131 in the expression   of the effective momentum may be interpreted as the effective mass of @xmath26 .",
    "this can be motivated by a decomposition of the kinetic energy of the system into tangential and orthogonal parts , using the projector for a given position @xmath132 :",
    "@xmath133 the orthogonal part can be rewritten , for any @xmath1 , as : @xmath134 the last equations allow to consider @xmath135 as some effective mass .",
    "the constraints on a mechanical system can also be reformulated in the more general form @xmath136 where either ( i ) the effective momentum is constrained , in which case @xmath137 and @xmath138 ; or ( ii ) the effective velocity is constrained , in which case @xmath139 and @xmath140 . the phase space associated with such constraints is denoted by @xmath141 a position @xmath142 being given , the affine space of constrained momenta verifying   is then denoted by @xmath143 in the effective velocity case , and by @xmath144 in the effective momentum case .",
    "this notation is very important for nonequilibrium methods where the constraints evolve in time according to a predefined schedule , see section  [ sec : lang_jarz ] .",
    "note that the phase space of mechanical constraints , defined by , is simply @xmath145 .",
    "we can now define the skew - symmetric gram tensor of dimension @xmath146 associated with the constraints : @xmath147 the gram matrix @xmath148 associated with the generalized constraints can be explicitly computed by block . indeed , for @xmath149 , @xmath150 therefore , @xmath151 in this case .",
    "in the case @xmath152 , the gram matrix reads @xmath153 and @xmath154 .",
    "note that in both cases @xmath155 .",
    "the constrained symplectic ( skew - symmetric ) matrix is now defined by @xmath156 and the poisson bracket associated with generalized constraints   by : @xmath157 this poisson bracket is often called the dirac bracket in the literature ( in reference to the seminal work of dirac  @xcite ) .",
    "it is easily checked that @xmath158 verifies the characteristic properties of poisson brackets , namely the skew - symmetry , jacobi s identity , and leibniz rule .",
    "therefore , the flow associated with the evolution equation @xmath159 defines a symplectic map .",
    "recall that ( see  ( * ? ? ?",
    "* section  vii.1.2 ) ) a map @xmath160 is symplectic if for any @xmath161 and @xmath162 , @xmath163 a consequence of the symplectic structure is the divergence formula   relating the phase space measure @xmath164 on @xmath165 ( defined below ) , and the poisson bracket  .",
    "the reader is referred to chapter  @xmath166 in  @xcite , and section  vii.@xmath167 in @xcite for more material on constrained systems .",
    "it will be shown in proposition  [ s : p : lconstgen ] below that the poisson system   is equivalent to  @xmath55 when @xmath168 .",
    "the phase space measure ( also termed liouville measure ) on the phase space @xmath169 ( or more generally on @xmath165 ) of constrained mechanical systems is denoted by @xmath170 ( or more generally @xmath171 ) .",
    "the latter is induced by the symplectic , or skew - symmetric @xmath172-form on @xmath107 defined by the canonical skew - symmetric matrix @xmath173 in @xmath107 .",
    "more precisely , it can be defined through the volume form @xmath174 , where @xmath175 and @xmath176 is a basis of tangential vectors of the submanifold  @xmath177 ( or  @xmath165 ) at a given point @xmath67 .",
    "surface measures induced by scalar products associated with general symmetric definite positive matrices will also be of interest .",
    "we denote by @xmath178 the surface measure on @xmath37 induced by the scalar product @xmath179 on @xmath72 , and , for a given @xmath29 , by @xmath180 and @xmath181 the surface measures on the affine spaces @xmath144 and @xmath182 respectively , induced by the scalar product @xmath183 on  @xmath72 . for more precise definitions of these measures ,",
    "we refer to  ( * ? ? ?",
    "* sections  3.2.1 and  3.3.2 ) and the references therein .",
    "it is now possible to define a generalization of the canonical distribution   as follows : @xmath184 the distribution   is associated with the generalized constraints  @xmath185 , and is used in section  [ sec : lang_jarz ] for nonequilibrium methods .",
    "note that @xmath186 defined in  .",
    "the co - area formula ( see  @xcite ) relates the phase space or surface measures , and the conditional measures .",
    "conditional measures are defined in @xmath107 by the following conditioning formula : for any test function  @xmath187 , @xmath188 in the same way in @xmath72 , conditional measures are defined , for any test function  @xmath189 , by @xmath190 a more concise notation for the above equalities is @xmath191 and @xmath73 .",
    "[ p : coareasympl ] let @xmath37 be the submanifold   defined by the constraints @xmath68 , and assume that @xmath36 defined in   is non - degenerate in a neighborhood of @xmath37 .",
    "then , in the sense of measures on @xmath72 : @xmath192 let @xmath165 be the phase space defined by generalized constraints  .",
    "assume that  @xmath193 defined in   is non - degenerate in a neighborhood of @xmath165 .",
    "then , in the sense of measures on @xmath107 : @xmath194    we refer for example to chapter  @xmath195 in  @xcite for an elementary proof",
    ". an equivalent of - for momenta reads , for constrained effective momenta : @xmath196 and for constrained effective velocities : @xmath197 using the co - area formulas  - , and the expressions of symplectic gram matrices  - , we obtain the following expressions of the phase space measures :    a.   the phase space measure on @xmath198 can be identified with the conditional measure defined in  : @xmath199 while the phase space measure on @xmath200 is related to the corresponding conditional measure as @xmath201 b.   the phase space measures are given by the product of surface measures : @xmath202 and @xmath203    equations  - are a consequence of the fact that @xmath204 ( and a similar relation for @xmath125 ) .",
    "we end this section with an important formula , which is used to show the invariance of the canonical measure in the proof of proposition  [ p : revcons ] .",
    "[ p : divsympl ] consider the poisson bracket @xmath158 defined by  , and an open neighborhood @xmath205 of @xmath206 where @xmath148 is invertible . then for any smooth test functions @xmath207 with compact support in  @xmath205 , @xmath208",
    "the divergence formula   can be proved using darboux s theorem and internal coordinates , or directly using the co - area formula ( see section  3.3 in @xcite ) .",
    "we will also need the classical divergence formula on affine spaces ( see for instance section  3.3 in  @xcite ) : for a fixed @xmath132 , for any compactly supported smooth vector field @xmath209 , @xmath210",
    "we first give some properties of the constrained langevin equation  @xmath55 in section  [ sec : sampling_gen ] , then propose some numerical schemes to discretize it in section  [ sec : consnum ] , and finally consider the overdamped limit in section  [ sec : ovd_limit_constraints ] .",
    "we consider the dynamics  @xmath55 : @xmath211    \\dps   d p_{t } = -\\nabla v(q_{t } ) \\ , dt -\\gamma(q_t ) m^{-1}p_t \\ , dt     + \\sigma(q_t ) \\ , d w_t + \\nabla \\xi(q_{t } ) \\ , d \\lambda_t , & \\\\[6pt ]    \\dps \\xi(q_{t } ) = z. & ( c_q ) \\end{cases}\\ ] ] by differentiating with respect to time the constraint @xmath212 , the lagrange multipliers can be computed explicitly ( see for instance section  3.3 in  @xcite ) : @xmath213 \\nonumber\\\\ & = \\ , f_{\\rm rgd}^m(q_t , p_t ) \\ , dt + g_{m}^{-1}(q_t)\\nabla \\xi(q_t)^t m^{-1 } { \\left(\\gamma(q_{t } ) m^{-1}p_{t } \\,dt - \\sigma(q_{t } ) \\,d w_t \\right ) } ,   \\label{eq : first_expression_lagrange}\\end{aligned}\\ ] ] where the constraining force @xmath214 is defined as : @xmath215 thus , using the fact that @xmath216 when @xmath217 , the dynamics  @xmath55 can be recast in a more explicit form as @xmath218   d p_{t } & = -\\nabla v(q_{t } ) \\ , dt + \\nabla \\xi(q_t ) f_{\\rm rgd}^m(q_t , p_t ) \\ , dt -\\gamma_p(q_t ) m^{-1 } p_{t}\\ , dt \\\\ & \\quad + \\sigma_p(q_t ) \\ , d w_t ,    \\end{aligned } \\right.\\ ] ] where we introduced the notation @xmath219 .",
    "the constraint therefore has two effects : ( i ) the matrices @xmath220 in the dissipation and fluctuation terms are replaced by their projected counterparts @xmath94 , and ( ii ) an orthogonal constraining force @xmath221 is introduced .",
    "the generator of this stochastic langevin dynamics is the operator @xmath222 which appears in the kolmogorov evolution equation : for @xmath223 satisfying  @xmath55 or  , and for any smooth test function @xmath224 , @xmath225 the expression of @xmath222 can be obtained using it calculus , as made precise in the following proposition .",
    "[ s : p : lconstgen ] consider either the effective momentum   or the effective velocity  , denoted with the general constraints @xmath226 or @xmath227 ( see  ) .",
    "the solution of the constrained dynamics  @xmath55 ( or equivalently   with an initial condition @xmath228 ) belongs to @xmath229 , and the generator of this markov process reads ( whatever the value of  @xmath38 ) @xmath230 where the fluctuation - dissipation part is @xmath231 with @xmath232 defined in  . using the fluctuation - dissipation relation  ,",
    "the generator @xmath233 can be rewritten more compactly as @xmath234    we perform the computation in two steps : ( i ) we compute the generator of the hamiltonian part of the constrained langevin dynamics , which is  @xmath55 in the case @xmath235 ; ( ii ) we compute the generator of the  thermostat  part of  @xmath55 , which is an ornstein - uhlenbeck process on momentum variable ( corresponding to the second equation in  @xmath55 with @xmath236 ) .",
    "let us first consider ( i ) , with @xmath226 ( the case @xmath227 being similar ) .",
    "note that @xmath237 where the hessian operator @xmath238 is defined in  .",
    "now , implies that @xmath239 besides , @xmath240 along a trajectory , since @xmath52 .",
    "therefore , @xmath241 where the notation @xmath242 is introduced in  .",
    "consider a test function @xmath243 , and remark that @xmath244 so that , for any @xmath245 , @xmath246 finally , for all @xmath247 , @xmath248 the operator   is the generator of the hamiltonian part in  .",
    "we turn to ( ii ) .",
    "the diffusive part arises from the fluctuation term @xmath249 in  , and its expression @xmath250 is obtained directly from the standard it calculus .",
    "similarly , the dissipation operator is @xmath251 the addition of these two contributions gives the expression of @xmath233 .    with the expression   of the generator at hand , it is easily checked that the process  @xmath55 satisfies the following equilibrium properties :    [ p : revcons ] when the fluctuation - dissipation relation   holds , the constrained langevin dynamics  @xmath55 on @xmath252 admits the boltzmann - gibbs distribution   as a stationary measure , and is reversible up to momentum reversal with respect to  : if @xmath253 , then , for any @xmath254 , @xmath255 moreover , if @xmath256 is everywhere strictly positive in the sense of symmetric matrices on @xmath257 , then the process  @xmath55 is ergodic : for any smooth test function  @xmath224 , @xmath258    the stationarity and reversibility properties follow from the following detailed balance condition up to momentum reversal ( see for instance section  2.2 in  @xcite ) : for any test functions  @xmath259 ,  @xmath260 , @xmath261 where @xmath262 is the momentum flip . in view of the expression   of the generator , proving   amounts to proving this property for the operators @xmath263 and @xmath233 .    for the hamiltonian part  @xmath263 , the expression   yields @xmath264 which states the time symmetry under momentum reversal of the hamiltonian part of the equations of motion  @xmath55 . on the other hand , @xmath265 so that @xmath266 and the divergence formula   yields the balance condition   for the hamiltonian part , in view of the invariance of the distribution @xmath170 under the momentum flip @xmath267 .    for the thermostat part , it is easily checked , that @xmath268 for any smooth test function @xmath224 , so that the detailed balance condition up to momentum reversal   follows from the following more general detailed balance condition , in the case @xmath269 ( @xmath270 being defined in  ): @xmath271 it is interesting to prove   for a general @xmath272 since it will be used in the proof of theorem  [ th : crookslangcons ] below . consider the divergence formula   in the affine space for the variable  @xmath273 ( the position @xmath274 being fixed ) , with @xmath275 after integration in @xmath274 , using the formula   for @xmath233 and  , an expression symmetric in @xmath276 is obtained : @xmath277 hence the detailed balance condition  .",
    "ergodicity is a consequence of the hypo - ellipticity of the operator @xmath222 on @xmath278 ( hrmander s criterion is satisfied , see  @xcite ) , which is itself a consequence of the fact that @xmath279 is strictly positive on each @xmath280 .",
    "the proof can be carried out using local coordinates and the results from  @xcite .",
    "[ rem : highosclang ] we have considered in this section the langevin dynamics   with constraints rigidly imposed by a projection onto the submanifold @xmath281 .",
    "this dynamics samples the canonical distribution   @xmath282 , with constraints on both positions and momenta .",
    "the marginal on positions of this distribution is , in view of  , proportional to @xmath283 this is what we call in the following rigidly imposed constraints .",
    "the canonical distribution   with rigid constraints is naturally associated to the rigid free energy   ( and this is what justifies the qualification `` rigid '' ) , since , we recall , @xmath284    another way to impose some constraints on a system is to add a penalization term . in our context , this could be done by changing the potential energy @xmath285 to @xmath286 it is easy to check that , in the limit @xmath287 ( infinite stiffness limit ) , the canonical measure associated to this potential is the canonical distribution   with positions conditioned by @xmath288 .",
    "this distribution is proportional to @xmath289 and its marginal on positions is proportional to @xmath290 this is what we call in the following softly imposed constraints . the canonical distribution with soft constraints is naturally associated with the standard free energy , since , we recall , @xmath291    note that , in view of  , the marginal on positions for softly imposed constraints can be written in terms of rigidly imposed constraints through a modification of the potential : @xmath292 where @xmath293 is sometimes called the fixman corrector ( see  @xcite ) . thus ,",
    "if @xmath223 satisfies   with the modified potential @xmath294 then @xmath295 samples ( in the longtime limit ) the probability measure proportional to @xmath296 , and we thus refer to this dynamics as the softly constrained langevin dynamics .",
    "these concepts will be used in section  [ ti - sec : mc ] to describe the computation of free energy differences for systems with molecular constraints .",
    "finally , let us mention that the infinite stiffness limit @xmath287 of the langevin dynamics   with the potential @xmath297 is not ( except for very specific forms of constraints ) the softly constrained langevin dynamics , as one would expect .",
    "we refer to [ 32 ] for example , where it is shown that adiabatic effective potentials ( derived from the conservation of the ratio of energy over frequency of fast modes ) are required to describe the limiting dynamics .",
    "however , a formal argument based on `` over - damping '' the fast modes indeed leads to the softly constrained langevin dynamics .",
    "we consider in this section a numerical scheme based on a splitting of the langevin dynamics  @xmath55 into a hamiltonian part ( section  [ sec : numhamiltonconst ] ) and a fluctuation - dissipation part acting only on the momentum ( section  [ sec : numflucdissconst ] ) . such a splitting is standard for unconstrained systems , but other splitting strategies for the langevin equation can be considered as well ( see  @xcite ) .    for simplicity , we restrict ourselves to constant matrices @xmath298 and @xmath299 . generalizations to position dependent matrices are straightforward .",
    "the hamiltonian part of the langevin dynamics  @xmath55 ( namely  @xmath55 with @xmath300 ) is discretized using a velocity - verlet scheme with constraints , which yields   below .",
    "the fluctuation - dissipation part on momentum variable in  @xmath55 is the following ornstein - uhlenbeck process ( for a fixed given @xmath301 ) : @xmath302 which can be rewritten as ( see  ) @xmath303 this equation can be explicitly integrated on @xmath304 $ ] to obtain : @xmath305 however , the matrix exponential @xmath306 may be difficult to compute in practice ( except for certain choices of @xmath298 and @xmath5 , see the discussion at the end of section  [ sec : numflucdissconst ] ) .",
    "instead of performing an exact integration , can be discretized using a midpoint euler scheme , which yields   and   below .",
    "the numerical scheme we investigate , termed midpoint euler - verlet - midpoint euler splitting , is therefore the following : @xmath307    \\nabla \\xi(q^n)^{t } m^{-1 } p^{n+1/4 } = 0 ,   & ( c_p)\\\\    \\end{cases } \\label{eq : flucdiss1 } \\\\     & \\begin{cases }",
    "p^{n+1/2 } = \\dps p^{n+1/4 } - \\frac{\\dt}{2 } \\nabla v ( q^{n } )     + \\nabla \\xi(q^n ) \\ , \\lambda^{n+1/2 } , & \\\\[6pt ]     q^{n+1 } =   q^{n } + \\dt \\ ,",
    "m^{-1 } \\ , p^{n+1/2 } , \\\\[6pt ]     \\xi(q^{n+1 } ) = z ,   & ( c_q)\\\\[6pt ]    p^{n+3/4 } = \\dps p^{n+1/2 } - \\frac{\\dt}{2 } \\nabla v ( q^{n+1 } )     + \\nabla \\xi(q^{n+1 } ) \\ , \\lambda^{n+3/4 } , & \\\\[6pt ]     \\nabla\\xi ( q^{n+1})^{t } m^{-1 } p^{n+3/4 } = 0 ,   & ( c_p)\\\\     \\end{cases } \\label{eq : verletconst } \\\\     &",
    "\\begin{cases }         \\dps p^{n+1 } =   p^{n+3/4 } -\\frac{\\dt}{4 } \\gamma \\ , m^{-1 } ( p^{n+3/4}+p^{n+1 } )     + \\sqrt{\\frac\\dt2 } \\ , \\sigma \\ , { \\mathcal g}^{n+1/2 }   \\\\",
    "\\phantom{p^{n+1 } = } + \\nabla\\xi(q^{n+1 } ) \\ , \\lambda^{n+1 } , &   \\\\[6pt ]    \\nabla \\xi(q^{n+1})^{t } m^{-1 } p^{n+1 } = 0 , & \\hspace{-1 cm } ( c_p)\\\\    \\end{cases } \\label{eq : flucdiss2 } \\end{aligned}\\ ] ] where @xmath308 and @xmath309 are sequences of independently and identically distributed ( i.i.d . )",
    "gaussian random variables of mean @xmath46 and covariance matrix  @xmath310 .",
    "note that when @xmath311 and @xmath312 , the scheme  -- becomes deterministic , and reduces to  , which is a scheme for the deterministic hamiltonian equations of motion with position constraints @xmath68 .",
    "the latter scheme is referred to as the  hamiltonian scheme   below .",
    "the hamiltonian part   of the scheme , often called rattle in the literature , is an explicit integrator , and is a modification of the classical shake algorithm ( see chapter  vii.@xmath167 in @xcite , or chapter  @xmath313 in @xcite for more precisions and historical references ) . in  , @xmath314 are the lagrange multipliers associated with the position constraints @xmath315 , and @xmath316 are the lagrange multipliers associated with the velocity constraints @xmath317 . the nonlinear constraints @xmath315 are typically enforced using newton s algorithm . in  ,",
    "the ( linear ) momentum projection @xmath318 is always well defined since we assumed that the gram matrix @xmath34 is invertible . on the other hand ,",
    "the nonlinear projection used to enforce the position constraints @xmath319 is in general well defined only on a subset of phase space .",
    "the domain @xmath320 is defined as the set of configurations @xmath321 such that there is a unique solution @xmath322 verifying  .    solving the position constraints",
    "@xmath51 consists in projecting onto @xmath37 a point in a @xmath80-neighborhood of @xmath323 . thus , by the implicit function theorem , the domain @xmath324",
    "verifies : @xmath325 it may happen that there is no solution if the time - step is too large , and , even for small time - steps , that several projections exist , see for instance example  @xmath172 in chapter  @xmath313 of @xcite . in practice , @xmath324 can be chosen to be the set of @xmath326 such that the newton algorithm enforcing the constraints @xmath51 has converged within a given precision threshold and a limited number of iterations .",
    "as for the verlet scheme in the unconstrained case , the associated numerical flow shares two important qualitative properties with the exact flow : it is time reversible and symplectic ( see  @xcite ) .",
    "this implies quasi - conservation of energy , in the sense that energy is conserved within a given precision threshold over exponentially long times , see @xcite .",
    "the new momentum @xmath327 in   ( or @xmath328 in  ) may be obtained by first integrating the unconstrained dynamics with a midpoint scheme , and then computing the lagrange multiplier @xmath329 ( or @xmath330 ) by solving the following linear system implied by the constraints @xmath318 : @xmath331 = 0 . \\end{aligned}\\ ] ] a sufficient criteria for stability is @xmath332 besides , it can be checked ( see sections  2.3.2 and  3.3.5 in  @xcite ) that the markov chain induced by the fluctuation - dissipation part of the scheme   ( or  ) verifies a detailed balance equation ( both in the plain sense and up to momentum reversal ) with respect to the stationary measure @xmath333 .",
    "the latter is defined as the kinetic probability distribution @xmath334 and is the marginal in the @xmath273-variable of the canonical distribution @xmath335 conditioned by a given @xmath301 . moreover ,",
    "if @xmath336 is strictly positive in the sense of symmetric linear transformations of @xmath337 , then the markov chain on momentum variable induced by   ( or  ) alone is ergodic with respect to  @xmath333 .",
    "finally , an important simplification occurs in the integration of   in the special case when @xmath298 and @xmath5 are equal up to a multiplicative constant ( so that @xmath338 is proportional to identity ) .",
    "indeed in this case the equality @xmath339 holds for any @xmath340 , and   simplifies to @xmath341 the numerical integration of   can thus be carried out in two steps : ( i ) exactly integrating   without constraint , and then ( ii ) projecting the result onto  @xmath342 .",
    "usually , the invariant probability distribution sampled by the solution of a numerical scheme is biased by the time discretization .",
    "relying on ( i ) the time symmetry ( up to momentum reversal ) and ( ii ) the preservation of the phase space measure @xmath343 by the solution of the rattle scheme  , it is possible to eliminate the time discretization error in the splitting scheme -- by resorting to a generalized hybrid monte carlo algorithm .",
    "[ a : ghmcconst ] consider an initial configuration @xmath344 , and a sequence @xmath345 of independently and identically distributed standard gaussian vectors .",
    "iterate on @xmath340 :    1 .",
    "evolve the momentum according to the midpoint euler scheme  , and compute the energy @xmath346 of the new configuration ; 2 .   integrate the hamiltonian part according to the rattle scheme  , denote @xmath347 the resulting state , and set @xmath348 .",
    "3 .   accept the proposal @xmath349 with probability @xmath350 otherwise , reject and flip the momentum : @xmath351 .",
    "4 .   evolve the momentum according to the midpoint euler scheme  .    by construction ,",
    "the ghmc algorithm with constraints leaves invariant the equilibrium distribution @xmath352 ( see section  3.3.5 in @xcite ) .    to understand the momentum reversal required upon rejection , it is useful to write more explicitly the markov chain as the composition of a metropolis - hastings part , where the proposal is obtained by a rattle step followed by a momentum reversal ( the latter operation is needed to ensure the symmetry of the proposition ) , which is then accepted or rejected ; and another momentum reversal ( which leaves invariant the targeted probability measure @xmath352 ) .",
    "when the proposal is accepted , the two momentum reversals cancel out each other . on the other hand , when the proposal is rejected , momenta are actually reversed .",
    "see  ( * ? ? ?",
    "* section  2.1.4 ) for more background on generalized metropolis - hastings algorithms .    in the above",
    ", we implicitly assume that the rattle scheme   is everywhere well defined . in practice",
    "however , it is necessary to modify algorithm  [ a : ghmcconst ] by restricting the sampled configurations to @xmath324 .",
    "this can be achieved by introducing additional tests in steps ( 1 ) , ( 2 ) and ( 4 ) , and rejecting the states that have gone outside the set @xmath353 where the position constraint @xmath51 is well defined . by doing so",
    ", the global algorithm has an invariant equilibrium distribution given by @xmath352 conditioned on the set of states @xmath324 .",
    "this invariant distribution can be written explicitly as follows : @xmath354 alternatively , the rejection tests in steps ( 1 ) , ( 2 ) and  ( 4 ) of algorithm  [ a : ghmcconst ] can be performed with a cut - off parameter @xmath355 on the momentum variable , chosen so that the position constraint @xmath51 in   is everywhere well defined when @xmath356 .",
    "this can be achieved when there exists @xmath355 small enough so that @xmath357 .",
    "since this is useful for later purposes ( see the discussion at the end of section  [ sec : num_ti ] ) , we provide a rough estimate of @xmath358 in terms of @xmath80 , assuming for simplicity that  @xmath37 is compact .",
    "first , by the implicit function theorem , there exists @xmath359 such that , for all @xmath29 and @xmath360 with norm @xmath361 , there is a unique @xmath362 satisfying @xmath363 therefore , there exists @xmath364 small enough such that , when @xmath365 , the rattle scheme in   is well defined , namely there exists a unique @xmath366 satisfying the constraint @xmath51 .",
    "this shows that @xmath367 for some @xmath368 .    the invariant probability distribution of the markov chain generated by ghmc with the additional rejection steps ensuring @xmath369 , is given by  , and actually reads @xmath370 its marginal distribution in the position variable is then exactly given by : @xmath371 this is also the marginal distribution in the position variable of  @xmath372 .",
    "note however , that if @xmath358 is too small , only small momenta will be sampled in step  ( 1 ) of algorithm  [ a : ghmcconst ] , and the correlation time of the sampling will be large . in practice , the threshold @xmath358 should be tuned in preliminary computations so that : ( i )  @xmath358 is small enough so that the maximal number @xmath373 of iterations for the newton algorithm used to enforce @xmath51 in   is never reached ; ( ii )  @xmath358 is large enough so that the correlation time of the sampling is as small as possible .",
    "let us end this section with a warning : it is now known that the correction of the bias in discretizations of the langevin dynamics by a metropolization of the scheme may reduce the efficiency of the sampling , see for instance  @xcite",
    ".      constrained overdamped langevin processes ( or brownian dynamics ) are solutions of the stochastic differential equation ( see also @xcite ) @xmath374 where @xmath375 is an adapted stochastic process .",
    "equivalently , can be rewritten in the stratonovitch form as @xmath376 where @xmath377 denotes the stratonovitch integration , and @xmath378 is the projector defined by   with the choice @xmath379 : @xmath380 it can be shown that   verifies the detailed balance condition for ( and is ergodic with respect to ) the invariant distribution @xmath381 which is the marginal in the @xmath274-variable of the canonical distribution with constraints   for the choice @xmath382 .",
    "it is easy to generalize all our results to scalar products associated with a general symmetric definite positive matrix @xmath5 upon considering  , see remark  [ rmk : discrete_ovd_m ] below .",
    "the constrained overdamped langevin process   may be obtained from a scaling limit of the constrained langevin dynamics  @xmath55 ( in the limit when either the mass goes to zero , or the damping  @xmath298 goes to infinity ) , see propositions  @xmath383 and  @xmath384 in  @xcite .",
    "likewise , at the discrete level , an euler - maruyama discretization of the overdamped process   can be obtained as a particular case of the numerical discretization  -- for the langevin equation  @xmath55 , yielding a markov chain @xmath385 on positions .",
    "the condition that the mass goes to  0 is replaced by the condition that the mass is proportional to the time - step .",
    "this is the content of the following proposition .",
    "[ p : langtooverd ] suppose that the following relation is satisfied : @xmath386 with a slight abuse of notation , the mass matrix and the friction matrix are rewritten as @xmath387 and @xmath388 with @xmath389 .",
    "then the splitting scheme  -- yields the following euler scheme for the overdamped langevin constrained dynamics  : @xmath390      \\xi(q^{n+1 } ) = z ,    \\end{cases}\\ ] ] where @xmath391 are independent and identically distributed centered and normalized gaussian variables , and @xmath392 are the lagrange multipliers associated with the constraints @xmath393 .",
    "moreover , the lagrange multipliers in verify : @xmath394 as well as @xmath395 where @xmath396 is defined in  .",
    "irrespective of @xmath397 , the choice   in the scheme -- leads to @xmath398 where @xmath329 is associated with the constraints @xmath399 .",
    "this gives @xmath400 where @xmath401 is such that @xmath402 .",
    "the fluctuation - dissipation relation   can be reformulated in this context as @xmath403 and the scheme   is recovered by taking the associated lagrange multiplier equal to @xmath404 . finally , remarking that @xmath405 and computing explicitly @xmath401 and @xmath406 in yields -- .",
    "this point of view allows to construct a metropolis correction to the euler scheme  , using the generalized hybrid monte carlo scheme ( algorithm  [ a : ghmcconst ] ) with the time - step chosen according to  . in this way , assuming that the position constraint @xmath51 in   is everywhere well defined , we obtain a markov chain @xmath407 discretizing the overdamped dynamics   which _ exactly _ samples the invariant distribution  .",
    "deriving such a metropolis - hastings correction to the euler scheme   without resorting to phase - space dynamics does not seem to be natural .",
    "[ rmk : discrete_ovd_m ] proposition  [ p : langtooverd ] can be seen as a discrete version of the zero - mass limit of the langevin dynamics .",
    "it is also possible to obtain a discrete version of the overdamped limit ( @xmath408 ) of the langevin dynamics by assuming that the parameters satisfy the relation @xmath409 which is less restrictive than  .",
    "equation   is then obtained with @xmath80 replaced by @xmath410 in this case , the effective discretization time - step @xmath411 for the overdamped langevin dynamics is thus different from the time - step @xmath412 originally used for the discretization of the langevin dynamics .",
    "this is reminiscent of the fact that the overdamped limit ( at the continuous level ) of the langevin dynamics requires a change of timescale to obtain the overdamped langevin dynamics .",
    "note also that in the more general case @xmath413 where @xmath5 is not supposed to be proportional to the identity , the following numerical scheme is obtained : @xmath414 \\xi(q^{n+1 } ) = z , \\end{cases}\\ ] ] where @xmath415 .",
    "this is a discretization of the overdamped dynamics @xmath416 which is a generalization of   to a scalar product on @xmath417 induced by a general positive definite mass matrix  @xmath5 .",
    "in this section , we focus on the computation of the gradient of the rigid free energy   @xmath418 using a numerical discretization of the constrained langevin process  @xmath55 .    as explained in the introduction",
    ", we may indeed concentrate on the computation of the rigid free energy  , since the standard free energy   can be computed from the latter one using  .",
    "the relation   can be proved with the co - area formula  .",
    "indeed , the free energy defined in   can be rewritten as ( where c denotes a constant which may vary from line to line ) : @xmath419 hence @xmath420 where surface measures are defined in section  [ sec : measures ] .",
    "note that the rigid free energy @xmath78 indeed depends explicitly on the mass matrix since @xmath421    this section is organized as follows .",
    "first , we show how systems with molecular constraints and systems with constrained values of the reaction coordinate can be treated in a unified framework ( section  [ ti - sec : mc ] ) .",
    "we then relate the lagrange multipliers arising in the constrained langevin dynamics , and the gradient of the rigid free energy ( the so - called mean force ) in section  [ sec : lag ] .",
    "we consider the numerical computation of the mean force in section  [ sec : num_ti ] , where we prove consistency results for the corresponding approximation formulas .",
    "finally , some numerical results on a model system illustrate the approach in section  [ sec : simple_example_wca ] .",
    "we discuss here how to generalize all the computations to systems with molecular constraints , generalizing thereby some results of  @xcite . without loss of generality ,",
    "we consider rigidly imposed molecular constraints , see remark  [ rmk : choice_mc ] below for a discussion of this assumption .",
    "this section can be considered as independent of the remainder of the paper and may therefore be omitted in a first reading .    in practice , many systems are subject to molecular constraints , such as fixed lengths for covalent bonds , or fixed angles between covalent bonds .",
    "the reader is referred to @xcite for practical aspects related to the simulation of molecular constraints . in the context of free energy computations , two types of constraints",
    "are therefore considered : first , the molecular constraints , @xmath422 for @xmath423 , and second , the reaction coordinates denoted in this section by @xmath424 , with @xmath425 .",
    "the submanifold of molecular constraints is denoted by @xmath426 and the submanifold associated with the reaction coordinates by @xmath427 it is assumed that the full gram matrix : @xmath428 is everywhere invertible on @xmath429 .",
    "likewise , we denote @xmath430 and @xmath431 assuming rigid mechanical constraints on the molecular constraints @xmath432 ( see remark  [ rmk : choice_mc ] below ) , we are led to considering the canonical distribution @xmath433 to describe systems with molecular constraints at a fixed temperature .",
    "the measure  @xmath434 denotes the phase space measure on @xmath435 , equal by   to the conditional measure @xmath436 associated with the constraints @xmath437 , where @xmath438 is the effective momentum   associated with @xmath432 .",
    "[ rmk : choice_mc ] the distribution @xmath439 in   is obtained by constraining rigidly @xmath440 to  0 , and not softly ( in which case @xmath441 would be replaced by @xmath442 , see also remark  [ rem : highosclang ] ) . as explained in section  [ sec : sampling ] , the distribution   is the equilibrium distribution of a langevin process ( thermostated hamiltonian dynamics ) with rigid position constraints @xmath443 . choosing whether constraints should be soft or rigid is a modeling choice , and there is no clear consensus on this issue in the current literature .",
    "note however that it is possible to rewrite the remainder of this section by considering the softly constrained potential rather than the rigidly constrained potential , up to an appropriate modification of   below , with the help of some fixman corrective potential .    by associativity of the conditioning of measures",
    ", the distribution @xmath439 conditioned by a value of the reaction coordinates @xmath444 is given , up to a normalizing factor , by : @xmath445 therefore , considering the marginal probability distribution of the reaction coordinates @xmath446 leads to the following definition of the free energy associated with  @xmath447 : @xmath448 the conditional distribution can be decomposed as follows , using the co - area formulas  - and the definition of effective momentum  : @xmath449 integrating out the momentum in the linear space @xmath450 with scalar product @xmath451 , the free energy can be rewritten as : @xmath452 as a consequence , the free energy @xmath453 can be computed from the generalized rigid free energy : @xmath454 using the following formula , similar to  : @xmath455 in the above , @xmath456 is defined similarly to  .",
    "the case of molecular constraints can therefore be treated within the general framework considered in this paper , the sampling of the canonical measure @xmath456 and the computation of the rigid free energy   being the problems at hand .    for systems with molecular constraints ,",
    "the measure sampled by the overdamped langevin dynamics   with @xmath457 is the marginal distribution in the position variables of @xmath458 in the special case @xmath382 , namely @xmath459 the rigid free energy which is thus naturally computed with such a dynamics is @xmath460 and the actual free energy is thus recovered by a formula similar to  , namely @xmath461      in this section , the average of the constraining force   is related to the gradient of the rigid free energy   ( or mean force ) .",
    "we also give a similar result for the following generalized rigid free energy : @xmath462    [ p : meanforce ] the constraining force @xmath463 defined in   as @xmath464 yields on average the rigid free energy derivative : @xmath465 moreover , for general constraints   and the associated generalized free energy  , the formula can be extended as follows : the generalized constraining force is @xmath466 where @xmath467 is defined in  , and the rigid mean force is @xmath468 where @xmath469 , and @xmath470 is defined in  . when @xmath67 verifies @xmath471 , then @xmath472 and @xmath473 .",
    "formulas   and   are obtained directly by replacing  @xmath224 by  @xmath474 in lemma  [ l : consint ] ( see the appendix ) . the fact that @xmath475 in the tangential case ( namely when @xmath471 ) is a consequence of  .",
    "the following lemma gives a momentum - averaged version of the constraining force ( a similar formula exists in the overdamped case , see equations  ( 4.8)-(4.9 ) in  @xcite , for example ) .",
    "[ l : meanforce_av ] the rigid mean force   can be rewritten as : @xmath476 where @xmath477    consider the gaussian distribution @xmath478 defined in  : @xmath479 which is the marginal distribution in the momentum variable of the canonical distribution @xmath335 , conditioned by a given @xmath301 .",
    "proving lemma  [ l : meanforce_av ] amounts to showing that the average of the constraining force @xmath242 with respect to @xmath480 yields @xmath481 : @xmath482 first , we compute the covariance matrix @xmath483 of the gaussian distribution @xmath484 . since @xmath484 is a centered gaussian distribution , @xmath485 satisfies , for all @xmath486 , @xmath487 denoting @xmath488 , this yields @xmath489 so that @xmath490 this gives @xmath491 averaging   over momenta thus leads to the desired result .",
    "free energy derivatives can also be obtained from the lagrange multipliers of the langevin constrained process  @xmath55 .",
    "this is very useful in practice since it avoids the computation of second order derivatives of the reaction coordinates which appear in the expressions of @xmath492 and @xmath493 ( see the discussion at the beginning of section  [ sec : avg_lagrange ] ) :    consider the rigidly constrained langevin process solution of  @xmath55 , with associated lagrange multipliers @xmath375 .",
    "assume that @xmath97 , @xmath494 and @xmath299 are bounded functions on @xmath37 , and @xmath495 is strictly positive on @xmath496 ( in the sense of symmetric matrices ) .",
    "then , the almost sure convergence   claimed in the introduction holds : @xmath497 a similar result holds for the ` hamiltonian part ' of the lagrange multipliers , defined by : @xmath498 indeed , the following almost sure convergence holds : @xmath499    the estimator based on   has a smaller variance than the estimator based on   ( or   above ) since only the bounded variation part is retained , and the martingale part due to the brownian increments and the dissipation term are subtracted out .",
    "similar results on variance reduction where obtained in the overdamped case in  @xcite .",
    "recall the expression   of the lagrange multipliers , which can be decomposed as the sum of the constraining force , a dissipation term and a martingale ( fluctuation ) term : @xmath500 the result follows from three facts .",
    "first , the process is ergodic with respect to the equilibrium distribution @xmath335 and averaging @xmath242 yields the rigid free energy derivative in view of proposition  [ p : meanforce ] .",
    "this already shows  .",
    "second , the gaussian distribution of @xmath335 with respect to momentum variables is centered , which yields : @xmath501 third , the variance of the martingale term can be uniformly bounded as @xmath502 this implies the almost sure convergence @xmath503 see for example theorem 1.3.15 in  @xcite .",
    "the fact that averaging the lagrange multiplier in   indeed yields the mean force may not be intuitive .",
    "this is actually very much related to the cost interpretation of the lagrange multipliers in optimization , see  ( * ? ? ?",
    "* remark  3.29 ) .",
    "estimates of the mean force based on either  , or   can be obtained .",
    "free energy derivatives can be computed by averaging @xmath504 or @xmath505 with respect to the distribution @xmath335 , for instance using the estimators : @xmath506 or @xmath507 the functions @xmath504 and @xmath505 may thus be called `` rigid local mean forces '' .",
    "note that using the momentum - averaged local mean force @xmath481 instead of the original @xmath242 reduces the variance since the fluctuations of the momentum variable have been averaged out analytically .",
    "table  [ tab : comparison_variance_langevin_ti ] below confirms this analysis , although the variance reduction appears to be small in our specific numerical experiment .",
    "assuming the convergence of the constrained splitting scheme  -- in the probability distribution sense to the limiting langevin process  @xmath55 , the convergence of these estimators to @xmath508 is ensured , when taking first the limit @xmath509 with @xmath510 such that @xmath511 , and then @xmath512 .",
    "free energy derivatives can also be computed using the lagrange multipliers of a langevin constrained process according to   or  .",
    "this technique avoids the possibly cumbersome computation of second order derivatives @xmath513 of the reaction coordinate , which appear in the expressions of @xmath492 or @xmath481 . besides",
    ", the lagrange multipliers are needed anyway for the numerical integration of the dynamics .",
    "the computation can be performed as before with a longtime simulation of the splitting scheme  -- discretizing the langevin process with constraints .",
    "the following approximation formula can for instance be used : @xmath514 where @xmath515 are the lagrange multipliers in the hamiltonian part  .",
    "the consistency of this estimator is given by the following proposition .",
    "[ p : consist ] the approximation formula   is consistent .",
    "more precisely , the lagrange multipliers @xmath516 in  -- are both equivalent when @xmath509 to the constraining force defined in  : @xmath517 moreover , the following second order consistency holds for the sum of the lagrange multipliers : @xmath518 together with the variant : @xmath519    the variant  , which involves positions and momenta at the beginning and at the end of the hamiltonian steps only , is used in   below to estimate the time discretization error in the thermodynamic integration method based on the estimator  .    for sufficiently small time - steps @xmath80 , the implicit function theorem ensures that the two projection steps associated with the nonlinear constraints in  -- have a unique smooth solution .",
    "a taylor expansion with respect to  @xmath80 of the position constraints gives @xmath520 where @xmath521 denotes the order @xmath195 differential of @xmath26 computed at @xmath274 and evaluated with the vectors @xmath522 .",
    "we denote @xmath523 then , the fact that @xmath524 and the identity @xmath525 yield the following expansion of @xmath526 in terms of @xmath527 : @xmath528 by time symmetry , the same computation holds for @xmath406 , starting from @xmath322 and by formally replacing @xmath80 by @xmath529 .",
    "this can be double checked by taylor expanding with respect to @xmath80 the position constraints , as done above for @xmath401 .",
    "it thus holds : @xmath530",
    "the sum of the multipliers therefore reads @xmath531 which gives  .",
    "now , using the previous calculations , we remark that : @xmath532    \\dps   p^{n+1/2 } = p^{n+3/4 } + \\frac{\\dt}{2 } \\nabla v ( q^{n+1 } ) - \\frac{\\dt}{2 } \\nabla \\xi ( q^{n+1 } )    f_{\\rm rgd}^m(q^{n+1},p^{n+1/2 } ) + { \\rm o}(\\dt ^2 ) .",
    "\\end{cases}\\ ] ] thus , it holds @xmath533 this gives the claimed second order consistency of the sum of the lagrange multipliers  .",
    "let us discuss the convergence of the approximation  .",
    "assuming again that the constrained splitting scheme  -- converges in the probability distribution sense to the limiting langevin process  @xmath55 , the following convergence in probability distribution occurs when @xmath509 and @xmath511 : @xmath534 this shows the convergence of the estimate   of the mean force when taking first the limit @xmath509 and then @xmath512 .",
    "when the scheme  -- is complemented with a metropolis step ( see algorithm  [ a : ghmcconst ] ) , it is possible to prove a result on the longtime limit of trajectorial averages ( _ i.e. _ letting first the number of iterations go to infinity , and then taking the limit @xmath509 ) , upon assuming the irreducibility of the numerical scheme .",
    "indeed , let us consider the markov chain @xmath535 generated by the ghmc scheme in algorithm  [ a : ghmcconst ] , and assume ( i ) the irreducibility of the markov chain , and ( ii ) that appropriate rejections outside the set @xmath536 are made in the steps ( 1)-(2)-(4 ) of the algorithm . in particular , the projection steps associated with the nonlinear constraints in step  ( 2 ) of algorithm  [ a : ghmcconst ] are well defined .",
    "then , by ergodicity , an average of the analytic expression of the local rigid mean force @xmath481 given in   yields an estimate of the free energy without time discretization error : @xmath537 if @xmath242 is used instead of  @xmath481 , then the mean force is computed with some exponentially small error : almost surely , @xmath538 for some @xmath359 .",
    "the error arising from replacing @xmath539 with @xmath169 is indeed exponentially small in view of   ( namely @xmath540 ) and using the fact that the marginal distribution in the @xmath273-variable is gaussian .    likewise , for estimates based on lagrange multipliers , the following longtime averaging holds : almost surely , @xmath541 where we have used the estimate   on the lagrange multipliers .",
    "the limit @xmath509 is obtained by a dominated convergence argument : @xmath542 note that , due to the metropolis correction in algorithm  [ a : ghmcconst ] , the time discretization error in the sampling of the invariant measure is removed .",
    "the only remaining time discretization errors come from ( i )  the approximation of the local mean force by the lagrange multipliers ( this is a second order error ) , and ( ii )  the integration domain being @xmath539 instead of @xmath169 ( as discussed above , this is an exponentially small error in  @xmath80 ) . in conclusion",
    ", the left - hand side of   is an approximation of  @xmath543 up to a @xmath544 error term .",
    "finally , let us emphasize that free energy derivatives can be computed with the estimator   within the overdamped langevin framework , using the scheme   and the expressions  -- of proposition  [ p : langtooverd ] .",
    "let us recall that the latter are equivalent to the scheme  -- with fluctuation - dissipation matrices satisfying @xmath545 .",
    "this leads to the original free energy estimator ( recall that , for the overdamped dynamics , @xmath72 is equipped with the scalar product associated with the identity matrix ) : @xmath546 which can be seen as a variant of the variance reduced estimator proposed directly for the overdamped scheme   in  @xcite : @xmath547 the rigorous justification of the consistency of   in the limit @xmath509 follows from the results of  @xcite .",
    "see also section  [ sec : time_continuous_limit_ovd ] below for similar results .",
    "we consider a system composed of @xmath0 particles in a 2-dimensional periodic box of side length  @xmath548 , interacting through the purely repulsive wca pair potential , which is a truncated lennard - jones potential : @xmath549 + \\varepsilon & \\quad { \\rm if \\ } r \\leq r_0 , \\\\ 0 & \\quad { \\rm if \\ } r > r_0 , \\end{array } \\right.\\ ] ] where @xmath550 denotes the distance between two particles , @xmath551 and @xmath299 are two positive parameters and @xmath552 . among these particles ,",
    "two ( numbered 1 and 2 in the following ) are designated to form a dimer while the others are solvent particles . instead of the above wca potential ,",
    "the interaction potential between the two particles of the dimer is a double - well potential @xmath553 ^ 2,\\ ] ] where @xmath554 and @xmath555 are two positive parameters .",
    "the total energy of the system is therefore , for @xmath556 with @xmath557 , @xmath558 see  @xcite for instance for other computational studies using this model .",
    "the potential @xmath559 exhibits two energy minima , one corresponding to the compact state where the length of the dimer is @xmath560 , and one corresponding to the stretched state where this length is @xmath561 .",
    "the energy barrier separating both states is @xmath554 .",
    "the reaction coordinate used to describe the transition from the compact to the stretched state is the normalized bond length of the dimer molecule : @xmath562 where @xmath563 and @xmath564 are the positions of the two particles forming the dimer .",
    "the compact state ( resp . the stretched state ) corresponds to the value @xmath565 ( resp .",
    "@xmath566 ) of the reaction coordinate .",
    "the inverse temperature is set to @xmath567 , with @xmath568 particles ( @xmath569 solvent particles and the dimer ) with solvent density @xmath570 , since there are @xmath569 solvent particles in a square box of side length @xmath571 with @xmath572 .",
    "the parameters describing the wca interactions are set to @xmath573 and @xmath574 , and the additional parameters for the dimer are @xmath575 and @xmath576",
    ".    for this system , @xmath379 and @xmath577 is constant , so that the rigid free energy @xmath578 is equal to the free energy @xmath84 .",
    "the mean force is estimated at the values @xmath579 , with @xmath580 , @xmath581 and @xmath582 , by ergodic averages obtained with the projected dynamics with metropolis correction ( algorithm  [ a : ghmcconst ] , where in the simple case considered here , the fluctuation - dissipation part can be integrated exactly ) . for each value of  @xmath38",
    ", we integrate the dynamics on a time @xmath583 with a step size @xmath584 , using a scalar friction coefficient  @xmath585 .",
    "the resulting mean force profile is presented in figure  [ fig : ti_lang_1 ] , together with the associated free energy profile .",
    "top : estimated mean force .",
    "bottom : corresponding free energy profile .",
    ", title=\"fig:\",width=340 ]   top : estimated mean force .",
    "bottom : corresponding free energy profile .",
    ", title=\"fig:\",width=340 ]    figure  [ fig : ti_lang_2 ] compares the analytical constraining force @xmath586 and the lagrange multipliers , see proposition  [ p : consist ] . in figure",
    "[ fig : ti_lang_2 ] , the @xmath587-axis represents the blocks of @xmath588 simulation steps , concatenated for the @xmath589 different values of @xmath590 .",
    "it can be seen that the difference between @xmath586 and the lagrange multipliers is small in any cases , though somewhat larger for the lowest values of  @xmath26 .",
    "top : the constraining force @xmath586 ( pale line ) , and the difference between the constraining force and its estimate from the lagrange multipliers ( dark line ) .",
    "middle : zoom on the difference between the constraining force and the lagrange multipliers .",
    "note the difference of scales for the @xmath591-axis .",
    "bottom : the schedule @xmath26 is piecewise constant . in all figures , the @xmath587-axis represents the blocks of @xmath588 simulation steps , concatenated for the @xmath589 different values of @xmath590 .",
    ", title=\"fig:\",width=340 ]   top : the constraining force @xmath586 ( pale line ) , and the difference between the constraining force and its estimate from the lagrange multipliers ( dark line ) .",
    "middle : zoom on the difference between the constraining force and the lagrange multipliers .",
    "note the difference of scales for the @xmath591-axis .",
    "bottom : the schedule @xmath26 is piecewise constant . in all figures , the @xmath587-axis represents the blocks of @xmath588 simulation steps , concatenated for the @xmath589 different values of @xmath590 .",
    ", title=\"fig:\",width=340 ]   top : the constraining force @xmath586 ( pale line ) , and the difference between the constraining force and its estimate from the lagrange multipliers ( dark line ) .",
    "middle : zoom on the difference between the constraining force and the lagrange multipliers .",
    "note the difference of scales for the @xmath591-axis .",
    "bottom : the schedule @xmath26 is piecewise constant . in all figures , the @xmath587-axis represents the blocks of @xmath588 simulation steps , concatenated for the @xmath589 different values of @xmath590 .",
    ", title=\"fig:\",width=340 ]    it can be checked numerically that the differences @xmath592 and @xmath593 are indeed of order @xmath594 , and that the difference @xmath595 is indeed of order @xmath596 ( by computing the average of these elementary differences for various step sizes ) .",
    "the lagrange multipliers are in any case very good approximations to the constraining force  @xmath492 .",
    "let us finally discuss the efficiency of the different estimators of the mean force , in terms of their variances .",
    "they can be written as the empirical average of the following random sequences : @xmath597 where @xmath598 are given by the numerical scheme  -- .",
    "the correlations in time ( between the iterates ) are very similar for the three methods , and we therefore simply compute the variance over all the samples .",
    "table  [ tab : comparison_variance_langevin_ti ] compares the so - obtained standard errors over @xmath588 time - steps with @xmath584 ( simulation time @xmath599 for each value of the reaction coordinate ) .",
    "the results show that the different estimators are more or less equivalent .",
    "this is related to the fact that the essential source of variance comes from the sampling of the positions , and not the sampling of the velocities .",
    "note however that , for the smallest value of the reaction coordinate , the estimator based on the averaged local mean force @xmath600 appears to be better in terms of variance .",
    ".standard error ( square - root of the variance ) of three mean force estimators , with correlations in time neglected , for different values @xmath38 of the reaction coordinate . [ cols=\"^,^,^,^ \" , ]",
    "this section presents nonequilibrium hamiltonian and langevin dynamics with time - evolving constraints .",
    "we thus consider @xmath223 solution to the dynamics  @xmath96 , which we recall for convenience : @xmath601      d p_t & = -\\nabla v ( q_t )   \\,dt -\\gamma_p(q_t ) m^{-1 } p_t \\ , dt+ \\sigma_p(q_t )   \\,d w_t   + \\nabla",
    "\\xi(q_t ) \\ , d \\lambda_t , \\\\[6pt ]      \\xi(q_t ) & = z(t ) , \\hspace{5 cm } ( c_q(t ) )    \\end{aligned } \\right.\\ ] ] we prove in particular the fluctuation identity  , see   below .",
    "recall ( see  ) that , for simplicity , we assume in this section that the fluctuation - dissipation matrices are assumed to be of the form @xmath602 with @xmath603 . at variance with the previous sections , we do _ not _ assume that @xmath495 is strictly positive .",
    "actually , @xmath604 corresponds to an interesting case : the deterministic hamiltonian dynamics .    to our knowledge",
    ", the standard work fluctuations derived so far ( except for our previous work  @xcite ) apply only to the case of time - dependent hamiltonians .",
    "it is possible to consider transitions in the values of some reaction coordinate in this framework upon resorting to steered molecular dynamics techniques . in this case ,",
    "a penalty term @xmath605 ( with @xmath551 small ) is used in the energy of the system to `` softly '' constrain the system to remain close to the submanifold @xmath606 at time  @xmath607 .",
    "however , it is observed in practice that the statistical fluctuations increase with smaller  @xmath551 ( see  @xcite ) .",
    "we propose instead to replace the stiff constraining potential @xmath608 by a projection onto the submanifold @xmath417 .",
    "this is reminiscent of the replacement of stiff constrained langevin dynamics by rigidly constrained ones , see remark  [ rem : highosclang ] .",
    "this section is organized as follows .",
    "we first define the generalized free energy which is naturally computed with  @xmath96 , and relate it to the standard free energy   in section  [ sec : langti_fe ] . then , we give some precisions on the nonequilibrium dynamics  @xmath96 in section  [ sec : generators_jarz ] .",
    "next , we prove an appropriate version of the jarzynski - crooks fluctuation equality in section  [ sec : jarz_lang_cons ] . a numerical discretization of the nonequilibrium dynamics is proposed in section  [ sec : num_jarz ] , together with various approximations of the work .",
    "in particular , we propose a numerical strategy to obtain a jarzynski - crooks identity without time discretization error ( see section  [ sec : discrete_jarz ] ) .",
    "we then consider the overdamped limit when the mass matrix  @xmath5 goes to 0 ( see section  [ sec : ovd_limit_disc ] ) . finally , in section  [ sec : num_res_jarz ] , we present some numerical results for the model system already considered in section  [ sec : simple_example_wca ] .      for @xmath223 solution to the langevin dynamics  @xmath96 ,",
    "the reaction coordinate evolution @xmath609 implies that @xmath610 , so that , at each time @xmath53 , the system @xmath223 belongs to the state space @xmath611 . as a consequence ,",
    "the free energy difference computed in this section by the jarzynski relation without correction ( see   below ) is in fact the generalized rigid free energy @xmath612 defined in  , in the special case @xmath152 : @xmath613 the latter free energy is associated to the normalization constant @xmath614 of the distribution @xmath615 defined by  .",
    "the generalized rigid free energy   can be explicitly related to the usual free energy as follows .",
    "first , remark that , for a fixed  @xmath274 , @xmath616 in the above , the change of variable @xmath617 has been used , in the space @xmath618 note that @xmath619 can be interpreted as the kinetic energy of the reaction coordinate  @xmath26 . using the decomposition of measures   and the above calculations ,",
    "an alternative expression of the generalized free energy is : @xmath620 where , as usual , @xmath621 denotes a generic constant ( independent of @xmath38 ) whose value may vary from line to line . as a consequence ,",
    "the standard free energy   is easily recovered from the generalized free energy , using relations similar to  . indeed , using  , and with computations similar to the ones leading to",
    ", the difference of the two free energies writes : @xmath622 in practical nonequilibrium computations , the profile @xmath623 can then be computed by adding a corrector to the work value in the jarzynski estimator computing @xmath624 .",
    "this yields the identity   mentioned in the introduction and proved below ( see the discussion after theorem  [ th : crookslangcons ] ) .",
    "the explicit expression of the lagrange multipliers in  @xmath96 is obtained by a computation similar to   for the case without switching , by differentiating twice the constraints over time : @xmath625 in view of the special structure of @xmath232 , this leads to @xmath626 the expression does not depend on the fluctuation - dissipation tensors @xmath232 .",
    "this leads to simplified computations and motivates the special form of the latter matrices .",
    "the momentum evolution  @xmath96 thus simplifies as @xmath627    let us denote by @xmath628 the generator of the forward dynamics @xmath629 defined in  @xmath96 .",
    "the latter has a backward switching version , @xmath630 obtained by using a time reversed switching @xmath631 , and by reversing the momentum first in the initial condition , and then reversing them back after the time evolution ( see  @xcite for more general backward dynamics ) .",
    "more precisely , the backward dynamics can be defined through its generator @xmath632 where @xmath633 is the generator of the forward process at time @xmath634 , and @xmath635 is the momentum flip operator with @xmath636 .",
    "thus @xmath637 is solution of the forward evolution equation  @xmath96 with a switching schedule @xmath631 .",
    "therefore , the time evolution of the backward dynamics is given by @xmath638      d",
    "p^{\\rm b}_{t'}= \\nabla v(q^{\\rm b}_{t ' } ) \\ , dt ' -\\gamma_p(q^{\\rm b}_{t ' } ) m^{-1 } p^{\\rm b}_{t ' } \\ , dt'+ \\sigma_p(q^{\\rm b}_{t ' } ) \\",
    ",   d w_{t'}^{\\rm b }   + \\nabla \\xi(q^{\\rm b}_{t ' } ) \\",
    ",   d \\lambda_{t'}^{\\rm b } , \\\\[6pt ] \\xi(q^{\\rm b}_{t ' } ) = z(t - t ' ) .",
    "\\end{cases}\\ ] ] in the following proposition , the expressions of @xmath628 and @xmath639 are explicitly written .",
    "[ prop : generators_noneq ] consider @xmath640 .",
    "then , the generator of the forward process  @xmath96 at time @xmath86 $ ] reads : @xmath641 and the generator of the backward process   at time @xmath642 $ ] reads : @xmath643 where @xmath644 is the fluctuation - dissipation operator defined in  .",
    "first , let us consider the terms in  @xmath96 arising from the hamiltonian evolution and from the switching ( _ i.e. _ without fluctuation - dissipation , which amounts to setting @xmath645 and @xmath646 in  @xmath96 ) .",
    "since during this dynamics @xmath647 , yields : @xmath648 so that , using  , @xmath649 with  , we then obtain : @xmath650 now , the hamiltonian part of the switched dynamics  @xmath96 ( see also  ) can be recognized in  , so that the generator @xmath651 when @xmath652 reads : for any smooth test function  @xmath224 , @xmath653 the full expression of the generator @xmath654 is then obtained by adding the terms arising from the fluctuation - dissipation .",
    "these terms are directly obtained from the terms involving  @xmath495 and  @xmath655 in  , as in the proof of proposition  [ s : p : lconstgen ] .",
    "the generator of the backward switching process given by   can be obtained from similar computations .",
    "first , the thermostat parts in   and in  @xmath96 are the same .",
    "consider now the hamiltonian part ( obtained by taking @xmath652 ) in the dynamics  . by definition of the backward dynamics , and the expression   of the forward dynamics , the hamiltonian part reads @xmath656 so that @xmath657 this gives  .      before stating the main result of this section ( theorem  [ th : crookslangcons ] below ) , we need to introduce a notion of work .",
    "this quantity is most conveniently defined for deterministic dynamics , but the corresponding definition is also valid for stochastic dynamics .",
    "we define the work @xmath658 associated with the constraining force  @xmath659 in  @xmath96 as the physical displacement multiplied by the force : @xmath660 by convention , @xmath661 . in the above computations",
    ", we used successively the fact that @xmath662 , and then @xmath663 are differentiable processes , so that stratonovitch and it integrations are equivalent .",
    "let us introduce the deterministic version of the nonequilibrium process  @xmath96 ( _ i.e. _ @xmath652 ) : @xmath664      d \\tilde{p}_t & = -\\nabla v ( \\tilde{q}_t )   \\,dt + \\nabla \\xi(\\tilde{q}_t ) \\ ,       d \\tilde{\\lambda}_t , \\\\[6pt ]      \\xi(\\tilde{q}_t ) & = z(t ) , \\hspace{5 cm } ( c_q(t ) )    \\end{aligned } \\right.\\ ] ] and denote by @xmath665 the associated flow between time @xmath86 $ ] and @xmath666 $ ] .",
    "the work can now be written out more explicitly using the following lemma :    the infinitesimal variation of the work   reads : @xmath667 where for all @xmath86 $ ] and all @xmath668 , @xmath669 the total exchanged work is then a time integral associated with the path @xmath629 , and is denoted by : @xmath670    note that the expression   can be interpreted as the energy variation of the system during the switching when the stochastic thermostat is turned off .",
    "the expression of the lagrange multipliers in   yields  : @xmath671 moreover , gives : @xmath672 where in the last line we have used @xmath673 .",
    "this gives  . to prove",
    ", we compute the variations of the energy @xmath674 for @xmath675 solution of   with initial condition  @xmath67 : @xmath676 the last equality is obtained using the computation of the lagrange multipliers in  .",
    "this yields  .",
    "we are now in position to state the main result of this section .",
    "[ th : crookslangcons ] consider the normalization @xmath614 for the canonical distribution @xmath615 defined in  .",
    "denote by @xmath677 the solution of the forward langevin dynamics  @xmath96 with initial conditions distributed according to @xmath678 and by @xmath679 the solution of the backward langevin process   with initial conditions distributed according to @xmath680 then , the following jarzynski - crooks identity holds on  @xmath681 $ ] : for any bounded path functional  @xmath682}$ ] , @xmath683}\\left(\\{q_t , p_t\\}_{0 \\leq t \\leq t}\\right ) \\ ,",
    "{ \\rm e}^{-\\beta\\w_{0,t}\\left({\\left\\{q_t , p_t\\right\\}}_{t\\in [ 0,t]}\\right ) } \\right ) } }      { \\e { \\left ( \\ph^{\\rm r}_{[0,t]}\\left(\\{q^{\\rm b}_{t'},p^{\\rm b}_{t'}\\}_{0 \\leq t ' \\leq t } \\right ) \\right ) } } , \\ ] ] where @xmath684 denotes the composition with the operation of time reversal of paths : @xmath685}^{\\rm r}\\big(\\ { q^{\\rm b}_{t'},p^{\\rm b}_{t'}\\}_{0 \\leq t ' \\leq t}\\big ) =       \\ph_{[0,t]}\\big(\\ { q^{\\rm b}_{t - t},p^{\\rm b}_{t - t } \\}_{0 \\leq t \\leq t}\\big).\\ ] ]    note that the theorem still holds in the hamiltonian case , _",
    "i.e. _ when @xmath686 .",
    "the choice @xmath682 } = 1 $ ] in   leads to the following work fluctuation identity : @xmath687 } ) } \\right ) \\big].\\ ] ] besides , upon choosing a path functional @xmath688 , it is possible to obtain a family of free energy estimators , parameterized by @xmath689 and where both forward and backward paths are weighted by the exponential of some work .",
    "moreover , the standard crooks equality on ratios of probability density functions of work values is also a consequence of  , see section  4.2.2 in  @xcite .",
    "note also that the choice @xmath682}(q , p ) = \\phi(q_t , p_t)$ ] leads to the following representation of the canonical distribution  @xmath690 : @xmath691}\\right ) } }   \\right ) } } { \\e { \\left ( { \\rm e}^{-\\beta\\w_{0,t } { \\left({\\left\\{q_t , p_t\\right\\}}_{t\\in [ 0,t]}\\right ) } }   \\right ) } }   = \\int_{\\manq_{\\xi , v_\\xi}(z(t),\\dot{z}(t ) ) } \\phi(q , p ) \\ ,   \\mu_{\\manq_{\\xi , v_\\xi}(z(t),\\dot{z}(t))}(dq\\ , dp ) .\\ ] ] the usual free energy profile @xmath65 can therefore be computed using the relations  - presented in the introduction .",
    "indeed , equation   ( see   below ) can be proved by combining   and   as follows : @xmath692 } ) } \\right ) \\big ] \\nonumber \\\\ & =   -\\frac1\\beta \\ln \\e { \\left (   ( \\det g_m(q_t ) ) ^{-1/2 } { \\rm e}^{\\frac{\\beta}{2 } \\dot{z}(t)^t g_m^{-1}(q_t ) \\dot{z}(t)}\\ , { \\rm e}^{-\\beta\\w_{0,t } { \\left({\\left\\{q_t , p_t\\right\\}}_{t\\in [ 0,t]}\\right ) } }   \\right ) } \\nonumber \\\\ & \\quad + \\frac1\\beta \\ln \\e { \\left (   ( \\det g_m(q_0 ) ) ^{-1/2 } { \\rm e}^{\\frac{\\beta}{2 } \\dot{z}(0)^t g_m^{-1}(q_0)\\dot{z}(0 ) } \\right ) } \\nonumber \\\\ & =   -\\frac1\\beta \\ln \\left ( \\frac { \\e\\left(\\rme^{-\\beta \\left [ \\w_{0,t } { \\left({\\left\\{q_t , p_t\\right\\}}_{t\\in [ 0,t]}\\right ) } + c(t , q_t )    \\right ]   } \\right ) } {   \\e\\left(\\rme^{-\\beta   c(0,q_0 )    }   \\right ) } \\right ) , \\label{eq : identity_to_approximate}\\end{aligned}\\ ] ] where the corrector @xmath693 is defined in  : @xmath694 this leads to the following relation : @xmath695   } \\right)}{\\e\\left(\\rme^{-\\beta c(0,q_0 )    } \\right ) } \\right),\\ ] ] estimators of the free energy based on   can then be constructed , see chapter  4 in  @xcite for a review .    before turning to the proof of theorem  [ th : crookslangcons ] , we first give the general lemma which enables to deduce the jarzynski - crooks fluctuation identity from a _ nonequilibrium detailed balance condition _",
    "( similar to the one presented in  @xcite for switchings arising from a time - dependence in the hamiltonian ) .",
    "[ lem : jarz_gen ] let @xmath696 ( resp .",
    "@xmath697 ) be a markov process with infinitesimal generator @xmath698 ( resp .",
    "@xmath699 ) and initial conditions distributed according to   ( resp .  ) .",
    "let us assume that the following nonequilibrium detailed balance condition is satisfied : for any two smooth test functions @xmath259 , @xmath260 , @xmath700 then the jarzynski - crooks fluctuation identity   holds .",
    "we use in this proof the short - hand notation @xmath701 , @xmath702 and @xmath703 for the partition function @xmath614 , the ( unnormalized ) distribution @xmath704 and the submanifold @xmath611 respectively .",
    "let us introduce the following weighted transition operators : for any bounded test function  @xmath224 , @xmath705 }   \\right ) } } \\ , \\big | \\ , ( q_t , p_t ) = ( q , p ) \\big ) ,      \\label{eq : pfwd}\\\\       p^{\\rm b}_{t',t}(\\ph)(q , p ) & =        \\e\\big(\\ph(q^{\\rm b}_{t},p^{\\rm b}_{t})\\ , \\big | \\ , ( q^{\\rm b}_{t'},p^{\\rm b}_{t'})=(q , p ) \\big ) , \\label{eq : pbwd}\\end{aligned}\\ ] ] where @xmath696 ( resp .",
    "@xmath697 ) is a markov process with infinitesimal generator @xmath698 ( resp .",
    "@xmath699 ) , and @xmath706 .",
    "we assume that these operators are well defined and smooth with respect to time for sufficiently smooth test functions defined in an open neighborhood of @xmath611 and @xmath707 respectively ( for any @xmath708 $ ] ) .",
    "the transition operators satisfy the following backward kolmogorov evolution equations : @xmath709 p^{\\rm f}_{t , t } = { \\rm i d } ,   \\end{cases } \\quad \\begin{cases } \\partial_{t ' } p^{\\rm b}_{t',t } = -{\\mathcal l}^{\\rm b}_{t ' }   p^{\\rm b}_{t',t } , \\\\[6pt ] p^{\\rm b}_{t , t } = { \\rm id}.   \\end{cases}\\ ] ] consider now two test functions @xmath710 and @xmath711 .",
    "the balance condition   implies @xmath712 integrating this equality on @xmath681 $ ] yields @xmath713 which is the crooks identity   for path functionals of the form @xmath714}(q , p ) = \\ph_0(q_0,p_0 ) \\ , \\ph_t(q_t , p_t).\\ ] ] indeed ,",
    "@xmath715 } )   } \\big ] , \\ ] ] while @xmath716.\\ ] ] then , using the markov property of the forward and backward processes , crooks identity   can be extended to finite - dimensional path functionals of the form : @xmath717}(q , p ) = \\ph_0(q_{0},p_0 ) \\dots \\ph_k(q_{t_k},p_{t_k } ) \\dots \\ph_{k}(q_{t},p_t)\\ ] ] with @xmath718 by repeatedly using a variant of   on time subintervals @xmath719 $ ] ( see the proof of theorem  4.10 in @xcite for further precisions ) .",
    "this allows to conclude since finite dimensional time marginal laws characterize the distribution on continuous paths , see for instance  @xcite .",
    "we are now in position to write the    by lemma  [ lem : jarz_gen ] , it is sufficient to prove the nonequilibrium detailed balance   for the markov processes @xmath696 and @xmath697 , solutions to  @xmath96 and   respectively , with generators  @xmath654 and  @xmath720 defined by   and  .",
    "first , using lemma  [ l : consint ] , we compute the variation of the unnormalized canonical equilibrium distribution with constraints with respect to the switching : @xmath721 on the other hand , and proposition  [ prop : generators_noneq ] give @xmath722 now , can be verified in two steps .",
    "first , the last two terms in   ( the  thermostat  terms ) cancel out after integration with respect to @xmath723 thanks to the detailed balance condition",
    ". then , an integration of   with respect to @xmath724 gives , in view of   and  , @xmath725 which is indeed  .",
    "note that the time - regularity on the evolution semi - groups  - required to make these computations rigorous is proved in the overdamped case in the proof of theorem  a.5 in @xcite .",
    "a similar proof can be carried out for constrained langevin equations .      in this section , a numerical scheme for the nonequilibrium dynamics  @xmath96 and the associated free energy estimator",
    "are presented . as for langevin processes with constraints ( section  [ sec : consnum ] ) , a splitting between the hamiltonian part and the thermostat part of the dynamics  @xmath96 leads to a simple and natural scheme ( see  -- below ) .",
    "note that a consistent numerical scheme in the case of hamiltonian dynamics can be obtained by considering only   ( this corresponds to @xmath726 ) .",
    "besides , we propose a discrete jarzynski - crooks identity without time discretization error , see section  [ sec : discrete_jarz ]",
    ".    the reaction coordinate path is first discretized as @xmath727 where @xmath728 is the number of time - steps . for simplicity ,",
    "equal time increments are used , so that @xmath729 and @xmath730 . the deterministic hamiltonian part in the equations of motion  @xmath96 with switched position constraints",
    "@xmath731 can be integrated by a velocity - verlet algorithm with constraints similar to  .",
    "the fluctuation - dissipation term in  @xmath96 can be integrated similarly to the constrained case without switching  - , using an ornstein - uhlenbeck process on the momentum variable approximated by a midpoint euler scheme . in conclusion ,",
    "the splitting scheme for the langevin dynamics with time - evolving constraints reads as follows : take initial conditions @xmath732 distributed according to @xmath733 and iterate on @xmath734 : @xmath735    & \\begin{cases }      \\dps   p^{n+1/2 } = p^{n+1/4 } - \\displaystyle{\\frac{\\dt}{2 } \\nabla v ( q^{n } ) } + \\nabla \\xi(q^n ) \\lambda^{n+1/2 } , & \\\\[6pt ]      \\dps   q^{n+1 } = q^{n } + \\dt \\ m^{-1 } p^{n+1/2 } ,   & \\\\[6pt ]      \\dps    \\xi(q^{n+1 } )   = z(t_{n+1 } ) , & ( c_q ) \\\\[6pt ]      \\dps   p^{n+3/4 } = p^{n+1/2 } - \\displaystyle{\\frac{\\dt}{2 } \\nabla v ( q^{n+1 } ) } + \\nabla \\xi(q^{n+1 } ) \\lambda^{n+3/4},&\\\\[6pt ]      \\dps    \\nabla \\xi ( q^{n+1})^{t } m^{-1 } p^{n+3/4 } = \\frac { \\dps   z(t_{n+2})- z(t_{n+1})}{\\dps \\dt } ,      & ( c_p )     \\end{cases}\\label{eq : verletconstswitched}\\\\    &    \\begin{cases }   \\dps     p^{n+1 } = p^{n+3/4 } -\\frac{\\dt}{4 } \\gamma_p(q^{n+1 } ) m^{-1}(p^{n+3/4}+p^{n+1 } ) \\\\",
    "\\dps \\phantom{p^{n+1 } = }   + \\sqrt{\\frac{\\dt}{2 } } \\sigma_p(q^{n+1 } ) { \\mathcal g}^{n+1/2 } ,         \\end{cases}\\label{eq : flucdissconstjarz2}\\end{aligned}\\ ] ] where @xmath736 and @xmath737 are sequences of i.i.d .",
    "gaussian random variables of mean  @xmath46 and covariance matrix  @xmath310 .",
    "note that the momenta obtained from  -- satisfy @xmath738 so that constraints on momenta are automatically enforced , and no lagrange multiplier is needed in   and  .",
    "we comment in the subsequent sections on the different parts of the scheme .",
    "the lagrange multipliers  @xmath401 are associated with the position constraints @xmath315 , and the lagrange multipliers @xmath406 are associated with the velocity constraints @xmath317 . in @xmath318",
    ", the velocity of the switching at time @xmath739 is discretized as : @xmath740 the latter choice is motivated by the following observation : the position after one step of an unconstrained motion , given by @xmath741 already satisfies @xmath315 up to error terms of order two with respect to @xmath80 .",
    "indeed , using  : @xmath742 this property is useful to ensure a fast convergence of the numerical algorithm solving the nonlinear constraints @xmath315 .",
    "the numerical flow associated with   is denoted in the sequel as @xmath743    ( q^n , p^{n+1/4 } ) & \\mapsto & ( q^{n+1},p^{n+3/4 } )   \\end{array}\\right.\\ ] ] it can be proven that @xmath744 is a symplectic map .",
    "the proof is indeed exactly the same as for the symplecticity of the classical rattle scheme , see ( * ? ? ?",
    "* sections  vii.1.3 ) for an explicit computation for symplectic euler and ( * ? ? ?",
    "* sections  vii.1.4 ) for an extension to rattle . as a consequence",
    ", @xmath744 transports the phase space measure @xmath745 to the phase space measure @xmath746 .      in practice , may be rewritten in a form more suited to numerical computations . of course",
    ", similar considerations hold for  . since @xmath747 and @xmath748 ,",
    "is equivalent to : @xmath749 where the lagrange multiplier @xmath329 is associated with the constraint @xmath318 .",
    "the equivalence between   and   can be checked by multiplying   by @xmath750 and using  .",
    "the lagrange multiplier @xmath329 in   is obtained by multiplying the above equation by @xmath751 , and solving the following linear system : @xmath752 this system is well posed .",
    "indeed , the matrix @xmath753 can be rewritten as @xmath754 with @xmath755 .",
    "both @xmath5 and @xmath298 are symmetric and non - negative , so that @xmath267 is symmetric , positive and invertible .",
    "finally , the invertibility of @xmath754 follows from the invertibility of @xmath34 .    in the special case",
    "when @xmath298 and @xmath5 are equal up to a multiplicative constant , the numerical integration can be simplified using the explicit formula   and the method described below  , which still holds for the tangential part of the momentum .",
    "see section  [ sec : num_res_jarz ] below for further precisions .",
    "the splitting scheme for the backward langevin dynamics with time - evolving constraints   reads as follows : denote @xmath756 , take initial conditions @xmath757 distributed according to @xmath758 and iterate on @xmath759 , @xmath760 &\\begin{cases }   \\dps   p^{{\\rm b},n'+1/2 } = p^{{\\rm b},n'+1/4 } + \\displaystyle{\\frac{\\dt}{2 } \\nabla v ( q^{{\\rm b},n ' } ) } + \\nabla \\xi(q^{{\\rm b},n ' } ) \\lambda^{{\\rm b},n'+1/2 } , & \\\\[6pt ]   \\dps   q^{{\\rm b},n'+1 } = q^{{\\rm b},n ' } - \\dt \\ m^{-1 } p^{{\\rm b},n'+1/2 } ,   \\\\[6pt ]   \\dps    \\xi(q^{{\\rm b},n'+1 } )   = z(t_{n_t - n'-1 } ) , & ( c_q ) \\\\[6pt ]   \\dps   p^{{\\rm b},n'+3/4 } = p^{{\\rm b},n'+1/2 } + \\displaystyle{\\frac{\\dt}{2 } \\nabla v ( q^{{\\rm b},n'+1 } ) } + \\nabla \\xi(q^{{\\rm b},n'+1 } ) \\lambda^{{\\rm b},n'+3/4},&\\\\[6pt ]    \\dps    \\nabla \\xi ( q^{{\\rm b},n'+1})^{t } m^{-1 } p^{{\\rm b},n'+3/4 } = \\frac { \\dps   z(t_{n_t - n ' } ) - z(t_{n_t - n ' - 1 } ) } { \\dps \\dt } , & ( c_p ) \\end{cases}\\label{eq : verletconstswitchedbck}\\\\ &    \\begin{cases }   \\dps     p^{{\\rm b},n'+1 } = p^{{\\rm b},n'+3/4 } -\\frac{\\dt}{4 } \\gamma_p(q^{{\\rm b},n'+1 } ) m^{-1}(p^{{\\rm b},n'+3/4}+p^{{\\rm b},n'+1 } )",
    "\\\\ \\dps \\phantom{p^{{\\rm b},n'+1 } = } + \\sqrt{\\frac{\\dt}{2 } } \\sigma_p(q^{{\\rm b},n'+1 } ) { \\mathcal g}^{{\\rm b},n'+1/2 } , \\end{cases}\\label{eq : flucdissconstjarzbck2}\\end{aligned}\\ ] ] where @xmath761 and @xmath762 are sequences of i.i.d .",
    "gaussian random variables of mean @xmath46 and covariance matrix  @xmath310 .",
    "the numerical flow associated with   is denoted @xmath763    ( q^{{\\rm b},n'},p^{{\\rm b},n'+1/4 } ) & \\mapsto & ( q^{{\\rm b},n'+1},p^{{\\rm b},n'+3/4 } )   \\end{array}\\right.\\ ] ] where we recall @xmath764 .",
    "assuming that the flow @xmath744 given by   and @xmath765 are both well - defined , the following reversibility property is easily checked ( extending the symmetry property of the standard rattle scheme , see for instance  ( * ? ? ?",
    "* section  vii.1.4 ) ) : @xmath766      the work   can be approximated using the lagrange multipliers in  : @xmath767 for @xmath768 . the ( formal ) consistency of the work discretization   in the time continuous limit is a direct consequence of the work expression  .",
    "an estimator of the free energy profile is then obtained by using @xmath769 independent realizations of the switching process , computing the work @xmath770 for each realization @xmath771 ( with the numerical trajectories obtained from the numerical scheme  -- and i.i.d .",
    "initial conditions sampled according to  @xmath733 ) , and approximating  , rewritten up to an unimportant additive constant ( independent of  @xmath98 ) , as @xmath772   } \\right),\\ ] ] with empirical averages such as @xmath773 \\right).\\ ] ] in the above , the discretization @xmath774 of the corrector   is @xmath775 we refer to chapter  4 in @xcite for more background on free energy estimators for nonequilibrium dynamics . in particular , it is possible to compute a work associated with the backward switching from the lagrange multipliers in  , and to resort to bridge estimators ( see section  4.2.3 in  @xcite ) .",
    "however , using approximations such as   in the jarzynski - crooks identity introduces a time discretization error .",
    "we show in the next section how to eliminate this error .",
    "it turns out that a discrete version of the jarzynski - crooks identity   can be obtained .",
    "this enables the estimation of free energy differences using nonequilibrium simulation _ without time discretization error_. the discrete equality   below may be seen as an extension of the corresponding equality obtained for transitions associated with time - dependent hamiltonians and performed with metropolis - hastings dynamics ( see  @xcite and remark  4.5 in  @xcite ) .    for this purpose",
    ", we consider a discretization of the work @xmath776 using the interpretation   of the work as the energy variation of the hamiltonian part of the langevin dynamics .",
    "this leads to the following definition of the work at the discrete level : @xmath777 for @xmath768 .",
    "this work discretization leads to a jarzynski - crooks identity without time discretization error .",
    "[ eq : jarz_disc ] consider the distribution @xmath615 and its normalization @xmath614 defined in  .",
    "denote by @xmath778 the solution of the forward discretized langevin dynamics  -- with initial conditions distributed according to @xmath779 and by @xmath780 the solution of the discretized backward langevin dynamics  -- distributed according to @xmath781 then , the following jarzynski - crooks identity holds on  @xmath782 $ ] : for any bounded discrete path functional @xmath783}$ ] , @xmath784}\\left(\\{q^n , p^n\\}_{0 \\leq n \\leq n_t}\\right ) \\ ,          { \\rm e}^{-\\beta\\w^{n_t } } \\right ) } } { \\e { \\left ( \\ph^{\\rm r}_{[0,n_t]}\\left(\\{q^ { { \\rm b } , { n ' } } , p^ { { \\rm b } , { n ' } } \\}_{0 \\leq n ' \\leq n_t } \\right ) \\right ) } } , \\ ] ] where @xmath785 is computed according to  , and @xmath684 denotes the composition with the operation of time reversal of paths : @xmath786}^{\\rm r}\\big(\\ { q^ { { \\rm b},{n ' } } , p^{{\\rm b } , { n ' } } \\}_{0 \\leq n ' \\leq n_t}\\big ) =       \\ph_{[0,n_t]}\\big(\\ { q^ { { \\rm b},{n_t - n } } , p^{{\\rm b } , { n_t - n } } \\}_{0 \\leq n \\leq n_t}\\big).\\ ] ]    the ( formal ) consistency of the work discretization   in the time continuous limit is a direct consequence of the work expression  .",
    "free energy estimators based on the identity   are obtained as described in section  [ sec : work_discretization ] .",
    "let us emphasize once again that there is no error related to the finiteness of the time - step @xmath80 in this estimator , and that the only source of approximation is due to the statistical error .    with a slight abuse of notation ,",
    "we denote in the same way the random variables @xmath787 , @xmath788 , etc . in  -- or  -- , and the integration variables in the definition of probability distributions .",
    "we divide the proof into three steps .",
    "step 1 : the phase space conservation of @xmath744 and @xmath765 and the reversibility property   imply @xmath789    step 2 : the probability distribution of @xmath790 given @xmath787 in the discretization of the fluctuation - dissipation part   is denoted @xmath791 .",
    "the scheme   is a mid - point discretization of an ornstein - uhlenbeck process , which can be rewritten by decomposing the orthogonal and tangential updates of the momentum : @xmath792 where @xmath793 , and @xmath794 .",
    "the markov chain induced by the parallel part of the momentum is the same as the one induced by the scheme   ( or  ) defined in section  [ sec : consnum ] .",
    "the latter verifies a detailed balance equation ( both in the plain sense and up to momentum reversal ) with respect to the stationary measure @xmath333 defined by   ( see sections  2.3.2 and  3.3.5 in @xcite ) .",
    "we recall that this measure is defined as the kinetic probability distribution in the momentum variable of the canonical distribution @xmath335 on the tangential space , conditioned by a given @xmath301 . adding the ( invariant ) orthogonal part of the momentum , the following detailed balance condition is satisfied : @xmath795    step @xmath195 : denote by @xmath796 the probability distribution of the variables @xmath797 given the variables @xmath787 in the scheme  -- ; and by @xmath798 the probability distribution of the variables @xmath799 given the variables @xmath800 in the scheme  -- . the splitting structure yields : @xmath801 as well as @xmath802 combining the detailed balance conditions   and   of steps  @xmath167 and  @xmath172 , and using the decomposition   of phase space measures",
    ", it follows @xmath803 which can be seen as the jarzynski - crooks identity over one time - step . iterating the argument",
    ", it is easy to obtain : @xmath804 which yields  .",
    "the splitting scheme  -- can be used in the overdamped regime , using the method of proposition  [ p : langtooverd ] , _ i.e. _ by choosing @xmath805 which implies @xmath806 and @xmath807 . for this choice of parameters , the continuous limit of the numerical scheme",
    "is the following variant of the stochastic differential equation  : @xmath808 where @xmath809 is an adapted stochastic process such that @xmath609 .",
    "we then obtain the following jarzynski - crooks relation for discretized overdamped dynamics , _ without time discretization error_.    [ p : langtooverd_jarz ] suppose that the relation   is satisfied . with a slight abuse of notation ,",
    "the mass matrix and the friction matrix are rewritten as @xmath387 and @xmath388 with @xmath389 . then the splitting scheme  -- yields the following euler discretization of the overdamped langevin constrained dynamics  : @xmath810      \\xi(q^{n+1 } ) = z(t_{n+1 } ) ,    \\end{cases}\\ ] ] where @xmath391 are independent and identically distributed centered and normalized gaussian variables , and @xmath392 are the lagrange multipliers associated with the constraints @xmath811 . in the same way , the backward process  -- yields the following euler scheme : @xmath812      \\xi(q^{{\\rm b},n'+1 } ) = z(t_{n_t - n'-1 } ) .",
    "\\end{cases}\\ ] ] consider the work update @xmath813 for @xmath768 , where @xmath814 with @xmath815 , and the scheme   is rewritten as : @xmath816   \\dps   q^{n+1 } = q^{n } + 2 p^{n+1/2 } ,   \\\\[6pt ]   \\dps    \\xi(q^{n+1 } )   = z(t_{n+1 } ) , \\quad ( c_q ) \\\\[6pt ]   \\dps   p^{n+3/4 } = p^{n+1/2 } - \\displaystyle{\\frac{\\dt}{2 } \\nabla v ( q^{n+1 } ) } + \\nabla \\xi(q^{n+1 } ) \\lambda^{n+3/4},\\\\[6pt ]    \\dps    \\nabla \\xi ( q^{n+1})^{t } p^{n+3/4 } = \\frac {    z(t_{n+2})- z(t_{n+1})}{2 } , \\quad ( c_p ) \\end{cases}\\ ] ] then the jarzynski - crooks relation   holds under the assumptions   and   on the initial conditions of the schemes   and   respectively .",
    "the proof is a direct consequence of the reformulation of   into  , and a direct application of theorem  [ eq : jarz_disc ] with the parameters  .",
    "note that the free energy estimator @xmath817   } \\right),\\ ] ] based on the work   and the corrector @xmath818 is exact ( there is no time discretization error ) .",
    "this free energy estimator can be seen as a variant of the estimator proposed in  @xcite , which was derived directly for the scheme  , and reads ( up to an unimportant additive constant ) : @xmath819   } \\right),\\ ] ] where the work is defined as @xmath820 with @xmath821 and the modified corrector is defined without the kinetic energy term : @xmath822 there is a bias due to the time discretization error in the estimator  , which can be removed upon following the procedure described in proposition  [ p : langtooverd_jarz ] .      in this section , we would like to discuss the consistency of three free energy estimators introduced above : - ( based on the direct discretization of the overdamped dynamics proposed in  @xcite ) , - ( which uses the lagrange multipliers to approximate the work ) and - ( based on the discrete jarzynski equality ) .",
    "the limiting continuous - in - time version of the jarzynski relation is : @xmath823 where the work for the overdamped dynamics   reads ( see  @xcite ) : @xmath824 with @xmath825 the consistency of  - with  - was already proven in  @xcite .    concerning the consistency of @xmath826 with @xmath827 ( see   and  ) , note that in the overdamped scaling ( @xmath828 ) , the difference @xmath829 vanishes when @xmath509 .",
    "this difference can therefore be neglected when analyzing the consistency of the scheme in the continuous - in - time limit .",
    "we henceforth concentrate on the consistency of the works   and   with  .    in the sequel , we denote the anticipating stochastic integration of the integrand @xmath830 with respect to @xmath831 by @xmath832 where @xmath833 is the stratonovitch symmetric integration , and @xmath834 the it integration .",
    "the symbol @xmath835 denotes the formal time continuous limit .",
    "[ [ consistency - of . ] ] consistency of  .",
    "+ + + + + + + + + + + + + + + +    let us justify the consistency of the work expression   with  .",
    "remark that the lagrange multipliers in verify : @xmath836 \\label{eq : lag_od_jarz_1}\\ ] ] and @xmath837 as well as @xmath838 .",
    "\\label{eq : lag_od_jarz_3 }   \\end{aligned}\\ ] ] the expressions   and   yield @xmath839 as well as @xmath840 moreover the constraints imply that @xmath841 so that @xmath401 and @xmath406 yield the same time continuous limit , that is to say @xmath842 eventually , implies @xmath843 the same holding true for @xmath844 . the work expression   is thus formally consistent with  .",
    "this concludes the proof of the consistency of - with  - .",
    "[ [ consistency - of.-1 ] ] consistency of  .",
    "+ + + + + + + + + + + + + + + +    we now prove the consistency of the work expression   with  .",
    "define @xmath845 the expression   yields using  : @xmath846 where @xmath847 first , since @xmath848 and @xmath849 , the limit of the terms in   is zero .",
    "second , using the expressions   and , and similarly to   and  , it holds @xmath850   \\\\    & - ( \\nabla \\xi g^{-1})(q^{n+1 } ) \\big [ \\nabla \\xi ( q^{n+1})^t { \\left(q^{n}-q^{n+1}\\right ) } + ( z(t_{n+2})-z(t_{n+1 } ) ) + \\dt \\nabla \\xi ( q^{n+1})^t \\nabla v ( q^{n+1})\\big ]   \\\\ & + \\frac\\dt2 ( \\nabla v(q^{n+1 } ) - \\nabla v(q^n ) ) = \\mathrm{o}(\\dt )   \\end{aligned}\\ ] ] since @xmath851 by  . expanding in higher order powers of  @xmath80",
    ", it can be checked that there exists two functions  @xmath852 and  @xmath853 such that @xmath854 therefore , since ( in the limit @xmath509 ) the martingale part of @xmath855 arises only from the term @xmath856 , one obtains @xmath857 since @xmath858",
    ". in conclusion , the second term in   has a zero contribution to the continuous - in - time limit .    as a consequence ,",
    "the formal time continuous limit of @xmath859 is the same as the one of @xmath860 .",
    "computations similar to the one performed above yield @xmath861 indeed , @xmath862 as in  , while @xmath863 .",
    "the formal time continuous limit of @xmath860 is therefore the same as the limit of @xmath864 since   implies @xmath865 we get in the end that the formal time continuous limit of @xmath860 and @xmath859 is the same as : @xmath866 where we have used  .",
    "this concludes the proof of the consistency of - with  - .",
    "we present some free energy profiles obtained with nonequilibrium switching dynamics for the model system and the parameters described in section  [ sec : simple_example_wca ] .",
    "the switching schedule reads @xmath867 with @xmath868 and @xmath869 .",
    "the time - step is @xmath870 .",
    "the initial conditions are obtained by first subsampling a constrained dynamics with @xmath871 and @xmath872 , with a time spacing @xmath873 ; and then adding the required component @xmath874 to the momentum variable ( with @xmath875 ) .    in the specific case at hand , the corrector term   is constant , and free energies differences are equal to differences of rigid free energies .",
    "the dynamics used to integrate the nonequilibrium dynamics is based on a splitting strategy , analogous to  -- , except that the midpoint integration of the ornstein - uhlenbeck part is replaced by an exact integration for the unconstrained dynamics , followed by a projection .",
    "this can be done here since we choose a friction matrix of the form @xmath388 ( recall also that @xmath876 ) . more precisely , the corresponding scheme is obtained by replacing   ( and likewise for  ) with @xmath877 where @xmath878 , and setting @xmath879 with @xmath329 chosen such that @xmath880     free energy profiles .",
    "the top curve corresponds to @xmath881 with @xmath882 , while the two other curves were obtained for @xmath883 with @xmath884 and @xmath885 with @xmath886 ( smoothest curve ) .",
    ", width=275 ]    figure  [ fig : noneq_rc ] presents estimates obtained with @xmath5 independent realizations of the switching dynamics for different switching times @xmath98 , using the estimator presented in section  [ sec : work_discretization ] with the work discretization  . in all cases ,",
    "the product @xmath887 is kept constant .",
    "the free energy profile becomes closer to the reference curve as @xmath98 is increased , and the profile obtained for @xmath885 is in excellent agreement with the result obtained with thermodynamic integration .",
    "when the switching time is small , more realizations should be considered to reduce the statistical errors and obtain estimates in better agreement with the reference profile .",
    "the fact that the variance is very large when the switching time  @xmath98 is too small is a well - known drawback of estimators based on the jarzynski - crooks identity , see the review in sections  4.1.4 and  4.1.5 in  @xcite . roughly speaking",
    ", the difficulty is related to the fact that the free energy difference is obtained as an average of @xmath888 , which requires a very good sampling of the small values of the work  @xmath889 . as @xmath98 decreases , the width of the work distribution increases and the low tail part is more and more difficult to sample .",
    "improved estimates can be obtained with estimators based on combinations of forward and backward trajectories , see for instance  @xcite and section  4.2 in  @xcite .",
    "we give in this appendix two technical lemmas , used in the proof of proposition  [ p : meanforce ] .",
    "the first lemma can also be used to prove the divergence formula  .",
    "the proof relies on the following computation rules for any family of invertible square matrices @xmath892 : @xmath893 and @xmath894 fix @xmath895 .",
    "first , using   with @xmath896 replaced by @xmath148 and @xmath897 replaced by @xmath898 , we obtain @xmath899 so that by the skew - symmetry of @xmath900 and @xmath148 , @xmath901 jacobi s identity for poisson brackets and   then yield @xmath902 since @xmath903 where @xmath904 is the kronecker symbol .",
    "finally , the left hand and right hand sides of the last equality can be factorized as @xmath905 since @xmath906 and @xmath193 is invertible , it follows @xmath907 for all @xmath908 , which is  .",
    "consider a test function @xmath910 .",
    "an integration by parts and the co - area formula   give : @xmath911 where in the last line the following chain rule has been used : @xmath912 now an integration by parts with respect to @xmath913 , together with  , leads to @xmath914 which gives the result .",
    "w.  e and e.  vanden - eijnden , _ metastability , conformation dynamics , and transition pathways in complex systems _ , multiscale modelling and simulation ( s.  attinger and p.  koumoutsakos , eds . ) , lect . notes comput .",
    "39 , springer , berlin , 2004 , pp .  3568 .",
    "e.  hairer , c.  lubich , and g.  wanner , _ geometric numerical integration : structure - preserving algorithms for ordinary differential equations _ , springer series in computational mathematics , vol .",
    "31 , springer - verlag , 2006 .",
    "t.  lelivre , m.  rousset , and g.  stoltz , _ computation of free energy differences through nonequilibrium stochastic dynamics : the reaction coordinate case _ , j. comput",
    "* 222 * ( 2007 ) , no .  2 , 624643 .",
    "s.  park , f.  khalili - araghi , e.  tajkhorshid , and k.  schulten , _ free energy calculation from steered molecular dynamics simulations using jarzynski s equality _ , j. chem .",
    "* 119 * ( 2003 ) , no .  6 , 35593566 ."
  ],
  "abstract_text": [
    "<S> in this paper , we consider langevin processes with mechanical constraints . </S>",
    "<S> the latter are a fundamental tool in molecular dynamics simulation for sampling purposes and for the computation of free energy differences . </S>",
    "<S> the results of this paper can be divided into three parts . </S>",
    "<S> ( i ) we propose a simple discretization of the constrained langevin process based on a splitting strategy . </S>",
    "<S> we show how to correct the scheme so that it samples _ exactly _ the canonical measure restricted on a submanifold , using a metropolis - hastings correction in the spirit of the generalized hybrid monte carlo ( ghmc ) algorithm . </S>",
    "<S> moreover , we obtain , in some limiting regime , a consistent discretization of the overdamped langevin ( brownian ) dynamics on a submanifold , also sampling exactly the correct canonical measure with constraints . </S>",
    "<S> ( ii ) for free energy computation using thermodynamic integration , we rigorously prove that the longtime average of the lagrange multipliers of the constrained langevin dynamics yields the gradient of a rigid version of the free energy associated with the constraints . </S>",
    "<S> a second order time discretization using the lagrange multipliers is proposed . </S>",
    "<S> ( iii ) the jarzynski - crooks fluctuation relation is proved for langevin processes with mechanical constraints evolving in time . </S>",
    "<S> an original numerical discretization without time discretization error is proposed , and its overdamped limit is studied . </S>",
    "<S> numerical illustrations are provided for ( ii ) and ( iii ) . </S>"
  ]
}