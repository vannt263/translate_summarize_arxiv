{
  "article_text": [
    "in recent years an assortment of new astronomical techniques have evolved to address the challenges of imaging faint objects and disk structure at close angular separations to nearby stars .",
    "a major scientific motivation for these efforts is the direct detection and characterization of low - mass companion bodies orbiting at separations between @xmath1 5 and 100 au .",
    "these objects are beyond the reach of conventional optical imaging due to the extreme contrast in brightness with respect to the primary star . in such cases , even under ideal observing conditions",
    "the diffracted light of the primary star overwhelms the neighboring source of interest .",
    "the various methods of manipulating a star s light to enable investigation of its immediate environment are collectively referred to as high - contrast imaging . for a recent review of this field ,",
    "see  @xcite .",
    "the acquisition of spectra of young , sub - stellar mass objects in this newly opened parameter space will ultimately lead to a breakthrough in our understanding of exoplanet populations  @xcite .",
    "project 1640 ( p1640 ) is the first of several instruments to approach the high contrast imaging problem through a combination of high - order adaptive optics , a lyot coronagraph , and an integral field spectrograph  @xcite .",
    "forthcoming instruments using a similar design include the gemini planet imager ( gpi )  @xcite , the very large telescope spectro - polarimetric high - contrast exoplanet research ( vlt - sphere ) project  @xcite , and the subaru telescope planetary origins imaging spectrograph ( poise )  @xcite . while previous efforts have used integral field spectrographs for high contrast imaging  ( e.g. * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "* ) , and lyot coronagraphs have also been employed for surveys of nearby stars  ( e.g. * ? ? ?",
    "* ; * ? ? ?",
    "* ) , p1640 is the first instrument to combine these two technologies .",
    "the coronagraph component , based on the fourier optics concept described in  @xcite , rejects the core of the target star s point spread function ( psf ) and attenuates the surrounding diffraction rings .",
    "provided that the adaptive optics ( ao ) system upstream of the coronagraph has corrected the star s psf to near the diffraction limit , then the dominant source of noise in the image exiting the coronagraph takes the form of a halo of speckles surrounding the occulted star , as in figure  [ fig : examplecube ]  @xcite .",
    "these relatively long - lived , point source - like artifacts are caused by uncorrected wave front aberrations , and limit the dynamic range of the data unless further processing is carried out  @xcite .",
    "the integral field spectrograph , also referred to as the integral field unit ( ifu ) , is situated after the coronagraph and provides spatially resolved spectra for a grid of points across the field of view  @xcite .",
    "the reduced form of data acquired with an ifu is a stack of simultaneous narrowband images spanning the instrument s wavelength range , often called a data cube .",
    "an example of part of a p1640 data cube is shown in figure  [ fig : examplecube ] .",
    "one benefit the ifu provides is enabling the observer to measure the spectrum of any source at any position in the field of view .",
    "this is not possible with a conventional spectrograph , which can only use one spatial dimension at a time to discriminate against other sources in the field of view .",
    "the second purpose of the ifu is to exploit the chromatic behavior of the speckles  @xcite .",
    "speckles are optical in origin and their separation from the target star is linearly proportional to wavelength , at least to a first - order approximation ( see figure  [ fig : examplecube ] ) . by comparing the images in different channels of the data cube",
    ", the observer can discriminate the speckles from a true point source , whose position should remain constant with wavelength . furthermore , automated post - processing software can use the chromaticity of the speckles to subtract a large component of them from the data , taking a reduced data cube as input and generating a speckle - suppressed version  @xcite .",
    "the unusual properties of data generated by the p1640 ifu necessitate novel reduction techniques to reach the point where inspection , spectrophotometry , astrometry , and advanced post - processing techniques like speckle suppression can begin . in the scope of this article",
    ", we describe the software created to translate rapidly the raw data from the ifu camera to a set of data cubes ready for further analysis .",
    "during operation at palomar observatory , p1640 receives a wave front - corrected beam of the target star s light from the 200 \" hale telescope ao system .",
    "the current ao system , the 241-actuator palao  @xcite , will soon be upgraded to the 3388-actuator palm-3000  @xcite . upon entering the instrument",
    ", the light passes through an apodized lyot coronagraph , followed by an integral field spectrograph , which contains a near - infrared camera .",
    "in addition to the focal plane mask and lyot stop of a traditional lyot coronagraph , p1640 uses a pupil plane apodization mask to optimize the starlight suppression based on the telescope pupil shape  @xcite .",
    "the beam exiting the coronagraph comes to a focus on a @xmath2 square microlens array at the entrance of the spectrograph . immediately after the microlens array ,",
    "the light is collimated to form a pupil on a wedge - shaped prism , which disperses the light over the 1.1 - 1.8 @xmath3 m wavelength range of operation spanning the @xmath4 and @xmath5 bands .",
    "additional optics focus the @xmath6 resulting spectra onto a teledyne hawaii-2 @xmath7 pixel , hgcdte , near - infrared detector .",
    "the field of view of the final image , designed to match the control radius of the palm-3000 ao system , is @xmath8 . for further details on the optical and mechanical design ,",
    "see  @xcite .    for each exposure",
    ", the camera controller performs a sequence of non - destructive reads on the detector array . in other words ,",
    "the digitized value of each pixel is periodically sampled while its voltage escalates .",
    "this technique , known as up - the - ramp sampling , can result in the read noise being reduced by a factor of @xmath9 in a reduced image when the counts versus read slope is fit for the @xmath10 samples of each pixel  @xcite .",
    "up - the - ramp sampling also adds an advantageous temporal dimension to our data .",
    "speckle suppression algorithms work best when the positions of the speckles are well - defined . for bright stars with high signal - to - noise in individual read differences",
    ", it may be helpful to `` freeze '' the speckle pattern with the higher time resolution enabled in a read - by - read data reduction .",
    "our pipeline reduces the detector data with both approaches : the non - destructive read ( ndr ) slope fit and consecutive read differences .",
    "the read sample interval is fixed at 7.7 seconds by the camera controller .",
    "the sequence of reads are stored in a binary file containing the arrays of 16-bit unsigned integer samples , which we refer to as a _ dat _ file .",
    "the camera controller also generates a separate fits file with a header containing the information about the telescope and instrument status , the target ( coordinates , magnitude , parallax , etc . ) , and the name of the _ dat _ file corresponding to the exposure . a typical observation of a project 1640 science target is made up of 15 exposures , each containing 20 reads , giving a cumulative exposure time of @xmath11 minutes .",
    "the resulting volume of raw data is 160 mbytes for each exposure s _ dat _ file and 2.4 gbytes in total .",
    "the structure of the p1640 ifu focal plane , illuminated by moonlight , is depicted in figure  [ fig : focpldiagram ] .",
    "the microlens array , represented by the dotted grid superimposed on the left panel , is rotated with respect to the detector .",
    "this configuration interleaves the adjacent rows of microlens spectra , thereby maximizing the efficiency of focal plane area usage . along a given column of microlenses ,",
    "the mean interval between neighboring spectra is 3.3 pixels in the horizontal direction and 10.0 pixels in the vertical direction .",
    "each spectrum takes up a length of approximately 27 pixels in the dispersion direction .",
    "rather than relying purely on design predictions , we have written procedures to empirically determine the ifu response , capturing the minute optical distortions and alignment changes unique to each observing run .",
    "two forms of calibration data are used as input for the focal plane model .",
    "the first kind are the spectrograph images formed by illuminating the instrument pupil with a tunable laser source .",
    "these allow us to characterize the response at fixed wavelengths across the passband . secondly ,",
    "during each observing run we observe a broadband source of nearly uniform brightness across our field of view  either the moon or the twilight sky . in the case of the moon calibration images ,",
    "the telescope ao correction loop was turned off , and several exposures with different pointings were averaged .",
    "these images constrain the geometry of the focal plane , including the positions and shapes of the individual spectra formed on the detector , as well as large - scale variations in sensitivity across the field of view due to vignetting .      an accurate model of the monochromatic spectrograph point",
    "spread function ( psf ) is at the core of the ifu focal plane model .",
    "we emphasize the distinction here from the coronagraph psf , which is formed on the mircolens array at the entrance of the ifu .",
    "the spectrograph psf , on the contrary , is the signal formed on the ifu focal plane from monochromatic light incident on an individual microlens . in a laboratory environment before the first scientific observing run , we illuminated the ifu with a tunable laser source and recorded narrowband emission ( bandwidth @xmath12 4 nm ) images at wavelengths in 0.01 @xmath3 m increments spanning the 0.7 @xmath3 m operating band of the instrument .",
    "any given laser image shows a grid of @xmath0 point spread functions , each corresponding to a microlens illuminated by the beam entering the spectrograph . from these images , we derived an analytic model of the spectrograph psf specific to the recorded wavelength , as follows :",
    "first , a script looped through all of the psfs in the spectrograph image , forming a 9@xmath139 pixel _ mean _ psf based on the subset having centroids within 0.05 pixels of a detector pixel center .",
    "next , we experimented with a variety of two - dimensional functional forms to represent the psf , progressively adding parameters until finding one with a good match to the data .",
    "since in our case the detector pixel width is comparable to the psf full - width half maximum value , it was necessary to take into account not only the effect of the finite detector pixel area in sampling the function , but also intra - pixel sensitivity variations .",
    "charge diffusion is the largest contribution to non - uniform sensitivity within any given pixel . during the technology development phase of a space mission to survey extragalactic supernovae ,",
    "@xcite measured the effect of charge diffusion on the intra - pixel sensitivity of a hawaii-2 detector .",
    "he found a good empirical fit to a typical pixel s response by convolving a tophat function ( with width equal to that of the detector pixel ) with a hyperbolic secant diffusion term , @xmath14 , where r is radius from origin and @xmath15 is the diffusion length . with the established diffusion length of 1.9 @xmath3 m ( compared to the 18 @xmath3 m full pixel width )",
    ", the response falls to about 50% of the peak at the middle of each pixel edge . for lack of similar measurements of our own hawaii-2 detector",
    ", we assumed the same charge diffusion behavior .",
    "we discretized the two - dimensional functions representing the psf , @xmath16 , and intra - pixel response , @xmath17 , at a resolution of @xmath18 times that of the detector , where @xmath18 is an odd number @xmath19 3 .",
    "in other words , the image model has @xmath20 samples contained within each detector pixel , one always aligned with the center of a pixel .",
    "the intra - pixel response function , @xmath21 , is only defined over an area of one pixel , so that @xmath22 , whereas @xmath23 is defined over the entire @xmath24 area of the mean psf cutout , corresponding to @xmath25 . in this notation , the detector - downsampled psf , @xmath26 is determined by    @xmath27    where @xmath28 are independent variables representing detector samples over the @xmath29 pixel mean psf cutout .",
    "we found a satisfactory functional form to match the monochromatic psf by taking the sum of two piecewise , two - dimensional gaussian profiles , defined as follows :    @xmath30    where @xmath31    nine parameters fully describe the psf in this formulation : two amplitudes , six characteristic widths , and one rotation .",
    "the piecewise definition allows freedom from reflective symmetry across the @xmath32 axis .",
    "hence there is a pair of characteristic widths for each side of the @xmath33 axis ",
    "one for @xmath34 ( @xmath35 and @xmath36 ) the other for @xmath37 ( @xmath38 and @xmath39 ) .",
    "also note the coordinate transformation built into the definition ( equation  [ eqn : coordxform ] ) .",
    "the operations in the right hand column vector serve two purposes .",
    "first , they shift the effective origin from the lower left corner of the @xmath29 cutout array ",
    "its original position for the purpose of simplified indexing in equation  [ eqn : psfbinning]to its center . at the same time , the @xmath40 factor scales both coordinates to units of detector pixel width .",
    "finally , the @xmath41 matrix facilitates a rotation of the overall surface by angle @xmath42 in the counterclockwise sense .    using mpfit ,",
    "the non - linear least squares fitting program written by  @xcite , we determined the function parameters for the mean psf cutouts at wavelengths 1.25 @xmath3 m and 1.58 @xmath3 m .",
    "the results , based on a model spatial sampling rate of @xmath43 times that of the detector , are listed in table  [ tab : psfparams ] . in each case , the amplitudes were scaled so as to give unity peak intensity in the detector - downsampled psf . as in equation",
    "[ eqn : psfdef ] , the characteristic widths are in units of detector pixel widths . in figure",
    "[ fig : psf_cross_sections ] we have plotted orthogonal cross sections of the best - fit psf functions . in the same figure we drew bars to represent the corresponding detector - downsampled psf cross sections .",
    "note that the peak of each model function is significantly higher than that of the detector - downsampled version , due to the sensitivity roll - off away from the pixel center . at both wavelengths ,",
    "the mean residual disparity between the downsampled best - fit model and the original mean laser psf cutout ( not shown in the plot ) is the less than @xmath44 of the peak intensity .",
    "cccccccccc    1.25 & 1.31 & 0.33 & 0.52 & 0.85 & 0.38 & 1.22 & 0.91 & 1.85 & @xmath45 + 1.58 & 1.32 & 0.27 & 0.55 & 0.81 & 0.44 & 1.14 & 0.90 & 1.87 & @xmath46 +      we built upon knowledge of the spectrograph psf to characterize the coarse near - infrared spectra distributed across the ifu focal plane .",
    "here we turned to our moon and twilight sky calibration exposures , during which each microlens was illuminated with a strong , uniform , broad spectrum of light .",
    "an example image of this kind was illustrated in figure  [ fig : focpldiagram ] . by isolating the small detector area containing an individual microlens signal",
    ", we can fit a set of parameters encoding the spectrum geometry .",
    "ccccc    position @xmath47 & @xmath48 & n / a & ( 0.02047.0 , 0.02047.0 ) & n / a + height ( @xmath49 ) & @xmath50 & 23.9 pixels & 23.524.7 pixels & 0.2 pixels + tilt ( @xmath51 ) & @xmath52 & 0.044 & 0.00900.080 & 0.021 +    in table  [ tab : specparams ] we have listed the parameters needed to describe the spectrum image of an individual microlens .",
    "the @xmath47 position coordinates are the most fundamental of these .",
    "they are referenced to the @xmath53 = 1.37 @xmath3 m point , which coincides with the sharp ( blue ) edge of the telluric water absorption trough between the @xmath4 and @xmath5 bands .",
    "the @xmath54 coordinates index the full detector array from an origin at the pixel in the lower left ( sw ) corner of the image ; all integral values align with a pixel center . using similar notation ,",
    "we defined the spectrum height and tilt based on the relative positions of the @xmath53 = 1.10 @xmath3 m and 1.76 @xmath3 m points , which roughly correspond to the edges of our passband . from the position , height , and tilt , the coordinates of an arbitrary wavelength in the spectrum can be calculated by the following parametrized equations :    @xmath55    where @xmath49 is height , @xmath51 is tilt , and @xmath56 m . by this definition ,",
    "each integral step in @xmath57 corresponds to 0.03 @xmath3 m , so there is a total of 22 such increments from 1.10 @xmath3 m and 1.76 @xmath3 m . using the same wavelength parameter , we can specify the intrinsic spectrum incident on the focal plane by some function @xmath58 for @xmath59 .",
    "we introduce the concept of spectrum _ trace _ to model the layout of the spectrum by an ideal `` skeleton '' image formed by a train of impulse functions , unencumbered by diffraction and focus effects .",
    "the trace is discretized in the same manner as the psf model , at a resolution @xmath18 times higher than that of the detector . in this case , however , we use a lower spatial sampling rate factor of @xmath60 to balance reasonable execution speed and performance . by convolving the trace with the reverse of the psf ( rotated 180@xmath61 ) , and downsampling the result",
    ", we can synthesize a spectrum image as measured by the detector ( figure  [ fig : moddescrip ] ) .",
    "the position , height , and tilt parameters , along with the intrinsic spectrum can then be adjusted by a least squares fitting algorithm until the downsampled result matches the data cutout .    a cutout spanning an area of @xmath62 detector pixels is sufficient to enclose an individual spectrum as well as major portions of the two nearest neighbors .",
    "at the start of the fitting procedure , the cutout is aligned such that the ( @xmath63 ) reference point of the spectrum nearly corresponds to pixel position ( 4 , 16 ) in the detector - downsampled trace array .",
    "two free parameters in the model , @xmath64 and @xmath65 , allow the algorithm to refine the initial position guess alongside the other geometrical properties .",
    "for a given microlens spectrum , the following equations define the conversion between @xmath66 detector indices and @xmath67 trace array indices :    @xmath68    from which it follows that the trace indices of the 1.37 @xmath3 m reference point are @xmath69 .",
    "based on the typical interval between spectra along a microlens , we set the 1.37 @xmath3 m reference points of the neighboring spectra by @xmath70 and @xmath71 .",
    "the trace signal is dispersed over the same line segment defined in equation set  [ eqn : specxyparam ] , with intrinsic spectrum function @xmath58 .",
    "the neighboring spectra are parametrized by the same shape with respect to their own reference points , ( @xmath72 ) and ( @xmath73 ) .",
    "we form separate trace arrays for the @xmath4- and @xmath5-band halves of the spectra , designated @xmath74 and @xmath75 .",
    "we do this in anticipation of separate convolution operations with the @xmath4- and @xmath5-band psfs ( figure  [ fig : psf_cross_sections ] ) .",
    "the two respective trace arrays are defined as follows :    @xmath76    where @xmath77 , @xmath78 , and @xmath79 .    to test a given set of spectrum model parameters , we convolve the @xmath4 and @xmath5 trace arrays with the reverse of the psf model ( such that @xmath80 ) , giving a high - resolution model of the light distribution on the focal plane , @xmath81 :    @xmath82    implicitly , we have zero - padded the trace arrays before the convolution , and trimmed the result to the original @xmath83 array size .",
    "the detector - downsampling operation is similar to that used earlier for the psf model :    @xmath84    however , one new variable has been introduced in equation  [ eqn : binnedspec ] : @xmath85 , a constant offset added to each pixel in the downsampled image model .",
    "this is one more parameter open to adjustment by the fitting procedure , which takes into account any background level of scattered light present in the data cutout . for a point source , in some focal plane locations this background reaches up to 3% of the 99.5 percentile - level count rate , considering all detector pixels .",
    "therefore , it becomes especially significant for an exposure of a source as bright as the moon .",
    "the resulting synthetic spectrum image @xmath86 can be directly compared with the data cutout ( figure  [ fig : moddescrip ] ) . in principle , the least squares fitting algorithm ( the mpfit program in our case ) converges on the data cutout over many loops , switching between revising the trace model parameters and comparing the downsampled result to the data .",
    "the combination of unknown position , shape , and intrinsic spectrum @xmath58 presents too many free parameters for a fitting algorithm to accurately solve for at once . in practice",
    ", we need to iteratively build up constraints , starting from as few assumptions as possible .",
    "one aspect of the moon / sky calibration exposure we can take advantage of is the fact that the intrinsic spectrum , @xmath58 , is identical across the image , apart from scale factors due to large - scale variations in sensitivity over the field of view . in addition , by referring to the laser calibration images , we can make very good initial guesses of the height and tilt for a given region of the focal plane .",
    "still , we found these constraints alone were insufficient to reach consistent solutions .",
    "the exact vertical position of the spectrum ( encoded by @xmath65 in equation set  [ eqn : uvdef ] ) proved especially difficult to determine with only limited information about the light source and the instrument response . to get over this barrier , we chose to use prior knowledge of the atmosphere s transmission function  in particular , the shape imposed on the spectrum by the deep water absorption trough in the middle of the p1640 passband .",
    "figure  [ fig : watertrough ] shows the expected transmission function of the atmosphere from 1.28 @xmath3 m to 1.52 @xmath3 m .",
    "the data points are based on the measurements made by  @xcite from kitt peak ( at altitude 6875 ft , comparable to the 5618 ft altitude of the palomar observatory hale telescope ) , here averaged over 0.01 @xmath3 m bins . instead of allowing the points inside the water trough ( @xmath87 ) to vary freely ,",
    "we impose the condition    @xmath88    where @xmath89 is the peak - normalized atmospheric transmission function plotted in figure  [ fig : watertrough ] . inside the water trough",
    ", @xmath58 is discretized in 0.01 @xmath3 m bins ; outside , in 0.03 @xmath3 m bins ( integral values of @xmath57 ) .",
    "once the above assertion is in place , the fitting algorithm could at last reliably determine both the position and shape of the spectrum , as achieved in the example shown in figure  [ fig : moddescrip ] .",
    "[ eqn : watercond ]      we repeated the spectrum fitting procedure across the entire spectrograph image to form a global solution unique to the specific epoch of the moon / sky calibration exposure . to minimize the number of free parameters before executing this , we first determined a mean intrinsic spectrum @xmath90 based on average of the @xmath58 fit results from a sub - area of about 100 spectra near the center of the field of view . with the spectrum shape fixed",
    ", however , there needs to be a parameter that captures variations in overall signal strength across the focal plane .",
    "we designated an amplitude parameter @xmath91 to acts as a multiplicative constant , applied to @xmath90 , and freely adjusted alongside @xmath92 , @xmath93 , @xmath49 , @xmath51 , and @xmath94 .    in figure",
    "[ fig : param_maps ] we have displayed maps of the height , tilt , and amplitude parameters for one epoch .",
    "these maps proved essential to the challenging process of debugging the fitting routines .",
    "they also enable easy visual comparisons between focal plane properties at different times , and can serve as diagnostic tools during periods of modifications and upgrades to instrument optics .",
    "the maps in figure  [ fig : param_maps ] appear as rotated squares because the microlens array is by design rotated with respect to the detector ( as shown previously in figure  [ fig : focpldiagram ] ) .",
    "we index the microlenses using cartesian coordinates @xmath95 and @xmath96 relative to an origin at the lower left corner . with these coordinates ,",
    "a range of @xmath97 is sufficient to enclose the @xmath0 microlens spectra on the detector .",
    "the ability to analyze the _ spatial _ distribution of the ifu spectra is also of great interest . a vector field , like those depicted in figure  [ fig : distortion ] ,",
    "is an effective way to illustrate the evolution of the global spectrograph focal plane geometry . to make these plots , we first partitioned the calibration image into an array of @xmath98 boxes , each of width 256 detector pixels .",
    "for any two comparison epochs , each with spectrum position arrays @xmath99 and @xmath100 , we calculated the median of the differences @xmath101 and @xmath102 inside each box , resulting in an @xmath98 array of vectors . before plotting those vectors , we subtracted the median difference vector at the image center . in this way",
    ", we removed the effect of a trivial bulk shift between the focal plane patterns .",
    "depending on the duration of time between the pair of calibration images under consideration , the quivers representing the vectors need to be scaled up by different factors to reveal the subtle evolution .",
    "once this is done , it becomes clear that the overall scale and orientation of the spectrograph focal plane pattern vary with time .",
    "more complicated , non - uniform distortions also play a role . in all cases ,",
    "the magnitude of these changes are small enough that they would never be obvious from a mere `` blinking '' comparison of the source images .",
    "for example , the transformation from march 2009 to june 2009 can mostly be attributed to a rotation of the microlens array with respect to the detector ( or vice versa ) by an angle of merely @xmath103 .",
    "likewise , between 28 june 2009 and 29 june 2009 , the focal plane was magnified by about 0.003% .",
    "it is a fair guess that the changes we observe in global focal plane geometry are due to minute variations of environmental conditions inside the ifu dewar .",
    "however , it remains unclear what the relative contributions are from the various optics and the mechanical support structures . to an extent ,",
    "the origin of these changes is not an issue , so long as each science data set can be attached to a solution that accurately reflects its particular geometry .",
    "another important product of our global fitting procedure is a synthetic image of the entire spectrograph focal plane . using the established geometric parameters",
    ", we can inject an arbitrary source spectrum @xmath104 to simulate the distribution of light incident on the detector .",
    "the synthetic focal plane image is useful for inspecting the results of the global fit , and is also an essential ingredient in the algorithm used by the cube extraction pipeline to register the spectrograph image of an individual science exposure at sub - pixel precision ( described in ",
    "[ sec : specreg ] ) .",
    "the formalism is analogous to that described for the individual spectrum cutout model in equations  [ eqn : uvdef][eqn : binnedspec ] .",
    "we designate @xmath105 and @xmath106 to represent the @xmath4- and @xmath5-band model trace arrays of the full spectrograph focal plane image , discretized at a spatial sampling rate @xmath18 times that of the detector .",
    "since the hawaii-2 detector array size is @xmath7 , the trace arrays are defined over @xmath107 . here",
    "we again settled on a sampling factor of @xmath18 = 7 . since as before ,",
    "we require @xmath18 to be an odd integer @xmath108 , there is always a pair of trace array indices @xmath109 aligned with the center of a given detector pixel @xmath66 :    @xmath110    the trace array is determined by the position , height , and tilt solutions , now indexed by microlens coordinates @xmath111 :    @xmath112    @xmath113    from the trace arrays , we obtain the spectrograph focal plane image model @xmath114 in the same manner as in   [ sec : spectrummodel ] , by convolving them with their corresponding reversed psf models :    @xmath115    we implement these convolution operations in the fourier domain to save computational time , which is otherwise a nuisance for the large dimensions of our arrays  @xcite . with a spatial sampling factor of @xmath116",
    ", we obtain a factor of @xmath1 50 using fft - based convolution over direct convolution . in our experience , this cuts the execution time needed to form the synthetic image down from a few hours to a few minutes ( assuming the global solution is already done ) .",
    "finally , we can obtain the detector - downsampled synthetic focal plane image , @xmath117 , by binning @xmath118 to the detector resolution using the assumed intra - pixel response :    @xmath119    note that this synthetic detector image is idealized in the sense that we have left out the amplitude modulations across the image ( @xmath120 ) as well as background light parameters ( @xmath121 ) .",
    "for the purpose of registering a science spectrograph image , this is preferred , since we are only concerned with matching the shapes and positions of the spectra .",
    "the project 1640 data cube extraction pipeline ( pcxp ) , written in the gnu c programming language , automates the processing of raw p1640 detector images and their translation to reduced data cubes . a block diagram summarizing the steps applied to each image is shown in figure  [ fig : blockdiagram ] . by design ,",
    "the program is fast enough to use while observing , so that newly acquired images can be inspected in real time to monitor instrument performance and check for unknown objects .",
    "the data pipeline can also be used to process an arbitrarily large set of raw data at a later date . for post - processing",
    ", we feed the output of the pcxp into the project 1640 speckle suppression pipeline ( pssp ) , described by  @xcite .",
    "two outer loops comprise the pcxp execution .",
    "first , the program steps through the detector data in the input directory specified by the user at the start time , processing each non - destructive read ( ndr ) sequence to form a reduced , registered spectrograph image .",
    "the second stage of the pipeline loops through the finished spectrograph images and extracts data cubes from each of them . throughout these steps ,",
    "the pipeline relies on the empirical model of the spectrograph focal plane described in ",
    "[ sec : focplmodel ] .",
    "the pipeline identifies pixels contaminated by cosmic rays by checking for anomalous jumps in digitized count values within the ndr sequence . for each detector pixel",
    ", our algorithm determines the median increase in counts between successive reads over the course of the exposure .",
    "a count increment greater than five times the median is flagged as a cosmic ray event . at each pixel meeting",
    "this criterion , the count contribution of the cosmic ray event is subtracted from the read corresponding to the event as well as all the following reads , canceling out its influence .",
    "we chose our threshold based on inspections of images of faint occulted stars , with relatively noisy slopes .",
    "we blinked `` before '' and  after  images to check that all apparent cosmic ray events , and no starlight - dominated pixels were erroneously flagged .",
    "this method of cosmic ray removal only works for exposures consisting of more than two reads . for a shorter exposure",
    "there is no way to take advantage of the ndr detector mode to identify cosmic rays . in this case",
    "the pipeline passes the detector image through the iraf noao cosmic ray cleaning algorithm .      during each observing run , a set of ``",
    "dark '' ndr sequences are obtained by taking calibration exposures with the ifu in a cryogenic state identical to the scientific data acquisition mode , except that the coronagraph beam entrance window is capped to obstruct external light .",
    "these dark exposures record the bias , thermal , dark current , and badly - behaved `` hot '' pixel count values of the detector array at each read interval .",
    "the median of 11 dark ndr sequences for each exposure time is added to a permanent library directory of dark exposures , marked by date and exposure time .",
    "see figure  [ fig : dark ] for an example of a dark exposure .",
    "after loading the _ dat _ file of a science target , the first processing step of the pipeline is to find the most appropriate dark ndr sequence and perform a readwise subtraction .      after subtracting the bias / dark component and removing the cosmic rays , the pipeline fits a slope to the adu count versus time values recorded in the ndr sequence .",
    "this reduces the detector data for a given exposure to a single @xmath7 pixel representation of the spectrograph image .",
    "we employ an ordinary least - squares linear regression to determine the count rate for each pixel , eventually storing the floating point values in a fits file in units of counts / second .    the slope fitting is complicated by pixel saturation caused by bright sources . however , the ndr detector mode is advantageous for handling this . in the case where a pixel reaches saturation at some point after the first two reads ,",
    "the affected reads are simply excluded from that pixel s linear regression .",
    "this approach , recommended after tests described by  @xcite , extends the effective dynamic range of a long exposure by a factor of @xmath122 . for pixels that reach saturation before the second read",
    ", a slope computation is not possible .",
    "if this saturation occurred between the first and second reads , then the slope can at least be approximated based on the difference between the first read value and an assumed zero level from the dark ndr sequence .",
    "however , in the case of a pixels saturating before the first read , this result will not be physically meaningful . to prevent erroneous measurements from being made by investigators analyzing images affected by saturation",
    ", the pipeline sets an appropriate header variable in the reduced fits files .",
    "this header keyword indicates whether any of the detector pixels saturated , and if so , whether that occurred at the first , the second , or a subsequent read .",
    "a externally controlled lamp inside the dewar of the p1640 ifu can fully illuminate the detector . to counteract pixel - to - pixel variations in detector sensitivity",
    ", we constructed a detector flat field map based on the mean of 12 dewar lamp exposures .",
    "since the lamp intensity is not uniform across the detector , we used iraf to fit a cubic spline surface to the normalized , mean dewar lamp image .",
    "we divided by the resulting spline surface to form the final detector flat , with large - scale variations removed ( see the next section for an explantation of how large - scale variations in sensitivity are corrected for during cube extraction ) .",
    "the standard deviation of pixel values in the detector flat field map is 0.13 . after the ndr slope - fitting step ,",
    "the pipeline divides the spectrograph image by the flat field map to compensate for pixel - to - pixel variations .",
    "for locations in the flat field map with exceptionally low values ( @xmath123 ) , no division is carried out since doing so would tend to enhance the noise induced by weak , problematic pixels .",
    "due to flexure  varying mechanical stress on the instrument while the telescope slews  the projection of the microlens array onto the detector changes over the course of an observing period .",
    "the plot in figure  [ fig : offsets ] illustrates the magnitude of this effect based on measurements from three observing runs . between targets , the positions of the spectra on the detector can uniformly shift by up to 2 pixels in each direction . between observing runs",
    "there is a more pronounced , systematic shift in the spectrograph - detector alignment . to accurately extract the data",
    ", the pipeline needs to register the precise offset between each spectrograph image and the focal plane model of the corresponding epoch .",
    "we accomplish this through two stages : first a crude estimate based on a cross - correlation with the downsampled spectrograph image model ( array @xmath124 in equation  [ eqn : binnedimagemodel ] ) , followed by a more elaborate approach to refine the offset to sub - pixel precision .    for efficiency",
    ", the initial cross - correlation is restricted to a @xmath125 square pixel section of the science image @xmath126 .",
    "we denote this cutout box with a tilde accent on top of the original array symbol :    @xmath127    likewise we use @xmath128 to represent the same section from the downsampled focal plane image model .",
    "the center of the box , @xmath129 , is chosen based on the average count rate computed within @xmath130 partitions across the image , so as to enclose spectra with relatively high signal strength . in a typical science image with the star occulted by the coronagraph ,",
    "this is near the center of the image , where the residual starlight is brightest .",
    "we cross - correlate @xmath128 and @xmath131 to determine the _ crude _ offset .",
    "a given science focal plane pattern is not expected to stray more than two pixels away from the calibration exposure of the matching epoch .",
    "furthermore , the periodicity of the spectrum pattern ensures that large lags will merely introduce degenerate solutions . therefore , we do not compute the full two - dimensional cross - correlation array , but merely a small region bounded by horizontal and vertical lags up to 4 pixels in each direction :    @xmath132    the summation limits take the lag range into account in order to avoid the influence of non - overlapping array edges . the lag combination that maximizes @xmath133 , which we denote @xmath134 ,",
    "is our initial guess for the horizontal and vertical displacement of @xmath135 with respect to @xmath124 .",
    "the second stage of the registration routine determines separately the _ fine _ @xmath136 and @xmath137 offsets . as apparent in figure",
    "[ fig : focpldiagram ] , the spectral dispersion is almost completely aligned with the @xmath137 axis of our detector image coordinate system . as a consequence",
    ", the shape of a spectrum s horizontal cross - section at a given wavelength is determined much more by the spectrograph psf shape than by the intrinsic spectrum of the light source .",
    "it is effectively the cross - dispersion profile commonly referred to in literature on more conventional spectroscopic observations  ( e.g , * ? ? ?",
    "therefore , to measure the effect of a slight horizontal offset on the detector - sampled image , we can start with the high - resolution model of the light distribution @xmath118 ( equation  [ eqn : imagemodel ] from   [ sec : globalsol ] ) , even though its intrinsic spectrum does not necessarily match the data . to simulate how the detector would `` see '' the image model for a range of small fractional - pixel offsets from the initial alignment ,",
    "we downsample @xmath118 as in equation  [ eqn : binnedimagemodel ] , but with the detector sampling array shifted by a range of horizontal sub - pixel offsets indexed by the variable integer @xmath138 :    @xmath139    now we reevaluate the cross - correlation peak for the @xmath18 fine horizontal offsets values , with @xmath32 and @xmath33 fixed at @xmath140 and @xmath141 :    @xmath142    the fractional offset index @xmath138 that maximizes @xmath143 gives the fine horizontal displacement of the data , @xmath138 , with respect to the crude initial guess , @xmath140 .",
    "the full horizontal offset is @xmath144 detector pixel widths .",
    "we originally intended to use the same approach to determine the fine vertical offset .",
    "unfortunately , in this case the disparity between the intrinsic spectrum of the data and the image model strongly biases the cross - correlation result . in a typical science image",
    ", the cutout box @xmath131 contains @xmath110 speckles .",
    "their chromatic position dependence ( as illustrated in figure  [ fig : examplecube ] ) causes steep brightness gradients in the spectra formed on the spectrograph focal plane , since a given microlens will collect light from a speckle over only a fraction of the passband .",
    "whatever intrinsic spectrum is built into the image model , @xmath118 , will significantly differ from that of most of the sample .",
    "we found that the effects of these disparities do not average out over an ensemble .",
    "instead , they systematically push the cross - correlation result up or down by a degree that does not reflect the actual relative wavelength alignment .    instead of using the image model as an alignment template",
    ", we return to the fitting approach described in ",
    "[ sec : spectrummodel ] .",
    "this time , however , rather than fitting the full spectrum parameter set , we concentrate on the region with the most information about the vertical position : the telluric water absorption trough .",
    "therefore , we confine the least - squares fit region to a @xmath145 box , aligned such that the 1.37 @xmath3 m reference point is near the middle pixel on the 8th row .",
    "we further simplify the spectrum fit by describing the local light source with merely two parameters : an amplitude and color .",
    "the other free parameters are the background light offset and the vertical position .",
    "the height and tilt are already known from the calibration image solution , and the horizontal position is fixed based on the previous step in the registration algorithm . as in equation  [ eqn : troughcond ] , the spectrum trace points with wavelengths @xmath146 m are again tied to the transmission function plotted in figure  [ fig : watertrough ] .",
    "the anchor points at @xmath1471.28 @xmath3 m and 1.58 @xmath3 m are set based on the amplitude and color parameters .    to get a diverse set of spectrum shapes spanning a wide region of the speckle halo , during the fine vertical offset fitting procedure we sample 121 spectra over a @xmath148 pixel box ( as compared to the @xmath2 pixel box used for the horizontal registration ) .",
    "of the 121 fits , the median vertical offset is taken as the final value , and rounded to the nearest 1/7th of a pixel to match the quantization of the fine horizontal offset . in",
    "trial runs , we found the vertical offsets determined from the full set of sample spectra follow a gaussian distribution , with standard deviation 0.20.4 pixel widths , depending on the source image .",
    "we accept this as the uncertainty in the vertical registration .        in order to form a data cube ,",
    "the pipeline must `` know '' where individual spectra are positioned on the focal plane , and furthermore , which points of those spectra correspond to a given wavelength .",
    "we rely on the global spectrograph focal plane solution described in   [ sec : globalsol ] to establish the image geometry for each epoch under consideration .",
    "one of the products of the calibration image fitting procedure is a text file tabulating the positions of all @xmath0 spectra alongside their corresponding microlens indices .",
    "this table , combined with the results of the registration algorithm (   [ sec : specreg ] ) and the maps of height and tilt parameters give all the information needed to organize the detector data for a given science image .",
    "the amplitude map produced during the global fit ( see figure  [ fig : param_maps ] ) also has an important role .",
    "it compliments the dewar lamp flat described in ",
    "[ sec : dewarflat ] by capturing the larger - scale variations in sensitivity across the field of view . by looking up the amplitude parameter associated with a given microlens , we can appropriately scale any detector samples from that spectrum to compensate for optical effects such as vignetting .      despite the numerous stages in the detector image processing ,",
    "some minor extraneous background structure persists into the processed focal plane image .",
    "this component , superimposed on the real signal , is caused by a combination of residual bias counts , scattered light within the instrument , and thermal contamination from outside the dewar ( unaccounted for in the dark subtraction ) . in the cube extraction routine , after loading an individual focal plane image , the pipeline forms a map of background count rates based on measurements between spectra .",
    "figure  [ fig : extraction ] shows the regions used to estimate the background count rate associated with a given microlens .",
    "the upper left box is situated so that its bottom row is matched with the @xmath149 m point ( rounded to the nearest row ) , and the bottom row of the lower right box is on level with @xmath150 m . for both background boxes ,",
    "the near side is spaced three columns from the rounded center of the spectrum .",
    "the pipeline takes the median of the sample of the pixels in both @xmath151 dark regions and stores this in a residual background map . after forming the background estimates for all microlenses ,",
    "the resulting map is smoothed with a box median filter and stored for use in the inner extraction loop .",
    "our cube extraction method is summarized in figure  [ fig : extraction ] . after forming the background map , the extraction routine loops through microlens indices @xmath95 and @xmath96 . for each microlens",
    ", we retrieve the parameters from the global spectrograph focal plane solution : position , height , tilt , and amplitude ( represented by the variables @xmath152 , @xmath153 , @xmath154 , and @xmath120 , respectively ) .",
    "an inner loop steps through 23 wavelength channels in 0.03 @xmath3 m increments between @xmath155 m and 1.76 @xmath3 m .",
    "we index these channels by integer values of @xmath57 ( @xmath59 ) , and determine the extraction target point for each cube element , or _ spaxel _",
    ", as follows ( cf .",
    "equation set  [ eqn : specxyparam ] ) :    @xmath156    where @xmath140 and @xmath141 are the crude horizontal and vertical offsets , and @xmath138 and @xmath157 are the fine horizontal and vertical offset indices determined by the registration algorithm (   [ sec : specreg ] ) for the current reduced spectrograph image , @xmath126 .",
    "we use a hat symbol to designate the same coordinates rounded to the nearest pixel center : @xmath158 .",
    "the spaxel for each microlens and wavelength combination is based on the weighted sum over a @xmath159 detector pixel square centered on @xmath158 :    @xmath160    the weights @xmath161 applied to the detector samples are based on the psf model , downsampled and truncated to the @xmath159 pixel extraction box as follows :    @xmath162    defined for @xmath163 .",
    "the formulas for the @xmath4- and @xmath5-band psfs , @xmath164 and @xmath165 , as well as the intra - pixel response , @xmath21 , can be found in   [ sec : psfmodel ] .",
    "the integers @xmath166 and @xmath167 encode the offsets of the extraction target point from the extraction box center :    @xmath168    the resulting indices take on integer values in the range @xmath169 ( corresponding to offsets up to @xmath170 of a pixel width in each direction when @xmath60 ) .",
    "lastly , the @xmath171 factor in front of each weight formula compensates for the effect that the offset between the psf center and the extraction box center has on the sum of products in equation  [ eqn : weightedsum ] .",
    "the need for this can be qualitatively understood by the fact that the overall flux in a @xmath159 pixel sample of the psf decreases when the peak is offset from the center .",
    "the @xmath171 correction factor varies from unity at perfect alignment up to 1.09 in the worst case for extreme offsets .      for a given microlens ,",
    "the separation between the extraction target points of the first and last channels  corresponding to @xmath172m  is typically about 24 detector pixels .",
    "since we use @xmath159 pixel boxes to extract a signal for each of 23 channels spanning that length , the footprints of adjacent channels necessarily overlap . we have examined the effect of this by extracting data cubes directly from the laser calibration images ( discussed in   [ sec : psfmodel ] ) . from these cubes , we compared the mean flux in neighboring cube channels .",
    "the results , plotted in figure  [ fig : laserresponse ] for 1.25 @xmath3 m and 1.58 @xmath3 m emission , reveal the effective filter shape of an individual data cube channel .",
    "the cube channel filters exhibit a full width half - maximum value of @xmath1 70 nm at both @xmath4 and @xmath5 band .",
    "knowledge of this profile is essential for comparisons between p1640 data and existing astronomical spectra .",
    "we can not simply bin a reference spectrum to the channel spacing ; we must also convolve it with the cube channel filter before comparing it to data cube measurements .",
    "suppose an object appears in a data cube , and we carry out channel - wise photometry to find a spectrum @xmath173 , @xmath59 .",
    "to compare this meaningfully to an established spectrum , @xmath174 , acquired by some other instrument with wavelength bin width @xmath175 , requires two steps .",
    "first , we re - bin @xmath174 to the cube channel interval , 0.03 @xmath3 m , to form an intermediate - resolution spectrum @xmath176 :    @xmath177    we then convolve the intermediate - resolution spectrum @xmath178 with the cube channel filters @xmath179 and @xmath180 .",
    "the filter functions are defined to follow the profiles shown in figure  [ fig : laserresponse ] for @xmath181 ( so that @xmath182 corresponds to the central peak of the filter ) , and are zero - valued outside that range .",
    "@xmath183    the ratios in front of each convolution sum compensate for the effect of the spectrograph passband edges on the filtering ( they are unity when @xmath57 is at least three channels from both passband edges ) . the resulting spectrum , @xmath184 ,",
    "is smoothed to the same resolution as the cube - derived spectrum @xmath173 .",
    "if @xmath185 has been corrected for the p1640 spectral response , then the two spectra can be directly compared , apart from some scale factor . if on the other hand , @xmath173 is a `` raw '' cube spectrum , with undetermined spectral calibration , and @xmath184 refers to the same source , then it can be used to correct @xmath173and , in general , any p1640 data cube , as described next .",
    "we characterize the wavelength - dependent sensitivity of p1640 , or spectral response function , by comparing the `` raw '' data cube count values of an unocculted reference star ( observed off - axis from the coronagraph focal plane mask ) with its established near - infrared spectrum . in practice",
    ", we have chosen stars with spectra archived in the nasa infrared telescope facility ( irtf ) spectral library to calibrate our response  @xcite .",
    "the spectral response function is determined by dividing the re - binned , smoothed reference spectrum ( @xmath184 , in the notation above ) by the spectrum of the same source derived from a p1640 data cube .",
    "we measure the signal of the observed reference star by carrying out aperture photometry on each channel image making up the data cube , enclosing the third airy ring . to capture the wavelength - dependent scaling of the coronagraph psf , we linearly increased the photometric aperture radius from 13 to 20 spaxels across the passband .",
    "the resulting response curve for one calibration star , hd 75555 ( @xmath186 ; spectral type f5.5iii - iv ) , is shown in figure  [ fig : response ] .",
    "the response curve shows the expected roll - off at the edges of the operating range due to telluric water absorption features .",
    "the valley centered near @xmath187 m is likewise due to water absorption between @xmath4 and @xmath5 band .",
    "the overall climb in the response towards longer wavelengths is caused by the wavelength - dependence of three effects in combination : the energy per photon as dictated by the plank relation , @xmath188 ; detector quantum efficiency ; and the transmission of the blocking filter at the ifu entrace .",
    "we normalize the spectral response function to its mean value before storing it for general application to data cubes .",
    "the cube extraction pipeline loads one of these mean - normalized spectral response functions into memory before beginning the cube extraction routine .",
    "if the appropriate switch is set by the user , the pipeline will divide the spaxel values in each channel image by the corresponding response function value .",
    "uncertainty in the global spectrograph focal plane solution , the image registration , and the weighting function combine to contribute a pseudo - random error to each cube point , at a level of @xmath1 5% of the spaxel value .",
    "we extracted cubes from the moon calibration images to estimate the magnitude of this error .",
    "since spatial amplitude variations are compensated for during extraction , ideally any given spatial cross - section of a cube extracted from a calibration image would appear flat .",
    "instead , we observe a standard deviation of 3% , with some variation between channels and areas of the image .",
    "there are also systematic errors caused by light from adjacent microlenses overlapping on the focal plane , which we refer to as cross - talk .",
    "the horizontal space between spectra on the focal plane is 3.3 detector pixels , and yet we know from the spectrograph psf model ( figure  [ fig : psf_cross_sections ] ) that about 10% of the downsampled psf flux falls outside the central three columns . as a result , a small fraction of light from one microlens is inevitably counted during the extraction of a neighboring spectrum . consider the spectrograph image cutout shown in figure  [ fig : extraction ] .",
    "for each channel of a given spectrum , you can attribute the dominant contamination to a different channel belonging to the neighboring spectrum positioned either above or below along the microlens column .",
    "we know from examining the laser calibration data cubes that the upper limit of the flux incorrectly extracted into a cube point is @xmath1 5% of the cube value in a neighboring spectrum . in other words ,",
    "suppose @xmath189 is the cube point whose contamination we are trying to assess .",
    "based on our spectrum model , we can determine that some channel @xmath190 of microlens @xmath191 is the dominant contamination source for channel @xmath192 of microlens @xmath193 .",
    "therefore , we estimate the cross - talk error @xmath194 , added in quadrature with the uncertainty described earlier . using a table of established cross - talk channel pairs",
    ", we can repeat this error estimate for each channel of a spectrum of interest .",
    "the spectral response function plotted in figure  [ fig : response ] and the source spectrum plotted in figure  [ fig : titan ] reflect this analysis .",
    "the pcxp stores the reduced data output in fits files , and organizes them in a directory tree by object and date .",
    "three channels from an example cube based on an occulted star observation are displayed in figure  [ fig : examplecube ] .",
    "in addition to the normal cube extraction described in   [ sec : cubeextraction ] , there are several other products the pipeline derives from the raw data . from the brightest stars ,",
    "there is enough signal recorded in a single 7.7 second read to form a cube without using the full exposure time .",
    "one option of the pipeline takes advantage of this , checking if the @xmath195-band magnitude is less than 2.0 , and if so then making cubes from each pair of consecutive reads in the ndr sequence .",
    "the resulting `` read - wise '' cubes have a speckle pattern resolved to a higher time resolution , which may eventually be exploited to improve speckle suppression . at the opposite time scale ,",
    "the pipeline can form cubes from the mean of all spectrograph images acquired on the same data of a given target .",
    "the pipeline also forms `` collapsed '' images by summing all the channel images of a cube , as well as the subsets of channels corresponding to the @xmath4 and @xmath5 bands .",
    "to demonstrate the efficacy of our data extraction and calibration procedures , we apply them here to an observation of saturn s moon titan acquired on 2009 march 15 . after locking the ao system on titan ,",
    "its image was positioned off - axis from the focal plane mask so that no part of the @xmath196 disk was occulted by the coronagraph .",
    "we used the pipeline to generate a data cube from a single 138 s exposure , calibrating the relative channel fluxes with the response function shown in figure  [ fig : response ] .",
    "next , we averaged 1900 spaxels inside the resolved disk of titan .",
    "after normalizing the disk - averaged spectrum to the mean channel flux , we compared it to unpublished data obtained by emily schaller two days earlier using the spex near - infrared spectrograph  @xcite at the nasa infrared telescope facility ( irtf ) . following the procedure in  ",
    "[ sec : speccal ] , we re - binned and smoothed the irtf spectrum to match the resolution of the data cube ( equations  [ eqn : rebinspec][eqn : convspec ] ) .",
    "the resulting spectra are plotted in figure  [ fig : titan ] .",
    "the near - infrared spectrum of the moon is marked by a series of broad ch@xmath197 absorption troughs  @xcite .",
    "at the two albedo peaks in our passband , 1.3@xmath198 m and 1.6@xmath198 m , titan s atmospheric opacity is low enough for the direct reflection of sunlight off the water ice surface to constitute the observed flux , rather than diffuse scattering in its stratospheric haze  @xcite .",
    "we expect the disk - averaged spectra acquired on these two dates to be similar .",
    "as titan rotates over a 16-day period , in synchronicity with its orbit around saturn , the near - infrared albedo observed from earth ( through the 1.3@xmath198 m and 1.6@xmath198 m methane `` windows '' ) varies in a cycle with an amplitude on the order of 10% .",
    "this variation is caused by a change in surface features between the leading and trailing hemispheres  @xcite . however , despite the 45 degree rotation of titan with respect to earth between the irtf and p1640 observations , previous monitoring by several investigators indicates no significant albedo change between our specific pair of planetographic longitudes ( @xmath199 and @xmath200 )  @xcite .",
    "furthermore , long - term monitoring of titan s albedo only occasionally reveals deviations from predicted reflectivity due to transient cloud features  ( e.g. * ? ? ?",
    "* ; * ? ? ?",
    ". the anticipated resemblance of the two spectra is confirmed in figure  [ fig : titan ] : the average absolute difference between the irtf and p1640 titan data over the 19 channels used in figure  [ fig : titan ] is 7% of the mean flux , and most flux points agree within the error bars of the p1640 data .",
    "the only channel flux showing significant disparity with the irtf data , centered at 1.13 @xmath3 m , is located near the edge of a telluric water absorption trough , and therefore is more susceptible to calibration errors than most channels on the plot . for examples of m dwarf stellar spectra that have been measured from p1640 data cubes ,",
    "see  @xcite and  @xcite .",
    "starting from the economic constraint of limited detector area , the design of any integral field spectrograph must reach compromises between the competing parameters of spatial resolution , field of view , spectral resolution , and spectral range . for project 1640 ,",
    "the need to nyquist - sample the starlight speckle pattern inside the angular extent of the adaptive optics system `` control radius '' largely determined the balance of these tradeoffs .",
    "the other major factor was the overarching science goal of distinguishing astrophysically interesting features in the spectral energy distributions of young giant exoplanet atmospheres . based on these considerations ,",
    "the p1640 collaboration concluded on an ifu design that strongly favored a high density of spatial elements over spectral resolution , to a greater extreme than previous microlens - based integral field spectrographs .",
    "for example , the broadband mode of the tiger ifu had 572 spatial elements dispersed at spectral resolution @xmath201 , and the broadband mode of the osiris ifu has 1024 spatial elements dispersed at @xmath202  @xcite .",
    "p1640 , by comparison , has 38,000 spatial elements with @xmath203 , corresponding to over a factor of 30 increase in spatial elements , and a similarly substantial reduction in spectral resolution .",
    "only two other ifus will join p1640 in this operating regime in the next year : gpi and vlt - sphere  both designed for exoplanet imaging .",
    "since the properties of p1640 data are unusual even in the context of preceding ifus , the instrument commissioning has required development of novel extraction and calibration approaches .",
    "consider that each detector pixel width spans approximately 27.5 nm in spectral dispersion4% of the instrument passband  and that the physical length of an individual microlens spectrum s footprint is merely 0.5 mm at the focal plane .",
    "as such , great care has been required to accurately map the spectrograph focal plane data , in a manner that is resilient to subtle long - term changes in optical alignment .",
    "we described an answer to this problem in   [ sec : focplmodel ] , using a hierarchical fitting procedure to build a comprehensive , epoch - specific model of the full spectrograph focal plane .",
    "the last obstacle to securing the layout of the data , instrument flexure , must be dealt with individually for each exposure . therefore , unlike the case of building the spectrograph focal plane model , we register each science spectrograph image `` on the fly '' inside the data pipeline , as explained in   [ sec : specreg ] .",
    "the relatively long execution time required to build the spectrograph focal plane solution ( @xmath1 12 hours on a single high - performance workstation ) means that it is sometimes necessary to rely on an outdated solution to extract data",
    ". such will be the case , for example , during the first night of an observing run when the calibration moon / sky image has not yet been acquired and fit .",
    "we know from the geometric evolution illustrated in figure  [ fig : distortion ] that consequent errors in the positions of the spectra , along with other properties , will inevitably degrade the quality of the cube",
    ". however , for a preliminary inspection of data , and to check on instrument performance , the result will usually be acceptable . recall that the spectrograph image registration uses a region of the image with the strongest signal to align the model .",
    "therefore , under circumstances where the solution is old , the extraction will still tend to be fairly accurate near the brightest region of the image , but will progressively worsen towards the outskirts of the focal plane .",
    "the main advantages of our weighted sum approach to ifu spectrum extraction , described in ",
    "[ sec : weightedsum ] , are simplicity and speed .",
    "our reasoning behind using the spectrograph psf itself to shape the weighting function is that it mimics the cross - dispersion profile of the spectrum . this way , along the middle horizontal row of the @xmath159 extraction box , we weight the detector samples by an estimate of their relative intensity ( see figure  [ fig : extraction ] for an example ) .",
    "@xcite originally devised this strategy for extracting coarsely - sampled ccd spectra .",
    "he demonstrated that matching the weights to the expected cross - dispersion profile optimizes the fidelity of the extraction in the case where read noise is prevalent .",
    "this makes sense intuitively because we want detector samples with high count rates to have more influence than weak , noisy ones .",
    "unlike the case of horne s spectrograph , however , we are dealing with many closely packed spectra , and so we are forced to truncate our weighting area to a region smaller than the actual extent of the psf .",
    "we attempt to account for this in the weighting formula in equation  [ eqn : weights ] .",
    "since this correction depends not just on the shape of the psf but also the target spectrum , it is necessarily only an estimate , and can contribute errors on the order of a few percent to the spaxel value .    as compared to the cross - dispersion axis , for the dispersion axis there is more freedom in the choice of extraction weights .",
    "the tradeoffs here are signal - to - noise ratio per channel versus spectral resolution . ultimately , for any weighted sum approach",
    ", the spectral resolution is limited by the width of the monochromatic ifu response along the dispersion axis .",
    "the spectrograph psf fitting result plotted in the right - hand panel of figure  [ fig : psf_cross_sections ] shows this is about 2 detector pixels for p1640 , which translates to @xmath1 50 nm in the dispersion direction . for simplicity ,",
    "we chose to remain with the psf again to set the weights ; the resulting cube spectra have a resolution of about 70 nm ( @xmath204 ) . in the future",
    ", it would be worthwhile to experiment with a hybrid weighting function that combines the cross - dispersion profile of the psf with a different vertical profile , to investigate how much the spectral resolution can be improved .",
    "as one example of an alternative ,  @xcite propose extracting spectra from the gpi ifu by summing strictly along a single row / column of pixels in the cross - dispersion direction .",
    "another possible improvement to our data pipeline is a completely different extraction approach based on deconvolution or fitting .",
    "a well - designed fitting algorithm might disentangle the flux contributions of wavelengths with overlapping footprints .",
    "we have done a few experiments in this direction  for example , we applied the same mpfit - based algorithm we used to model the microlens spectra in the moon / sky calibration image (   [ sec : spectrummodel ] ) to a science image .",
    "the results were of significantly poorer quality than our normal data cubes , partly as a consequence of not having the luxury to average the fit spectra over many microlenses , as we do with calibration images . in another program ,",
    "two of our co - authors created a program that fits each spectrum cutout as a train of scaled psfs , each one representing a different channel .",
    "while its implementation is not complete , this method shows promise of forming data cubes with slightly higher spectral resolution than the existing extraction .",
    "since any fitting approach is inherently much slower than a weighted sum translation , one can imagine two cube extraction algorithms co - existing for different purposes : one as an offline procedure reserved for images of the greatest interest , and the other program applied to all p1640 data .",
    "we have developed a collection of algorithms to reduce the data acquired by p1640 , a coronagraphic integral field spectrograph designed for high contrast imaging .",
    "our aim has been to describe our data pipeline software in enough detail that upcoming microlens - based imaging spectrograph projects can take advantage of our experience in treating closely packed , coarsely sampled spectra .",
    "an essential element of our approach is an empirical model of the spectrograph focal plane image , based on calibration exposures in which the entire microlens array is illuminated , in turn , by broadband and monochromatic light . to derive a solution specific to each observation epoch",
    ", we fit a set of parameters describing each microlens spectrum ( position , tilt , height , and overall signal amplitude ) .",
    "we use the resulting table of solved parameters to determine the extraction location on the focal plane for any given combination of microlens and wavelength , and hence build the data cube .",
    "we implement the cube extraction with a weighted sum that optimizes the signal - to - noise ratio by mimicking the expected cross - dispersion profile , as constrained by the sub - pixel spectrograph image registration .",
    "sources of error in the final data cube are cross - talk between adjacent microlens spectra , uncertainty in the spectrograph focal plane model , uncertainty in sub - pixel registration , and uncertainty in the determination of extraction weights .",
    "nevertheless , based on an observation of saturn s moon titan , we have demonstrated our ability to retrieve strong - featured near - infrared spectra to @xmath1 5% accuracy . as our methods for handling this new form of data evolve , we expect p1640 to continue its pioneering role in high contrast astronomy .",
    "thanks are due to anand sivaramakrishnan , emily rice , michael mcelwain , james gunn , david zurek , and charles beichman for helpful discussions .",
    "we also thank emily schaller for providing us with unpublished spex / irtf titan data to serve as a reference spectrum in figure  [ fig : titan ] .",
    "project 1640 is funded by national science foundation grants ast-0520822 , ast-0804417 , and ast-0908484 .",
    "part of this work was performed under a contract with the california institute of technology ( caltech ) funded by nasa through the sagan fellowship program .",
    "the members of the project 1640 team are also grateful for support from the cordelia corporation , hilary and ethel lipsitz , the vincent astor fund , judy vale , andrew goodwin , and an anonymous donor ."
  ],
  "abstract_text": [
    "<S> project 1640 is a high contrast near - infrared instrument probing the vicinities of nearby stars through the unique combination of an integral field spectrograph with a lyot coronagraph and a high - order adaptive optics system . </S>",
    "<S> the extraordinary data reduction demands , similar those which several new exoplanet imaging instruments will face in the near future , have been met by the novel software algorithms described herein . </S>",
    "<S> the project 1640 data cube extraction pipeline ( pcxp ) automates the translation of @xmath0 closely packed , coarsely sampled spectra to a data cube . </S>",
    "<S> we implement a robust empirical model of the spectrograph focal plane geometry to register the detector image at sub - pixel precision , and map the cube extraction . </S>",
    "<S> we demonstrate our ability to accurately retrieve source spectra based on an observation of saturn s moon titan . </S>"
  ]
}