{
  "article_text": [
    "since its introduction more than two decades ago by lucy ( 1977 ) and gingold & monaghan ( 1977 ) , smoothed - particle hydrodynamics ( sph ) has become one of the standard techniques for modelling astrophysical fluid flow ( e.g. evrard 1988 ; hernquist & katz 1989 , hereafter hk89 ; thomas & couchman 1992 ; steinmetz & mller 1993 ; couchman , thomas & pearce 1995 , hereafter ctp95 ; shapiro 1996 ) .",
    "sph is fully lagrangian , with the particles themselves being the framework on which the fluid equations are solved , and so there is no grid to constrain the dynamic range or geometry of the system being modelled .",
    "this is of particular importance for phenomena involving the growth of gravitational fluctuations , such as cosmological structure formation ( bertschinger 1998 ) and star formation ( bhattal 1998 ) , and in an adaptive form ( wood 1981 ; nelson & papaloizou 1994 ) the sph algorithm will follow the wide range of densities encountered without difficulty .",
    "in contrast , computational demands severely restrict the dynamic range of eulerian finite - difference methods ( e.g. the piecewise - parabolic method of collela & woodward 1984 ) , and to date the best three - dimensional eulerian simulations of galaxy formation have a gas resolution of @xmath0 kpc ( blanton 1999 ) , although adaptive mesh refinement ( amr ) techniques promise to greatly enhance the fixed - grid approach .",
    "sph can be easily integrated with a range of @xmath1-body gravity solvers such as the tree algorithm used by hk89 and the adaptive particle - particle , particle - mesh ( ap@xmath2 m ) algorithm of couchman ( 1991 )",
    ".    however , sph is not without its problems .",
    "the need for an artificial viscosity means that sph resolves shocks poorly in comparison with finite - difference methods .",
    "pairwise artificial viscosities ( monaghan & gingold 1983 ) generally give the sharpest resolution of shocks , but also introduce a large shear viscosity unless correction terms are used ( balsara 1995 ) . there is some concern that these terms further degrade the shock capturing ability of sph ( navarro & steinmetz 1997 ; thacker 1998 , hereafter t98 ) . while it is possible to add a _ physical _ viscosity to sph and solve the navier - stokes equations directly ( e.g. flebbe 1994 ) , the relatively simple sph interpolation method is quite sensitive to particle disorder and tends to give large errors in the higher - order dissipative terms .",
    "boundary conditions are also difficult to implement in sph and do not sit naturally with the method .",
    "generally boundaries are either periodic or situated far from the region of interest , and sph is unsuitable for simulations in which complex boundary conditions are of critical importance .",
    "standard implementations of sph also have a limited ability to resolve steep density gradients , and a number of numerical problems can occur when particles are close to , but not physically part of , a region of higher density .",
    "these arise because the usual formulation of sph assumes that the density gradient across the smoothing kernel of each particle is small . however , this is not true in many situations in which sph is commonly used . in simulations of galaxy formation ,",
    "for example , thermal instability causes cold , dense clumps to form within halos of hot gas , and density contrasts of several orders of magnitude can occur within the typical smoothing length of the halo gas .",
    "current implementations of sph will overestimate the density of the halo gas , leading to the gas cooling excessively and accreting on to the cold clump ( t98 ; pearce 1999 ) .",
    "tittley , couchman and pearce ( 1999 , hereafter tcp99 ) have also shown that the drag exerted on these protogalaxies by the intracluster medium can be seriously overestimated .",
    "these problems are thought to contribute to the overmerging commonly seen in simulations of structure formation including gas ( frenk 1996 ) .",
    "we wish to extend the method to cope with these problems , along with multiphase fluids , such as the intracluster medium and cooling flows , which consist of an emulsion of discrete phases in which there is no correlation between the density of neighbouring particles .",
    "we should emphasise however that we are _ not _ seeking to model homogeneously mixed materials with different equations of state , such as dust and aerosols ( monaghan 1997 ) .",
    "we make two changes to the standard implementation of sph .",
    "firstly , particles no longer have to try and maintain a fixed number of neighbours , as is required by the algorithm of hk89 , and instead the smoothing length is adjusted to keep a density - weighted quantity constant ( see section  [ sec : smooth2 ] ) .",
    "this prevents the smoothing length of low density particles from decreasing as they approach a high density region .",
    "secondly we make the assumption that pressure , not density , is constant across the smoothing kernel .",
    "we then summate the local pressure at each particle and calculate the local density from the equation of state .",
    "this is a reasonable approach to take when the cooling time of the gas is greater than the local dynamic time , where a local pressure equilibrium can be expected even when the local density gradient is steep .",
    "it will _ not _ be true in the presence of shocks ( although neither is the assumption that density is smoothly varying ) . as we will see in sections",
    "[ sec : shocktube ] and  [ sec : adiabatic ] , however , there is no evidence that the shock capturing ability of sph is degraded .",
    "the layout of the paper is as follows .",
    "in section  [ sec : method2 ] we detail our new implementation of sph . in section",
    "[ sec : test2 ] we present the results of a number of tests of the new method , and compare the performance with results produced using the sph implementations of ctp95 and t98 .",
    "this is followed in section  [ sec : disconc ] by a discussion of our results .",
    "in sph the fluid is represented by particles of known mass , @xmath3 , and specific energy , @xmath4 .",
    "other properties must be inferred by averaging over a smoothing sphere that typically extends to enclose a fixed number , @xmath5 , of particles . for a continuous distribution ,",
    "the average value of some quantity @xmath6 at the location of particle @xmath7 would be @xmath8 where @xmath9 is the smoothing kernel . in sph the integral",
    "is replaced by a sum : @xmath10 that extends over all particles , @xmath11 , within the smoothing sphere .",
    "@xmath12 is the density of particle @xmath11 and so @xmath13 is its volume .",
    "here @xmath14 where @xmath15 is the separation of particles @xmath7 and @xmath11 , @xmath16 , and @xmath17 is the smoothing length .",
    "there are several possible forms for @xmath9 . throughout this paper",
    ", we use the standard form described in thomas & couchman ( 1992 ) .",
    "the choice of @xmath17 determines the size of the region over which the density is to be averaged .",
    "many authors take @xmath17 to be a symmetric function ( for example the harmonic average ) of @xmath18 and @xmath19 ( see t99 and references therein ) .",
    "we prefer to set @xmath20 .",
    "this has the advantages that we know in advance exactly how far we have to search and always have the same number of neighbours within the smoothing region .",
    "the integral of the smoothing kernel over all space is unity , which translates to the condition @xmath21 although this will only be true in a statistical sense .",
    "equation  [ eq : adef ] seems to require the value of @xmath12 , which is not known in advance .",
    "however , it is possible to circumvent this by formulating sph such that @xmath6 is always a multiple of density and a known quantity .",
    "taking @xmath22 gives the standard sph estimate for the density in the neighbourhood of a particle @xmath23    where expressions arise involving derivatives , we use the divergence theorem to transfer the derivative onto the smoothing kernel as follows : @xmath24 @xmath25      in multiphase sph , it is important to distinguish between the density of a particle , @xmath26 , and the mean density in the neighbourhood of a particle , @xmath27 , defined by equation  [ eq : dmean ] . the pressure of the gas is expected to be a smooth quantity because ( excluding shocks ) the sound - crossing time is shorter than the flow time across the smoothing sphere . the density of individual particles , @xmath26 ,",
    "can therefore be determined from an estimate of the local pressure and the equation of state , @xmath28 the specific energy @xmath29 is related to the gas temperature @xmath30 by @xmath31 , where @xmath32 is boltzmann s constant , @xmath33 is the mass of the hydrogen atom and @xmath34 is the relative molecular mass .",
    "the sph estimate of the pressure is @xmath35 and the density of a particle can therefore be written @xmath36 variations in @xmath4 can cause large variations in density between neighbouring particles , whereas equation  [ eq : dmean ] , being an average , varies only slightly between neighbours .",
    "note that a cold , high - density clump of particles will contribute a lot of terms to equation  [ eq : density ] , but each of these will be given a low weight due to the presence of the @xmath37 term .",
    "the consistency condition , equation  [ eq : consistency ] , becomes @xmath38 which will be true if the pressure is slowly - varying , as we have assumed .",
    "the sph smoothing length is usually defined in terms of the radius of a sphere , centred on the particle in question , that encloses a fixed number of neighbours .",
    "one can either search for such a radius on each time - step , a time - consuming process , or allow the number of neighbours to vary and accept an estimate based on the number of neighbours found on the previous step : @xmath39,\\ ] ] where @xmath40 is the actual number of neighbours and @xmath5 is the desired number ( hk89 ) .",
    "@xmath41 is a convergence parameter : for a uniform distribution , choosing @xmath42 returns the correct value of @xmath18 on the next step .",
    "where large density contrasts are present , however , @xmath41 must be reduced to avoid overshooting and convergence is much slower .",
    "we use a convergence parameter @xmath43 and @xmath44 .    for the extreme density contrasts",
    "we envisage , t98 have shown that @xmath40 can oscillate between values which are alternately too low and too high .",
    "they solve this problem both by giving lower weight to particles at the extreme edge of the smoothing sphere , and by the introduction of a more sophisticated convergence algorithm . in this paper , we suggest a simpler approach that uses a neighbour count weighted as follows : @xmath45 where @xmath46 is the mean density at particle @xmath7 and the sum extends over all neighbours within the smoothing sphere .",
    "note that :    1 .   for a uniform distribution",
    "in which @xmath47 , then @xmath48 and @xmath40 is simply equal to the number of neighbours .",
    "2 .   particles do not notice neighbours with a much greater than average density ( @xmath49 for @xmath50 ) .",
    "this prevents the common instability whereby changing the radius of the smoothing sphere so as to include or exclude a high - density clump can dramatically change the number count .",
    "3 .   neighbours with a lower than average density count at most double ( @xmath51 for @xmath52 ) .",
    "while this could lead to an isolated cold particle in a hot medium having fewer neighbours than is desirable , such a situation is unlikely to arise in practice and @xmath53 could be limited to a maximum value of unity if desired .      in the absence of artificial viscosity , heating and radiative cooling ,",
    "the equation of motion for a parcel of gas is simply @xmath54 in the same spirit as above , we require an estimate of @xmath55 that does not depend upon the number density of particles .",
    "this is @xmath56 it is common practice to use the following identity @xmath57 to symmetrise the pressure force .",
    "this expression is not suitable here , both because we are envisaging abrupt changes in density ( so that @xmath58 is undefined ) and because the estimator for @xmath59 depends upon the density of the particles .",
    "equation  [ eq : gradpidentold ] is obtained using the general identity @xmath60 ( monaghan , 1992 ) and using @xmath61 gives an alternative identity that at first sight seems a little bizarre : @xmath62 this leads to the estimator for the force on particle @xmath7 , @xmath63,\\ ] ] where we have chosen to use @xmath64 in place of @xmath65 in the second term on the right hand side in order to make the force symmetric .",
    "this gives @xmath66 where @xmath67 the first set of terms in equation  [ eq : force2 ] is evaluated when calculating the sph properties for particle @xmath7 ; the second set is accumulated in stages when calculating the properties of the neighbours .",
    "note that the only change from the usual sph formalism is that @xmath4 and @xmath37 have exchanged places in equation  [ eq : force2temp ] .",
    "however , this change means that the force on particle @xmath7 is dependent only upon the local pressure gradient and not upon the density of its neighbours .",
    "conservation of energy is ensured by equating the heating to the @xmath68 work done : @xmath69 by making use of the identity @xmath70 where @xmath71 , this can be put into a variety of forms .",
    "for example , @xmath72 gives @xmath73 where @xmath74 the second term has vanished because it contains @xmath75 which is identically zero .",
    "using @xmath76 we obtain an alternative expression @xmath77 combining equations  [ eq : dedt2one ] and [ eq : dedt2two ] , we find that @xmath78 where @xmath79 is the pairwise force given in equation  [ eq : fij ] .",
    "any of equations  [ eq : dedt2one ] , [ eq : dedt2two ] , or [ eq : dedt2 ] ( or any similarly derived equation ) may be used as an estimator of @xmath80 ( and hence , by rearrangement of equation  [ eq : coe2 ] , for @xmath81 ) . indeed ,",
    "if density is eliminated by substituting equation  [ eq : eos ] it is clear that the equations are identical , provided that our assumption that @xmath82 and @xmath83 are approximately equal is valid .",
    "overall energy conservation is ensured as all three expressions give @xmath84 under most conditions the performance of the three equations is indistinguishable , and standard tests of sph can not tell them apart .",
    "however , when large temperature variations are present the double - sided form can lead to a large scatter in particle entropy .",
    "we use equation  [ eq : dedt2one ] here .      in the presence of shocks , we require a mechanism to convert relative motion into heat . in sph , this is achieved via an artificial pressure , @xmath85 , that is added to the usual one in regions of convergent flow .",
    "this has the effect of replacing @xmath86 by @xmath87 in equations  [ eq : eom2 ] and [ eq : coe2 ] . in the current method",
    ", we replace @xmath79 in equations  [ eq : force2 ] and [ eq : dedt2two ] with @xmath88 , where @xmath89 ( c.f . monaghan & gingold 1983 ) . here",
    "the pairwise mach number @xmath90 the particle separation , @xmath91 , and the sound speed @xmath92 where @xmath93 we adopt the values @xmath42 , @xmath94 .",
    "the use of @xmath95 in equation  [ eq : mach ] rather than @xmath96 helps to limit the degree to which cold particles shock against dense clumps .",
    "in addition , a shear - correcting term ( balsara 1995 ) can be applied to limit the damping of shear flows . following steinmetz ( 1996 ) we use @xmath97 where @xmath98 for compressional flows @xmath32 = 1 and @xmath99",
    "is unchanged , while in shearing flows @xmath100 and the artificial viscosity vanishes .",
    "only the cosmological galaxy formation test described in section  [ sec : cosmic ] uses this correction term .      in the presence of artificial viscosity and cooling ,",
    "the equation of energy conservation becomes @xmath101 where @xmath102 is the emissivity ( the emission rate per unit volume ) .",
    "the cooling function is interpolated from sutherland & dopita ( 1993 ) . to minimise problems of cooling during shock - heating ( see hutchings & thomas 2000 ) ,",
    "we allow the gas to cool only at the end of a time - step after the artificial viscosity term has been applied .",
    "the cooling is assumed to occur at constant density ( the time - step ensures that this condition is approximately satisfied ) , as described in thomas & couchman ( 1992 ) .",
    "the tests discussed in the following sections were carried out using hydra ( couchman , thomas and pearce , 1995 ) , an ap@xmath2m+sph code modified to use the sph method detailed in this paper .",
    "the simulations were performed on single - processor sun and intel workstations .",
    "+      a standard test of gas dynamical codes is the sod shock ( sod 1978 ) , which has been applied to sph by many authors ( e.g. monaghan & gingold 1983 ; rasio & shapiro 1991 ; t98 ) .",
    "analytic results are given by hawley , smarr & wilson ( 1984 ) and rasio & shapiro ( 1991 ) .",
    "this test is often carried out in one dimension , but this does not properly test particle interpenetration ; we perform a three dimensional test , with the normal cubical simulation volume altered to match the geometry of a shock tube .",
    "dimensions are @xmath103 in code units and all boundaries are periodic .    in a sod shock",
    "two regions of gas with different densities are brought into contact , resulting in a shock wave propagating into the low - density gas and a rarefaction wave propagating into the high density gas . between these two regions",
    "is a contact discontinuity , where the pressure is constant but the density jumps .",
    "following t98 we use the initial conditions @xmath104 giving a shock mach number @xmath105 .",
    "both regions are allowed to evolve at constant temperature before being brought into contact , to allow the gas to relax to a physically realistic initial state .",
    "a total of 7343 equal mass particles are used .",
    "thirty timesteps are required to reach the state shown in figure  [ fig : sodshock1 ] , by which time the shock front has moved around 13 code units to the right . both the shock and the contact discontinuity",
    "are broadened over a range @xmath106 .",
    "the results are in good agreement with the analytic solutions , although in common with other implementations of sph the gradient of the rarefaction wave is too shallow .",
    "flow is reasonably smooth , and there is no post - shock ringing .",
    "figure  [ fig : sodcompare ] compares the results from our code with those of t98 and ctp95 .",
    "there is very little difference between the three implementations , although the ctp95 implementation produces a broader shock than the other two codes .",
    "this is due to the choice of artificial viscosity ",
    "ctp95 uses an artificial viscosity based on the divergence of the local velocity field , which is shown in t98 to be worse at shock capturing than the pairwise artificial viscosity used in t98 and our code .",
    "all three implementations model the rarefaction wave similarly , as viscous terms do not apply in expanding regions .    with @xmath107",
    ", this test represents a fairly weak shock .",
    "a strong adiabatic shock presents a more demanding test , as the pressure jump across the shock , and hence the mach number , are infinite . in this case",
    "the jump conditions are @xmath108 although in our code we require particles to have a small minimum temperature to prevent numerical divergences in equation  [ eq : density ] , leading to @xmath109 being slightly greater than zero and the mach number remaining large but finite .",
    "the density profile across the shock is shown in figure  [ fig : addn ] .",
    "the new code is clearly capable of handling such shocks , and although some post - shock oscillation is visible it is not noticeably different from the results obtained from the other codes . as the performance of our code is so close to that of t98",
    "there is no evidence from shock - tube experiments that our assumption that pressure is smoothly varying has degraded the shock - capturing ability of the code .",
    "one of the primary requirements for any hydrodynamics code that includes gravity is the ability to correctly follow the shock - heating of cold gas during gravitational collapse .",
    "a common test problem for sph codes is the collapse of an initially isothermal sphere of gas ( evrard 1988 ; hk89 ; steinmetz & mller 1993 ; t98 ) , with an initial density profile @xmath110 to create this profile we translate particles radially from a uniform grid , which gives a lower sampling error than a random distribution of particles .",
    "initial particle temperatures are set to the code minimum .",
    "a total of 8184 particles are used , with the gravitational softening set as 0.02r .",
    "following evrard ( 1988 ) results are presented in normalised units , with density , internal energy , velocity , pressure and time normalised by @xmath111 , @xmath112 , @xmath113 , @xmath114 and @xmath115 respectively .",
    "the gas in the sphere initially has negligible thermal energy , and collapses due to the lack of pressure support . during the collapse",
    "a central bounce occurs , causing a shock wave to propagate outwards through the gas , and the sphere should eventually reach virial equilibrium , with the ratio of thermal and gravitational energy approaching a value of @xmath116 .",
    "figure  [ fig : evenergy ] compares the evolution of the thermal , kinetic , total and gravitational potential energies during the collapse for the multiphase and standard methods .",
    "the performance of the two codes is very similar throughout the bounce and subsequent expansion , with only relatively minor differences apparent after time @xmath117 .",
    "profiles of the system at time @xmath118 are shown in figure  [ fig : evcollapse ] , at which time the shock is located at @xmath119 .",
    "the temperature jump across the shock is well modelled by both codes , and the post - shock conditions are very similar .",
    "however , the density profile across the shock produced by the multiphase code is noticeably shallower .",
    "this is a result of the overestimation of the local pressure due to the steep pressure gradient in the shock , and is analogous to the smoothing of the density profile in the presence of steep density gradients that affects the standard implementation of sph .",
    "this error is unimportant in the force calculations , which are dominated by the artificial viscosity during shocks , but may be significant when radiative cooling is implemented , as it leads to to excess cooling in the shock .    in such circumstances it may be preferable to use the standard sph estimate of the density @xmath46 for calculating the emissivity in regions where the local pressure gradient is steep .",
    "this switch can be implemented easily using either a pairwise condition based on the pressure of particles @xmath7 and @xmath11 or an sph estimation of the local pressure gradient .",
    "both methods effectively restrict the use of @xmath46 to the vicinity of the shock .",
    "when this approach is used , the density profile across the shock in figure  [ fig : evcollapse ] closely resembles that of the standard code , as would be expected , with the other profiles remaining unchanged .      in the standard formulation of sph arbitrarily steep density gradients are smoothed over a distance representative of the local value of @xmath120 .",
    "this is a cause for concern in simulations of cosmological structure formation , where cold dense clumps of gas  galaxies  form within diffuse halos of hotter gas and the density of halo gas can be overestimated by an order of magnitude or more in the steep density gradients around the largest galaxies .",
    "the smoothing of the density is a result of two effects .",
    "firstly , when equation  [ eq : dmean ] is used , @xmath121 for a fixed number of neighbours , and the estimated density becomes closely tied to the choice of smoothing length .",
    "secondly , most adaptive forms of sph update the smoothing length each timestep to try and keep the number of neighbouring particles approximately constant ( e.g. the method of hk89 ) .",
    "particles act as tracers of the underlying mass distribution , and a high - density region will therefore contain more particles than a region of lower density . when the hk89 algorithm is used , a particle close to a dense clump of gas will need to search little further than the edge of the dense region to find its required number of neighbours .",
    "if equation  [ eq : dmean ] and the hk89 algorithm are used together then the estimate of the density of the particle becomes strongly dependent on its separation from the clump .",
    "simply estimating the density using equation  [ eq : density ] is not enough to cure this problem .",
    "while the high density particles will be at low temperature in a region of pressure equilibrium , and will therefore contribute little to the estimate of the pressure , the size of the smoothing sphere , and hence weight given to neighbouring particles by the smoothing kernel @xmath65 , still depends on the distance to the clump .",
    "it is therefore necessary to weight the neighbour count using equation  [ eq : neigh ] , so that a low - density particle close to a dense clump will assign a very low weight to particles in the clump and will search for neighbours as if the clump was not present .",
    "the benefits of our approach can be seen in figure  [ fig : htest ] . here",
    "we plot the change in smoothing length and the sph estimate of the density as a hot gas particle moves past a cold , dense clump , grazing the surface of the clump at closest approach .",
    "the clump contains 420 particles , and has a central density 200 times that of the surrounding gas , with temperatures set so that the two phases are in pressure equilibrium . for the purposes of this test",
    "all inter - particle forces have been turned off , so that the particles move at constant velocity .",
    "initially , the density of the hot particle is @xmath122 and the smoothing length @xmath123 , both in code units .",
    "panel ( a ) shows the results from the standard implementation of sph , in which the density is estimated using equation  [ eq : dmean ] and the smoothing length is updated using the algorithm of hk89 .",
    "once the smoothing kernel of the hot particle overlaps the cold clump it finds many more than the desired number of neighbours and the hk89 algorithm starts to decrease the smoothing length in response , with @xmath120 reaching a minimum of @xmath124 shortly after closest approach ( this delay is due to the convergence parameter @xmath41 in equation  [ eq : hnew ] limiting the rate at which @xmath120 can change ) .",
    "there is a corresponding increase in the estimate of the density , which peaks slightly earlier at @xmath125 , an overestimate of some two orders of magnitude .",
    "these values of @xmath120 and @xmath126 are typical of cold particles on the surface of the clump , indicating that despite the large difference in temperature between the hot and cold particles the standard implementation of sph treats them identically .",
    "panel ( b ) shows the result of changing to the @xmath120-update method described in section  [ sec : hupdate ] , with the density still estimated using equation  [ eq : dmean ] .",
    "the peak density has only dropped slightly to @xmath127 , while the smoothing length remains fairly constant until shortly before the closest approach , when the density of the hot gas particle has increased to a point where particles in the clump become significantly weighted , leading to a decrease smoothing length .",
    "panel ( c ) shows the combination of the new estimate of the density , given by equation  [ eq : density ] , and the hk89 @xmath120-update algorithm .",
    "the peak density is reduced to @xmath128 , which occurs when the smoothing length reaches it s minimum and the cold particles in the clump are weighted most strongly .",
    "finally , panel ( d ) shows the results when the new estimate of the density is combined with the new smoothing length update algorithm .",
    "the smoothing length remains virtually constant throughout the transit , with @xmath120 decreasing to @xmath129 shortly after closest approach and @xmath126 only increasing from @xmath130 to @xmath131 .",
    "the new @xmath120-update algorithm does imply some additional computational expense when strong density gradients are present . in the example presented here",
    "the hot particle has in excess of 450 neighbours when the smoothing sphere overlaps the whole of the cold clump , far more than the 32 required by the hk89 algorithm",
    ". the overall computational expense will not be nearly as severe as this might suggest , however , as this idealised test follows a single particle next to a dense clump , where the weighting of neighbouring particles is the most extreme . for a distribution of particles , such as the cosmological structure formation discussed in section  [ sec : cosmic ] ,",
    "the overhead is typically on the order of @xmath132 per timestep .",
    "figure  [ fig : dncomp ] shows the sph estimate of the density profile across the boundary between two regions of different density , and demonstrates the sharpness with which density contrasts can be resolved by our method . to create the high density region",
    "we first evolve a cubical volume of gas at constant temperature , to ensure a relaxed particle distribution .",
    "we then extract a spherical region and compress it radially to achieve the desired density .",
    "this is then inserted back into the cubical simulation volume and the particles are allowed to move at constant radius from the centre of the box for a few time - steps to ensure a fully stable initial state . here",
    "the sphere has a radius @xmath133 in code units , and is 100 times more dense than the surrounding gas , with the temperature again set so that the two regions are in pressure equilibrium .",
    "away from the boundary both methods correctly estimate the density , as we would expect .",
    "however , as discussed in the previous section , the standard implementation of sph clearly overestimates the density close to the dense region , whereas the new algorithm gives a density contrast that is much sharper .",
    "in addition to the problems in estimating the density , unphysical forces can also occur in the presence of steep density gradients . in implementations of sph which try to keep the number of neighbours constant , a particle near a density gradient",
    "will find many , if not all , of its neighbours in the region of higher density .",
    "the pressure gradient at the particle will therefore be highly asymmetric , leading , from equation  [ eq : eom2 ] , to a force that acts to push the particle away from the high density region .",
    "the strength of this force will depend on the magnitude of the density contrast , saturating once the particle finds all its neighbours in the high density region , and a dense clump of gas will therefore rapidly empty the surrounding region of particles .",
    "we can see the effect of this asymmetric pressure gradient in figure  [ fig : veldiff ] , where we plot the radial velocities after 10 time - steps of particles in or near the dense clump .",
    "the scatter in velocity due to thermal motion of the hot gas is around @xmath134 in both cases .",
    "the standard sph code produces a large outward velocity in the hot gas , which evacuates a space between the two phases within a few tens of time - steps .",
    "this effect can be clearly seen in figure  [ fig : numdens ] , where the number density of particles drops to zero between @xmath135 . while our method also produces excess velocities at the boundary , implying that the spurious pressure gradient has still not been completely eliminated , the magnitude of the outward velocity has been greatly reduced and the effect is far less systematic .",
    "drag resulting from gas dynamical forces is an important factor in simulations of cosmological structure formation , as incorrectly estimating the drag can bias both the distribution of matter in clusters and the size and number of objects formed .",
    "frenk ( 1996 ) have suggested that excessive drag can worsen the overmerging problem seen in n - body simulations , and tcp99 have shown that standard implementations of sph can significantly overestimate the drag on a cold clump of gas moving through hot gas representative of the intracluster medium .",
    "this excess drag is caused by accretion of gas from the icm on to a shell around the clump , where it is held by forces arising from the miscalculation of the pressure gradient around the clump ( a discussion of this effect can be found in tcp99 ) .",
    "this accretion leads to an increase in the effective radius of the clump , and hence the drag .",
    "this drag is most severe when the clump is moving subsonically , and at higher velocities the accretion of gas decreases , largely vanishing when the mach number @xmath136 .    in order to examine the drag introduced by our implementation of sph",
    ", we consider the case of a clump of cold gas initially at rest in a stream of fast moving , diffuse gas ( this is identical to the method of tcp99 , except we work in the rest - frame of the cold clump ) .",
    "assuming collisions are inelastic , the clump will be accelerated to the flow velocity @xmath137 at a rate @xmath138 \\label{eq : drag}\\ ] ] where @xmath32 is a constant @xmath139 in which @xmath140 is the density of the diffuse gas , @xmath137 the flow velocity , r is the radius of the clump and m is the mass of the clump ( all in code units ) . for our tests @xmath141 , @xmath142 , the velocity and density of the flow are set to unity and the mach number of the flow is determined by setting the temperature of the gas as required .",
    "we use a mach number @xmath143 here , which is well inside the regime in which tcp99 show that drag becomes excessive .",
    "figure  [ fig : drag ] compares the results from our new code with those obtained the codes of ctp95 and t98 ( the code used by tcp99 is essentially the same as that used in t98 ) .",
    "the results of our code are clearly an improvement , being close to the prediction of equation  [ eq : drag ] .",
    "this is due to the elimination of the accretion that occurs in the other codes , as the asymmetric pressure gradients causing accretion are greatly reduced by our method .",
    "the difference between ctp95 and t98 is mainly a result of the kernel smoothing used in t98 , which is shown in tcp99 to further increase the effective cross section of a dense clump . at higher mach numbers",
    "the differences between the codes are less pronounced as the accretion decreases once @xmath144 , although t98 continues to give the largest drag of the three codes .",
    "clusters of galaxies contain large quantities of hot , x - ray emitting gas , often concentrated around the most massive galaxy in the cluster . in @xmath145 of cases , gas in the centre of the cluster has a radiative cooling time less than the hubble time , @xmath146 ( edge , stewart & fabian 1992 ; white , jones & forman 1997 ) , and as this gas cools surrounding gas will move inwards to maintain pressure support , initiating a large - scale motion known as a cooling flow ( see fabian 1994 for a review ) .",
    "the mass deposition rate can be as high as @xmath147 ( fabian 1985 ) , and is often observed to vary with radius roughly as @xmath148 within the radius @xmath149 in which the cooling time is less than a hubble time ( e.g. thomas , fabian and nulsen 1987 , hereafter tfn87 ) .",
    "this is generally taken as evidence for a multiphase flow , in which thermal instability is causing the denser gas to cool out of the flow at larger radii .",
    "modelling a multiphase flow is impossible with the usual implementation of sph as density is a locally averaged quantity , making the flow inherently single phase .",
    "in contrast , our method allows a wide range of densities , provided that a local pressure equilibrium exists .",
    "this is a reasonable assumption for particles with temperatures above @xmath150k , which will have cooling times much greater than the local sound crossing time ( nulsen , 1988 ) .",
    "particles below @xmath150k will cool to @xmath151k within a few time - steps , at which point they are removed from the flow .    to test the ability of our code to model a fully multiphase environment",
    ", we examine a simple constant - pressure , spherically - symmetric cooling flow .",
    "the distribution of phases in the flow is described by the fractional volume distribution @xmath152 introduced by nulsen ( 1986 , hereafter n86 ) , where @xmath153 is the fractional volume occupied by phases in the density range @xmath126 to @xmath154 .",
    "n86 considered many analytic forms for @xmath155 . here , we take @xmath156 with @xmath140 being a minimum density and @xmath41 the temperature dependence of the cooling function @xmath157 . for the purposes of this test we replace the sutherland & dopita ( 1993 ) cooling function with a pure power law in which @xmath158 .",
    "then equation  [ eq : cffuse ] can be integrated ( n86 ) and gives a mass deposition profile @xmath159 where @xmath160    particles are placed randomly within a cubical simulation of volume @xmath161 , and are then allowed to evolve at constant temperature until spurious fluctuations arising from the initial particle distribution have died away .",
    "particles are then ordered in terms of their distance from the centre of the box , and translated radially so as to match the mass profile given by @xmath162 where the density profile @xmath163 is derived in tfn87 .",
    "particles translated outside the bounds of the box are discarded .",
    "particle densities are drawn at random from the volume fraction distribution given by equation  [ eq : cffuse ] , with particle temperatures set so as to maintain constant pressure . here , the outer temperature is @xmath164 , the inner temperature @xmath165 , the central density is @xmath166 and the average outer density is @xmath167 .",
    "a total of 20252 particles are used .",
    "figure  [ fig : mdot ] shows the mass deposition profile @xmath168 , produced by the multiphase method after 500 timesteps .",
    "roughly 11% of the gas has cooled from the flow .",
    "the line marks a least - squares fit to the data , with slope @xmath169 .",
    "the points within @xmath170kpc of the centre of the flow have been excluded from this fit , as there are too few particles here for the mass deposition profile to be well sampled , as have particles with @xmath171 which lie in the corners of the cubical simulation volume .",
    "the slope is slightly steeper than the theoretical index of @xmath172 .",
    "figure  [ fig : multif ] shows the mass distribution function @xmath173 for particles at radii of between 50 and 60 kpc . in theory we would expect the distribution of phases given by equation  [ eq : cffuse ] to remain unchanged with time , giving @xmath174 .",
    "the dashed line represents a least - squares fit to the data , with gradient @xmath175 .",
    "this is again steeper than we would expect .",
    "this is probably due to the phases not comoving , an assumption made in n86 .",
    "there is no condition in our code to enforce this , and equation  [ eq : eom2 ] implies that high - density particles will receive a smaller pressure force than low - density ones .",
    "the artificial viscosity will limit the degree to which particles can interpenetrate , ensuring that the flow is largely comoving , but it may not be sufficient to ensure that no slippage occurs . applying a large bulk viscosity term in equation  [ eq : artvis ] forces the particles to comove , and flattens both slopes towards their theoretical values .",
    "however , this is not suitable for general application as it degrades the shock capturing ability of the method .",
    "the mass deposition profile produced by the standard implementation of sph is shown in figure  [ fig : mdotsingle ] .",
    "500 timesteps have passed and this time about 5% of the gas has cooled .",
    "in contrast with the multiphase results , this implementation produces a mass deposition profile that is centrally concentrated , as would be expected from a single - phase flow .",
    "this is supported by the mass distribution function , which is plotted in figure  [ fig : singlef ] .",
    "the gas has clearly evolved back to a single - phase state , with all particles having a density close to the mean , and no trace of the original density distribution remains .",
    "in addition , the gradient of the density profile has steepened from an initial value of @xmath176 ( as given by equation  [ eq : cfdens ] ) to @xmath177 , close to the theoretical single - phase gradient @xmath178 ( thomas , 1988 ) .",
    "when compared to the standard implementation of sph , it is clear that our method performs well .",
    "both the mass deposition profile and the distribution of densities in the flow are close to the theoretical values , whereas the standard implementation fails to reproduce the properties of the flow correctly .",
    "our final test involves a simulation of the formation of a cluster of galaxies .",
    "we use the initial conditions from the fiducial simulation of kay ( 2000 ) , who used it to test in detail the effect of varying a number of numerical and physical parameters .",
    "the simulation uses the standard cold dark matter ( scdm ) cosmology , with @xmath179 , @xmath180 and @xmath181 .",
    "the baryon fraction was set from primordial nucleosynthesis constraints , @xmath182 ( copi , schramm & turner 1995 ) , and an unevolving gas metallicity of @xmath183 was used .",
    "the initial fluctuation amplitude was set so that the model produces the same number density of rich clusters as is observed today , with @xmath184 , the present - day linear rms fluctuation on a scale of 8 , set to 0.6 ( eke , cole & frenk 1996 ; vianna & liddle 1996 ) . until @xmath185",
    "we adopt a comoving @xmath186-spline gravitational softening equivalent to a plummer softening of @xmath187 , after which it is switched to a fixed physical softening of @xmath188 .",
    "the minimum sph resolution is set to match the constraints imposed by the gravitational softening .",
    "@xmath189 particles of both dark matter and gas were used , giving a mass per particle of @xmath190 for the dark matter and @xmath191 for the gas .",
    "the simulation was started at @xmath192 and was evolved to the present day .",
    "for the purposes of this simulation , equation  [ eq : coole ] incorporates a source term @xmath193 to reflect the heating of gas due to a photoionising background .",
    "we assume that the background has a standard power - law form @xmath194 where @xmath195 is the flux at the h@xmath196 lyman limit ( navarro & steinmetz , 1997 ) ; we take @xmath197 and @xmath198 here . photoheating is implemented following theuns ( 1997 ) .",
    "the ultraviolet background has the effect of imposing a minimum temperature on the gas , rapidly heating it to @xmath199 and ensuring that pressure gradients in the gas remain shallow .",
    "if the effects of photoionisation are not included , then problems can occur when particles which have been in free expansion since the start of the simulation , cooling to very low temperatures with @xmath200 , encounter the accretion shock at the outer edges of halos .",
    "this shock is generally poorly - resolved , and neighbouring particles that have passed through the shock can make an overwhelming contribution to the estimate of the pressure of the cold particle , which can lead to the density being overestimated , potentially by several orders of magnitude . incorporating photoionisation serves as a simple way to limit this effect ; an alternative is to use the standard sph estimate of the density for calculating the emissivity in regions where the pressure gradient is steep , as discussed in section  [ sec : adiabatic ] .",
    "figures  [ fig : mbarphase ] and  [ fig : sbarphase ] illustrate the temperature - density distribution of baryonic matter at @xmath201 produced by the multiphase and standard codes . we have divided the gas into two phases ; a _ galaxy _ phase containing gas which is overdense by at least a factor of @xmath202 and has a temperature of @xmath203k@xmath204k and a _ hot _ phase which includes all gas with a temperature of @xmath205k and the gas with @xmath206k which is not sufficiently overdense to be considered part of the galaxy phase . almost all the particles in the galaxy phase lie along a line with @xmath207k , which marks the point at which the radiative cooling and photoheating rates balance .",
    "most of these particles are in the form of dense clumps with a size similar to the gravitational softening length  we refer to these clumps as galaxies .",
    "the properties of these galaxies are calculating by first extracting all particles within the galaxy phase from the simulation volume and then running a friends - of - friends group finder ( davis 1985 ) .",
    "the most significant difference between the two simulations is in the mass of the largest galaxy , which is nearly @xmath208% more massive in the single - phase simulation .",
    "kay ( 2000 ) find that this is a result of excessive cooling , as decoupling the hot and cold phases ( pearce 1999 ) reduces the final mass of the galaxy to a more reasonable value .",
    "the hot phase consists of particles that have been shock heated during gravitational collapse , with the bulk kinetic energy of the gas being converted to heat .",
    "figure  [ fig : mbarphase ] shows a significant quantity of hot ( @xmath209k ) , high - density ( @xmath210 ) gas which is not present in figure  [ fig : sbarphase ] but _ is _ seen in the single - phase simulations when radiative cooling is not allowed .",
    "this gas is located near the centre of large dark matter halos , close to the central galaxy , and overestimation of the already high gas density by the standard method leads to the gas rapidly cooling and being accreted by the galaxy .",
    "in contrast , the multiphase method correctly estimates the density of the gas , resulting in a slower cooling rate and the gas remaining at high temperatures throughout the halo .",
    "this effect can be seen in more detail in figures  [ fig : mhalo ] and  [ fig : shalo ] , which show the radial temperature profile of the gas around the most massive galaxy found in the simulation volume .",
    "the size of the galaxy is on the order of the softening length , @xmath211 , and is not shown here .",
    "the results from the standard implementation clearly show two of the problems inherent in the method .",
    "firstly , particle temperatures drop sharply within @xmath212kpc - this is clear evidence for overcooling .",
    "no such effect is visible in figure  [ fig : mhalo ] and the lack of overcooling in our method is probably the principle reason for the difference in mass of the largest objects in the two simulations .",
    "secondly , there is a complete absence of particles at radii @xmath213kpc , whereas particles are found all the way in to @xmath214kpc in the multiphase simulations .",
    "this is an example of the effect examined in section  [ sec : twophase ] , with particles close to the central galaxy being forced away by an artificially asymmetric pressure gradient in the single - phase method .",
    "we have presented a multiphase implementation of smoothed - particle hydrodynamics ( sph ) , along with a number of tests to compare the performance of our method with standard implementations of sph .",
    "the usual sph formalism assumes that density is a smooth quantity , varying negligibly on distances on the order of a typical smoothing length .",
    "this is clearly not true in many situations in which sph is applied , such as simulations of galaxy formation , in which large density contrasts are present .",
    "however , the pressure of the gas is expected to be a much smoother quantity because in almost all situations the sound - crossing time is shorter than the flow time across the smoothing sphere .",
    "we therefore summate the local pressure at each particle , and calculate the density from the equation of state .",
    "one situation in which our assumption will definitely not be true is in the presence of shocks , in which density variations are generally smaller than the variations in pressure .",
    "sections  [ sec : shocktube ] and  [ sec : adiabatic ] demonstrate that our method handles shocks acceptably , although the estimate of the density in the shock can be inaccurate when strong shocks are resolved poorly .",
    "this does not alter the force calculation , which is dominated by the artificial viscosity under such conditions , but is potentially significant when radiative cooling is implemented , and it may be may be preferable to use the standard estimate of the density for calculating the emissivity in regions where the local pressure gradient is steep . in section  [ sec : hupdate ]",
    "we examine the degree to which steep density gradients can be resolved by the two methods .",
    "standard implementations of sph are shown to severely overestimate the density of particles close to a region of high density , while these particles have their density correctly estimated by our method .",
    "in addition , we show in section  [ sec : twophase ] that unphysical forces can occur in the presence of steep density gradients , and while such forces are not completely eliminated by our method , they are greatly reduced .",
    "section  [ sec : drag ] examines the drag introduced by our implementation of sph .",
    "we find that at low mach numbers drag is greatly reduced compared to the sph implementations of ctp95 and t98 , while at higher velocities the results are in broad agreement with the findings of tcp99 , depending mainly on the choice of smoothing kernel symmetrization .    in section  [ sec : cflow ]",
    "we examine a simple spherically - symmetric , constant pressure cooling flow .",
    "the fractional volume distribution @xmath215 of phases within the flow is taken to be a pure power - law , which is shown by n86 to remain unchanged with time and deposit mass as @xmath216 .",
    "the standard implementation of sph is shown to be unable to reproduce the expected behaviour of this cooling flow , with conditions rapidly returning to a single - phase state .",
    "our code performs well , although the gradient of both the mass distribution @xmath217 and the mass deposition profile @xmath218 are too steep .",
    "this is probably due to phases not comoving in the flow , which is an assumption made in n86 .",
    "application of a large bulk viscosity to force particles to comove appears to reduce the problem , although this is not a suitable for application generally as it results in the shock capturing ability of the code being significantly degraded .    in section  [ sec : cosmic ] we examine the formation of a cluster of galaxies .",
    "the idealised problems examined in sections  [ sec : hupdate ] and  [ sec : twophase ] are shown to have real analogues in the simulation using the standard sph implementation , with overcooling resulting from overestimating the density of halo gas being clearly visible , and halo gas being forced away from the central galaxy .",
    "no such effects are visible in the simulation using our method .",
    "the lack of overcooling is also apparent in the masses of the galaxies formed , with the largest galaxy being nearly 50% more massive in the single - phase simulation , in agreement with the findings of pearce ( 1999 ) , who found that decoupling the galaxy from the hot halo gas produced a similar effect .",
    "our method is an alternative to the standard formulation of sph . in simulations without large density contrasts ,",
    "the two give very similar results .",
    "however it represents a significant improvement over the standard implementation of sph when the gas component can not be assumed to be a single - phase fluid , such as galaxy formation and cluster formation .",
    "in addition , fully multiphase fluid flow can be modelled , allowing sph to be applied to simulations of cooling flows and the intracluster medium .",
    "bwr acknowledges the support of a pparc postgraduate studentship . pat is a pparc lecturer fellow .",
    "the authors would like to thank rob thacker and scott kay for supplying initial conditions used in testing , and andy fabian for useful suggestions .",
    "we would also like to thank the referee , james wadsley , for helpful suggestions that have greatly improved this paper .",
    "parts of this work was conducted on the sgi origin platform using cosmos consortium facilities , funded by hefce , pparc and sgi .",
    "( ctp95 ) ( hk89 ) astro - ph/9903320 ( n86 ) astro - ph/9809221 ( t98 ) astro - ph/9911017 ( tcp99 ) ( tfn87 )"
  ],
  "abstract_text": [
    "<S> we adapt the smoothed - particle hydrodynamics ( sph ) technique to allow a multiphase fluid in which sph particles of widely differing density may be freely intermixed . </S>",
    "<S> applications include modelling of galaxy formation and cooling flows .    </S>",
    "<S> # 1#2#3#4#5#1 , # 2 , # 3 , # 4 , # 5 # 1#2#3#1 , # 2 , # 3 , in press # 1#2#3#4#5#6#1 , # 2 , in # 3 , eds , # 4 . </S>",
    "<S> # 5 , p.  # 6 </S>",
    "<S> # 1#2#1 , # 2 , preprint # 1*#1 *    methods : numerical - hydrodynamical simulation - galaxies : formation - cooling flows </S>"
  ]
}