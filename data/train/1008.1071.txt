{
  "article_text": [
    "new telescopes such as planck , lofar , mwa , alma and jwst will soon open up new windows onto the epoch of reionisation ( e.g. , @xcite ; @xcite ; @xcite ; @xcite for reviews of this epoch ) .",
    "data collected by these telescopes is expected to shed light on many unresolved issues in our current understanding of how galaxies form and evolve and interact with their surroundings .",
    "detailed theoretical studies , however , will be needed to interpret it . amongst the most promising techniques to perform such studies",
    "are cosmological simulations of reionisation .",
    "modern simulations of reionisation aim to combine the first - principle modelling of the gravitational growth of density fluctuations and of the hydrodynamical evolution of the cosmic gas in the expanding universe with recipes for star formation and associated feedback and to follow also the propagation of ionising radiation emitted by the first ionising sources .",
    "the computationally efficient , but accurate implementation of the radiative transfer ( rt ) is currently one of the biggest challenges for simulating reionisation .",
    "computing the ionising intensity throughout the simulation box requires solving the seven - dimensional ( three space coordinates , two directional coordinates , frequency and time ) rt equation .",
    "this is a formidable task , not only because of the high dimensionality of the problem , but also because of the large number of ionising sources contained in typical cosmological volumes . to accomplish it , existing approaches",
    "( e.g. , @xcite ; @xcite ; @xcite ; @xcite ; @xcite ; @xcite ; @xcite ; @xcite ; @xcite ; @xcite ; @xcite ; @xcite ; @xcite ; @xcite ; @xcite ; @xcite ; @xcite ; @xcite ; @xcite ; @xcite ; @xcite ; @xcite ) to transport ionising photons must often resort to a number of approximations .",
    "the accuracy of several ionising ( cosmological ) rt codes has been assessed in test simulations that were performed as part of a series of comparison projects ( @xcite ; @xcite ) .",
    "the results of the comparisons are encouraging and indicate that the participating codes have reached a certain level of maturity ( @xcite ) .",
    "the design of most of the test simulations was kept simple in order to facilitate comparisons between different rt codes .",
    "more recently , the performance of different rt codes has been compared in cosmological simulations of reionisation with an equally promising degree of agreement ( @xcite ) .",
    "however , the inclusion of rt in state - of - the - art simulations of structure formation remains a tough computational challenge , as we now explain .",
    "rt codes that are both spatially adaptive and parallel on distributed memory are still rare ( see , e.g. , table  1 in @xcite and table  1 in @xcite ) .",
    "nearly all reionisation simulations are therefore performed on uniform grids .",
    "combined with the fact that large simulation boxes are needed to model representative volumes of the universe , this means that the spatial resolution of state - of - the - art rt simulations of reionisation is typically far below that of the underlying spatially adaptive hydrodynamical simulations .",
    "in fact , many rt simulations of reionisation ignore hydrodynamical effects altogether and assume the gas traces the dark matter .",
    "small - scale structure in the cosmic gas is therefore often ignored or included only in a statistically sense .",
    "cosmological simulations of reionisation typically contain millions of star particles ( e.g. , @xcite ) .",
    "large numbers of ionising sources pose a challenge to simulations of reionisation because for most of the existing rt methods the computation times increases linearly with the source number",
    ". the usual practice of reducing the number of ionising sources by combining sources that fall into the same cell of a superimposed mesh renders reionisation simulations feasible , but also reduces the spatial resolution at which the rt is performed .",
    "note that the inclusion of diffuse ionising radiation emitted by recombining ions further increases the number of ionising sources . to reduce the computational effort ,",
    "this recombination radiation is therefore usually treated using the on - the - spot approximation ( e.g. , @xcite ) , which assumes it to be re - absorbed in the immediate vicinity of the recombining ion .",
    "however , the validity of this approximation remains to be assessed ( e.g. , @xcite ; @xcite , @xcite ) .",
    "rt simulations of reionisation are still often performed by post - processing pre - computed static density fields .",
    "this static approximation is appropriate for simulating the initial phase of rapid growth of ionised regions or the propagation of ionisation fronts on cosmological scales ( see , e.g. , the discussion in @xcite ) .",
    "once the speed of ionisation fronts becomes comparable to the sound speed of the ionised gas , the static approximation , however , becomes inapplicable and a full radiation - hydrodynamical treatment is required . in any case , the static approximation breaks down after about a sound - crossing time , as the jeans filtering of the gas can then no longer be ignored ( e.g. , @xcite ) .",
    "although radiation - hydrodynamical feedback from reionisation is known to play a key role , most of the large - scale reionisation simulations performed to date ignore it .    in pawlik & schaye ( 2008 , hereafter paper  i ) we presented the rt method traphic  ( transport of photons in cones ) for use in smoothed particle hydrodynamics ( sph ; @xcite ; @xcite ) simulations .",
    "traphic  can be used to solve both the time - independent and the time - dependent rt equation in an explicitly photon - conserving manner .",
    "it employs the full spatial resolution of the underlying sph simulation because it works directly on the unstructured grid formed by the discrete set of sph particles .",
    "it achieves directed transport of radiation on the irregular distribution of sph particles by tracing photon packets inside cones .",
    "the solid angle of these cones thereby sets the angular resolution at which the rt is performed .",
    "traphic  is by construction parallel on distributed memory machines if the sph simulation itself is parallel on distributed memory machines .",
    "the computational cost for simulations with traphic  is independent of the number of ionising sources .",
    "it merely scales with the product of the number of spatial and angular resolution elements , i.e. with the number of sph particles and the number of cones needed to tessellate the sky . for comparison ,",
    "the computational cost of conventional ray and photon tracing methods scales with the product of the number of spatial resolution elements ( gas particles or gas cells ) and the number of sources . since the number of sources is typically proportional to the number of spatial resolution elements , conventional ray and photon tracing methods face an expensive scaling with the square of the number of spatial resolution elements .",
    "in contrast , a relatively small number of angular resolution elements is typically sufficient to obtain converged results ( paper  i ; see also , e.g. , @xcite ; @xcite ) , and this , in combination with the independence of the computational cost of the source number , makes traphic  ideal for simulations containing large numbers of sources ( as is the case for , e.g. , reionisation simulations ) as well as for an explicit treatment of the diffuse radiation component .    in paper",
    "i we presented an implementation of traphic  for use on ( sets of ) static density fields in the sph code gadget ( @xcite ) .",
    "we applied this implementation to the transport of monochromatic ionising radiation in hydrogen - only gas at a fixed temperature .",
    "we demonstrated its excellent performance in several ( static density field ) test problems that were designed to allow a detailed comparison to results obtained with other rt codes .",
    "here we describe , test and discuss an extension of this implementation .",
    "the new implementation of traphic  allows for the transport of multi - frequency radiation in primordial gas , i.e. , in gas consisting of both hydrogen and helium .",
    "in addition to the computation of the ionisation state , it also allows for the self - consistent computation of the temperature of photoionised gas .",
    "the new implementation still solves the rt equation only on static density fields .",
    "the radiation - hydrodynamical coupling of traphic  will be described in a future work .    because the computational cost for rt simulations is typically proportional to the number of frequencies at which the rt equation is solved , many rt simulations of ionising radiation discretize the rt problem using only a single frequency bin . in the grey approximation ( e.g. , @xcite ) , ionising radiation within this bin is then assigned an effective absorption cross - section and an effective photoenergy that is injected in the gas upon absorption ( for examples see , e.g. , @xcite ) .",
    "the corresponding photoionisation heating rates can be computed assuming the optically thin or the optically thick limit .",
    "we use our new implementation to show that rt simulations which employ the grey approximation yield gas temperatures that agree with the exact multi - frequency solution only if grey photoheating rates are computed in the optically thin limit and then only close to the ionising sources .",
    "grey rt simulations that compute photoheating rates in the optically thick limit significantly overestimate the typical temperatures of the photo - heated gas .",
    "a related treatment of this subject and a discussion of its astrophysical implications can be found in @xcite .",
    "the structure of this paper is as follows . in sec .",
    "[ sec : traphic ] we present a brief review of the main concepts behind traphic . in sec .",
    "[ sec : theory ] we then discuss the equations that govern the evolution of the ionisation state and temperature of gas exposed to ionising radiation . with these preparations in hand",
    "we are ready to present our new implementation of traphic  in sec .",
    "[ sec : implementation ] ( and in the appendix ) .",
    "we discuss an extensive set of tests of this implementation ( on static density fields ) in sec .",
    "[ sec : tests ] .",
    "there we also investigate the applicability of the grey approximation by comparing simulations using the grey approximation with simulations using multiple frequency bins .",
    "we conclude with a brief summary in sec .",
    "[ sec : summary ] .",
    "in this section we briefly summarise the basic concepts underlying the rt method traphic  and introduce some of the notation that will be frequently employed in the following sections .",
    "the reader is referred to the original description in sec .  4 of paper  i for more details as that description remains valid .",
    "the extensions presented in this work concern only the application of traphic  to the transport of ionising photons , which will be described in sec .  [ sec : implementation ] .    to introduce essential notation",
    "we briefly recall that sph is a lagrangian numerical method to solve the euler equations of fluid dynamics through the representation of continuum fluids by discrete sets of particles ( for reviews see , e.g. , @xcite ; @xcite ) . any property ,",
    "say @xmath0 , of any given particle @xmath1 is determined by performing a weighted average , or smoothing , @xmath2 of the corresponding property @xmath3 of all other particles @xmath4 , where @xmath5 and @xmath6 are the mass and density of particle @xmath4 , and @xmath7 is the sph kernel that depends on the sph smoothing length @xmath8 .    in the following we",
    "make the common assumption that the kernel @xmath9 is compact so that there is a finite number @xmath10 of neighbouring particles @xmath4 within a sphere of radius @xmath8 around particle @xmath1 .",
    "if the smoothing lengths , which represent the spatial resolution elements of the sph simulation , are allowed to vary in space such that the number of neighbours @xmath10 remains fixed , then sph enables simulations whose spatial resolution adapts to the fluid geometry .",
    "it is this feature that makes simulations with a large dynamic range possible and that is perhaps the main reason for the numerous and successful applications of sph to solve multi - scale astrophysical problems such as galaxy formation and reionisation .",
    "traphic  transports photons directly on the sph particles ( i.e.  without interpolation to a superimposed numerical grid ) and hence the full dynamic range of the sph simulation is employed .",
    "the photon transport can be decomposed into the emission of photon packets by source particles followed by their directed propagation on the irregular set of sph particles .",
    "we now briefly describe both these parts in turn .",
    "photon packets , each of which carries photons of a characteristic frequency @xmath11 , are emitted from source particles to their @xmath12 neighbouring sph particles ( residing in a sphere of radius @xmath13 centred on the source ) using a tessellating set of @xmath14 emission cones .",
    "the number of neighbours @xmath12 is a parameter that determines the spatial resolution and is usually matched to the number of neighbours @xmath15 ( residing in the sphere of radius @xmath8 ) used in the computation of the sph particle properties , i.e. , @xmath16 .",
    "the number of cones @xmath14 is a parameter that determines the angular resolution of the rt .",
    "emission cones are necessary to achieve an isotropic emission despite the generally highly irregular distribution of sph particles ( see app .",
    "a in paper  i ) .",
    "the last parameter that controls the emission of photon packets by source particles is the number @xmath17 of frequency bins that are used to discretize the associated radiation spectrum .",
    "each of the emitted photon packets ( of frequency @xmath11 ) has an associated propagation direction .",
    "this propagation direction is chosen to be parallel to the central axis of the corresponding emission cone .",
    "after emission , the photon packets are traced downstream along their propagation directions .",
    "the packets thereby remain confined to the solid angle of the emission cone into which they were originally emitted thanks to the use of transmission cones with solid angle @xmath18 .",
    "the transmission cones prevent the unconfined diffusion of photon packets on the unstructured grid of sph particles that would otherwise occur and they ensure that the transport is directed .",
    "because the transmission cones are defined locally ( i.e. , at the positions of the transmitting particles ) and because photon packets are only transmitted to the subset of the @xmath19 nearest neighbours that are inside the transmission cones , the angular resolution at which photon packets are transferred is independent of the distance from the source ( even though the surface areas implied by the solid angles of the original emission cones increase with the square of the distances from the corresponding sources ) . as a result ,",
    "the sharpness of the shadows cast by opaque objects such as dense neutral clumps and filaments is independent of their distances from the sources .",
    "virtual particles ( vips ) are introduced to accomplish the photon transport along directions for which no neighbouring sph particle in the associated emission or transmission cones could be found .",
    "the properties of the vips ( like , e.g. , their densities ) are determined through sph interpolation from the @xmath12 neighbouring sph particles .",
    "their name refers to the fact that vips are temporary constructs that are only invoked to accomplish the transport of photon packets in empty cones .",
    "they do not hold permanent information , they do not affect the sph simulation and they are deleted as soon as they have fulfilled this task .",
    "the photon transport is supplemented with a photon packet merging procedure that respects the chosen angular resolution and renders the rt computation time independent of the source number .",
    "the merging is done by binning photon packets in angle ( according to their propagation directions ) using @xmath14 ( tessellating ) reception cones .",
    "binned photon packets define a single new photon packet per reception cone whose propagation direction is given by the weighted sum of this new photon packet contains a typo . the expression used in that publication , @xmath20 , where @xmath21 are the unit vectors that represent the propagation directions of photon packets that are to be merged and @xmath22 are associated weights , does generally not result in a unit vector ,",
    "which is inconsistent with the employed notation .",
    "however , a unit vector representing the propagation direction of the merged photon packet can be obtained by an additional explicit normalisation , i.e.  @xmath23 .",
    "] of the propagation directions of photon packets received in that cone .",
    "the merging is done separately for photon packets of different frequencies .",
    "thus , it does not change the mean free path of the photon packets , which is important for simulations that contain radiation sources with a broad range of spectral properties ( e.g. , quasars and stellar sources ) . thanks to the merging , at each particle at most @xmath24 photons packets need to be stored implied by the emission / reception cone tessellation .",
    "the solid angle of the transmission cones is the main parameter that determines the angular resolution of the photon transport , while the number @xmath25 of emission / reception cones controls the number of photon packets that need to be stored at each particle . choosing the solid angle of transmission cones smaller than @xmath26 would thus result in a higher angular resolution while keeping the memory needed to store photon packets unchanged .",
    "we have successfully tested this option by repeating test  4 in paper  i with @xmath27 and a transmission cone solid angle of @xmath28 .",
    "we found the results of this simulation to be indistinguishable from the simulation that employed @xmath29 and transmission cone solid angles of @xmath30 . in this work , however , we will not make use of this cone decoupling option . ] .    the photon transport is performed using rt time steps @xmath31 ( see sec .",
    "5.2.3 in paper  i for a detailed discussion of the size of time steps in reionisation simulations ) . during each such time step ,",
    "photons are propagated and their interactions with the gas are computed until a certain stopping criterion is satisfied . the criterion depends on whether one aims to solve the time - independent or the time - dependent rt equation . in the first case ,",
    "photons are propagated until they are absorbed or have left the computational domain . in the second case ,",
    "photon clocks associated with each photon packet are used to synchronise the packet s travel time with the simulation time such that photon packets travel at the speed of light .    after each time step ,",
    "the state of the sph particles is updated according to the interactions ( absorptions , scatterings ) with photon packets they experienced . in sec .",
    "[ sec : implementation ] we will explain , for the example of absorption of ionising radiation , how to combine the photon transport discussed here with the evaluation of the interactions according to the optical depth encountered by photon packets",
    ". finally , the rt time is advanced , which concludes the algorithm .",
    "a schematic summary of the rt method is depicted in the flow chart in fig .",
    "[ fig : flowchart ] .",
    "in this section we outline the physical processes that determine the evolution of the ionisation state ( sec .  [",
    "sec : ionisation ] ) and temperature ( sec .",
    "[ sec : heating ] ) of primordial gas exposed to ionising radiation .",
    "we discuss the underlying equations and present the references to atomic data required to evaluate them .",
    "the description of the numerical implementation used to solve these equations is deferred to sec .",
    "[ sec : implementation ] .",
    "readers familiar with the physics of ionisation , recombination , heating and cooling may wish to skip secs .",
    "[ sec : ionisation ] and [ sec : heating ] and refer to them only when needed . for those readers we have summarised the physical processes that we include in the computations of the ionisation and thermal state of gas in the rt simulations presented later in this work , together with the references to the ( fits to ) atomic data sets employed for their numerical evaluation , in table  [ tab : references ] .",
    "a detailed discussion of our choice for certain ( fits to ) atomic data sets and a comparison with other works can be found in @xcite .",
    "we start with some definitions that we will employ throughout the rest of this work .",
    "we consider an atomic gas of total number density @xmath32 , where @xmath33 is the number density of species @xmath34 and @xmath35 is the number density of free electrons .",
    "the number density @xmath33 is related to the total mass density @xmath36 through @xmath37 , where @xmath38 is the mass fraction of species @xmath34 and @xmath39 is its mass @xmath40 in units of the hydrogen mass @xmath41 .",
    "we assume that the gas is of primordial composition , i.e.  @xmath42 , @xmath43 , @xmath44 , @xmath45 , @xmath46 and @xmath47 .",
    "we will set @xmath48 .",
    "we will make frequent use of the species number density fractions with respect to the hydrogen number density , @xmath49 and the electron fraction @xmath50 .",
    "the evolution of the ionisation state of primordial gas in the presence of a photoionising radiation background of mean intensity @xmath51 is determined by the set of rate equations @xmath52 supplemented with the closure relations @xmath53 where @xmath54 is the photoionisation rate implied by the mean intensity @xmath55 of the ionising background and @xmath56 and @xmath57 are the collisional ionisation and recombination rate coefficients for species @xmath34 ; @xmath58 denotes the helium abundance ( by number ) ; @xmath41 and @xmath59 are the masses of the hydrogen and helium atoms , respectively .",
    "the ionisation and recombination rates are discussed in more detail below .",
    "the photoionisation rate @xmath60 determines the number of photoionisations of species @xmath34 per unit time and unit volume @xmath61 .",
    "it is defined by ( e.g. , @xcite ) @xmath62 where @xmath42 , @xmath44 , @xmath63 , @xmath64 is planck s constant , @xmath65 is the photoionisation cross - section and @xmath66 is the ionisation potential .",
    "we use the fits to the photoionisation cross - section from @xcite . note that @xmath67 , @xmath68 and @xmath69 .",
    "the photoionisation rates can be written as @xmath70 where @xmath71 is the average , or grey , photoionisation cross - section , @xmath72^{-1}. \\label{eq : crosssection}\\ ] ] we will employ the grey photoionisation cross - section of hydrogen in some of our rt simulations in sec .  [",
    "sec : tests ] . for reference",
    "we note that its value for a blackbody spectrum of temperature @xmath73 is @xmath74 .",
    "in addition to photoionisations we include collisional ionisation of hi , hei and heii by electron impact . to compute the corresponding ionisation rates , we employ the fits to the collisional ionisation coefficients provided by @xcite .",
    "we write the number of radiative recombinations per unit time and unit volume of species @xmath34 ( with @xmath75 @xmath76 , @xmath46 ) to energy level @xmath77 of the recombined species as @xmath78 .",
    "two radiative recombination coefficients are of special interest and are referred to as case a and case b. the case a recombination coefficient @xmath79 is the sum of all the recombination coefficients @xmath80 . on the other hand , the case",
    "b recombination coefficient is defined as @xmath81 and thus does not include the contribution from recombinations to the ground state .",
    "the introduction of the case b recombination coefficient is motivated by the observation that for pure hydrogen gas that is optically thick to ionising radiation , recombinations to the ground state are cancelled by the immediate re - absorption of the recombination photon by a neutral atom in the vicinity of the recombining ion .",
    "rt simulations of ionising radiation in an optically thick hydrogen - only gas may therefore work around the ( generally computationally expensive ) explicit transfer of recombination photons by simply employing the case b ( instead of the full , i.e.  case a ) recombination coefficient . note that this _ on - the - spot _ approximation ( e.g , @xcite ) is only strictly valid when considering the transport of ionising radiation in optically thick gas , whereas the gas in rt simulations typically shows a range of optical depths , from optically thick to optically thin .    to keep the description of our method and its test simple and to allow for a detailed comparison with published reference results",
    ", we will also assume the on - the - spot approximation and use case b recombination rates .",
    "the explicit transport of recombination radiation will be the subject of future work .",
    "we use the following coefficients to describe radiative recombinations ( table  [ tab : references ] ) . for hii and heiii radiative recombination",
    ", we employ the fits from @xcite . for the heii radiative recombination coefficient",
    ", we employ the tabulated coefficients of @xcite using linear interpolation in log - log .",
    "we have not yet discussed the dielectronic contribution to the heii recombination coefficient .",
    "dielectronic heii recombination ( e.g.  @xcite ; @xcite for a review ) is the dominant recombination process for temperatures @xmath82 .",
    "we therefore add the dielectronic contribution to the heii recombination rates , making use of the fit presented in @xcite .",
    "our main goal in this work is to present and test an implementation of traphic  to compute , in addition to the ionisation state , the evolution of the temperature of gas exposed to ionising radiation . for the discussion it is helpful to review the relevant thermodynamical relations , which is the subject of this section .",
    "the internal energy per unit mass for gas composed of monoatomic species that are at the same temperature @xmath83 is @xmath84 where @xmath85 is the boltzmann constant and @xmath86 is the mean particle mass in units of the hydrogen mass .    from the first law of thermodynamics @xmath87 where @xmath88 is the pressure ,",
    "@xmath89 the volume and @xmath90 and @xmath91 are the radiative heating and radiative cooling rates , normalised such that the rates of energy gain and loss per unit volume are described by @xmath92 and @xmath93 , respectively . assuming that @xmath94 , as is the case for an sph particle , it follows that @xmath95      the normalised cooling rate @xmath96 is the sum of the normalised rates of the individual radiative cooling processes .",
    "we include all standard cooling processes : collisional ionisation by electron impact , radiative and dielectronic recombination , collisional excitation by electron impact , bremsstrahlung and compton scattering .",
    "the expressions for the corresponding cooling rates are taken from the references listed in table  [ tab : references ] .",
    "the normalised heating rate @xmath90 is the sum of the rates of the individual radiative heating processes . in the following",
    "we only consider the contribution from photoionisation heating , which will be the main contributor to the heating rate for the high - redshift rt simulations of interest .",
    "we , however , note that compton heating by x - rays may not be negligible ( @xcite ) .",
    "we write the heating rate due to photoionisation as @xmath97 where @xmath98 is the heating rate per particle of species @xmath34 .",
    "using eq .",
    "[ eq : photoionisationrate ] , we can write @xmath99 where @xmath100 \\nonumber \\\\ & \\times & \\left [ \\int_{\\nu_\\alpha}^\\infty~d\\nu \\frac{4 \\pi j_{\\nu}(\\nu)}{h_{\\rm p } \\nu } \\sigma_{\\gamma \\alpha } ( \\nu ) \\right]^{-1 } \\label{eq : averageexcessenergy}\\end{aligned}\\ ] ] is the average excess energy of absorbed ionising photons . for reference , the average excess energy for photoionisation of hydrogen , assuming a blackbody spectrum of temperature @xmath101 , is @xmath102 .",
    "sometimes , e.g.  when considering the energy balance of entire hii regions , one is interested in the total photoheating rate integrated over a finite volume , assuming all photons entering this volume are absorbed within it .",
    "the average excess energy injected at each photoionisation in this optically thick limit is also obtained from eq .",
    "[ eq : averageexcessenergy ] , but after setting @xmath103 , since all photons are absorbed ( e.g. , @xcite ) , @xmath104   \\nonumber \\\\ &",
    "\\times&\\left [ \\int_{\\nu_\\alpha}^\\infty~d\\nu \\frac{4 \\pi j_{\\nu}(\\nu)}{h_{\\rm p } \\nu } \\right]^{-1}. \\label{eq : averageexcessenergythick}\\end{aligned}\\ ] ] for reference , the value of the average excess energy for photoionisation of hydrogen in the optically thick limit , assuming a blackbody spectrum of temperature @xmath101 , is @xmath105 .    in writing eqs .",
    "[ eq : averageexcessenergy ] and [ eq : averageexcessenergythick ] we assumed that all of the photon excess energy is used to heat the gas , corresponding to a complete thermalization of the electron kinetic energy . in reality ,",
    "( very energetic ) photo - electrons may lose some of their energy due to the generation of secondary electrons ( e.g. , @xcite ; @xcite ) .",
    "[ cols= \" < , < , < , < , < , < , < \" , ]",
    "here we extend the description of traphic  given in sec .",
    "[ sec : traphic ] to the transport of ionising photons by describing our implementation of the absorption of ionising photons and the subsequent computation of the species fractions and gas temperatures .",
    "the number of ionising photons that are absorbed during the propagation of a photon packet over distance @xmath106 between neighbouring particles @xmath1 and @xmath4 is given by @xmath107 $ ] , where @xmath108 is the number of photons inside the photon packet before propagation and the optical depth @xmath109 is the sum @xmath110 of the optical depths of each absorbing species @xmath111 and @xmath112 the last approximation is reasonable because sph neighbours will have similar densities .",
    "we consider these photons to be absorbed by particle @xmath4 .",
    "the number of photons @xmath113 absorbed by species @xmath34 is determined from the number of absorbed photons @xmath114 using @xmath115 where we choose ( un - normalized ) weights @xmath116 ( @xcite ; see also , e.g. , @xcite ) .",
    "the total number of photons @xmath117 absorbed by species @xmath34 is the sum of the photons absorbed due to the propagation of photon packets from all neighbouring particles during the rt time step @xmath118 , i.e. , @xmath119 .",
    "we pause to note that other choices for the weights @xmath120 ( as employed in , e.g. , @xcite ; @xcite ; @xcite ) will in general imply an unphysical distribution of the number @xmath114 of absorbed photons amongst the individual species . to see this , consider , for example , a gas parcel with optical depth @xmath121 that contains only hydrogen atoms .",
    "let an arbitrary fraction @xmath122 of the hydrogen atoms be labelled @xmath123 and let the remaining fraction @xmath124 of the hydrogen atoms be labelled @xmath125 .",
    "suppose that the optical depth of the hydrogen atoms with label @xmath123 is @xmath126 .",
    "the ratio of the number of photons absorbed by hydrogen atoms with label @xmath123 to the number of photons absorbed by all hydrogen atoms should be @xmath127 while eq .",
    "[ eq : absorptionweights ] implies @xmath128 the two ratios generally agree only if @xmath129 , where @xmath34 takes values @xmath123 and @xmath125 .",
    "other choices of the weights @xmath130 would imply that the probability for absorption of ionising photons by hydrogen atoms with label @xmath123 is different from the probability for absorption of ionising photons by hydrogen atoms with label @xmath125 .",
    "this is unphysical , since there is no physical difference between these two types of hydrogen atoms .",
    "as described in paper  i , photons absorbed by a virtual particle ( vip ) are redistributed amongst the @xmath12 neighbouring sph particles that have been used to compute its species densities .",
    "this is necessary , because vips are temporary constructs ; physical properties like the gas species fractions are only defined and stored for the sph particles . there",
    ", however , is an important change with respect to the original description .",
    "previously , we assigned to each of the neighbours a fraction of the absorbed photons that is proportional to the value of the vip s sph kernel @xmath131 at its position . in the current version",
    "we assign , to each of the neighbours , a fraction of the photons absorbed by species @xmath34 that is proportional to the neighbour s contribution to the sph estimate of the density of that species at the location of the considered vip .",
    "the current version is equivalent to the original version of paper  i if @xmath132 ( i.e.  no helium ) and if all neighbours have the same neutral hydrogen mass .",
    "however , in general this will not be true , in which case the current version is the only self - consistent one .",
    "we discuss the differences between the current and the original version in detail in app .",
    "[ sec : appendix ] .    the number of photons @xmath133 that are absorbed by a given particle during the rt time step @xmath31 is used to obtain the photoionisation rates @xmath134 for that particle directly ( i.e. , without reference to the mean intensity @xmath55 ) using @xmath135 where @xmath136 is the number of hydrogen atoms associated with the sph particle of mass @xmath137 .",
    "the photoionisation rates are then used to advance the species fractions and the gas temperature as we will describe in the next section .      here",
    "we present our numerical method to solve the equations of the evolution of the ionisation balance and temperature of gas exposed to ionising radiation ( eqs .",
    "[ eq : neutralfractions1 ] - [ eq : neutralfractions6 ] and eq .",
    "[ eq : dudt ] ) .",
    "this method is an extension of the subcycling method described in paper  i , which we therefore briefly recall .    in paper",
    "i we presented a method to follow the ionisation state of a ( hydrogen - only ) gas parcel exposed to ( hydrogen- ) ionising radiation at fixed temperature .",
    "the ionisation rate equations were solved at the end of each rt time step @xmath118 by explicit numerical integration ( hereafter also referred to as subcycling ) using subcycle steps @xmath138 , where @xmath139 is the time scale to reach ionisation equilibrium ( eq .  20 in paper",
    "i ) , @xmath140 is the recombination time scale , @xmath141 is the ionisation time scale and @xmath142 is a dimensionless factor that controls the integration accuracy .",
    "subcycling allows the rt time step @xmath118 to be chosen independently of the values of the ionisation and recombination time scales on which the species fractions evolve .",
    "a rt time step @xmath118 limited by the ionisation and recombination time scales would prevent efficient rt simulations since these time scales may become very small .    in this work",
    "we are interested in the self - consistent computation of the non - equilibrium ionisation state of gas with an evolving temperature . as for the case of a non - evolving temperature studied in paper  i",
    ", we integrate the ionisation rate equations over subcycle steps @xmath138 . the time scale @xmath143 to reach ionisation equilibrium",
    "is computed using eq .",
    "[ eq : taueq ] with @xmath144 and @xmath145 .",
    "recombination and collisional ionisation rates are determined using the temperature at the beginning of each subcycle step and the species fractions are advanced in a photon - conserving manner as detailed ] in paper  i.    in addition , the temperature is advanced by evolving the internal energy according to eq .  [",
    "eq : dudt ] over the same subcycle step assuming isochoric evolution ( @xmath146 ) , which is appropriate for a fixed gas distribution ( and thus during a single hydro - step in radiation - hydrodynamical simulations ) .",
    "we use the mean particle mass @xmath147 derived from the current species fractions to convert between temperature ( which is required to compute the rate coefficients ) and internal energy using eq .",
    "[ eq : internalenergy ] .",
    "note that the species fractions and the temperature are evolved independently of each other over a single subcycle step of size @xmath148 .",
    "we thus implicitly assume that during any of these steps the species fractions and the temperature do not evolve significantly .",
    "this assumption is excellent because the species fractions and the temperature evolve , by definition , on time scales large compared with the size of the subcycle steps .",
    "the evolutions of the species fractions and the temperature are coupled at the beginning of the next subcycle step , where the new species fractions and the new temperature determine new collisional ionisation , recombination and cooling rates .",
    "we now describe our numerical implementation of the subcycling .",
    "we limit ourselves to the description of how we advance the internal energy over a single subcycle step as the implementation of the subcycling of the species fractions was already described ] in paper  i. the internal energy is advanced by solving a discretized version of the energy equation ( i.e. , eq .",
    "[ eq : dudt ] with @xmath146 ) .",
    "we make use of implicit euler integration when the subcycle step is larger than the time scale @xmath149 on which the internal energy evolves . that is , if @xmath150 we advance the internal energy according to @xmath151 the last equation is solved iteratively for @xmath152 by finding the zero of the function @xmath153 and setting @xmath154 and assuming @xmath155 during the first iteration . if , instead , @xmath156 , we employ the explicit euler integration scheme , @xmath157 our implementation combines the advantages of the explicit scheme ( its accuracy ) with that of the implicit scheme ( its stability ; see , e.g. , @xcite and @xcite for useful discussions on implicit and explicit integration ) .    in paper  i ( for the case of a constant temperature )",
    ", we sped up the subcycling of the species fractions by keeping the species fractions fixed once ionisation equilibrium has been reached ) . ] .",
    "we employ a similar recipe here .",
    "however , thermal equilibrium is reached on the time scale @xmath158 , which may be much larger than the time scale @xmath159 to reach ionisation equilibrium . in this case",
    "the temperature continues to evolve after the species fractions have attained their ( quasi- ) equilibrium values .",
    "the evolution of the temperature implies an evolution of the recombination and collisional ionisation rates , and hence an evolution of the equilibrium ionisation balance . our recipe for speeding up the subcycling should respect this evolution .",
    "we therefore proceed as follows .",
    "once ionisation equilibrium has been reached , we stop the subcycling of the species fractions . over the remainder of the time step",
    "@xmath118 only the internal energy is subcycled , which can be done using time steps @xmath160 , where @xmath161 is a dimensionless parameter that controls the accuracy of the integration ( we set @xmath162 ) .",
    "this results in a speed - up since typically @xmath163 . after each such subcycle step",
    ", we reset the species fractions to their current equilibrium values .",
    "the equilibrium species fractions are obtained by iteratively solving the set of equations [ eq : neutralfractions1 ] - [ eq : neutralfractions6 ] with @xmath164 .    in summary",
    ", we solve the evolution of the ionisation balance and temperature using a hybrid numerical method that makes use of both explicit and implicit euler integration schemes .",
    "the ionisation rate equation is solved explicitly using the subcycling procedure presented in paper  i. this ensures the accurate conservation of photons and allows one to choose the size of the rt time step independently of the ( often very small ) ionisation and recombination time scales , a pre - requisite for efficient rt simulations . the temperature is evolved along with the ionisation balance by following the evolution of the internal energy of the gas .",
    "we use an explicit discretisation scheme to advance the internal energy if the cooling time is larger than the size of the subcycle step . for smaller cooling times ,",
    "stability considerations lead us to employ an implicit discretisation scheme to advance the internal energy .",
    "once ionisation equilibrium has been reached , the subcycling computation is sped up by fixing the species fractions to their ( temperature - dependent ) quasi - equilibrium values . from then on ,",
    "only the evolution of the internal energy is subcycled .",
    "in this section we perform simulations to test our new , thermally coupled implementation of traphic .",
    "we also use these simulations to discuss the differences in rt simulations performed using the grey approximation in the optical thick and thin limits and compare simulations using the grey approximation to simulations that solve the rt using multiple frequency bins .",
    "we begin in sec .  [",
    "sec : tests : test1 ] with verifying that the subcycling method described in sec .",
    "[ sec : implementation : subcycling ] can be successfully employed to solve for the non - equilibrium ionisation balance and temperature of gas exposed to ionising radiation .",
    "then , in sec .  [ sec : tests : reference ]",
    ", we present a set of reference solutions for the idealised problem of a single spherically symmetric expanding hii region that we will employ later to test the performance of traphic  in this same problem .",
    "we compare reference solutions derived in the grey approximation with the exact multi - frequency results and discuss their differences .",
    "thereafter , in secs .  [",
    "sec : tests : test2 ] and [ sec : tests : test3 ] , we investigate traphic s performance in rt simulations of increasing complexity : in sec .  [",
    "sec : tests : test2 ] we compute the ionised fractions and temperatures around a single source in a homogeneous density field and in sec .  [ sec : tests : test3 ] we follow the ionising radiation of multiple sources in a highly inhomogeneous density field .",
    "throughout we will compare the results obtained with traphic  to analytical and numerical reference results .",
    "the simulations were performed with traphicimplemented in a modified version of gadget-2(@xcite ) .",
    "all simulations were run on static density fields .",
    "we also remind the reader that , to facilitate comparisons with reference simulations , we do not explicitly follow recombination radiation but treat it using the on - the - spot - approximation .      here",
    "we test the subcycling approach to the computation of the coupled evolution of the non - equilibrium ionisation balance and temperature of gas exposed to ionising radiation that we have introduced in sec .",
    "[ sec : implementation : subcycling ] .",
    "our aim is to demonstrate that , given a flux impinging on a gas parcel ( or , equivalently , a photoionisation rate experienced by this parcel ) , the subcycling allows for an accurate computation of the evolution of its ionisation state and temperature , independent of the size of the rt time step @xmath118 .",
    "the setup of the test is as follows .",
    "we simulate the evolution of the ionisation state of an optically thin gas parcel with hydrogen number density @xmath165 . for simplicity and clarity of the presentation",
    ", we set the hydrogen mass fraction to @xmath166 ( i.e. , no helium ) .",
    "the simulation starts at time @xmath167 with a fully neutral parcel with initial temperature @xmath168 .",
    "we then apply a photoionising flux of @xmath169 with a blackbody spectrum of characteristic temperature @xmath170 .",
    "consequently , the parcel becomes highly ionised and is heated to a temperature @xmath171 .",
    "after @xmath172 we switch off the ionising flux and the parcel recombines and cools .",
    "the simulation ends at @xmath173 .",
    "the test here is identical to test 0 presented in @xcite , except for the switch - off time ( @xcite used @xmath174 ) .",
    "we employ a grey photoionisation cross - section @xmath175 ( sec .",
    "[ sec : ionisation ] ) , yielding a photoionisation rate @xmath176 .",
    "we assume that each photoionisation adds @xmath177 to the internal energy of the gas ( sec .",
    "[ sec : heating ] ) , which corresponds to the optically thin limit .",
    "we solve the equations for the evolution of the ionisation state and temperature of the gas parcel by subcycling them on subcycle time steps @xmath148 over consecutive time intervals @xmath178 .",
    "note that in a full rt computation these intervals would correspond to the rt time steps @xmath118 . here",
    "we distinguish between @xmath179 and @xmath118 only because in this test we are considering a single gas parcel with prescribed photoionisation rate and do not perform rt simulations .",
    "the dimensionless parameter @xmath142 that controls the size of the subcycling steps @xmath148 ( and hence the accuracy of the subcycling ) is set to @xmath180 . when computing compton cooling rates off the cosmic microwave background , we assume a redshift @xmath181 .    fig .",
    "[ fig : test1:error ] shows the results .",
    "the top left and top right panels show the evolution of the neutral hydrogen fraction and the temperature , respectively , for simulations with time steps @xmath182 , @xmath183 , @xmath184 , @xmath185 , @xmath186 , @xmath187 .",
    "note that in order to limit the computation time , not all of the simulations have been evolved until the end of the simulation time .",
    "they were stopped once their simulation time overlapped with that of the simulation with the next larger time step .",
    "the earliest output of a given simulation is at @xmath188 ( and hence , in fig .",
    "[ fig : test1:error ] , different curves start at different times ) , but all simulations started at @xmath167 and were numerically evolved on subcycle time steps @xmath189 as described in sec .",
    "[ sec : implementation : subcycling ] .",
    "the gas parcel quickly approaches photoionisation equilibrium , reaching its equilibrium neutral fraction after @xmath190 ( photo-)ionisation time scales ( @xmath191 ) . during this period",
    ", photoheating raises its temperature to @xmath192 .",
    "around @xmath193 , the neutral fraction exhibits a slight decrease .",
    "as noted in @xcite , this behaviour is caused by the decrease in the recombination rate due to the rise in temperature that can be observed at this time .",
    "the fact that the temperature still evolves after the neutral fraction reached its equilibrium value means that thermal equilibrium is reached on a larger time scale than photoionisation equilibrium .",
    "note that the thermal equilibrium phase is missed in the test simulations of @xcite because these simulations were stopped at a much earlier time .",
    "the observed behaviour can be understood as follows . when thermal equilibrium is approached from a temperature lower than the equilibrium temperature",
    ", the net cooling rate is approximately given by the photoheating rate .",
    "in photoionisation equilibrium , the photoheating rate is proportional to the recombination rate .",
    "the time scale @xmath194 to reach thermal equilibrium can therefore be expressed in terms of the recombination time @xmath140 , @xmath195 where in the last step we assumed that the gas is highly ionised , i.e.  @xmath196 , and that @xmath197 . the recombination time ( and hence the cooling time )",
    "is much larger than the time @xmath198 to reach ionisation equilibrium which asymptotes to @xmath199 for @xmath200 ( see also the discussion in sec .  5.1 in paper  i ) . here , @xmath201 and @xmath202 .",
    "accordingly , thermal equilibrium is reached much later than photoionisation equilibrium .",
    "after thermal equilibrium has been reached , the ionising flux is switched off and the parcel recombines and cools . once it has cooled to a temperature @xmath203",
    ", cooling becomes inefficient .",
    "the temperature of the recombining parcel therefore remains roughly constant .    in the bottom panels of fig .",
    "[ fig : test1:error ] we quantify the accuracy of our subcycling approach .",
    "ideally , we would like to compare the numerical results to an exact analytical reference solution .",
    "however , such a solution exists only for the case of a constant temperature ( see , e.g. , the appendix in @xcite ) . instead , we therefore show the relative error of the evolutions shown in the top panel with respect to the evolutions obtained from the simulation with the next smaller time step .    for all our choices of the time step @xmath179 and for most of the simulation time the relative errors are small , @xmath204 or even much smaller . during the initial phase of rapid evolution the relative error in the ionised fraction",
    "briefly becomes as large as @xmath205 . in practice",
    ", such errors will have little impact on the results of rt simulations if photons are conserved and if the equilibrium solution is still obtained with high accuracy ( as is the case ) . moreover ,",
    "relative differences of order @xmath205 are already implied by uncertainties in current atomic data used to compute the ionisation and recombination rates and the radiative heating and cooling rates ( as will be discussed in sec .",
    "[ sec : tests : test2:reference : t ] ) .",
    "note that the relative error can be reduced by lowering the numerical factor @xmath142 , which controls the size of the subcycle steps and hence the integration accuracy .",
    "we conclude that the results of the subcycling are insensitive to the size of the simulation time step .    in summary",
    ", we have demonstrated that our subcycling recipe accurately computes , independently of the size of the rt time step , the combined evolution of the neutral fraction and temperature of gas exposed to hydrogen - ionising radiation .",
    "in the following sections we will employ the subcycling to compute the species fractions and temperature of gas particles in rt simulations .      in the next section ( sec .  [",
    "sec : tests : test2 ] ) we will apply our new implementation of traphic  to compute the evolution of the ionisation state and temperature around an ionising source surrounded by gas of constant density .",
    "this is an idealised test problem designed to facilitate the verification of our implementation through the direct comparison to results obtained with an improved version of our one - dimensional ( 1-d ) rt code ( @xcite ; hereafter referred to as tt1d , which stands for testtraphic1d ) , which solves the rate equations using the same techniques ( and code ) as traphic , as well as to published reference results obtained with other rt codes for the same test problem ( @xcite ) . in this section we present these reference results .",
    "we also discuss the applicability of the grey approximation for solving multi - frequency rt problems .",
    "we start in sec .",
    "[ sec : tests : test2:reference : fixedt ] by presenting reference solutions obtained with our 1-d rt code tt1d  for the case of hydrogen - only gas at fixed temperature .",
    "this is an important case because it allows analytical solutions to be derived against which the numerical results obtained with tt1d  can be compared .",
    "then , in sec .  [ sec : tests : test2:reference : t ] , we compare the performance of tt1d  in a simulation of hydrogen - only gas in which the gas temperature is allowed to evolve due to photoheating and radiative cooling to published numerical results obtained for the same problem .",
    "finally , in sec .",
    "[ sec : tests : test2:reference : he ] , we discuss results from simulations with tt1d  in which the gas also contains helium .      in this section",
    "we discuss the rt problem of an expanding hii region . despite its simplicity , an analytical solution to this problem",
    "can not generally be obtained , even if the gas densities are assumed to be non - evolving ( as is the case throughout this work ) .",
    "this is because the coupling between the ionisation and temperature state through the dependence of the collisional ionisation , recombination and cooling rates on the temperature and species fractions impedes the evaluation of the governing differential equations ( eqs .",
    "[ eq : neutralfractions1 ] - [ eq : neutralfractions6 ] and [ eq : dudt ] ) .    to provide an approximate point of reference",
    ", we recall the evolution of an hii region at fixed gas temperature , for which an analytical solution is known ( under the approximation that the ionised region is fully ionised ; we will also ignore collisional ionisations , although this is not necessary ) .",
    "we have reviewed this solution in paper  i , where we showed that the radius of the ionised sphere around a source of ionising luminosity @xmath206 that is located in a homogeneous hydrogen - only medium of density @xmath207 is given by @xmath208 where @xmath209^{1/3}$ ] is the strmgren radius and @xmath210 is the strmgren time scale , which equals the recombination time for fully ionised gas . in some of our comparisons",
    "we will employ this approximate point of reference .",
    "we will refer to it as an analytical approximation .",
    "on the other hand , because of the lack of an accurate analytical solution , we will mostly employ results obtained with our 1-d rt code tt1d  in our benchmarking below .",
    "for this reason , we will first discuss its performance .",
    "we start by verifying our multi - frequency treatment in tt1dby comparing its performance in a simple hii region test problem to the corresponding equilibrium solution that can be derived analytically ( except for a numerical evaluation of the integrals involved ) .",
    "the test consists of simulating the spherically symmetric growth of the ionised region around a single ionising source in a homogeneous hydrogen - only medium at fixed temperature .",
    "the source has a blackbody spectrum with temperature @xmath211 and emits radiation with an ionising luminosity @xmath212 .",
    "the gas density is @xmath213 .",
    "the initial ionised fraction is assumed to be @xmath214 , and we use a recombination coefficient @xmath215 , independent of radius and time .",
    "collisional ionisation is not included .",
    "for reference , with the physical parameters mentioned above , the strmgren time is @xmath216 and the strmgren radius is @xmath217 .",
    "the spatial resolution , the time step and the number of frequency bins used in the simulation with tt1d  are chosen such as to achieve numerical convergence .    in fig .",
    "[ chapter : heating : fig : multifrequency ] we show the neutral ( ionised ) fraction profile in photoionisation equilibrium .",
    "diamonds show the result of the simulation with tt1d  ( at @xmath218 ) .",
    "the blue solid curve indicates the exact equilibrium solution obtained by solving ( e.g. , @xcite ) @xmath219 where the frequency - dependent optical depth @xmath220 is given by @xmath221    the simulation result is in excellent agreement with the exact equilibrium solution , verifying our multi - frequency implementation of tt1d . for comparison",
    ", we also show the exact equilibrium solution assuming that the radiation is monochromatic ( dotted black curve ) with a photoionisation cross - section evaluated at the ionisation threshold , i.e.  @xmath222 .",
    "we also show the exact equilibrium solutions in the grey treatment , i.e.  using the average cross - section @xmath223 ( dashed red curve ) .",
    "the reason for the differences between the results of the multi - frequency computation and the results of the grey and monochromatic computation can be readily understood .",
    "the absorption cross - section for ionising photons is a strongly decreasing function of the photon energy .",
    "the ionising photons with the lowest energy are therefore preferentially absorbed , which leads to an increase in the typical photon energy with distance .",
    "this effect is referred to as spectral hardening . because the photon mean free path is inversely proportional to the absorption cross - section , spectral hardening increases the width of the ionisation front with respect to that obtained in the absence of spectral hardening .",
    "note that spectral hardening only becomes important for large optical depths , which explains why the grey approximation reproduces the multi - frequency solution at small distances where the optical depth is low .",
    "the monochromatic approximation , on the other hand , implies an inappropriate value for the photoionisation rate and hence fails to describe the present multi - frequency problem at all distances from the source .",
    "note that both the grey and the monochromatic approximation will provide a better description of the multi - frequency problem for sources with a softer radiation spectrum .",
    "having demonstrated the validity of our multi - frequency treatment with tt1d , we now repeat the test problem from the previous section but this time we account for the self - consistent evolution of the gas temperature due to photoheating and radiative cooling .",
    "the physical parameters for the test are taken from @xcite .",
    "we consider an ionising source embedded in a homogeneous hydrogen - only density field with number density @xmath224 .",
    "the source emits @xmath225 with a blackbody spectral shape @xmath226 corresponding to a blackbody temperature @xmath227 .",
    "the test described here is identical to test 1 in paper  i , except that now the gas temperature is allowed to vary due to heating and cooling processes as described in sec .",
    "[ sec : heating ] ( with compton cooling off the redshift @xmath228 cosmic microwave background included ) and that collisional ionisation is included . the gas is assumed to have an initial ionised fraction @xmath229 ( approximately corresponding to the ionised fraction implied by collisional ionisation equilibrium at the temperature @xmath230 ) .",
    "its initial temperature is set to @xmath231 .",
    "as before , the spatial resolution , the time step and the number of frequency bins used in the simulation with tt1d  are chosen such as to achieve numerical convergence .",
    "[ chapter : heating : fig : comparison ] shows the neutral ( ionised ) fraction and temperature profiles at time @xmath232 using tt1d  ( black solid curves ) .",
    "we compare these multi - frequency results to results obtained using the grey approximation , i.e. using an average cross - section @xmath223 and grey photoheating rates .",
    "we employ grey photoheating rates computed in the optically thin limit ( red dotted curves ) , according to which each photoionisation adds @xmath233 to the internal energy of the gas , and in the optically thick limit ( blue dashed curves ) , in which case each photoionisation adds @xmath234 to the internal energy of the gas ( sec .  [ sec : heating ] ) .",
    "we employ the labels _ grey thin _ and _ grey thick _ to distinguish the two grey simulations from each other .",
    "we also show the results obtained ( in three - dimensional rt simulations ) with the rt codes c@xmath235-ray(@xcite ) , crash  ( @xcite ; @xcite ) and ftte  ( @xcite ) for the same test problem , as published in @xcite .",
    "the differences in the neutral fractions between the grey and the multi - frequency simulations that we have discussed above for fig .",
    "[ chapter : heating : fig : multifrequency ] are again clearly visible ( top panel of fig .  [ chapter : heating : fig : comparison ] ) .",
    "the _ grey thin _",
    "simulation yields results that asymptote to those obtained in the multi - frequency simulation at small distances from the ionising source . at large distances ,",
    "i.e.  near the ionisation front and beyond , on the other hand , the multi - frequency simulation implies significantly larger ionised fractions than those implied by this grey simulation .",
    "this is because the photon mean free path is larger in the multi - frequency simulation than in the grey simulations due to spectral hardening , leading to a smoother transition of the neutral fraction between the highly ionised gas interior to and the neutral gas far ahead of the ionisation front .",
    "the _ grey thick _ simulation yields neutral fractions that are very similar to those found in the _ grey thin _ simulation .",
    "however , the _ grey thick _ simulation yields slightly lower neutral fractions than the _ grey thin _ simulation , since it yields slightly larger temperatures , and thus smaller recombination rates , throughout the ionised region ( bottom panel of fig .  [ chapter : heating : fig : comparison ] ) .",
    "in contrast to the _ grey thin _ simulation , the neutral fractions obtained in the _ grey thick _ simulation therefore do not asymptote to those obtained in the multi - frequency simulation at small distances to the ionising source .",
    "instead , they remain systematically too small .",
    "the differences between the grey and multi - frequency simulations ( and between the _ grey thin _ and _ grey thick _ simulations ) become particularly apparent when inspecting the corresponding temperature profiles .",
    "the multi - frequency simulation yields substantially higher gas temperatures ahead of the ionisation front .",
    "this _ pre - heating _ is a simple consequence of the increase in the photon mean free path above that in the grey simulations .",
    "as already noted , at fixed radii the _ grey thick _ simulation shows systematically higher gas temperatures than the _ grey thin _ simulation .",
    "the reason is that in the optically thin limit the contribution of high - energy photons to the photoheating rate is reduced due to the weighting by the absorption cross - section @xmath236 , which is a strongly decreasing function of the photon energy .",
    "observe that the temperatures ( like the neutral fractions ) obtained in the _ grey thin _",
    "simulation asymptote to those obtained in the multi - frequency simulation at small distances to the ionising source , while the temperatures in the _ grey thick _ simulation are too high .",
    "we summarise our discussion of the differences between the grey and multi - frequency simulations for the present problem by noting that the use of the grey approximation leads to neutral fractions and temperatures that generally are very different from those obtained in detailed multi - frequency simulations . at large optical depths ,",
    "the neutral fractions are systematically too high and the temperatures too low due to the lack of spectral hardening .",
    "the grey treatment yields neutral fractions and temperatures that asymptote to those obtained in the corresponding multi - frequency simulation at small distances to the ionising source when photoheating rates are computed in the optically thin limit , i.e.  using eq .",
    "[ eq : averageexcessenergy ] . when computing photoheating rates in the optically thick limit , i.e.using eq .",
    "[ eq : averageexcessenergythick ] , the neutral fractions and temperatures do not asymptote to the correct values at small distances to the ionising source , i.e.  the values in the multi - frequency simulation . consequently ,",
    "when one invokes the grey approximation to compute the thermal structure of ionised regions , one should compute photoheating rates in the optically thin limit . photoheating rates in the optically thick limit",
    "should only be employed when considering the thermal balance of an ionised region as a whole .",
    "ideally , one would perform detailed multi - frequency simulations and simply dispense with the grey approximation .",
    "we now discuss the results of our simulations with tt1d  with respect to those obtained with c@xmath235-ray , crash  and ftte  for the same test problem ( @xcite ) .",
    "we note that the simulation with crash  employed multiple frequency bins , while the one with ftte  was done using a single frequency bin and computing photoionisation and optically thick photoheating in the grey approximation ( alexei razoumov , private communication ) .",
    "finally , c@xmath235-ray  used a hybrid method ( garrelt mellema , private communication ) : the absorption of ionising radiation was computed as a function of frequency , but each photoionisation injected the same amount of energy , regardless of the frequency of the absorbed photon .",
    "this method thus accounts fully for the spectral hardening of the radiation but ignores it when computing photoheating rates .",
    "there are noticeable differences in the results obtained with these three codes . at large distances from the ionising source , i.e.  close to and beyond the ionisation front ,",
    "most of these differences may be attributed to differences in the multi - frequency implementation , leading to differences in the spectral hardening of the emitted blackbody spectrum . at these distances ,",
    "the neutral fractions obtained in our grey simulations agree closely with those obtained with ftte , while the neutral fractions obtained in our multi - frequency simulations closely agree with ( and are , in fact , nearly identical to ) those obtained with c@xmath235-ray , as expected from our discussion above .",
    "we note that the fact that the neutral fractions obtained with crash  are systematically too large may indicate that the radiation field was too poorly sampled ( see @xcite , in particular their fig .  2 , for a thorough discussion ) .",
    "the results , however , show also significant differences in the neutral fractions and temperatures close to the ionising source , where the gas is close to optically thin and the emitted blackbody radiation spectrum is not severely deformed due to spectral hardening .",
    "some of these differences can be attributed to the fact that the different codes employ different expressions for cross - sections , recombination and cooling rates . as demonstrated in @xcite ( their fig .",
    "4 ) , different recombination and cooling rates may only account for differences in the neutral fraction and temperature of at most @xmath237 .",
    "we have verified this by employing the rates used with the different codes ( table  2 in @xcite ) in simulations with tt1d .",
    "most of the differences close to the ionising source may instead be traced back to the use of different assumptions underlying the computation of the photoheating rates .",
    "in fact , the temperatures obtained with crash  are in very good agreement with the temperatures obtained in our multi - frequency and grey thin simulations , while the temperatures obtained by ftte  and c@xmath235-ray  are in excellent agreement with the temperatures in our grey thick simulation .",
    "( assuming @xmath238 , @xmath239 ) .",
    "note that the results computed with cloudy  correspond to equilibrium ( @xmath240 ) , while the results computed with tt1d  correspond to a time @xmath241 ( which is much larger than the recombination time on which the gas reaches thermal and ionisation equilibrium ) .",
    "the results obtained with tt1d  are nearly indistinguishable from those obtained with cloudy  for all radii at which equilibrium has been reached.,scaledwidth=44.0% ]      finally , we test the ability of tt1d  to accurately compute the ionisation and temperature structure in gas containing both hydrogen and helium by comparing results obtained with tt1d  with results obtained with the photoionisation code cloudy  ( version 08.00 ; last described by @xcite ) for the same test problem .",
    "note that cloudy  assumes ionisation equilibrium .    as before we consider an ionising source with blackbody spectrum of temperature @xmath242 with an ionising luminosity of @xmath243 in gas of density @xmath244 , but we now assume @xmath245 and @xmath239 .",
    "cloudy  includes considerably more physics than tt1d . to facilitate a direct comparison ,",
    "we therefore keep the setup of the simulations as simple as possible : we assume that there is no radiative coupling between hydrogen and helium , i.e. , photons emitted due to recombination of helium do not lead to ionisations of hydrogen , and compute recombinations in the case a ( sec .  [ sec : recombination ] ) limit .",
    "[ fig : reference : helium ] shows the ionised fractions and temperatures computed with tt1d  at time @xmath241 .",
    "it also shows the results obtained with cloudy , which correspond to a time @xmath246 .",
    "the agreement between tt1d  and cloudyis excellent .",
    "the results only differ at radii where ( in the simulation with tt1d ) equilibrium has not yet been reached .",
    "thus , tt1d  yields equilibrium ionisation and temperature profiles that are almost indistinguishable from those obtained with a well - tested and widely employed state - of - the - art photoionisation code .      in this section",
    "we apply our new implementation of traphic  to compute the evolution of the ionisation state and temperature around an ionising source surrounded by gas of constant density .",
    "this idealised test problem captures the main characteristics of a thermally coupled rt simulation that we wish to verify : conservation of the number of ionising photons , which ensures that the final ionised region attains the correct size , and conservation of the associated energy , which , together with an accurate implementation of the relevant cooling processes , ensures that the ionised region settles into the correct thermal structure .",
    "the physical parameters for the test are identical to those employed to obtain the reference solutions presented in sec .",
    "[ sec : tests : test2:reference : t ] but , for definiteness , we repeat the problem description here .",
    "we consider an ionising source embedded in a homogeneous hydrogen - only density field with number density @xmath224 .",
    "the source emits @xmath225 with a blackbody spectral shape @xmath226 corresponding to a blackbody temperature @xmath227 .",
    "the test described here is identical to test 1 in paper  i , except that now the gas temperature is allowed to vary due to heating and cooling processes as described in sec .",
    "[ sec : heating ] ( with compton cooling off the redshift @xmath228 cosmic microwave background included ) and that collisional ionisation is included .",
    "the gas is assumed to have an initial hydrogen ionised fraction @xmath229 ( approximately corresponding to the ionised fraction implied by collisional ionisation equilibrium at the temperature @xmath230 ) .",
    "its initial temperature is set to @xmath231 .",
    "first , in sec .  [ sec : tests : test2:traphic ] , we consider the case in which radiation is transported using a single frequency bin in the grey optically thin approximation in pure hydrogen gas .",
    "we employ the grey approximation to allow for a more direct comparison with the results presented in paper  i. in sec .",
    "[ sec : tests : test2:traphicmultifreq ] we will also briefly discuss the performance of traphic  in multi - frequency simulations in gas containing both hydrogen and helium .",
    "+     +      the numerical realisation of the initial conditions is similar to that used for test 1 in paper  i. the ionising source is located at the centre of a simulation box with side length @xmath247 .",
    "the box boundaries are photon - transmissive , i.e. , photons leaving the box are lost from the computational domain .",
    "we assign each sph particle a mass @xmath248 , where @xmath249 is the total number of sph particles .",
    "the positions of the sph particles are chosen to be glass - like ( e.g. , @xcite ) .",
    "glass - like initial conditions imply a more regular distribution of particles in space when compared to that obtained from a monte carlo sampling of the density field .",
    "the sph smoothing kernel is computed and the sph densities are found using the sph formalism implemented in gadget-2 , with @xmath250 .",
    "photons are transported using a single frequency bin assuming the grey approximation in the optically thin limit .",
    "we therefore employ a photoionisation cross - section @xmath251 ( sec .",
    "[ sec : ionisation ] ) and assume that each photoionisation adds @xmath252 to the thermal energy of the gas ( sec .",
    "[ sec : heating ] ) .",
    "the rt time step is set to @xmath253 to facilitate a comparison to test 1 in paper  i. for the same reason , we limit ourselves to solving the time - independent rt equation and propagate photons during each time step only from a given particle to its direct neighbours .",
    "all simulations presented in this section employ @xmath254 sph particles , which are evolved for a total of @xmath255 .",
    "some of our simulations employ the resampling technique introduced in paper  i to reduce artifacts due to the particular setup of the initial conditions .",
    "briefly , each sph particle is , within its spatial resolution element whose size is determined by the diameter of the sph kernel , @xmath256 , from time to time offset randomly from its initial position . for comparison ,",
    "we repeat all simulations without employing this technique .",
    "we perform simulations with different angular resolutions .",
    "[ fig : test2:slices ] and [ fig : test2:profiles ] show our results .    in fig .",
    "[ fig : test2:slices ] we present slices through the centre of the simulation box showing the neutral fraction ( top row ) and temperature ( bottom row ) at time , as we did in the corresponding test 1 in paper  i , is that the simulation box is slightly too small to contain the whole ionised sphere at this time ( because of the smaller photoionisation cross - section that is employed here ) . ]",
    "@xmath232 . in each row ,",
    "the three left - most panels show results from simulations with angular resolution @xmath257 and @xmath258 and no resampling of the particle positions applied and the right - most panel shows results from a simulation with angular resolution @xmath259 and resampling of the particle positions every 10th rt time step . in each panel",
    "we indicate , as a point of reference , the analytical approximation for the position of the ionisation front ( eq .  [ eq : ifront ] ) by a dash - dotted circle .",
    "interior to the ionisation front the gas is highly ionised and photo - heated to typical temperatures @xmath260 ( with maximum temperatures @xmath261 ) .",
    "the runs that did not employ the resampling show slight deviations from the expected spherical shape which depend on the angular resolution .",
    "as discussed in paper  i , the deviations are caused by the particular arrangement of the sph particles . reducing this particle noise , which is strongest when @xmath262 , was the motivation for introducing the resampling technique .",
    "indeed , the distribution of neutral fractions and temperatures from the simulation that employed the resampling of the density field is spherically symmetric to a high degree .    in fig .",
    "[ fig : test2:profiles ] we compare the median profiles of the neutral fraction ( left - hand panel ) and the temperature ( right - hand panel ) at time @xmath263 obtained from the three - dimensional simulations with traphic  ( solid curves with error bars ) to the reference simulation obtained with our 1-d rt code tt1d  ( dashed curves ) .",
    "the results of all simulations are in excellent agreement with the reference result .",
    "the small deviations that are present very close to the ionising source and in regions where the profile gradients are steep are due to the finite spatial resolution ( indicated with horizontal error bars in the top left corners of the panels ) .",
    "the effect of resampling in reducing noise can most clearly be seen when comparing the simulations with angular resolution @xmath264 with each other ( middle panels ) .",
    "note that for the simulation with the highest angular resolution that we have considered here ( @xmath29 ) , the resampling slightly reduces the agreement with the reference simulation because it introduces additional scatter .",
    "this scatter is consistent with the spatial resolution employed .",
    "+      next we demonstrate the ability of traphic  to accurately solve the present multi - frequency problem in gas of primordial composition ( i.e. , in the presence of helium ) and using multiple frequency bins . for brevity",
    ", we discuss only a single simulation with particle number @xmath265 and angular resolution @xmath27 .",
    "we have verified that simulations with other choices for these parameters show the expected behaviour .",
    "we perform two simulations .",
    "the first simulation assumes a hydrogen mass fraction @xmath266 .",
    "the second simulation assumes a hydrogen mass fraction @xmath238 and a helium mass fraction @xmath267 .",
    "we set the initial ionised helium fractions to zero , @xmath268 .",
    "all other physical parameters are as in the previous section . for both simulations we use the same number of frequency bins , @xmath269 ( starting at @xmath270 , @xmath271 , @xmath272 , @xmath273 and @xmath274 , with the last bin extending to infinity ) .",
    "the photoionisation cross - section and excess energy associated with each bin are obtained from averaging over a blackbody spectrum of temperature @xmath211 , assuming the optically thin limit ( eqs .",
    "[ eq : crosssection ] and [ eq : averageexcessenergy ] ) .",
    "the motivation behind our choice to use a small number of frequency bins is that in realistic simulations that will be computationally more expensive , limited resources will require the usage of as few frequency bins as possible .",
    "our results below show that a number as low as five ( and perhaps even as low as three , see sec .",
    "[ sec : tests : test3 ] ) may be sufficient to capture the main effects associated with multi - frequency radiation transport .    fig .",
    "[ fig : test2:helium : slices ] shows the neutral hydrogen fractions ( top ) and temperatures ( bottom ) in a slice through the centre of the simulation box for the simulation without ( left ) and with ( right ) helium .",
    "the panels can be compared with the left - most panels of fig .",
    "[ fig : test2:slices ] , which show results from an identical simulation except that it used a single frequency bin and the grey , optically thin approximation . the effect of spectral hardening is most visible in the panels showing the temperature , with the multi - frequency simulations showing a substantial pre - heating ahead of the ionisation front .",
    "interestingly , the simulation that includes helium shows slightly less pre - heating ( and pre - ionisation ) than the one that assumes pure hydrogen .    the solid curves in fig .",
    "[ fig : test2:helium : profiles ] show median profiles of the species fractions and temperatures for both simulations . for comparison ,",
    "the ( converged ) reference results obtained with tt1d  are shown by dashed curves .",
    "the results of the simulations with traphic  are in excellent agreement with the reference result , both with and without the inclusion of helium .",
    "the small deviations that are present very close to the ionising source and in regions where the profile gradients are steep are due to the finite spatial resolution ( indicated with horizontal error bars ) .",
    "the fact that @xmath275 shows reduced scatter is probably because its value is not free but depends on @xmath276 and @xmath277 according to eq .",
    "[ eq : neutralfractions5 ] .",
    "[ sec : tests : test2:traphicmultifreq ]      in this section we use our thermally coupled implementation of traphic  to repeat test  4 of the cosmological rt code comparison project ( @xcite ) that we have discussed in paper  i for the case of fixed temperature ( @xmath278 ) .",
    "this test involves the simulation of the evolution of ionised regions around multiple sources in a static cosmological density field at redshift @xmath279 and was designed to resemble important aspects of state - of - the - art simulations of the epoch of reionisation .",
    "in contrast to our test 4 simulations in paper  i , we will here compute the evolution of the temperature along with that of the ionisation state of the gas .",
    "we will perform both simulations assuming the grey approximations ( optically thin and optically thick ) and using multiple frequency bins and we will discuss the origin of the differences in the results that these simulations yield .    the setup of this test is identical to that of test 4 in paper  i , to which we refer the reader for a detailed description .",
    "briefly , the initial conditions are provided by a snapshot ( at redshift @xmath280 ) from a cosmological n - body and gas - dynamical uniform - mesh simulation .",
    "the simulation box is @xmath281 on a side , uniformly divided into @xmath282 cells .",
    "we monte carlo sample this input density field to replace the mesh cells with @xmath283 sph particles .",
    "the gas is assumed to be initially fully neutral and to have an initial temperature of @xmath284 .",
    "the ionising sources are chosen to correspond to the 16 most massive halos in the box .",
    "they are assumed to have blackbody spectra @xmath285 with temperature @xmath101 .",
    "the ionising photon production rate is taken to be constant and all sources are switched on at the same time .",
    "the box boundaries are photon - transmissive .",
    "we perform three rt simulations to solve the time - independent rt equation , all with an angular resolution of @xmath259 ( and setting @xmath286 ) .",
    "we have demonstrated in paper  i ( test  4 ) that for the current problem this angular resolution is sufficiently high to obtain converged results . to facilitate a direct comparison with the corresponding simulation in paper  i , we employ the same time step @xmath287 and transport photons only over a single inter - particle distance per time step .",
    "we note that the current simulations do not employ the resampling technique to suppress noise in the neutral fraction caused by the particular realisation of the sph density field .",
    "as discussed in paper  i , for the present test this noise is small .",
    "for definiteness we mention that all simulations include collisional ionisation and all relevant cooling processes ( including compton cooling off the @xmath288 cosmic microwave background ) , employing the rates listed in table  [ tab : references ] .     +     +    in the first two of the three simulations we transport radiation using a single frequency bin , employing the grey photoionisation cross - section @xmath251 ( sec .",
    "[ sec : ionisation ] ) .",
    "the difference between these two simulations is in the computation of the photoheating rates used to evolve the gas temperatures . for one simulation ( _ traphic  thin _ ) we compute photoheating in the optically thin limit , assuming that each photoionisation adds @xmath252 to the thermal energy of the gas ( sec .",
    "[ sec : heating ] ) . in the other simulation ( _ traphic  thick _ ) we compute photoheating in the optically thick limit , assuming that each photoionisation on average adds @xmath289 to the thermal energy of the gas ( sec .",
    "[ sec : heating ] ) .",
    "the third simulation ( traphic ) differs from the first two in that we transport photons using @xmath290 frequency bins ( starting at @xmath291 , @xmath292 and @xmath293 , with the last bin extending to infinity ) .",
    "the photoionisation cross - section and the excess energy associated with each bin are obtained from averaging over a blackbody spectrum of temperature @xmath211 , assuming the optically thin limit ( eqs .",
    "[ eq : crosssection ] and [ eq : averageexcessenergy ] ) . as in the previous section ,",
    "our choice in favour of a very small number of frequency bins has purely practical reasons : computational efficiency .",
    "while we could have performed this relatively small test simulation at higher spectral resolution , we anticipate that applications of traphic  to large simulations of reionisation will generally require us to choose a number of frequency bins as small as possible .",
    "using a small number of frequency bins in the present test should thus give results that more closely resemble the results of future , larger simulations .",
    "[ chapter : heating : test7:hi]-[chapter : heating : test7:pdf ] show our results .",
    "[ chapter : heating : test7:hi ] shows images of the neutral fraction in slices through the centre of the simulation box at time @xmath294 ( our conclusions also hold for other times ) . the individual panels show results obtained with _ traphic  thin _ , _",
    "traphic  thick _ and traphic . for reference",
    ", we also show the results obtained with other rt codes for the same test problem as published in @xcite .",
    "neutral fraction contours are shown to facilitate the comparison . while the simulation with crash  treated the present problem by performing a multi - frequency computation , the simulation with ftte , as our simulation _",
    "traphic  thick _",
    ", solved it in the grey approximation using optically thick photoheating rates .",
    "finally , c@xmath235-ray  employed a hybrid method that treats the transport of radiation with multiple frequency bins but computes photoheating rates in the grey ( optically thick ) approximation .",
    "the differences in the neutral fractions are generally small .",
    "the simulations that employ photoheating rates in the optically thick limit ( ftte , c@xmath235-ray , traphic  _ thick _ ) yield smaller minimum neutral fractions than the simulations that compute photoheating rates in the optically thin limit ( traphic  _ thin _ ) or using multiple frequency bins ( crash , traphic ) .",
    "this is the result of lower recombination rates caused by the higher temperatures these simulations yield ( see fig .  [ chapter : heating : test7:temp ] ) .",
    "the regions with low ionisation ( @xmath295 ) found with traphic  are slightly smaller than those found with c@xmath235-ray  and crash , which indicates that three frequency bins are not sufficient for obtaining highly accurate multi - frequency solution .",
    "still , the simulations with traphic  seem to capture the main effects ( see the discussion on pre - heating below ) .",
    "[ chapter : heating : test7:temp ] shows images of the gas temperature in slices through the centre of the simulation box that correspond to the images of the neutral fraction shown in fig .  [ chapter : heating : test7:hi ] .",
    "there are significant differences in both the morphologies of the photo - heated regions and the typical temperatures attained by the photoionised gas between the different simulations . outside the ionisation fronts",
    ", these differences can mostly be attributed to differences in the spectral hardening of the ionising radiation .",
    "c@xmath235-ray , crash  and traphic  all yield a substantial pre - heating of the gas ahead of the ionisation fronts .",
    "this pre - heating is not seen in the simulations with _",
    "traphic  thin _ , _",
    "traphic  thick _ and ftte  since they all assume the grey approximation . in sec .",
    "[ sec : tests : test2:reference : t ] we have already discussed , for the same set of codes , the differences between a multi - frequency treatment and its grey approximations in idealised simulations of the evolution of a single , spherically symmetric , ionised region .",
    "the results here are in close qualitative agreement with that discussion .",
    "the results obtained with the different codes also exhibit significant variations in the gas temperature in regions well inside the ionisation fronts . while crash , traphic  and traphic  _ thin _ yield typical temperatures at @xmath296 ) peak temperatures ( their fig .  5 ) , which improves the agreement with the peak temperatures found with traphic .",
    "[ footnote : crash ] ] of @xmath297 , the typical temperatures obtained with c@xmath235-ray , ftte  and traphic are @xmath298 , i.e. , substantially higher .",
    "note that there is also disagreement between codes which incorporate the detailed treatment of multi - frequency radiation ( c@xmath235-ray , crash , traphic ) and between codes in which the radiation is treated in the grey approximation ( ftte , traphic  _ thin _ , traphic  _ thick _ ) .",
    "spectral hardening may thus only provide an explanation for part of the differences between the simulations .",
    "we recall that in sec .",
    "[ sec : tests : test2:reference : t ] , where we simulated the evolution of a single , spherically symmetric , photoionised region , we found qualitatively similar differences between the results obtained with c@xmath235-ray , crash  and ftte . in the ( nearly optically thin ) region close to the ionising source , the simulations that employed c@xmath235-ray  and ftte  yielded gas temperatures that were substantially larger than those in the simulation that employed crash . by comparing with results obtained with our 1-d rt code tt1d",
    ", we were able to explain most of these temperature differences in terms of differences in the assumptions underlying the computation of photoheating rates .",
    "the results presented in fig .  [ chapter : heating : test7:temp ] are another manifestation of this explanation .    in fig .",
    "[ chapter : heating : test7:pdf ] we compare histograms of the temperature at time @xmath299 . for the simulations with c@xmath235-ray ,",
    "crash  and ftte  we have computed these histograms directly from the @xmath282 values of temperatures published in @xcite . for the simulations with traphic , traphic",
    "_ thin _ and traphic  _ thick _ we assigned the temperatures to a corresponding uniform mesh with @xmath282 cells using sph interpolation before we computed the histograms .",
    "the histograms provide a quantitative confirmation of our qualitative discussion above . the simulations with traphic  and traphic  _ thin _ yield , in close agreement ] with the simulations performed with crash , typical temperatures of @xmath300 .",
    "on the other hand , the simulations performed with c@xmath235-ray , ftte  and traphic  _ thick _ closely agree on typical temperatures of @xmath301 .",
    "the differences between the histograms at low values of the temperature are mostly caused by the differences in spectral hardening . due to the pre - heating of gas",
    "ahead of the ionisation fronts obtained with the multi - frequency codes traphic , c@xmath235-ray  and crash , the number of cells that are still at their initial temperature @xmath302 is much smaller than found by ftte , traphic  _ thin _ and traphic  _ thick _ , which only employ a single frequency bin .",
    "in summary , in this section we have repeated the simulation of the expansion of multiple ionised regions in a cosmological density field that we discussed in test 4 in paper  i , but this time we explicitly computed the evolution of the temperature of the photoionised gas .",
    "we performed three simulations : one simulation computed photoheating in the grey , optically thin limit ( traphic  _ thin _ ) , one computed photoheating in the grey , optically thick limit ( traphic  _ thick _ ) and one employed multiple ( i.e. , three ) frequency bins .",
    "all three simulations showed only small differences in the neutral fractions when compared with each other , which could be plausibly explained with the differences in the temperatures .",
    "the temperatures differed due to the computation of photoheating rates in different limits ( grey optically thin , grey optically thick and multi - frequency ) . in particular , employing the grey approximation in the optically thick limit yields temperatures that are typically too large by factors @xmath303 .",
    "we also compared the results of our thermally coupled simulations with results obtained with other rt codes for the same test problem ( @xcite ) .",
    "we found very good agreement between these and our results when comparing simulations that employed similar assumptions for computing photoionisation and photoheating rates .",
    "the results of the multi - frequency simulation ( neutral fractions and temperatures interpolated to a @xmath304 uniform mesh using sph interpolation ) are available for download at the website of the cosmological rt code comparison project ( @xcite ; @xcite ) .",
    "in this work we described an extension of the implementation of traphic , the radiative transfer ( rt ) method for use with smoothed particle hydrodynamics ( sph ) simulations that we have introduced in pawlik & schaye ( 2008 , paper  i ) , in a modified version of the sph code gadget ( @xcite ) . the new implementation of traphic  can be used to solve multi - frequency rt problems in primordial gas consisting of hydrogen and helium .",
    "it also allows for the computation of the non - equilibrium evolution of the gas temperature due to photoheating and radiative cooling .    as part of the new implementation we introduced a numerical method that allows us to accurately compute the coupled evolution of the ionisation balance and temperature of gas parcels exposed to ionising radiation and that works independently of the size of the chosen rt time step",
    "this decoupling of the rt time step from the time scales that govern the evolution of the species fractions and temperatures , i.e. the decoupling from the ionisation , recombination and radiative cooling time scales , is an important pre - requisite for performing efficient rt simulations .",
    "the alternative , a rt time step limited by the values for the ionisation , recombination or cooling time scales , could quickly become computationally infeasible since these time scales may become very small .",
    "we discussed the performance of the new , thermally coupled implementation of traphic  in three - dimensional multi - frequency rt test simulations of spherically symmetric expanding hii regions and non - spherical expanding hii regions in a cosmological reionisation setting .",
    "we treated the multi - frequency radiation both using a single frequency bin in the grey approximation and using multiple frequency bins .",
    "we distinguished two types of grey approximations by computing photoheating both in the optically thin and optically thick limits .",
    "we compared the results of our test simulations to results obtained with other rt codes for identical test problems .",
    "we found excellent agreement in the morphologies and gas temperatures of the photoionised and photoheated regions when comparing simulations that employed similar assumptions for computing photoionisation and photoheating rates .",
    "we used the new implementation to demonstrate and pinpoint the differences in the results obtained from grey simulations and simulations that use multiple frequency bins .",
    "close to and ahead of ionisation fronts these differences are mostly due to the spectral hardening of the radiation field caused by the dependence of the absorption cross - section on photon energy .",
    "spectral hardening significantly increases the widths of ionisation fronts and implies a substantial preheating of the gas ahead of them .",
    "additional significant differences between the simulations are caused by the choice of the limit in which grey photoheating rates are computed .",
    "simulations that use grey photoheating rates computed in the optically thick limit yield typical gas temperatures that are too large by factors @xmath303 when compared with the exact multi - frequency solution .",
    "simulations that use grey photoheating rates computed in the optically thin limit yield typical gas temperatures that asymptote to the multi - frequency result with decreasing distances from the ionising sources .",
    "the additions presented in this work are crucial for applications of traphic  to simulations of the ( re-)ionisation of both hydrogen and helium that also wish to account for the preheating of gas ahead of ionisation fronts due to spectral hardening .",
    "we plan to perform such simulations in the future .",
    "note that we have limited our considerations to rt simulations on pre - computed static density fields .",
    "but photoheating increases also the gas pressure and hence affects the hydrodynamical evolution of the gas .",
    "an important goal for the future will therefore be to present an implementation of traphic  that allows one to perform radiation - hydrodynamical simulations .",
    "we thank benedetta ciardi , antonella maselli , garrelt mellema , alexei razoumov and dominique aubert for helpful discussions .",
    "we thank the referee for a careful reading of the manuscript and the many excellent suggestions that significantly improved the presentation of this work .",
    "this research was sponsored by the national computing facilities foundation ( ncf ) for the use of supercomputer facilities , with financial support from the netherlands organization for scientific research ( nwo ) , and by an nwo vidi grant .",
    "this research was furthermore supported by nsf grants ast-0708795 and ast-1009928 , as well as nasa through astrophysics theory and fundamental physics program grants nnx08al43 g and nnx09aj33 g .    99    abel , t. , haehnelt , m.  g. , 1999 , apjl , 520 , l13    abel t. , norman m.  l. , madau p. , 1999",
    ", apj , 523 , 66    aldrovandi s.  m.  v. , pequignot d. , 1973 , a&a , 25 , 137    altay g. , croft r.  a.  c. , pelupessy i. , 2008 , mnras , 386 , 1931    aubert d. , teyssier r. , 2008 , mnras , 387 , 295    badnell n.  r. , 2001 , aspc , 247 , 37    barkana r. , loeb a. , 2001 , phr , 349 , 125    black j.  h. , 1981 , mnras , 197 , 553    bolton j. , meiksin a. , white m. , 2004 , mnras , 348 , l43    cantalupo s. , porciani c. , 2010 , arxiv , arxiv:1009.1625    cen r. , 1992 , apjs , 78 , 341    ciardi b. , ferrara a. , marri s. , raimondo g. , 2001 , mnras , 324 , 381    ciardi b. , ferrara a. , 2005 , ssrv , 116 , 625    dove j.  b. , shull j.  m. , 1994 , apj , 430 , 222    fan x. , carilli c.  l. , keating b. , 2006 , ara&a , 44 , 415    ferland g.  j. , korista k.  t. , verner d.  a. , ferguson j.  w. , kingdon j.  b. , verner e.  m. , 1998 , pasp , 110 , 761    furlanetto s.  r. , oh s.  p. , briggs f.  h. , 2006 , phr , 433 , 181    furlanetto s.  r. , stoever s.  j. , 2010 , mnras , 404 , 1869    finlator k. , zel f. , dav r. , 2009 , mnras , 393 , 1090    gingold r.  a. , monaghan j.  j. , 1977 , mnras , 181 , 375    gnedin n.  y. , 2000 , apj , 542 , 535    gnedin n.  y. , abel t. , 2001 , newa , 6 , 437    gritschneder m. , naab t. , burkert a. , walch s. , heitsch f. , wetzstein m. , 2009 , mnras , 393 , 21    hasegawa , k. , & umemura , m.  2010 , arxiv:1005.5312    hui l. , gnedin n.  y. , 1997 , mnras , 292 , 27    hummer d.  g. , storey p.  j. , 1998 , mnras , 297 , 1073    iliev i.  t. , et al . ,",
    "2006a , mnras , 371 , 1057    iliev i.  t. , mellema g. , pen u .-",
    ", merz h. , shapiro p.  r. , alvarez m.  a. , 2006b , mnras , 369 , 1625    iliev i.  t. , et al . , 2009 , mnras , 400 , 1283    lucy l.  b. , 1977 , aj , 82 , 1013    madau p. , efstathiou g. , 1999 , apj , 517 , l9    maselli a. , ferrara a. , ciardi b. , 2003 , mnras , 345 , 379    maselli a. , ciardi b. , kanekar a. , 2009 , mnras , 393 , 171    mellema g. , iliev i.  t. , alvarez m.  a. , shapiro p.  r. , 2006 , newa , 11 , 374    mihalas , d. , weibel mihalas , b. , 1984 , foundations of radiation hydrodynamics , oxford university press , new york    nakamoto t. , umemura m. , susa h. , 2001 , mnras , 321 , 593    monaghan j. j. , rep .",
    ", 68 , 1703 ( 2005 )    mcquinn m. , lidz a. , zahn o. , dutta s. , hernquist l. , zaldarriaga m. , 2007 , mnras , 377 , 1043    mcquinn m. , lidz a. , zaldarriaga m. , hernquist l. , hopkins p.  f. , dutta s. , faucher - gigure c .- a . , 2009 , apj , 694 , 842    osterbrock d.  e. , 1989 , astrophysics of gaseous nebulae and active galactic nuclei , palgrave macmillan    paardekooper j .- p .",
    ", kruip c.  j.  h. , icke v. , 2010 , a&a , 515 , a79    partl a.  m. , dallaglio a. , mller v. , hensler g. , 2010 , arxiv , arxiv:1009.3424    pawlik a.  h. , schaye j. , 2008 , mnras , 389 , 651    pawlik a.  h. , 2009 , phd thesis , leiden university ( http://hdl.handle.net/1887/14025 )    petkova m. , springel v. , 2009 , mnras , 396 , 1383    press w.  h. , teukolsky s.  a. , vetterling w.  t. , flannery b.  p. , 1992 , numerical recipes in c. the art of scientific computing , cambridge university press , 2nd ed .",
    "a.  o. , cardall c.  y. , 2005 , mnras , 362 , 1413    ritzerveld j. , 2005 , a&a , 439 , l23    ritzerveld j. , icke v. , 2006 , phrve , 74 , 026704    savin d.  w. , 2000 , apj , 533 , 106    semelin b. , combes f. , baek s. , 2007 , a&a , 474 , 365    shampine l.  f. , gear c.  w. , 1979 , siam review , vol . 21 , no .",
    "1 . , pp . 1 - 17 , jstor .",
    "shapiro p.  r. , kang h. , 1987 , apj , 318 , 32    shull j.  m. , van steenberg m.  e. , 1985 , apj , 298 , 268    spitzer l. , 1978 , physical processes in the interstellar medium , new york wiley - interscience    springel v. , 2005 , mnras , 364 , 1105    springel v. , 2010 , ara&a , 48 .    susa h. , 2006 , pasj , 58 , 445    theuns t. , leonard a. , efstathiou g. , pearce f.  r. , thomas p.  a. , 1998 , mnras , 301 , 478    trac h. , cen r. , 2007 , apj , 671 , 1    verner d.  a. , ferland g.  j. , korista k.  t. , yakovlev d.  g. , 1996 , apj , 465 , 487    whalen d. , norman m.  l. , 2008 , apj , 673 , 664    white s.  d.  m. , 1996 , cosmology and large scale structure , proceedings of the `` les houches ecole dete de physique theorique '' ( les houches summer school ) , p. 349",
    ", elsevier scientific publishing company , amsterdam    williams r.  j.  r. , henney w.  j. , 2009 , mnras , 400 , 263    zahn o. , mesinger a. , mcquinn m. , trac h. , cen r. , hernquist l.  e. , 2010 , arxiv , arxiv:1003.3455",
    "in this appendix we show that the treatment of virtual particles ( vips ) in the implementation of traphic  that we have used to perform the ( hydrogen - only ) simulations published in pawlik & schaye ( 2008 , hereafter paper  i ) and that we will refer to as the old implementation , results in a temporary underestimate of the neutral hydrogen fraction just behind evolving ionisation fronts in simulations that use a high angular resolution .",
    "we will show that this underestimate is absent in simulations that employ our new implementation ( presented in the current work ) .",
    "moreover , in simulations that employ this new implementation , the numerical scatter in the neutral hydrogen fraction is significantly reduced . for clarity of the presentation and because we will compare results obtained with the new implementation with results obtained with the old implementation presented in paper  i that lacked the treatment of helium , we will assume that photons are transported in gas that consists only of hydrogen ( i.e. , @xmath166 ) .",
    "our discussion generalizes straightforwardly to the transport of photons in gas consisting of both hydrogen and helium .",
    "the number of hydrogen - ionising photons a vip absorbs depends on its neutral hydrogen density .",
    "as explained in paper  i , the computation of this number is performed in exactly the same manner as for sph particles .",
    "the only difference between the treatment of photons absorbed by sph particles and vips is that the latter distribute the absorbed photons amongst their sph neighbours . for",
    "this distribution of absorbed photons one must specify the fraction of the total that is given to each of the sph neighbours . in the old implementation of traphic",
    "this fraction was taken to be proportional to the value of the sph kernel @xmath131 of the distributing vip at the position of the sph neighbour . in the new version",
    "this fraction is taken to be proportional to the contribution of the sph neighbour to the sph estimate of the vip s neutral hydrogen density .    the old treatment of vips results in an underestimate of the simulated non - equilibrium neutral hydrogen fractions .",
    "[ fig : test1:artefact ] serves to demonstrate this .",
    "its panels show the neutral and ionised hydrogen fractions around a single ionising source in a homogeneous hydrogen - only medium at times @xmath305 and @xmath255 ( from left to right ) obtained with the old ( first and third rows ) and new ( second and fourth rows ) implementation .",
    "the setup and parameters for the simulations presented here are identical to the setup and parameters used for the @xmath306 , @xmath307 simulation presented in test  1 in sec .",
    "5.3.1 of paper  i. in addition to the neutral ( grey dots ) and ionised ( light red dots ) fractions of each particle , fig .",
    "[ fig : test1:artefact ] shows the median neutral ( black solid curves ) and ionised ( red solid curves ) fractions in spherical bins , which are compared to the exact solution obtained with our 1-d rt code tt1d(sec .",
    "[ sec : tests : test2 ] ; dashed curves of the corresponding colour ) .",
    "the error bars indicate the @xmath308 confidence intervals in each bin . for each implementation",
    "we have performed simulations both with and without resampling the density field , as indicated by the presence or absence of the letter ` r ' in the panel titles .    in the simulations employing the old implementation of traphic  the neutral hydrogen fractions at times @xmath309 and @xmath310",
    "are underestimated at radii slightly smaller than the radius of the ionisation front . in the simulations that employ the new implementation",
    "this underestimate is no longer present , thanks to the new manner in which the photons absorbed by vips are distributed . at @xmath311 ,",
    "i.e.  when the ionised region has ( nearly ) reached its equilibrium size , the underestimate is also absent in the simulations that employ the old implementation . however , at this time these old simulations still exhibit an increased scatter around the median when compared to the corresponding snapshots from the simulations that employ the new implementation .",
    "the underestimate of the neutral hydrogen fraction just behind evolving ionisation fronts in simulations employing the old implementation is caused by the fact that in this implementation the distribution of the photons absorbed by vips does not respect the spatial distribution of the neutral gas in their surroundings .",
    "it mainly affects the neutral fraction of particles close to evolving ionisation fronts , because the number of photons absorbed and subsequently distributed by vips near the ionisation front is significantly larger than the number of photons that are absorbed by the sph particles behind the ionisation front and because the vips distribute the absorbed photons irrespective of the neutral hydrogen mass with which the corresponding sph particles contributed to the computation of its neutral hydrogen density .",
    "we did not notice the described temporary underestimate of the neutral fraction just behind non - equilibrium ionisation fronts in the simulations that we have presented in our original publication ( paper  i ) , since there we only discussed profiles of the neutral fraction at @xmath312 .",
    "the reason why we limited ourselves to discussion of equilibrium results in that publication , was that we were still lacking accurate non - equilibrium reference solutions at that time ( our 1-d reference rt code tt1d  was still under development ) .",
    "the discovery of the underestimate of the neutral fraction was triggered by scatter plots of the neutral and ionised hydrogen fractions like those presented in fig .",
    "[ fig : test1:artefact ] that we have performed more recently ."
  ],
  "abstract_text": [
    "<S> we present an extension of traphic , the method for radiative transfer of ionising radiation in smoothed particle hydrodynamics simulations that we introduced in @xcite . </S>",
    "<S> the new version keeps all advantages of the original implementation : photons are transported at the speed of light , in a photon - conserving manner , directly on the spatially adaptive , unstructured grid traced out by the particles , in a computation time that is independent of the number of radiation sources , and in parallel on distributed memory machines . </S>",
    "<S> we extend the method to include multiple frequencies , both hydrogen and helium , and to model the coupled evolution of the temperature and ionisation balance . </S>",
    "<S> we test our methods by performing a set of simulations of increasing complexity and including a small cosmological reionisation run . </S>",
    "<S> the results are in excellent agreement with exact solutions , where available , and also with results obtained with other codes if we make similar assumptions and account for differences in the atomic rates used . </S>",
    "<S> we use the new implementation to illustrate the differences between simulations that compute photoheating in the grey approximation and those that use multiple frequency bins . </S>",
    "<S> we show that close to ionising sources the grey approximation asymptotes to the multi - frequency result if photoheating rates are computed in the optically thin limit , but that the grey approximation breaks down everywhere if , as is often done , the optically thick limit is assumed .    </S>",
    "<S> [ firstpage ]    methods : numerical  radiative transfer  hydrodynamics  </S>",
    "<S> hii regions  diffuse radiation  </S>",
    "<S> cosmology : large - scale structure of universe </S>"
  ]
}