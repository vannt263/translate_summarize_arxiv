{
  "article_text": [
    "the development over the last two decades of efficient and reliable wide - field multi - object spectrographs has resulted in enormous advances in the ability to compile large samples of high - quality astronomical spectra . the sloan digital sky survey ( sdss ; * ? ? ? * ) represents the most impressive application yet of such an instrument to provide spectroscopic samples of quasars , galaxies and stars of unprecedented size . the third data release ( dr3 ; abazajian et al .",
    "2004b ) provides the astronomical community with nearly 500,000 object spectra and further releases will take the number to 750,000 within eighteen months .",
    "the sdss spectra present a dramatic improvement in quality over data from previous surveys : extended wavelength coverage , @xmath0 ; intermediate resolution , @xmath3 ; high - quality relative and absolute flux - calibration ; typical signal - to - noise ratios ( s / n ) of @xmath4 ; availability of accurate noise and mask arrays . coupled with the overall homogeneity of the dataset this makes them suitable for an almost limitless number of quantitative investigations .",
    "a particularly impressive aspect of the instrumental design , observing strategy and data reduction pipeline @xcite has been the quality of the sky - subtraction achieved considering the relatively large , 3 arcsecond diameter fibres and fully automated reduction .",
    "subsets of the sdss spectra , such as the fainter quasars , include objects with magnitudes in red passbands equivalent to the sky - brightness per square arcsecond . despite the demonstrable quality of the sdss spectra",
    ", visual inspection reveals significant systematic sky - subtraction residuals longward of @xmath1  in many spectra .",
    "for fainter objects in particular , the sky - subtraction residuals are the dominant source of uncertainty over a wavelength interval of some @xmath5 . the spectroscopic region involved is extensive and includes features of significant astrophysical interest ; examples include the calcium triplet ( 8500 , 8545 , @xmath6 ) , a powerful diagnostic of stellar populations in low - redshift galaxies , and the h@xmath7 + [ oiii ] 4959 , @xmath8  emission region in quasars and active galactic nuclei ( agn ) in the redshift interval @xmath9 .    with sufficient care ( e.g. * ? ? ?",
    "* ) it is possible to quantify the noise properties of the sdss spectra in the red , allowing the statistical significance of features to be estimated reliably .",
    "however , the decrease in the s / n relative to that expected from counting statistics can be factors of 2 - 3 . coupled with the substantial fraction of the spectral range affected ,",
    "many potential scientific investigations are compromised .",
    "the sky - subtraction procedures incorporated in the sdss spectroscopic pipeline are very effective , overcoming a number of the longstanding problems associated with wide - field multi - fibre observations .",
    "brief details can be found in the early data release paper ( * ? ? ?",
    "* sections 4.8.5 and 4.10.1 ) and information on calibration improvements for the second data release ( dr2 ) are given in abazajian et al .",
    "( 2004a ) .",
    "while the large area of sky , @xmath10 square arcseconds , observed through the fibre aperture exacerbates the problem of achieving accurate sky - subtraction , the origin of the dominant systematic residuals present in the sdss spectra is not a preserve of fibre spectroscopy alone .",
    "rather , the fundamental issue lies in the ability to remove oh emission features from spectra in which the line profiles are barely resolved . combined with sub - pixel changes in the pixel - to - wavelength calibration between spectra",
    ", sharp residuals often remain .",
    "@xcite provides a recent summary of the difficulties associated with accurate sky - subtraction in long - slit observations , presenting a highly effective procedure for removing the signature of even rapidly varying and poorly sampled emission line features .",
    "the technique described by kelson is certainly not applicable to the extracted fibre spectra available as part of the official sdss data releases and any improvement must rely on an alternative procedure .",
    "the sky - subtraction residuals arise from the subtraction of two essentially identical tooth - comb signatures that have been very slightly misaligned relative to one another leading to well - defined patterns ( fig .",
    "[ fig_skyegs ] ) .",
    "this suggests a correction procedure that takes advantage of the correlations present in the wavelength direction , offering significant advantages over simply masking the affected pixels .",
    "more specifically , we develop an approach for the removal of the dominant oh sky - subtraction residuals in the sdss spectra based on principal component analysis ( pca ) .",
    "pca ( also called karhunen ",
    "love transformation ) is a well - established data reduction technique in astronomy , frequently applied to classification and reconstruction problems associated with large numbers of spectra of various types of object ( e.g. galaxies : connolly et al .",
    "1995 ; folkes et al . 1996",
    "; madgwick et al . 2002 , 2003 ; yip et al .",
    "quasars : francis et al .",
    "1992 ; yip et al .",
    "2004b . stars : whitney 1983 ) .",
    "the idea of employing pca for sky - subtraction has been suggested by @xcite , who present a complex method to remove the sky signal without the need for concurrent sky observations .",
    "however , the scheme appears to have generated little interest , perhaps because of the ambitious goal of the technique and the targeting of observations in which sky spectra are unavailable .",
    "by contrast , we develop a much more specific application of the pca technique to the sdss dr2 spectra that results in an improvement by over a factor of 2 in the s / n of those pixels longward of @xmath1 affected by oh sky lines , dramatically increasing the potential use of the red half of the sdss spectra for a variety of scientific investigations .",
    "the technique is equally applicable to the spectra in the recent dr3 release .",
    "we adopt the same convention as employed in the sdss and use vacuum wavelengths throughout the paper .    in section [ sec_method ]",
    "we present our method which is applied to sdss galaxy and quasar spectra in section [ sec_recon ] .",
    "section [ sec_tests ] uses subsets of the sdss dr2 spectroscopic catalogue to demonstrate application of the method to various astronomical studies .",
    "the code and documentation with which to carry out the method on public release sdss spectra is available on the web at http://www.ast.cam.ac.uk/research/downloads + /code",
    "our overall approach is determined by the extent of the spectroscopic information provided in a sdss public data release .",
    "the raw ccd exposures , typically 4 or 5 per spectroscopic plate , that make up the total exposure in each spectroscopic field are not available , precluding any attempt to improve the sky - subtraction on an exposure by exposure basis .",
    "however , the sdss data releases do provide the final reduced spectra for both target objects and for the fibres allocated to blank sky regions employed to define the underlying spectrum of the night sky .",
    "these contain significant diagnostic information about the quality of sky subtraction for each spectroscopic plate .    for each observation of a sdss spectroscopic plate , approximately 32 fibres , 16 for each of the 2 spectrographs ,",
    "are assigned to blank sky regions , selected from areas containing no detected objects in the sdss imaging survey .",
    "the sky fibres are identified as `` sky '' in the catalogue s `` objtype '' and `` specclass '' field .",
    "the sky spectra are combined to create a `` master - sky '' spectrum for each spectroscopic plate , which is then scaled and subtracted from each of the 640 spectra , producing 608 sky - subtracted object spectra and 32 sky - subtracted sky spectra , all of which are part of the standard sdss data releases . throughout the remainder of the paper we will refer to the sky - subtracted sky spectra as `` sky spectra '' , and the sky - subtracted object spectra as `` object spectra '' .",
    "the availability of large numbers of sky spectra , over 18,500 in dr2 , thus provides a direct empirical measure of the noise resulting from counting statistics as well as any systematic residuals from the sky - subtraction procedure .",
    "the scale of the sdss releases is such that the application of empirical self - calibration techniques , based on the statistical properties of the data set itself , can be a powerful tool",
    ".    visual inspection of the spectra of faint objects , or sky spectra ( fig .",
    "[ fig_skyegs ] ) , immediately reveals the presence of `` patterns '' due to small imperfections in sky subtraction .",
    "the presence of systematic deviations that are correlated over extended wavelength ranges suggests that a technique capable of quantifying the form and amplitude of the correlated deviations could allow the removal of a substantial fraction of the sky - subtraction noise .",
    "pca is a well - established technique with a number of desirable properties for such an application .",
    "the principles behind our sky - subtraction method are simple to understand : a pca of the sky spectra produces a set of orthogonal components that provides a compact representation of the systematic residuals resulting from the sky - subtraction process .",
    "the components are then added in linear combinations to remove the systematic sky residuals from the spectra of target objects , such as galaxies .",
    "our analysis focuses on the red part of the sdss spectra ( @xmath11 ) , as the strong emission features blueward of @xmath1   are small in number and easily masked .",
    "the upper limit of @xmath12  is set by the requirement that the entire wavelength region be included in all spectra when creating the pca components from the sky spectra .",
    "although techniques exist to overcome this @xcite , it was believed they would not greatly improve the applicability of the procedure for scientific objectives due to the very small fraction of plates affected .",
    "the goal of the sky - subtraction scheme is to remove any systematic residuals from the bulk of the sdss spectra .",
    "pathological spectra with very unusual deviations can have a disproportionate effect on the generation of the pca components .",
    "therefore , we identify a restricted subset of the full 18,764 sky spectra for use in deriving the pca components .    for the wavelength range used in the analysis ( @xmath11 ) the spectra must satisfy the following criteria , where the numerical values are in the units of the sdss spectra ( @xmath13 ) :    1 .",
    "@xmath14 mean flux @xmath15 , ensuring the spectra have a mean close to zero",
    "variance of the flux @xmath16 , ensuring that the amplitude of pixel - to - pixel fluctuations is not unusually high 3 .",
    "`` spectral colours '' have values @xmath17 , @xmath18 and @xmath19 ensuring that the spectra do not exhibit significant large scale gradients .",
    "@xmath20 , @xmath21 and @xmath22 are calculated by averaging the flux in three wavelength regions largely free of oh sky emission ( 7000:7200 [ a ] , 8100:8250 [ b ] and 9100:9180 [ c ] ) .",
    "we further only accept spectra with a minimum of 3800 good pixels ( `` ngood '' parameter ) over the entire wavelength range of the spectrum , to eliminate spectra with substantial numbers of missing pixels .",
    "following a trial run of the pca , 300 spectra are identified as outliers in the distribution of principal components , therefore dominating particular components , and discarded ( see section [ sec_pca ] ) .",
    "application of these selection criteria leaves sky spectra .",
    "finally , the spectra were normalised to have a median flux of zero over the wavelength range @xmath11 .",
    "none of the results in the paper depend on the details of the criteria used to define the subset of sky spectra to be used in the pca - analysis .",
    "the true error on each pixel in each spectrum is made up of components due to poisson noise and systematic sky - subtraction errors .",
    "our method for removing sky residuals relies on determining the best - fit pca - components via a minimum least - squares criterion over all pixels within the @xmath11 wavelength range .",
    "a pixel which varies greatly between spectra will be weighted highly during the generation of the pca - components and in the subsequent reconstruction of the sky - residuals present in individual spectra .",
    "for example , there will be a greater variance among spectra at wavelengths in the vicinity of strong oh emission lines , purely due to poisson noise and independent of whether there is a contribution due to sky - subtraction errors .",
    "it follows that to achieve effective sky - subtraction it is important to normalise each spectrum by the poisson noise expected at each pixel .",
    "failure to do so results in over - subtraction for certain pixels , with `` corrected '' pixels apparently exhibiting fluctuations below the poisson limit .",
    "each sdss spectrum includes a companion error array based on the original poisson errors derived from photon counts , ccd read - noise and so forth .",
    "unfortunately for our application , the error arrays have been systematically increased in regions of poor sky subtraction .",
    "the procedure is carried out separately for each plate and details can be found in the data reduction source code at http://spectro.princeton.edu/idlspec2d_doc.html#skysubtract .",
    "[ fig_hedge1 ] shows the flux standard deviation ( rms ) of the sky spectra with and without normalisation by the associated sdss noise arrays .",
    "if the sdss noise arrays accounted for all the variance present in the spectra , the lower plot in fig .",
    "[ fig_hedge1 ] would be flat .",
    "in fact the sdss noise arrays account well both for the increased `` continuum '' noise at red wavelengths , the presence of the atmospheric a - band at @xmath23  and the contribution from the increased sky emission associated with the presence of the broad o@xmath24 airglow emission centred on @xmath25 .",
    "however , significant additional residual variance resulting from the incomplete subtraction of the barely resolved oh emission lines remains .",
    "for many applications the resulting scaled error arrays , which better reflect the true error in each spectrum , are an improvement .",
    "however , using the modified sdss noise arrays for our sky - subtraction procedure does not allow it to reach its full potential , due to the excessive down - weighting of strong oh features .",
    "it is not possible to recover directly the original poisson errors that we require , so instead we develop an empirical approximation from investigation of several spectroscopic plates prior to sky subtraction , kindly made available to us by the sdss project ( e. switzer , p. macdonald and d. schlegel ) .",
    "these data confirmed the expectation that scaling of the error arrays is applied by the sdss reduction pipeline predominantly at positions of oh emission features .",
    "the same noise scaling is applied to all spectra on a plate , allowing us to derive a single rescaling for each plate . for each one of the 574 plates we calculate the median noise at each wavelength increment ( pixel ) from the sdss error arrays of the sky spectra .",
    "the continuum noise is calculated over the full wavelength range of interest interpolating across pixels containing oh sky emission lines .",
    "the amplitude of this continuum noise is dominated by counting statistics , and rises towards the red ( fig .",
    "[ fig_hedge1 ] ; upper panel ) due to an increase in the sky level and instrumental effects .     for this plate , which occurs at the wavelength of @xmath26 .",
    "]    we use a simple function to approximate the rescaling of the noise , @xmath27 , for each pixel @xmath28 on each plate : [ eq_scale ] s_i = 1+^ where @xmath29 is the median noise of the plate , @xmath22 the continuum noise , and max@xmath30 the maximum noise , above the continuum level , over all pixels . fig .",
    "[ fig_egplate ] shows an example plate median noise array , with estimated continuum and max@xmath30 marked .",
    "@xmath2 and @xmath7 are determined empirically as described below and represent , respectively , the relative amount of rescaling between pixels with differing amounts of noise , and the total rescaling of the pixel with the highest noise above continuum level .",
    "as the exact effects of the sdss noise scaling are not understood , the form of this function is chosen to provide flexibility in both the total rescaling and dependence with wavelength .",
    "( @xmath31 ) .",
    "for clarity , the upper spectra have been displaced vertically by 2.5 units ( upper panel ) and 1.5 units ( lower panel ) .",
    "the effectiveness of the sky - residual subtraction procedure is seen by the reduction by more than half of the systematic spikes in the top figure , and complete removal in the bottom figure . ]",
    "anticipating the results of section [ sec_recon ] , the effectiveness of the pca sky - residual subtraction procedure can be seen in fig .",
    "[ fig_hedge2 ] .",
    "the top panel shows the effect of the sky - residual subtraction on the raw rms of the sky spectra : the lower spectrum shows the uncorrected rms as a function of wavelength ( reproducing the top spectrum from fig .",
    "[ fig_hedge1 ] ) ; the upper spectrum shows the raw rms after application of the sky - residual subtraction scheme . note how the features due to the atmospheric a - band ( @xmath32 ) and o@xmath24-emission ( @xmath33 ) are unaffected , while the height of the spikes associated with the oh emission lines is greatly reduced . the variation with wavelength of the rms , post sky - residual subtraction ,",
    "is explained almost entirely by counting statistics .",
    "the bottom panel of fig .",
    "[ fig_hedge2 ] shows the rms of the sky spectra weighted by our modified noise arrays ( with @xmath31 ) : the lower and upper spectra show the rms before and after subtraction of the sky residuals respectively .    .",
    "from bottom to top @xmath34 and @xmath35 . ]    fig .",
    "[ fig_beta ] shows the effect of varying the noise rescaling ( @xmath7 in eq .",
    "( [ eq_scale ] ) ) applied to the sky spectra prior to creating the eigenspectra . from bottom to top @xmath36 . for low values of @xmath7 ( small amounts of rescaling of the noise arrays )",
    "the noise weighted rms is approximately constant with wavelength , i.e. the sky - residual subtraction procedure is not removing signal below the poisson limit for any pixels , although the procedure may also not be removing the full systematic contribution to the errors . as beta increases , initially the rms remains constant until a point is reached where significant dips appear in the red half of the spectra .",
    "the presence of these dips show that an unphysical situation has resulted , where , following the rescaling , the noise falls below the poisson limit for those pixels .",
    "the same effect is seen if we undertake the sky residual subtraction without weighting the flux by the noise arrays , i.e. the noise is constant , independent of wavelength .",
    "the fact that we can rescale the noise arrays by some amount before these unphysical dips appear , indicates that the sdss noise arrays have indeed been scaled to take account of the presence of a systematic contribution to the noise at wavelengths where the oh - emission is significant .    under - subtraction of the sky - residual signal due to over estimation of the poisson errors",
    "prevents our sky - residual subtraction method from reaching its full potential . over - subtraction of the sky - residual signal causes downward spikes to appear at the location of the oh emission lines ( fig .",
    "[ fig_beta ] ) , as we begin to erroneously subtract poisson noise .",
    "this suggests a simple method to estimate the values of @xmath2 and @xmath7 in eq .",
    "[ eq_scale ] : we require the weighted flux rms , post sky - residual subtraction , to be as constant with wavelength as possible whilst maximising the noise rescaling .",
    "we take a grid of values for @xmath2 and @xmath7 and for each combination first run the pca on the sky spectra with noise normalisation scaled according to eq .",
    "( [ eq_scale ] ) , then perform with the sky - residual subtraction with the same noise weighting . by calculating the standard deviation of the rms array , post sky - residual subtraction , for each value of ( @xmath2 , @xmath7 )",
    "we can derive the best empirical rescaling of the sdss noise arrays : we require the greatest value of @xmath7 that does not introduce upward or downward spikes , whilst @xmath2 allows purely for potential wavelength variations .",
    "we find that @xmath35 and @xmath37 .",
    "our final results are insensitive to small changes in @xmath2 or @xmath7 , and the measured value of @xmath35 suggests that the empirical rescaling of the noise arrays within the sdss spectroscopic pipeline is predominantly a function of the height of the oh spikes above the continuum noise . by systematically decreasing the amplitude of the noise arrays by 30% at positions of oh lines whilst retaining a constant noise weighted rms with wavelength , we substantially increase the effectiveness of the method , without over - subtracting residual sky features beyond the limit set by counting statistics .",
    "we emphasise that it is not possible to derive the true noise array , based on counting statistics , for each sdss spectrum from the information contained in the publically available sdss data releases",
    ". however , the close to constant rms as a function of wavelength achieved following our empirical rescaling of the noise arrays ( fig .",
    "[ fig_hedge2 ] ; bottom panel ) is strong evidence that , while approximate , the scheme does achieve a highly effective correction , reducing the rms close to the level set by counting statistics at all wavelengths .",
    "if a version of our sky - residual subtraction scheme could be applied to the sdss spectra using the true noise arrays , based on counting statistics , then further improvements should result .",
    "the strong sky emission lines , which lead to the presence of systematic sky - residuals , occupy only a fraction of the @xmath11  wavelength range and it is necessary to identify those pixels which suffer significantly from sky subtraction errors .",
    "the affected pixels can be found via the calculation of the rms of the sky spectra , normalised by the corresponding sdss noise arrays ( as shown in the lower panel of fig .",
    "[ fig_hedge1 ] ) .",
    "all pixels above a threshold value are defined as `` sky pixels '' .",
    "the `` non - sky pixels '' are not included in the pca sky - residual removal procedure but provide an empirical estimate of the level of poisson noise ( i.e. excluding systematic sky - residuals ) present in each spectrum . adopting a threshold level of 0.85 for the sky / non - sky boundary , the scheme results in 670 sky pixels and 697 non - sky pixels . the results shown in subsequent sections are not sensitive to reasonable variations in the threshold level .",
    "finally , to minimise their effect during the calculation of the pca components , sky pixels in each spectrum where the associated sdss noise array is zero ( i.e. no data ) are set to the mean value of the pixel in all the sky spectra that contain data .",
    "pca is a simple statistical method for data reduction which looks for components in a dataset that vary the most .",
    "the technique can be visualised by imagining an @xmath38-dimensional array , where @xmath38 is the number of pixels in the spectra . each spectrum",
    "is then represented by a point in the @xmath38-dimensional array ; pca searches for lines of greatest variance through the array , each one being orthogonal to all previous lines .",
    "the line of greatest variance defines the first pca component , and so on until the line of least variance defines the @xmath39 pca component .",
    "the projection of an individual spectrum back onto a pca component gives the amplitude of the component contained in that particular spectrum .",
    "a spectrum is reconstructed by summing the principal components multiplied by the relative amplitudes for that spectrum .",
    "appendix [ ap_pca ] presents the mathematics of pca .",
    "having created a sample of sky spectra containing only those pixels with sky signal and weighted by our empirically derived noise array for the relevant plate , we run the pca .",
    "the output consists of @xmath38 principal components which are @xmath38 pixels long .",
    "each component has an associated variance , which gives the percentage of the total variance of the dataset contained in that component .",
    "as pca can be sensitive to spectra with particularly unusual features in which we are not interested , we remove spectra which dominate the signal in individual components after one trial run .",
    "the pruning , of 300 spectra in total , is achieved by removing those spectra with principal component amplitudes more than @xmath40 from the mean .",
    "the pca is then rerun on the resulting sample of sky spectra .",
    "[ fig_temp ] shows the first 5 principal components resulting from the analysis .",
    "note the distinctive , correlated features present in each component .",
    "once the components are created , they can be used as templates to reconstruct the input sky spectra and later the sky residuals in the object spectra ( section [ sec_reconobj ] ) .",
    "this is done by projection of each spectrum onto the components and summation of the components weighted by the projection coefficients ( eq . [ eq_recon ] and [ eq_recon ] ) .",
    "the reconstruction may then be subtracted from the sky spectra leaving residual - free spectra , termed sky - residual subtracted spectra .",
    "the number of components to use in the reconstruction is not well defined . the use of too many results in the artificial suppression of noise below the poisson limit , with the pca acting as an ( undesirable ) high - frequency filter .",
    "the use of too few components means that the removal of sky residuals is sub - optimal and , in some cases , the overall quality of the spectra can decrease .",
    "[ fig_nrecon ] shows the mean ratio of the rms of the noise - weighted flux in the sky pixels to that in the non - sky pixels , for the sky - residual subtracted sky spectra , as a function of the number of components used in the reconstructions .",
    "the rms of the non - sky pixels in each spectrum remains constant and the ratio decreases monotonically as more components are used in the reconstructions , with an increasing fraction of the noise in the sky pixels removed .",
    "the reduction of the noise in the sky pixels below the noise in the non - sky pixels is clearly unphysical , and we therefore estimate the number of components to employ in the reconstruction of each spectrum by adopting the non - sky pixel rms of that spectrum as a reference .",
    "the reconstruction of a spectrum proceeds one component at a time , with the rms ratio calculated for the sky - residual subtracted spectrum .",
    "reconstruction is stopped when the rms ratio reaches unity , i.e. when the noise weighted flux rms is the same for the sky and non - sky pixels .",
    "the scheme is largely self - calibrating .",
    "for example , in spectra with high s / n the systematic sky residuals typically contribute only marginally to the sky - pixel noise , the rms ratio thus starts close to unity and only a small number of components are necessary to achieve equality in the rms ratio .",
    "the large number of pixels that contribute , combined with the robust estimator of the non - sky rms , mean the amplitude of the non - sky rms is well determined , providing an excellent indicator of when to halt the reconstructions .",
    "[ fig_hist ] shows the distribution of the number of components used for dr2 sky , galaxy and quasar spectra . for bright objects",
    "the contribution to the noise from imperfections in the sky subtraction is small and few components are required to bring the sky and non - sky rms to the same level .",
    "the presence of many spectra with high s / n produces the `` spike '' at low component numbers in both the galaxy and quasar sample histograms . the fainter limiting magnitude of the quasar sample make sky - residuals a problem in a larger fraction of the spectra and , on average , more components are required to remove the systematic errors present following the default sdss - pipeline sky - subtraction . to limit the effect of very occasional poor estimation of the non - sky rms we set the maximum number of components to 150 and 200 for the galaxy and quasar samples respectively .              in the preceding sections",
    "we have developed a procedure that achieves a substantial reduction in the amplitude of the systematic sky residuals in spectra that possess no large scale signal , i.e. the successfully sky spectra are known , by definition , to possess zero signal at all wavelengths .",
    "we now turn to the more interesting application of removing the systematic sky - residuals from the sdss science spectra of targets such as galaxies and quasars .",
    "the problem is made tractable by the success of the sky - subtraction procedure performed as part of the standard sdss spectroscopic pipeline .",
    "detailed examination of the properties of the sky spectra shows that both the mean level and the large scale shape of the sky spectrum to be subtracted from each spectrum have been determined to very high accuracy . as a result , there is effectively no sky `` continuum '' to remove , rather the problem is confined to removing the high - frequency structure due to the presence of the strong oh sky emission lines .",
    "the key goal is to ensure that object continuum and intrinsic absorption and emission line features are not removed as a result of the procedure used to reduce the amplitude of the systematic sky - residuals .",
    "as it is not necessary to identify any sky continuum present , we can remove the continuum of the object spectrum using a median filter before projection of the spectrum onto the principal components derived from the sky spectra .",
    "the smallest filter size can be found from median filtering the sky spectra as it is important that the filter is unaffected by the oh residuals ( about 40 pixels ) . as the filter size",
    "is increased above this minimum , some features intrinsic to the object fail to be removed .",
    "this generally causes an increase in the rms of the non - sky pixels used as a reference point to halt the reconstruction ( see previous section ) and therfore a decrease in the number of components used and slight decrease in the effectiveness of the sky - residual subtraction procedure .",
    "however , the final effect is small and insignificant for a reasonable range of filter sizes ( up to about 80 pixels ) . we have used a filter size of 55 pixels throughout this paper . in certain circumstances",
    ", it may be desirable to reduce the filter scale in order to follow the broad emission line profiles in quasars closer to the line centroids .",
    "narrow line features present the greatest challenge , as these can be mistaken for an oh sky residual by the pca .",
    "the advantage of pca in this task is that it looks for patterns in the spectrum , linking lines together which are correlated in the input sky spectra , and weights all bins equally .",
    "however , if an emission or absorption feature occurs exactly at the location of an oh line , some combination of principal components can sometimes be found to reconstruct the feature , without increasing the rms in the rest of the spectrum significantly .",
    "such behaviour is particularly likely if the line feature lies in a noisy part of the spectrum . for most applications in which the sky - residual subtraction scheme might be employed , it is possible to mask known emission and absorption features , thereby circumventing the problem . in section [ sec_cat ]",
    "we show how such masked features are unaffected by the sky - residual subtraction procedure .",
    "the disadvantage is that real sky features which happen to fall in the masked regions do not contribute to the projection onto the principal components and the sky - residual subtraction may not be fully effective in these regions . in some potential applications , it is not known in advance where absorption and emission features may occur and we present such an example in section [ sec_dla ] .",
    "features are masked by removing the relevant pixels during projection onto the principal components .",
    "alternatively , replacing the pixels with the local mean results in almost identical reconstruction .",
    "we similarly mask bad pixels ( where the sdss noise array is set to zero ) .    once the object spectrum has been continuum subtracted , we divide by the sdss noise spectrum of the relevant plate and project onto the sky principal components ( eq . [ eq_pcs ] ) , leaving out those pixels identified as possibly containing emission and absorption features .",
    "the resulting principal component amplitudes are used to reconstruct the residual sky - subtraction signal ( eq . [ eq_recon ] ) and the reconstruction is subtracted from the object spectrum , including masked pixels .",
    "re - multiplication by the noise spectrum , followed by the addition of the object continuum , returns the object spectrum cleaned of oh sky emission line residuals .",
    "[ fig_gal1 ] illustrates the process of sky - residual subtraction on a typical sdss galaxy spectrum .",
    "each class of spectroscopic science targets has different spectral characteristics .",
    "the effective application of the sky residual subtraction scheme requires the removal of the large scale `` continuum '' signal from the target object and the identification of wavelength intervals where narrow emission or absorption features may be present .",
    "the extremely high identification success rate achieved in the sdss means that the wavelengths of strong absorption and emission features in the spectra of stars and galaxies are known ; there are only 3,002 spectra without secure identifications among the 329,382 object spectra included in dr2 .",
    "potential systematic biases in the sky residual subtraction can be prevented by masking the wavelength intervals that include such features .",
    "the exact nature of the pre - processing applied to spectra prior to the implementation of the sky residual subtraction depends on the scientific goal . however , in subsequent sections we describe schemes that are likely to have wide application in the analysis of the 3 main classes of sdss science targets : galaxies , quasars and stars .",
    "the dr2 catalogue contains 249,678 unique objects spectroscopically classified as galaxies .",
    "the strong systematic trends in the absorption- and emission - line properties of the galaxies as one moves from early through to late type objects necessitates a sub - classification of the population prior to the application of the sky - residual subtraction .",
    "therefore , we classify each galaxy as either an absorption line , emission line or extreme emission line object .",
    "the spectral type parameter ( `` eclass '' ) in the sdss catalogue provides the basis for the absorption line ( eclass@xmath41 ) and emission line ( eclass @xmath42 ) classification .",
    "the extreme emission line galaxies are identified through the presence of emission lines with very large equivalent widths ( ew ) ( @xmath43 , @xmath44 ; or @xmath45 } } > 200$] , @xmath46 ) .",
    "an appropriate feature mask is then applied depending on the galaxy type ( e.g. see fig . [ fig_gal1 ] ) .",
    "a total of 331/286/469are masked in absorption / emission / extreme emission line objects respectively , over the entire rest - frame wavelength range of @xmath47 , i.e. in the observed - frame wavelength range of @xmath11  only a small fraction of pixels are affected by the line masks .",
    "[ fig_gal2 ] shows examples of galaxy spectra before and after sky residual removal .",
    "the dr2 catalogue contains 34,674 unique objects spectroscopically classified as quasars or high - redshift quasars .",
    "a feature mask includes narrow emission lines ( e.g. [ oiii ] @xmath48 ) and @xmath49intervals ( observed frame ) centred on the broad emission lines ( e.g. civ @xmath50 ) .",
    "the wings of the broad emission features can , in practice , be regarded as `` continuum '' in the context of the sky residual subtraction as they are removed by the median filtering .",
    "[ fig_qso ] shows examples of quasar spectra before and after sky subtraction .",
    "there are 42,027 unique objects classified as stars or late - type stars in the dr2 . due to their single redshift , application of the sky - subtraction procedure",
    "is even simpler .",
    "depending on the final science required and the type of stars involved , a suitable feature mask and continuum estimation can be straightforwardly derived but our adopted median filter scale of 71 pixels , employed for the galaxies and quasars , produces very satisfactory results .",
    "in this section we present the quantitative results of applying the sky - residual subtraction to a variety of object spectra .      [ cols=\"^,^,^,^,^,^,^ \" , ]     the detection of intervening absorption features in quasar spectra is an example of an investigation in which it is not possible to simply mask the wavelength regions containing features before the application of the sky residual subtraction .",
    "that is not to say that the sky - residual subtraction scheme is not of potential interest .",
    "the improvement in the quality of the spectra is such that the s / n of specific features can increase , albeit at the potential cost of modification of the feature properties . in practice , a hybrid scheme , involving one or more iterations , with detected features masked in a second application of the sky - residual subtraction ,",
    "is straightforward to implement .    in any particular application ,",
    "a full understanding of the advantages of employing the sky - residual subtraction scheme would require the use of ( straightforward ) monte carlo simulations to quantify the probability of feature detection as a function of wavelength .",
    "such an investigation is beyond the scope of the present paper but to illustrate the impact of the sky - residual subtraction on unmasked absorption features we create a composite spectrum of damped ly@xmath2 ( dla ) systems identified by @xcite .",
    "each quasar spectrum is shifted to the rest frame of the dla absorber and normalised to possess the same signal in the absorber rest - frame wavelength interval @xmath51 .",
    "the composite spectrum is then constructed using an arithmetic mean of all the spectra with signal at each wavelength , taking care to account for the flux /   term in the sdss spectra .",
    "[ fig_dla1 ] shows the resulting composite spectrum , calculated with and without the application of the sky - residual subtraction to the constituent quasar spectra . as in section [ sec_qso ] the centres of prominent broad emission lines in the quasars",
    "are masked during the sky - residual subtraction .",
    "[ fig_dla2 ] shows 3 versions of the composite spectrum , focusing on the rest - frame wavelength region that derives from observed - frame wavelengths @xmath52 .",
    "the 3 versions of the composite were calculated using quasar spectra without sky - residual subtraction ( bottom ) , with sky - residual subtraction ( middle ) and with sky - residual subtraction _ and _ the absorption features masked .",
    "the absorption - line mask consisted of 14@xmath53  intervals , in the absorber rest - frame , centered on each absorption line .",
    "absorption - line equivalent widths ( ews ) are measured in the absorber rest - frame , using the method of section [ sec_cat ] .",
    "table [ tab_dla ] includes the ews of the absorption features in the 3 composite spectra , together with the wavelength intervals used in the line and continuum measurement .",
    "for each composite the same continuum is used for measuring ews , in this case calculated from the spectrum with lines masked , although in practice any consistent continuum would suffice .",
    "the sky - residual subtracted composite , with masking of absorption lines , provides the best reference .",
    "as expected , the ews of several of the absorption lines in the unmasked composite are systematically reduced .",
    "however , the illustration is a `` worst case '' example of the sky - residual subtraction scheme involving only a single iteration .",
    "a second application of the sky - residual subtraction using a mask based on the identification of features following the first application , offers the prospect of significant improvement in the identification and measurement of features at initially unknown wavelengths .",
    "poor sky subtraction affects most those spectra with low s / n , and the fainter quasars , including those at high redshift ( @xmath54 ) , suffer from significant contamination from sky subtraction residuals .",
    "the extended wavelength range of the sdss spectra combined with a redshift range for the quasars of @xmath55 , allows the construction of composite spectra over unprecedented ranges in rest - frame wavelength and luminosity @xcite .",
    "however , the number of quasars that occupy the extremes of the wavelength and luminosity ranges is relatively small and the sky subtraction residuals at @xmath56  limit both the determination of the continuum properties and the detection of weak emission features .",
    "we create composite spectra of all quasars in the sdss with @xmath57 , in redshift slices of @xmath58 .",
    "each input quasar spectrum is normalised to have a mean flux of 1 between @xmath59 , prior to combination using an arithmetic mean .",
    "[ fig_qsocomp ] illustrates how the sky - residual subtraction technique improves the quality of these composites .",
    "subtracting the underlying spectrum using a median filter and removing the centers of emission lines from the calculation , we calculate the error weighted absolute deviation from zero on the composites with and without sky - residual subtraction .",
    "the average improvement in s / n over the entire wavelength region due to the sky subtraction is about 20% for all redshift bins .",
    "the sdss spectra represent a vast improvement in data quantity , quality and wavelength coverage over previous surveys .",
    "the sky - subtraction carried out by the sdss reduction pipeline has in general achieved excellent results , however the common problem of the subtraction of undersampled oh emission lines results in substantial systematic residuals over almost half the spectral range .",
    "a technique is presented to remove these residual oh features , based on a principal component analysis of the observed - frame sky spectra which have been sky subtracted along with all other spectra in the sdss data releases .",
    "the scheme takes advantage of the high degree of correlation between the residuals in order to produce corrected spectra whose noise properties are very close to the limit set by counting statistics .",
    "the sky - residual subtraction scheme is applied to the sdss dr2 catalogue and is immediately applicable to the recent sdss dr3 release .",
    "the precise form of the implementation depends on the spectral energy distributions of the target objects and the scientific goal of any analysis . as a consequence ,",
    "the main classes of target objects , galaxies , quasars and stars , are treated slightly differently .",
    "constructing composites of high - redshift quasars before and after sky - residual subtraction illustrates the significant increase in the overall s / n of the spectra that is achieved .",
    "the application of the procedure when narrow absorption or emission features are present requires the use of a mask to prevent the sky - subtraction scheme suffering from bias .",
    "both the calcium - triplet in low redshift galaxies and metal absorption lines in damped ly@xmath2 systems at high redshifts fall in the wavelength range affected by the oh - forest ( @xmath60 ) . by employing these two rather different examples it is shown that masking absorption and emission features prior to the reconstruction of the sky - residual signal in each spectrum ensures that the properties of the features themselves are not systematically biased in the resulting sky - residual subtracted spectra .    the significant improvement in s / n achieved over some @xmath5  of a large fraction of sdss spectra , particularly for the fainter objects such as the high - redshift quasars , should benefit a wide range of scientific investigations .",
    "we have made available datafiles , idl code and a comprehensive guide on using the code , with which the procedure can be applied to all sdss spectra ( http://www.ast.cam.ac.uk/research/downloads + /code",
    "further improvements should be possible if the sky - residual subtraction procedure is adapted to run on the sdss spectra using the original noise arrays based on counting statistics alone .",
    "the nature of the sky - residual subtraction scheme is such that application to other large samples of spectra should be relatively straightforward .",
    "many thanks to eric switzer , david schlegel and patrick mcdonald of the sdss team who made available information and answered questions about the sdss spectroscopic reduction pipeline .",
    "we would also like to thank the referee , simon morris , for his careful reading of the manuscript and helpful comments and suggestions .",
    "vw acknowledges the award of a pparc research studentship .",
    "funding for the sloan digital sky survey ( sdss ) has been provided by the alfred p. sloan foundation , the participating institutions , the national aeronautics and space administration , the national science foundation , the u.s .",
    "department of energy , the japanese monbukagakusho , and the max planck society .",
    "the sdss web site is http://www.sdss.org/.    the sdss is managed by the astrophysical research consortium ( arc ) for the participating institutions .",
    "the participating institutions are the university of chicago , fermilab , the institute for advanced study , the japan participation group , the johns hopkins university , los alamos national laboratory , the max - planck - institute for astronomy ( mpia ) , the max - planck - institute for astrophysics ( mpa ) , new mexico state university , university of pittsburgh , princeton university , the united states naval observatory , and the university of washington .",
    "k. , adelman - mccarthy j.  k. , ag \" ueros m.  a. , et al .",
    "( the sdss collaboration ) , 2004a , , 128 , 502    k. , adelman - mccarthy j.  k. , ag \" ueros m.  a. , et al .",
    "( the sdss collaboration ) , 2004b , preprint ( astro - ph/0410239 )    a.  s. , burles s. , schlegel d.  j. , eisenstein d.  j. , brinkmann j. , 2004 , , 127 , 1860    a.  j. , szalay a.  s. , 1999 , , 117 , 2052    a.  j. , szalay a.  s. , bershady m.  a. , kinney a.  l. , calzetti d. , 1995 , , 110 , 1071    a.  i. , terlevich e. , terlevich r. , 1989 , , 239 , 325    a. , 1984 , , 286 , 97    g. , fall s.  m. , 1984 , , 206 , 453    s.  r. , lahav o. , maddox s.  j. , 1996 , , 283 , 651    p.  j. , hewett p.  c. , foltz c.  b. , chaffee f.  h. , 1992 , , 398 , 476    hewett p.  c. , irwin m.  j. , bunclark p. , bridgeland m.  t. , kibblewhite e.  j. , he x.  t. ,",
    "smith m.  g. , 1985 , , 213 , 971    d.  d. , 2003 , , 115 , 688    m.  g. , 1975 , multivariate analysis .",
    "griffen , london    m.  j. , mink d.  j. , 2000 , , 533 , l183",
    "d.  s. , coil a.  l. , conselice c.  j. , cooper m.  c. , davis m. , ellis r.  s. , faber s.  m. , finkbeiner d.  p. , gerke b. , guhathakurta p. , kaiser n. , koo d.  c. , newman j.  a. , phillips a.  c. , steidel c.  c. , weiner b.  j. , willmer c.  n.  a. , yan r. , 2003 , , 599 , 997    d.  s. , lahav o. , baldry i.  k. , et al .",
    "( the 2dfgrs team ) 2002 , , 333 , 133    f. , heck a. , 1987 , multivariate data analysis .",
    "astrophysics and space science library , dordrecht : reidel , 1987    r.  n. , long d.  c. , snedden s.  a. , et al .",
    "( for the sdss collaboration ) , 2004 , preprint ( astro - ph/0408167 )    prochaska j.  x. , herbert - fort s. , 2004 , pasp , 116 , 622    g.  a. , hesser j.  e. , stetson p.  b. , mateo m. , simard l. , bolte m. , friel e.  d. , copin y. , 1997 , , 109 , 883    c. , lupton r.  h. , bernardi m. , et al .",
    "( the sdss collaboration ) , 2002 , , 123 , 485    e. , diaz a.  i. , terlevich r. , 1990 , , 242 , 271    d. , yip c. , connolly a. , jester s. , stoughton c. , 2004 , in asp conference series , volume 311 p.  21",
    "c.  a. , 1983 , , 51 , 443    c.  w. , connolly a.  j. , szalay a.  s. , budav ' ari t. , subbarao m. , frieman j.  a. , nichol r.  c. , hopkins a.  m. , york d.  g. , okamura s. , brinkmann j. , csabai i. , thakar a.  r. , fukugita m. , ivezi ' c  .",
    ", 2004a , , 128 , 585    c.  w. , connolly a.  j. , vanden berk d.  e. , ma z. , frieman j.  a. , subbarao m. , szalay a.  s. , richards g.  t. , hall p.  b. , schneider d.  p. , hopkins a.  m. , trump j. , brinkmann j. , 2004b , aj , 128 , 2603    d.  g. , adelman j. , anderson j.  e. , et al .",
    "( the sdss collaboration ) , 2000 , , 120 , 1579",
    "for completeness we include the basic mathematics of pca .",
    "further details can be found in @xcite and , for astronomical applications , in @xcite and @xcite . for an @xmath61 spectra by @xmath38 pixel data array @xmath62 , where @xmath63 , @xmath64 and @xmath65 , the covariance matrix is c_jk = _",
    "i=1^n x_ijx_ik .",
    "the eigenvectors ( @xmath66 , principal components in the language of this paper ) and eigenvalues ( @xmath67 ) of the covariance matrix are _ j",
    "= _ j _ j. it can be shown that @xmath68 is the axis along which the variance is maximal , @xmath69 is the axis with second greatest variance , and so on until @xmath70 has the least variance .",
    "the principal component amplitudes for each noise weighted input spectrum @xmath71 are given by [ eq_pcs ] a_j = _",
    "j.    the @xmath38 eigenvectors can be used as a basis set on which to project any spectrum of the same dimensions .",
    "the principal component amplitudes of this projection and the eigenvectors can then reconstruct the input spectrum from the templates : [ eq_recon ] f_k = _ j=1^m",
    "the reconstructed spectrum only contains information present in the templates , which may or may not be a fair representation of the input spectrum . in general as the variance of the eigenvectors decrease , so does the useful information contained in the spectra , allowing pca to be a useful form of data compression .",
    "the exact number of eigenvectors required to reconstruct the input spectrum satisfactorily depends on the dataset and purpose of the analysis ."
  ],
  "abstract_text": [
    "<S> the sloan digital sky survey ( sdss ) currently provides by far the largest homogeneous sample of intermediate signal - to - noise ratio ( s / n ) optical spectra of galaxies and quasars . </S>",
    "<S> the fully automated sdss spectroscopic reduction pipeline has provided spectra of unprecedented quality that cover the wavelength range @xmath0 . however , in common with spectra from virtually all multi - object surveys employing fibres , there remain significant systematic residuals in many of the spectra due to the incomplete subtraction of the strong oh sky emission lines longward of @xmath1 . </S>",
    "<S> these sky lines affect almost half the wavelength range of the sdss spectra , and the s / n over substantial wavelength regions in many spectra is reduced by more than a factor of 2 over that expected from counting statistics . </S>",
    "<S> we present a method to automatically remove the sky residual signal , using a principal component analysis ( pca ) which takes advantage of the correlation in the form of the sky subtraction residuals present in each spectrum . </S>",
    "<S> application of the method results in spectra with essentially no evidence for degradation due to the incomplete subtraction of oh emission features . a dramatic improvement in the quality of a substantial number of spectra , particularly those of faint objects such as the bulk of the high - redshift quasars , </S>",
    "<S> is achieved . </S>",
    "<S> we make available idl code and documentation to implement the sky residual subtraction scheme on sdss spectra included in the public data releases . to ensure that absorption and emission features intrinsic to the object spectra do not affect the subtraction procedure line masks </S>",
    "<S> must be created that depend on the scientific application of interest . </S>",
    "<S> we illustrate the power of the sky - residual subtraction scheme using samples of sdss galaxy and quasar spectra , presenting tests involving the near - infrared caii triplet absorption , metal absorption line features in damped ly@xmath2 systems and composite spectra of high - redshift quasars .    </S>",
    "<S> methods : statistical  surveys  techniques : spectroscopic </S>"
  ]
}