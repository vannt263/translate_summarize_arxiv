{
  "article_text": [
    "the palomar transient factory ( ptf ; * ? ? ? * ) and its successor survey currently underway , the _ intermediate _ palomar transient factory ( iptf ; * ? ? ?",
    "* ) have been advancing our knowledge of the transient , variable , and dynamic sky at optical wavelengths since march 2009 . from new classes of supernovae @xcite , identifying gamma - ray burst optical afterglows @xcite and counterparts to gravitational wave",
    "triggers @xcite , exotic stellar outbursts @xcite , milky way tomography @xcite to near - earth asteroids @xcite and comets @xcite , iptf continues to deliver[multiblock footnote omitted ] , serving as a testbed for the development of future time - domain surveys .",
    "iptf uses a 92-megapixel camera mosaicked into eleven functional 2048@xmath24096 ccds covering @xmath3 on the palomar 48-inch samuel oschin schmidt telescope .",
    "the single exposures reach a depth of ( mould ) @xmath4 mag ( 5@xmath5 ) in 60 sec .",
    "the pixel scale is @xmath6 and the image quality is @xmath7 ( median fwhm ) , implying the point spread function ( psf ) is better than critically sampled slightly more than 50% of the time .",
    "further details of the hardware , survey design , and on - sky performance are described in @xcite and @xcite .",
    "an overview of the image pre - processing and photometry pipelines , and archival system is described in @xcite .",
    "the near real - time discovery of transients from iptf imaging data is currently performed using an image differencing pipeline at the national energy research scientific computing center ( nersc ; * ? ? ?",
    "new incoming images are astrometrically and instrumentally calibrated , then aligned , psf - matched , and differenced with deeper _ reference _ images supplied by the infrared processing and analysis center ( ipac , caltech ; * ? ? ?",
    "transient candidates are extracted from the differenced images then vetted using a classification engine @xcite .",
    "the nersc infrastructure has contributed immensely to the success of ptf and iptf .",
    "we have implemented an enhanced version of the discovery pipeline to complement the pipeline at nersc . in 2017",
    ", the iptf project will be replaced by the zwicky transient facility ( ztf ) using a new camera on the same telescope @xcite .",
    "the ztf camera will have a field - of - view of @xmath8 square degrees , enabling a full scan of the northern visible sky every night , at a rate @xmath9 times faster than iptf to similar depths .",
    "the massive high - rate data stream and volume expected from ztf will require advancements in algorithms and data - management practices despite the ( inevitable ) growth in hardware technology .",
    "this will pave the way to the large synoptic survey telescope ( lsst ; * ? ? ?",
    "* ) that is expected to yield at least @xmath10 as many astrophysical transients per image exposure than ztf . in anticipation of this data deluge , we have embarked on a new efficient discovery pipeline and infrastructure at ipac .",
    "our design philosophy is flexibility , i.e. , being able to operate in a range of complex astrophysical environments ( including the galactic plane ) , robustness to instrumental glitches , adaptability to a wide range of atmospheric seeing and transparency , minimal tuning ( unless warranted by instrumental changes ) , optimality ( in the signal - to - noise sense ) , reliability in extracted candidates to moderately low s / n levels , and fast delivery of vetted candidates to enable follow - up in near real - time .",
    "searches for astrophysical transients ( by virtue of changes in flux and/or position ) have traditionally been conducted using either of two approaches .",
    "the first involves differencing of astrometrically - aligned , psf - matched images from two epochs : the _ science _ or _ target _",
    "image containing the potential transient sources , and a deeper _ reference _ or _ template _ image serving as a static representation of the sky , for example , defined from an average of images from multiple historical epochs .",
    "the difference image is then thresholded to find and measure excess signals , i.e , the transient candidates .",
    "this approach was ( and in some cases continues to be ) used by numerous synoptic surveys , e.g. , ogle @xcite , rotse @xcite , la silla - quest @xcite , pan - starrs @xcite , and ptf @xcite .",
    "although simple in theory , a challenging aspect of discovery via image differencing is the prior matching of psfs between the input images .",
    "this has lead to an intensive , ongoing research effort ( e.g. , * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "* ; * ? ? ?",
    "the ultimate goal is the elimination of systematic instrumental residuals , e.g. , induced by non - optimal calibrations and/or psf - matching upstream .",
    "these would otherwise contaminate lists of extracted transient candidates , i.e. , the false positives that would need to be dealt with later ( see below ) . in practice",
    ", one strives to minimize their occurence in difference images such that in a global sense , the resulting pixel fluctuations and photometric uncertainties of _ bona fide _ flux transients approach expectations from poisson noise and/or detector read - noise .",
    "the second approach involves positionally - matching source catalogs extracted from images at different epochs and searching for large flux differences between the epochs , e.g. , as used by the catalina real - time transient survey ( crts ; * ? ? ?",
    "this method avoids systematics from color - correlated source - position misalignments due to differential chromatic refraction , an effect that can be severe for some facilities .",
    "however , this method requires a relatively large flux - difference threshold to ensure reliability .",
    "this is at the expense of a higher missed detection rate ( incompleteness ) at low flux levels , particularly in regions with a complex background and/or high source - density ( e.g. , the galactic plane ) where positional - matching is a challenge .",
    "on the other hand , assuming optimally calibrated and instrumentally - matched inputs , image differencing excels in regions where source confusion is high and/or where complex , fast - varying backgrounds are present ( e.g. , near or within galaxies ) . due to its adaptability to a wide range of astrophysical environments ,",
    "the ptf project adopted image differencing as its primary means for discovery .    following",
    "the extraction of transient candidates from differenced images , a somewhat daunting problem is deciding which are _ bogus _",
    "( i.e. , spurious ) or _ real _ and worthy of further study .",
    "the existing iptf discovery pipeline at nersc accomplishes this using a _ supervised _ machine - learned ( ml ) classifier @xcite . here",
    ", a pre - labelled training set of previously discovered _ real _ transients are first fit to a two - class ( _ real or bogus _ ) non - parametric model described by a number of selected source features ( or metrics ) .",
    "this model is then used to predict the class ( _ real _ or _ bogus _ ) of future candidates according to some probability threshold .",
    "the probabilities are also referred to as _",
    "( or quality ) scores .",
    "the iptf discovery pipeline at nersc typically yields a few to ten _ real _ `` interesting '' transients per night ( excluding solar - system objects and periodic or reoccuring variables in regions with a high stellar density ) . for ztf , we expect at least 100 such transients per night .",
    "currently however , real iptf transients can be outnumbered by spurious candidates ( false positives ) by more than two orders of magnitude , despite efforts to minimize their incidence through careful pre - calibration .",
    "the problem gets worse if one is interested in finding the rare gems down to low s",
    "/ n levels ( e.g. , * ? ? ?",
    "depending on the science goals , the vetted candidates need to be delivered in a timely manner to the respective science working groups for follow - up . at nersc",
    ", this currently takes @xmath11 minutes since observation .",
    "the goal is to get this below @xmath12 minutes .",
    "large numbers of false - positives can strain any machine - learned vetting process and affect its reliability @xcite .",
    "it is crucial that the vetting process be efficient and reliable .",
    "we have developed an automated image - differencing , transient - extraction and vetting system at ipac ; hereafter , the ipac / iptf discovery engine ( or ide ) .",
    "this infrastructure is currently in use for iptf and is expected to be a foundation for ztf in future .",
    "we have 6@xmath13 years of ptf science data in hand ( ongoing with iptf ) and an experienced team at nersc that aided in developing and refining all aspects of a robust discovery engine  from instrumental calibration to vetted transient candidates .",
    "guided by previous implementations of the image subtraction problem , this paper reviews our algorithms , optimization strategies , experiences , and liens .",
    "we also describe our probabilistic ( _ real__bogus _ ) classification scheme for vetting transient candidates , quality assurance ( qa ) metrics , and database ( db ) schema .",
    "we note that two of the core pipeline steps in ide : ( i ) image - differencing ( that includes pre - conditioning of image inputs ) , and ( ii ) extraction of _ raw _ transient candidates therefrom , are both implemented in a stand - alone software module called ptfide[multiblock footnote omitted ] . in this paper",
    ", we use the acronym ptfide when referring to these specific processing steps , otherwise , we use ide when referring to the overall processing system .",
    "the latter includes all pre - calibration steps ( prior to ptfide ) , machine - learned vetting and archival steps ( post - ptfide ) .",
    "furthermore , when referring to astrophysical transients , we use the term `` transient '' in a generic sense , i.e. , all types of flux - excesses that can be detected in difference images ( in both the positive and negative sense , relative to a reference image template ) : moving objects , periodic or aperiodic variable sources , or short - lived ( fast ) events . the goal of ide is to deliver reliable transient candidates to the various science working groups for further follow - up . from hereon , these science working groups will be referred to as `` science marshals '' , or simply marshals .",
    "this paper is organized as follows . in section  [ realtpl ]",
    "we give an overview of ide and provide references for more information on each subsystem , both in this paper and elsewhere .",
    "section  [ revide ] gives a broad overview of the image differencing and extraction module ptfide and its dependencies : input parameters , reference - image building , and output products .",
    "section  [ psteps ] expands on the specific processing steps in ptfide : gain and background matching , astrometric refinement , reference - image resampling , and psf - matching .",
    "this includes a summary of all image - based and transient - candidate source metrics , and their use in deriving simple initial quality scores .",
    "section  [ schema ] reviews the db schema for storing all difference image - based and source - based metrics . the machine - learned vetting infrastructure , which includes training , tuning , and its overall performance is described in section  [ ml ] .",
    "lessons learned during the course of development and testing are given in section  [ lessons ] .",
    "future and potential enhancements are discussed in section  [ enhance ] and conclusions are given in section  [ conc ] .",
    "the raw camera - image files are first sent from the palomar 48-inch samuel oschin schmidt telescope to the san diego supercomputing center via a @xmath14 mbit / s microwave link and then pushed to caltech and ipac over the internet ( bandwidth is @xmath15 gbit / s ) . at ipac",
    ", the camera - image files are ingested into an archive and associated metadata are stored in a relational database for fast retrieval and processing soon thereafter ( see below ) .",
    "figure  [ fig : ideflow ] gives an overview of the near real - time discovery pipeline .",
    "an executive pipeline wrapper controls the various steps : preprocessing which performs basic instrumental and astrometric calibration per ccd image ( _ light purple _ boxes ) ; ptfide  the image - differencing and transient extraction module ( _ red _ boxes ) ; then returning to the pipeline executive for archiving , db - loading , and machine - learned vetting ( _ light purple _ boxes ) .",
    "the preprocessing steps are from a stripped down version of the ptf / iptf _ frame - processing pipeline_. this executes asynchronously and independently of ide following ingestion of an entire night s worth of image data .",
    "the purpose of this pipeline is to provide accurately calibrated images and source catalogs for future public distribution .",
    "this pipeline and the ide preprocessing steps borrowed therefrom ( _ light purple _ boxes in figure  [ fig : ideflow ] ) are described in detail in @xcite . below we summarize the major processing steps .",
    "the steps specific to ptfide ( _ red _ boxes ) are expanded in sections  [ revide][ml ] .",
    "operational details and tools used by the various science marshals ( _ green _ boxes ) will be discussed in future papers . in particular , the streak - detection functionality that is designed to detect moving objects in difference images ,",
    "i.e. , that streak in individual exposures is described in @xcite .",
    "the 92-megapixel raw camera - image files ( one per exposure ) are processed by the real - time pipeline soon after they are ingested , check - summed , and registered in the database at ipac .",
    "the ingest process also loads a _",
    "jobs _ database table that is automatically queried by the pipeline executive to initiate the camera - splitting pipeline @xcite .",
    "this pipeline splits the camera - images into twelve 17 mb ccd image files ( with overscan regions included ) , and noting that one of the ccds is defective .",
    "an initial astrometric solution is derived and attached to their fits[multiblock footnote omitted ] headers .",
    "this astrometric solution is not the final ( and best ) calibration attached to the ccd images prior to image - differencing with ptfide .",
    "it is used to support source - catalog overlays , quick - look image visualizations , and quality assurance ( qa ) from the archive .",
    "the individual raw ccd frames in fits format are copied to a local sandbox directory and associated metadata ( including quality metrics and image usability indicators ) are stored in a database to facilitate retrieval for the next processing steps .    a number of preprocessing and instrumental calibration steps are then applied to the raw ccd image .",
    "these include a dynamic ( floating ) bias correction and a static bias correction , a flat - field ( pixel - to - pixel responsivity ) correction , and cropping to remove overscan regions .",
    "the static bias and flat - field calibration maps are retrieved from an archive .",
    "these are generally the latest ( closest - in - time ) products available for the night being processed , i.e. , that were made by combining data from a prior night .",
    "for the flat - field calibration in particular , quality metrics are used to check that the responsivity pattern falls within the range expected for a specific ccd and filter . if not , a pristine superflat is used .",
    "this preprocessing also initiates and populates a 16-bit mask image to record bad hardware pixels for the specific ccd frame , badly calibrated pixels , and saturated pixels .",
    "this mask is further augmented below to record image artifacts and object detections .    at this stage",
    ", we have a bias - corrected , flattened ccd image and accompanying mask image .",
    "sources are then extracted from the ccd image using _ sextractor _ @xcite primarily to support astrometric calibration  the most important calibration step in the real - time pipeline since its accuracy is crucial to attaining good quality difference images ( section  [ garef ] ) .",
    "the _ sextractor _ module is executed twice .",
    "the first run is to compute an accurate value of the overall image seeing ( point - source fwhm ) from the mode of a filtered distribution of individual source fwhm values .",
    "this estimate is then used to support source - detection in the second _ sextractor _ run via a point - source matched filter .",
    "the first _ sextractor _ run also folds in the object detections into the image mask , or rather the contiguous pixels contributing to each object above the specified threshold .",
    "the _ createtrackimage _ module is also executed to detect satellite and aircraft tracks in the ccd image and record their locations in the image mask .",
    "these occur with a frequency of typically several times per night and the same track can cross multiple ccds .",
    "metrics for each track are also computed ( e.g. , length and median intensity ) and stored in a database table . for details on track identification and characterization , see @xcite .",
    "the second _ sextractor _ run generates a source catalog for input into the astrometric calibration step .",
    "astrometric calibration is initially performed using _ scamp _ @xcite .",
    "_ scamp _ is executed using one of two possible astrometric reference catalogs as input : if the ccd image overlaps entirely with a field from the sloan digital sky survey ( sdss ) , the _ sdss - dr9 _ catalog @xcite is used ; otherwise , the _ ucac4 _ catalog @xcite is used .",
    "if _ scamp _ fails to find an astrometric solution using either of these catalogs , it is rerun with the _ usno - b1 _ catalog @xcite .",
    "in addition to solving for the standard world coordinate system ( wcs ) first - order terms ( for a gnomonic sky - projection ; * ? ? ?",
    "* ) , _ scamp _ simultaneously solves for field - of - view distortion using the _ pv _ polynomial convention on a per - image basis .",
    "the solution implicitly captures both the fixed camera - distortion and any variable atmospheric refraction effects at the time of exposure .",
    "the wcs solution and _ pv _ distortion coefficients are written to the ccd image fits header . to enable other downstream ( as well as generic analysis ) software to map from pixel to sky coordinates and vice - versa , the _ pv _ coefficients are converted to the _ sip _ representation @xcite using the _ pv2sip _ module @xcite . the associated _ sip _ coefficients are also written to the fits header .",
    "the astrometric ( and distortion ) solution from _ scamp _ is then validated .",
    "the first validation step coarsely checks that the standard first - order wcs terms ( pointing , rotation , and scale ) are within their expected ranges according to specific prior values .",
    "the second validation step involves re - extracting sources from the astrometrically - calibrated ccd image ( again using _ sextractor _ ) and matching them to a filtered subset of sources from the _",
    "2mass _ point source catalog ( psc ; * ? ? ?",
    "a matching radius of @xmath16 is used and a minimum of 20 2mass matches must be present . if the number of matches exceeds this minimum , the axial root - mean - squared ( rms ) position differences are root - sum - squared ( rssd ) and compared against a threshold that is dependent on galactic latitude .",
    "this threshold ( @xmath17 ) lies in the range @xmath18 corresponding to galactic latitudes @xmath19 .",
    "the threshold is interpolated from a look - up table of predetermined values according to the galactic latitude of the input image .",
    "the reason for a latitude - dependent threshold is due to the less reliable rms estimates in position differences following source matching when the source density is high .",
    "we are less tolerant of larger rms estimates in this regime due to the higher probability of false matches .",
    "if the above validation checks on the astrometry are not satisfied , another attempt is made at the astrometric calibration , this time by executing the _ astrometry.net _ module @xcite .",
    "this module uses the 2mass psc as the astrometric - reference catalog .",
    "_ astrometry.net _ also solves for distortion on a per - image basis , however , its representation is only in the _ sip _ format . to ensure proper execution of other downstream pipeline modules that depend exclusively on the _ pv _ representation , the _ sip _ coefficients are converted to _ pv _ equivalents using the _ sip2pv _ module @xcite and written to the fits header .",
    "the solution from _",
    "_ is validated in the same manner as above using the 2mass psc .",
    "if the acceptability criteria are still not satisfied , a bit - flag is set in a database table for use downstream .",
    "metrics to assess the astrometric performance on each image are computed and also stored in the database to facilitate future analysis and trending ( for details , see * ? ? ?",
    "* ) .",
    "figure  [ fig : astrom]a quantifies the astrometric performance of the real - time pipeline for 68,310 iptf ccd images acquired from 2015 january 1 to 2015 may 1 that used the sdss - dr9 catalog in their _ scamp _ solution .",
    "this catalog covers @xmath20 14,555 @xmath21 at galactic latitudes of typically @xmath22 and has an overall astrometric accuracy ( rms per axis ) of @xmath23 milli - arcseconds ( mas ) with respect to earlier _ ucac _ releases @xcite .",
    "the median rms per iptf ccd per axis is typically 115 mas with respect to sdss - dr9 . the astrometric performance outside the sdss - dr9 footprint ( calibrated using either ucac4 or usno - b1 ; see above ) is similar , except however for exposures observed in regions with a high source - density ( e.g. , the galactic plane ) where systematics are more prevalent .",
    "these systematics are currently being addressed since iptf includes a number galactic - plane science programs .",
    "figure  [ fig : astrom]b shows the rms distributions for a subset of 24,168 ccd images from the same sdss - dr9 overlap region with respect to the 2mass psc . here ,",
    "only images containing @xmath24 200 2mass matches each were used .",
    "the median astrometric accuracy with respect to 2mass degrades to @xmath20 190 mas per axis .",
    "this larger rms is somewhat expected since the 2mass psc has an accuracy of typically 150 - 200 mas @xcite .",
    "preprocessing in the real - time pipeline also includes a step to detect and mask artifacts induced by bright - source reflections in the telescope optics , primarily ghosts and halos .",
    "the ghosts are due to bright sources lying off the telescope s optical axis , while halos are more coincident with the offending source .",
    "these features are located by first searching for bright ( parent ) stars from the tycho-2 catalog @xcite with @xmath25 mag .",
    "the positions of ghosts are then isolated using a pre - determined geometric mapping from the parent stars to expected ghost positions .",
    "circular areas are flagged in the ccd bit - mask image to indicate probable ghosts and halos .",
    "given the ghost and halo sizes vary with the brightness of the parent star , a conservative maximally - sized masking area is used .",
    "the positions of ghosts , halos and their parent stars are stored in the database to facilitate future analysis .",
    "lastly , the preprocessing phase computes a number of qa metrics for the image pixels and accompanying mask , a summary of which can be found in @xcite .",
    "these are also loaded into the database .",
    "there is no absolute photometric calibration in the preprocessing phase of the real - time pipeline to assign image - specific photometric zeropoints .",
    "instead , the raw pixel signals are later throughput ( gain)-matched to a reference image template during ptfide processing using sources extracted therefrom ( section  [ garef ] ) .",
    "this reference image has an associated photometric zeropoint and therefore serves as the generic zeropoint for all real - time products that are matched to it , including the difference image products downstream . for details ,",
    "see sections  [ refcon ] and  [ psffit ] . for an overview on the performance of the initial photometric calibration of the ccd images ( on which the reference and difference - image products ultimately depend ) , see @xcite .",
    "figure  [ fig : timing ] shows the typical durations of the primary steps in the real - time pipeline : from acquisition of a camera exposure to vetted candidates , ready to be examined by the science marshals .",
    "the median total time lag since exposure acquisition ( figure  [ fig : timing]b ) is @xmath20 16 minutes and the @xmath26 percentile is @xmath27 22 minutes . when broken down into the various steps , the bulk of the lag is in the transfer of image data from the telescope to ipac ( @xmath20 9 minutes ) .",
    "this includes database ingestion and archiving , which amount to no more than several seconds per camera exposure .",
    "the preprocessing , ptfide and final archival steps amount to no more than @xmath20 7 minutes , although there is a long tail in the ptfide runtime which we attribute to the extraction and processing of transient candidates from `` bad '' difference - images , i.e. , containing an excess of residual artifacts ( section  [ train ] ) .",
    "the timing metrics shown in figure  [ fig : timing ] are those inferred at the time of writing using 1340 camera - image files and all eleven ccd images therein .",
    "the overall lag is expected to decrease in the near future , in particular in the transfer of image - data from the telescope to ipac .    at the time of writing ( pertaining to iptf operations ) , the ide pipeline executes on a linux cluster of 23 machines consisting of 232 64-bit physical cpu cores in total : 11 machines have 8 intel^^ xeon^^ cores running at 3.0 ghz each and the remaining 12 machines have 12 similar cores running at 2.4 ghz each .",
    "all the machines , file and database servers are connected by a 10 gbit network .",
    "given that the 12-core machines can admit two threads per core , this cluster can in principle allow for 376 concurrent processes .",
    "however , since much of the processing involves a considerable amount of disk i / o , we achieve close to maximum throughput with only one thread per physical core , and therefore we usually execute at most 232 simultaneous threads . as raw camera - image files",
    "are received during the night , multiple instances of the camera - splitting pipeline are first run across all idle processor cores ( until filled ) to generate the individual raw ccd - images .",
    "these images then enter the processing queue and the level of core - parallelism now occurs at the ccd - image level through all the remaining pipeline steps ( figure  [ fig : ideflow ] ) .",
    "the ide pipeline was designed to be flexible enough to also process archival ( preprocessed ) image data .",
    "this mode facilitates pipeline tuning , iterative training of machined - learned classifiers in response to changing detector properties and/or science goals , but it also supports archival research in general , i.e. , ad - hoc discovery projects using different pipeline parameters and thresholds .",
    "this offline execution mode only runs the ptfide steps ( _ red _ boxes in figure  [ fig : ideflow ] ) using preprocessed image data that were previously instrumentally - calibrated and archived by the regular ptf / iptf _ frame - processing pipeline _ @xcite .",
    "this is because the preprocessed intermediate products from the initial phase of the ide pipeline ( _ light purple _ boxes in figure  [ fig : ideflow ] ) are not stored in a long - term archive .    to summarize",
    ", we have given a general overview of the near real - time ide pipeline , with particular emphasis on the preprocessing steps needed to generate instrumentally and astrometrically calibrated ccd - images for input into the image - differencing and transient extraction module ( ptfide ) .",
    "the primary outputs from the preprocessing step are a calibrated _ science _ image exposure , an accompanying _ bit - mask _ image , and metrics that quantify the astrometric performance and quality of the image - pixel data .",
    "the details on how these metrics and products are used in ptfide are discussed in section  [ psteps ] .",
    "this section gives a broad overview of the ptfide software[multiblock footnote omitted ] , dependencies , design assumptions , input data and formats , tunable parameters , and outputs  both primary products for archival and ancillary products for debug and analysis .",
    "ptfide is a standalone unix command - line tool written in perl .",
    "it calls a number of software executables written in c , c`++ ` and fortran . for a summary of the dependencies ,",
    "see section  [ swdep ] . the software can be built and configured to run under most linux or unix - like operating systems .",
    "figure  [ fig : ptfideflow ] summarizes the main processing steps in ptfide , from preparing the inputs , to extracted transient candidates and metrics ready for loading into a relational database .",
    "a summary of all input files , parameters , and their default values is given in section  [ paramsum ] .",
    "one of the most important inputs is the _ reference image _ and its accompanying _ source catalog_. requirements regarding its construction are given in section  [ refcon ] .",
    "output products , formats , and their level of importance are summarized in section  [ prodsum ] .",
    "the details of each computational step in figure  [ fig : ptfideflow ] are expanded in section  [ psteps ] .          to expedite the delivery of science quality products following the commencement of iptf , some of the processing steps in ptfide leverage existing astronomical software tools .",
    "this is mostly heritage software that has been well tested by the astronomical community and refined over time .",
    "table  [ tab : sw ] summarizes the external ( third - party ) software components used in ptfide and other dependencies .",
    "one of the design goals was robustness against missing or corrupted input data with appropriate error handling and reporting upon pipeline termination .",
    "depending on the error , any missing ( or out - of - range ) data or associated metadata are replaced with default values in an attempt to salvage as many products as possible .",
    "warnings are issued and logged if these occur .",
    "furthermore , different pipeline exit codes are assigned according to the different anomalies ( fatal and benign ) encountered in processing .",
    "these status codes are stored as a bit - string in a database table to enable follow - up or to avoid querying unusable ( or non - optimal ) science products in future .",
    "another design consideration was the ability to generate as many intermediate products and write as much information as possible from each processing step ( section  [ prodsum ] ) .",
    "this was to facilitate offline debugging and tuning since many of the steps have complex interdependencies .",
    "this debug mode is controlled by a command - line switch and is typically turned off in operations to minimize runtime .",
    "the base language in ptfide is perl .",
    "this code executes both the external software modules and performs its own image - processing computations through use of the perl data language ( pdl ; * ? ? ?",
    "pdl is an object - oriented extension to perl5 that is freely available as an add - on module .",
    "pdl is optimized for computations on large multidimensional data sets by making use of the hyper - threading capabilities of modern processor technologies .",
    "that is , pdl has its own threading engine that uses constructs from linear algebra to process large arrays as efficiently as possible using parallel computations .",
    "this is crucial since most of the steps in ptfide are cpu - bound .",
    "this low - level parallelism occurs on the individual processor cores where our basic processing unit is a single ccd - image",
    ". a higher level of parallelism is achieved by using all of the @xmath28 cpu cores in our linux cluster ( described in section  [ realtpl ] ) .",
    "here we typically execute 232 simultaneous threads ( one ccd - image per core at any time ) .",
    "this gives us close to maximum throughput .",
    "lll & @xmath29 & core language for scripting and performing arithmetic operations .",
    "+ _ pdl _ & @xmath30 & perl module for vectorized image processing ; built with bad - value and gsl support .",
    "+ _ gsl _ & @xmath31 & gnu scientific library ( numerical library ) . + _ astro - wcs - libwcs _ & @xmath32 & perl module to support world coordinate system ( wcs ) transformations .",
    "+ _ ptfutils _ , _ pars _ & 1.0 & in - house developed perl modules specific to ptf data processing . + _",
    "xy2xytrans _ & 2.0 & for fast image - to - image pixel position transformations .",
    "+ _ libtwoplane _ & 1.0 & library to support _ xy2xytrans _ module .",
    "+ _ wcstools _ & @xmath33 & contains wcs library to support multiple modules listed here .",
    "+ _ cfitsio _ & @xmath34 & fits file - manipulation library to support multiple modules listed here .",
    "+ _ sextractor _ & 2.8.6 & for initial source extraction to support internal source - matching steps .",
    "+ _ swarp _ & 2.19.1 & for image resampling and interpolation using wcs .",
    "+ _ daophot _ & ii , 1/15/2004 & source detection , aperture photometry , and psf - estimation .",
    "+ _ allstar _ & ii , 2/7/2001 & psf - fit photometry and support for psf - estimation ( included in _",
    "package ) .",
    "+      ptfide is driven by the perl script _",
    "ptfide.pl_. the inputs can be broadly separated into the following : an instrumentally - calibrated ccd - image exposure ( the _ science _ image ) ; an accompanying bit - mask ( pixel - status ) image ; a spatially overlapping _ reference _ image ; an accompanying _ source catalog _ for the reference image ; configuration files for the various external software modules ; processing parameters , thresholds , and control switches .",
    "all image files are in fits format ( defined in section  [ realtpl ] ) .",
    "input parameters and thresholds may be supplied on either the _ ptfide.pl _ command - line or in a configuration file , while image fits - file names , other configuration files , and switches can only be supplied on the command - line .",
    "table  [ tab : inp ] summarizes the inputs to _ ptfide.pl _ with a brief explanation for each . the default parameter values are those currently used for iptf .",
    "more details on some of the parameters can be found in section  [ psteps ] .",
    "p1.7cmp1.6cmp12.2 cm -cfgide & & optional input configuraton file listing all numerical parameters and thresholds defined below ; these override those on the command - line , if any .",
    "+ -scilst & & input filename listing science image fits file(s ) .",
    "+ -msklst & & input filename listing mask image fits file(s ) accompanying -scilist .",
    "+ -ref & & input fits filename of reference image ( co - add ) .",
    "+ -catref & & input reference image source catalog file from sextractor ; -cn specifies required columns .",
    "+ -cn & 2,3,4,42,10,57 , 60,63,72,78,27 , 48,14,15,45 & list of integers defining locations of required columns in the -catref input file .",
    "+ -catfilt & 0.5,100,19.0 , 1.3 & thresholds for filtering reference source catalog : min / max tolerable values for class_star , isoareaf_image , mag_aper , and ratio awin_world / bwin_world .",
    "+ -od & & directory name for output products ( including any debug output ) .",
    "+ -cfgswp & & input configuration file for swarp module .",
    "+ -cfgsex & & input configuration file for sextractor to support position / gain matching .",
    "+ -cfgsexpsf & & input configuration file for sextractor to support association with psf extractions .",
    "+ -cfgcol & & input sextractor column name configuration file to support position / gain matching .",
    "+ -cfgcolpsf & & input sextractor column name configuration file to support association with psf extractions .",
    "+ -cfgfil & & input filename for sextractor convolution kernel filter .",
    "+ -cfgnnw & & input sextractor neural network configuration file for star / galaxy classification .",
    "+ -cfgdao & & input generic _ daophot _ parameter file .",
    "+ -cfgpht & & input _ daophot _ photometry parameter file .",
    "+ -tmaxpsf & 2000.0 & threshold [ # bckgnd sigma ] above background in _ reference image _ for maximum usable pixel value when creating psf .",
    "+ -tdetpsf & 50.0 & _ daophot _ find - threshold [ # bckgnd sigma ] for psf creation from reference image . + -tmaxdao & 3000.0 & threshold [ # bckgnd sigma ] above zero - background in _ difference image _ for maximum usable pixel value for source extraction .",
    "+ -tdetdao & 3.5 & _ daophot _ find - threshold [ # bckgnd sigma ] for source extraction on difference image .",
    "+ -tchi & 8.0 & threshold on _ chi _ metric from _",
    "allstar _ program below which extractions on difference image are retained ; larger @xmath35 more non - psf - like profiles are retained .",
    "+ -tshp & 4.0 & threshold on _ sharp _ metric from _ allstar _ program where extractions on difference image with tshp @xmath36 @xmath13tshp are retained ; values of @xmath37 @xmath35 sources are more psf - like .",
    "+ -tsnr & 4.0 & threshold on flux signal - to - noise ratio in psf - fit photometry above which _ difference image _ extractions are retained .",
    "+ -fatbits & 8,9,10,12 & fatal bits to mask as encoded in input mask images ( -msklist input ) ; set to 1 for no masking .",
    "+ -satbit & 8 & saturation bit # in mask images for determining saturation level in science images .",
    "+ -expnbad & 3 & mask an additional ( _ expnbad _ @xmath2 _ expnbad _ ) - 1 pixels around each input masked science and reference image pixel ; provides more complete blanketing .",
    "+ -eg & 1.5 & native electronic gain of detector [ e-/adu ] ; used for pixel - uncertainty estimation .",
    "+ -sxt & 2.0 & sextractor detection threshold [ # sigma ] to support position / gain matching .",
    "+ -rad & 3.0 & match radius [ pixels ] for associating reference and science frame extractions for position refinement and gain matching .",
    "+ -nmin & 200 & minimum number of reference - to - science image source matches above which to proceed with position refinement and gain matching .",
    "+ -dgt & 1.5 & minimum relative gain factor [ % ] above which to proceed with relative gain correction .",
    "+ -dpt & 0.07 & minimum offset [ pixels ] above which to proceed with position refinements ( dx or dy ) .",
    "+ -dgsnt & 5.0 & minimum s / n ratio in gain factor above which to proceed with relative gain correction .",
    "+ -dpsnt & 5.0 & minimum s / n ratio in deltas above which to proceed with position corrections ( dx or dy ) . + -gridxy & 4,8 &",
    "number of image partitions per axis to support differential svb computation .",
    "+ -tpix & 2.0 & threshold @xmath17 [ # sigma ] for replacing pixel values @xmath24 mode @xmath13 @xmath38sigma in an image partition to support differential svb computation .",
    "+ -tmode & 500.0 & threshold @xmath17 [ % ] for replacing all pixels of a partition with global mode if its local mode is @xmath39/100)$ ] @xmath40 global mode ; to support differential svb computation .",
    "+ -tsig & 100 & threshold @xmath17 [ % ] for replacing all pixels of a partition with local mode if its robust sigma is @xmath41t@xmath42/100)$ ] @xmath40 `` median of all partition sigmas '' ; to support differential svb computation .",
    "+ -rfac & 16 & image - pixel sampling factor to speed up filtering for differential svb computation .",
    "+ -szker & 41 & median - filter size for downsampled image to support differential svb computation [ pixels ] .",
    "+    -ker & lanczos3 & interpolation kernel type for swarp module .",
    "+ -zpskey & imagezpt & keyword name for photometric zeropoint in _ science _ image fits headers .",
    "+ -zprkey & imagezpt & keyword name for photometric zeropoint in _ reference _ image fits header .",
    "+ -pmeth & 2 & method to derive psf - matching kernel between _ sci _ and _ ref _ images : 1 @xmath35 old alard - lupton ( 1998 ) method ( now deprecated ) ; 2 @xmath35 pixelated convolution kernel ( pick ) method .",
    "+ -conv & auto & for -pmeth 2 : image to convolve ; can be _ sci _ , _ ref _ , or _",
    "auto_. the _ auto _ option uses the _",
    "sci _ and _ ref _ fwhm values to select the image to convolve .",
    "+ -kersz & 9 & for -pmeth 2 : linear size of psf - matching kernel stamps [ pixels ] .",
    "+ -kerxy & 3,3 & for -pmeth 2 : number of image partitions along x , y to represent spatially - dependent kernel .",
    "+ -psfsz & 25 & for -pmeth 2 if -rpick was set : linear size of psf stamps created from point source cutouts .",
    "+ -apr & 9.0 & for -pmeth 2 if -rpick was set : source aperture radius [ pixels ] to compute flux for normalizing psfs and background level outside this .",
    "+ -nmins & 20 & for -pmeth 2 if -rpick was set : minimum number of sources in an image partition above which psf - creation is attempted .",
    "+ -nmaxs & 150 & for -pmeth 2 if -rpick was set : use _ n _ brightest sources per image partition for psf - creation .",
    "+ -rpickthres & 4.0,5.0,0.0004 , 40,0.045 & for -pmeth 2 if -rpick was set : list of parameter thresholds for creating psfs : _",
    "n_-sigma threshold for stack - outlier rejection ; _ n_-sigma threshold for spatial outlier - detection and winsorisation ; maximum tolerable rss of spatial rmss of psf products for ( re)assigning partition inputs for kernel derivation ; minimum distance to edge to avoid when selecting sources from _ sci _ and _ ref _ images ; threshold @xmath43 for @xmath44 where @xmath45 ratio of psf pixel sums and psfs with @xmath46 are rescaled to the @xmath47 of all image partitions .",
    "+ -nbreftb & 65 & for -pmeth 2 : number of pixel rows to force as bad at top and bottom of internal images used for kernel derivation to account for edge effects in resampled reference image .",
    "+ -nbreflr & 35 & for -pmeth 2 : number of pixel columns to force as bad at left and right of internal images used for kernel derivation to account for edge effects in resampled reference image .",
    "+ -bckwin & 31 & for -pmeth 2 : linear window size for median filtering of [ downsampled ] reference image when computing spatially varying background ; note : downsampling factor is fixed at 16x per axis .",
    "+ -tsat & 0.65 & for -pmeth 2 : factor threshold to perform more conservative tagging of resampled _ ref _ image pixels satisfying @xmath48 where @xmath49 and @xmath50 is from resampled _ ref _ image header .",
    "this assumes the _ ref _ image was made using the _ mkcoadd.pl _ co - addition software .",
    "+ -goodcuts & 5.3,1.2,5.0 , 0.02,22,4,0.8 , 35,14.3,7.0,2 , 0.07,0.2 & for -pmeth 2 : list of parameter thresholds for performing simple 1-d cuts on source metrics for assigning _ goodcand _ flag in output extraction tables : _ chi , sharp , snrpsf , magfromlim , nneg , nbad , magdiff , mindtoedge , magnear , dnear , elong , @xmath51 , kpr_. + -baddiff & 80,15,15,3,140 , 0.2,0.7,0.15 , 0.15,1.5,1.5 & list of parameter thresholds for performing simple 1-d cuts on difference - image metrics for assigning _",
    "good _ flag in output qa file : _ diffpctbad , dmedchi , davgchi , diffsigpixmin , diffsigpixmax , dmedksum , medkpr , ncandscimrefratio , ncandrefmsciratio , dinpseeing , dconvseeing_. + -uglydiff & 80,15,15,140 , 0.2,0.7,0.35 & list of parameter thresholds for performing simple 1-d cuts on difference - image metrics to decide if should proceed with source extraction on difference images : _ diffpctbad , dmedchi , davgchi , diffsigpixmax , dmedksum , medkpr , maxminksum_. + -qas & 41,2008 , 41,4056 & coordinate range of rectangular region in image for computing qa metrics in difference images if -qa switch was set ; format is : _ xmin , xmax , ymin , ymax _ where pixel numbering is unit based and @xmath52 ; @xmath53 .",
    "+ -apnum & 3 & internal aperture number for which _ daophot _ aperture photometry information should be propagated to output psf - fit photometry table .",
    "+ -forceparams & _ ra , dec , _ 43 & list of parameters to support `` forced sub - image mode '' if -forced switch was set ; parameters are : ra [ deg ] , dec [ deg ] , linsize [ pixels ] .",
    "+ -kerlst & & input filename listing fits image cubes storing prior - derived , spatially - dependent psf - matching kernels for each science image to support `` forced sub - image mode '' .",
    "+ -phtcalsci & & switch to perform absolute photometric calibration of input science image after gain - matching to _ ref_-image by computing a zp using the calibrated mag_auto values in the _ ref_-image sextractor catalog ; this zp will allow big - aperture ( and psf - fit ) absolute photometry on the input science image _ before _ further gain refinements in the psf - matching step downstream .",
    "+ -phtcaldif & & switch to perform absolute photometric calibration on science image _ after _ possible gain refinement and _ before _ image - differencing with _",
    "ref_-image by computing a zp using the calibrated mag_auto values in the ref - image sextractor catalog ; this zp will allow big - aperture ( and psf - fit ) absolute photometry on the science and difference images .",
    "+    -wmode & & switch to compute image modes ( instead of medians ) for the differential svb correction .",
    "+ -rpick & & switch to use robust version of the pick method ( -pmeth 2 ) when deriving psf - matching kernel , i.e. , via the construction of image psfs using point - source cutouts .",
    "+ -psffit & & switch to perform psf - fit photometry on difference images with prior psf estimation off [ possibly convolved ] reference image .",
    "+ -apphot & & switch to perform fixed - aperture photometry on difference images using _ daophot_. + -dontextract & & switch to _ only _ estimate spatially - varying psf ; no extraction or photometry is performed .",
    "+ -forced & & switch to execute in `` forced sub - image mode '' where only `` _ sci _ minus _ ref _ '' difference image stamps ( and ancillary files ) centered on input _ ra , dec _ ( _ -forceparams _ inputs ) are made .",
    "+ -outstp & & switch to generate image cutouts of candidates from `` _ sci _ minus _ ref _ '' difference images .",
    "+ -pg & & switch to compute _ sci - to - ref _ relative astrometric and gain corrections , and apply if significant .",
    "+ -pcln & & switch to pre - clean ( remove ) output products directory specified by -od .",
    "+ -qa & & switch to generate qa metrics on difference images before and after psf - matching within image slice defined by -qas string ; results are written to standard output and an ascii file .",
    "+ -d & & switch to write debug information to standard output , ascii files and fits images .",
    "+ -v & & switch to increase verbosity to standard output .",
    "+      the purpose of a reference image is to provide a _",
    "static _ representation of the sky , or more specifically , a historical snapshot as defined by the state of the sky recorded in previous image exposures .",
    "this image provides a benchmark against which future exposures can be compared ( i.e. , differenced ) to assist with transient discovery , both temporally ( for flux changes ) and/or spatially ( for motion changes ) .",
    "the reference images also provide `` absolute anchors '' for assigning a photometric calibration to the incoming real - time science images and difference images derived therefrom .",
    "they are also used to check and refine astrometric solutions prior to differencing .",
    "details are given below .",
    "the reference images are co - adds ( stack averages ; see below ) of several to fifty high - quality ccd - images selected from the image archive .",
    "therefore , they have a higher s / n than the individual exposures . besides supporting transient discovery , they can also benefit other science applications that require deeper photometry . so far in iptf",
    ", the goal has been to construct reference images that are optimal for _ single - exposure _ image differencing and transient discovery .",
    "these do nt necessarily achieve the highest possible depths ( s / n ) by using all available ( good quality ) images .",
    "this may be performed at a later date on completion of the survey and with different input image selection criteria .",
    "reference images are generated by a separate pipeline in iptf operations that executes asynchronously and is independent of the real - time pipeline .",
    "this pipeline is only triggered when enough _ good quality _ images are available for a given field , ccd , and filter in the archive .",
    "the generation process is iterative in that reference images are remade and refined if an existing product is identified to be of low quality or unusable , provided better quality image - data are available .",
    "the input - image selection criteria for reference image generation were outlined in @xcite . given their importance , we repeat them below and expand on some of the details .",
    "these were derived from analyses of the distributions of numerous image metrics in june 2013 .",
    "the goal was to cover as much of the iptf - visible sky as possible according to the available depth - of - coverage across all visited fields at the time .    1 .",
    "the image must have been astrometrically and photometrically calibrated in an absolute sense and passed all automated quality checks prior to archiving @xcite .",
    "the astrometric calibration ( including full distortion solution ) must have passed all validation steps ( section  [ realtpl ] ) .",
    "this includes a separate check on the higher - order terms of the distortion polynomial .",
    "3 .   the spatially - binned photometric zeropoint values ( provided by the zp variations map or zpvm from photometric calibration ) must lie within @xmath54 mag .",
    "furthermore , the source color - term coefficients derived from photometric calibration ( as described in @xcite ) must lie between the overall observed @xmath55 and @xmath56 percentiles .",
    "the seeing ( inferred from the mode of the point - source fwhm distribution ) is @xmath57 .",
    "the 5-@xmath5 limiting magnitude , estimated using both theoretical and empirically - derived inputs is @xmath58 mag .",
    "the number of sources extracted from the image ( via _ sextractor _ ) is @xmath59 .",
    "this reinforces the previous criterion and ensures the transparency was not too low or image noise not too excessive .",
    "the minimum number of input images that must satisfy the above criteria before proceeding with reference image generation is @xmath60 .    if @xmath61 , the image limiting magnitudes @xmath62 are then sorted in descending order ( faintest to brightest ) .",
    "next , co - add limiting magnitudes @xmath63 are predicted cumulatively and incrementally per - image for this list of candidate images .",
    "the resulting values of @xmath63 are then compared to a predefined set of six target magnitude limits desired for the final co - add ; e.g. , for the iptf @xmath64 filter , these are defined : @xmath65 where @xmath66 , @xmath67 is the typical ( median ) 5-@xmath5 limiting magnitude of a single @xmath64-band exposure @xcite , and @xmath60 .",
    "the faintest target limit @xmath68 is then identified as the faintest @xmath69 that just falls below the co - add limit predicted from the _ entire _ image - list : @xmath70 .",
    "the number of images @xmath71 to co - add is then the _ smallest _ possible @xmath71 whose cumulative @xmath63 comes closest to @xmath68 , i.e. , @xmath72,\\,50\\},\\ ] ] where 50 is the maximum number of images allowed at this stage .",
    "the requirement of an upper cutoff in the input image fwhm ( @xmath73 ; criterion # 4 above ) is an important consideration since it influences the quality ( effective point - source fwhm ) of the resulting reference image and image subtractions derived therefrom .",
    "it is desirable to generate a reference image whose effective fwhm is smaller than that generally expected in the science ( target ) images .",
    "this ensures the higher s / n reference image is preferentially convolved ( smoothed ) to match the science image psf prior to subtraction in ptfide . not only",
    "will this minimize the relative fraction of correlated pixel - noise in the difference images ( i.e. , since noise will be dominated by the science image ) , it ensures robustness and minimizes the potential for error when using an automatic method to decide on which image to convolve .",
    "this is because the decision metrics themselves are inherently noisy and one can not be confident that the correct image will _ always _ be selected . for the interested reader , @xcite present an analysis on ways to select the best reference image and convolution direction for optimal image subtraction in the presence of variable seeing .",
    "the median fwhm of the iptf science images is @xmath74 .",
    "therefore , it is inevitable that some cases will require the _ science _ image to be convolved when matching psfs .",
    "this is not detrimental since ptfide can automatically select the image to convolve , with some margin for error ( see below ) .",
    "the desire to have a lower cutoff for the input image fwhm when constructing reference images is mentioned here as a future improvement , specifically to optimize image subtraction .",
    "as mentioned , the requirement of fwhm @xmath57 was driven by data availability ( after accounting for all other selection criteria ) and a need to generate reference images for a large fraction of the iptf survey fields in short order .    before co - addition to create a reference image , the input list of high - quality overlapping ccd - images ( for a given field and filter ) are astrometrically refined as an ensemble .",
    "this is performed in a relative image - to - image sense using _ scamp _ with inputs provided by _",
    "sextractor_. their distortion solutions ( in the _ pv _ format ) are also refined self - consistently .",
    "this improves the astrometric solutions of the input images as well as the overall astrometry in final co - adds .",
    "following astrometric refinement , the images are fed to an in - house developed co - addition tool ( _ mkcoadd.pl _ ) specifically written for iptf .",
    "this software first determines the wcs geometry of the output co - add footprint using wcs metadata from all the input images .",
    "the co - add pixel scale is set to the native value determined for the center of the focal plane : @xmath75/pixel , and the footprint x , y dimensions are fixed at 2500 pixels @xmath2 4600 pixels throughout .",
    "these dimensions can accomodate for slight offsets in the reconstructed image pointing within a field . retaining the native pixel scale for co - add images",
    "ensures they more - or - less remain ( marginally ) critically sampled in median seeing conditions",
    ". a future consideration would be to use half the native pixel scale to take advantage of the natural dithering offered by random offsets in telescope pointing across image epochs .",
    "this dithering would benefit input lists that are dominated by undersampled images ( i.e. , acquired in better than median seeing ) so that the effective psf can be better sampled when all images are combined .",
    "bad and saturated pixels are internally set to nan in each ccd - image using their accompanying masks .",
    "this facilitates easier omission and tracking of all bad pixels downstream .",
    "respective image - median levels are then subtracted .",
    "this stabilizes ( or homogenizes ) the images against temporally - varying backgrounds before they are combined ( see below ) .",
    "these backgrounds are not always astrophysical , for example , there is contamination from scattered moonlight and internal scattering from other bright objects whose line - of - sight may not directly fall on the focal plane .",
    "the individual image background levels are stored for later use .",
    "each image is then de - warped ( distortion - corrected ) and interpolated onto the output co - add grid using its astrometric and distortion solution .",
    "this is accomplished using the _ swarp _ software @xcite . for an image observed at epoch @xmath17 , the pixel values @xmath76 at distortion - corrected positions",
    "@xmath77 are interpolated and resampled using a 2d lanczos kernel of window size three : @xmath78 where @xmath79 and @xmath80 , and the signal at pixel position @xmath81 in the output grid is given by @xmath82 this generates a new set of images for epochs @xmath83 that have been corrected for distortion , all sharing the same wcs geometry , i.e. , that of the final co - add footprint .",
    "the choice of a lanczos kernel ( equation  [ lanc ] ) , particularly with window size three , is motivated by three reasons .",
    "first , it is close to optimal for psfs that are sampled close to or above the nyquist rate , i.e. , its _",
    "sinc_-like properties can reconstruct well - sampled signals to good accuracy . by `` optimal '' , we mean in the context of conserving information content .",
    "second , its _",
    "sinc_-like nature also ensures that uncorrelated input noise remains close to uncorrelated on output .",
    "third , its relatively compact support minimizes aliasing and the spreading of bad and saturated pixels on output .",
    "given the @xmath6 pixel size , one small downside is that localized ringing can occur when the psf is severely undersampled , i.e. , when the seeing falls below @xmath84 .",
    "since the epochal images will have been observed at different atmospheric transparencies , their photometric throughput ( or effective photon - to - dn gain factors ) will be different .",
    "throughput - matching the images to a common photometric gain or zeropoint ( zp ) value is therefore necessary before combining them .",
    "this can be done in a relative sense ( by computing source - flux ratios across images and rescaling pixel values therein ) or in an absolute sense using the image - zp values derived from photometric calibration upstream .",
    "we have chosen to use the absolute zp values to compute the gain - factors .",
    "this is accomplished by throughput - matching all images to a common target zero point of @xmath85 .",
    "this value becomes the final co - add ( reference image ) zp , where currently , all archived ptf reference images have @xmath86 magnitudes .",
    "the gain - corrected pixel values in a resampled image at epoch @xmath17 with specific zero point @xmath87 are given by @xmath88    the resampled and throughput - matched epochal images with pixel signals @xmath89 are then combined using a _ lightly_-trimmed weighted - average .",
    "outlier - trimming is performed on the individual pixel stacks ( along the @xmath17 dimension ) by first computing robust measures of the location and spread : respectively the median ( @xmath90 ) and @xmath91 $ ] , where the @xmath92 are percentiles .",
    "pixels that satisfy @xmath93 are rejected from their temporal - stack at position @xmath81 prior to combining the remaining pixels using a weighted - average ( see below ) .",
    "our choice of a relatively loose trimming threshold ( @xmath94 ) is driven by our goal to remove the largest outliers only ( e.g. , cosmic rays and unmasked satellite trails ) , therefore preserving as much information as possible .",
    "the pixels in a stack are weighted using an inverse power of the seeing ( @xmath95 ) in the images they originated from , i.e. , @xmath96 where @xmath97 is a constant fiducial value currently set to the modal value of @xmath16 and is unimportant since it cancels following normalization in the final weighted average .",
    "@xmath98 is a parameter that controls the overall importance of the weighting .",
    "this weighting is purely motivated by empirical and practical considerations as an attempt to handle the time - dependent seeing in a qualitative sense , i.e. , in that relatively more weight is given to images acquired in better seeing .",
    "there is no theoretical justification that satisfies some optimality criterion like maximal s / n , however , it s interesting to note that @xmath99 corresponds to the case where @xmath100 , where @xmath101 is the effective number of _ noise pixels_[multiblock footnote omitted ] for a gaussian - like psf and @xmath102 is the flux - variance that would result from psf - fit photometry on the image ( see also * ? ? ?",
    "therefore when @xmath99 , the weighting is effectively inverse - variance weighting of the images according to the expected point - source flux uncertainties from psf - fitting . besides being optimal for psf - fitting ( simultaneously over the entire image stack ) , and",
    "particularly when the input noise is gaussian , we found through simulation and analysis of on - sky data that @xmath99 can lead to significantly distorted psfs and slight degradations in the co - add pixel s / n .",
    "this is due to the undersampled nature of the psf when the seeing is better than average in iptf exposures .",
    "we found that values of @xmath103 for the range of seeing encountered ( and a forced cutoff of fwhm @xmath57 ; see above ) work best .",
    "as a compromise , we assumed @xmath104 throughout .",
    "this choice is similar to that adopted by @xcite for combining sdss image data .",
    "these authors also included inverse - variance weights in their weighting scheme , with pixel variances computed from the background rms in each input image .",
    "the @xmath105 remaining pixels in a stack following outlier rejection are combined using a weighted average to produce the co - added pixel signal : @xmath106 where @xmath89 and @xmath107 are given by equations ( [ tp ] ) and ( [ wt ] ) respectively . the @xmath108 are the individual image background levels that were initially subtracted from each image ( see above ) then rescaled using the same throughput - match factors in equation ( [ tp ] ) .",
    "a median of all these levels is computed and used as a fiducial background for the final co - add .",
    "we also generate an image of the uncertainties in the weighted averages @xmath109 . for co - add pixel",
    "@xmath81 , this can be written : @xmath110 where @xmath111 and @xmath112 is the uncertainty ( e.g. , a prior ) for the input pixel signal at @xmath113 .",
    "we assume that the noise is spatially and temporally uncorrelated across images . instead of using explicit priors for @xmath112 ( e.g. , from a pixel - noise model ) , we approximate @xmath112 using an _ unbiased _ and unweighted estimate of the population standard - deviation in the stack of @xmath89 values .",
    "the uncertainty in @xmath109 ( equation  [ wtavg ] ) then becomes : @xmath114 ^ 2\\right]^{1/2}. \\end{aligned}\\ ] ] the effective @xmath115 scaling is implicitly represented by the fractional term involving @xmath107 .",
    "an image of the pixel depth - of - coverage , @xmath116 , is also generated .",
    "the astrometric solution in the reference image is validated against the _ 2mass _ psc using a procedure similar to that described in section  [ realtpl ] .",
    "sources are extracted and measured from the reference image using both aperture ( _ sextractor _ ) and psf - fit photometry ( _ daophot _ ) .",
    "ancillary products for the psf - fit catalog include a ds9-region file and estimates of the spatially - variable psf represented in both _ daophot _",
    "s look - up - table format and as a grid of fits - image stamps .",
    "qa metrics for the image and catalog products are also generated .",
    "the product files are archived and their paths@xmath117filenames and associated metrics stored in a relational database .",
    "each reference image product is uniquely identified according to survey field , ccd , filter , pipeline number , version , and archive status flag .",
    "the pipeline number supports variants of the reference image pipeline tailored for different science applications , for example , a specific time range , number of input images , and/or different filtering criteria than the default used to support real - time processing . as mentioned , the reference image library is periodically updated as low - quality or unusable products are identified from analyses of outputs from the real - time pipeline , provided enough _ good quality _",
    "images are available ( see above ) .",
    "the reference image and its _ sextractor _ catalog for a given survey field , ccd , and filter are two of the primary products used in ptfide ( section  [ psteps ] ) .",
    "as mentioned , these provide an absolute anchor for assigning a photometric zp to all the _ new _ incoming , spatially coincident science images and subtractions derived therefrom .",
    "the zp value in the fits header of a reference image is the target fiducial value @xmath85 onto which selected input images were gain - matched prior to co - addition ( equation  [ tp ] ) .",
    "the absolute accuracy of @xmath85 is therefore determined by the accuracy of the input image @xmath87 values .",
    "these were initially derived from photometric calibration in the _ frame - processing _ pipeline using the sdss - dr9 catalog @xcite .",
    "the input instrumental magnitudes used to perform this calibration are _",
    "kron_-like aperture measurements from _ sextractor _ , also referred to as @xmath118 . at the time of writing ,",
    "these are the only instrumental magnitudes in iptf products that can be tied to an _ absolute _ photometric system via the image @xmath87 values .",
    "the individual ( spatially - averaged ) image @xmath87 values are accurate to 2 - 4% ( absolute rms ; * ? ? ?",
    ". these could be less accurate on sub - image scales due to possible residual spatial variations in the instrumental response .",
    "the @xmath87-inherent gain - match errors will propagate into the reference image pixel values following image rescaling ( equation  [ tp ] ) .",
    "these errors will only be captured by the empirical uncertainty estimates in equation ( [ uncavg ] ) ( with its implicit @xmath119 scaling ) assuming no systematics in the @xmath87 derivations upstream .",
    "a future goal is to calibrate the @xmath87 values to better than 1% , preferably using psf - fit photometry .",
    "ptfide output products are files that are generically named : _",
    "inputimgfilenametype.ext _ where inputimgfilename is the root filename assigned to the ccd image following pre - calibration upstream ( section  [ realtpl ] ) and _ type.ext _ is a mnemonic for the type of ptfide product generated . the extension ( _ ext _ ) can be either _ fits _",
    "( for fits - formatted image ) , _ tbl _ for ascii table in the standard ipac format , _ psf _ for psf file in _ daophot _",
    "s look - up - table format , _ reg _ for ds9 region - overlay file , _ log _ for logfile , or _",
    "txt _ for other ascii files .",
    "table  [ tab : pout ] lists the primary ptfide products generated per ccd image . by `` primary '' ,",
    "these represent the products that are later used for real - time transient discovery and/or general archival science applications , for example , light - curve generation using forced - photometry on the difference images .",
    "the image , psf , qa , and log files are copied to long - term storage and their paths / filenames registered in relational database tables .",
    "the table ( _ tbl _ ) files contain the extracted transient candidates and associated metrics ( section  [ srcqa ] ) , one for the _ positive _ and another for the _ negative _ difference image .",
    "the metadata for each transient are later stored in database tables ( see section  [ schema ] ) .",
    "the metrics in the _ _ diffqa.txt",
    "_ qa files ( section  [ diffqa ] ) are stored in a separate database table .",
    "the generation of _ positive _ ( _ sci  ref _ ) and _ negative _ ( _ ref  sci _ ) difference images may seem somewhat redundant since one is simply the negative of the other .",
    "the purpose of having a negative difference is to enable detection of transients that dissapear below the reference image baseline level , for example , variable stars that are observed in their `` low '' state relative to their time - averaged ( reference image ) flux .",
    "our source detection software is designed to detect positive signals only and therefore it is necessary to negate the positive difference image and extract any new transients ( or excursions in variable flux ) that happened to be below the reference level at that epoch .",
    "table  [ tab : sout ] lists the secondary or ancillary ptfide products that can be generated per input ccd image .",
    "these are diagnostic files to support offline analysis , debugging and tuning , and are not generated by the ( real - time ) production pipeline .",
    "they are generated in addition to the products in table  [ tab : pout ] if the debug ( _ -d _ ) switch was specified for _",
    "ptfide.pl_. furthermore , some products are only generated when _",
    "_ is executed in sub - image mode ( with the _",
    "-forced _ switch ; section  [ force ] ) .",
    "p3.5cmp2.5cmp9 cm _ pmtchscimref.fits & fits image & final psf - matched `` science _ minus _ reference '' difference image .",
    "+ _ pmtchscimrefpsffit.tbl & ipac table & table of extracted transient candidates with psf - fit and aperture photometry , and source metrics corresponding to the _ pmtchscimref.fits difference image . + _ pmtchscimrefpsffit.reg & ascii & ds9 region / source - overlay file for all transient candidates in _ pmtchscimrefpsffit.tbl . +",
    "_ pmtchrefmsci.fits & fits image & final psf - matched `` reference _ minus _ science '' difference image .",
    "+ _ pmtchrefmscipsffit.tbl & ipac table & table of extracted transient candidates with psf - fit and aperture photometry , and source metrics corresponding to the _ pmtchrefmsci.fits difference image . + _ pmtchrefmscipsffit.reg & ascii & ds9 region / source - overlay file for all transient candidates in _ pmtchrefmscipsffit.tbl .",
    "+ _ pmtchdiffunc.fits & fits image & image storing 1-@xmath5 pixel uncertainties corresponding to the _ pmtchscimref.fits and _ pmtchrefmsci.fits difference images . + _",
    "pmtchkerncube.fits & fits cube & image stamps of spatially - dependent psf - matching convolution kernels with metadata in header . each plane of cube stores kernel image for a specific partition in input science image . + _ pmtchconvrefdao.psf & ascii & file storing psf template generated by _ daophot _ from the kernel - convolved reference image . only generated if the reference image was convolved to match the science image seeing ( fwhm ) .",
    "+ _ resamprefdao.psf & ascii & file storing psf template generated by _ daophot _ directly from the reference image , with no convolution . only generated if the science image was convolved to match the reference image fwhm .",
    "+ _ diffqa.txt & ascii & file storing qa metrics on image - differencing process and statistics on number of transients extracted . + _",
    "ptfide.log & ascii & log file storing processing diagnostics and verbose output",
    ". +    p4.5cmp12 cm _ badmsksci.fits & bad pixel mask for science image that includes spatially - expanded bad pixels . + _",
    "badmskref.fits & bad pixel mask for reference image ( mostly showing saturated regions ) . + _",
    "scisatpixels.fits & image showing locations of _ only _ saturated pixels in science image .",
    "+ sx_ref_filt.tbl & table of filtered sources from input reference - image _ sextractor _ catalog to support gain - matching and position refinement .",
    "+ sx_ref_filt.reg & ds9 region / source - overlay file corresponding to sx_ref_filt.tbl .",
    "+ _ sxrefremap.tbl & table of positions and fluxes of filtered reference image sources from sx_ref_filt.tbl with positions mapped onto science image frame to support source - association in _ sextractor _ run . + _",
    "sx.tbl & _ sextractor _ catalog of science image extractions _ matched _ to filtered and remapped reference image sources from _ sxrefremap.tbl ; to support gain - matching and photometric calibration .",
    "sx.reg & ds9 region / source - overlay file corresponding to _ sx.tbl .",
    "+ _ sxbck.fits & diagnostic background image computed by _ sextractor _ when generating _",
    "sx.tbl catalog .",
    "+ _ sxbckrms.fits & diagnostic background rms image computed by _ sextractor _ when generating _",
    "sx.tbl catalog .",
    "+ _ sxobjects.fits & diagnostic image showing objects extracted by _ sextractor _ when generating _",
    "sx.tbl catalog .",
    "+ _ resampref.fits & reference image resampled onto science image frame .",
    "resamprefunc.fits & pixel - uncertainty image corresponding to _ resampref.fits . + _",
    "resamprefwt.fits & weight image from resampling of reference image using _ swarp_. + _ newscitmp.fits & science image gain - matched and positionally refined relative to reference image . + _ inpsvb.fits & regularized image used to compute smoothly - varying differential background ( svb ) image . + _",
    "svb.fits & image of smoothly - varying differential background ; used to correct science image . + _",
    "newscibmtch.fits & science image with differential background , photometric gain , and astrometry matched to resampled reference image , before psf - matching . + _",
    "newsciuncbmtch.fits & pixel - uncertainty image corresponding to _ newscibmtch.fits . + _",
    "diffbmtch.fits & internal `` science _ minus _ reference '' difference image before any psf - matching . + _",
    "noconv_p**_m_**_stp**_n_**.fits & point - source image stamp indexed by * _",
    "n _ * in partition * _ m _ * of image that _ is not _ convolved . + _",
    "toconv_p**_m_**_stp**_n_**.fits & point - source image stamp indexed by * _",
    "n _ * in partition * _ m _ * of image that _ will be _ convolved . + _",
    "noconv_p**_m_**_psfcoad.fits & final co - added psf from all point - source stamps in partition * _ m _ * of image that _ is not _ convolved ; used to derive psf - matching kernel for partition * _ m_*. + _ toconv_p**_m_**_psfcoad.fits & final co - added psf from all point - source stamps in partition * _ m _ * of image that _ will be _ convolved ; used to derive psf - matching kernel for partition * _",
    "m_*. + _ noconv_p**_m_**_psfcoaddepth.fits & pixel depth - of - coverage map corresponding to _ noconv_p**_m_**_psfcoad.fits . + _",
    "toconv_p**_m_**_psfcoaddepth.fits & pixel depth - of - coverage map corresponding to _ toconv_p**_m_**_psfcoad.fits . + _",
    "sxrefremapcorr.tbl & equivalent to _ sxrefremap.tbl but performed on regularized science image ( gain - matched , position - refined , and psf - matched with additional gain - corrections ) prior to differencing . + _",
    "scibefdiff.fits & regularized science image ( gain - matched , position - refined , and psf - matched with additional gain - corrections ) ; input for _ sextractor _ to generate _",
    "sx_scibefdiff.tbl catalog .",
    "+ _ sx_scibefdiff.tbl & _ sextractor _ catalog of science image extractions _ matched _ to filtered and remapped _ ref _",
    "image sources from _ sxrefremapcorr.tbl ; to support photometric calibration of difference image . + _",
    "pmtchconvref.fits & convolved reference image prior to differencing ; only produced if _ ref _ image was convolved . + _",
    "pmtchconvsci.fits & convolved science image prior to differencing ; only produced if _",
    "image was convolved . + _",
    "pmtchdiffmsk.fits & bad - pixel mask for final difference images ; includes effects of convolution from psf - matching . + _",
    "pmtchdiffchisq.fits & image of binned pseudo-@xmath120 values for difference image after psf - matching .",
    "+    _ pmtchconvref.coo & _ daophot _ output file listing initial detections from _",
    "pmtchconvref.fits for psf generation . + _",
    "pmtchconvref.lst & _ daophot _ output file listing stars picked from _",
    "pmtchconvref.fits for psf generation . + _",
    "pmtchconvref.lst.reg & ds9 region / source - overlay file corresponding to _ pmtchconvref.lst . +",
    "_ pmtchconvref.nei & _ allstar / daophot _ output file listing neighbors of the stars listed in _ pmtchconvref.lst . + _ pmtchconvrefdaosub.fits & _ allstar / daophot _ output image showing psf - subtracted sources from _ pmtchconvref.fits . + _",
    "pmtchconvrefdaopsf.fits & image of spatially varying psf represented as a grid of @xmath121 postage stamps . + _",
    "pmtchscimref.coo & _ daophot _ output file listing initial detections from _",
    "pmtchscimref.fits difference image .",
    "pmtchrefmsci.coo & _ daophot _ output file listing initial detections from _",
    "pmtchrefmsci.fits difference image .",
    "pmtchscimrefdaosub.fits & _ allstar / daophot _ output image showing psf - subtracted sources from _ pmtchscimref.fits .",
    "pmtchrefmscidaosub.fits & _ allstar / daophot _ output image showing psf - subtracted sources from _ pmtchrefmsci.fits .",
    "+ _ pmtchscimrefapphot.tbl & table containing concentric aperture photometry for extracted transient candidates from the _ pmtchscimref.fits difference image ; only generated if the _",
    "_ switch was set .",
    "pmtchscimrefapphot.reg & ds9 region / source - overlay file for all sources in _ pmtchscimrefapphot.tbl .",
    "+ _ pmtchrefmsciapphot.tbl & table containing concentric aperture photometry for extracted transient candidates from the _ pmtchrefmsci.fits difference image ; only generated if the _",
    "_ switch was set .",
    "pmtchrefmsciapphot.reg & ds9 region / source - overlay file for all sources in _ pmtchrefmsciapphot.tbl .",
    "+ _ pmtchscimrefsex.tbl & _ sextractor _ catalog for _ pmtchscimref.fits difference image to associate with psf - fit extractions ; used to assign source - shape metrics . + _",
    "pmtchrefmscisex.tbl & _ sextractor _ catalog for _ pmtchrefmsci.fits difference image to associate with psf - fit extraction ; used to assign source - shape metrics . + _",
    "pmtchconvscistamp.fits & convolved _ sci _ image stamp prior to differencing ; only produced if _",
    "image was convolved . + _",
    "pmtchconvrefstamp.fits & convolved _ ref _ image stamp prior to differencing ; only produced if _ ref _ image was convolved . + _",
    "imgtoconvstamp.fits & stamp image that _ is not",
    "_ convolved with psf - matching kernel . can be either _ sci _ or _ ref _ image .",
    "imgnoconvstamp.fits & stamp image that _ will be _ convolved with psf - matching kernel .",
    "can be either _ sci _ or _",
    "ref_. + _ msktoconvstamp.fits & mask image stamp corresponding to _ imgtoconvstamp.fits . + _",
    "msknoconvstamp.fits & mask image stamp corresponding to _ imgnoconvstamp.fits . + _ uncscistamp.fits & pixel - uncertainty image stamp corresponding to regularized science image . + _ uncrefstamp.fits & pixel - uncertainty image stamp corresponding to regularized reference image . + _ pmtchkernstamp.fits & image of psf - matching kernel used to convolve image stamp ; extracted from archival _",
    "pmtchkerncube.fits file .",
    "the input pre - calibrated ccd images need to satisfy a number of criteria prior to processing through ptfide .",
    "these criteria use a number of quality metrics computed upstream during preprocessing ( section  [ realtpl ] ) .",
    "inputs that do not satisfy these criteria are expected to be of low quality and are not used for transient discovery .",
    "instead , they are assigned a status flag ( that is encoded into an overall processing bit - string at the end of processing ) and stored in a database table for future reference .",
    "the criteria currently used to declare a ccd image as `` good '' and worthy for image differencing are as follows :    1 .",
    "the seeing fwhm on the corresponding raw exposure image satisfies @xmath122 fwhm @xmath123 .",
    "values of fwhm @xmath124 are also a good proxy for low atmospheric transparency .",
    "over the course of iptf , @xmath125 of exposures are above this limit .",
    "the calculation of the seeing fwhm used in ( 1 ) was based on a sufficient number of point sources and is not a nan .",
    "the latter may occur due to bad inputs .",
    "at least 500 sources were found by _",
    "sextractor _ for use in the astrometric calibration using _ scamp_. 4 .",
    "the wcs solution from _ scamp _ used @xmath126 source matches with the astrometric catalog .",
    "the wcs solution could be derived using _ scamp _ with no errors or warnings .",
    "i.e. , the astrometric calibration did not fallback to _",
    "astrometry.net_. 6 .",
    "at least 20 sources were matched with the 2mass psc for validating the wcs .",
    "the axial rms position differences using the 2mass matches are within the maximum tolerable value ( which depends on galactic latitude ; see section  [ realtpl ] ) .",
    "the first - order wcs terms ( pointing , rotation , and scale ) are within range . 9 .",
    "the higher - order terms of the distortion polynomial are within range .",
    "below we expand on the processing steps outlined in the ptfide processing flow of figure  [ fig : ptfideflow ] .",
    "this includes additional details not shown in this figure .",
    "the descriptions make extensive use of the input parameters and output products summarized in tables  [ tab : inp ] , [ tab : pout ] , and [ tab : sout ] .",
    "the input bit - mask image for the ccd science image is first andd with the fatal - pixel bit - string template specified by _ _",
    "this identifies those pixels to omit from processing . to enable tracking downstream ,",
    "these pixels are forced to nan and all good ( usable ) pixels are reset to 1 in an internal image mask .",
    "this mask is then further processed and regularized by forcing an additional @xmath127 pixels around each masked ( nand ) pixel to also be bad , where @xmath71 = input from _",
    "_ parameter .",
    "this provides more complete blanketing of bad pixel regions , e.g. , for saturated sources in particular whose unmasked edges and associated bleed artifacts will lead to residuals in the difference images and hence unreliable extractions .",
    "this expansion operation is also performed on saturated pixels in the _ resampled _ reference image , i.e. , following reprojection onto the science image frame ( section  [ reproj ] ) .",
    "these internal regularized science and reference image masks are propagated downstream . in debug mode",
    ", they can be written to fits format with filename suffixes _",
    "_ badmsksci.fits _ and _ _ badmskref.fits _ respectively .",
    "another reason for spatially expanding all bad input pixels is that both the reference image resampling and the later psf - matching step that involves convolving one of the images ( section  [ pkern ] ) will cause bad - pixel regions to implicitly grow .",
    "a forced expansion provides a more conservative blanketing that s matched in both images prior to subtraction .",
    "both the science and reference image masks are later combined ( following psf - matching ) to produce a final effective bad - pixel mask ( _ _ pmtchdiffmsk.fits _ ) for both difference images : _",
    "_ pmtchscimref.fits _ and _ _ pmtchrefmsci.fits_. furthermore , all bad pixels in the difference images are tagged with value -999999 .",
    "two important preprocessing steps are photometric throughput ( or gain)-matching and a ( possible ) astrometric alignment of the science image with the reference image .",
    "as discussed in section  [ refcon ] , the reference image provides an absolute anchor for assigning a photometric zeropoint ( zp ) and a wcs to the final difference image products .",
    "the relative photometric and astrometric corrections are first derived and validated , and then only applied to the science image if found to be statistically significant .",
    "we describe each in turn below .",
    "first , the input reference image catalog from _ sextractor _ ( _ _ ) is filtered to retain primarily isolated point sources using the following _ sextractor_-derived metrics : _ class_star _ ( minimum stellarity index ) ; _ isoareaf_image _ ( maximum effective isophotal area ) ; _ mag_aper _ ( faintest magnitude based on a fixed 14-pixel diameter aperture ) ; and the ratio _ awin_world / bwin_world _ ( maximum effective source elongation ) . the thresholds for these metrics are specified by the _ _ input .",
    "another requirement is that all sources be clean and uncontaminated with no bad _ sextractor _ flags , i.e. , @xmath128 .",
    "a 14-pixel diameter aperture is used so that integrated source fluxes are relatively immune to seeing variations for the range of seeing encountered .",
    "this choice however is not optimal for crowded fields ( see below ) .",
    "an intermediate filtered reference image catalog is then generated with filename _",
    "sx_ref_filt.tbl_.    the source @xmath129 positions in the filtered reference image catalog are then mapped into the coordinate frame of the science image using the _ xy2xytrans _ utility .",
    "the reason for this is to support efficient source - matching within _ sextractor _ when run in source - association mode ( below ) since it only supports source - matching in @xmath129 coordinates .",
    "a new intermediate catalog is made with filename suffix _",
    "_ sxrefremap.tbl _ that stores photometric information for the filtered reference image sources and with @xmath129 positions in the wcs of the science image .",
    "it is not guaranteed that this wcs is correct ; hence any possible astrometric errors will be reflected in the remapped @xmath129 positions .",
    "these positions will be used below to refine the overall astrometry . _",
    "sextractor _ is then executed in source - association mode using the filtered and position - remapped reference catalog sources .",
    "this entails finding the _ nearest _ science image sources with s / n above input threshold _ _ and within a radial tolerance of _ _ .",
    "a source - matched catalog table is generated ( _ _ sx.tbl _ ) with an accompanying ds9 region file ( _ _ sx.reg _ ) .",
    "this table is used to derive the gain and astrometric corrections .",
    "the relative photometric gain factor @xmath130 is estimated using a median of the flux ratios of all @xmath131 science - to - reference source matches , where all fluxes are based on a 14-pixel diameter aperture : @xmath132 the uncertainty in @xmath130 is estimated from the median absolute deviation ( mad ) , appropriately rescaled for consistency with gaussian statistics in the limit of large @xmath131 , and further inflated by @xmath133 to account for the fact that the median in equation ( [ dg ] ) is noisier than a mean : @xmath134    global position offsets along the @xmath135 and @xmath136 axes are also computed using medians of the source - position differences : @xmath137 with uncertainties that are also based on the mad estimator , similar to equation ( [ sigdg ] ) .",
    "note that these represent overall orthogonal offsets between the science and reference images , and do not account for possible spatially - dependent offsets , for example , that would result from an erroneous distortion solution for the science image ( as calibrated upstream ; see section  [ realtpl ] ) .",
    "recall that the reference - image pixels have already been corrected for distortion during the co - addition process ( section  [ refcon ] ) .",
    "therefore , the assumption here is that the distortion solution is reasonably accurate over the ccd image , and that any systematics in the relative astrometry are purely global shifts along either @xmath135 or @xmath136 or both .    furthermore , to gauge the spread in the @xmath131 input flux ratios ( equation  [ dg ] ) and position offsets ( equation  [ dxy ] ) , @xmath138 ",
    "@xmath26 percentile ranges are also computed for these quantities .",
    "a large spread in the flux ratios for example ( relative to some expected nominal value ) may indicate that the flat - fielding was inaccurate upstream .",
    "a large spread in the position offsets may indicate that the distortion calibration was inaccurate .",
    "these metrics are stored in a database table for trending .",
    "the gain correction factor @xmath130 ( equation  [ dg ] ) is only used to rescale the science image pixel values to match those in the reference image if the following criteria are satisfied : the number of matches @xmath131 from which it was derived exceeds _ _ ; the quantity @xmath139 exceeds _ _ ; and its significance or s / n ratio , @xmath140 , exceeds _ _ . similarly , the orthogonal position corrections @xmath141 are only applied to the _ science _ image wcs parameters if the following criteria are satisfied : the number of matches @xmath131 also exceeds _ _ ; either @xmath142 or @xmath143 exceed _ _ ; and their s / n ratios , @xmath144 or @xmath145 , exceed _ _ .",
    "note , since the @xmath141 are constant corrections ( independent of position ) , it suffices to simply correct the coordinate origin defining the science image wcs .",
    "these are the fits keyword values @xmath146 and @xmath147 , and are corrected to the new values @xmath148 and @xmath149 respectively .",
    "this adjustment then ensures that the reference image is reprojected ( and registered ) onto the correct science image wcs later on ( see section  [ reproj ] ) .    as a detail , there are occasions when the input science image was already absolutely photometrically calibrated and associated with a zp value , for example , when ptfide is executed in offline mode on processed archival data . in this case ,",
    "an initial global gain correction factor @xmath150 is computed using the science and reference image zp values according to equation ( [ tp ] ) .",
    "the @xmath130 factor ( equation  [ dg ] ) is still computed , but it becomes a delta - correction on top of @xmath150 .",
    "the final effective gain correction factor for rescaling the science image pixels is then @xmath151 , where @xmath130 is only applied if the above criteria are met , otherwise it is reset to 1 .",
    "therefore , regardless of whether the science image had a valid zp calibration , ptfide always computes a relative gain correction factor in order to place the science image pixels on the same scale as those in the reference image as best as possible .",
    "after rescaling the science image pixels , the above method then implies that the reference image zp will enable absolute photometry on the science image , and eventually the difference images derived therefrom .",
    "however , it is important to note that the reference image zp will only allow an absolute calibration of the same _ type _ of instrumental photometry that was initially used to calibrate that zp . at the time of writing ,",
    "the instrumental photometry used for the absolute photometric calibration of ptf / iptf data are the _",
    "kron_-like @xmath152 aperture measurements from _ sextractor _ @xcite . as discussed in section  [ refcon",
    "] , these are used together with sources from the sdss - dr9 catalog to derive the absolute zps in all archived image products , including reference images .",
    "unfortunately , the @xmath152 measurements tend to systematically underestimate the total instrumental flux , with a bias that depends non - trivially on the image seeing .",
    "this bias is of order 48% .",
    "therefore , the current reference image based zps are only applicable to @xmath152-like measurements performed on the gain - corrected science and difference images . on the other hand ,",
    "the primary instrumental photometry extracted from ptfide image products is psf - fitting ( section  [ psffit ] ) .",
    "a refinement to the zp is therefore necessary .    to enable an absolute calibration of other flavors of photometry , for example psf - fitting or big - aperture photometry on the _ real - time _ science and difference images ,",
    "we compute a new zp value for insertion into their fits headers , denoted _ zpsci_.",
    "this is only performed by ptfide if the _ _ switch was specified .",
    "this new zp is computed using the ( absolutely calibrated ) @xmath152 magnitudes of the same filtered reference image point sources as used for the relative gain - correction above , with matching 14-pixel diameter aperture measurements from the science image , corrected for any residual @xmath130 .",
    "if the number of source - matches exceeds 100 , the new zp is estimated as @xmath153 a robust rms based on percentiles , _ zpscirms _ , is also computed to quote as a possible systematic uncertainty on _ zpsci_. it s important to note that the @xmath154 instrumental photometry used here is from a relatively large fixed ( 14-pixel diameter ) aperture .",
    "the _ zpsci _",
    "value will also be applicable to psf - fit instrumental photometry because analyses have consistently shown that this agrees , within measurement error , with the instrumental fluxes from large aperture photometry .",
    "i.e. , both flavors of photometry catch the _ same _ total instrumental flux for the range of seeing encountered .",
    "therefore , to enable an _",
    "absolute _ calibration ( on the sdss system ) of the photometry from ptfide image products , involving either psf - fitting and/or large apertures , it is advised that the _ zpsci _ values be used .",
    "we note that this reverse engineering to recover the correct zp for psf - fit photometry will disappear in the future when our photometric calibration system is upgraded to use psf - fit photometry throughout .",
    "to summarize , we have at this stage an internally regularized science image whose pixels are gain - matched to those in the input reference image , and with a possibly refined wcs that matches the reference image astrometric solution .",
    "this intermediate science image can be written to a fits - formatted file with suffix _ _",
    "newscitmp.fits_. other metadata that depend on the gain - matching operation are recomputed and also propagated along .",
    "these are the science image saturation level and the pixel electronic gain ( used for uncertainty estimation later ) .",
    "along with the _ mag_auto_-based zp inherited from the reference image , a new zp is also available , _ zpsci _ , to enable a more accurate absolute calibration of psf - fit photometry downstream .",
    "it s important to note that these corrections represent initial adjustments at the global image level .",
    "other refinements to the relative photometric gain and/or astrometry are possible at the _ local _ ( sub - image ) level later when we apply the spatially - dependent convolution kernels to match the image psfs ( section  [ appkern ] ) .",
    "the reference image is warped onto the native pixel grid of the science image ( accounting for distortion ) using its refined wcs as described in section  [ gm ] .",
    "the _ swarp _",
    "utility @xcite is used to perform the reprojection and resampling .",
    "this software conveniently uses the science image s distortion polynomial with coefficients encoded in the pv - format , derived upstream during astrometric calibration ( section  [ realtpl ] ) .",
    "pixels are interpolated using a 2d lanczos kernel of window size three ( equation  [ lanc ] ) , i.e. , the same as that used when constructing the reference images .",
    "see section  [ refcon ] for a discussion of its advantages .    it is imperative that the distortion solution for the science image be as accurate as possible over the entire frame to avoid mapping the reference image pixels into the wrong locations . even slight inaccuracies ( down to a tenth of pixel )",
    "will lead to systematic residuals in the difference images .",
    "one could mitigate these spatially - dependent astrometric residuals by fitting for a differential ( relative ) distortion between the science and reference images and if significant , correcting the science image distortion prior to reprojection .",
    "we found this to be unnecessary for now since for the bulk of iptf fields , the spatially - binned source - position residuals between the science and reprojected reference image sources have _ maximal _ rms values of @xmath155 per axis .",
    "this maximum rms per image is computed over @xmath156 spatial bins , where the binning is intended to capture local systematics in the distortion solution of the science image .",
    "@xmath157 is typically the maximum tolerable residual to obtain good quality difference images for iptf under median seeing or worse , at the location of @xmath158 mag sources .",
    "presently however , the residuals are generally larger in the densest regions of the galactic plane since that s where the astrometric calibration is most challenging .",
    "this is a work in progress .",
    "the resampled reference image can be written to a fits - formatted file with suffix _ _ resampref.fits_. an accompanying weight - image file is also generated ( _ _ resamprefwt.fits _ ) .",
    "this weight image is used to generate a mask image for the resampled reference image ( _ _ basmskref.fits _ ) that primarily tags saturated pixels .",
    "these pixels are then expanded to account for their growth during the interpolation and psf - matching process ( see section  [ bp ] ) .",
    "the slowly - varying background ( svb ) component in the rescaled and astrometrically - refined science image is matched to that in the resampled reference image .",
    "this background matching step helps minimize systematics in the difference - image photometry later on ( through estimation of the local background ) , particularly when the differential background between the science and reference image varies non - linearly with position .",
    "the background correction map is estimated using a robust image - partitioning method performed on a preliminary _ science - reference _ difference image , where the inputs are already gain matched ( section  [ gm ] ) and astrometrically aligned ( section  [ reproj ] ) but not yet psf - matched .",
    "bad and saturated pixels from both images are masked in the difference image prior to processing .",
    "the reason for computing the background correction map from a _ raw _ difference image is that this minimizes any biases from bright extended emission ( e.g. , galaxies ) .",
    "furthermore , the presence of residuals at the point - source level due to the lack of psf - matching ( at high spatial frequencies ) does not impact the estimation process .",
    "the difference image is first partitioned into @xmath159 rectangles where @xmath160 are specified by _ _ ( see table  [ tab : inp ] ) .",
    "pixel modes ( or optionally medians ) are computed both globally ( for the entire image ) and within each partition using only unmasked pixels .",
    "modes are only computed if the _ _",
    "switch was specified , otherwise medians are computed . in the steps described below",
    ", _ mode _ can be interchanged with _",
    "median _ if the latter was used .",
    "first , for each partition , we replace all pixel values therein with the global mode if its local _ mode _ exceeds or is below the global mode by a relative percentage specified by _ _ , i.e. , if @xmath161 is satisfied .",
    "furthermore , we replace any outlying pixel values @xmath162 in all partitions with their respective local _ mode _ if @xmath163 is satisfied , where @xmath17 is a threshold specified by _ _ and @xmath5 is a robust local rms estimated from a trimmed standard - deviation of the low - tail pixel distribution in the partition , i.e. , below its local mode .",
    "the resulting outlier - trimmed modal map is further regularized by replacing all pixels in those partitions with the global image mode whose local @xmath5 ( robust rms ) is + @xmath164 , where @xmath165 is a relative threshold specified by _ _",
    "this avoids noisy partitions ( e.g. , due to excessive poisson noise from bight emission ) from affecting the differential svb estimate . at this stage",
    ", the regularized difference image can be written to a fits - formatted file with suffix _ _",
    "inpsvb.fits_.    next , we down - sample the regularized difference image using the binning factor specified by _ _ .",
    "this binning uses a local averaging of pixels and is performed to speed up the filtering in the next step .",
    "the down - sampled map is median filtered using a window size specified by _ _ to smooth out the partition boundaries .",
    "the resulting image is up - sampled back to the original image pixel dimensions for use downstream .",
    "this is the final svb correction map and can be written to a fits - formatted file with suffix _ _",
    "svb.fits_.    the svb correction map is subtracted from the input ( gain - matched ) science image to produce a new regularized science image ( file suffix _ _",
    "newscibmtch.fits_ ) .",
    "this now has a svb whose pattern matches that in the resampled reference image . figure  [ fig : bmatch ] shows an example of an input science and resampled reference image , and the differential ( low - pass filtered ) svb image generated therefrom . at this stage , a preliminary difference image ( still with no psf - matching ) can be generated with suffix _",
    "_ diffbmtch.fits _ to check the quality of the background matching .",
    "an example is shown on the far right of figure  [ fig : bmatch ] .          at this stage",
    ", images of the 1-@xmath5 uncertainties corresponding to the gain and background - matched science and resampled reference images are initialized for propagation downstream .",
    "these pixel uncertainties are later updated to account for additional processing on the images .",
    "we use a robust semi - empirical method to compute the pixel uncertainties .",
    "first , we find the _ minimum _ background pixel variance @xmath166 and mode @xmath167 over all partitions of the science image .",
    "these are the same partitions from the background matching step above ( section  [ bckm ] ) .",
    "the variances are computed from a robust pixel rms based on a trimmed standard - deviation of the low - tail pixel distribution in each partition .",
    "the minimum value is used for conservatism in the sense that any biases from bright emission and/or source - confusion are minimal .",
    "the 1-@xmath5 uncertainty for a pixel signal @xmath168 in the science image is approximated by : @xmath169^{1/2},\\ ] ] where @xmath170 is a scale factor to account for the gain - matching operation ( section  [ gm ] ) and is needed since the actual counting of photoelectrons ( for the poisson term ) is always with respect to the native detector adu counts .",
    "@xmath171 is the detector s electronic gain in @xmath172 ( input parameter _ _ ) .",
    "we have subtracted an estimate of the background from the pixel signals since any poisson - noise from the background is already implicitly included in the @xmath166 term and we remove any unknown ( hidden ) bias level that is not induced by photoelectrons .",
    "this avoids overestimating the poisson contribution from the background .",
    "furthermore , @xmath166 implicitly includes the read - noise component .",
    "pixels with @xmath173 are reset to zero .    for the reference image pixel uncertainties ,",
    "we first compute a robust background pixel variance @xmath174 from the same ( minimally - contaminated ) partition as used for the science image .",
    "given that the reference image was created from a co - add of science images with variable photometric zps ( that were later used to throughput - match the images ; section  [ refcon ] ) , the poisson - noise contribution will be difficult to estimate precisely from first principles .",
    "instead , we approximate the 1-@xmath5 uncertainty for a pixel signal in the reference image by scaling from the science image uncertainties ( equation  [ sigsci ] ) and the relative background rms estimates : @xmath175 this is expected to be a reasonable approximation since the pixel signals ( in dn ) are guaranteed to be conserved between the rescaled science image and resampled reference image , to within measurement error . in other words , the signals contributing to the poisson component are not expected to change much between these images and any @xmath176 diminution in the overall noise in the reference image from co - addition is effectively handled by the ratio @xmath177 .",
    "an important effect that is not accounted for in the pixel uncertainties of the resampled reference image at this stage is the possibility of correlated pixel noise .",
    "this could arise from both co - addition ( during construction of the initial reference image ) and the reinterpolation step ( onto the science image pixel grid ; section  [ reproj ] ) .",
    "accounting for spatially correlated noise is more important when estimating the photometric uncertainties of extracted sources from _ difference _ images ( section  [ psffit ] ) .",
    "the contribution of correlated noise from reference images however is expected to be small .",
    "this is because first , as discussed in section  [ refcon ] , correlated noise will be negligible due to the choice of a _",
    "sinc_-like interpolation kernel , and second , because of the @xmath176 diminution from co - addition .",
    "the difference image noise will be dominated by that in the science image .",
    "the difference image pixel uncertainty estimates are described in section  [ appkern ] .",
    "the science and reference image pixel - uncertainty images can be written to fits format with suffix names _",
    "_ newsciuncbmtch.fits _ and _ _ resamprefunc.fits _ respectively .",
    "our overall goal is to derive a kernel image @xmath178 where @xmath179 are relative pixel coordinates , which when _ convolved _ with one of the input images ( science or reference ) , will match their psfs in some optimal manner .",
    "the details of how this kernel is represented and derived are outlined in section  [ pkern ] .",
    "following the _ global_-matching steps above ( i.e. , registration , gain and background - matching ) , the psf - matching problem can be generalized by attempting to model one of the input images in terms of the other through @xmath178 and some local differential background @xmath180 .",
    "for instance , let us assume the science image pixel values @xmath181 can be modeled from those in an overlapping reference image @xmath182 where the point - source profiles therein are significantly more narrow ( in terms of overall fwhm ) : @xmath183 + db + \\epsilon_{ij}.\\ ] ] @xmath184 is a noise term , usually a correction to the random noise component inherent in the @xmath64 image since the latter is not strictly noiseless .",
    "note , if @xmath185 was determined to be the better seeing image ( according to some @xmath186fwhm threshold based on prior metrics ; see section  [ pkern ] ) , then @xmath64 and @xmath185 would be interchanged in equation ( [ imgmodel ] ) without loss of generality . aside from modeling differences in psf shape , @xmath178 will also ( implicitly ) model local residuals in the relative photometric gain and/or astrometry , for later removal when @xmath178 is applied .",
    "regardless of how @xmath178 is parameterized ( see below ) , the crucial inputs for an optimal solution ( in the least - squares sense ) are accurate representations of the psfs as a function of position in both the science and reference images .",
    "these psfs then effectively take - on the role of @xmath185 and @xmath64 in equation ( [ imgmodel ] ) . to account for spatial dependencies , we estimate the psfs over a grid of @xmath187 image partitions where @xmath188 are specified by _ _",
    "( currently @xmath189 or @xmath190 for iptf ) .",
    "the boundaries of the partitions are made to overlap by a length equal to half the kernel image width ( input _ _ ; currently @xmath191 pixels ) .",
    "the partition size is determined from an analysis of the coherency in psf - shape versus position , balanced against the typical number of point - sources expected therein in order to obtain psfs of reasonable s / n when all sources are combined .",
    "our derivation of @xmath178 is highly sensitive to input noise and therefore every attempt is made to maximize the pixel s / n in the final psf images , for all image partitions .",
    "figure  [ fig : makepsfs ] gives an overview of the steps used to construct the @xmath192 high quality psf images for all partitions in the preprocessed science and reference images .",
    "the primary input is a list of clean point - sources from the input reference _",
    "sextractor _ catalog , with @xmath81 centroid positions in the _ resampled _ reference image frame .",
    "these are the same filtered point - sources used for the relative gain - matching and astrometric refinement steps described in section  [ garef ] .",
    "the sources are assigned to their specific image partitions and we require a minimum of @xmath193 sources ( parameter _ _ ) per partition .",
    "the maximum is capped at @xmath194 ( _ _ ) where if exceeded , the brightest @xmath195 sources in the partition are selected .",
    "this maximum is imposed for runtime reasons , but still provides a sufficient overall s / n when all sources are combined .        for a given image partition @xmath196 , square stamps of linear size _ _ ( @xmath197 )",
    "pixels centered on the reference - image - based source centroids are cut from the ( already registered ) science and reference images .",
    "the reason for using the same ( reference ) position on both images is that we want to preserve any possible local astrometric shift between stamps of the same source from each image .",
    "this shift ( if significant ) will persist into the final respective psf images and be subsequently captured by the kernel solution @xmath178 .",
    "this will allow any local systematic shifts to be corrected following the application of @xmath178 to its respective image partition ( section  [ appkern ] ) .",
    "the point - source cutouts are then filtered to remove cases with large numbers of masked pixels .",
    "each stamp is then interpolated into a new pixel grid so that the input ( fractional - pixel ) source centroids are made to fall close to their geometric centers , i.e. , to correct for the truncation error when creating the initial cutouts using integer pixel coordinates .",
    "this registration step is important prior to stacking the point - source stamps .",
    "the stamps are then background - subtracted to ensure a zero - median background level outside an aperture with size specified by _ _ .",
    "pixel signals inside this aperture from _ only the reference image _ cutouts are then integrated and used to flux - normalize each matching science and reference image cutout of the same source .",
    "the reason is similar to that mentioned above for source positions  it preserves any possible residual in the relative gain that can later be modeled and removed by @xmath178 .",
    "if the debug switch was set , the point - source image cutouts can be individually written to fits format with file suffixes _ _ noconv_p**_m_**_stp**_n_**.fits _ and _ _ toconv_p**_m_**_stp**_n_**.fits _ for the science and reference image respectively , where * m * is the partition identification index and * n * is the source index therein .    the homogenized point - source cutouts for partition @xmath196 are then separately stacked for the science and reference images .",
    "the first step involves using robust statistics to identify and mask outlying pixels in the pixel stacks .",
    "the stamps are combined using a weighted average where weights are the inverse of the pixel variances computed from the background in each stamp ( outside an aperture with radius _ _ ) .",
    "this results in two psf images for partition @xmath196 , one for the science and another for the reference image .",
    "the psf images are further cleaned for possible pixel outliers using winsorization ( e.g. , * ? ? ?",
    ", pixels that exceed some threshold ( a multiple of the robust spatial rms above or below the background ) are replaced with the threshold value .",
    "this replacement ( when used with a high threshold ) does not inadvertently distort the psf shape . the input parameters and thresholds for the above steps are specified by the _ _ input string .",
    "the source - cutout and stamp - stacking process is performed on all @xmath131 partitions .",
    "this results in two _ preliminary _ ( science and reference ) psf images per partition , assuming there were enough point sources therein ( i.e. , exceeding @xmath198 ) .",
    "if the debug switch was set , these can be written to fits format with filename suffixes _",
    "_ noconv_p**_m_**_psfcoad.fits _ and _ _ toconv_p**_m_**_psfcoad.fits _ for the science and reference image respectively , where * m * is the partition index . accompanying pixel - depth maps showing the final number of stacked pixels",
    "are also generated with _",
    "_ psfcoad.fits _ replaced by _ _",
    "psfcoaddepth.fits _ in these filenames .",
    "these psfs are preliminary in the sense that there is no guarantee that all are of sufficient quality with good overall s / n across all partitions . for example",
    ", a partition could fall on a highly confused region , exhibit a complex background , or not have enough good quality point - sources . to account for this",
    ", we further regularize the psfs for approximate consistency across all partitions .",
    "this includes replacing a bad psf with a better quality one from a neighboring partition .",
    "a consequence of this replacement is that the selected psfs ( for a common science and reference partition ) will no longer represent the true psf shapes for that partition .",
    "this is a small loss since this replacement does not occur often , and when it does occur , the overall psf variation is small enough that the impact to the psf - matching is negligible when another partition s psfs are used .",
    "these regularization steps are described in more detail below , with control parameters also specified by the _ _ input .",
    "we first correct any psf pairs with a large residual gain relative to all other psf pairs from other partitions .",
    "the residual gain is estimated using the ratio of the sum of _ normalized _ psf pixel values for the pair .",
    "ratios that deviate by more than some threshold from the median pixel - sum ratio over all partitions have their respective psf pixels rescaled to match the median ratio .",
    "this median ratio is typically unity due to the global gain - matching performed earlier ( section  [ garef ] ) .",
    "note that this `` gain - homogenization '' is only intended to correct psf pairs with large outlying residuals in their relative gain .",
    "next , we allocate the final psf pairs to each partition by enuring that first , there were enough sources to make psfs in the first place ( i.e. , @xmath199 ) and second , that the rss of their robust spatial rmss were below some threshold .",
    "if either of these conditions are not satisfied for a partition , we assign psfs from that partition with the lowest rssd rms value . each overlapping science and reference image partition is now associated with a high quality pair of psfs , ready for the psf - matching step .",
    "figure  [ fig : egpsfs ] shows an example of the psfs for two image partitions and the resulting matching kernels @xmath178 using the formalism in section  [ pkern ] . as expected , the reference image psfs will have a higher s / n and appear smoother since the references were initially created from a stack of science images .    .",
    "pixel sizes are the same throughout .",
    "the kernel images are enlarged for clarity . ]",
    "given high s / n representations of the science and reference - image psfs for a spatial partition , with psf pixel values @xmath181 and @xmath182 respectively at common coordinates @xmath77 , we outline below the method used to obtain an optimal solution for the convolution kernel @xmath178 and differential background @xmath180 in equation ( [ imgmodel ] ) . following previous approaches ,",
    "these can be derived by minimizing a weighted sum of the squared residuals between a model and some new image ( here the science image psf ) ; for example , using the objective function : @xmath200 - db }                                  { \\sigma_{ij}}\\right]^2,\\ ] ] where @xmath201 are prior pixel uncertainties in the @xmath181 that may include some scaled contribution from @xmath182 ( see below ) .",
    "equivalently , equation ( [ chi2 ] ) can be recast in vector - matrix notation : @xmath202 where @xmath203 is the full error - covariance matrix to account for possible correlated errors between the input pixels , and @xmath204 is the model - image with elements : @xmath205 + db.\\ ] ] strictly speaking , the objective function @xmath206 can only be compared to a true @xmath120 distribution with degrees - of - freedom @xmath207 for the purpose of validating model solutions using probabilistic inference if the input data errors are normally distributed ; i.e. , @xmath208 . these errors can be interdependent ( and if so , need to be captured by @xmath203 ) , but they do need to be identically distributed for @xmath120-validation purposes .",
    "the null hypothesis is that the model ( equation  [ mod ] ) `` generated '' the @xmath181 .",
    "furthermore , for linear parameterizations of @xmath178 ( see below ) , the minimization of @xmath206 reduces to a generalized linear least - squares problem with a solution that is _ unique _ and _ optimal _ in the maximum - likelihood sense for normally distributed errors .",
    "another important consideration is that the input errors @xmath184 are _ heteroskedastic _ ,",
    "i.e. , they are not identically distributed with constant variance over the input pixels @xmath77 .",
    "this is because we are exclusively fitting point - source data where poisson noise dominates .",
    "the noise - variance will have a spatial dependence following the shape of the psf profile ( @xmath181 ) . even though this dependence can be accounted for by using prior weights derived from the pixel uncertainties ( @xmath209 or @xmath210 ) that implicitly include poisson - noise , their direct use in @xmath206 will lead to biased estimates for @xmath178 and @xmath180 .",
    "this was explored in a different context by @xcite .",
    "a number of complex variance - stabilizing methods exist to ensure unbiased estimates . for simplicity",
    ", we omit the use of prior weights when estimating @xmath178 and @xmath180 . our solution will still be optimal in the least - squares sense and will also be close to the maximum - likelihood solution for normally - distributed errors in general .",
    "even though the exclusion of weighting in equation ( [ chi2 ] ) prohibits the use of goodness - of - fit tests in an absolute ( probabilistic ) sense , relative changes in the global @xmath206 can be used to validate the performance of different kernel solutions when applied to full images ( see section  [ diffqa ] ) . for completeness",
    ", we continue to carry the @xmath201 term ( as represented in equation  [ chi2 ] ) in our derivations below . in the end , our estimates are really solutions to an ordinary linear least - squares ( ols ) problem .",
    "our construction in equations ( [ imgmodel ] ) and ( [ chi2 ] ) assumes that the image containing the narrower psf is the one that should be convolved . however , there is no guarantee that this image is always the reference psf ( @xmath182 ) and hence without loss of generality , @xmath181 and @xmath182 can be interchanged .",
    "it is therefore important to predefine the convolution direction .",
    "this can be specified by the _ _ input string .",
    "the choices are _ sci _ , _ ref _ , or _ auto_. the _ sci _ and _ ref _ options always force the science ( @xmath181 ) or reference ( @xmath182 ) image pixels to be convolved respectively .",
    "the _ auto _",
    "option allows an automatic selection of the image to convolve and is our current operating mode .",
    "this selection is based on comparing global - image measures of the fwhm values of filtered stars from the science and reference images .",
    "the fwhm values are from 2d gaussian fits performed by _",
    "these values are medianed to yield two measures : @xmath211 and @xmath212 .",
    "the automatic selection is based on the value of the relative difference @xmath213 currently if @xmath214 , the science image is selected for convolution , otherwise the reference image is selected , i.e. , as depicted in the estimation equations above .",
    "the threshold for @xmath215 was tuned by examining distributions in @xmath211 and @xmath212 from many images and setting a conservative value to allow for uncertainty in the median fwhm estimates . in other words , the fuzzy interval @xmath216 implies the overall _ sci _ and _ ref _ psf fwhm measures are consistent within measurement error . note that the fwhm measure is assumed to be a good proxy for psf shape in general , at least to first order for the purpose of defining a convolution direction .",
    "when the psf fwhms are consistent , no useful information is expected in the kernel solution , i.e. , aside from noise and perhaps variations incurred by higher - order psf - shape differences .",
    "the kernel then effectively becomes a single spike ( i.e. , a @xmath215-function ) where in principle , no psf - matching would be required .",
    "usually ( for @xmath217% of science image exposures encountered ) , the reference images are those selected for convolution since by design , these were constructed from archived science images with moderately better seeing than average , in addition to being weighted by their inverse - seeing ( section  [ refcon ] ) . however , for cases where the science image ( @xmath181 ) is selected for convolution , the roles of @xmath181 and @xmath182 are interchanged in equations ( [ chi2 ] ) and ( [ mod ] ) so that @xmath181 convolved with @xmath178 becomes the model - image fitted to the data , @xmath182 .",
    "this complicates the error and weighting structure if a true @xmath120 objective function ( based on equation  [ chi2 ] ) were to be used for estimation since the model would be noisier than the data being fitted .",
    "this is another reason for omitting the use of prior weights in the objective function and treating it as a simple ols problem .",
    "the application of @xmath178 to the noisier @xmath181 image also causes a larger fraction of the noise to be correlated in the final difference image .",
    "this is further discussed in section  [ appkern ] .    as mentioned above ,",
    "linear parameterizations for @xmath178 are the simplest to solve from a computational standpoint , for example , by expanding @xmath178 as a linear combination of @xmath218 basis functions : @xmath219 and solving for the @xmath218 coefficients @xmath220 . a traditional choice for the @xmath221 are gaussians of different width , each modified by a 2d shape - morphing polynomial .",
    "the @xmath220 are further expanded into another polynomial in @xmath129 to model possible dependencies over the focal plane .",
    "this is the classic psf - matching algorithm of @xcite and @xcite , and extended by @xcite .",
    "this algorithm has been successfully used by several time - domain surveys , e.g. , ogle @xcite , la silla - quest @xcite , pan - starrs @xcite and the sdss - ii supernova survey @xcite .",
    "initially , we extensively validated this method for ptf ( at ipac , caltech ) as implemented in the hotpants[multiblock footnote omitted ] and diapl utilities @xcite .",
    "a major limitation was the specification of a number of fixed configuration parameters .",
    "these parameters are not fitted , i.e. , the gaussian widths ( at least four were needed ) and the polynomial orders ( six more parameters ) .",
    "the overall performance was sensitive to the precise choice of these parameters .",
    "furthermore , the basis functions were not complex or flexible enough to model the bulk of the data encountered in the survey , under a continuum of atmospheric conditions and unforeseen instrumental behaviors . despite attempts to constrain the basis function constants using",
    "_ a - priori _ information in a dynamic manner ( e.g. , as prescribed by @xcite ) , a generic - enough representation for @xmath178 under this framework that kept the false - positive rate amongst transient candidates appreciably low and at a manageable level eluded us .",
    "a more flexible `` shape free '' basis representation for @xmath178 was proposed by @xcite . here",
    "the kernel is discretized into @xmath222 pixels and each pixel value therein , @xmath223 , is treated as a free parameter in the ols fitting problem .",
    "this free form basis is also referred to as the delta function representation where the kernel can be expressed as a 2d array of delta functions : @xmath224 a kernel size of @xmath225 pixels ( input parameter _",
    "_ ) then has 81 orthonormal basis functions when expanded as a linear combination according to equation ( [ lin ] ) . for comparison ,",
    "the best gaussian - basis model mentioned above has 252 free parameters for effectively the same amount of input data in the estimation process .",
    "apart from the kernel image size and threshold parameters used to creating the regularized psf - inputs ( section  [ preppsfs ] ) , there are no shape - based tuning parameters for the delta - function representation .",
    "for this reason , it can accomodate more generic shapes , as well as capture offsets in the astrometry on scales used to construct the input psf data @xmath181 and @xmath182 , coming from effectively a @xmath226 image partition .",
    "as we shall discuss , this unconstrained specification is both good and bad .    with this representation",
    ", the model image ( equation  [ mod ] ) can be written in terms of the unknown coefficients @xmath223 as follows : @xmath227 the objective function to minimize ( the equivalent of equation  [ chi2 ] ) then becomes : @xmath228 ^ 2.\\ ] ]    the optimal values of @xmath223 and @xmath180 are those that minimize @xmath206 , i.e. , where the partial derivaties of @xmath206 with respect to each parameter are all zero : @xmath229 these are evaluated at the specific parameter values indexed by @xmath230 for @xmath223 and @xmath231 to yield two general relations : @xmath232 and @xmath233 respectively .",
    "the kernel pixel indices in equations ( [ norm1 ] ) and ( [ norm2 ] ) have the ranges : @xmath234 where @xmath235 corresponds to the center pixel of the kernel with dimensions @xmath222 pixels and @xmath236 is a one - dimensional index : @xmath237 . for a given @xmath230 , @xmath238 equations ( [ norm1 ] ) and ( [ norm2 ] ) lead to a simultaneous system of @xmath239 equations in @xmath239 unknowns that can be written in the vector - matrix form : @xmath240 where @xmath241 is a vector containing the @xmath242 kernel - pixel unknowns @xmath243 ( @xmath244 ) and differential background estimate @xmath231 .",
    "equation ( [ ax ] ) can be inverted using standard techniques , and at first , @xmath241 was estimated directly using a @xmath245-decomposition of @xmath246 . however , in accord with previous analyses ( e.g. , * ? ? ?",
    "* ) , the unconstrained nature of a pure delta - function representation can make the @xmath223 solutions very sensitive to noise and contamination from non - psf related signal in the inputs @xmath181 and @xmath182 .",
    "the model - fit is therefore subject to _ over - fitting_. this is the so - called bias versus variance tradeoff where one is after a solution that is expressive enough to avoid biases , but not so complex as to introduce excessive variance when the solutions are later applied to match the psfs in an entire input image or partition . in the end , one is after the _ true _ psf - matching kernel for the two images . despite our attempts to mitigate noise in the input psf co - add stamps ( @xmath181 and @xmath182 ; section  [ preppsfs ] ) , noise is inevitable .",
    "one way to avoid overfitting and still maintain optimality is to invoke regularization in the estimation process .",
    "@xcite implemented a regularized version of the delta - function kernel model by introducing a tunable smoothing constraint in the @xmath120 objective function .",
    "this function is proportional to the second spatial derivative in the input pixels and is intended to penalize fits that are too irregular as a result of high - frequency noise .",
    "this regularization method was explored and validated in detail by @xcite from the aspect of maximizing photometric accuracy in final difference images .",
    "this extension is attractive , but it did not become known to us until after we had implemented an alternative regularized version of the delta - function model ( see below ) .",
    "this worked very well on ptf image data .",
    "we will refer to this method as the pixelated convolution kernel method ( or pick for short ) .",
    "instead of imposing a regularizing constraint on the objective function as in @xcite , our approach involves regularizing the coefficient matrix @xmath246 in equation ( [ ax ] ) .",
    "we perform a spectral decomposition , also known as an eigendecomposition of @xmath246 : @xmath247 where @xmath248 is an orthogonal matrix ( @xmath249 ) and @xmath250 is a diagonal matrix : @xmath251 with eigenvalues @xmath252 .",
    "the corresponding linearly independent eigenvectors of @xmath246 reside in the columns of @xmath248 .",
    "given @xmath246 is a real symmetric matrix , such a decomposition can always be found .",
    "this decomposition allows us to examine the basis vectors that will contribute to the kernel solution .",
    "the _ least_-important eigenvectors of @xmath246 are those associated with input noise and can be identified by their relatively small eigenvalues , below some threshold .",
    "these can then be `` zeroed - out '' . for example , the inverse of @xmath246 can then be written : @xmath253 where @xmath254 for all @xmath255 . for values",
    "@xmath256 ( within machine precision ) , the @xmath257 are replaced by zero in @xmath258 .",
    "this special replacement corresponds to the classic singular value decomposition ( svd ) method for handling singular ( ill - conditioned ) matrices .",
    "the inverse defined by equation ( [ inva ] ) then becomes the _ pseudo - inverse _ of @xmath246 .",
    "this approximation is better conditioned for obtaining a solution to the matrix equation in ( [ ax ] ) .",
    "the essence of the pick method is to make this svd - like replacement more generic and less restrictive on the specific @xmath259 to replace .",
    "the goal is to also make @xmath246 more regularized against noisy input data ( including singular cases ) by finding the largest eigenvalue @xmath260 such that @xmath261 for some threshold @xmath262 ( see below ) . for all @xmath263 ,",
    "we reset @xmath264 in @xmath258 and then proceed to obtain a solution . following the decomposition in ( [ inva ] ) , the solution vector @xmath241 in equation ( [ ax ] ) can be written @xmath265 in this form , it can be seen that the noisiest ( _ least_-relevant ) eigenvectors @xmath266 according to @xmath267 will not significantly contribute to @xmath241 . therefore , they can be eliminated by forcing @xmath264 .",
    "these eigenvectors can be also identified by their relatively small dot - products with the @xmath268 vector , @xmath269 , as shown in figure  [ fig : eigend ] .",
    "the threshold @xmath262 is dynamically derived on a _ per _ image - partition basis , i.e. , where an inversion of equation ( [ ax ] ) via ( [ inva ] ) is performed .",
    "this uses the following semi - empirical criterion : @xmath270}\\right\\},\\ ] ] where the second argument corresponds to the low - tail percentile of the _",
    "max_-normalized @xmath259 distribution .",
    "the values in equation ( [ crit ] ) were tuned by examining the eigendecompositions of @xmath246 using iptf image data acquired across different environments , from low source - density to densities approaching those in the galactic plane .",
    "a range of @xmath262 values were then tested by exploring the impact of the corresponding regularized solutions on the overall fit @xmath120 ( equation  [ chi2new ] ) .",
    "examples of these eigendecompositions are shown in figure  [ fig : eigend ] .",
    "the criterion in equation ( [ crit ] ) corresponds to approximately an inflexion point in the relative eigenvalue size .",
    "this choice is also conservative in the sense that the amount of legitimate high - frequency information thrown away ( not associated with noise ) is expected to be insignificant as determined by the change in @xmath120 with and without regularization ( @xmath271 ) .",
    "i.e. , we ensure that @xmath272 , where @xmath273 is the effective number of degrees of freedom . in the current setup for iptf ,",
    "@xmath274    the regularization threshold @xmath262 is also dependent on the size of the kernel assumed ( @xmath275 free parameters to solve ) since this determines the relative fraction of noise contributing to the @xmath223 estimates .",
    "the kernel image size was tuned beforehand to be small enough to avoid introducing too many free parameters that would result in overfitting on noisy backgrounds in the psf stamps , but large enough to accomodate the range of seeing ( point - source profile widths ) encountered .",
    "this ensures both unbiased kernel solutions and minimal variance following their application , i.e. , a compromise in the bias versus variance tradeoff mentioned above .",
    "when a psf - matching kernel image with estimates @xmath223 is available , a measure of the relative residual gain between the science and reference image pixels for a specific image partition ( from which @xmath181 and @xmath182 were extracted ) is given by the sum : @xmath276 the @xmath277 values ( across all image partitions ) can be used to assess the accuracy of the global relative gain correction computed upstream ( section  [ gm ] ) .",
    "more importantly , they provide local estimates of any residual photometric gain where if significant , can be used to refine the gain factor at the image partition level prior to differencing ( see section  [ appkern ] ) . @xmath277 also provides a diagnostic to assess the quality of the kernel solution .",
    "for example , an image partition with a @xmath277 that significantly deviates from unity compared to that of its neighboring partitions could indicate a problem in the estimation process , perhaps triggered by bad or low - quality input psfs . for details",
    ", see the discussion on quality assurance in section  [ diffqa ] .    to summarize , we have extended the free form delta - function model representation to derive psf - matching kernels by performing a simple regularization of the matrix system used for the least - squares solution .",
    "this uses an eigendecomposition to retain the most significant basis vectors within a statistically validated threshold .",
    "we have coined this the pick method .",
    "figure  [ fig : diffeg ] shows examples of input images , kernels , and the resulting difference images for a relatively dense field with and without regularization included .",
    "the relative change in @xmath120 ( equation  [ chi2new ] ) going from the unregularized to regularized solution for the entire image shown in figure  [ fig : diffeg ] is @xmath278 .",
    "the pick method leads to smoother psf - matching kernels and hence difference images in general .",
    "it is also robust against contamination in the input psfs ( @xmath181 and @xmath182 ) , for example when constructed from high source - density regions .",
    "the psf - matching convolution kernel is first normalized to unity to yield @xmath279 where @xmath277 was defined by equation ( [ ksum ] ) .",
    "@xmath280 is then convolved with the specific image partition that was initially selected for convolution using the method in section  [ pkern ] , i.e. , defining the convolution direction .",
    "the reason for decoupling @xmath277 ( the local relative gain factor ) from the raw kernel @xmath223 is so that any residual gain correction can be refactored and applied as a multiplicative correction on the science image pixels only , and not the resampled reference image , regardless of the convolution direction .",
    "this is consistent with our _ modus operandi _ in ptfide : all corrections are applied to the science image pixels , in order to match the photometrically and astrometrically calibrated reference image as best as possible .",
    "if the reference image was selected for convolution , the difference image pixel values for an image partition from which the kernel and differential background estimates were derived can be written : @xmath281 -            \\sum_l\\sum_m \\widetilde{k}_{lm } r_{(i+l)(j+m)}.\\ ] ] if the science image was selected for convolution , the difference image pixel values for the image partition can be written : @xmath282 - r_{ij}.\\ ] ]    two difference images per science , reference image pair are generated , a positive ( _ sci  ref _ ) and negative ( _ ref  sci _ ) difference image . as described in section  [ prodsum ] , this is to enable the detection of transients and variables that happen to be below the reference - image baseline level at any observation epoch .",
    "the positive and negative difference images are written to fits formatted files with filename suffixes _",
    "_ pmtchscimref.fits _ and _ _ pmtchrefmsci.fits _ respectively . if the debug switch was set , ancillary products representing the different components of equations ( [ diffrefc ] ) or ( [ diffscic ] ) prior to differencing can also be generated ( see table  [ tab : sout ] ) .",
    "these are the final science image , convolved or not with @xmath277 and @xmath231 applied : _ _ scibefdiff.fits _ , and the convolved counterpart : either @xmath283 or @xmath284 : _ _ pmtchconvref.fits _ or _ _ pmtchconvsci.fits _ respectively .",
    "the science and reference image bad - pixel masks generated upstream ( section  [ bp ] ) include the effects of convolution where bad pixel regions are expanded accordingly . these are combined to produce a final effective bad - pixel mask for both the positive and negative difference images . if the debug switch was set , this can also be written to fits format with filename suffix _ _",
    "pmtchdiffmsk.fits_. furthermore , all bad pixels in the difference images are tagged with value -999999 .",
    "an image of the 1-@xmath5 uncertainties corresponding to the @xmath285 images ( equation  [ diffrefc ] or [ diffscic ] ) is also generated .",
    "these uncertainties are estimated by rssing the input uncertainties for the science and reference images ( equations  [ sigsci ] and [ sigref ] respectively in section  [ punc ] ) with a correction for correlated - noise : @xmath286 the correlated - noise correction factor @xmath287 accounts for the _ diminution _ in the pixel rms noise ( lost to covariance ) due to the convolution process . recall that this convolution may have been performed on either the science or reference image ( see above ) .",
    "@xmath287 is approximated as the ratio of the robust pixel rms in the actual difference image to the rssd background rmss in the science and reference images prior to any convolution : @xmath288 the background variances in the denominator of equation ( [ fc ] ) are the same estimates used in equations ( [ sigsci ] ) and ( [ sigref ] ) of section  [ punc ] .",
    "the presence of correlated - noise in the difference image will underestimate the photometric uncertainties of extracted sources therefrom if not properly accounted for on the spatial scales of interest ( i.e. , the spatial - extent on which the photometry is performed ) .",
    "note that @xmath287 does not represent any correction at the source level .",
    "its purpose is to capture any modification to the input uncertainties ( @xmath289 and @xmath290 ) due to smoothing from the psf - matching process .",
    "the source level correction is computed and applied during the source extraction step ( see section  [ psffit ] ) .",
    "following application of the spatially - dependent convolution kernels and associated gain - corrections ( @xmath277 ) to the science image pixels ( equations [ diffrefc ] and [ diffscic ] ) , we compute a new photometric zeropoint for the adjusted science image .",
    "this zp will also be applicable to the difference images generated therefrom .",
    "it provides a sanity check on the global - image _ zpsci _ value computed upstream using the input _ absolutely _ calibrated reference image photometry ( see section  [ rzp ] ) . as mentioned , _",
    "zpsci _ enables a more accurate absolute calibration of either psf - fit or big - aperture photometry .",
    "the new zp is only computed if the _ _",
    "switch was specified on input .",
    "if so , it is written as the _ zpdif _ keyword with accompanying rms _ zpdifrms _ to the fits headers of both the positive and negative difference images .",
    "the computation uses exactly the same methodology as outlined in section  [ rzp ] .",
    "if the debug switch was set , a catalog of the reference - to - science image matches used to compute _ zpdif _ is generated with suffix _",
    "_ sx_scibefdiff.tbl_. when the psf - matching and additional gain - refinement steps perform as intended , _ zpdif _ is generally consistent with _ zpsci _",
    ", within random measurement error .",
    "large deviations in @xmath291 usually imply a problem with either the psf - matching kernel(s ) , the input astrometry , or its later refinement since astrometric accuracy will indirectly affect the source matching step used to estimate the zps . @xmath292",
    "therefore provides a powerful quality assurance metric .",
    "metrics and diagnostics for a difference image product are shown in table  [ tab : iqa ] .",
    "these encompass information on photometric zeropoints ; pixel statistics before and after psf - matching ; properties of the psf - matching kernels ; statistics on the input science and reference images ; global image fwhm values ; and the number of candidates extracted ( section  [ ctp ] ) .",
    "these metrics are used to support later machine - learned vetting ( section  [ ml ] ) .    in ptfide processing ,",
    "two checks are performed to assess the quality of the difference   @xmath293 ( bad ) or 1 ( good)@xmath294 $ ] . even though candidates are extracted under ( ii ) during processing , these are not loaded into the database ( section  [ schema ] ) .",
    "the rationale is that bad subtractions will lead to thousands of spurious candidates and strain both database loading as well as machine - learned vetting downstream .",
    "the conditions for ( i ) and ( ii ) are determined using one - dimensional cuts on a number of metrics from table  [ tab : iqa ] as follows .",
    "first , a difference image is flagged _ atrocious _ if the following criteria are satisfied : @xmath295 where in terms of the metrics listed in table  [ tab : iqa ] , @xmath296 and the seven thresholds ( @xmath297 ) are specified by the _ _ input string with defaults defined in table  [ tab : inp ] .",
    "lcc atrocious & 25.0% & 0.42% + bad & 34.5% & 11.18% + good & 40.5% & 88.40% +    if the difference image is not labelled atrocious according to the criteria in ( [ icuts1 ] ) , it is subject to the less - severe criteria below .",
    "these are applied after transient candidates are extracted .",
    "the metrics used here are therefore a subset of those from above ( but with lower `` badness '' thresholds ) and others related to the number and properties of candidates extracted .",
    "see table  [ tab : iqa ] for definitions .",
    "@xmath298   . ] the eleven thresholds ( @xmath299 ) are specified by the _ _ input string with defaults defined in table  [ tab : inp ] .",
    "if the criteria in ( [ icuts2 ] ) are satisfied , _ status _ @xmath300 is assigned to indicate a possibly bad difference .",
    "this flag is propagated to the _ subtractions _ table of the transients database ( section  [ schema ] ) .",
    "table  [ atfrac ] summarizes the percentages of _ atrocious _ , _ bad _ , and _ good _ difference images obtained from real - time processing for two sky regions spanning different galactic latitudes and longitudes .",
    "these regions sample the extremes in source - density : near the galactic center and bulge , and high galactic latitudes .",
    "these were covered by iptf from august 2015 to january 2016 .",
    "the high fraction of failures near the galactic center ( or bulge ) can be attributed to adverse effects from high source confusion on the processing steps prior to differencing , for example , astrometric calibration , and/or gain and psf - matching .",
    "all these steps depend on source - matching of some kind between the science and reference images , and is severely challenged in regions of high source density . for examples of bad or unusable difference images and their causes , see section  [ train ] .",
    "if the debug switch was set , an image of the locally - smoothed pixel chi - square is generated for both positive and negative difference images .",
    "this is analogous to a _ reduced _ @xmath120 and is defined as : @xmath301 where the angled brackets denote boxcar averaging over pixels @xmath77 that fall within @xmath302 pixel bins over the difference image .",
    "the image generated from equation ( [ chimg ] ) is written to a fits formatted file with suffix _ _ pmtchdiffchisq.fits_. large values in @xmath303 ( significantly above unity ) may indicate residuals from imperfect instrumental calibrations , underestimated pixel uncertainties , or the presence of real transient sources .",
    "small values ( @xmath304 ) will imply that the pixel uncertainties are overestimated .",
    "p4.5cmp12 cm zpmaginpsci & photometric zeropoint ( zp ) estimate of science image _ before _ rescaling to reference [ mag ] + zpmaginpsciunc & 1-@xmath5 uncertainty in zpmaginpsci [ mag ] + zpmagcormed & median zp correction offset to zpmaginpsci over all partitioned convolution kernel sums [ mag ] + zpmagcormin & min .",
    "zp correction offset to zpmaginpsci over all partitioned convolution kernel sums [ mag ] + zpmagcormax & max .",
    "zp correction offset to zpmaginpsci over all partitioned convolution kernel sums [ mag ] + zpmaginpscicor & refined photometric zeropoint ( zp ) of science image following application of kernel sums : `` zpmaginpsci @xmath13 zpmagcormed '' [ mag ] + zpfacinpsci & photometric scale factor applied to science image to match reference image zp + zpfacinpsciunc & 1-@xmath5 uncertainty in zpfacinpsci + zpref & photometric zeropoint ( zp ) of input reference image [ mag ] + nmatch & number of sources matched within 3.0 pixels between science and reference images to support initial gain - matching and astrometric refinement + fluxrat & median flux ratio of matched sources prior to global gain - matching : @xmath305 + pctfluxrat & @xmath306 percentile range in fluxrat values of matched sources + deltax & median positional difference along x - axis using matched sources : @xmath307 [ pixels ] + sigdeltax & 1-@xmath5 uncertainty in deltax [ pixels ] + pctdeltax & @xmath306 percentile range in deltax values across matched sources [ pixels ] + deltay & median positional difference along y - axis using matched sources : @xmath308 [ pixels ] + sigdeltay & 1-@xmath5 uncertainty in deltay [ pixels ] + pctdeltay & @xmath306 percentile range in deltay values across matched sources [ pixels ] + medksum & median pixel - sum of all image - partitioned raw convolution kernel sums + minksum & minimum pixel - sum of all image - partitioned raw convolution kernel sums + maxksum & maximum pixel - sum of all image - partitioned raw convolution kernel sums + medkdb & median differential background over all image - partitioned raw convolution kernels [ dn ] + minkdb & minimum differential background over all image - partitioned raw convolution kernels [ dn ] + maxkdb & maximum differential background over all image - partitioned raw convolution kernels [ dn ] + medkpr & median @xmath306 percentile pixel range of all image - partitioned raw convolution kernels + minkpr & minimum @xmath306 percentile pixel range of all image - partitioned raw convolution kernels + maxkpr & maximum @xmath306 percentile pixel range of all image - partitioned raw convolution kernels + zpdiff & photometric zero point of difference image [ mag ] + ngoodpixbef & number of good pixels in difference image before psf - matching [ pixels ] + ngoodpixaft & number of good pixels in difference image after psf - matching [ pixels ] + nbadpixbef & number of bad pixels in difference image before psf - matching [ pixels ] + nbadpixaft & number of bad pixels in difference image after psf - matching [ pixels ] + medlevbef & difference image median level before psf - matching [ dn ] + medlevaft & difference image median level after psf - matching [ dn ] + avglevbef & difference image average level before psf - matching [ dn ] + avglevaft & difference image average level after psf - matching [ dn ] + medsqbef & median of squared differences before psf - matching [ @xmath309 + medsqaft & median of squared differences after psf - matching [ @xmath309 + avgsqbef & average of squared differences before psf - matching [ @xmath309 + avgsqaft & average of squared differences after psf - matching [ @xmath309 + chisqmedbef & difference image chi - square using median before psf - matching + chisqmedaft & difference image chi - square using median after psf - matching + chisqavgbef & difference image chi - square using average before psf - matching + chisqavgaft & difference image chi - square using average after psf - matching + scibckgnd & modal background level in science image after gain and background matching [ dn ] + refbckgnd & modal background level in ref - image after gain , background matching , and resampling [ dn ] + scisigpix & robust sigma per pixel in science image after gain and background matching [ dn ] + refsigpix & robust sigma per pixel in ref - image after gain , background matching , and resampling [ dn ] + scigain & effective electronic gain in science image after gain - matching [ e-/dn ] +    scisat & saturation level in science image after gain - matching [ dn ] + refsat & saturation level in reference image after resampling [ dn ] + scimaglim & expected 5-@xmath5 magnitude limit of science image after gain and background matching [ mag ] + refmaglim & expected 5-@xmath5 mag .",
    "limit of ref - image after gain , background matching , and resampling [ mag ] + diffbckgnd & median background level in difference image [ dn ] + diffpctbad & percentage of difference image pixels that are bad / unusable [ % ] + diffsigpix & robust sigma per pixel in difference image [ dn ] + diffmaglim & expected 5-@xmath5 magnitude limit of difference image [ mag ] + sciinpseeing & seeing ( point source fwhm ) of input science image [ pixels ] + refinpseeing & seeing ( point source fwhm ) of input reference image [ pixels ] + refconvseeing & seeing ( point source fwhm ) of reference image after convolution [ pixels ] + ncandraw & number of candidates extracted from difference image before any internal filtering ( for positive and negative difference ) + ncandfilt & number of candidates extracted from difference image after internal filtering using _ chi _ , _ sharp _ , and _ snr _ source metrics ; this is the actual number loaded into database ( for positive and negative difference ) + ncandgood & number of candidates from difference image likely to be real using 1-d cuts on several extracted source features ( for positive and negative difference ) + nrefsrcstodifflim & number of reference image extractions to difference - image mag limit ( diffmaglim ) + ncandfiltrat & ratio : ncandfilt / nrefsrcstodifflim ( for positive and negative difference ) + status & good / bad difference image status flag ( @xmath310 1 or 0 ) ; based on combining a number of internal image metrics ( see section  [ diffqa ] ) . only candidates from status @xmath310 1 subtractions are loaded into database for vetting +      the detection and photometry of transient candidates on both the positive and negative difference images is performed using an automated implementation of the _ daophot _ tool @xcite .",
    "this includes the subsidiary program _ allstar _ which performs psf - fit photometry on the detections found by _",
    "daophot_. the primary output photometry for characterizing transient candidates is psf - fitting .",
    "fixed concentric aperture photometry is also generated as a diagnostic .",
    "the benefits of psf - fit photometry can not be stressed enough , at least for detecting transient events .",
    "for example , this provides better photometric accuracy to faint fluxes ; the ability to de - blend confused sources ; and simple metrics to distinguish point ( psf - like ) sources from artifacts .",
    "these metrics can be used to maximize the reliability of candidates .    _",
    "perl _ routines were written to automate all decision - related and processing steps in _",
    "daophot_. these steps would have been done interactively in classic _",
    "daophot_. this includes all file i / o , parameter handling , checking of outputs , and quality assurance .",
    "the steps are summarized below .",
    "_ daophot _ first detects sources for input into either the psf - determination step or final psf - fitting step using a matched filter via its _ find _ algorithm .",
    "the filter is constructed from a gaussian with a proxy for the image fwhm computed upstream using _ sextractor _ on the science image .",
    "this gaussian is convolved with the image in question to construct the point - source matched filter , i.e. , an internal product that is optimized for point - source detection .",
    "this assumes that the psf is approximately spatially uniform over the image , and for the purpose of detection , the penalty in detection s / n by not using the precise spatially - varying psf is negligible .",
    "this image is then background - subtracted using local estimates of the background . the pixel - uncertainty product from equation ( [ sigdif ] ) , which effectively includes contributions from detector read - noise , background , and poisson noise at the location of sources , is internally readjusted to account for the matched filtering .",
    "the ratio of the match - filtered , background - subtracted image and its corresponding uncertainty image is then thresholded .",
    "either the _ _ or _ _",
    "s / n parameter threshold is used depending if psf - determination or final dectection is desired respectively . if the debug switch was set , the detection tables from these steps are written to files with extension _ .coo _ ( see table  [ tab : sout ] for filenames ) .",
    "psf generation and psf - fit photometry ( or source extraction of any form ) are only attempted if the input difference image was determined to be of sufficient quality according to a number of quality metrics ( see section  [ diffqa ] ) . if not",
    ", ptfide processing terminates gracefully after the image differencing step .",
    "furthermore , psf - fit photometry can be intentionally turned off by omitting the _ _ switch .",
    "the base parameters specific to _ daophot _ and _ allstar _ reside in configuration files specified by _ _ and _ _ , with some of the more important ( threshold - like ) parameters therein overridden by the command - line inputs : _ _ , _ _ , and _ _ . also , some parameters are computed dynamically within _",
    "ptfide.pl _ and override those from both the input files and command - line .",
    "these parameters are those that depend on the image noise , usable pixel range , and image fwhm : _ re , lo , hi , fw , ps , fi , _ and nested aperture radii @xmath311 where @xmath312 .",
    "the parameters that depend on the input fwhm ( _ fw _ ) are the linear - half - size of the psf image stamp , _ ps _",
    "( for psf - creation only ) ; the psf - fitting radius , _ fi _ ; and the aperture radii @xmath311 , all in units of pixels . respectively , these parameters are adjusted according to : @xmath313              + 0.5\\}\\right ) , \\\\ fi = \\ , & \\text{min}\\left(7 , \\text{max}\\left[3 , fw\\right]\\right ) , \\\\",
    "a_i = \\ , & \\text{min}\\left(15 , 1.5 \\text{max}\\left[3 , fw\\right]\\right ) + i - 1 , \\end{aligned}\\ ] ] where @xmath312 , and min , max , int denote the minimum , maximum , and integer part of the argument respectively .",
    "_ is run in psf - fit photometry mode ( with the _ _ switch ) , only one aperture measurement corresponding to a single fixed aperture is written to the primary output tables : file suffixes _ _ pmtchscimrefpsffit.tbl _ and _ _ pmtchrefmscipsffit.tbl _ for the positive and negative difference images respectively .",
    "this is the aperture number @xmath314 corresponding to the user - specified parameter _ _ ( currently @xmath315 ) . if however , the _ _ switch was also specified , all nested aperture measurements ( @xmath312 ) are written to separate tables with file suffixes _ _ pmtchscimrefapphot.tbl _ and _ _ pmtchrefmsciapphot.tbl_. these products are not currently generated in production .",
    "it s important to note that the aperture measurements are not curve - of - growth corrected to account for the variable seeing .",
    "they only serve as diagnostics ( or source features ; table  [ tab : sqa ] ) to support machine - learned vetting ( section  [ ml ] ) .",
    "the psf used for psf - fitting is estimated automatically using utilities within _ daophot _ and _ allstar_. its shape over a ccd image is modeled as a linear function in @xmath129 .",
    "this dependence is sufficient to catch spatial variations in the psf and avoids introducing too many free parameters .",
    "the psf is always estimated from the _ resampled _ and possibly convolved reference image ( following psf - matching ) .",
    "this is because the reference image ( convolved or not ) is expected to have a higher s / n than the science image . in the end , we want to estimate the psf on an image whose point - source profiles match those in the difference image ( either positive or negative ) . in theory ,",
    "given that the only operations performed on the input images prior to differencing are gain , background and psf - matching , and given that differencing is a linear operation , either the science or reference image would have sufficed for psf estimation .",
    "for iptf , no more than the brightest 200 point sources with magnitudes @xmath316 are automatically selected per ccd image to estimate an initial spatially - varying psf .",
    "this is refined in a second iteration by subtracting neighboring sources ( in the wings ) from the initially chosen psf stars and then re - estimating the psf .",
    "this second iteration can be rather slow if there are many neighbors since it involves psf - fitting to obtain the fluxes and positions of the neighbors to subtract . to speed up the process",
    ", we regulate the number of neighbors to consider by only subtracting the brightest 1000 neighbors to all the initially psf - picked stars .",
    "therefore , given a random distribution of sources and @xmath317 sources picked for psf generation , @xmath318 ( brightest ) sources on average will be subtracted prior to refinement of the psf in the second iteration .",
    "this makes the psf estimation relatively fast and robust , and there are always enough stars in an image to yield a reasonably accurate psf model .    the psf model is stored in the default _ daophot _ format , with output file suffix _ _ pmtchconvrefdao.psf _ if the reference image was convolved , otherwise _ _",
    "resamprefdao.psf _ if the science image was convolved .",
    "this file consists of a look - up table of corrections to a best - fitting gaussian basis model over the image .",
    "other basis functions are available , but we found a gaussian works reasonably well for ptf data ( in terms of photometric accuracy ) .",
    "this basis representation also has the least number of free parameters .",
    "if the debug switch was set , the _",
    "daophot_-formatted psf file is converted to a fits image of @xmath121 psf - stamps for visualization ( output file suffix _ _",
    "pmtchconvrefdaopsf.fits_ ) .",
    "other ancillary files , e.g. , the list of psf - picked stars , their neighbors , and ds9 region files are also generated ( see table  [ tab : sout ] ) .",
    "following psf estimation , sources are detected on the positive and negative difference images above a specific threshold as described in section  [ srcdet ] .",
    "psf - fit photometry is then performed using _",
    "allstar_. this program estimates seven quantities per input detection : flux ; flux uncertainty ( to be rescaled later , see below ) ; refined image _",
    "x , y _ position ; uncertainties in _ x , y _ ; and two metrics from the fit : _ chi _ , and _ sharp _",
    "( see below ) .",
    "we do not iteratively subtract the psf to uncover new sources that were missed in the first detection pass , e.g. , because they were hidden in the wings of brighter sources .",
    "this is commonly done for crowded fields .",
    "given we are extracting sources from difference images , source - crowding ( or rather , blending of transient candidates ) is largely absent , even in areas of high source density .",
    "one can argue however for cases where instrumental residuals could blend with real transient sources .",
    "this is also rare , but nonetheless the components of a blend only need to be detected in the first place so that simultaneous psf - fitting can yield fluxes and other metrics for further examination downstream .",
    "the psf - fit fluxes are converted to absolute calibrated magnitudes using the _ zpsci _ image zeropoint computed upstream ( section  [ rzp ] ) .",
    "this places the photometry on the ptf filter system @xcite .",
    "note that the supposedly refined _ zpdif _ value ( section  [ czp ] ) is not used since analyses have shown that it exhibits a greater variance than _",
    "zpsci_. this arises from systematics in the psf - matching and relative gain - matching process .",
    "the source _ x , y _ positions are converted to r.a . , dec . using the difference image wcs ( inherited and refined from the reference image wcs ) .",
    "this information is written to the transient - candidate extraction tables ( one for each difference image ; see above ) .",
    "ds9 region files also accompany these tables ( see table  [ tab : pout ] for filenames ) .",
    "another detail is correcting the flux uncertiainties from psf - fitting for correlated pixel - noise in the difference image .",
    "as discussed in sections  [ punc ] and [ appkern ] , correlated noise arises from the reference - image construction process ( interpolation and resampling ) , but the more dominant effect is from convolution by the psf - matching kernel , where either the science or reference image may have been convolved . given that the reference image has a higher s / n in general , and that this is the image that is usually convolved ( by design ) , the fraction of the pixel noise that is correlated in a difference image is likely to be small .",
    "for example , if the reference image is made from a stack of @xmath319 science images all with similar pixel noise - variances , the fractional contribution to the difference image pixel - noise from the ( convolved ) reference would be @xmath320 .",
    "if the science image were convolved however , the fractional contribution would be greater , i.e. , @xmath321)^{-0.5}$ ] , approaching 100% if @xmath319 is large .",
    "we use a simple method to correct the source - flux uncertainties from psf - fit photometry before writing them to the photometry tables .",
    "the flux uncertainties from _ allstar _ are estimated using some combination of the difference image pixel uncertainties ( equation [ sigdif ] ) within the effective fitting area of the psf .",
    "following convolution ( smoothing ) of the one of the images , these will underestimate the true source - flux uncertainty .",
    "the true uncertainty contributed by the convolved image can be recovered by scaling its pixel uncertainties by the effective number of _ noise pixels_[multiblock footnote omitted ] defining the convolution kernel : @xmath322^{-1},\\ ] ] where @xmath280 are the unit - normalized pixel values of the kernel image ( equation  [ knorm ] ) .",
    "@xmath323 effectively represents the correlation length ( or in this case the correlation area ) in pixels .",
    "therefore , we seek a correction factor @xmath324 for scaling the difference image source flux variance which can also be written in terms of its science and reference image contributions , after convolution by @xmath280 : @xmath325 where we assume ( for illustration ) that the reference image was convolved .",
    "if the science image was convolved , @xmath323 would be multiplying the science image variance term .",
    "since all the flux - variance terms in equation ( [ srcvar ] ) are some weighted combination ( or effectively an rss ) of the pixel noise variances , in the limit of background - dominated noise , the correction factor can be estimated from : @xmath326}^2 }                   { \\sigma_{bckdiff}^2},\\ ] ] where the variances now denote robust estimates of the background pixel rms in the science , @xmath327 $ ] reference , and difference images .",
    "these quantities are estimated within respective image partitions , i.e. , the same partitions used to compute the kernel images ( and hence @xmath323 ) .",
    "this construction was verified using monte carlo simulations^[notenp]^.      the raw candidates initially extracted from the difference images as described in section  [ psffit ] undergo loose filtering prior to writing them to the transient - candidate tables ( file suffixes _ _ pmtchscimrefpsffit.tbl _ and _ _ pmtchrefmscipsffit.tbl _ for positive and negative difference images respectively ) .",
    "the intent is to catch the most deviant non - psf - like residuals from the difference images and remove them .",
    "this somewhat relieves traffic on database loads ( section  [ schema ] ) and the machined - learned vetting step ( section  [ ml ] ) which also heavily relies on interactions with the database .",
    "this simple filtering can result in reductions of up to a factor of five in the number of raw transient candidates initially _ detected _ from the point - source match - filtered image down to s / n @xmath328 ( _ _ input threshold ; table  [ tab : inp ] ) .",
    "it s worth mentioning that this relatively low initial detection threshold is to ensure completeness prior to further filtering and analysis downstream , including photometric s / n .",
    "the filtering applied to the raw detected candidates is @xmath329 ; @xmath330 ; @xmath331 , where the thresholds on the right are currently 8 , 4 , and 4 respectively ( from table  [ tab : inp ] ) .",
    "all these parameters are source - based metrics from psf - fitting and are defined as follows : @xmath332  the ratio of the rms in psf - fit residuals to that expected using prior pixel uncertainties ; @xmath333  effectively the difference between the squared fwhm of the source light profile ( from a 2d gaussian fit ) and that expected from the psf template model derived for the image , i.e. , @xmath334 ; and @xmath335  the photometric signal - to - noise ratio using the psf - fitted flux and uncertainty .",
    "relatively large values of @xmath332 and/or @xmath336 indicate deviations from the nominal psf template estimated upstream for the difference image ( section  [ psffit ] ) .",
    "the optimum values of @xmath332 and @xmath333 are 1 and 0 respectively .",
    "for example , a cosmic - ray spike would yield @xmath337 and an extended source @xmath338 , as well as @xmath339 for both these cases .",
    "the number of candidates that satisfy initial filtering using @xmath332 , @xmath333 , and @xmath335 are recorded as _",
    "ncandfilt _ in the qa output table ( table  [ tab : iqa ] ) .",
    "figure  [ fig : chishp ] shows an example of the distribution in _ chi _ versus _ sharp _ for raw transient candidates extracted from a collection of iptf difference images acquired during late 2015 to early 2016 , mostly at high galactic latitudes .",
    "the solid rectangle shows the region covered by reliable ( _ likely - real _ ) candidates according to a machine - learned classification ( _ realbogus _ ) score of @xmath340 ( see section  [ ml ] for details ) .",
    "the rectangle boundaries span 1 - 99 percentile ranges along each axis for these likely - real candidates only .",
    "note that the machined - learned classifier uses over 40 metrics ( or features from tables  [ tab : iqa ] and  [ tab : sqa ] ) for scoring , of which @xmath332 and @xmath333 are the most important .",
    "difference images . only candidates with @xmath341 and s / n @xmath342 were used .",
    "the solid rectangle spans the 1 - 99 percentile range along each independent axis for candidates with a _ real - bogus _ machine - learned reliability score of @xmath340 ( see section  [ filt ] for details ) . ]",
    "in addition to the measurements and metrics from psf - fitting ( see above ) , the transient - candidate extraction tables are augmented with more metrics and features to support machine - learned vetting ( section  [ ml ] ) . most of these metrics are listed in table  [ tab : sqa ] .",
    "the shape metrics , for example _ aimage _ , _ bimage _ , _ elong _ , are computed by first executing _ sextractor _ , then associating the extractions ( with metadata ) with those from _ daophot _ above .",
    "furthermore , the source metrics with names that end in _ nr _ in table  [ tab : sqa ] refer to those of the _ nearest _ reference image source .",
    "these are assigned by associating the _ daophot _ extractions with the input reference - image catalog , also originally from _",
    "sextractor_.    prior to implementation of the machine - learned vetting ( section  [ ml ] ) , we resorted to simple one - dimensional cuts on a number of metrics in table  [ tab : sqa ] in order to isolate those candidates as probably _",
    "real _ transients . unlike machine - learning",
    ", this involved no probabilistic classification of candidates into likely _",
    "reals _ and _ bogus _ transients .",
    "it only provided a means to isolate candidates for further follow - up .",
    "the most powerful metrics and filtering logic we have found to label a candidate as `` interesting '' are as follows :    @xmath343    where the metric names on the left are defined in table  [ tab : sqa ] and the corresponding thresholds ( @xmath344 ) are specified by the _ _ input string with defaults defined in table  [ tab : inp ] .",
    "the number of candidates that satisfy the above criteria per difference image are recorded as _ ncandgood _ in the qa output table ( table  [ tab : iqa ] ) .",
    "figure  [ fig : ncand ] shows the number of transient candidates extracted from a collection of iptf difference images acquired during late 2015 to early 2016 , mostly at high galactic latitudes .",
    "these are shown as a function of the ( point - source ) fwhm and density of sources extracted from the science image using _ sextractor _ to a fixed magnitude limit of @xmath345 mag .",
    "three different levels of candidate filtering are shown : first , the number initially extracted using the loose filtering described in section  [ filt ] ( _ ncandfilt _ ) ; second , the number resulting from the simple one - dimensional cuts in section  [ srcqa ] ( equation  [ scuts ] ; _ ncandgood _ ) ; and third , the number satisfying a machine - learned classification ( _ realbogus _ ) score of @xmath346 .",
    "this score corresponds to a false positive rate of @xmath347% ( see section  [ ml ] ) . a noteworthy feature in figure  [ fig : ncand]b is the significant reduction in the number of initial candidates at relatively high source densities following simple 1-d filtering ( yielding _ ncandgood _ ) or machine - learned vetting . in the end ,",
    "the number that are visually - scanned and subject to scrutiny before further follow - up are those that were machine - learned vetted ( diamonds in figure  [ fig : ncand ] ) .",
    "we have constructed animations of difference - images for two ptf ccd footprints made from image data acquired at @xmath348 observation epochs .",
    "these can be accessed from the following urls :    @xmath349=1em = 0em    field containing the m13 globular cluster :    http://web.ipac.caltech.edu/staff/fmasci/home/idemovies/d4335ccd8f2movie.html[`http://web.ipac.caltech.edu/staff/fmasci ` ]    http://web.ipac.caltech.edu/staff/fmasci/home/idemovies/d4335ccd8f2movie.html[`/home/idemovies/d4335ccd8f2movie.html ` ]    field heavily used for supernova searches :    http://web.ipac.caltech.edu/staff/fmasci/home/idemovies/d4450ccd2f2movie.html[`http://web.ipac.caltech.edu/staff/fmasci ` ]    http://web.ipac.caltech.edu/staff/fmasci/home/idemovies/d4450ccd2f2movie.html[`/home/idemovies/d4450ccd2f2movie.html ` ]    each epochal difference image is annotated with the two candidate numbers mentioned above ( and shown in figure  [ fig : ncand ] ) : _ ncandfilt _ ( or @xmath350 in the animation frames ) and the number following machine - learned vetting above a _ realbogus _ ( @xmath351 ) cut : @xmath352 .",
    "one way to assess the photometric accuracy of the difference - image extractions is to examine the repeatability in their photometry under different observing conditions and/or input noise assumptions .",
    "instead , we explore the photometric repeatability empirically at _ prior _ source positions across a stack of difference images generated from spatially - overlapping exposures acquired over a range of observation epochs .",
    "unfortunately we can not perform this test on real flux - transients and variables because they intrinsically vary and will confuse repeatability statistics .",
    "we have resorted to exploring the scatter in photometric measurements from _ forced _ photometry on a list of prior source positions detected in a reference image co - add .",
    "the majority of the sources here will be non - variable and _ non - detected _ in the difference images . even though undetected , their photometric residuals will persist , therefore providing sensitive probes of all random ( and systematic ) errors affecting the end - to - end difference image construction process in a relative sense across epochs .",
    "these residuals would arise from image misalignments , erroneous photometric - gain matching , flat - fielding errors , psf - matching errors , poisson noise from the science and reference images , and other instrumental / detector noise . at some level",
    ", there are also airmass - dependent color - refraction effects and astrometric scintillations .",
    "it s important to note that these residuals will also include systematics from the forced - photometry process itself .",
    "for example , for forced _ psf - fit _",
    "photometry , these would include errors in the psf estimates for each epochal image and their placement on the purported source positions in the difference image ( the prior positions selected from the reference image ) .",
    "therefore , the photometric variance inferred using _ forced _ psf - fit photometry is likely to overestimate the true variance ( or relative photometric accuracy ) of _ detected _ transients in a difference image . as a reminder ,",
    "the primary photometry measured for detected transients in ptfide is psf - fit photometry ( section  [ psffit ] ) where both flux and position are estimated per source . in forced photometry on _ prior _ positions , only fluxes are estimated .",
    "figure  [ fig : photperf]a shows an example of the _ robust _ rms in repeated forced _",
    "psf - fit _ photometry using 26,385 targets selected to @xmath353 mag from the reference image co - add .",
    "a portion of this reference image is shown in figure  [ fig : photperf]d where it contains part of the north america nebula .",
    "this was created from 20 good - seeing ccd images .",
    "note that the complexity of this field is atypical of iptf in general , but it provides a good test of image differencing in complex environments .",
    "each reference - target position probes @xmath354 difference images , generated from ccd images acquired over several months .",
    "the robust stack rms is based on half the @xmath355 percentile difference in all photometric measurements per target position .",
    "this measure is relatively immune to outliers .",
    "this rms is shown as a function of reference image magnitude and can be interpreted in the context of _ real _ transients extracted from difference images as follows . a real transient with psf - fit magnitude @xmath356",
    "is expected to have a 1-@xmath5 uncertainty in the _ frequentist _ sense no larger than the rms shown in figure  [ fig : photperf]a ( i.e. , relative to repeated measurement if the same event with the same intrinsic flux were re - observed ) .",
    "figure  [ fig : photperf]b shows stack - rms estimates for the same prior target positions , but using forced _ aperture _ photometry instead",
    ". a fixed aperture of radius 6 arcsec was used throughout . comparing with",
    "the forced _ psf - fit _ photometry in figure  [ fig : photperf]a , there are two noteworthy differences : first , aperture photometry results in a higher photometric precision at bright fluxes ; and second , aperture photometry has a shallower limiting magnitude ( 5-@xmath5 limits are depicted by the vertical dashed lines ) .",
    "the converse of these applies to psf - fit photometry .",
    "psf - fit photometry lacks precision ( relative to aperture photometry ) at bright fluxes because knowledge of the underlying psf is more critical .",
    "systematic errors in the shape of the psf - template and/or its centroiding will inflate errors in the photometry by a greater amount .",
    "aperture photometry is more immune to these effects .",
    "the encouraging observation is that psf - fit photometry leads to a fainter sensitivity limit ( or more accurate photometry at fainter fluxes ) , in this case by @xmath357 magnitudes .",
    "for comparison , figure  [ fig : photperf]c shows the performance of psf - fit photometry extracted directly from a set of science image ccd exposures falling in a field flanking the north america nebula .",
    "this has a background that is not as complex .",
    "as expected , the precision at bright fluxes is considerably higher that that inferred from _ forced _ psf - fit photometry on difference images ( figure  [ fig : photperf]a ) . this is also higher than that achieved by _ forced _ aperture photometry ( figure  [ fig : photperf]b ) .",
    "furthermore , the limiting magnitude from psf - fitting on single ccd exposures is in general deeper ( by at least 0.8 mag ) than all other types of photometry performed for iptf , for example _ sextractor _",
    "@xmath118 measure ( section  [ refcon ] ; * ? ? ?",
    "* ) .",
    "p4.5cmp11 cm xpos & x - image coordinate [ one - based pixels ] + ypos & y - image coordinate [ one - based pixels ] + ra & j2000 right ascension [ degrees ] + dec & j2000 declination [ degrees ] + magpsf & magnitude from psf fit [ mag ] + sigmagpsf & 1-@xmath5 uncertainty in psf - fit magnitude [ mag ] + flxpsf & flux from psf fit [ dn ] + sigflxpsf & 1-@xmath5 uncertainty in psf - fit flux [ dn ] + magap & magnitude from aperture photometry [ mag ] + sigmagap & 1-@xmath5 uncertainty in magap [ mag ] + flxap & flux from aperture photometry [ dn ] + sigflxap & 1-@xmath5 uncertainty in flxap [ dn ] + snrpsf & ratio : flxpsf / sigflxpsf + sky & local sky background level [ dn ] + nneg & number of negative pixels in a 7 x 7 box + nbad & number of bad pixels in a 7 x 7 box + distnr & distance to nearest reference image extraction [ arcsec ] + magnr & magnitude of nearest reference image extraction [ mag ] + sigmagnr & 1-@xmath5 uncertainty in magnr [ mag ] + arefnr & aimage ( major axis rms ) of nearest reference image extraction [ pixels ] + brefnr & bimage ( minor axis rms ) of nearest reference image extraction [ pixels ] + normfwhmrefnr & ratio : ( fwhm of nearest ref - image extraction ) / ( average fwhm of ref - image ) + elongnr & elongation of nearest reference image extraction ( @xmath310 arefnr / brefnr ) + chi & chi value from psf fit + sharp & sharpness value from psf fit + nneg2 & number of negative pixels in a 5 x 5 box + nbad2 & number of bad pixels in a 5 x 5 box + magdiff & magnitude difference : magap - magpsf [ mag ] + fwhm & fwhm from gaussian profile fit [ pixels ] + aimage & windowed rms along major axis of source profile [ pixels ] + aimagerat & ratio : aimage / fwhm + bimage & windowed rms along minor axis of source profile [ pixels ] + bimagerat & ratio : bimage / fwhm + elong & elongation @xmath310 aimage / bimage + seeratio & ratio : fwhm / ( average fwhm of science image ) + mindistoedge & distance to nearest edge in frame [ pixels ] + magfromlim & magnitude difference : diffmaglim - magpsf [ mag ] +    ksum & pixel sum of psf - matching kernel for image partition containing source + kdb & differential background associated with psf - matching kernel estimate for image partition containing source [ dn ] + kpr & @xmath306 percentile range of pixel values in psf - matching kernel for image partition containing source + rb & real - bogus quality score from machine - learned vetting + strid & primary key from stars table , if match is available + luid & primary key from lu ( local universe ) table , if match is available + cvsid & primary key from cvs ( cataclysmic variable stars ) table , if match is available + qsoid & primary key from qsos ( quasi - stellar objects ) table , if match is available + lcid & primary key from lcs ( light curves ) table , if match is available + rockid & primary key from rocks ( asteroids ) table , if match is available +      ptfide can be executed in a mode where it operates exclusively on square sub - image cutouts .",
    "this is enabled if the _ _",
    "switch is specified .",
    "the science and reference image cutouts have a center ( equatorial ) position and side - length ( pixels ) specified by _ _",
    "( table  [ tab : inp ] ) . in this mode",
    ", ptfide also expects as input a pre - computed ( archived ) psf - matching kernel image fits - cube , for example initially generated with suffix _ _ pmtchkerncube.fits _ from a prior run of ptfide .",
    "the planes of this cube store the convolution kernels corresponding to partitions of the parent image ( section  [ pkern ] ) and is supplied via the _ _ input .",
    "this cube also stores metadata on each kernel , for example , the parent - image partition pixel ranges to which these apply , including all gain - correction factors . the appropriate kernel image for the parent - image partition containing the image cutouts ( science and reference ) is then applied ( as in section  [ appkern ] ) to match their psfs .",
    "image - differencing is then performed on the cutouts .    only a positive ( _ science  reference _ )",
    "difference image stamp with accompanying uncertainty and mask image are generated in this mode .",
    "there is no source detection .",
    "further outputs are generated if the debug switch was set ( see end of table  [ tab : sout ] ) .",
    "the purpose of this mode is to support later _ forced photometry _ on a target position of interest .",
    "this position would be the same used to generate the initial image cutouts .",
    "operating on stamp cutouts using pre - existing kernel images is very fast , particularly when difference - images containing specific source positions over a historical observation range are needed .",
    "this avoids regenerating entire difference images , including all associated psf - matching kernels and corrections .",
    "it also avoids archiving entire difference images in the first place .",
    "this section describes the schema and related workings of the iptf transients database in current operations , along with how it will be improved for ztf in future . figure  [ fig : schema ]",
    "depicts a simplified snapshot of the schema , in which each box represents a separate database table with a given name and some number of columns .",
    "the major table columns are listed .",
    "the columns in bold font are the table s primary keys .",
    "the columns in bold - italicized font are the alternate primary keys .",
    "the columns in regular font are not-_null _ columns , and those in regular - italicized font are _ null _ columns ( in which _ null _ values may also be stored ) . _",
    "_ represents a foreign key and `` 1  1 * .. '' indicates a relationship of one record to many records .",
    "the _ subtractions _ table stores a variety of metadata for both the positive and negative difference images generated for each processed ccd image .",
    "the boolean _ isdiffpos _ discriminates between the two subtraction types .",
    "many of the qa metrics from ptfide defined in table  [ tab : iqa ] are included in this database table . associated with each record",
    "are the observation time ( _ jd _ is the julian date ) and foreign - key database ids of the corresponding field , filter , chip , reference image , and pre - processed science image .",
    "a stored difference - image filename contains the full pathname , and in its record , is accompanied by an md5 checksum , a timestamp for when the record was created , and a _ status _",
    "flag for whether the subtraction satisfied a number of qa criteria : @xmath358 if so , @xmath359 if not ( see section  [ diffqa ] )",
    ". multiple versions of difference images are possible if the pipelines are rerun , and therefore the @xmath360 number and @xmath361 flag for which version is best ( generally the latest ) are also stored .",
    "the primary key for this table is _ subid _ , while the alternate primary keys are _ pid _ , _ isdiffpos _ , and _ version_.    the _ candidates _ and _ features _ tables hold metadata for all transient candidates extracted from difference images with @xmath358 only .",
    "the records in these tables store many of ptfide s source - based metrics and features , which are listed in table  [ tab : sqa ] .",
    "included are _ null _ columns for storing the foreign - key database ids of the closest positional matches to astronomical objects of interest ( as discussed below ) .",
    "these are updated after the corresponding record is loaded , where a _",
    "null _ value indicates either there is no match or no match was attempted . while _ candid _ is a unique candidate index assigned in sequence by the database , _ tblid _ is a relative number assigned to each candidate for a given difference image .",
    "the versioning mechanism in the _ features _",
    "table is not used at this time .",
    "the _ realbogus _ table stores the scores computed by the machine - learned classifier for all transient candidates ( see section  [ ml ] ) . the rb score is a value in the range [ 0 , 1 ] where a higher value indicates the candidate is more likely to be a _ real _ transient .",
    "improved versions of the classifier are forthcoming , and a mechanism for tracking them in this database has been implemented .",
    "the _ knownrocks _ table contains the predicted positions ( ephemerides ) and magnitudes of all known numbered asteroids through the end of year 2019 .",
    "the predictions are spaced 1  day apart .",
    "this table contains @xmath362  asteroids and @xmath363  epochs for each , giving a total of @xmath364  million rows . for each positive subtraction ,",
    "the known rocks within its sky - footprint are found and loaded into the _ rocks _ table .",
    "a 30  cone search ( accounting for uncertainty ) is used to find the nearest rock to each candidate , and the corresponding _ rockid _ is updated in the _ candidates _ record .",
    "the _ stars _ table holds the positions and magnitudes derived from ptf @xmath64-band reference - image catalogs for sources that have been classified to be stars by a star / galaxy classifier @xcite .",
    "candidates are matched to stars in this table to within 1 , and the resulting _ candidates _ record is updated with primary key _",
    "strid _ of the match .",
    "a typical database query would be for transient candidates within an observation - time and rb - score range , with an additional constraint that each be associated with at least another candidate ( potentially from the same source ) at approximately the same sky position , but with observation - times and magnitudes that differ by specified tolerances .",
    "transients that have been spectroscopically confirmed and classified are inserted into the _ transients _ table .",
    "the iptf transients marshal , which is a web - based tool for analyzing lightcurves , is updated continuously with records from this table .",
    "approximately 64 thousand classified transients are currently stored .",
    "the database schema will be streamlined in future for ztf so that it is scalable and more efficient .",
    "sets of complete _ candidates _ records will be fully constructed ahead of time for bulk database - loading",
    ". this will require the unique candidate ids to be formed predictively rather than from a database sequence .",
    "any redundant and unnecessary columns in the _ features _ table will be eliminated .",
    "also , the _ candidates _ and _ features _ tables may be combined into a single table . partitioning the _ candidates _ , _ features _ , and perhaps other tables into child tables that isolate different observation - time ranges will also be considered , as this will allow for faster queries by taking advantage of constraint exclusion in the postgresql database .",
    "the machine - learned vetting of sources is necessitated by the overwhelming number of artifacts produced by image subtraction and subsequently extracted during source finding .",
    "the true ratio of real astronomical sources ( referred to as _",
    "reals _ ) versus artifacts generated by image subtraction ( referred to as _ boguses _ ) is unknown since the majority of sources extracted are unexamined .",
    "we estimate the bogus to real ratio for ptfide is typically greater than 10 to 1 .",
    "this necessitates the use of automated systems to discriminate between _ boguses _ and _ reals _ in order to filter out unreliable candidates and prioritize detections for further study .",
    "we refer to systems that perform this task as `` realbogus '' systems , a term coined by @xcite .",
    "the use of machine learning for the vetting of astronomical transients extends back to ptf @xcite .",
    "machine learning systems are typically statistical classifiers that are able to score candidates on a spectrum from zero ( _ bogus _ ) to one ( _ real _ ) .",
    "classifiers are trained with annotated data exemplars as opposed to expert - specified rules .",
    "three machine learning systems are currently in use for iptf @xcite for vetting outputs from the image differencing pipeline at nersc .",
    "the results therefrom are combined to minimize missed detections .",
    "machine - learned vetting is also being used for other surveys that use image differencing for transient discovery , for example , the dark energy survey @xcite and pan - starrs @xcite .",
    "here we briefly describe the construction and evaluation of the _ realbogus _ system for ptfide and leave the details to a future paper .",
    "the _ realbogus _ system for ptfide , like all its predecessors , is based on a random forest classifier . for an overview of random forests ,",
    "see @xcite , @xcite , and @xcite .",
    "we use an ensemble of 300 trees trained on 10,000 _ real _ and 10,000 _ bogus _ candidates . the proportion of trees reporting a classification of _ real _",
    "is reported as the candidate s score .",
    "each candidate is described via a set of features that forms an input vector into the classifier .",
    "the current set of 89 features are outputs from ptfide and consist of both image - based and source - based features ( tables [ tab : iqa ] and [ tab : sqa ] respectively ) .",
    "this excludes irrelevant and trivial information such as source ids , database counters , positions ( i.e. , ra , dec ) , and the constant photometric zeropoints",
    ".    figure  [ fig : feature_importance ] shows a feature importance diagram that provides an estimate of the relative importance of each feature to the classification process . only the twenty most important features are displayed . despite the high number of features , the top two features for discriminating between _ real _ and _ bogus _ candidates are _ sigmagpsf _ ( the 1-@xmath5 uncertainty in the psf - fit magnitude ) and _ status _ ( a flag for whether the difference image satisfied a number of qa criteria ; see section  [ diffqa ] ) .",
    "it s important to note that the relative feature importance ranking in figure  [ fig : feature_importance ] does not account for any correlation between features .",
    "for example , the _ chi _ and _ sharp _ features are expected to be highly correlated .",
    "removal of one of these features will still result in a good classifier , while removing both will not .",
    "i.e. , the presence of either one but not necessarily both is important for overall classifier performance .",
    "the training data must be well sampled with respect to the true distributions of _ real _ and _ bogus _ candidates on any given night .",
    "the _ realbogus _",
    "system for ptfide benefited from predecessor systems at nersc in that we could reprocess images containing real candidates discovered at nersc and recover them with ptfide .",
    "we queried the nersc database for all objects that were spectroscopically - confirmed to be a supernova , variable star , gap transient , cataclysmic variable or nova .",
    "this resulted in 372 candidates .",
    "we augmented this set with data belonging to the lightcurves of these candidates at all observation epochs .",
    "this resulted in 15,168 real candidates in total .",
    "all images containing this candidate set were reprocessed with ptfide . of these 15,168 candidates ,",
    "2,153 were lost due to ptfide failures , of which 11 were spectroscopically - confirmed .",
    "of the remaining recoverable 13,015 candidates , we recovered matching transients for 11,075 ( @xmath2085.1% ) with ptfide .",
    "361 of these were spectroscopically - confirmed of which we recovered 310 ( @xmath2085.8% ) .",
    "we reserved 10,000 of the 11,075 for training and reserved the remaining 1,075 as an independent test set for final validation .",
    "_ bogus _ candidates are pipeline artifacts that must be sampled directly from the ptfide database .",
    "we randomly sampled 20,000 candidates exclusive of known reals and declare them as _",
    "bogus_. we reserve 10,000 for training and another 10,000 as an independent test set .",
    "figure  [ fig : bogus ] shows an example of the various kinds of _ bogus _ transients extracted .",
    "some are induced from bad or inaccurate upstream instrumental calibrations , while others are due to inadvertently unmasked detector glitches or artifacts from the optical system .",
    "it is impossible to ensure the purity of our samples without examining each candidate individually .",
    "bogus _ set may include missed detections while our labeled sets of real candidates may contain artifacts .",
    "future work includes plans to assess training set contamination via a machine learning technique called active learning ( e.g. , * ? ? ?",
    "* ) .     for details .",
    "]      we have two methods of evaluation .",
    "the first is to use ten - fold cross - validation in order to form a receiver operating characteristic ( roc ) curve that measures the false positive rate ( fpr ) and false negative rate ( fnr ) at a continuum of decision thresholds from 0 to 1 . in ten - fold cross - validation ,",
    "all 20,000 labeled examples ( exclusive of the independent test sets ) are randomly split into 10 groups , where one fold is held out as the test fold and the classifier is trained on the remaining nine .",
    "the test fold is rotated and the predicted outcomes from the ten classifiers are averaged across the folds . methodologically , cross - validation usually assumes examples are independent and identically - distributed .",
    "that is not the case here , since light curve observations from the same source ( especially variable stars ) may span both the training and test folds .",
    "we use cross - validation as a guide when comparing competing versions of the classifier , rather than for assessing the system s overall performance .",
    "in fact , cross - validation is prone to overfitting if the labeled population does not well represent the general population of candidates .",
    "figure  [ fig : roc ] shows the roc curve for the classifier using cross - validation , where the _ y_-axis shows the true positive rate ( tpr @xmath365 fnr ) .",
    "the fnr at 1% fpr , the maximum fpr tolerated by the science teams , was 3.51% from cross - validation .",
    "the second evaluation of the system looks at score distributions on the two independent test sets of _ real _ and _ bogus _ examples .",
    "this gauges performance and determines the system s decision threshold .",
    "candidates that score above the decision threshold are presented to the science teams for inspection , while those below will likely remain unexamined .",
    "we classify the candidates in the test set of randomly selected candidates and note the threshold that admits only 1% of the set as false positives .",
    "similarly , using the independent test set of known reals , we classify this set and note the threshold that admits only 5% as false negatives ( or missed detections ) .",
    "the thresholds resulting in a 1% fpr and 5% fnr were 0.735 and 0.724 respectively .",
    "as a result , the decision threshold for the _ realbogus _ classifier was set to 0.73 .",
    "figure  [ fig : ncandhist ] shows the distribution of _ realbogus _ scores obtained from ptfide run on iptf data . as seen in figure  [ fig : ncandhist]a",
    ", the decision threshold of 0.73 corresponds to a plateau followed by a knee in the distribution above which the fpr falls below 1% .",
    "areas of future work include plans for identifying and eliminating training set contamination .",
    "we have built an active learning prototype that identifies candidates that are likely mislabeled , and present those to the science teams for cleaning .",
    "we have also developed a new way to randomly sample against the ptfide candidates database to ensure our _ bogus _ sample is not overly biased towards certain types of artifacts and is representative of the full distribution of observing conditions .",
    "finally , we have used machine learning to analyze the frequency of certain types of _ bogus _ artifacts produced by ptfide in order to understand the software and faciliate improvements .",
    "details on these methods will be published in a forthcoming paper .",
    "the iptf realtime processing system has evolved considerably over the last few years through feedback received from the various science programs .",
    "the system was developed by a small team with limited resources .",
    "communication between the development team and users of the products was paramount .",
    "the success of a large astronomical survey requires ( i ) a clear definition of the science goals and deliverables needed to achieve these ; ( ii ) a tractable system engineering plan to enable ( i ) , given the available resources .",
    "below we list some of the challenges and pitfalls encountered over the course of development and how these were addressed .",
    "we also present thoughts on how specific aspects could have been improved if resources allowed .    1 .",
    "tuning and optimization of all processing components is an iterative process that requires real on - sky data acquired with your survey instrument .",
    "do not rely on the commissioning period to optimize everything to perfection . resources ( and schedule ) are limited .",
    "more eyes on the data , the better , and this can only occur by harnessing the expertise of the scientific community .",
    "immediate visibility to data products is therefore crucial in the early phases of the survey .",
    "implement offline versions of your primary production pipelines to allow for experimentation and ongoing tuning .",
    "this ensures minimal disruption to the production system that is serving users .",
    "communicate all planned updates in advance and only deploy when the stakeholders have confirmed and understood the updates .",
    "3 .   allow versioning control of all pipeline software parameters and instrumental calibrations _ together _ with the software versions they were optimized for .",
    "this will allow for easier traceability and reproducibility of specific science products in future .",
    "4 .   have a well defined quality - assurance plan for the entire observing and data - processing system .",
    "this entails implementing qa metrics for each subsystem and a means to communicate these across all subsystems .",
    "for example , implementing automated checks at the raw - data level ( close to realtime ) alerts the team of bad data and that no products are expected downstream .",
    "a modular and _ visible _ end - to - end qa / alerting system allows for easier accountability of missing products , traceability of errors , and recovery .",
    "5 .   related to the previous point , routine monitoring should include overall performance of the network , data - transfer rates , and all aspects of the compute cluster . 6 .",
    "assign ownership and responsibility of key components of the system to individuals of the team .",
    "for example , this may consist of collecting performance metrics , analysis reports , and/or providing feedback for improving aspects of the data - processing system .",
    "having all communication channels defined at the outset will allow priorities to be better managed .",
    "time - domain surveys are dynamic , literally . for example , science goals or their priorities may change over time in response to scientific outcomes or analyses early in the survey .",
    "goals may also change in response to unforeseen problems in instrumentation , hardware , and/or algorithmic or processing details .",
    "be prepared to adapt .",
    "_ modularity _ in all pipeline software and hardware components to accomodate change and growth is therefore crucial .",
    "8 .   in the context of realtime discovery using image - differencing ,",
    "the accuracy of upstream calibrations is crucial .",
    "this primarily refers to astrometric and photometric calibration .",
    "flat - fielding in particular is important for the latter .",
    "proper trending and qa of all calibration products prior to use is therefore necessary to avoid a flood of false - positives downstream . early notification of bad calibrations and a means to either recreate them on - the - fly or fallback to archived versions should be planned .",
    "have a plan to assess the overall performance of image - differencing and transient - discovery over the course of the survey .",
    "this may involve for example tracking the relative efficiency and reliability of candidates extracted from pre - defined survey fields known to contain a good statistical sample of variable stars .",
    "alternatively , one could inject synthetic episodic transients for offline analysis .",
    "the important thing is that the appropriate metrics and methodologies to enable this monitoring be identified and implemented prior to commencement of the survey .",
    "image - differencing is a game of ( i ) minimizing false - positives at the expense of also maintaining a low false - negative rate , and ( ii ) maximizing the photometric accuracy .",
    "these sensitively depend on the initial extraction s / n .",
    "the power of using machine learning to probabilistically classify candidates into either _",
    "real _ or _ bogus _ can not be overstated .",
    "false - positives are inevitable .",
    "we advise setting a maximum tolerable threshold for their occurence to enable tuning of the relevant extraction and scoring thresholds .",
    "these will evolve as algorithms and software improve .",
    "the efficacy of a machine - learned vetting infrastructure crucially depends on the data it was trained on ( in the context of _ supervised _ learning ) .",
    "this should be kept in check over the course of a survey according to the different science applications and possible changes in survey design .",
    "for example , if a decision is made to survey more of the galactic plane , the machined - learned classifier should be retrained accordingly using data from the same region .",
    "this minimize biases when predicting the reliability of transient candidates .",
    "a _ supervised _ machine - learned classifier will have been trained on products from a specific version of pipeline software .",
    "any algorithmic or parameter changes in the pipeline usually requires a retraining of the classifier .",
    "this dependency will incur a delay in the software delivery cycle and must be accommodated .",
    "we have not yet streamlined this delivery and integration process since classifier ( re)training can be time - consuming .",
    "we advise that any classifier - retraining be performed on a stable version of the pipeline software .",
    "both can then be updated as shortcomings are identified during the survey .",
    "plan on reprocessing any or all of your data , for example , to recover from failures in processing and/or hardware outages .",
    "this also enables one to regenerate products for a future archive using a consistent set of pipeline parameters and software .",
    "these may have evolved over the course of the survey .",
    "a number of shortcomings were identified over the course of development of the iptf discovery engine .",
    "some of these are at the algorithmic level and some relate to data management practices . in 2017 , iptf will be replaced by the zwicky transient facility ( ztf ; see section  [ intro ] ) .",
    "the higher data rates and volumes will require a redesign of some of the subsystems to minimize processing latencies and the delivery of transient candidates for scanning .",
    "the planned upgrades are as follows :    1 .",
    "improve the efficiency of loading and retrieval of candidates into / from the transients database described in section  [ schema ] .",
    "the plan is to periodically construct lists of pre - machine - vetted candidates ahead of time at intervals throughout a night and batch - load them .",
    "source features and metrics will be consolidated into single ( flatter ) database tables .",
    "we will also consider retaining only candidates and associated metadata for the last 30 nights or more to enable more efficient near real - time discovery and lightcurve generation .",
    "older transient candidates will roll - off to a growing archival database .",
    "the reason for this is to keep the number of candidate records for active - querying ( close to their discovery epoch ) relatively small .",
    "transient candidates and image - cutouts for human scanning will need to be delivered for external viewing using pre - defined ( or cached ) database queries submitted by an automated process at regular intervals throughout a night .",
    "currently for iptf , there is no limit on how many queries can be submitted .",
    "having many scanners submit similar queries in an uncoordinated manner has led to severe bottlenecks .",
    "astrometric calibration needs to be made more robust against changes in source density , seeing , depth , atmospheric refraction , and telescope tracking .",
    "this includes the ability to properly model and capture time - dependent distortion effects from the optical system and atmosphere .",
    "4 .   absolute photometric calibration will need to be performed on a _ per - image _ basis in the _ realtime _ pipeline .",
    "the use of psf - fit photometry in particular is paramount .",
    "psf - fitting will automatically account for seeing variations and regions with high source - confusion through its de - blending ability .",
    "this will ensure that photometric zeropoints can be accurately determined for a larger fraction of the images . as discussed in section  [ gm ] ,",
    "the zeropoints are refined using big - aperture photometry to enable more accurate gain - matching prior to image - differencing .",
    "this method is fragile and has not been reliable .",
    "extend ptfide to include some of the optimal methodologies for co - addition , image - differencing , source detection , and photometry presented in the detailed study by @xcite .",
    "consider using pre - classified star catalogs constructed initially from reference image catalogs ( e.g. , via machine - learning ) to properly seed inputs for deriving psf - matching kernels .",
    "consider dynamic updates to reference image products as the survey proceeds in order to use the best - quality epochal data acquired to date .",
    "in other words , the reference - image library can be progressively refined to ensure optimal image - differencing .",
    "we have described a transient - discovery engine ( ide ) , currently in use to support near real - time discovery for iptf at ipac / caltech .",
    "a refined version will be used for ztf in future .",
    "guided by previous implementations of the image - subtraction problem , this paper reviews our algorithms , optimization strategies and machine - learned vetting scheme .",
    "once tuned , the pipeline requires little intervention and is resilient to bad input data and/or inaccurate instrumental calibrations .",
    "our development approach was to make all processing steps as modular as possible to allow for easier debugging and tractability .",
    "our goal has been reliable transient discovery and robustness .",
    "the methods were refined using the knowledge gained from 6@xmath13 years of archived science - quality ptf data .",
    "the elements we find that are most crucial to image - differencing performance , and hence the efficiency and reliability of transient discoveries are : ( i ) astrometric calibration ; ( ii ) flat - fielding ; and ( iii ) related to this , photometric calibration ( either relative or absolute ) . having these calibrations optimized ( in the maximal s / n sense )",
    "paves the way to more accurate psf - matching and image - differencing .",
    "this also relieves the amount of work needed downstream to weed out false positives , by both human and machine . despite differences in the details of instrumentation , image quality and/or survey design , ide provides a testbed for future large time - domain surveys .",
    "this work was funded in part by the iptf and ztf projects at the california institute of technology .",
    "iptf is a partnership led by the california institute of technology and includes the infrared processing & astronomical center ; los alamos national laboratory ; university of wisconsin at milwaukee ; oskar - klein center of the university of stockholm , sweden ; weizmann institute of sciences , israel ; university system of taiwan , taiwan ; the institute for physics & mathematics of the universe , japan ; lawrence berkeley national laboratory and the university of california , berkeley .",
    "ztf is funded by the national science foundation under grant no .",
    "mmk acknowledges support from the national science foundation pire growth award .",
    "aam acknowledges support for this work by nasa from a hubble fellowship grant : hst - hf-51325.01 , awarded by stsci , operated by aura , inc .",
    ", for nasa , under contract nas 5 - 26555 .",
    "part of the research was carried out at the jet propulsion laboratory , california institute of technology , under a contract with nasa .",
    "the pipelines use a number of software packages from other institutions and past projects ( see table  [ tab : sw ] ) , for which we are indebted .",
    "portions of the analysis presented here made use of the perl data language ( pdl ) developed by k. glazebrook , j. brinchmann , j. cerney , c. deforest , d. hunt , t. jenness , t. lukka , r. schwebel , and c. soeller and can be obtained from"
  ],
  "abstract_text": [
    "<S> we describe the near real - time transient - source discovery engine for the _ intermediate _ palomar transient factory ( iptf ) , currently in operations at the infrared processing and analysis center ( ipac ) , caltech . </S>",
    "<S> we coin this system the ipac / iptf discovery engine ( or ide ) . </S>",
    "<S> we review the algorithms used for psf - matching , image subtraction , detection , photometry , and machine - learned ( ml ) vetting of extracted transient candidates . </S>",
    "<S> we also review the performance of our ml classifier . for a limiting signal - to - noise ratio of 4 in relatively unconfused regions , _ </S>",
    "<S> bogus _ candidates from processing artifacts and imperfect image subtractions outnumber _ real _ transients by @xmath0 </S>",
    "<S> . this can be considerably higher for image data with inaccurate astrometric and/or psf - matching solutions . despite this occasionally high contamination rate , </S>",
    "<S> the ml classifier is able to identify real transients with an efficiency ( or completeness ) of @xmath1% for a maximum tolerable false - positive rate of 1% when classifying raw candidates . </S>",
    "<S> all subtraction - image metrics , source features , ml probability - based _ real - bogus _ scores , contextual metadata from other surveys , and possible associations with known solar system objects are stored in a relational database for retrieval by the various science working groups . </S>",
    "<S> we review our efforts in mitigating false - positives and our experience in optimizing the overall system in response to the multitude of science projects underway with iptf .    </S>",
    "<S> = 1 </S>"
  ]
}