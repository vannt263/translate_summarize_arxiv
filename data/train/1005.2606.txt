{
  "article_text": [
    "astronomers have to keep accurate records of where their observations are located on the sky . beyond the direction and angular size of the field of view",
    ", we have detailed information available about the precise sky coverage derived from the exact shape of our detectors .",
    "this coverage is invaluable for most statistical studies , e.g. , luminosity functions or especially analyses of spatial clustering .",
    "the de facto standard of the flexible image transport system ( fits ; * ? ? ?",
    "* ) has reserved keywords for the world coordinate system ( wcs ; * ? ? ? * ) specification , and parameters that specify the transformation from image pixels to sky coordinates ( and reverse ) , are present in the header of most fits files . while the wcs is perfectly adequate for individual exposures , multiple observations are difficult to describe in a single system .",
    "every field has potentially a separate coordinate system , hence moving from field to field is convoluted , and makes it cumbersome to answer even simple questions , e.g. , whether two separate fields overlap",
    ".    the footprint of a large - area survey might be complicated but the small - scale irregularities are even more problematic .",
    "not only the depth of a survey changes as a function of the position on the sky , but parts of the observations are often censored for various reasons , such as bright stars blocking the view , satellite trails , artifacts from reflections .",
    "if we would like to represent all these on the sky , we need a scalable solution that works for shapes of arbitrary complexity and size from the subpixel level to the entire sky . we need tools to create and manipulate these descriptions right there where the data are and utilize the information efficiently .",
    "geographic information systems ( gis ) were designed with a similar goal in mind .",
    "there are however subtle differences , that are large enough that gis systems are not quite applicable to astronomy directly .",
    "the modern mapping systems do not extend much beyond the basic features of projected maps but provide very efficient tools for finding nearby places and shortest routes , etc .",
    "even the most complicated gis shapes are limited to spherical polygons whose sides are great circles ( or straight lines in the projection . ) in astronomy , the approximations with such polygons would be unacceptably inaccurate or prohibitively redundant , hence there is need for an extended set of features to represent the geometries of the observations and surveys .    some of the concepts discussed in the paper are not new and have been introduced and studied previously in different fields .",
    "books by @xcite detail the quad - trees for spatial searches that @xcite advocated using for astronomy data .",
    "@xcite developed an icosahedron - based methodology for earth sciences , and @xcite introduced the convex description and the hierarchical triangular mesh , a triangulation that was also used by @xcite with a different numbering scheme . a similar representation of shapes is also found in @xcite and @xcite . @xcite and @xcite introduced the discrete global grid for gis systems , an equal area variant of the same triangulation idea .",
    "the integration to relational databases is discussed in @xcite .",
    "the goal this paper is to provide the astronomy community with a complete and consistent view of the current and much improved methodology built on a new fully functional spherical geometry framework , and describe the implementations and interfaces used in several astronomy archives and tools today including the sloan digital sky survey @xcite , the hubble legacy archive @xcite , the galaxy evolution explorer and the nvo footprint service @xcite . in section  [ sec : shapes ] we describe how to specify spherical shapes and manipulate them .",
    "section  [ sec : geom ] deals with the spherical geometry of the region representations and section  [ sec : htm ] discusses an efficient search method based on the hierarchical triangular mesh . in section",
    "[ sec : lib ] we provide details of our software solution including the implementation of the database routines and their usage .",
    "section  [ sec : sum ] summarizes the main results , along with current and future applications in astronomy .",
    "in cartography , maps are typically local projections , e.g. , the pages of an atlas that just overlap so that they provide enough reference for navigating a road or a trail , and in general , moving from one projection to another can be quite difficult . in astronomy , the usage pattern is different and usually more global that warrants the use of a true spherical geometry .",
    "spherical polygons are closed geometric figures over the sphere , formed by arcs of great circles .",
    "generalized spherical polygons ( gsps ) are similar , but their arcs can also be small circles . these are conceptually simple and yet versatile enough to represent most common shapes in astronomy .",
    "they easily describe circles , rectangles ( even with curved sides ) , and where they can not precisely track a boundary , an accurate approximation is possible by a short series of arc segments .",
    "not only do they conveniently describe spherical shapes but they also provide a very compact representation . for example , the vertices and the equations of the edges ( arcs ) define the _ outline _ of a generalized spherical polygon , and its inside can be determined by the order of the vertices .",
    "one convention is to define the inside to be to the left as one traverses around the polygon .",
    "either a small or a great circle can be defined as the intersection of the unit sphere with a 3-d plane .",
    "this enables us to use another , dual representation , by using half - space contraints that define the interior _ surface _ area of these spherical circles , instead of their outline .",
    "if we embed the surface of the unit sphere in a 3-dimensional eucledian space , we can use 3d directed planar ( halfspace ) constraints and their boolean combinations to select parts of the sphere that represent various spherical shapes of this family describable by gsps .",
    "regions that can not be represented this way would be the curves defined by intersections of higher order surfaces with the sphere , like quadrics .",
    "these two alternative descriptions are formally equivalent but have different properties that make them preferable for certain types of problems .",
    "both have advantages and disadvantages but we do not have to choose one . in this section ,",
    "we first elaborate on the surface or convex representation in detail with special emphasis on its strengths , and point out how to obtain the outline algorithmically .",
    "going from a two - dimensional representation of spherical shapes to a three - dimensional description provides a uniform framework with readily available geometrical concepts to build on .",
    "a _ halfspace _ is a directed plane that splits the 3-d space in two . in our context",
    ", it represents a spherical cap when intersected with the unit sphere .",
    "it is defined by a direction , i.e. , a unit vector @xmath0 , and a signed scalar offset @xmath1 , measured along the normal vector from the origin . using a unit - sphere centered on the origin of a cartesian coordinate system",
    ", the parameter @xmath1 can take values between 1 ( an infinitely small cap ) and -1 ( the whole sky ) .",
    "the value of 0 corresponds to a special case and represents half the sky cut along a great circle . in general",
    ", @xmath1 is the cosine of the angular radius of the cap .",
    "the caps with a negative @xmath1 are called _",
    "another common shape in astronomy is a rectangle in the tangent plane defined by the geometry of the detector . since a straight line in any tangent plane projects onto a great circle on the surface of the sphere ,",
    "the rectangle is a convex formed by the intersection of four zero - offset halfspaces , whose normal vectors point in the direction of the neighboring vertices cross products .",
    "an intersection of halfspace constraints represents a ( possibly open ) 3-d _ convex _ polyhedron , which in turn describes a more complicated shape when it intersects the unit sphere . despite their simplicity in 3-d",
    ", convexes can define a large variety of spherical shapes , e.g. , rings , diamonds or other polygons of `` straight '' or curved sides .",
    "in fact , they can even represent multiply connected shapes of arbitrarily large topological complexity .",
    "for example , the vertices and edges of a large enough cube centered on the sphere can define eight disjoint generalized spherical triangles as they poke through the surface .",
    "nevertheless , convexes are constrained in 3-d and , hence are limited in what types of spherical shapes can describe .",
    "more general spherical _ regions _ can be defined as the unions of convexes .",
    "this hierarchy of halfspaces , convexes and regions and their negation ( or difference ) provides a complete algebra over these spherical regions , enabling extreme flexibility and efficiency .",
    "one of the most common tasks is the containment test to decide whether a point is inside a region .",
    "we start with the most basic elements of the region , the halfspaces .",
    "a point ( unit vector @xmath2 ) is inside a halfspace ( @xmath3 ) , if the dot product of the two vectors is greater than the offset , @xmath4 while this is straightforward to see , its computational simplicity is striking , and has serious consequences for the performance of any implementation using this formalism .",
    "for example , the computation requires only three multiplications and one comparison for a circle and four times that for a spherical quadrangle , regardless of the size and actual shape .    testing a point against a convex simply consists of checking whether the point is inside all its halfspaces .",
    "if yes , the point is inside ; otherwise outside . as",
    "a region is the union of its convexes , it contains a point if any of its convexes contains the point .      within this framework , the boolean algebra of regions maps very well onto basic set operations on the collections of halfspaces and convexes .",
    "the set of regions is closed for the operations one routinely performs when deriving survey specific geometries .",
    "the same is not true for the convexes .",
    "the _ union _ of two or more regions is a region that includes all the convexes , @xmath5 by definition .",
    "also the _ intersection _ of two or more convexes is a convex that includes all their halfspaces , @xmath6 and , in turn , the intersection of regions is a region whose convexes are the pairwise intersections of the convexes , e.g. , for two @xmath7 it is straightforward to define the _ differences _ of halfspaces , convexes , and regions , even if not as simple as the above operations .",
    "let us first look at two halfspaces .",
    "we see that their difference is @xmath8 where @xmath9 is the _ negate _ or inverse of @xmath10 , which is obtained by simply flipping the sign of its normal vector and the offset .",
    "similarly , subtracting a halfspace from a convex is also simple as is the subtraction from a region .",
    "it might look logical to express the difference of two convexes as a region whose convexes are @xmath11 but the constructed convexes would overlap , hence the following procedure is preferred to avoid the overlaps @xmath12 also we difference a region and a convex by subtracting the convex from all the convexes of the region . by substituting the all - sky coverage into @xmath13 of the previous equation , we get the region of a negated convex @xmath14 the negate of a region is in turn the intersection of its inverted convexes , by a simple application of demorgan s rules . from these formulas",
    "we can also see that it is not enough to stop at the level of the convexes , because even if the basic building blocks of a particular geometry are simple , subsequent operations quickly yield more complicated descriptions that can only be represented as a region .",
    "with this elegant formalism in hand , the practical challenge is to derive irreducible representations of the results of these operations , discarding empty regions and redundant constraints . in general , this can be a compute - intensive task but , most of the time it is very fast and done as a pre - processing step that is well - worth the effort . the description not only becomes more compact but the simpler form speeds up subsequent analyses .",
    "this region _",
    "simplification _ is the topic of this section , where one has to move beyond the basic 3-d concepts of the previous paragraphs and solve the spherical geometry of the region .",
    "a region is the union of convexes , so one has to start by simplifying all of its convexes individually . for many of the subsequent tasks",
    "the frequency of intersections will depend on the radii of the caps , thus it is a good practice to sort the collection by increasing size . after making sure that the smallest cap is indeed finite (",
    "if infinitely small , the convex is empty , and is eliminated ) , we examine the pairwise relations of the halfspaces .",
    "based on the topology of the halfspaces , we can discard the ones that are the same as another , and those that fully contain other halfspaces . if we find halfspaces that are each other s inverse or simply disjoint , the convex is empty .    having done the trivial pruning of halfspaces",
    ", there might still be redundant constraints but one can only reject them by explicitely solving for the vertices and arcs of the convex .",
    "the circumference of a halfspace , a circle , would generally intersect other circles .",
    "we compute the roots ( 0 , 1 or 2 ) for all possible pairs of circles , keeping track degenerate roots where multiple ( @xmath15 ) halfspaces intersect .",
    "we now collect the roots on each circle and form arcs around the circle between the roots .",
    "some of the arcs are invisible , i.e. , outside the convex , these we can ignore , and can also prune degenerate ones , if any . at this point , one can start to form a chain ( linked list ) of the arcs by taking one randomly and looking to match its end point with the start point of a next arc",
    ". then we repeat adding arcs until the starting point of the first arc is reached .",
    "this singly connected part enclosed by the arcs is called a _",
    "patch_.    in general , a convex could have more than one patches , in which case there could be leftover arcs . with these we can repeat the previous procedure to form the remaining of the patches . in some sense ,",
    "the patches are the most basic and compact elements of the convexes .",
    "we derive a minimal enclosing circle for every patch and store them with the convex .",
    "the bounding circles facilitate quick rejections in containment tests for convexes of many halfspaces , and enable faster collision or overlap detections between shapes . in the process",
    "we keep track of the halfspaces whose arcs are present in any of the patches , these are the halfspaces that we have to keep in the simplified representation . on top of these , we have to add those halfspaces that are needed to reject the roots outside the convex .",
    "this may happen in situations such as the diamond shape that is defined as the intersection of four holes .",
    "since the surface of the sphere is a closed manifold , these four negative halfspaces could define two patches so another halfspace is needed to select the patch we want , see figure  [ fig : diamond ] . by the end of the algorithm ,",
    "the convex is left with the minimum number of halfspaces that still describes the same shape .",
    "naturally , the simplification of a region starts by processing its convexes one by one . if we know that the convexes are disjoint or not interested in the analytic area calculation , we are done .",
    "the following steps can not only provide a region description with disjoint convexes and precise areas but enable a potential performance boost from a simpler representation .",
    "building on the bounding circles , first an approximate _ collision graph _ is calculated , where the links note which convex ( a node in the graph ) might overlap with others .",
    "it is possible that some convexes simply contain others , in which case the smaller ones are redundant , and thus quickly eliminated , simplifying the collision graph .",
    "partial overlaps are more difficult to deal with , and here the region algebra proves ( see section  [ sec : alg ] ) to be invaluable . to guarantee disjoint convexes , one has to look for potential collisions between two convexes and derive new ones that do not intersect . in practice , this is simply the convex subtraction , where one keeps the larger convex and substitutes the smaller one with the difference of the two .",
    "the collision graph is updated to include the new convexes that are now disjoint from the larger one . since the new convexes present a smaller area than their progenitor , they can only collide with those that were linked to the eliminated one .",
    "we repeat this procedure until the graph has no links left .",
    "we proceed by working with the larger convexes to guarantee that those are not broken up into many small pieces .",
    "it is common for regions to have more convexes than the original description after this step , but they will be now disjoint . during this simplification process",
    "the number of collisions often grows as for every eliminated convex we introduce one or more , whose collision links are inherited and get queued for analysis .    it is worth noting that one can also eliminate convexes by _ stitching _ them .",
    "for example , two adjacent rectangles next to one another that share an arc and have neighboring halfspaces that are identical , can be substituted by a single convex .",
    "stitching is not only a cosmetic improvement but in certain situations can make a huge impact on the performance .",
    "one example is when working with pixels that can be merged .",
    "heuristic simplifications can make use of this feature , as we will see in section  [ sec : igloo ] .",
    "the dual halfspace - convex - region representation has many advantages as discussed before , but in certain situations a third representation , the _ outline _ , provides further new opportunities .",
    "one obvious application is visualization , when we would like to render regions projected on the sky . in section  [ sec : htm ]",
    "we will also look at how the outline can be used in advanced algorithms to accelerate searches for points in a region .",
    "we started by stating that the surface and shape descriptions are theoretically equivalent but in practice going from one to the other is not always straight forward .",
    "next we discuss the outline and its derivation .",
    "going the other way , from outline to surface representation is less convenient and not really necessary , when working primarily with halfspaces and convexes .",
    "the patches of a region are essentially the outlines of the convexes , but not necessarily the outline of the region .",
    "for example , the outline of a region with a single convex that has only one patch consists of the patch s arcs .",
    "this is also true if the convex has multiple patches as patches of the same convex can never touch each other at more than a point .",
    "as soon as multiple convexes are present , adjacent ones will share arcs , at least partially .",
    "we can define a _",
    "segment _ as part of a directed arc that has a start and an end point , and there are no additional vertex point along the arc between these two .",
    "the algorithm to create an outline would just have to remove those segments from all patches that `` annihilate '' each other , i.e. there are two directed segments which are identical in geometry but opposite in direction .",
    "the first step is to break up each arc into unique segments , which is performed by grouping the arcs by common circles , then ordering the circle , and breaking all arcs up into distinct segments . a possible approach to identify the `` canceling '' segments is to look along the common circles in the collection of all patches and for every circle identify the places where two segments are opposite to one another , and hence cancel out . in this case both are removed . to preserve the relation to the original patches , which have precomputed bounding circles",
    ", we keep the structure of the outline similar to that of the region , but the arcs of the patches are replaced by smaller segments .",
    "such representation is most advantagous but lacks the connectivity of the arcs , which requires the visualizer to draw the arcs independently lifting the pen .",
    "a continous outline is chained into a loop of the correct order by checking the start- and endpoints .",
    "when none of the above simplification methods work well , we can use hybrid techniques where we combine the advantages of pixelization with the exact geometry .",
    "let us imagine an large area survey that takes tens of thousands of pointed observations with a circular field - of - view , so that the circles fully overlap .",
    "while the edges of the survey are rippled and need many circles to represent it accurately , the inside of the region is contigous and simple .",
    "the aforementioned simplification rules including the stitching will not be able to achieve much improvement , although there should be a simpler form .",
    "the previous algorithms would eventually also choke on a region with @xmath1650,000 convexes where every one of the convexes overlaps with 12 other .",
    "this is similar to a good approximation for the sky coverage of the faint images of the radio sky at twenty - centimeters ( first ; * ? ? ?",
    "* ) survey .",
    "if one could break up the region into small pieces that , unlike small circles , can be stitched together neatly , then one could potentially define a small number of large convexes in the middle of the region , and eliminate the union of tens of thousands of caps .",
    "the algorithm is an elegant divide - and - conquer recursion .",
    "we need a pixelization that is a hierarchical subdivision of the surface of the sphere , where the pixels are not only nicely adjacent but also share many halfspace constraints that allow for extensive merging .",
    "such pixelization is achieved by the igloo scheme @xcite .",
    "we start with a region and build a tree , e.g , using the ( 3:0:3 ) pixelization , where only those nodes are kept that collide with the region .",
    "every igloo pixel is a simple convex , aswe have defined this term , namely a generalized spherical triangle or a rectangle , hence the usual region operations can be directly applied .",
    "the depth - first recursion is very efficient when one records for every node of the tree the convexes of the region that it overlaps with , so that on the deeper levels of the tree with more and more nodes , less and less convexes are to be tested per each node .",
    "we typically specify the stopping criteria for building the tree by pixel size ( maximum number of levels ) or by the maximum number of leaf nodes .",
    "once the tree is ready , the geometry of every leaf is examined .",
    "we subtract the colliding convexes of the region from each leaf one by one and calculate its area ( see section  [ sec : area ] ) .",
    "if the pixel is completely covered , we take the convex of the pixel , otherwise derive its exact shape .",
    "the merging of the pixels into larger and larger convexes is done along the tree using the full pixels only , and once the fragmentation of the region stops the pixels to grow , one can stitch the neighboring pixels , if they are on the same level .",
    "this procedure yields the exact region with alternative internal convexes . taking it one step further",
    ", we can also create an even simpler region by keeping the full pixels for nodes where the overlap area is large even if not completely full .",
    "for these nodes , we define another region called the _ mask _ that defines the overshoot area of the approximation .",
    "typical footprints already have such masks to censor areas covered by bright stars , satellite trails , etc . , and adding some more does not make the subsequent analyses more difficult , instead",
    ", it can significantly simplify the description of the region .",
    "a patch is just a generalized spherical polygon bounded by small ( and/or great ) circles , whose arcs are ordered by design .",
    "the trick is the break a patch up into more regular pieces whose areas we can calculate .",
    "let us pick a point arbitrarily on the sphere , e.g. , at the center of mass of the vertices of a patch , and break up the polygon into spherical triangles such that one of the vertices of every triangle is this selected point and it contains an arc of the patch .",
    "now every triangle has two great circle arcs and one of the original arcs .",
    "we follow the approach of @xcite , by subdividing this shape into a triangle of great circle arcs and the leftover shape , known as the _ semilune_.",
    "the area of the former is given by the girard formula that has several variants .",
    "here we list the one that is the most robust against degeneracy and hence should be preferred for numerical calculations over equations that appear to be simpler algebraically : @xmath17 with @xmath18 where @xmath19 is half the circumference of the triangle with the sides @xmath20 in radians .",
    "the area of a semilune is also calculated analytically but it is more convoluted . for completeness , here we print the formulas without further explanation@xcite .",
    "@xmath21 where @xmath22 is the half angle of the small circle , i.e. , the radius of the cap , and @xmath23 with @xmath24 being half the eucledian distance between the end points of the arc .",
    "the situation is slightly complicated by the fact that certain patches are actually holes ( for ) , whose area is propagated with a negative sign to obtain the correct total sum for the region .",
    "another pixelization of the sphere in combination with the region representation enables fast spatial searches for catalog entries of stars , galaxies and other astronomical sources that are within a spherical region on the sky .",
    "the idea is to apply a coarse filter to the entire dataset and to reject most of the sources that are outside the search region , and perform the computationally more expensive geometry test on a much smaller subset of candidates that already passed the filter .",
    "our choice for such a filter is based the hierarchical triangular mesh , also known as the htm @xcite .",
    "next we discuss the properties and features of the htm , then introduce the algorithms for creating efficient coarse filters for regions that map very well onto the indexing facilities of currently available relational database engines .",
    "we can paint the sphere with triangular pixels that we call _ trixels _ defined by the htm .",
    "the top nodes are the 8 faces defined by an octahedron projected onto the sphere .",
    "the children of each node are obtained by subdividing the existing triangular nodes into 4 new triangles .",
    "the sub - triangles have the current corners and the current arc s midpoints as their corners .",
    "finer detail is created as new levels are added by repeating the process for each triangle . in the limit , the recursive subdivision approaches the ideal sphere as in figure  [ fig : subdivision ] .",
    "all the triangles at any level have a unique identifier or trixel i d .",
    "it is an integer number , that encodes the position of the trixel in the hierarchy and is composed through the following recursive algorithm .",
    "the level 0 trixels are the faces of the octahedron .",
    "we name them with n0 , n1 , n2 , n3 and s0 , s1 , s2 , s3 where n and s refer to the northern and southern hemispheres , respectively . in the recursion",
    ", each triangle has four offsprings that are named by appending the index 0 , 1 , 2 or 3 to the parent s name .",
    "figure  [ fig : naming ] illustrates the naming convention in the subdivision on a few examples .    to keep things consistent ,",
    "we introduce a straightforward mapping between the name and the i d of a trixel .",
    "the i d is a 64-bit integer and is more compact than the human - readable name that can be up to 25 bytes long .",
    "first we assign the bits 11 to n and 10 to s and convert the trixel s number betwen 0 and 3 to binary ( 00 and 11 ) and append it to the previous bits .",
    "we repeat until the desired level is reached .",
    "for example , the trixel named s2320 will convert to binary 1010111000 or decimal 696 .",
    "the longer the name of a trixel , the deeper it is in the hierarchy .",
    "for practical purposes , we stop at level 20 , approximately corresponding to a positional accuracy of about 0.3 \" .",
    "this special level-20 trixel i d is called the htmid in our system .",
    "a 64-bit integer can hold a trixel number to level 30 , although the standard ieee - float double precision breaks down after level 25 where the positional accuracy would be about one hundredth of an arcsecond .",
    "a property of the trixel i d numbers is that the descendants of a trixel have ids that form a consecutive list of numbers .",
    "for example , the 4 children of s2320 , namely the set of \\{s23200 , s23201 , s23202 , s23203 } , form the range of numbers 27842787 .",
    "the level 20 offsprings of the same trixel form the htmid range 1195718895206411974368821247 .",
    "this is important , because we can represent any level trixel with either a single number , or with a pair of low - high htmid values .",
    "the consequence of using the latter representation is that regions with variable size trixels can be expressed uniformly , and because the numbering provides partial coherence of the htmid numbers .",
    "since trixels partition the sphere , any location is inside exaclty one trixel , so a level 20 trixel i d , or the htmid is a fairly accurate approximation of the position .",
    "this property is exploited in our spatial search algorithm detailed in the subsequent paragraphs .",
    "simply put , a _",
    "cover _ is a set of trixels that fully covers a region .",
    "it is an approximation of the shape by the union of a set of spherical triangles .",
    "given a region , the algorithm starts with the eight level-0 trixels that make up the entire globe .",
    "the s2 in figure  [ fig : naming ] is one of these eight trixels that are initially marked as unprocessed . in the recursion ,",
    "all unprocessed trixels are analyzed and get marked with one of three possible tags .",
    "the _ inner _",
    "trixels are fully inside the region , the _ reject _ ones are completely outside and _ partial _ trixels are on the outline .",
    "dealing with inner and reject trixels is easy .",
    "inner trixels are saved for output , and the rejects are discarded from further consideration . a partial trixel is subdivided into four smaller trixels which are placed at the back of the unprocessed list .",
    "eventually all trixels are tagged to the desired level of detail .",
    "often it is very useful to have an approximation of the inside of the region that does not touch the outline .",
    "sources in the inner cover are guaranteed to be inside the region , hence do not require extra geometry tests . this _",
    "inner cover _ is the union of all the inner trixels , while the aforementioned _ outer cover _ is the union of the inner and partial trixels .",
    "in fact , it is possible to obtain both sets at the same time without much extra processing . as to where to stop , there is no universal optimum , and the answer will depend on the actual dataset and region , as well as the implementation of the search engine and even its hardware configuration . fortunately , sensible heuristics exist and the performance of the searches are considerably better than the naive implementation for any reasonable cover shapes .",
    "let us now examine how spatial searching is performed using an htm cover .",
    "assume that every source of our dataset has a pre - computed htmid that constrains its location on the celestial sphere to within a particular level-20 trixel .",
    "the outside cover of the region can be represented as a set of htmid intervals . if the sources are ordered by their htmid ,",
    "fetching sources in these intervals is extremely fast .",
    "if the dataset resides on disk , which is the case for any massive live astronomical catalog , getting sources in an interval consists of reading sequentially from the hard drive . at the end of every interval",
    ", the disk head is raised and re - positioned to the beginning of the next interval .",
    "this seek - time is the source of the penalty one would pay for a very accurate cover that is represented by many short intervals .",
    "often a couple of dozen htm ranges provide accurate representations that select a small enough candidate list with which modern cpus can keep up with processing the exact geometry calculations . in general , any custom stopping criterion can be utilized , e.g. , based on elapsed time or resolution size .",
    "one particularly interesting possibility is to monitor the area of the inner and outer covers and stop at a desired limit on their ratio .",
    "in fact , the area ratio can be approximated by the ratio of the number trixels in the two covers .",
    "the areas of trixels on the same level vary less than about 40% but the collections of ( random ) trixels would average out this variance to a more precise estimation of the area ratio .",
    "our design of the software implementation was driven by several requirements .",
    "it needed to be architecture and operating - system independent that also integrates well with the relational database technology , which is at the core of most modern astronomy archives today .",
    "we chose to build our solution in the .net framework programming model that satisfies our development , maintainance , portability and performance requirements .",
    "such managed code runs in a virtual machine called the common language runtime , or clr for short .",
    "in addition to microsoft s clr implementation of the common language infrastructure ( cli ) , there is also an open - source cross - platform runtime by the mono project .",
    "the .net framework is not only os independent but also allows for development in several programming languages and the integration of projects in a mixture of languages . using the c # programming language",
    ", we built a set of class libraries that depend on each other , so that applications in any one of the supported languages can choose to include the appropriate modules selectively .",
    "the basic module or assembly contains the routines to deal with the spherical geometry .",
    "generic container classes are used to store the collection of halfspaces in a convex and the collection of convexes that make up a region . thus managing a shape is as simple as working with lists . here",
    "we show the c # listings of a trivial example with a convex of two halfspaces to illustrate the simplicity of the coding .",
    "first , we define the centers of the caps using j2000 ( r.a . ,",
    "dec . ) coordinates ,    .... cartesian p1 = new cartesian(180 , 0 ) ; cartesian p2 = new cartesian(181 , 0 ) ; ....    then set the radius of the caps and create the halfspaces using the centers    .... double theta = math.pi / 180 ;     // 1 degree radii halfspace h1 = new halfspace(p1 , math.cos(theta ) ) ; halfspace h2 = new halfspace(p2 , math.cos(theta ) ) ; ....    the convex is a collection of halfspaces that are added one by one after which we invoke the simplification of the description that also derives the arcs and patches of the shape along with its analytic area in square degrees .",
    ".... convex c = new convex ( ) ; c.add(h1 ) ; c.add(h2 ) ; c.simplify ( ) ; console.out.writeline(c.area ) ; ....    similary a region is created by adding convexes to its collection .",
    ".... region r = new region ( ) ; r.add(c1 ) ; r.add(c2 ) ; r.simplify ( ) ; console.out.writeline(r.area ) ; ....    naturally , the number of convexes in a region and halfspaces in a convex are not limited to two ( and can also be one ) , they are only bound by system memory and computational power for processing .",
    "boolean operations on the shapes are implemented to perform the computations in place whereever possible .",
    "for example , the union of regions or the intersection of convexes can be done within the instance on which the method is called , but the difference of two convexes or regions is implemented to return the resulting region . on top of the straightforward translations of the algorithms in section  sec : alg , most operations have a _",
    "version for simplified shapes .",
    "one of the advantages of using these methods is the speedup for complicated shapes , where the precomputed bounding circles reduce the computational costs .",
    "the other benefit is potentially even greater .",
    "e.g , the union of simplified regions can be done based on the assumption that the convexes of the regions are already disjoint , and hence , check for collisions among the mixed pairs only . in code , the snipets    .... r.union(r2 ) ;       //",
    "regions may not be simplified r.simplify ( ) ;      //",
    "simplification from scratch console.out.writeline(r.area ) ; ....    and    ....",
    "r.smartunion(r2 ) ; // both simplified console.out.writeline(r.area ) ; ....    are conceptually identical but the latter can take significanly less time as it can assume the arguments to be in the canonical form .",
    "the application programming interface ( api ) supports many more advanced ways to create and manipulate regions of arbitrary complexity , the working code snipets above are here to serve as guide",
    ".      numerical stability of the implementation of the spherical algorithms is crucial and has not been easily achieved .",
    "computations with floating - point numbers make errors that can accumulate in a series of operations .",
    "these uncertainties can result in erroneous determination of topological relations of points and planes , convexes and regions .",
    "one possible solution is not to use floating - point arithmetics .",
    "software packages exist that work with rational numbers , and represent them as a pair of integers : the numerator and the denominator . in this setting ,",
    "the values are always precise but there is an efficiency penalty . in",
    "spherical geometry , there is an even more severe problem with this approach .",
    "the set of rational numbers is not closed for operations that one has to routinely perform , e.g. , the square root of a rational number can be irrational .",
    "we use ieee standard 754 double - precision floating - point numbers in our implementations that most modern cpus can efficiently process , and we carefully analyze the code for numerical stability and rounding problems .",
    "it is a surprisingly hard task . for decades ,",
    "linear algebra routines , e.g. , those in lapack , have been strengthened and optimized by hand because no generic solution exists ; only best practices .",
    "classic examples include the robust solution to the quadratic equation , or evaluating the values of @xmath25 and @xmath26 . to illustrate the importance , here we describe real - life problems that make the spherical geometry computations more difficult than expected , and explain our solutions briefly .",
    "the details of error propagation in floating - point arithmetics is beyond the scope of this writing .",
    "rather , we refer the interested reader to @xcite .",
    "previously we said that deciding whether a point is inside a halfspace , the most basic containment test discussed in section  [ sec : shapes ] , involves calculating the dot product of the point s unit vector and the direction of the plane and comparing the result to the halfspace s offset , the cosine of the cap s radius .",
    "the numerical imprecision on the result translates to larger errors in the radius because the cosine function is quadratic at values near zero , hence using the sine can be more advantageous .",
    "even then , when the point is very close to the plane , it is essentially impossible to decide which side it is on or whether it is contained in the plane .",
    "we circumvent the problem by not trying to answer in or out but allow for an _ undetermined _ value within a margin derived from the limitations of the representation of floating - point numbers .",
    "this value is deep in the core of routines establishing the spatial topological relations of the shapes .",
    "another , more subtle , algorithmic problem is the solution of the intersection of two planes , and the derivation of the intersecting points of two circles on the unit - sphere . as discussed in detail by @xcite , an elegant robust solution ( out of many possible derivations )",
    "is based on optimizing for the errors made in the computation of a point that the line crosses .",
    "the idea is to pick one of the , and planes that is most perpendicular to the direction of the line , and solve for the point in that plane .",
    "this way one of the coordinates is readily fixed to be 0 , and we only have to solve a 2-d linear equation for the other coordinates .    halfspaces and vertices of spherical polygons become degenerate very frequently as a result of routine operations while building up the geometric description of observations . without controlled accuracy these degeneracies",
    "could not be spotted and caught to derive correct representations or the regions .",
    "classes and routines of the htm implementation are divided into two basic categories .",
    "the creation of the hierarchy of triangles is a module of its own .",
    "the tree is usually not created for its extremely large size but computed on the fly .",
    "once the algorithm is fixed , the hierarchical trixels exists without the actual tree in memory or disk .",
    "the methods provide the recursion and the basic geometrical description of the pixels .",
    "for example , a single call yields the htmid ,    .... cartesian p = new cartesian(180,0 ) ; //",
    "point on the sky int64 htmid = trixel.cartesiantohid20(c ) ; // and its i d ....    and another the trixel s geometry ,    .... cartesian v1 , v2 , v3 ;    // vertices of the trixel trixel.totriangle(htmid , out v1 , out v2 , out v3 ) ; ....    on top of the core module is a set of classes that deal with the regions and their topological relations to the trixels .",
    "our efficient implementation of the htm makes use of the internal structure of the region , and the derived properties of its convexes and patches as well as the outline . in the api ,",
    "all the complexity is hidden behind simple    .... list < int64 > trixels = cover.hidlist(region ) ; console.out.writeline(trixels.count ) ; ....    alternatively one can explicitly instantiate a cover object , and investigate the properties during processing    .... cover k = new cover(region ) ; k.run ( ) ;   // default processing and stopping            // call k.step ( ) for more control list <",
    "int64 > inner = k.gettrixels(markup.inner ) ; list <",
    "int64 > outer = k.gettrixels(markup.outer ) ; list < int64 > partl = k.gettrixels(markup.partial ) ; ....    similarly the intervals are retrieved by a single method call and print in the following example .",
    ".... list < int64pair > ranges = cover.hidrange(region ) ; foreach ( int64pair p in ranges )      console.writeline(p ) ....    as shown in the examples above the htm and spherical library classes and routines work together seemlessly by design .",
    "they leverage all the information available to perform the operations as fast as possible , while keeping the usage patterns simple . under these high - level routines ,",
    "powerful methods provide easy customization of the code for other type of problems and applications .",
    "one such example is the nvo s footprint service that uses high - resolution htm ranges to look for overlapping footprint , or regions that contain a given point .",
    "our basic internal string representation of the regions follows the simple structure of the collections .",
    "we enumerate the convexes and all their halfspaces    .... region      convex cartesian x1 y1 z1 c1             ...",
    "cartesian xn yn zn cn      convex ... ....    with arbitrary whitespace and linefeed characters .",
    "the cartesian coordinates are the usual transformations of the j2000 @xmath27 by equations @xmath28 on top of this simple description , the interfaces also support more advanced concepts via region parser based on our grammar in the backus ",
    "naur form ( bnf ) .",
    "the use of these constructs are often more straighforward than spelling out the @xmath29 coordinates of the normal vectors . here",
    "we show the case for a couple of simple convexes often used by astronomers .",
    "the region describes the union of a circle with a radius of @xmath30 around the center at @xmath31 in the j2000 coordinate system and a great - circle polygon specified by its ordered vertecies given by the angles .",
    ".... region      poly j2000 180 0 182 0 182 2 180 2      circle j2000 180 0 60 ....    the polygon can be built up by any number of vertices ( greater than two ) and the region can have any combination of convex constructs .",
    "another useful feature is the convex hull of a point set that is specified by the keyword chull .",
    "to specify cartesian coordinates , one can replace the j2000 keyword with cartersian and enumerate the components of the unit vector instead of the anglular coordinates .",
    "one of the most attractive advantages of developing in the .net programming model is the elegant integration with sql server since the 2005 version .",
    "the runtime is actually hosted inside the engine , which allows for the customization of the database to satisfy the astronomy specific requirements .",
    "the custom assemblies can be loaded to be part of the database along with the catalog data , and user - defined functions ( udfs ) can wrap the functionality of the managed code that are invoked efficiently from sql at query time .",
    "this way custom programs can run inside the database right there where the data are , and perform analyses without moving the bits on the network or even outside the sql engine .",
    "our harness for the spherical implementation is schema - independent by design .",
    "this means that the same sql routines can be present and be used in any astronomy science archive regardless of the layout of the database or the content of the tables .",
    "in fact , it is currently in use in a wide variety of services , including the sloan digital sky survey , the galaxy evolution explorer and the hubble legacy archive , being integrated with the spitzer and chandra servers , among others .",
    "the regions are serialized into a compact binary format that contains both the halfspace - convex - region representation and the patches along with their minimal enclosing circles .",
    "the simplest way to create a region is by using the internal specification language that can describe any region but the operations are also supported when starting with basic building blocks . for example , the union of a 60 radius circle and the spherical rectangle can be coded as follows .    ....",
    "declare @s varchar(max ) , @r varbinary(max ) ,          @z varchar(max ) , @u varbinary(max ) select @s = ' region circle j2000 180 0 60 ' ,         @z = ' poly j2000   180 0   182 0   182 2   180 2 ' ,         @r = sph.fsimplifystring(@s ) ,         @u = sph.funion(@r,sph.fsimplifystring(@z ) ) select sph.fgetarea(@r ) , select sph.fgetarea(@u ) go -- 3.14151290574491   6.35572804450646 ....    in sql , the binary blobs of arbitrary size ( up to 2 gb ) are represented as varbinary(max ) , and here we use variables of that type .",
    "naturally , one can also create tables with varbinary columns to save the resulting regions within sql server .",
    "we note that previous version of the sql harness , e.g. , currently deployed in the sdss catalog archive server , do not use the separate sph schema but instead keep the udfs in the default dbo using an sph prefix , e.g. , in dbo.fsphgetarea(@r ) .",
    "the htm routines in sql provide high - performance spatial searches in combination with the builtin indexing mechanism .",
    "scalar - valued udfs can compute the address of a point at the default level of 20 . here",
    "we list a simple example that updates a table called photoobj to set the htmid column for all rows based on their j2000 coordinates    .... update photoobj set htmid = dbo.fhtmeq(ra,dec ) ....    using spherical regions to search for sources is also very straightforward and very efficient . in the following snippet we fetch only the rows that are in the htm cover , hence are probably contained in the region :    .... with cover as (      select * from dbo.fhtmcoverregion            ( ' region circle j2000 180 0 10 ' ) ) select o.objid from photoobj as o inner join cover as c      on o.htmid between c.htmidstart and c.htmidend go ....    the udf returns a table of the htm ranges of the approximation of the specified shape that overshoots , and the join returns instantly all the possible rows . in a real - life search ,",
    "the where clause of the query would have a separate containment test with the region geometry . the sole purpose of the htm cover is to fetch the good candidates only from the disk , and it does this very fast .      as part of the current standardization efforts of the international virtual observatory alliance ( ivoa ) , the space - time coordinate metadata ( stc ) provides an alternative to accurately describing shapes on the celestial sphere .",
    "an stc region has both xml ( stc - x ) and string ( stc - s ) serializations that are well mapped onto our data structures , and translators are being implemented to support them . the stc - x parser is deployed and being tested as part of the the national virtual observatory s ( nvo ) footprint service and the stc - s capabilities shall be part of future releases of our software packages and the service .",
    "the plain string representation stc - s is very straightforward by default .",
    "the union of a set of convexes looks like    .... union j2000 (      convex    1 0 0    0.1              -1 0 0   -0.5      convex    0 1 0    0.0 ) ....    the simplicity of the representation comes from the defaults that are substituted automatically for the missing stc elements but it is also possible to be explicit about every detail and even have different coordinate systems for the components , e.g. , in    .... union (      polygon fk5 j2000   180 0   182 0   182 2   180 2      circle   fk4 b1950   179 0   2 ) ....    in addition to the union , stc sports a large set of features that also include intersection , difference and negation of any of the shapes .",
    "the ivoa also working toward a standardized search language called the astronomical data query language ( adql ) , which is an ivoa recommendation as of this writing .",
    "adql is an extended subset of the ansi sql-92 standard , which adds geometrical constraints via simplified gis - like functions ( e.g. , circle ) and the full support of aforementioned stc representation . building on our legacy sql routines that currently work with the internal string representation",
    ", we are now creating new versions that input stc - s , and are designing an efficient implemention that supports the full adql .",
    "we explored the properties of generalized spherical polygons .",
    "we found the convex representation to be very compact and efficient .",
    "the boolean region operations are straightforward within this framework but inevitably create convoluted and redundant descriptions .",
    "the simplification involves solving the spherical geometry of the region . in the process",
    ", we summarized how to analytically calculate the areas and create the outlines of the regions .",
    "pixelization schemes also significantly benefit from the better representation .",
    "an optimal set of htm triangles can be computed to cover entirely a region , or just to approximate the inside , in much less time than before .",
    "we introduced a heuristic hybrid solutions for simplifications based on the igloo pixelization hierarchy that can tackle massive geometries where the brute - force method fails to deliver .",
    "our portable implementation in the .net programming model is available for developers on the projects website .",
    "its design enables quick development of new applications and a clean and easy integration with the sql server database engine that hosts several science archives today .",
    "the provided working examples illustrate common search patterns in c # and sql .",
    "future works include more algorithmic optimizations and full support of the ivoa s stc and adql standards .",
    "the authors are grateful to arnold rots for his heroic work on the stc standard , as well as to gretchen greene , steve lubow and rick white for their feedback on our software packages deployed in the hla .",
    "the authors acknowledge generous support from the following organizations : gordon and betty moore foundation gbmf 554 , w.  m. keck foundation keck d322197 , nsf nvo ast-0122449 , nasa aisrp nng05gb01 g .",
    "goodchild , m.  f. , shiren , y. , et  al .",
    "1991 , `` spatial data representation and basic operations on triangular hierarchical data structure . ''",
    "national center for geographic information and analysis : santa barbara .",
    "technical report 91 - 8      goldberg , d.  1991 , _ what every computer scientist should know about floating - point arithmetic _ in computing surveys , association for computing machinery , inc .",
    ", http://docs.sun.com/source/806-3568/ncg_goldberg.html                  kunszt , p.  z. , szalay , a.  s. , csabai , i. , and thakar , a.  r.  2000 , ` the indexing of the sdss science archive ' , in asp conf . ser . , astronomical data analysis software and systems ix , eds .",
    "n. manset , c. veillet , d. crabtree , vol . 216,141 .",
    "kunszt , p.  z. , szalay , a.  s. , thakar , a.  r.  2001 , in mining the sky : proceedings of the mpa / eso / mpe workshop held at garching , germany , july 31 - august 4 , 2000 , eso astrophysics symposia .",
    "isbn 3 - 540 - 42468 - 7 . edited by a.j .",
    "banday , s. zaroubi , and m. bartelmann .",
    "springer - verlag , p. 631",
    "short , n.m .",
    ", cromp , r. f. , campbell , w. j. , tilton , j. c. , lemoigne , j. , fekete , g. , netanyahu , n. s. , wichmann , k. , ligon , w. b.  1995 , `` mission to plane earth : ai views the world '' , ieee expert , june , 1995 , pp 24 - 34    song , l. , kimerling , a.  j. , and sahr , k.  2000 , developing an equal area global grid by small circle subdivision , proc.international conference on discrete global grids , santa barbara , ca , march 26 - 28 , 2000 ."
  ],
  "abstract_text": [
    "<S> sky coverage is one of the most important pieces of information about astronomical observations . </S>",
    "<S> we discuss possible representations , and present algorithms to create and manipulate shapes consisting of generalized spherical polygons with arbitrary complexity and size on the celestial sphere . </S>",
    "<S> this shape specification integrates well with our hierarchical triangular mesh indexing toolbox , whose performance and capabilities are enhanced by the advanced features presented here . </S>",
    "<S> our portable implementation of the relevant spherical geometry routines comes with wrapper functions for database queries , which are currently being used within several scientific catalog archives including the sloan digital sky survey , the galaxy evolution explorer and the hubble legacy archive projects as well as the footprint service of the virtual observatory . </S>"
  ]
}